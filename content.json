{"pages":[{"title":"404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º","date":"2019-12-26T08:16:51.761Z","path":"/404.html","text":""},{"title":"å…³äº","date":"2020-04-25T03:12:39.220Z","path":"about/index.html","text":"ä¸ªäººè¯¦ç»†ä»‹ç»"},{"title":"ä¹¦å•","date":"2019-12-26T08:16:51.762Z","path":"books/index.html","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2019-12-26T08:16:51.762Z","path":"links/index.html","text":""},{"title":"Repositories","date":"2019-12-26T08:16:51.763Z","path":"repository/index.html","text":""},{"title":"æ ‡ç­¾","date":"2020-04-25T03:29:22.060Z","path":"tags/index.html","text":""},{"title":"åˆ†ç±»","date":"2020-04-25T03:12:19.979Z","path":"categories/index.html","text":""}],"posts":[{"title":"SnapKit åˆ†æ","date":"2020-04-10T07:24:23.000Z","path":"2020/04/10/source-code/SnapKit-åˆ†æ/","text":"å¯¹åº” Masonry æºç åˆ†æ, çœ‹è¿™ç¯‡æ–‡ç« å‰æœ€å¥½å…ˆçœ‹çœ‹è¿™ç¯‡ï¼ˆDSL å…¶å®æ˜¯ Domain Specific Language çš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰åˆ†ææºç ï¼šè¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿ SnapKit æ˜¯ä»€ä¹ˆSnapKit æºç åœ°å€ ä¸ºä»€ä¹ˆè¦è®¾è®¡ SnapKité¦–å…ˆå’Œç³»ç»Ÿæä¾›æ¥å£å¯¹æ¯”ä¸‹123456789101112131415161718label.translatesAutoresizingMaskIntoConstraints = falselet constraint1 = NSLayoutConstraint.init(item: label, attribute: .left, relatedBy: .equal, toItem: view, attribute: .left, multiplier: 1, constant: 150);constraint1.isActive = true... top, widthlet constraint4 = NSLayoutConstraint.init(item: label, attribute: .height, relatedBy: .equal, toItem: view, attribute: .notAnAttribute, multiplier: 1, constant: 20);constraint4.isActive = trueAnchor: åªæ”¯æŒ ios &gt;= 91234567label.translatesAutoresizingMaskIntoConstraints = falseNSLayoutConstraint.activate([ label.leftAnchor.constraint(equalTo: view.leftAnchor, constant: 150), label.topAnchor.constraint(equalTo: view.topAnchor, constant: 200), label.widthAnchor.constraint(equalToConstant: 200), label.heightAnchor.constraint(equalToConstant: 200),])12345label.snp.makeConstraints &#123; (make) in make.left.equalTo(view).offset(150) make.top.equalToSuperview().offset(200) make.size.equalTo(CGSize(width: 200, height: 20))&#125;P.S. SnapKit å†…éƒ¨ä¼šå¸®ä½ è°ƒç”¨ view.translatesAutoresizingMaskIntoConstraints = trueSnapKit è®¾è®¡çš„ç›®çš„ï¼Œå°±æ˜¯ä»¥é“¾å¼ç¼–ç¨‹æ‰‹æ®µå°è£… NSLayoutConstraint å†—ä½™ä»£ç ï¼å¦‚ä½•å¤„ç†åŸæ¥ç¹æ‚æ¥å£å¦‚ä½•å®ç°é“¾å¼å¦‚ä½•å°è£… NSLayoutConstraint çš„å¦‚ä½•æŠŠå¤šä¸ª NSLayoutConstraint å°è£…æˆç®€å•çš„ä¸€å¥æå®šçš„ä½¿ç”¨äº†ä½•ç§ç¼–ç¨‹æ‰‹æ®µ SnapKit ä»£ç ç»“æ„åˆ†æ ä»è°ƒç”¨å±‚æ¬¡åˆ†æè¿™é‡Œæˆ‘è¦åƒæ´‹è‘±ä¸€æ ·ä¸€å±‚ä¸€å±‚çš„æ‹¨å¼€æœ€å¤–å±‚æ¥å£æ ¹æ®è¿™æ®µä»£ç åˆ†æ1234label.snp.makeConstraints &#123; (make) in make.left.equalTo(view).offset(150) make.size.equalTo(CGSize(width: 200, height: 20))&#125;ConstraintMaker.swift123456789101112 public class ConstraintMaker &#123; public var left: ConstraintMakerExtendable &#123; get &#125; public var top: ConstraintMakerExtendable &#123; get &#125; public var bottom: ConstraintMakerExtendable &#123; get &#125; public var right: ConstraintMakerExtendable &#123; get &#125; ...... internal static func prepareConstraints(item: LayoutConstraintItem, closure: (_ make: ConstraintMaker) -&gt; Void) -&gt; [Constraint] internal static func makeConstraints(item: LayoutConstraintItem, closure: (_ make: ConstraintMaker) -&gt; Void) internal static func remakeConstraints(item: LayoutConstraintItem, closure: (_ make: ConstraintMaker) -&gt; Void) internal static func updateConstraints(item: LayoutConstraintItem, closure: (_ make: ConstraintMaker) -&gt; Void) ......&#125;ä»ğŸ‘†æºç å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªè§åçŸ¥æ„çš„æ–¹æ³•æ–¹æ³•å‚æ•° ConstraintMaker è¿™ä¸ªå°±æ˜¯ makeå±æ€§ ConstraintMakerExtendable è¿™ä¸ªå°±æ˜¯ make åé¢çš„ make.leftæˆ‘æƒ³çŸ¥é“ï¼Œä»–çš„é“¾å¼æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¦‚ä½•å°è£… autolayout ç›¸å…³çš„æ•°æ®çš„ï¼Œç›®å‰çœ‹åˆ°çš„åªæ˜¯å¹³å¸¸ä½¿ç”¨çš„æ¥å£æˆ‘è¿˜è¦æ‰¾åˆ° ä¸‹å›¾çš„è¿™äº›ä¿¡æ¯æ¥ç€å¾€é‡Œé¢çœ‹ConstraintMakerExtendable ç»§æ‰¿è‡ª ConstraintMakerRelatable123456789101112131415161718public class ConstraintMakerExtendable : ConstraintMakerRelatable &#123; public var left: ConstraintMakerExtendable &#123; self.description.attributes += .left return self &#125; public var top: ConstraintMakerExtendable &#123; self.description.attributes += .top return self &#125; public var bottom: ConstraintMakerExtendable &#123; self.description.attributes += .bottom return self &#125; public var right: ConstraintMakerExtendable &#123; self.description.attributes += .right return self &#125; ......é—®é¢˜&amp;çŒœæµ‹ï¼šdescription æ˜¯å•¥ï¼Ÿä¸çŸ¥é“ä¸è¿‡ä»–æœ‰ attributes å±æ€§ï¼Œçœ‹æ ·å­å¯¹åº” NSLayoutConstraint.Attributeleft, top â€¦â€¦ è¿™äº›éƒ½è¿”å› ConstraintMakerExtendable ï¼ŒçŒœæµ‹ä»–æ˜¯é“¾çš„èŠ‚ç‚¹å¯¹è±¡ç»§ç»­çœ‹ ConstraintMakerRelatable1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class ConstraintMakerRelatable &#123; internal let description: ConstraintDescription internal init(_ description: ConstraintDescription) &#123; self.description = description &#125; internal func relatedTo(_ other: ConstraintRelatableTarget, relation: ConstraintRelation, file: String, line: UInt) -&gt; ConstraintMakerEditable &#123; let related: ConstraintItem let constant: ConstraintConstantTarget if let other = other as? ConstraintItem &#123; guard other.attributes == ConstraintAttributes.none || other.attributes.layoutAttributes.count &lt;= 1 || other.attributes.layoutAttributes == self.description.attributes.layoutAttributes || other.attributes == .edges &amp;&amp; self.description.attributes == .margins || other.attributes == .margins &amp;&amp; self.description.attributes == .edges || other.attributes == .directionalEdges &amp;&amp; self.description.attributes == .directionalMargins || other.attributes == .directionalMargins &amp;&amp; self.description.attributes == .directionalEdges else &#123; fatalError(\"Cannot constraint to multiple non identical attributes. (\\(file), \\(line))\"); &#125; related = other constant = 0.0 &#125; else if let other = other as? ConstraintView &#123; related = ConstraintItem(target: other, attributes: ConstraintAttributes.none) constant = 0.0 &#125; else if let other = other as? ConstraintConstantTarget &#123; related = ConstraintItem(target: nil, attributes: ConstraintAttributes.none) constant = other &#125; else if #available(iOS 9.0, OSX 10.11, *), let other = other as? ConstraintLayoutGuide &#123; related = ConstraintItem(target: other, attributes: ConstraintAttributes.none) constant = 0.0 &#125; else &#123; fatalError(\"Invalid constraint. (\\(file), \\(line))\") &#125; let editable = ConstraintMakerEditable(self.description) editable.description.sourceLocation = (file, line) editable.description.relation = relation editable.description.related = related editable.description.constant = constant return editable &#125; @discardableResult public func equalTo(_ other: ConstraintRelatableTarget, _ file: String = #file, _ line: UInt = #line) -&gt; ConstraintMakerEditable &#123; return self.relatedTo(other, relation: .equal, file: file, line: line) &#125; ......&#125;æ‰¾åˆ°äº†ConstraintConstantTarget(struct)ConstraintRelation(struct)ConstraintAttributes(struct)ConstraintDescription(class)ConstraintItem(class)ConstraintMakerEditable(class) model å±‚æ•°æ®åˆ†æ ConstraintConstantTarget12345678910typealias LayoutAttribute = NSLayoutConstraint.Attributepublic protocol ConstraintConstantTarget &#123;&#125;extension CGPoint: ConstraintConstantTarget &#123;&#125;extension CGSize: ConstraintConstantTarget &#123;&#125;extension ConstraintInsets: ConstraintConstantTarget &#123;&#125;extension NSDirectionalEdgeInsets : ConstraintConstantTarget &#123;&#125;extension ConstraintConstantTarget &#123; internal func constraintConstantTargetValueFor(layoutAttribute: LayoutAttribute) -&gt; CGFloat&#125;çœ‹æºç çŸ¥é“ ConstraintConstantTarget æ˜¯ autolayout æ–¹ç¨‹å¼ä¸­çš„ constantï¼Œä»–æ˜¯è¿™ä¸ª constant æ‰©å±•å°è£… ConstraintRelation123456internal enum ConstraintRelation : Int &#123; case equal case lessThanOrEqual case greaterThanOrEqual internal var layoutRelation: LayoutRelation &#123; get &#125;&#125;ConstraintRelation æ˜¯ æ–¹ç¨‹å¼ä¸­çš„ å…³ç³»ç¬¦å· ConstraintAttributes123456789101112131415161718192021222324252627282930internal struct ConstraintAttributes : OptionSet, ExpressibleByIntegerLiteral &#123;... internal static var none: ConstraintAttributes &#123; return 0 &#125; internal static var left: ConstraintAttributes &#123; return 1 &#125; internal static var top: ConstraintAttributes &#123; return 2 &#125; internal static var right: ConstraintAttributes &#123; return 4 &#125; internal static var bottom: ConstraintAttributes &#123; return 8 &#125; internal static var leading: ConstraintAttributes &#123; return 16 &#125; internal static var trailing: ConstraintAttributes &#123; return 32 &#125; internal static var width: ConstraintAttributes &#123; return 64 &#125;... internal var layoutAttributes:[LayoutAttribute] &#123; var attrs = [LayoutAttribute]() if (self.contains(ConstraintAttributes.left)) &#123; attrs.append(.left) &#125; if (self.contains(ConstraintAttributes.top)) &#123; attrs.append(.top) &#125; .... return attrs &#125;&#125;internal func + (left: ConstraintAttributes, right: ConstraintAttributes) -&gt; ConstraintAttributes &#123; return left.union(right)&#125;internal func +=(left: inout ConstraintAttributes, right: ConstraintAttributes) &#123; left.formUnion(right)&#125;ConstraintAttributes ä½¿ç”¨äº†swift çš„é€‰æ‹©é›†(å¯é€‰æšä¸¾)é‡è½½äº†è¿ç®—ç¬¦ä¾ç„¶çŒœæµ‹ å®ƒå¯¹åº” NSLayoutConstraint.Attribute1234567891011121314151617181920//ConstraintItem.swiftpublic final class ConstraintItem &#123; internal weak var target: AnyObject? internal let attributes: ConstraintAttributes internal init(target: AnyObject?, attributes: ConstraintAttributes) internal var layoutConstraintItem: LayoutConstraintItem? &#123; return self.target as? LayoutConstraintItem &#125;&#125;public func == (lhs: ConstraintItem, rhs: ConstraintItem) -&gt; Bool// LayoutConstraintItem.swiftpublic protocol LayoutConstraintItem: class &#123;&#125;@available(iOS 9.0, OSX 10.11, *)extension ConstraintLayoutGuide : LayoutConstraintItem &#123;&#125;extension ConstraintView : LayoutConstraintItem &#123;&#125;//public typealias ConstraintLayoutGuide = UILayoutGuidepublic typealias ConstraintView = UIViewnice~ConstraintItem å°±æ˜¯ view å’Œ ä»–å¯¹åº”å¸ƒå±€å±æ€§çš„å…ƒç»„ (view, attr) ConstraintDescription1234567891011121314public class ConstraintDescription &#123; internal let item: LayoutConstraintItem internal var attributes: ConstraintAttributes internal var relation: ConstraintRelation? internal var sourceLocation: (String, UInt)? internal var label: String? internal var related: ConstraintItem? internal var multiplier: ConstraintMultiplierTarget internal var constant: ConstraintConstantTarget internal var priority: ConstraintPriorityTarget internal lazy var constraint: SnapKit.Constraint? &#123; get set &#125; // main internal init(item: LayoutConstraintItem, attributes: ConstraintAttributes)&#125;ConstraintDescription åŒ…å«äº† autolayout å¸ƒå±€æ–¹ç¨‹å¼ä¸­æ‰€æœ‰ä¿¡æ¯ï¼Œå¯æ˜¯ä¸çŸ¥é“ä¸ºå•¥ä¸åœ¨è¿™é‡Œè°ƒç”¨ NSLayoutConstraint æ·»åŠ å±æ€§ï¼Œéè¦æä¸€ä¸ª SnapKit.Constraintæ¥åšè¿™äº›äº‹ConstraintMakerEditable æ˜¯é“¾å¼ç¼–ç¨‹æŠ€å·§é‡Œé¢çš„å¾€åçœ‹ åˆ†æ SnapKit é“¾å¼å°è£… ä¸»è¦ç»„ä»¶ç»“æ–‡ä»¶åˆ†ç»„ ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æSnapKit ä¸»æµç¨‹SnapKit é“¾å¼æµç¨‹maker åˆ›å»ºä¸€ä¸ªå…¶å®èŠ‚ç‚¹ ContraintExtentableï¼Œä»–ç»´æŠ¤è‡ªå·±çš„ descriptionmaker ä¿å­˜ descriptions[] æ•°ç»„ä¼ é€’ description æ¥å»¶ç»­é“¾èŠ‚ç‚¹to be continued ä»£ç ç»„ä»¶åˆ†æAuto Layout Guide","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"},{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"UI å¸ƒå±€","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/UI-å¸ƒå±€","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/UI-%E5%B8%83%E5%B1%80/"}]},{"title":"ä½¿ç”¨ closures ä»£æ›¿ Gesture Recognizers é€‰æ‹©å™¨","date":"2020-03-08T01:56:45.000Z","path":"2020/03/08/ä½¿ç”¨-closures-æ·»åŠ -Gesture-Recognizers/","text":"åŸæ–‡ Adding Gesture Recognizers with Closures Instead of Selectorsæ·»åŠ UITapGestureRecognizeræˆ–ä»»ä½• recognizer/target action çš„æœ€ç³Ÿç³•çš„éƒ¨åˆ†æ˜¯ä»…é’ˆå¯¹é€‰æ‹©å™¨å‚æ•°å®ç°æ–°åŠŸèƒ½ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€ä¸ªå·§å¦™çš„æŠ€å·§ï¼Œè®©ä½ æ·»åŠ ä¸å¸¦é€‰æ‹©å™¨çš„æ‰‹åŠ¿è¯†åˆ«å™¨ã€‚å‡è®¾æˆ‘ä»¬åœ¨View Controllerä¸­æœ‰ä¸€ä¸ªUIImageViewï¼Œæˆ‘ä»¬æƒ³å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ªUITapGestureRecognizerï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»å®ƒæ—¶æ‰“å°å‡ºä¸€æ¡è¯­å¥.é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª UITapGestureRecognizer çš„å®ä¾‹ï¼Œå¹¶å°†å…¶ç›®æ ‡è®¾ç½®ä¸ºè§†å›¾æ§åˆ¶å™¨åŠå…¶é€‰æ‹©å™¨ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå¿«é€Ÿå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·(myImageViewTapped(senderï¼šUITapGestureRecognizer))ã€‚è¿™å¯èƒ½ä¼šæœ‰ç‚¹å¤šä½™ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´è¦æ·»åŠ äº¤äº’æ€§çš„æ¯ä¸ªå­è§†å›¾çš„å‡½æ•°çš„ä»£ç æ··ä¹±ã€‚æˆ‘ä»¥ä¸ºæˆ‘å¯ä»¥å¿«é€Ÿæ‰©å±•ä¸€ä¸‹ï¼Œä»¥ä¾¿ä¸ºæˆ‘çš„å›¾åƒè§†å›¾æ·»åŠ æ•²å‡»æ‰‹åŠ¿è¯†åˆ«å™¨ï¼Œä½†æ˜¯ç„¶åæˆ‘å¿…é¡»ä¸ºæ¯ä¸ªè¯†åˆ«å™¨åˆ›å»ºä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå¯¹å—ï¼Ÿé”™è¯¯ï¼åˆ©ç”¨å…³è”å¯¹è±¡çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥å°†é—­åŒ…å­˜å‚¨ä¸ºæ‰©å±•ä¸­çš„è®¡ç®—å±æ€§ï¼1234567891011121314151617181920212223242526272829303132333435363738394041424344import UIKitextension UIView &#123; // In order to create computed properties for extensions, we need a key to // store and access the stored property fileprivate struct AssociatedObjectKeys &#123; static var tapGestureRecognizer = \"MediaViewerAssociatedObjectKey_mediaViewer\" &#125; fileprivate typealias Action = (() -&gt; Void)? // Set our computed property type to a closure fileprivate var tapGestureRecognizerAction: Action? &#123; set &#123; if let newValue = newValue &#123; // Computed properties get stored as associated objects objc_setAssociatedObject(self, &amp;AssociatedObjectKeys.tapGestureRecognizer, newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_RETAIN) &#125; &#125; get &#123; let tapGestureRecognizerActionInstance = objc_getAssociatedObject(self, &amp;AssociatedObjectKeys.tapGestureRecognizer) as? Action return tapGestureRecognizerActionInstance &#125; &#125; // This is the meat of the sauce, here we create the tap gesture recognizer and // store the closure the user passed to us in the associated object we declared above public func addTapGestureRecognizer(action: (() -&gt; Void)?) &#123; self.isUserInteractionEnabled = true self.tapGestureRecognizerAction = action let tapGestureRecognizer = UITapGestureRecognizer(target: self, action: #selector(handleTapGesture)) self.addGestureRecognizer(tapGestureRecognizer) &#125; // Every time the user taps on the UIImageView, this function gets called, // which triggers the closure we stored @objc fileprivate func handleTapGesture(sender: UITapGestureRecognizer) &#123; if let action = self.tapGestureRecognizerAction &#123; action?() &#125; else &#123; print(\"no action\") &#125; &#125;&#125;ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬è¦å°†UITapGestureRecognizeræ·»åŠ åˆ°UIViewæˆ–UIViewå­ç±»ï¼ˆå¦‚UIImageViewï¼‰æ—¶ï¼Œéƒ½å¯ä»¥è¿™æ ·åšï¼Œè€Œæ— éœ€ä¸ºé€‰æ‹©å™¨åˆ›å»ºå…³è”çš„åŠŸèƒ½ï¼è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š123sampleImageView.addTapGestureRecognizer &#123; print(\"image tapped\")&#125;æ²¡æœ‰UITapGestureRecognizerså®ä¾‹ï¼Œæ²¡æœ‰targetsï¼Œæ²¡æœ‰selectorsï¼Œæ²¡æœ‰ä¸å¿…è¦çš„functionsï¼","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"},{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"Apple ç³»ç»Ÿç•Œé¢æ¸²æŸ“è¿‡ç¨‹","date":"2020-03-06T06:39:27.000Z","path":"2020/03/06/iOS æ¸²æŸ“è¿‡ç¨‹/","text":"è‹¹æœçš„æ¸²æŸ“æ¡†æ¶(é€šä¿—çš„ç†è§£)æ ¹æ®æ—¥å¸¸å¼€å‘å’Œä¸Šå›¾åˆ†ææ¸²æŸ“æµç¨‹UIKit: å¼€å‘ä¸­ä½¿ç”¨çš„ç”¨æˆ·äº¤äº’ç»„ä»¶éƒ½æ¥è‡ªäº UIKit (ç†è§£ä¸ºæ”¶é›†æ¸²æŸ“ä¿¡æ¯+ç”¨æˆ·äº¤äº’äº‹ä»¶ä¿¡æ¯çš„æ¡†æ¶)æä¾›å„ç§ UI ç»„ä»¶æä¾›é…ç½® UI ç»„ä»¶çš„æ ·å¼æ¥å£(autoLayout, Frame, Color, Text â€¦â€¦)ï¼Œäº¤ç”± Core Animation å¤„ç†å°è£…ç”¨æˆ·äº‹ä»¶æ¥å£Core Animationï¼šå­—é¢ç¿»è¯‘æ˜¯æ ¸å¿ƒåŠ¨ç”»ï¼Œçœ‹ä¸‹ CALayerï¼ŒCA è¡¨ç¤ºçš„å°±æ˜¯ Core Animationï¼ŒCore Animation ç†è§£ä¸ºæ”¶é›†æ¸²æŸ“ä¿¡æ¯ï¼Œè§¦åº•ç»™åº•éƒ¨ç„¶åå¾—åˆ°ä¸€ä¸ªæ¸²æŸ“ç»“æœ contentsï¼ˆUIKit ä¸Šæ‰€æœ‰èƒ½çœ‹åˆ°çš„ä¸œè¥¿éƒ½æ˜¯é€šè¿‡ layer.contents å‘ˆç°çš„ï¼‰ç»™ UIKit æä¾› layerç®¡ç†åŠ¨ç”»æ”¶é›†æ¸²æŸ“æ•°æ®äº¤ç”±æ¸²æŸ“å¼•æ“å¤„ç†ä¸è´Ÿè´£ç”¨æˆ·äº‹ä»¶ç›¸å…³å¤„ç†ï¼OpenGL ES &amp; Core Graphics æ¸²æŸ“å¼•æ“æ”¶é›† Core Animation æä¾›çš„æ¸²æŸ“æ•°æ®Core Graphics æ˜¯åŸºäº Quartz(è½»é‡çº§ 2D æ¸²æŸ“) é«˜çº§ç»˜å›¾å¼•æ“Graphics Hardware è¯‘ä¸ºå›¾å½¢ç¡¬ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåŠçš„ GPUGPU çš„é«˜åº¦å¹¶è¡Œç»“æ„ä½¿å…¶åœ¨å¤§å—æ•°æ®å¹¶è¡Œå¤„ç†çš„ç®—æ³•ä¸­æ¯”é€šç”¨ CPU æ›´æœ‰æ•ˆç”¨æˆ·æ“ä½œçš„æ ¸å¿ƒåœ¨ Core Animationï¼Œä½ è¦æ¸²æŸ“çš„æ•°æ®éƒ½è¦æ”¾åœ¨ï¼ˆlayer.contentsï¼‰ä¸Šå½“ç„¶ç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®OpenGL ES(GLKView) æ¥å¤„ç†æ¸²æŸ“Core Graphic (CG-- ç›¸å…³æ¥å£) æ¥ç”Ÿæˆ bitmap æ•°æ®ï¼Œç„¶åå°†å…¶æ”¾åˆ° Core Animation ä¸Šlayer.contentsUIKit ä¸­çš„ç»„ä»¶éƒ½ä¼šå…³è”åˆ°ç›¸åº”çš„ CALayeræ¸²æŸ“å¼•æ“ OpenGL ES &amp; Core Graphic éƒ½ä¼šæŠŠæ¸²æŸ“ç»“æœäº¤ç»™ layer.contents (CGImage) ç”¨æˆ·ä½¿ç”¨æ¸²æŸ“æ¡†æ¶çš„æ•°æ®æµå‘ å®˜æ–¹æ¸²æŸ“æµç¨‹ Core Animation Pipelineåœ¨çœ‹å®Œ wwdc2014 session419(Advanced Graphics and Animations for iOS Apps) æœ‰äº†æ›´æ·±å…¥çš„äº†è§£ä¸Šå›¾éœ€è¦æ³¨æ„ï¼šè‹¹æœçš„ UI æ¸²æŸ“é¢‘ç‡æ˜¯ 60hz 16.67ms ä¸€æ¬¡ï¼ˆVsyncï¼‰æ¯ä¸ªå‚ç›´çš„è™šçº¿è¡¨ç¤ºä¸€ä¸ª Vsyncæ°´å¹³è™šçº¿ï¼Œè¡¨ç¤ºä¸€ä¸ªç¡¬ä»¶èµ„æºé—®é¢˜æ¥äº†ï¼Œæ ¹æ®ä¸Šå›¾ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸéœ€è¦ 3frameï¼Œé‚£ä¹ˆçœŸå®çš„æ¸²æŸ“é¢‘ç‡åªæœ‰ 20hzé‚£ä¹ˆç³»ç»Ÿæ˜¯æ€ä¹ˆåšåˆ° 60hz çš„å‘¢ï¼Ÿç­”æ¡ˆï¼š æµæ°´çº¿å¦‚æœåœ¨æ¯ä¸€å¸§ä¸Šå¯¹åº”ç¡¬ä»¶æ“ä½œéƒ½å®Œæˆäº†ï¼Œé‚£ä¹ˆå°±ä¼šä»¥ 60hz çš„é€Ÿåº¦æ¸²æŸ“æ¥ä¸‹æ¥è¯´ä¸€ä¸‹æ¸²æŸ“è¿‡ç¨‹ä¸­çš„æ¯ä¸ªç»†èŠ‚éƒ¨åˆ† æäº¤äº‹åŠ¡ï¼ˆcommit transactionï¼‰ä¸»è¦æ˜¯ 4ä¸ªé˜¶æ®µLayoutï¼šæ„å»º Viewsè°ƒç”¨ layoutSubviews å¦‚æœé‡è½½äº†åˆ›å»º viewï¼ŒaddSubView:å¡«å……å†…å®¹ï¼Œè½»é‡çº§çš„æ•°æ®æŸ¥è¯¢ï¼ˆå°±æ˜¯ string èµ‹å€¼ä¹‹ç±»çš„ï¼‰é€šå¸¸æ˜¯ CPU, I/O è´Ÿè´£Displayï¼šç»˜åˆ¶ ViewsdrawRect ç»˜åˆ¶å†…å®¹ï¼Œå¦‚æœé‡è½½äº†ï¼ˆä¸»è¦ä½¿ç”¨ Core Graphicï¼Œé¿å…æ‰§è¡Œå¤æ‚æ“ä½œï¼‰String drawingé€šå¸¸æ˜¯ CPU / memory è´Ÿè´£Prepareï¼šåšäº› Core Animation ç›¸å…³æ“ä½œimage decodingï¼ˆview hierachy ç»˜åˆ¶çš„ï¼Œjpegï¼Œpngï¼‰image conversionï¼ˆå› ä¸ºæœ‰äº›å›¾ç‰‡ GPU ä¸æ”¯æŒï¼‰ï¼Œé€šå¸¸æ˜¯è§£ç æˆ bitmapCommitï¼šæ‰“åŒ… layersï¼Œç„¶åå°†ä»–ä»¬å‘ç»™ render serveré€’å½’ä¸Šè¿°æµç¨‹å¦‚æœ layer æ ‘å¾ˆå¤æ‚ï¼Œé‚£ä¹ˆä¼šå¾ˆè€—æ€§èƒ½ã€‚æ‰€ä»¥å°½å¯èƒ½çš„è®© layer tree å¹³ä¸€äº›ï¼ˆå°‘å‡ å±‚ï¼‰ åŠ¨ç”»Animationä¸»è¦æ˜¯ 3ä¸ªé˜¶æ®µï¼Œæœ‰ 2ä¸ªé˜¶æ®µå‘ç”Ÿåœ¨ Application è¿›ç¨‹ä¸­ï¼Œ1ä¸ªåœ¨ Render Server è¿›ç¨‹ä¸­åˆ›å»ºåŠ¨ç”»æ¥ç€æ›´æ–°è§†å›¾å±‚çº§ animateWithDuration:animations:å‡†å¤‡åŠ¨ç”»ï¼Œç„¶åæäº¤ layoutSubviews, drawRect: å°±æ˜¯æäº¤äº‹åŠ¡è¿™å‡ æ­¥ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ï¼Œrender server è¿›ç¨‹ç»˜åˆ¶å‡ºåŠ¨ç”»ç›¸å…³çš„æ¯ä¸€å¸§ï¼Œåœ¨äº¤ç”± App è¿›ç¨‹ æ¸²æŸ“ renderä¸€ä¸ª view çš„æ¸²æŸ“è¿‡ç¨‹æ·»åŠ  masking åçš„æ¸²æŸ“è¿‡ç¨‹GPU çš„ç¦»å±æ¸²æŸ“ï¼Œå°±æ˜¯å¯¹äºä¸€ä¸ª view éœ€è¦å¤šæ¬¡æ¸²æŸ“ç»„åˆï¼Œå› ä¸ºéœ€è¦å¤šä¸ªæ¸²æŸ“å±‚æ‰€ä»¥éœ€è¦ç¦»å±æ¸²æŸ“å¼€è¾Ÿç¼“å­˜ï¼Œç»˜åˆ¶è¿™äº›maskï¼Œradiusï¼Œblend â€¦â€¦å¦‚æœéœ€è¦ç»„åˆçš„é‚£äº›æ¸²æŸ“è¿‡ç¨‹åœ¨ CPU ä¸­å®Œæˆï¼Œç„¶åCPUç›´æ¥æŠŠä¸€ä¸ªç»˜åˆ¶å¥½çš„ image äº¤ç»™ GPU æ¸²æŸ“å°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜äº†ï¼ä¸è¿‡ CPU æ€§èƒ½é—®é¢˜ï¼drawRect ä¸­å¦‚æœç»˜åˆ¶ image å¤ªè¿‡å¤æ‚ä¾ç„¶ä¼šå‡ºç°æ‰å¸§é—®é¢˜ Runloop &amp; Core AnimationRunLoopä¸»è¦å¤„ç†ä»¥ä¸‹6ç±»äº‹ä»¶ï¼š12345678910111213static void __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__();static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__();static void __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__();static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__();static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__();static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__();1. Observer2. block3. timer4. main_dispatch_queue5. source06. source1Observeräº‹ä»¶ï¼šrunloopä¸­çŠ¶æ€å˜åŒ–æ—¶è¿›è¡Œé€šçŸ¥ã€‚Core Animation ç›‘å¬ RunloopObserver é—²ç½®çš„æ—¶å€™è§¦å‘ã€‚Blockäº‹ä»¶ï¼šMain_Dispatch_Queueäº‹ä»¶ï¼šGCDä¸­dispatchåˆ°main queueçš„block ä¼šåœ¨ main loop ä¸­æ‰§è¡Œã€‚Timeräº‹ä»¶ï¼šå»¶è¿Ÿçš„NSObject PerformSelectorï¼Œå»¶è¿Ÿçš„dispatch_afterï¼Œtimeräº‹ä»¶ã€‚Source0äº‹ä»¶ï¼šå¤„ç†å¦‚UIEventï¼ŒCFSocketè¿™ç±»äº‹ä»¶ã€‚éœ€è¦æ‰‹åŠ¨è§¦å‘ã€‚è§¦æ‘¸äº‹ä»¶å…¶å®æ˜¯Source1æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ååœ¨å›è°ƒ __IOHIDEventSystemClientQueueCallback() å†…è§¦å‘çš„ Source0ï¼ŒSource0 å†è§¦å‘çš„ _UIApplicationHandleEventQueue()ã€‚source0ä¸€å®šæ˜¯è¦å”¤é†’runloopåŠæ—¶å“åº”å¹¶æ‰§è¡Œçš„ï¼Œå¦‚æœrunloopæ­¤æ—¶åœ¨ä¼‘çœ ç­‰å¾…ç³»ç»Ÿçš„ mach_msgäº‹ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šé€šè¿‡source1æ¥å”¤é†’runloopæ‰§è¡Œã€‚(ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è°ƒç”¨performSelector æ–¹æ³•è§¦å‘ source0)Source1äº‹ä»¶ï¼šå¤„ç†ç³»ç»Ÿå†…æ ¸çš„mach_msgäº‹ä»¶ã€‚ï¼ˆæ¨æµ‹CADisplayLinkä¹Ÿæ˜¯è¿™é‡Œè§¦å‘ï¼‰ã€‚App è¿›ç¨‹çš„ Core Animation åœ¨ RunLoop ä¸­æ³¨å†Œäº†ä¸€ä¸ª Observerï¼Œç›‘å¬äº† BeforeWaiting å’Œ Exit äº‹ä»¶ï¼ˆå°±æ˜¯ä¸è®© runloop ç¡ï¼ï¼‰ã€‚è¿™ä¸ª Observer çš„ä¼˜å…ˆçº§æ˜¯ 2000000ï¼Œä½äºå¸¸è§çš„å…¶ä»– Observerã€‚å½“ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶åˆ°æ¥æ—¶ï¼ŒRunLoop è¢«å”¤é†’ï¼ŒApp ä¸­çš„ä»£ç ä¼šæ‰§è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºå’Œè°ƒæ•´è§†å›¾å±‚çº§ã€è®¾ç½® UIView çš„ frameã€ä¿®æ”¹ CALayer çš„é€æ˜åº¦ã€ä¸ºè§†å›¾æ·»åŠ ä¸€ä¸ªåŠ¨ç”»ï¼›è¿™äº›æ“ä½œæœ€ç»ˆéƒ½ä¼šè¢« CALayer æ•è·ï¼Œå¹¶é€šè¿‡ CATransaction æäº¤åˆ°ä¸€ä¸ªä¸­é—´çŠ¶æ€å»ï¼ˆCATransaction çš„æ–‡æ¡£ç•¥æœ‰æåˆ°è¿™äº›å†…å®¹ï¼Œä½†å¹¶ä¸å®Œæ•´ï¼‰ã€‚å½“ä¸Šé¢æ‰€æœ‰æ“ä½œç»“æŸåï¼ŒRunLoop å³å°†è¿›å…¥ä¼‘çœ ï¼ˆæˆ–è€…é€€å‡ºï¼‰æ—¶ï¼Œå…³æ³¨è¯¥äº‹ä»¶çš„ Observer éƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚è¿™æ—¶ CA æ³¨å†Œçš„é‚£ä¸ª Observer å°±ä¼šåœ¨å›è°ƒä¸­ï¼ŒæŠŠæ‰€æœ‰çš„ä¸­é—´çŠ¶æ€åˆå¹¶æäº¤åˆ° GPU å»æ˜¾ç¤ºï¼›å¦‚æœæ­¤å¤„æœ‰åŠ¨ç”»ï¼ŒCA ä¼šé€šè¿‡ DisplayLink ç­‰æœºåˆ¶å¤šæ¬¡è§¦å‘ç›¸å…³æµç¨‹ã€‚ å¸ƒå±€&amp;æ¸²æŸ“æ¸²æŸ“å›¾ç‰‡ä¹‹å‰ä¸€å®šè¦å…ˆè®¡ç®—å¥½å°ºå¯¸ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ frameï¼ŒAutoLayout æœ€ç»ˆç»“æœä¹Ÿæ˜¯ frameï¼Œåœ¨ iOS12ä»¥å AutoLayout æ€§èƒ½å¤§å¹…æå‡æ›´æ–°å¸ƒå±€é™åˆ¶çš„è¿‡ç¨‹æ˜¯ï¼šå­â€“&gt;çˆ¶(super.updateConstraintsæœ€åè°ƒç”¨)æ›´æ–°å¸ƒå±€çš„è¿‡ç¨‹æ˜¯ï¼šçˆ¶â€“&gt;å­ (layoutSubview) å¸ƒå±€æ¸²æŸ“ç›¸å…³æ–¹æ³•å¸ƒå±€é™åˆ¶autulayout çš„å¸ƒå±€é™åˆ¶ä¸è¦å°†å¸ƒå±€ æ”¾åˆ° updateContraints æ–¹æ³•ä¸­ï¼Œè¿™é‡Œæ˜¯æ”¾å¤§é‡å¸ƒå±€æ›´æ–°çš„åœ°æ–¹ï¼Œé€šå¸¸å¸ƒå±€ä»£ç æ”¾åœ¨ view çš„ init, awakeFromNib or viewcontroller çš„ viewDidLoadï¼ŒloadView æ–¹æ³•ä¸­setNeedXXXX æ˜¯æ ‡è®°è„å¸ƒå±€ï¼Œåœ¨ä¸‹ä¸€æ¬¡ RunLoopå¾ªç¯çš„æ—¶å€™å°±ä¼šè°ƒç”¨ updateXXX æ–¹æ³•å¸ƒå±€layoutSubViews è¢«ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œæ‰€æœ‰ç›¸å…³çš„å­viewçš„ frame éƒ½å·²ç»è¢« AutoLayout çš„å¸ƒå±€å¼•æ“å¸ƒå±€å¥½äº†ï¼Œéƒ½æœ‰äº†è‡ªå·± frameï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ›´æ”¹ ä»–ä»¬çš„frameäº†æ˜¾ç¤ºï¼ˆCPUï¼‰å—¯ä»¥ä¸Šçš„1~3éƒ½æ˜¯ CPUçš„æ“ä½œdrawRectæ–¹æ³• é€šè¿‡ CoreGraphicåº“ç»˜åˆ¶ 2D imageï¼Œæ”¾åœ¨ layer.contents ç¼–ç äº¤ç»™ Render Serverå¤„ç†åŒç† CALayer çš„ drawLayer æ–¹æ³•CALayer çš„ delegate12345678910111213@protocol CALayerDelegate &lt;NSObject&gt;@optional/* If defined, called by the default implementation of the -display * method, in which case it should implement the entire display * process (typically by setting the `contents' property). */- (void)displayLayer:(CALayer *)layer;/* If defined, called by the default implementation of -drawInContext: */- (void)drawLayer:(CALayer *)layer inContext:(CGContextRef)ctx;@endé»˜è®¤æƒ…å†µ UIView æ˜¯ CALayer çš„CALayerDelegateï¼ŒdrawRect å†…éƒ¨å°±æ˜¯è°ƒç”¨ CALayerDelegateçš„æ–¹æ³• ç»™ Layer ç»˜åˆ¶ contentsåªè¦ layer.contents çš„ä¸œè¥¿äº¤ç”± Render Serverï¼Œå†…éƒ¨render å¼•æ“æ¸²æŸ“å°±æ˜¯ç³»ç»Ÿçš„äº‹äº†æ‰€ä»¥æœ‰äº†å†™å¼‚æ­¥æ¸²æŸ“æ¡†æ¶ï¼Œåªè¦ç¨‹åºå‘˜åœ¨å­çº¿ç¨‹é…ç½®å¥½äº† contentsç„¶ååœ¨ä¸»çº¿ç¨‹äº¤ç»™ layer å°±å¯ä»¥äº†","tags":[{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"},{"name":"æ€§èƒ½ä¼˜åŒ–","slug":"æ€§èƒ½ä¼˜åŒ–","permalink":"https://changzw.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"è‡ªå®šä¹‰ keyboard","date":"2020-02-17T09:18:39.000Z","path":"2020/02/17/è‡ªå®šä¹‰-keyboard/","text":"åŸæ–‡ï¼šCustomKeyboard è‡ªå®šä¹‰é”®ç›˜APIå¼€å‘è‡ªå®šä¹‰é”®ç›˜çš„å¿«é€Ÿå…¥é—¨,å¦‚ä¸‹å›¾ï¼Œå®ƒå±•ç¤ºäº†é”®ç›˜è¿è¡Œè¿‡ç¨‹ä¸­ä¸€äº›é‡è¦çš„å¯¹è±¡ï¼Œä»¥åŠå®ƒä»¬åœ¨å¼€å‘æµç¨‹ä¸­çš„çš„ä½ç½®ï¼šè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿ï¼ˆåœ¨iOSâ€œApplication Extensionâ€ç›®æ ‡æ¨¡æ¿ç»„ï¼‰åŒ…å«ä¸€ä¸ªUIInputViewControllerçš„å­ç±»ï¼Œå®ƒæ˜¯ä½ å¼€å‘çš„é”®ç›˜çš„ä¸»è§†å›¾æ§åˆ¶å™¨ã€‚è¯¥æ¨¡æ¿åŒ…å«é”®ç›˜æ‰€å¿…éœ€çš„â€œä¸‹ä¸€ä¸ªé”®ç›˜â€æŒ‰é’®çš„å®ç°ï¼Œå®ƒè°ƒç”¨äº†UIInputViewControllerç±»çš„advanceToNextInputModeæ–¹æ³•ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥åœ¨è¾“å…¥è§†å›¾æ§åˆ¶å™¨çš„ä¸»è§†å›¾ï¼ˆåœ¨å…¶inputViewå±æ€§ï¼‰ä¸­æ·»åŠ å­è§†å›¾ã€æ§åˆ¶å™¨ä»¥åŠæ‰‹åŠ¿è¯†åˆ«å™¨ç­‰ã€‚å¯¹äºå…¶å®ƒç±»å‹çš„æ‰©å±•åº”ç”¨ï¼Œåœ¨ç›®æ ‡ä¸Šå¹¶ä¸å­˜åœ¨çª—ä½“ï¼Œå› æ­¤ä¹Ÿå°±æ²¡æœ‰æ ¹è§†å›¾æ§åˆ¶å™¨äº†ã€‚åœ¨æ¨¡æ¿çš„Info.plistæ–‡ä»¶ä¸­æœ‰é¢„å…ˆé…ç½®å¥½çš„é”®ç›˜æ‰€éœ€è¦çš„æœ€åŸºæœ¬çš„å€¼ã€‚å‚è§å…¶ä¸­çš„NSExtensionAttributeså­—å…¸å…³é”®å­—ï¼Œé…ç½®ä¸€ä¸ªé”®ç›˜çš„å…³é”®å­—åœ¨ã€Šé…ç½®è‡ªå®šä¹‰é”®ç›˜çš„Info.plistæ–‡ä»¶ã€‹ä¸­æœ‰ä»‹ç»ã€‚é»˜è®¤ï¼Œé”®ç›˜ä¸èƒ½è®¿é—®ç½‘ç»œï¼Œä¸èƒ½å’Œå®ƒçš„appå…±äº«å®¹å™¨ã€‚å¦‚æœè¦å…·å¤‡è¿™ç§èƒ½åŠ›ï¼Œå¿…é¡»è¦å°†Info.plistæ–‡ä»¶ä¸­RequestsOpenAccessçš„å€¼ç½®ä¸ºYESã€‚è¿™éœ€è¦æ‰©å±•é”®ç›˜çš„æ²™ç›’ï¼Œåœ¨ã€Šè®¾è®¡ç”¨æˆ·ä¿¡ä»»ã€‹ä¸­æœ‰ä»‹ç»ç›¸å…³å†…å®¹ã€‚ä¸€ä¸ªè¾“å…¥è§†å›¾æ§åˆ¶å™¨éµä»å„ç§ä¸æ–‡æœ¬è¾“å…¥å¯¹è±¡å†…å®¹äº¤äº’çš„åè®®ï¼šå“åº”è§¦æ‘¸æ¶ˆæ¯æ—¶å¦‚æœè¦æ’å…¥æˆ–åˆ é™¤æ–‡æœ¬ï¼Œå¯ä»¥ä½¿ç”¨UIKeyInputåè®®çš„insertText:å’ŒdeleteBackwardæ–¹æ³•ã€‚å¯ä»¥åœ¨è§†å›¾æ§åˆ¶å™¨çš„textDocumentProxyå±æ€§ä¸­è°ƒç”¨è¿™äº›æ–¹æ³•ï¼Œè¯¥å±æ€§ä»£è¡¨å½“å‰æ–‡æœ¬è¾“å…¥å¯¹è±¡ï¼Œå®ƒéµä»UITextDocumentProxyåè®®ã€‚å¦‚ä¸‹ï¼š123self.textDocumentProxy insertText:@\"hello \"]; // Inserts the string \"hello \" at the insertion point[self.textDocumentProxy deleteBackward]; // Deletes the character to the left of the insertion point[self.textDocumentProxy insertText:@\"\\n\"]; // In a text view, inserts a newline character at the insertion pointåœ¨è°ƒç”¨deleteBackwardä¹‹å‰è¦å…ˆå†³å®šåˆ é™¤çš„å­—ç¬¦æ•°ã€‚å¯ä»¥é€šè¿‡textDocumentProxyçš„documentContextBeforeInputå±æ€§ï¼Œæ¥è·å¾—å…‰æ ‡é™„è¿‘çš„æ–‡æœ¬ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š1NSString *precedingContext = self.textDocumentProxy.documentContextBeforeInput;ä¸ºäº†æ§åˆ¶å…‰æ ‡æ‰€åœ¨ä½ç½®çš„æ“ä½œï¼Œæ¯”å¦‚æ”¯æŒå‘å‰åˆ é™¤æ–‡å­—ï¼Œéœ€è¦è°ƒç”¨UITextDocumentProxyåè®®ä¸­çš„adjustTextPositionByCharacterOffset:æ–¹æ³•ã€‚æ¯”å¦‚å‘å‰åˆ é™¤ä¸€ä¸ªå­—ç¬¦ï¼Œä»£ç å¦‚ä¸‹ï¼š1234- (void) deleteForward &#123; [self.textDocumentProxy adjustTextPositionByCharacterOffset: 1]; [self.textDocumentProxy deleteBackward];&#125;é€šè¿‡å®ç°UITextInputDelegateåè®®ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥å“åº”å½“å‰è¾“å…¥æ–‡æœ¬å¯¹è±¡çš„ä¸€äº›å˜åŒ–ï¼Œæ¯”å¦‚å†…å®¹å˜åŒ–ä»¥åŠç”¨æˆ·è§¦å‘çš„å…‰æ ‡ä½ç½®çš„å˜åŒ–ã€‚ä¸ºäº†å±•ç°ä¸å½“å‰æ–‡æœ¬è¾“å…¥å¯¹è±¡é€‚é…çš„é”®ç›˜å¸ƒå±€ï¼Œéœ€è¦å‚ç…§è¯¥å¯¹è±¡çš„UIKeyboardTypeå±æ€§ï¼Œæ ¹æ®æ¯ç§ä½ çš„é”®ç›˜æ‰€èƒ½æ”¯æŒçš„å±æ€§ï¼Œå˜åŒ–å¸ƒå±€å†…å®¹ã€‚åœ¨è‡ªå®šä¹‰é”®ç›˜ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æ”¯æŒå¤šè¯­è¨€ï¼šä¸ºæ¯ä¸ªè¯­è¨€åˆ›å»ºä¸€ä¸ªé”®ç›˜ï¼Œæ¯ä¸ªé”®ç›˜éƒ½ä½œä¸ºå‘å®¹å™¨appæ·»åŠ çš„ç‹¬ç«‹çš„Targetåˆ›å»ºä¸€ä¸ªå¤šè¯­è¨€é”®ç›˜ï¼ŒåŠ¨æ€åˆ‡æ¢å½“å‰è¯­è¨€ã€‚å¯ä»¥ä½¿ç”¨UIInputViewControllerç±»çš„primaryLanguageå±æ€§æ¥åŠ¨æ€åˆ‡æ¢è¯­è¨€ã€‚æ ¹æ®ä½ è¦æ”¯æŒçš„è¯­è¨€æ•°é‡ä»¥åŠä½ æƒ³æä¾›çš„ç”¨æˆ·ä½“éªŒï¼Œä½ å¯ä»¥ä»ä¸Šé¢é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆã€‚æ¯ç§è‡ªå®šä¹‰é”®ç›˜ï¼ˆéœ€è¦RequestsOpenAccessï¼‰éƒ½å¯ä»¥é€šè¿‡UILexiconç±»è®¿é—®è‡ªåŠ¨çº é”™çš„è¯å…¸ã€‚é€šè¿‡ä½¿ç”¨è¯¥ç±»ï¼Œå¹¶ç»“åˆä½ è‡ªå·±çš„è¯å…¸è®¾è®¡ï¼Œå¯ä»¥åœ¨ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­ä¸ºä»–æä¾›è¾“å…¥å»ºè®®å’Œè‡ªåŠ¨çº é”™ã€‚UILexiconå¯¹è±¡åŒ…å«æ¥è‡ªå¦‚ä¸‹æºçš„å•è¯ï¼šæ¥è‡ªç”¨æˆ·é€šè®¯å½•çš„äººåå’Œå§“åœ¨ è®¾ç½® &gt; é€šç”¨ &gt; é”®ç›˜ &gt; å¿«æ·æ–¹å¼ï¼ˆæ–‡æœ¬æ›¿æ¢ï¼‰ åˆ—è¡¨é€šç”¨è¯å…¸ä½ å¯ä»¥ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€æ¥è°ƒæ•´ä½ çš„è‡ªå®šä¹‰é”®ç›˜ä¸»è§†å›¾çš„é«˜åº¦ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰é”®ç›˜ä¼šæ ¹æ®å±å¹•å°ºå¯¸ä»¥åŠè®¾å¤‡æ–¹å‘ï¼Œå’Œç³»ç»Ÿé”®ç›˜çš„å°ºå¯¸ä¿æŒä¸€è‡´ã€‚è‡ªå®šä¹‰é”®ç›˜çš„å®½åº¦é€šå¸¸ä¸å±å¹•å½“å‰å®½åº¦ä¸€è‡´ã€‚ä¿®æ”¹è‡ªå®šä¹‰é”®ç›˜ä¸»è§†å›¾çš„é«˜åº¦çº¦æŸå³å¯ä¿®æ”¹å…¶é«˜åº¦ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•å®šä¹‰å’Œæ·»åŠ çº¦æŸï¼š12345678910CGFloat _expandedHeight = 500;NSLayoutConstraint *_heightConstraint = [NSLayoutConstraint constraintWithItem: self.view attribute: NSLayoutAttributeHeight relatedBy: NSLayoutRelationEqual toItem: nil attribute: NSLayoutAttributeNotAnAttribute multiplier: 0.0 constant: _expandedHeight];[self.view addConstraint: _heightConstraint]; è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘å…³é”®è‡ªå®šä¹‰é”®ç›˜å¼€å‘æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼šä¿¡ä»»ã€‚ è‡ªå®šä¹‰é”®ç›˜èƒ½è®¿é—®ç”¨æˆ·è¾“å…¥çš„å†…å®¹ ï¼Œå› æ­¤åœ¨é”®ç›˜å’Œç”¨æˆ·é—´å»ºç«‹ä¿¡ä»»éå¸¸å…³é”®ã€‚â€œä¸‹ä¸€ä¸ªé”®ç›˜â€é”®ã€‚ é€šè¿‡é”®ç›˜ç•Œé¢å¿…é¡»èƒ½è®©ç”¨æˆ·èƒ½åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé”®ç›˜ã€‚ ä¸ºç”¨æˆ·ä¿¡ä»»æ‰€åšçš„è®¾è®¡ä½œä¸ºè‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘è€…ï¼Œä½ é¦–å…ˆåº”å½“è€ƒè™‘çš„æ˜¯å¦‚ä½•å»ºç«‹å’Œç»´æŠ¤ç”¨æˆ·ä¿¡ä»»ã€‚ä½ è¦ç†è§£éšç§ç­–ç•¥çš„æœ€ä½³å®è·µå¹¶çŸ¥é“å¦‚ä½•å®ç°å®ƒæ‰èƒ½å¾ˆå¥½åœ°è·µè¡Œã€‚æ³¨æ„æœ¬èŠ‚ä¸ºä½ åˆ›å»ºè‡ªå®šä¹‰é”®ç›˜æä¾›ç›¸å…³çš„å¼€å‘æ‰‹å†Œï¼Œè¯¥æ‰‹å†Œè¦æ±‚å°Šé‡ç”¨æˆ·éšç§ã€‚äº†è§£iOSç¼–ç¨‹è¦æ±‚ï¼Œè¯·é˜…è¯»åº”ç”¨å•†åº—å®¡æ ¸æ‰‹å†Œï¼ŒiOSäººæœºäº¤äº’æ‰‹å†Œï¼ŒiOSå¼€å‘è®¸å¯åè®®ï¼Œè¯·å‚è§è‹¹æœçš„ã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹ï¼Œã€Šæ”¯æŒç”¨æˆ·éšç§ã€‹ï¼Œã€ŠiOSåº”ç”¨ç¼–ç¨‹æŒ‡å—ã€‹ã€‚å¯¹äºé”®ç›˜ï¼Œå¦‚ä¸‹ä¸‰ä¸ªæ–¹é¢å¯¹äºå»ºç«‹å’Œç»´æŠ¤ç”¨æˆ·ä¿¡ä»»è‡³å…³é‡è¦ï¼šæŒ‰é”®æ•°æ®çš„å®‰å…¨ã€‚ ç”¨æˆ·å¸Œæœ›ä»–ä»¬çš„æ•²é”®ä¼šè½åœ¨æ–‡æ¡£ä»¥åŠè¾“å…¥åŒºåŸŸå†…ï¼Œè€Œä¸æ˜¯ä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–è€…ç”¨äºå…¶ä»–ä¸æ˜ç›®çš„ã€‚æœ€å°åŒ–åˆç†åˆ©ç”¨å…¶å®ƒç”¨æˆ·æ•°æ®ã€‚ å¦‚æœä½ çš„é”®ç›˜è¿˜éœ€è¦ä½¿ç”¨å…¶ä»–ç”¨æˆ·æ•°æ®ï¼Œä¾‹å¦‚å®šä½æœåŠ¡æˆ–è€…é€šè®¯å½•ï¼Œä½ æœ‰ä¹‰åŠ¡è§£é‡Šè¿™ç»™ç”¨æˆ·å¸¦æ¥çš„å¥½å¤„æ˜¯ä»€ä¹ˆã€‚å‡†ç¡®ã€‚ æŠŠè¾“å…¥äº‹ä»¶è½¬æ¢æˆæ–‡æœ¬è¦æ±‚ç²¾å‡†ï¼Œè¿™æœ¬èº«è™½ç„¶ä¸æ˜¯ä¸€ä¸ªéšç§è¯é¢˜ï¼Œä½†ä»–ä¼šå½±å“åˆ°ä¿¡ä»»ï¼šæ¯æ¬¡æ–‡å­—è½¬æ¢éœ€è¦ä½“ç°å‡ºä½ çš„ä»£ç çš„ç²¾å‡†ã€‚åœ¨ä¿¡ä»»çš„å¼€å‘è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆè€ƒè™‘çš„æ˜¯æ˜¯å¦è¦è·å–open accessæƒé™ã€‚å°½ç®¡å¼€å¯äº†open accessæƒé™èƒ½ç»™è‡ªå®šä¹‰é”®ç›˜å¼€å‘å¸¦æ¥æå¤§ä¾¿åˆ©ï¼Œä½†è¿™ä¹Ÿå¢åŠ äº†ä½ ä½œä¸ºå¼€å‘è€…çš„è´£ä»»ã€‚ä¸‹é¢æ˜¯æ ‡å‡†çš„open accessçš„èƒ½åŠ›å’Œéšç§è€ƒè™‘ï¼šOpen Accessèƒ½åŠ›å’Œé™åˆ¶éšç§è€ƒè™‘Off(default)Â·é”®ç›˜å¯ä»¥æ‰§è¡Œæ‰€æœ‰åŸºæœ¬é”®ç›˜çš„èŒè´£Â·å¯ä»¥è®¿é—®é€šç”¨è¯å…¸ä»¥æ”¯æŒè‡ªåŠ¨çº é”™å’Œè¾“å…¥å»ºè®®Â·è®¿é—®è®¾ç½®é‡Œçš„å¿«æ·çŸ­è¯­Â·ä¸ä¸containingåº”ç”¨å…±äº«å®¹å™¨Â·ä¸è®¿é—®é”®ç›˜å®¹å™¨ä»¥å¤–çš„æ–‡ä»¶ç³»ç»ŸÂ·ä¸è®¿é—®é”®ç›˜å®¹å™¨ä»¥å¤–çš„æ–‡ä»¶ç³»ç»ŸÂ·ä¸èƒ½ç›´æ¥æˆ–é—´æ¥è®¿é—®iCloudæˆ–æ¸¸æˆä¸­å¿ƒæˆ–åº”ç”¨å†…è´­ä¹°ç”¨æˆ·äº†è§£æŒ‰é”®ä»…ä»…è¢«å‘é€åˆ°å½“å‰ä½¿ç”¨é”®ç›˜çš„åº”ç”¨é‡ŒOnÂ·å…·å¤‡éè”ç½‘è‡ªå®šä¹‰é”®ç›˜çš„æ‰€æœ‰èƒ½åŠ›Â·åœ¨ç”¨æˆ·è®¸å¯æƒ…å†µä¸‹å¯ä»¥è®¿é—®ä½ç½®æœåŠ¡å’Œé€šè®¯å½•Â·é”®ç›˜å’Œcontaining appå¯ä»¥è®¿é—®å…±äº«å®¹å™¨Â·é”®ç›˜å¯ä»¥ä¸ºæœåŠ¡å™¨ä¾§å¤„ç†è¿‡ç¨‹å‘é€æŒ‰é”®æˆ–å…¶ä»–è¾“å…¥äº‹ä»¶Â·containing appè‡ªåŠ¨çº é”™å­—å…¸æä¾›ç¼–è¾‘ç•Œé¢Â·é€šè¿‡containing appé”®ç›˜å¯ä»¥ä½¿ç”¨iCloudæ¥ä¿è¯è‡ªåŠ¨çº é”™è¯å…¸å’Œè®¾ç½®çš„æ›´æ–°Â·é€šè¿‡containing appï¼Œé”®ç›˜å¯ä»¥å‚ä¸åˆ°æ¸¸æˆä¸­å¿ƒå’Œåº”ç”¨å†…è´­ä¹°Â·å¦‚æœé”®ç›˜æ”¯æŒç§»åŠ¨è®¾å¤‡ç®¡ç†(MDM)ï¼Œå®ƒå¯ä¸è¢«ç®¡ç†çš„åº”ç”¨å…±åŒå·¥ä½œÂ·ç”¨æˆ·äº†è§£é”®ç›˜å¼€å‘è€…ä¼šåˆ©ç”¨æŒ‰é”®æ•°æ®Â·ä½ å¿…é¡»éµå®ˆæœ‰è”ç½‘èƒ½åŠ›çš„é”®ç›˜å¼€å‘æ‰‹å†Œå’ŒiOSå¼€å‘è®¸å¯åè®®ï¼Œå¯å‚è§ã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹å¦‚æœä½ çš„è‡ªå®šä¹‰é”®ç›˜ä¸éœ€è¦open accessæƒé™ï¼Œç³»ç»Ÿç¡®ä¿æ•²é”®ä¿¡æ¯ä¸ä¼šè¢«å‘é€ç»™ä½ çš„é”®ç›˜ä»¥åŠåˆ«çš„åœ°æ–¹ã€‚å¦‚æœåªæƒ³æä¾›ä¸€èˆ¬çš„é”®ç›˜åŠŸèƒ½ï¼Œè¯·ä¸è¦ç»™é”®ç›˜é…å¤‡è”ç½‘èƒ½åŠ›ã€‚ç”±äºæœ‰æ²™ç›’é™åˆ¶ï¼Œä¸è”ç½‘çš„é”®ç›˜ä¸€å®šæ˜¯æ»¡è¶³è‹¹æœçš„æ•°æ®éšç§æ‰‹å†Œå¹¶èƒ½è·å¾—ç”¨æˆ·ä¿¡ä»»çš„ã€‚å¼€å¯open accessæƒé™ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼Œå¯ä»¥åœ¨Info.plistæ–‡ä»¶ä¸­é…ç½®ï¼‰ï¼Œèƒ½ç»™ä½ çš„å¼€å‘å¸¦æ¥æ›´å¤šå¯èƒ½æ€§ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥æ›´å¤šçš„è´£ä»»ã€‚æ³¨æ„å‘åº”ç”¨å•†åº—æäº¤ä¸€ä¸ªopen-accessçš„é”®ç›˜å¿…é¡»éµå®ˆè‹¹æœã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹ä¸­çš„ç›¸å…³æ¡æ¬¾ã€‚æ¯ä¸€ä¸ªä¸open accessç›¸å…³çš„åŠŸèƒ½éƒ½éœ€è¦ä½ å±¥è¡Œç›¸åº”çš„è´£ä»»ï¼Œåº”å½“æœ€å¤§é™åº¦åœ°å°Šé‡ç”¨æˆ·æ•°æ®ï¼Œä¸å¾—ç”¨äºä¸ç”¨æˆ·è¾“å…¥æ— å…³çš„å…¶ä»–ä»»ä½•ç›®çš„ã€‚ä¸‹è¡¨åˆ—å‡ºäº†open accesså¸¦æ¥çš„å¥½å¤„ä»¥åŠå¼€å‘è€…éœ€æ‰¿æ‹…çš„è´£ä»»ï¼šèƒ½åŠ›ç”¨æˆ·åˆ©ç›Šç¤ºä¾‹å¼€å‘è€…è´£ä»»ä¸containing appå…±äº«å®¹å™¨ä¸ºé”®ç›˜çš„è‡ªåŠ¨çº é”™è¯å…¸ç®¡ç†UIç•Œé¢è¦è€ƒè™‘åˆ°è‡ªåŠ¨çº é”™æ•°æ®å±äºç”¨æˆ·éšç§ã€‚ä¸è¦æŠŠä»–å‘åˆ°ä½ çš„æœåŠ¡å™¨ï¼Œç”¨ä½œä¸è¾“å…¥æ— å…³çš„ç”¨é€”ã€‚æŠŠæŒ‰é”®æ•°æ®å‘åˆ°ä½ çš„æœåŠ¡å™¨é€šè¿‡å¼€å‘è€…çš„è®¡ç®—èµ„æºå¯ä»¥æä¾›æ›´å¥½çš„æŒ‰é”®å¤„ç†ç»“æœå’Œè¾“å…¥é¢„æµ‹åªæœ‰ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è¾“å…¥ä½“éªŒä¹‹ç”¨æ—¶ï¼Œæ‰èƒ½ä¿å­˜æŒ‰é”®å’Œè¯­éŸ³æ•°æ®åŸºäºäº‘çš„è‡ªåŠ¨çº é”™è¯å…¸æŠŠäººåã€åœ°åã€çƒ­ç‚¹æ–°é—»åŠ å…¥åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­ä¸è¦æŠŠç”¨æˆ·èº«ä»½ä¸è¾“å…¥æ•°æ®å…³è”èµ·æ¥ï¼Œä¸å¾—å°†ç”¨æˆ·ä¿¡æ¯ç”¨ä½œä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„é€šè®¯å½•æŠŠäººåã€åœ°åã€ç”µè¯å·ç æ·»åŠ åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­ä¸å¾—è®²é€šè®¯å½•ç”¨ä½œä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„ä½ç½®æœåŠ¡å°†é™„è¿‘çš„åœ°åæ·»åŠ åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­ä¸è¦åœ¨åå°ä½¿ç”¨ä½ç½®æœåŠ¡ï¼Œä¸å¾—å°†ä½ç½®ä¿¡æ¯å‘é€åˆ°ä½ çš„æœåŠ¡å™¨å¹¶ç”¨äºä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„ä¸€ä¸ªå…·æœ‰open-accessæƒé™çš„é”®ç›˜å’Œå…¶containing appèƒ½å°†æŒ‰é”®æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œé€šè¿‡è¿™äº›æ•°æ®å¯ä»¥ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è¾“å…¥ä½“éªŒã€‚å¦‚æœä½ ä½¿ç”¨äº†è¿™äº›èƒ½åŠ›ï¼Œå½“ä¸éœ€è¦è¿™äº›æ•°æ®çš„æ—¶å€™ï¼Œè¯·åŠæ—¶åœ¨æœåŠ¡å™¨ç«¯åˆ é™¤ã€‚å‚è§ä¸Šé¢çš„è¡¨æ ¼æ¥å±¥è¡Œä½ ä½¿ç”¨open-accessæƒé™ä¸­çš„ä¹‰åŠ¡ã€‚ æä¾›åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜çš„æ–¹æ³•ç³»ç»Ÿé”®ç›˜çš„å°åœ°çƒæŒ‰é”®ç”¨äºåˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ï¼šä½ çš„è‡ªå®šä¹‰é”®ç›˜å¿…é¡»æä¾›ç±»ä¼¼çš„æœºåˆ¶èƒ½åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ã€‚è°ƒç”¨UIInputViewControllerç±»çš„advanceToNextInputModeæ–¹æ³•å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ã€‚ç³»ç»Ÿä¼šé€‰æ‹©ä¸‹ä¸€ä¸ªé”®ç›˜ï¼Œæ²¡æœ‰èƒ½è·å¾—é”®ç›˜åˆ—è¡¨çš„APIï¼Œä¹Ÿæ²¡æœ‰åˆ‡æ¢åˆ°æŒ‡å®šé”®ç›˜çš„APIã€‚Xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿ä¸­å°±å·²ç»åœ¨ä¸‹ä¸€ä¸ªé”®ç›˜æŒ‰é’®ä¸Šå…·å¤‡äº†advanceToNextInputModeçš„åŠŸèƒ½ã€‚ä¸ºäº†æä¾›æœ€å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œåº”å½“æŠŠä½ çš„ä¸‹ä¸€ä¸ªé”®ç›˜æŒ‰é”®æ”¾åœ¨é è¿‘ç³»ç»Ÿé”®ç›˜çš„å°åœ°çƒé”®çš„ä½ç½®ã€‚æ³¨æ„è¦é€šè¿‡åº”ç”¨å®¡æ ¸ï¼Œå¿…é¡»åœ¨ä½ çš„é”®ç›˜ä¸Šæä¾›æ˜æ˜¾å…è®¸ç”¨æˆ·åˆ‡æ¢é”®ç›˜çš„UIæ ‡è¯†ã€‚ å¼€å§‹è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘ ä½¿ç”¨Xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿åˆ›å»ºé”®ç›˜åŠå…¶containing appä¸å…¶ä»–æ‰©å±•åº”ç”¨ç•¥æœ‰ä¸åŒã€‚æœ¬èŠ‚å°†å¸¦ä½ é¢†ç•¥åŸºæœ¬é”®ç›˜çš„å¼€å‘å’Œè¿è¡Œã€‚åœ¨ä¸€ä¸ªå®¹å™¨appä¸­åˆ›å»ºé”®ç›˜ï¼Œæ­¥éª¤å¦‚ä¸‹åœ¨Xcodeä¸­é€‰æ‹©File &gt; New &gt; Project &gt; iOS &gt; Applicationé€‰æ‹©Single View Applicationæ¨¡æ¿ã€‚ç‚¹å‡»Nextã€‚å¡«å†™Project Nameï¼ˆå¦‚CKImeï¼‰ï¼Œç‚¹å‡»Nextã€‚é€‰æ‹©è¦ä¿å­˜çš„ä½ç½®ï¼Œç‚¹å‡»Createã€‚è¿™æ ·ï¼Œä½ å°±æœ‰äº†ä¸€ä¸ªç©ºappï¼Œè¯¥appåªèƒ½å®Œæˆä¸€ä¸ªç®€å•çš„æ“ä½œï¼Œæ¥ä¸‹æ¥å®ƒå°†æ‰¿è½½é”®ç›˜ã€‚åœ¨ä½ æäº¤åˆ°åº”ç”¨å•†åº—ä¹‹å‰ï¼Œä½ éœ€è¦å®Œæˆä¸€äº›æœ‰ç”¨çš„åŠŸèƒ½ã€‚è¯·åˆ°åº”ç”¨å®¡æ ¸æ”¯æŒå‚è€ƒåº”ç”¨å•†åº—å®¡æ ¸æŒ‡å—ã€‚é€‰æ‹©File &gt; New &gt; Target &gt; iOS &gt; Application Extensioné€‰æ‹©Custom Keyboard Extensionï¼Œç‚¹å‡»Nextã€‚å¡«å†™Product Nameï¼ˆå¦‚CKbdï¼‰ï¼Œç‚¹å‡»Finishã€‚ç¡®è®¤Projectå’ŒEmbed in Applicationä¸­éƒ½æ˜¾ç¤ºçš„æ˜¯å®¹å™¨appçš„åå­—ï¼ˆCKImeï¼‰ï¼Œç‚¹å‡»Finishã€‚å¦‚æœå¼¹å‡ºActivate â€œCKbdâ€ schemeæç¤ºè®©æ¿€æ´»é”®ç›˜å·¥ç¨‹ï¼Œç‚¹å‡»Activateã€‚å®šä¹‰é”®ç›˜group nameï¼Œæ­¥éª¤å¦‚ä¸‹ï¼šåœ¨Xcodeå·¥ç¨‹å¯¼èˆªè§†å›¾ä¸­ï¼Œé€‰æ‹©å®¹å™¨appçš„Info.plistæ–‡ä»¶ï¼Œåœ¨å³ä¾§plistç¼–è¾‘å™¨ä¸­ï¼Œé¼ æ ‡hoveråˆ°Bundle nameä¸Šï¼Œç‚¹â€œ+â€æŒ‰é’®åˆ›å»ºä¸€è¡Œç©ºå±æ€§ã€‚åœ¨Keyä¸­å¡«å†™Bundle display nameï¼Œå›è½¦åŒå‡»è¯¥è¡Œçš„Valueï¼Œå¡«å†™ä½ è¦è‡ªå®šä¹‰çš„é”®ç›˜group nameã€‚é€‰æ‹©File &gt; Saveä¿å­˜è®¾ç½®ã€‚ä¸‹è¡¨æ±‡æ€»äº†åœ¨å®¹å™¨appå’Œé”®ç›˜appçš„Info.plistæ–‡ä»¶ä¸­ä½ å¯ä»¥é…ç½®çš„UIå­—ç¬¦ä¸²ï¼šiOS UIå­—ç¬¦ä¸²Info.plistå…³é”®å­—Â· åœ¨ç³»ç»Ÿè®¾ç½®çš„å·²è´­é”®ç›˜åˆ—è¡¨ä¸­çš„é”®ç›˜group nameåœ¨å®¹å™¨appçš„Info.plistæ–‡ä»¶ä¸­çš„Bundle display nameÂ· ç³»ç»Ÿè®¾ç½®ä¸­çš„é”®ç›˜åç§°Â· é”®ç›˜æ¢åˆ—è¡¨ä¸­çš„é”®ç›˜åç§°åœ¨é”®ç›˜appçš„Info.plistæ–‡ä»¶ä¸­çš„Bundle display nameè¿è¡Œè‡ªå®šä¹‰é”®ç›˜å¹¶å°†Xcodeè°ƒè¯•å™¨attachåˆ°å®ƒä¸Šé¢åœ¨Xcodeï¼Œä½ çš„view controllerå®ç°ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ¯”å¦‚å¯ä»¥æ–­åœ¨viewDidLoadä¸Šï¼‰ã€‚åœ¨Xcodeå·¥å…·æ ç¡®ä¿å½“å‰æ´»åŠ¨çš„é¡¹ç›®ä¸ºé”®ç›˜é¡¹ç›®ï¼Œå¹¶å¯¹åº”iOSæ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡ã€‚é€‰æ‹©èœå•Project &gt; Runï¼Œæˆ–ç‚¹å‡»Build and then run the current schemeæŒ‰é’®ï¼ˆå³æ’­æ”¾æŒ‰é’®ï¼‰ã€‚Xcodeä¼šæç¤ºé€‰æ‹©host appã€‚é€‰æ‹©ä¸€ä¸ªå¸¦æœ‰è¾“å…¥æ¡†çš„ï¼Œæ¯”å¦‚é€šè®¯å½•æˆ–Safariã€‚ç‚¹å‡»Runã€‚Xcodeå°†è¿è¡Œèµ·ä½ æŒ‡å®šçš„host appã€‚å¦‚æœè¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨é”®ç›˜æ‰©å±•åº”ç”¨ï¼Œéœ€è¦ç°åœ¨è®¾ç½®ä¸­æ·»åŠ å¹¶å¯ç”¨é”®ç›˜ï¼šSettings &gt; General &gt; Keyboard &gt; Keyboardsç‚¹å‡»Add New Keyboardâ€¦åœ¨OTHER IPHONE KEYBOARDSä¸­ç‚¹å‡»ä½ åˆšåˆšåˆ›å»ºçš„é”®ç›˜åœ¨iOSæ¨¡æ‹Ÿå™¨æˆ–çœŸæœºä¸Šï¼Œè°ƒå‡ºä½ çš„è‡ªå®šä¹‰é”®ç›˜ã€‚ç‚¹å‡»ä»»æ„å¯è¾“å…¥åŒºåŸŸï¼Œå°†æ˜¾ç¤ºå‡ºç³»ç»Ÿé”®ç›˜ã€‚æŒ‰ä½å°åœ°çƒï¼Œé€‰æ‹©ä½ çš„è‡ªå®šä¹‰é”®ç›˜ã€‚æ­¤æ—¶ä½ å°†çœ‹åˆ°è‡ªå®šä¹‰é”®ç›˜ï¼Œä½†æ˜¯è°ƒè¯•å™¨å°šæœªattachä¸Šæ¥ã€‚ä¸€ä¸ªä»æ¨¡æ¿æ„å»ºè€Œæ¥çš„æç®€é”®ç›˜ä»…æœ‰ä¸€ä¸ªNext KeyboardæŒ‰é’®ï¼Œç‚¹å‡»ååˆ‡æ¢å›å‰ä¸€ä¸ªé”®ç›˜ã€‚å–æ¶ˆä½ çš„é”®ç›˜ï¼ˆä»¥ä¾¿åœ¨ç¬¬8æ­¥ä¸­ä½ å¯ä»¥å†æ¬¡è°ƒå‡ºé”®ç›˜ä»¥å‘½ä¸­viewDidLoadæ–­ç‚¹ï¼‰åœ¨Xcodeä¸­ï¼Œé€‰æ‹©Debug &gt; Attach to Process &gt; By Process Identifier(PID) or Name åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ï¼Œè¾“å…¥ä½ çš„é”®ç›˜æ‰©å±•åº”ç”¨çš„åå­—ï¼ˆåŒ…å«ç©ºæ ¼ï¼‰.é»˜è®¤å°±æ˜¯è¯¥æ‰©å±•åº”ç”¨åœ¨å·¥ç¨‹å¯¼èˆªçª—å£é‡Œçš„group nameã€‚ç‚¹å‡»Attachã€‚Xcodeå°†æ˜¾ç¤ºå‡ºç­‰å¾…attachçš„è°ƒè¯•å™¨ã€‚åœ¨ä»»æ„èƒ½è¾“å…¥æ–‡å­—çš„appä¸­è°ƒå‡ºé”®ç›˜ã€‚å½“ä½ çš„é”®ç›˜ä¸»è§†å›¾å¼€å§‹åŠ è½½æ—¶ï¼ŒXcodeè°ƒè¯•å™¨å°†attacheåˆ°ä½ çš„é”®ç›˜ï¼Œå¹¶å‘½ä¸­æ–­ç‚¹ã€‚ ä¸ºè‡ªå®šä¹‰é”®ç›˜é…ç½®Info.plistæ–‡ä»¶è‡ªå®šä¹‰é”®ç›˜çš„Info.plistæ–‡ä»¶å…è®¸é™æ€å®šä¹‰é”®ç›˜çš„ç°å¼ç‰¹å¾ï¼ŒåŒ…æ‹¬ä¸»è¦è¯­è¨€ï¼Œä»¥åŠæ˜¯å¦éœ€è¦open accessæƒé™ã€‚æ‰“å¼€Xcodeå¹¶åˆ‡æ¢åˆ°è‡ªå®šä¹‰é”®ç›˜çš„ targetã€‚åœ¨å·¥ç¨‹å¯¼èˆªæ é€‰æ‹©Info.plistæ–‡ä»¶ï¼ŒæŒ‰æ–‡æœ¬æ ¼å¼å‘ˆç°å¦‚ä¸‹ï¼š123456789101112131415161718&lt;key&gt;NSExtension&lt;/key&gt;&lt;dict&gt; &lt;key&gt;NSExtensionAttributes&lt;/key&gt; &lt;dict&gt; &lt;key&gt;IsASCIICapable&lt;/key&gt; &lt;false/&gt; &lt;key&gt;PrefersRightToLeft&lt;/key&gt; &lt;false/&gt; &lt;key&gt;PrimaryLanguage&lt;/key&gt; &lt;string&gt;en-US&lt;/string&gt; &lt;key&gt;RequestsOpenAccess&lt;/key&gt; &lt;false/&gt; &lt;/dict&gt; &lt;key&gt;NSExtensionPointIdentifier&lt;/key&gt; &lt;string&gt;com.apple.keyboard-service&lt;/string&gt; &lt;key&gt;NSExtensionPrincipalClass&lt;/key&gt; &lt;string&gt;KeyboardViewController&lt;/string&gt;&lt;/dict&gt;æ¯ä¸ªå…³é”®å­—åœ¨App Extension Keysä¸­éƒ½æœ‰è§£é‡Šã€‚å¯ä»¥ä½¿ç”¨å­—å…¸NSExtensionAttributesä¸­çš„å…³é”®å­—æ¥æè¿°ä½ çš„è‡ªå®šä¹‰é”®ç›˜çš„ç‰¹å¾å’Œéœ€æ±‚ï¼Œå¦‚ä¸‹ï¼šIsASCIICapable - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚ç”¨æˆ·é”®ç›˜æ˜¯å¦å¯ä»¥å‘æ–‡æ¡£ä¸­æ’å…¥ASCIIå­—ä¸²ã€‚å¦‚æœè¦ä¸ºUIKeyboardTypeASCIICapableå±æ€§çš„è¾“å…¥å¯¹è±¡å±•ç°å•ç‹¬ç±»å‹çš„é”®ç›˜ï¼Œéœ€è¦å°†è¯¥å€¼ç½®ä¸ºYESã€‚PrefersRightToLeft - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚æ˜¯å¦ä¸ºä»å³åˆ°å·¦çš„è¯­ç§è®¾è®¡çš„çš„è‡ªå®šä¹‰é”®ç›˜ã€‚PrimaryLanguage - é»˜è®¤ä¸ºen-USçš„å­—ä¸²ã€‚ä»¥&lt;è¯­ç§&gt;-&lt;åŒºåŸŸ&gt;çš„å½¢å¼æè¿°é”®ç›˜çš„ä¸»è¯­è¨€ã€‚å¯ä»¥åˆ°http://www.opensource.apple.com/source/CF/CF-476.14/CFLocaleIdentifier.cæ‰¾åˆ°å¯¹åº”çš„è¯­ç§å’ŒåŒºåŸŸã€‚RequestsOpenAccess - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚æ˜¯å¦éœ€è¦æ¯”åŸºç¡€é”®ç›˜æ›´å¤§çš„æ²™ç›’èŒƒå›´ã€‚æŠŠè¯¥å€¼ç½®ä¸ºYESå°†éœ€è¦å®Œå…¨è®¿é—®æƒé™ï¼Œä½ çš„é”®ç›˜å°†è·å¾—å¦‚ä¸‹èƒ½åŠ›ï¼Œæ¯ä¸ªèƒ½åŠ›éƒ½ä¼´éšæœ‰ç›¸åº”çš„æƒé™ï¼šè®¿é—®å®šä½æœåŠ¡ï¼Œé€šè®¯å½•æ•°æ®åº“ï¼Œç›¸æœºï¼Œæ¯ä¸ªéƒ½éœ€è¦ç”¨æˆ·å…è®¸ä¸é”®ç›˜çš„å®¹å™¨appå…±äº«å®¹å™¨æ•°æ®ï¼Œä»¥ä¾¿å®Œæˆæ¯”å¦‚åœ¨å®¹å™¨appä¸­ç®¡ç†ç”¨æˆ·è¯åº“çš„ç•Œé¢çš„åŠŸèƒ½é€šè¿‡ç½‘ç»œå‘é€æŒ‰é”®ã€è¾“å…¥äº‹ä»¶ä¹‹ç±»çš„æ•°æ®ä¾›äº‘ç«¯å¤„ç†ä½¿ç”¨UIPasteboardç±»æ’­æ”¾éŸ³é¢‘ï¼ŒåŒ…æ‹¬ä½¿ç”¨playInputClickæ–¹æ³•æ’­æ”¾æŒ‰é”®éŸ³è®¿é—®iCloudï¼Œå¯ä»¥ç”¨æ¥æ ¹æ®ç”¨æˆ·èº«ä»½åŒæ­¥æ¯”å¦‚é”®ç›˜è®¾ç½®ã€è‡ªå®šä¹‰è‡ªåŠ¨çº é”™è¯å…¸é€šè¿‡å®¹å™¨appè®¿é—®æ¸¸æˆä¸­å¿ƒå’Œåº”ç”¨å†…è´­ä¹°å¦‚æœä½ çš„é”®ç›˜æ”¯æŒç§»åŠ¨è®¾å¤‡ç®¡ç†ï¼ˆMDMï¼‰ï¼Œå¯ä»¥ä¸è¢«ç®¡ç†çš„appæ— ç¼åˆä½œå½“è€ƒè™‘æ˜¯å¦å°†è¿™äº›å…³é”®å­—è®¾ç½®ä¸ºYESä¹‹å‰ï¼Œä¸€å®šè¦å…ˆé˜…è¯»ã€Šç”¨æˆ·ä¿¡ä»»è®¾è®¡ã€‹ï¼Œè¿™é‡Œæè¿°äº†å¦‚ä½•å°Šé‡å’Œä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"AppExtensions","slug":"iOS-Programming/AppExtensions","permalink":"https://changzw.github.io/categories/iOS-Programming/AppExtensions/"}]},{"title":"runloop å®è·µç›¸å…³","date":"2019-12-29T11:00:54.000Z","path":"2019/12/29/runloop/runloop-å®è·µç›¸å…³/","text":"RunLoop æ˜¯ç³»ç»Ÿå±‚çº§ä¸Šçš„è®¾è®¡ï¼Œç”¨æ¥ç»™ç®¡ç†ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—æ´¾å‘ï¼Œé‚£æˆ‘ä»¬éƒ½å¯ä»¥ç”¨ runLoop åšä»€ä¹ˆå‘¢ï¼Ÿç®€å•æ¥è¯´ï¼ŒRunLoop æ˜¯ç”¨æ¥ç›‘å¬è¾“å…¥æºï¼Œè¿›è¡Œè°ƒåº¦å¤„ç†çš„ã€‚RunLoop è¾“å…¥æºå¯ä»¥æ˜¯ï¼šè¾“å…¥è®¾å¤‡ç½‘ç»œå‘¨æœŸæ€§æˆ–è€…å»¶è¿Ÿæ—¶é—´å¼‚æ­¥å›è°ƒrunloop çš„ observer å¯ä»¥ç›‘å¬çš„ 7ä¸­çŠ¶æ€12345678910typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123; kCFRunLoopEntry , // è¿›å…¥ loop kCFRunLoopBeforeTimers , // è§¦å‘ Timer ä¹‹å‰ kCFRunLoopBeforeSources , // è§¦å‘ Source0 ä¹‹å‰ kCFRunLoopBeforeWaiting , // ç­‰å¾… mach_port æ¶ˆæ¯ï¼ˆç­‰å¾…æºSourceå’Œè®¡æ—¶å™¨Timerä¹‹å‰ï¼Œè¿›å…¥ç¡çœ ï¼‰ // åœ¨è¿™ä¸¤ä¸ªçŠ¶æ€ä¸­çœŸæ­£å¤„ç†äº‹ä»¶ kCFRunLoopAfterWaiting ), // æ¥æ”¶ mach_port æ¶ˆæ¯ï¼ˆç­‰å¾…æºSourceå’Œè®¡æ—¶å™¨Timeråï¼ŒåŒæ—¶åœ¨è¢«å”¤é†’ä¹‹å‰ï¼‰ kCFRunLoopExit , // é€€å‡º loop kCFRunLoopAllActivities // loop æ‰€æœ‰çŠ¶æ€æ”¹å˜&#125; æ£€æµ‹ iOS App å¡é¡¿ æ€è·¯åˆ†æ å¡é¡¿å¦‚ä½•é€ æˆçš„iOSç³»ç»Ÿé¡µé¢åˆ·æ–°é¢‘ç‡ï¼š60 FPSï¼Œ60æ¬¡/s, let refresh_time_per = 1s/60 &lt; 0.02å¦‚æœåœ¨ refresh_time_per æ—¶é—´å†…æ²¡æœ‰å®Œæˆå›¾ç‰‡ç»˜åˆ¶ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ï¼è€Œç³»ç»Ÿé¡µé¢åˆ·æ–°äº‹ä»¶å¤„ç†â€¦â€¦ äº‹ä»¶å‡ ä¹éƒ½æ˜¯ç”± runloop è°ƒç”¨æ‰§è¡Œçš„ã€‚é‚£ä¹ˆå¦‚æœ runloop ä¸€æ¬¡å¾ªç¯æ—¶é—´ &gt; refresh_time_per å°±è¯´æ˜å›¾ç‰‡æ²¡æœ‰æ¸²æŸ“å®Œæˆï¼Œå¯¼è‡´å¡é¡¿ã€‚é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åˆ¤æ–­ runloop ä¸€æ¬¡å¾ªç¯æ—¶é—´ &gt; refresh_time_per å‘¢ï¼ŸRunLoop çš„çº¿ç¨‹ï¼Œè¿›å…¥ç¡çœ å‰æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´è¿‡é•¿è€Œå¯¼è‡´æ— æ³•è¿›å…¥ç¡çœ ï¼Œæˆ–è€…çº¿ç¨‹å”¤é†’åæ¥æ”¶æ¶ˆæ¯æ—¶é—´è¿‡é•¿è€Œæ— æ³•è¿›å…¥ä¸‹ä¸€æ­¥çš„è¯ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯çº¿ç¨‹å—é˜»äº†ã€‚å¦‚æœè¿™ä¸ªçº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹çš„è¯ï¼Œè¡¨ç°å‡ºæ¥çš„å°±æ˜¯å‡ºç°äº†å¡é¡¿ã€‚æ‰€ä»¥è¦åˆ©ç”¨ RunLoop åŸç†æ¥ç›‘æ§å¡é¡¿çš„è¯ï¼Œå°±æ˜¯è¦å…³æ³¨è¿™ä¸¤ä¸ªé˜¶æ®µã€‚RunLoop çš„ä¸¤ä¸ª loop çŠ¶æ€åœ¨è¿›å…¥ç¡çœ ä¹‹å‰: kCFRunLoopBeforeSourcesåœ¨è¿›å…¥å”¤é†’ä¹‹å: kCFRunLoopAfterWaitingä¹Ÿå°±æ˜¯è¦è§¦å‘ Source0 å›è°ƒå’Œæ¥æ”¶ mach_port æ¶ˆæ¯ä¸¤ä¸ªçŠ¶æ€ã€‚runloop æ ¸å¿ƒæºç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071// while// 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeTimers);// 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeSources);// æ‰§è¡Œè¢«åŠ å…¥çš„block__CFRunLoopDoBlocks(runloop, currentMode);// 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚sourceHandledThisLoop = __CFRunLoopDoSources0(runloop, currentMode, stopAfterHandle);// æ‰§è¡Œè¢«åŠ å…¥çš„block__CFRunLoopDoBlocks(runloop, currentMode);// 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚if (__Source0DidDispatchPortLastTime) &#123; Boolean hasMsg = __CFRunLoopServiceMachPort(dispatchPort, &amp;msg) if (hasMsg) goto handle_msg;&#125;// é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚if (!sourceHandledThisLoop) &#123; __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeWaiting);&#125;// 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ã€‚// â€¢ ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚// â€¢ ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†// â€¢ RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†// â€¢ è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’__CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort) &#123; mach_msg(msg, MACH_RCV_MSG, port); // thread wait for receive msg&#125;// 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†ã€‚__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopAfterWaiting);// æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚handle_msg: // 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒã€‚if (msg_is_timer) &#123; __CFRunLoopDoTimers(runloop, currentMode, mach_absolute_time())&#125;// 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblockã€‚else if (msg_is_dispatch) &#123; __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);&#125;// 9.3 å¦‚æœä¸€ä¸ª Source1 (åŸºäºport) å‘å‡ºäº‹ä»¶äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶else &#123; CFRunLoopSourceRef source1 = __CFRunLoopModeFindSourceForMachPort(runloop, currentMode, livePort); sourceHandledThisLoop = __CFRunLoopDoSource1(runloop, currentMode, source1, msg); if (sourceHandledThisLoop) &#123; mach_msg(reply, MACH_SEND_MSG, reply); &#125;&#125;// é€€å‡º runloop é€»è¾‘ retVal != 0 exitif (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123; // è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚ retVal = kCFRunLoopRunHandledSource;&#125; else if (timeout) &#123; // è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº† retVal = kCFRunLoopRunTimedOut;&#125; else if (__CFRunLoopIsStopped(runloop)) &#123; // è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº† retVal = kCFRunLoopRunStopped;&#125; else if (__CFRunLoopModeIsEmpty(runloop, currentMode)) &#123; // source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº† retVal = kCFRunLoopRunFinished;&#125; å¡é¡¿ç›‘å¬å®è·µåˆ›å»º runloop çš„observerå¯¹è±¡:123let weakSelf = Unmanaged&lt;Monitor&gt;.passUnretained(self).toOpaque()var ctx: CFRunLoopObserverContext = CFRunLoopObserverContext(version: 0, weakSelf: info, retain: nil, release: nil, copyDescription: nil)self.runLoopObserver = CFRunLoopObserverCreate(kCFAllocatorDefault, CFRunLoopActivity.allActivities.rawValue, true, 0, runLoopCallBack(), &amp;ctx)å°† observer æ·»åŠ åˆ° runloop çš„ commonModes ä¸­1CFRunLoopAddObserver(CFRunLoopGetCurrent(), self.runLoopObserver, CFRunLoopMode.commonModes)åˆ›å»ºå­çº¿ç¨‹ï¼Œç›‘å¬runloopçš„çŠ¶æ€beforeSources: è¿›å…¥ç¡çœ å‰afterWaiting: å”¤é†’åçš„çŠ¶æ€è®¾ç½®å¡é¡¿é˜€å€¼æ‰“å°å †æ ˆä¿¡æ¯ä¸ºä»€ä¹ˆè¦ç›‘å¬ beforeSources å’Œ afterWaiting è¿™ä¸¤ä¸ªçŠ¶æ€å‘¢ï¼Ÿå› ä¸ºåªæœ‰è¿™ä¸¤ä¸ªçŠ¶æ€ runloop è§¦å‘äº‹ä»¶å›è°ƒï¼Œå¦‚æœrunloop é•¿æ—¶é—´å¤„äºè¿™ä¸¤ä¸ªçŠ¶æ€ä¸­è¯´æ˜å¡é¡¿ï¼1234567891011121314151617DispatchQueue.global().async &#123; while true &#123; guard let sem = self.dispatchSemaphore?.wait(timeout: DispatchTime.now() + 1 / 50) else &#123; return &#125; if case DispatchTimeoutResult.timedOut = sem &#123; guard let _ = self.runLoopObserver else &#123; self.dispatchSemaphore = nil self.runLoopActivity = nil return &#125; if (self.runLoopActivity == CFRunLoopActivity.beforeSources || self.runLoopActivity == CFRunLoopActivity.afterWaiting) &#123; print(\"symbo: \\(Thread.callStackSymbols)\") print(\"æ‰“å°å¡é¡¿å †æ ˆ...\") &#125; &#125; &#125;&#125; å¦‚ä½•è·å–å¡é¡¿çš„æ–¹æ³•å †æ ˆä¿¡æ¯ï¼Ÿ ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°è·å–12345678910111213141516171819202122232425262728293031323334353637static int s_fatal_signals[] = &#123; SIGABRT, SIGBUS, SIGFPE, SIGILL, SIGSEGV, SIGTRAP, SIGTERM, SIGKILL,&#125;;static int s_fatal_signal_num = sizeof(s_fatal_signals) / sizeof(s_fatal_signals[0]);void UncaughtExceptionHandler(NSException *exception) &#123; NSArray *exceptionArray = [exception callStackSymbols]; // å¾—åˆ°å½“å‰è°ƒç”¨æ ˆä¿¡æ¯ NSString *exceptionReason = [exception reason]; // éå¸¸é‡è¦ï¼Œå°±æ˜¯å´©æºƒçš„åŸå›  NSString *exceptionName = [exception name]; // å¼‚å¸¸ç±»å‹&#125; void SignalHandler(int code) &#123; NSLog(@\"signal handler = %d\",code);&#125; void InitCrashReport() &#123; // ç³»ç»Ÿé”™è¯¯ä¿¡å·æ•è· for (int i = 0; i &lt; s_fatal_signal_num; ++i) &#123; signal(s_fatal_signals[i], SignalHandler); &#125; //oc æœªæ•è·å¼‚å¸¸çš„æ•è· NSSetUncaughtExceptionHandler(&amp;UncaughtExceptionHandler);&#125;int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; InitCrashReport(); return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); ç¬¬ä¸‰æ–¹åº“æ¥è·å–å †æ ˆä¿¡æ¯PLCrashReporter åˆ©ç”¨RunLoopç©ºé—²æ—¶é—´å¡é¡¿æ˜¯å› ä¸º runloop ä¸€æ¬¡æ—¶é—´ &gt; 1/60sé‚£ä¹ˆå¦‚æœ runloop ä¸€æ¬¡è¿è¡Œæ—¶é—´ &lt; 1/60s å‘¢ï¼Ÿè­¬å¦‚ä½ æŠŠæ‰‹æœºæ”¾åœ¨é‚£çœ‹ç€ appï¼Œrunloop åœ¨é‚£ç¡è§‰(kCFRunLoopBeforeWaiting)è¿™ä¸ªæ—¶å€™å¾€ runloop é‡Œé¢æ”¾ä¸ª source or timerï¼Œrunloop å°±ä¼šé†’æ¥ è¿›å…¥ kCFRunLoopAfterWaiting çŠ¶æ€12345678910111213141516171819typealias BeforeWaitingDo = () -&gt; ()var tasks: [BeforeWaitingDo] = []@objc func exec() &#123; let t = self.tasks.remove(at: 0) t()&#125;func registerObserver() &#123; let rl = CFRunLoopGetCurrent() let observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, CFRunLoopActivity.beforeWaiting.rawValue, true, 0) &#123;[weak self] (observer, actives) in guard let self = self, let _ = self.tasks.first else &#123;return&#125; // åˆ›å»ºä¸€ä¸ª source0 æŠŠ runloop è¢«å«é†’ self.perform(#selector(ChatEmojiViewController.exec), on: Thread.current, with: nil, waitUntilDone: false) &#125; CFRunLoopAddObserver(rl, observer, CFRunLoopMode.commonModes)&#125;ã€ŠiOSå¼€å‘é«˜æ‰‹è¯¾ã€‹iOS æ€§èƒ½ç›‘æ§ï¼ˆäºŒï¼‰â€”â€” ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—çš„é‚£äº›äº‹","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"runloop","slug":"iOS-Programming/runloop","permalink":"https://changzw.github.io/categories/iOS-Programming/runloop/"}]},{"title":"è°ƒè¯•å†…å­˜ä¸è¶³é—®é¢˜ï¼šä½¿ç”¨è¿è¡Œæ—¶é­”æ³•æ•è·å¸ƒå±€åé¦ˆå¾ªç¯","date":"2019-11-30T23:25:43.000Z","path":"2019/12/01/performance/è°ƒè¯•å†…å­˜ä¸è¶³é—®é¢˜ï¼šä½¿ç”¨è¿è¡Œæ—¶é­”æ³•æ•è·å¸ƒå±€åé¦ˆå¾ªç¯/","text":"ç›®æ ‡ï¼šä½¿ç”¨ä»£ç æ›¿ä»£ UIViewLayoutFeedbackLoopDebuggingThreshold ç¬¦å·è°ƒè¯•ï¼Œæ¥æ•è· Autolayoutåé¦ˆå¾ªç¯æ‰€å¯¼è‡´çš„å†…å­˜ä¸è¶³é—®é¢˜ã€‚ å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› å¦‚æœ Appï¼Œå¼€å§‹æœ‰å¤§é‡æ—¥æ´»ç”¨æˆ·å¹¶ä¸”å´©æºƒç‡å¾ˆä½ï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´ï¼Œæ€»ä¼šå‡ºç°å´©æºƒé—®é¢˜ï¼Œæ£€æŸ¥ Fabric ä¹Ÿæ²¡å•¥ç”¨ã€‚å‡ºç°è¿™ç§æƒ…å†µå¾ˆå¯èƒ½æ˜¯å› ä¸ºï¼Œå†…å­˜ä¸è¶³ï¼Œå¯¼è‡´åº”ç”¨è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› ï¼šå¾ªç¯å¼•ç”¨;ç«äº‰æ¡ä»¶;åºŸå¼ƒçš„çº¿ç¨‹;æ­»é”;å¸ƒå±€åé¦ˆå¾ªç¯ã€‚Apple æä¾›äº†å¾ˆå¤šæ–¹æ³•æ¥è§£å†³è¿™ç±»é—®é¢˜ï¼šInstruments é‡Œçš„ Allocations å’Œ Leaks å·¥å…·ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨å’Œ å…¶ä»–ç±»å‹çš„æ³„æ¼åœ¨ Xcode 8 ä¸­å¼•å…¥çš„ Memory Debugger ä»£æ›¿äº† Allocations å’Œ Leaks çš„ä¸€éƒ¨åˆ†åŠŸèƒ½Thread Sanitizer å¸®åŠ©ä½ æ‰¾åˆ°ç«äº‰æ¡ä»¶ã€åºŸå¼ƒçš„çº¿ç¨‹æˆ–è€…æ­»é” å¸ƒå±€åé¦ˆå¾ªç¯å½“è§†å›¾æ­£åœ¨è¿è¡Œå®ƒä»¬çš„å¸ƒå±€ä»£ç ï¼Œä½†æŸç§æ–¹æ³•å¯¼è‡´å®ƒä»¬å†ä¸€æ¬¡å¼€å§‹å¸ƒå±€ä¼ é€’ï¼Œæ­¤æ—¶å¸ƒå±€åé¦ˆå¾ªç¯å°±ä¼šå‡ºç°ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºæŸä¸ªè§†å›¾æ­£åœ¨æ”¹å˜æŸä¸ªçˆ¶è§†å›¾çš„å¤§å°ï¼Œæˆ–è€…å› ä¸ºä½ æœ‰ä¸€ä¸ªæ¨¡æ£±ä¸¤å¯çš„å¸ƒå±€ã€‚æ— è®ºå“ªç§åŸå› ï¼Œè¿™ä¸ªé—®é¢˜çš„è¡¨ç°æ˜¯ä½ çš„ CPU ä½¿ç”¨è¢«å æ»¡å’Œ RAM ä½¿ç”¨é‡ç¨³æ­¥ä¸Šå‡ï¼Œå› ä¸ºä½ çš„è§†å›¾æ­£åœ¨ä¸€æ¬¡åˆä¸€æ¬¡åœ°è¿è¡Œå®ƒä»¬çš„å¸ƒå±€ä»£ç ï¼Œå´æ²¡æœ‰è¿”å›ã€‚-æ¥è‡ªHackingWithSwift çš„ Paul Hudsonåœ¨ WWDC 16 ä¸­ Apple ä»‹ç»äº†â€œå¸ƒå±€åé¦ˆå¾ªç¯è°ƒè¯•å™¨â€ã€‚è¿™ä¸ªè°ƒè¯•å™¨æœ‰åŠ©äºè¯†åˆ«åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¾ªç¯çš„æ—¶é—´ç‚¹ã€‚è¿™å°±æ˜¯ä¸€ä¸ªç¬¦å·æ–­ç‚¹ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼éå¸¸ç®€å•ï¼šå®ƒä¼šè®¡ç®—åœ¨å•ä¸ª run loop è¿­ä»£ä¸­è°ƒç”¨æ¯ä¸ªè§†å›¾ä¸Šçš„ layoutSubviews() æ–¹æ³•çš„æ¬¡æ•°ã€‚ä¸€æ—¦è¿™ä¸ªè®¡æ•°å€¼è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼ï¼ˆæ¯”å¦‚ï¼Œ100ï¼‰ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°†ä¼šåœåœ¨è¿™ä¸ªæ–­ç‚¹å¹¶æ‰“å°å‡ºæ—¥å¿—ã€‚è¿™ç¯‡æ–‡ç«  å¿«é€Ÿåœ°ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™ä¸ªè°ƒè¯•å™¨ã€‚è¿™ä¸ªæ–¹æ³•åœ¨å¯ä»¥é‡ç°é—®é¢˜çš„æƒ…å†µä¸‹ååˆ†æœ‰æ•ˆã€‚ä½†æ˜¯åœ¨çº¿ä¸Šå‡ºç°å°±ä¸ç”¨å®¹æ˜“è°ƒè¯•ã€‚ä½†æ˜¯ä½ å¯ä»¥å°è¯•æŠŠ UIViewLayoutFeedbackLoopDebuggingThreshold çš„ä»£ç å¤åˆ¶åˆ°ç”Ÿäº§ä»£ç ä¸­ã€‚ å¦‚ä½•ç”¨ä»£ç å®ç° UIViewLayoutFeedbackLoopDebuggingThreshold çš„åŠŸèƒ½å‘¢ç¬¦å·æ–­ç‚¹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šå®ƒä¼šè®¡ç®— layoutSubviews() çš„è°ƒç”¨æ¬¡æ•°å¹¶åœ¨å•ä¸ª run loop è¿­ä»£ä¸­è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼æ—¶å‘é€ä¸€ä¸ªäº‹ä»¶ã€‚å¬èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿ12345678910class TrackableView: UIView &#123; var counter: Int = 0 override func layoutSubviews() &#123; super.layoutSubviews() counter += 1; if (counter == 100) &#123; YourAnalyticsFramework.event(name: \"loop\") &#125; &#125;&#125;å¯¹äºä¸€ä¸ªè§†å›¾ï¼Œè¿™æ®µä»£ç è¿è¡Œæ­£å¸¸ã€‚ä½†æ˜¯ç°åœ¨ä½ æƒ³è¦åœ¨å¦ä¸€ä¸ªè§†å›¾ä¸Šå®ç°å®ƒã€‚å½“ç„¶ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª UIView çš„å­ç±»ï¼Œåœ¨è¿™é‡Œå®ç°å®ƒå¹¶ä½¿ä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰è§†å›¾éƒ½ç»§æ‰¿è¿™ä¸ªå­ç±»ã€‚ç„¶åä¸º UITableViewï¼ŒUIScrollViewï¼ŒUIStackView ç­‰åšåŒæ ·çš„äº‹æƒ…ã€‚å¦‚æœå°†æ­¤é€»è¾‘æ³¨å…¥ä½ æƒ³è¦çš„ä»»ä½•ç±»ï¼Œè€Œæ— éœ€ç¼–å†™å¤§é‡é‡å¤çš„ä»£ç ã€‚è¿™æ—¶å€™å°±å¯ä»¥ å€ŸåŠ©è¿è¡Œæ—¶ç¼–ç¨‹ äº†ã€‚ ä½¿ç”¨ runtime å®ç°å­ç±»æˆ‘ä»¬ä¼šåšåŒæ ·çš„äº‹æƒ…â€”â€”åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œé‡å†™ layoutSubviews() æ–¹æ³•å¹¶è®¡ç®—å…¶è°ƒç”¨æ¬¡æ•°ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨ runtime å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨é¡¹ç›®ä¸­åˆ›å»ºé‡å¤çš„ç±»ã€‚åˆ›å»ºè‡ªå®šä¹‰å­ç±»ï¼Œå¹¶å°†åŸå§‹è§†å›¾çš„ç±»æ›´æ”¹ä¸ºæ–°çš„å­ç±»ï¼š123456789101112131415161718192021struct LayoutLoopHunter &#123; struct RuntimeConstants &#123; static let Prefix = â€œruntimeâ€ &#125; static func setUp(for view: UIView, threshold: Int = 100, onLoop: @escaping () -&gt; ()) &#123; // æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§°ã€‚ let classFullName = â€œ\\(RuntimeConstants.Prefix)_\\(String(describing: view.self))â€ let originalClass = type(of: view) if let trackableClass = objc_allocateClassPair(originalClass, classFullName, 0) &#123; // åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±»ã€‚ // æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶ä¸”ç”¨åŸå§‹è§†å›¾çš„ç±»æ¥å’Œå®ƒäº¤æ¢ã€‚ objc_registerClassPair(trackableClass) object_setClass(view, trackableClass) &#125; else if let trackableClass = NSClassFromString(classFullName) &#123; // æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»ã€‚ // æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢ã€‚ object_setClass(view, trackableClass) &#125; &#125;&#125;objc_allocateClassPair() æ–¹æ³•çš„æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæ–¹æ³•ä½•æ—¶å¤±è´¥ï¼šæ–°ç±»ï¼Œæˆ–è€…å¦‚æœæ— æ³•åˆ›å»ºç±»ï¼Œåˆ™ä¸º Nil ï¼ˆä¾‹å¦‚ï¼Œæ‰€éœ€åç§°å·²è¢«ä½¿ç”¨ï¼‰ã€‚è¿™å°±æ„å‘³ç€ä¸èƒ½æ‹¥æœ‰ä¸¤ä¸ªåŒåçš„ç±»ã€‚æˆ‘ä»¬çš„ç­–ç•¥æ˜¯ä¸ºå•ä¸ªè§†å›¾ç±»åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶ç±»ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨åŸå§‹ç±»åå‰åŠ ä¸Šå‰ç¼€æ¥å½¢æˆæ–°ç±»çš„åç§°çš„åŸå› ã€‚ç°åœ¨æ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨åˆ°å­ç±»ä¸­ã€‚ç†è®ºä¸Šï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚æ·»åŠ ä¸€ä¸ªä¿å­˜è®¡æ•°å™¨çš„å±æ€§ã€‚ä¸ºè¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªå…³è”å¯¹è±¡ï¼ˆAssociated objectï¼‰ã€‚ä½†æ˜¯ç›®å‰ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•å¥æ•ˆã€‚ä½ å¯ä»¥æƒ³è±¡å±æ€§æ˜¯å­˜å‚¨åœ¨åˆ†é…ç»™ç±»çš„å†…å­˜é‡Œçš„ä¸œè¥¿ï¼Œç„¶è€Œå…³è”å¯¹è±¡åˆ™å‚¨å­˜åœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„åœ°æ–¹ã€‚å› ä¸ºåˆ†é…ç»™å·²å­˜åœ¨å¯¹è±¡çš„å†…å­˜æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è‡ªå®šä¹‰ç±»ä¸Šæ–°æ·»åŠ çš„å±æ€§å°†ä¼šä»å…¶ä»–èµ„æºé‡Œâ€œçªƒå–â€å†…å­˜ã€‚å®ƒå¯èƒ½å¯¼è‡´æ„æ–™ä¹‹å¤–çš„è¡Œä¸ºå’Œéš¾ä»¥è°ƒè¯•çš„ç¨‹åºå´©æºƒï¼ˆç‚¹å‡» è¿™é‡Œ æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼‰ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨å…³è”å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬å°†ä¼šå­˜å‚¨åœ¨è¿è¡Œæ—¶åˆ›å»ºçš„ä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œï¼Œè¿™æ˜¯å®Œå…¨å®‰å…¨çš„ã€‚123static var CounterKey = \"_counter\"...objc_setAssociatedObject(trackableClass, &amp;RuntimeConstants.CounterKey, 0, .OBJC_ASSOCIATION_RETAIN_NONATOMIC)å½“æ–°çš„å­ç±»è¢«åˆ›å»ºæ—¶ï¼Œè®¡æ•°å™¨åˆå€¼è®¾ç½®ä¸º 0ã€‚å®ç°è¿™ä¸ªæ–°çš„layoutSubviews() æ–¹æ³•ï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ç±»ä¸­ï¼š1234567891011let layoutSubviews: @convention(block) (Any?) -&gt; () = &#123; nullableSelf in guard let _self = nullableSelf else &#123; return &#125; if let counter = objc_getAssociatedObject(_self, &amp;RuntimeConstants.CounterKey) as? Int &#123; if counter == threshold &#123; onLoop() &#125; objc_setAssociatedObject(trackableClass, &amp;RuntimeConstants.CounterKey, counter+1, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) &#125;&#125;let implementation = imp_implementationWithBlock(layoutSubviews)class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, \"v@:\")ä¸ºäº†ç†è§£ä¸Šé¢è¿™æ®µä»£ç å®é™…ä¸Šåœ¨å¹²ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥è‡ª &lt;objc/runtime.h&gt; çš„ç»“æ„ä½“ï¼š12345struct objc_method &#123; SEL method_name; char *method_types; IMP method_imp;&#125;æ–¹æ³•å®é™…ä¸Šæ˜¯ç”±ä»€ä¹ˆç»„æˆçš„ï¼šæ–¹æ³•çš„å®ç° method_impï¼Œè¿™æ˜¯è°ƒç”¨æ–¹æ³•æ—¶è¦æ‰§è¡Œçš„å®é™…å‡½æ•°ã€‚å®ƒçš„å‰ä¸¤ä¸ªå½¢å‚æ€»æ˜¯æ–¹æ³•æ¥æ”¶è€…å’Œæ¶ˆæ¯é€‰æ‹©å™¨ã€‚åŒ…å«æ–¹æ³•ç­¾åçš„æ–¹æ³•ç±»å‹å­—ç¬¦ä¸² method_typesã€‚ä½ å¯ä»¥åœ¨ è¿™é‡Œ è¯¦ç»†äº†è§£å…¶æ ¼å¼ã€‚ä½†æ˜¯åœ¨ç°åœ¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ˜ç¡®è¯´æ˜çš„å­—ç¬¦ä¸²æ˜¯ â€œv@:â€ã€‚ä½œä¸ºè¿”å›ç±»å‹ï¼Œv ä»£è¡¨ voidï¼Œè€Œ @ å’Œ : åˆ†åˆ«ä»£è¡¨æ¥æ”¶è€…å’Œæ¶ˆæ¯é€‰æ‹©å™¨ã€‚é€‰æ‹©å™¨ method_name ä½œä¸ºé”®ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥æ‰¾æ–¹æ³•çš„å®ç°ã€‚ä½ å¯ä»¥æŠŠ Witness Tableï¼ˆåœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®ƒä¹Ÿè¢«ç§°ä½œæ–¹æ³•æ´¾å‘è¡¨ï¼‰æƒ³è±¡æˆä¸€ä¸ªç®€å•çš„å­—å…¸æ•°æ®ç»“æ„ã€‚é‚£ä¹ˆé€‰æ‹©å™¨ä¸ºé”®ï¼Œä¸”å®ç°éƒ¨åˆ†åˆ™ä¸ºå¯¹åº”çš„å€¼ã€‚åœ¨ä¸‹é¢è¿™è¡Œä»£ç ä¸­:1class_addMethod(trackableClass,#selector(originalClass.layoutSubviews), implementation, \"v@:\")æˆ‘ä»¬æ‰€åšçš„æ˜¯ç»™ layoutSubviews() æ–¹æ³•å¯¹åº”çš„é”®åˆ†é…æ–°å€¼ã€‚è¿™ä¸ªæ–¹æ³•ç›´æˆªäº†å½“ã€‚æˆ‘ä»¬è·å¾—è¿™ä¸ªè®¡æ•°å™¨ï¼Œä½¿å®ƒçš„è®¡æ•°å€¼åŠ ä¸€ã€‚å¦‚æœè®¡æ•°å€¼è¶…è¿‡ä¸´ç•Œå€¼ï¼Œæˆ‘ä»¬ä¼šå‘é€åˆ†æäº‹ä»¶ï¼Œå…¶ä¸­åŒ…å«ç±»åå’Œæƒ³è¦çš„ä»»ä½•æ•°æ®ä½“ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å¦‚ä½•å¯¹å…³è”å¯¹è±¡å®ç°å’Œä½¿ç”¨é”®ï¼š1234static var CounterKey = â€œ_counterâ€... objc_setAssociatedObject(trackableClass, &amp;RuntimeConstants.CounterKey, counter+1, .OBJC_ASSOCIATION_RETAIN_NONATOMIC)ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ var æ¥ä¿®é¥°è®¡æ•°å™¨çš„é”®è¿™ä¸ªé™æ€å±æ€§å¹¶åœ¨ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹æ—¶ä½¿ç”¨å¼•ç”¨ï¼Ÿç­”æ¡ˆéšè—åœ¨ Swift è¯­è¨€åŸºç¡€â€”â€”å­—ç¬¦ä¸²ä¹‹ä¸­ã€‚å­—ç¬¦ä¸²åƒå…¶ä»–æ‰€æœ‰çš„å€¼ç±»å‹ä¸€æ ·ï¼Œæ˜¯æŒ‰å€¼ä¼ é€’çš„ã€‚é‚£ä¹ˆï¼Œå½“ä½ æŠŠå®ƒä¼ å…¥è¿™ä¸ªé—­åŒ…æ—¶ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°†ä¼šè¢«å¤åˆ¶åˆ°ä¸€ä¸ªä¸åŒçš„åœ°å€ï¼Œè¿™ä¼šå¯¼è‡´åœ¨å…³è”å¯¹è±¡è¡¨ä¸­äº§ç”Ÿä¸€ä¸ªå®Œå…¨ä¸åŒçš„é”®ã€‚&amp; ç¬¦å·æ€»æ˜¯ä¿è¯å°†ç›¸åŒçš„åœ°å€ä½œä¸ºé”®å‚æ•°çš„å€¼ã€‚ä½ å¯ä»¥å°è¯•ä»¥ä¸‹ä»£ç ï¼š1234567891011121314func printAddress(_ string: UnsafeRawPointer) &#123; print(\"\\(string)\")&#125;let str = \"test\"printAddress(str)printAddress(str)let closure = &#123; printAddress(str) printAddress(str)&#125;closure()// æœ€åä¸¤ä¸ªå‡½æ•°è°ƒç”¨çš„åœ°å€å°†å§‹ç»ˆä¸åŒç”¨å¼•ç”¨çš„æ–¹å¼æ¥ä¼ é€’é”®çš„ä¸»æ„æ€»æ˜¯å¥½çš„ï¼Œå› ä¸ºæœ‰æ—¶ï¼Œå³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨é—­åŒ…ï¼Œå˜é‡çš„åœ°å€ä»å¯èƒ½å› å†…å­˜ç®¡ç†è€Œæ›´æ”¹ã€‚åœ¨æˆ‘ä»¬ä¾‹å­ä¸­ï¼Œå¦‚æœä½ æŠŠä¸Šé¢çš„ä»£ç è¿è¡Œå¤šæ¬¡ï¼Œå³ä½¿æ˜¯å‰ä¸¤ä¸ª printAddress() çš„è°ƒç”¨ä¹Ÿå¯èƒ½ä¼šè¾“å‡ºä¸åŒçš„åœ°å€ã€‚è®©æˆ‘ä»¬å›åˆ°è¿è¡Œæ—¶çš„é­”æ³•é‡Œæ¥ã€‚åœ¨æ–° layoutSubviews() çš„å®ç°é‡Œï¼Œè¿˜æœ‰ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…æ²¡æœ‰å®Œæˆã€‚è¿™ä»¶äº‹æ˜¯æ¯æ¬¡é‡å†™çˆ¶ç±»çš„æ–¹æ³•æ—¶é€šå¸¸éƒ½ä¼šåšçš„äº‹æƒ…â€”â€”è°ƒç”¨çˆ¶ç±»å®ç°ã€‚layoutSubviews() çš„æ–‡æ¡£é‡Œæåˆ°ï¼šåœ¨ iOS 5.1 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚è€Œä¹‹åçš„é»˜è®¤å®ç°ä¼šä½¿ç”¨ä½ è®¾ç½®çš„ä»»ä½•çº¦æŸæ¥ç¡®å®šä»»ä½•å­è§†å›¾çš„å¤§å°å’Œä½ç½®ã€‚ä¸ºäº†é¿å…å‘ç”Ÿä¸€äº›éš¾ä»¥é¢„æ–™çš„å¸ƒå±€è¡Œä¸ºï¼Œæˆ‘ä»¬å¾—è°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œä½†è¿™ä¸åƒå¹³å¸¸é‚£æ ·ç®€å•æ˜äº†ï¼š12345678910let selector = #selector(originalClass.layoutSubviews)let originalImpl = class_getMethodImplementation(originalClass, selector) // @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰// æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•°// æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦typealias ObjCVoidVoidFn = @convention(c) (Any, Selector) -&gt; Voidlet originalLayoutSubviews = unsafeBitCast(originalImpl, to: ObjCVoidVoidFn.self)originalLayoutSubviews(view, selector)è¿™é‡Œå®é™…å‘ç”Ÿçš„æ˜¯ï¼šæˆ‘ä»¬æ£€ç´¢æ–¹æ³•æ‰€éœ€çš„å®ç°éƒ¨åˆ†ï¼Œå¹¶ç›´æ¥ä»ä»£ç ä¸­è°ƒç”¨å®ƒï¼Œè€Œä¸æ˜¯ç”¨å¸¸è§çš„æ–¹å¼æ¥è°ƒç”¨æ–¹æ³•ï¼ˆå³æ‰§è¡Œä¸€ä¸ªä¼šåœ¨ Witness Table ä¸­å¯»æ‰¾å¯¹åº”å®ç°çš„é€‰æ‹©å™¨ï¼‰ã€‚ç›®å‰ä¸ºæ­¢ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ç°éƒ¨åˆ†ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344static func setUp(for view: UIView, threshold: Int = 100, onLoop: @escaping () -&gt; ()) &#123; // æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§° let classFullName = â€œ\\(RuntimeConstants.Prefix)_\\(String(describing: view.self))â€ let originalClass = type(of: view) if let trackableClass = objc_allocateClassPair(originalClass, classFullName, 0) &#123; // åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±» // æ³¨å†Œè¿™ä¸ªç±»å¹¶å°†å…¶ä¸åŸå§‹è§†å›¾çš„ç±»äº¤æ¢ objc_registerClassPair(trackableClass) object_setClass(view, trackableClass) // ç°åœ¨å¯ä»¥åˆ›å»ºå…³è”å¯¹è±¡ objc_setAssociatedObject(view, &amp;RuntimeConstants.CounterKey, 0, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) // æ·»åŠ æˆ‘ä»¬è‡ªå·± layoutSubviews çš„å®ç° let layoutSubviews: @convention(block) (Any?) -&gt; () = &#123; nullableSelf in guard let _self = nullableSelf else &#123; return &#125; let selector = #selector(originalClass.layoutSubviews) let originalImpl = class_getMethodImplementation(originalClass, selector) // @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰ // æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•° // æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦ typealias ObjCVoidVoidFn = @convention(c) (Any, Selector) -&gt; Void let originalLayoutSubviews = unsafeBitCast(originalImpl, to: ObjCVoidVoidFn.self) originalLayoutSubviews(view, selector) if let counter = objc_getAssociatedObject(_self, &amp;RuntimeConstants.CounterKey) as? Int &#123; if counter == threshold &#123; onLoop() &#125; objc_setAssociatedObject(view, &amp;RuntimeConstants.CounterKey, counter+1, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) &#125; &#125; let implementation = imp_implementationWithBlock(layoutSubviews) class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, â€œv@:â€œ) &#125; else if let trackableClass = NSClassFromString(classFullName) &#123; // æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±» // æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢ object_setClass(view, trackableClass) &#125;&#125;è®©æˆ‘ä»¬ä¸ºè§†å›¾åˆ›å»ºæ¨¡æ‹Ÿå¸ƒå±€å¾ªç¯ï¼Œå¹¶ä¸ºå…¶è®¾ç½®è®¡æ•°å™¨æ¥è¿›è¡Œæµ‹è¯•ï¼š1234567891011121314class ViewController: UIViewController &#123; override func viewDidLoad() &#123; super.viewDidLoad() LayoutLoopHunter.setUp(for: view) &#123; print(\"Hello, world\") &#125; &#125; override func viewDidLayoutSubviews() &#123; super.viewDidLayoutSubviews() view.setNeedsLayout() // loop creation &#125;&#125;æ˜¯ä¸æ˜¯å¿˜è®°äº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿè®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹ UIViewLayoutFeedbackLoopDebuggingThreshold æ–­ç‚¹çš„å·¥ä½œåŸç†ï¼šåœ¨ç¡®è®¤ä¸ºåé¦ˆå¾ªç¯ä¹‹å‰ï¼Œå®šä¹‰æŸä¸ªè§†å›¾çš„å­è§†å›¾åœ¨å•ä¸ª run loop é‡Œå¿…é¡»å¸ƒå±€çš„æ¬¡æ•°æˆ‘ä»¬ä»æœªæŠŠâ€œå•ä¸ª run loop â€è¿™ä¸€æ¡ä»¶è€ƒè™‘è¿›æ¥ã€‚å¦‚æœè§†å›¾åœ¨å±å¹•ä¸Šåœç•™äº†ç›¸å½“é•¿çš„æ—¶é—´ï¼Œå¹¶ç»å¸¸è¢«åå¤å¸ƒå±€ï¼Œè®¡æ•°å™¨è¿Ÿæ—©ä¼šè¶…è¿‡ä¸´ç•Œå€¼ã€‚ä½†è¿™å¯ä¸æ˜¯å› ä¸ºå†…å­˜çš„é—®é¢˜ã€‚æˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåªéœ€åœ¨æ¯æ¬¡ run loop è¿­ä»£æ—¶é‡ç½®è®¡æ•°å™¨ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª DispatchWorkItemï¼Œå®ƒé‡ç½®è®¡æ•°å™¨ï¼Œå¹¶åœ¨ä¸»é˜Ÿåˆ—ä¸Šå¼‚æ­¥ä¼ é€’å®ƒã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ƒä¼šåœ¨ run loop ä¸‹ä¸€æ¬¡è¿›å…¥ä¸»çº¿ç¨‹æ—¶è¢«è°ƒç”¨ï¼š12345678910111213static var ResetWorkItemKey = â€œ_resetWorkItemâ€...if let previousResetWorkItem = objc_getAssociatedObject(view, &amp;RuntimeConstants.ResetWorkItemKey) as? DispatchWorkItem &#123; previousResetWorkItem.cancel()&#125;let currentResetWorkItem = DispatchWorkItem &#123; [weak view] in guard let strongView = view else &#123; return &#125; objc_setAssociatedObject(strongView, &amp;RuntimeConstants.CounterKey, 0, .OBJC_ASSOCIATION_RETAIN_NONATOMIC)&#125;DispatchQueue.main.async(execute: currentResetWorkItem)objc_setAssociatedObject(view, &amp;RuntimeConstants.ResetWorkItemKey, currentResetWorkItem, .OBJC_ASSOCIATION_RETAIN_NONATOMIC)æœ€ç»ˆçš„ä»£ç ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667struct LayoutLoopHunter &#123; struct RuntimeConstants &#123; static let Prefix = â€œruntimeâ€ // Associated objects keys // å…³è”å¯¹è±¡é”® static var CounterKey = â€œ_counterâ€ static var ResetWorkItemKey = â€œ_resetWorkItemâ€ &#125; static func setUp(for view: UIView, threshold: Int = 100, onLoop: @escaping () -&gt; ()) &#123; // æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§°ã€‚ let classFullName = â€œ\\(RuntimeConstants.Prefix)_\\(String(describing: view.self))â€ let originalClass = type(of: view) if let trackableClass = objc_allocateClassPair(originalClass, classFullName, 0) &#123; // åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±»ã€‚ // æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶ä¸”ç”¨åŸå§‹è§†å›¾çš„ç±»æ¥å’Œå®ƒäº¤æ¢ã€‚ objc_registerClassPair(trackableClass) object_setClass(view, trackableClass) // ç°åœ¨å¯ä»¥åˆ›å»ºå…³è”å¯¹è±¡ objc_setAssociatedObject(view, &amp;RuntimeConstants.CounterKey, 0, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) // æ·»åŠ æˆ‘ä»¬è‡ªå·± layoutSubviews çš„å®ç° let layoutSubviews: @convention(block) (Any?) -&gt; () = &#123; nullableSelf in guard let _self = nullableSelf else &#123; return &#125; let selector = #selector(originalClass.layoutSubviews) let originalImpl = class_getMethodImplementation(originalClass, selector) // @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰ // æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•° // æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦ typealias ObjCVoidVoidFn = @convention(c) (Any, Selector) -&gt; Void let originalLayoutSubviews = unsafeBitCast(originalImpl, to: ObjCVoidVoidFn.self) originalLayoutSubviews(view, selector) if let counter = objc_getAssociatedObject(_self, &amp;RuntimeConstants.CounterKey) as? Int &#123; if counter == threshold &#123; onLoop() &#125; objc_setAssociatedObject(view, &amp;RuntimeConstants.CounterKey, counter+1, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) &#125; // ä¸ºé‡ç½®è®¡æ•°å™¨ï¼Œåœ¨æ¯ä¸ªæ–°çš„ run loop éå†ä¸­åˆ†å‘ work item if let previousResetWorkItem = objc_getAssociatedObject(view, &amp;RuntimeConstants.ResetWorkItemKey) as? DispatchWorkItem &#123; previousResetWorkItem.cancel() &#125; let counterResetWorkItem = DispatchWorkItem &#123; [weak view] in guard let strongView = view else &#123; return &#125; objc_setAssociatedObject(strongView, &amp;RuntimeConstants.CounterKey, 0, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) &#125; DispatchQueue.main.async(execute: counterResetWorkItem) objc_setAssociatedObject(view, &amp;RuntimeConstants.ResetWorkItemKey, counterResetWorkItem, .OBJC_ASSOCIATION_RETAIN_NONATOMIC) &#125; let implementation = imp_implementationWithBlock(layoutSubviews) class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, â€œv@:â€œ) &#125; else if let trackableClass = NSClassFromString(classFullName) &#123; // æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»ã€‚ // æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢ã€‚ object_setClass(view, trackableClass) &#125; &#125;&#125; ç»“è®ºæ˜¯çš„ï¼ç°åœ¨ä½ å¯ä»¥ä¸ºæ‰€æœ‰å¯ç–‘çš„è§†å›¾è®¾ç½®åˆ†æäº‹ä»¶äº†ï¼Œå‘å¸ƒåº”ç”¨ç¨‹åºï¼Œå¹¶æ‰¾åˆ°è¿™ä¸ªé—®é¢˜çš„ç¡®åˆ‡å‡ºå¤„ã€‚ä½ å¯ä»¥æŠŠè¿™ä¸ªé—®é¢˜çš„èŒƒå›´ç¼©å°åˆ°æŸä¸ªç‰¹å®šçš„è§†å›¾ï¼Œå¹¶åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å€ŸåŠ©äºä»–ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æœ€åè¦æåˆ°çš„ä¸€ä»¶äº‹æ˜¯ï¼šèƒ½åŠ›è¶Šå¤§è´£ä»»è¶Šå¤§ã€‚è¿è¡Œæ—¶ç¼–ç¨‹éå¸¸å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤å¾ˆå®¹æ˜“åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä¸ºåº”ç”¨ç¨‹åºå¼•å…¥å¦ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ€»æ˜¯å»ºè®®å°†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å±é™©ä»£ç åŒ…è£…åœ¨æŸç§å¯åœæ­¢å¼€å…³ä¸­ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨å‘ç°ä»£ç å¯¼è‡´é—®é¢˜æ—¶ä»åç«¯è§¦å‘å¼€å…³ç¦ç”¨è¯¥åŠŸèƒ½ã€‚è¿™æœ‰ä¸€ç¯‡ä»‹ç» Firebase çš„ Feature Flags çš„ (å¥½æ–‡ç« å®Œæ•´ä»£ç å¯ä»¥ä»è¿™ä¸ª GitHub ä»“åº“ é‡Œè·å–ï¼Œå¹¶ä¸”ä¹Ÿå°†ä¼šå‘å¸ƒåˆ° CocoPods ä¸Šï¼Œä»¥è·Ÿè¸ªé¡¹ç›®ä¸­çš„å¸ƒå±€å¾ªç¯ã€‚å¤§é‡å¼•ç”¨åŸæ–‡è¯»èµ·æ¥è´¹åŠ²ï¼Œåªæ˜¯æƒ³è®©è‡ªå·±è¯»çš„å®¹æ˜“å†™çš„è¿™ç¯‡æ–‡ç« ","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æ€§èƒ½ä¼˜åŒ–","slug":"æ€§èƒ½ä¼˜åŒ–","permalink":"https://changzw.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"AlamoFire åˆ†æ","date":"2019-08-23T02:24:19.000Z","path":"2019/08/23/source-code/AlamoFire-åˆ†æ/","text":"åˆ†ææºç ï¼šè¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦åˆ†æ AlamoFireåˆ†æå®ƒçš„æ¥å£è®¾è®¡åˆ†æä»–æ˜¯å¦‚ä½•å°è£… URL Loading System çš„åˆ†æç½‘ç»œå±‚æ¬¡æ€è€ƒæ•°æ®ä¼ è¾“è¿‡ç¨‹AlamoFire éƒ½åšäº†ä»€ä¹ˆï¼ŸChainable Request / Response MethodsURL / JSON Parameter EncodingUpload File / Data / Stream / MultipartFormDataDownload File using Request or Resume DataAuthentication with URLCredentialHTTP Response ValidationUpload and Download Progress Closures with ProgresscURL Command OutputDynamically Adapt and Retry RequestsTLS Certificate and Public Key PinningNetwork Reachability Foundation ä¸­æä¾›çš„ç½‘ç»œç›¸å…³æ¥å£AlamoFire æ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚åº“ï¼Œåº•å±‚å°è£…çš„äº‹ Apple æä¾›çš„ URL Loading System åå° sessionä¸‹è½½æµç¨‹&amp;æ³¨æ„äº‹é¡¹åå° sessionConfiguration ä¸‹è½½æ–‡ä»¶ä¿å­˜ åˆ°æœ¬åœ°æ²™ç›’12345678910111213141516171819202122// å¼€å¯åå° è¯·æ±‚ tasklet configuration = URLSessionConfiguration.background(withIdentifier: \"com.czw.backgroundDownload\")let session = URLSession.init(configuration: configuration, delegate: self, delegateQueue: OperationQueue.main)session.downloadTask(with: URL(string: urlDownloadStr)!).resume()extension ViewController: URLSessionDownloadDelegate &#123;// ä¸‹è½½å®Œæˆåä»£ç†å›è°ƒæ–¹æ³•ï¼Œå°†æ–‡ä»¶ç§»åŠ¨åˆ°æ²™ç›’æŒ‡å®šä½ç½® func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didFinishDownloadingTo location: URL) &#123; print(\"ä¸‹è½½å®Œæˆ - \\(location)\") let locationPath = location.path let documnets = NSHomeDirectory() + \"/Documents/xxxx\" + \".zip\" print(\"ç§»åŠ¨åœ°å€:\\(documnets)\") let fileManager = FileManager.default try! fileManager.moveItem(atPath: locationPath, toPath: documnets) &#125; // http åˆ†æ®µä¼ è¾“ï¼Œä¼šä¸æ–­è°ƒç”¨è¿™ä¸ªæ–¹æ³•ç›´åˆ°ï¼Œå…¨éƒ¨ä¸‹è½½å®Œæˆ func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) &#123; print(\" bytesWritten \\(bytesWritten)\\n totalBytesWritten \\(totalBytesWritten)\\n totalBytesExpectedToWrite \\(totalBytesExpectedToWrite)\") print(\"ä¸‹è½½è¿›åº¦: \\(Double(totalBytesWritten)/Double(totalBytesExpectedToWrite))\\n\") &#125;&#125;åå°è¯·æ±‚ï¼Œéœ€è¦ç”³è¯·åå°æƒé™ï¼Œè¿™æ · app è¿›å…¥ background çš„æ—¶å€™æ‰å¯ä»¥ç»§ç»­ä¸‹è½½1234567//ç”¨äºä¿å­˜åå°ä¸‹è½½çš„completionHandlervar backgroundSessionCompletionHandler: (() -&gt; Void)? func application(_ application: UIApplication, handleEventsForBackgroundURLSession identifier: String, completionHandler: @escaping () -&gt; Void) &#123; print(\"background: \\(identifier)\") self.backgroundSessionCompletionHandler = completionHandler&#125; ä½¿ç”¨ AlamoFire1234Alamofire.request(urlString) .responseJSON &#123; (data) in print(data)&#125;è·Ÿä¸Šé¢å¯¹æ¯”[åŸç”Ÿçš„æ–¹æ³•(#code1), æ€è€ƒ AlamoFire éƒ½å°è£…äº†ä»€ä¹ˆï¼Œå¦‚ä½•å®ç°é“¾å¼è°ƒç”¨çš„ï¼Œå†…éƒ¨å¦‚ä½•ä½¿ç”¨ oopï¼Œpop çš„, æ€è€ƒ AlamoFire æ¥å£è®¾è®¡ä¸‹é¢è¿™äº›éƒ½æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿé“¾å¼è¯­æ³•ç›´æ¥ä¼  stringå°è£…è°ƒç”¨ sessionï¼ŒresumeResponse å›è°ƒçš„è¿”å›çš„æ˜¯ json æ•°æ®Alamofire æ¨¡å—å¯¼å…¥è°ƒç”¨è°ƒç”¨çš„ç¬¬ä¸€å±‚ï¼šAlamofire.swift1234567891011121314151617//Alamofire Modelpublic func request( _ url: URLConvertible, method: HTTPMethod = .get, parameters: Parameters? = nil, encoding: ParameterEncoding = URLEncoding.default, headers: HTTPHeaders? = nil) -&gt; DataRequest &#123; return SessionManager.default.request( url, method: method, parameters: parameters, encoding: encoding, headers: headers )&#125;SessionManager.swift123456789101112131415161718192021222324252627282930313233//SessionManager/// A default instance of `SessionManager`, used by top-level Alamofire request methods, and suitable for use/// directly for any ad hoc requests.public static let `default`: SessionManager = &#123; let configuration = URLSessionConfiguration.default configuration.httpAdditionalHeaders = SessionManager.defaultHTTPHeaders return SessionManager(configuration: configuration)&#125;()public init( configuration: URLSessionConfiguration = URLSessionConfiguration.default, delegate: SessionDelegate = SessionDelegate(), serverTrustPolicyManager: ServerTrustPolicyManager? = nil)&#123; self.delegate = delegate self.session = URLSession(configuration: configuration, delegate: delegate, delegateQueue: nil) commonInit(serverTrustPolicyManager: serverTrustPolicyManager)&#125;public init?( session: URLSession, delegate: SessionDelegate, serverTrustPolicyManager: ServerTrustPolicyManager? = nil) &#123; guard delegate === session.delegate else &#123; return nil &#125; self.delegate = delegate self.session = session commonInit(serverTrustPolicyManager: serverTrustPolicyManager)&#125;SessionDelegate() ä»£ç†ç§»äº¤ SessionDelegate æ˜¯ä¸ª class, å¤„ç† URLSession çš„äº‹ä»¶å›è°ƒä»£ç†æ–¹æ³•ã€‚123extension SessionDelegate: URLSessionDataDelegate &#123;extension SessionDelegate: URLSessionTaskDelegate &#123;extension SessionDelegate: URLSessionStreamDelegate &#123;ä¸ºä»€ä¹ˆ Manager ä¸å¤„ç† URLSession çš„ä»£ç†å›è°ƒæ–¹æ³•ï¼Œè¦æä¸€ä¸ª SessionDelegate å¤„ç†ï¼Œå› ä¸º Manager æ˜¯ä¸€ä¸ªä¸­ä»‹è€…ï¼Œç”¨äºç®¡ç†å„ä¸ª class ä¹‹é—´çš„è”ç³»ï¼Œå¤„ç†å›è°ƒçš„é‚£äº›æ–¹æ³•åº”è¯¥å½’å±äº xxxClass æ¥å¤„ç†ä½¿ç”¨ Manager ä¸»è¦ä½œç”¨æ˜¯æŠŠä»£ç æ¨¡å—ä¹‹é—´çš„ é¢‘ç¹è°ƒç”¨å…³ç³»åŒ–ç®€ã€‚åˆ’åˆ†ä¸šåŠ¡å±‚ï¼Œç®¡ç†å±‚Manager ç»Ÿä¸€ç®¡ç†è°ƒåº¦å„ä¸ªæ¨¡å—å¤„ç†å®Œæˆåï¼Œå›è°ƒç»™ Manager å¤„ç†åå°ä¸‹è½½ request ç¼–ç urljsonpropertyListurl æ˜¯ASCIIç ç¼–ç çš„ï¼Œä»–ä¸æ˜¯ Unicodeï¼ŒASCII ç ä¸­çš„å¤–æ–‡æ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥è¦ç™¾åˆ†å·ç¼–ç â€”â€”å°† ACSII -&gt; Unicode è¿™æ ·å¯ä»¥è¢«è¯†åˆ«123456789101112131415161718192021222324252627public func encode(_ urlRequest: URLRequestConvertible, with parameters: Parameters?) throws -&gt; URLRequest &#123; var urlRequest = try urlRequest.asURLRequest() guard let parameters = parameters else &#123; return urlRequest &#125;// header if let method = HTTPMethod(rawValue: urlRequest.httpMethod ?? \"GET\"), encodesParametersInURL(with: method) &#123; guard let url = urlRequest.url else &#123; throw AFError.parameterEncodingFailed(reason: .missingURL) &#125; if var urlComponents = URLComponents(url: url, resolvingAgainstBaseURL: false), !parameters.isEmpty &#123; let percentEncodedQuery = (urlComponents.percentEncodedQuery.map &#123; $0 + \"&amp;\" &#125; ?? \"\") + query(parameters) urlComponents.percentEncodedQuery = percentEncodedQuery urlRequest.url = urlComponents.url &#125; &#125; else &#123; if urlRequest.value(forHTTPHeaderField: \"Content-Type\") == nil &#123; urlRequest.setValue(\"application/x-www-form-urlencoded; charset=utf-8\", forHTTPHeaderField: \"Content-Type\") &#125;// body urlRequest.httpBody = query(parameters).data(using: .utf8, allowLossyConversion: false) &#125; return urlRequest&#125;p.s. ä¼ è¾“ç»„çš„æ—¶å€™ä¸€å®šè¦ä¼  json å­—ç¬¦ä¸²ï¼iOS 10: Background Session wonâ€™t inform when downloads have failed #1920URL Loading System","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"Net","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/Net","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/Net/"}]},{"title":"URL Loading System","date":"2019-08-19T01:52:28.000Z","path":"2019/08/19/URL-Loading-System/","text":"ç®€ä»‹åœ¨ Foundation æ¡†æ¶ä¸­æ”¯æŒåè®®ï¼šFTPåè®®ï¼ˆftp://ï¼‰è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆhttp://ï¼‰åŠ å¯†è¶…æ–‡æœ¬ä¼ è¾“åè®®(https://)æœ¬åœ°èµ„æº(file://)æ•°æ®URLs(data://)å…³é”®ç±»ï¼šURLSessionï¼ŒURLï¼ŒURLRequestï¼ŒTasksï¼ŒDataæ”¯æŒï¼šAuthorization credentialsï¼Œcache å’Œcookiesï¼Œ é…ç½®ç®¡ç†ä½¿ç”¨ closure å’Œ delegate å¤„ç† Response æ ¸å¿ƒ URLSession &amp; URLSessionTaskä¸€ä¸ª session è¯·æ±‚ç½‘ç»œæ•°æ®éœ€è¦çš„æ ¸å¿ƒå†…å®¹ Session Configurationæ¯ä¸ªé…ç½®å±æ€§éƒ½å€¼å¾—ç ”ç©¶è¿™ç¯‡æ–‡ç« æœ‰å„ä¸ªå‚æ•°ç¿»è¯‘æ€»å…±æœ‰ä¸‰ç§ configurationDefault: ä½¿ç”¨æœ¬åœ°æ²™ç›’ç¼“å­˜ï¼Œç”¨æˆ·credentialä¿å­˜åœ¨ keychain ä¸­Ephemeral: ä¸ä½¿ç”¨æ²™ç›’ï¼Œæ‰€æœ‰ç¼“å­˜credential ç­‰æ•°æ®å­˜åœ¨ ä¸ session ç»‘å®šçš„ RAM ä¸­ï¼Œsession å¤±æ•ˆåå†…å­˜è‡ªåŠ¨æ¸…ç†Background: è·Ÿ default session ç›¸ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯å¦å¤–ä¸€ä¸ª è¿›ç¨‹(process) å¤„ç†æ•°æ®ä¼ è¾“ï¼Œå› ä¸ºæ˜¯è·¨è¿›ç¨‹ï¼Œæ‰€ä»¥ background session æœ‰äº›é™åˆ¶æ“ä½œã€‚ï¼ˆå—¯åå°session ä½¿ç”¨äº†è¿›ç¨‹é—´é€šä¿¡ï¼‰ä¸ºä»€ä¹ˆè¦æœ‰ configurationï¼Ÿsession ç›¸å½“ä¸€ä¸ª managerï¼Œç”¨æ¥ç®¡ç†ç»„ç»‡ taskï¼Œç½‘ç»œäº‹ä»¶å¤„ç†çš„æ¢çº½ï¼Œconfigurationæ˜¯è¿™ä¸ªæ¢çº½çš„å‚æ•°ä¿¡æ¯ï¼ç›¸å½“äº ä¸€ä¸ª app ä»–éƒ½æœ‰ è‡ªå·± preference12345678910111213let configuration = URLSessionConfiguration.background(withIdentifier: \"com.czw.backgroundDownload\")let configuration1 = URLSessionConfiguration.default// å…è®¸ç”¨æˆ·æ‹¥æœ‰æ²™ç›’ç¼“å­˜å™¨ï¼Œå½“session é‡Šæ”¾çš„æ—¶å€™ï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨let configuration2 = URLSessionConfiguration.ephemeral// session æ— æ•ˆæ—¶ï¼Œä¸œè¥¿å°±ä¼šæ¶ˆå¤±URLSession.init(configuration: configuration).dataTask(with: URL(string: urlDownloadStr)!) .resume()// åå° sessionConfiguration ä¸èƒ½è®¾ç½® completeHandlerï¼Œéœ€è¦è‡ªå·±è®¾ç½®ä»£ç†print(\"background-å†…å­˜å¤§å°ï¼š\\(String(describing: configuration.urlCache.memoryCapacity))\")print(\"background-æ²™ç›’å¤§å°ï¼š\\(String(describing: configuration.urlCache.diskCapacity))\")print(\"default-å†…å­˜å¤§å°ï¼š\\(String(describing: configuration1.urlCache.memoryCapacity))\")print(\"default-æ²™ç›’å¤§å°ï¼š\\(String(describing: configuration1.urlCache.diskCapacity))\")print(\"ephemeral-å†…å­˜å¤§å°ï¼š\\(String(describing: configuration2.urlCache.memoryCapacity))\")print(\"ephemeral-æ²™ç›’å¤§å°ï¼š\\(String(describing: configuration2.urlCache.diskCapacity))\")æ‰“å°ç»“æœï¼šbackground-å†…å­˜å¤§å°ï¼šnilbackground-æ²™ç›’å¤§å°ï¼šnildefault-å†…å­˜å¤§å°ï¼š512000default-æ²™ç›’å¤§å°ï¼š10000000ephemeral-å†…å­˜å¤§å°ï¼š512000ephemeral-æ²™ç›’å¤§å°ï¼š0å°±åƒæ–‡æ¡£è¯´çš„ï¼Œå½“session å¤±æ•ˆä»¥å ephemeral çš„ cache ä¼šæ¶ˆå¤±ï¼Œå› ä¸ºä»–æ²¡æœ‰æ²™ç›’ç©ºé—´ session ç½‘ç»œè¯·æ±‚æˆ‘ä»¬è¦åšçš„é…ç½®éœ€è¦çš„ session configurationï¼Œé…ç½® sessionç³»ç»Ÿæä¾›çš„ shared å•ä¾‹ï¼Œç³»ç»Ÿè‡ªå·±é…ç½® configurationï¼ŒsessionDelegateï¼ŒdelegateQueueè‡ªå®šä¹‰ sessionï¼Œè‡ªå·±è®¾ç½® configurationï¼ŒsessionDelegateï¼ŒdelegateQueue(æ˜¯ serial queue)æä¾› request &amp; url ç»™ sessionç”Ÿæˆ taskURLSessionTaskURLSessionDataTaskURLSessionUploadTaskURLSessionDownloadTaskURLSessionStreamTaskURLSessionWebSocketTaskï¼ˆiOS 13.0ï¼‰é…ç½®SessionDelegate, SessionTaskDelegate å¯¹ç½‘ç»œäº‹ä»¶å¤„ç† (URLSessionTaskDelegate: URLSessionDelegateURLSessionDataDelegateURLSessionDownloadDelegateURLSessionStreamDelegateURLSessionWebSocketDelegateï¼ˆiOS 13.0ï¼‰SessionDelegate åªæœ‰3ä¸ªæ¥å£12345678@available(iOS 7.0, *)optional func urlSession(_ session: URLSession, didBecomeInvalidWithError error: Error?) @available(iOS 7.0, *)optional func urlSession(_ session: URLSession, didReceive challenge: URLAuthenticationChallenge, completionHandler: @escaping (URLSession.AuthChallengeDisposition, URLCredential?) -&gt; Void) @available(iOS 7.0, *)optional func urlSessionDidFinishEvents(forBackgroundURLSession session: URLSession)è‡³äºå„ä¸ª taskDelegateï¼Œå¯¹åº”ä¸åŒçš„task ç±»å‹æœ‰ä¸ªå­—ä¸åŒåè®®æ¥å£è¿™é‡Œä¸»è¦çœ‹ SessionTaskDelegate12345678910111213141516171819202122232425public protocol URLSessionTaskDelegate : URLSessionDelegate &#123; @available(iOS 11.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, willBeginDelayedRequest request: URLRequest, completionHandler: @escaping (URLSession.DelayedRequestDisposition, URLRequest?) -&gt; Void) @available(iOS 11.0, *) optional func urlSession(_ session: URLSession, taskIsWaitingForConnectivity task: URLSessionTask) @available(iOS 7.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, willPerformHTTPRedirection response: HTTPURLResponse, newRequest request: URLRequest, completionHandler: @escaping (URLRequest?) -&gt; Void) @available(iOS 7.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, didReceive challenge: URLAuthenticationChallenge, completionHandler: @escaping (URLSession.AuthChallengeDisposition, URLCredential?) -&gt; Void) @available(iOS 7.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, needNewBodyStream completionHandler: @escaping (InputStream?) -&gt; Void) @available(iOS 7.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, didSendBodyData bytesSent: Int64, totalBytesSent: Int64, totalBytesExpectedToSend: Int64) @available(iOS 10.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, didFinishCollecting metrics: URLSessionTaskMetrics) @available(iOS 7.0, *) optional func urlSession(_ session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)&#125;å¸¸ç”¨çš„æ˜¯ dataTaskï¼ŒdownloadTaskï¼ŒuploadTask å®é™…ä½¿ç”¨ ä»ç½‘ç«™è·å–æ•°æ®åˆ°å†…å­˜ ä½¿ç”¨å›è°ƒå¤„ç†æ¥å—ç»“æœï¼šä½¿ç”¨closure å›è°ƒå¾—åˆ° data1234567891011121314151617181920212223242526272829303132333435// task çš„çŠ¶æ€extension URLSessionTask &#123; @available(iOS 7.0, *) public enum State : Int &#123; case running case suspended // åˆè¯•çŠ¶æ€ case canceling case completed &#125;&#125;func startLoad() &#123; let url = URL(string: \"https://www.example.com/\")! let task = URLSession.shared.dataTask(with: url) &#123; data, response, error in if let error = error &#123; self.handleClientError(error) return &#125; guard let httpResponse = response as? HTTPURLResponse, (200...299).contains(httpResponse.statusCode) else &#123; self.handleServerError(response) return &#125; if let mimeType = httpResponse.mimeType, mimeType == \"text/html\", let data = data, let string = String(data: data, encoding: .utf8) &#123; DispatchQueue.main.async &#123; self.webView.loadHTMLString(string, baseURL: url) &#125; &#125; &#125;// session create å‡ºæ¥çš„ task æ˜¯ suspend çš„çŠ¶æ€ task.resume()&#125;æ³¨æ„ç‚¹ï¼šsession create å‡ºæ¥çš„ task åˆå§‹çŠ¶æ€æ˜¯ suspendå›è°ƒå¤„ç†æ˜¯åœ¨ serial queue ä»»åŠ¡æ”¾åˆ°å­çº¿ç¨‹å¤„ç†çš„ï¼Œé€šçŸ¥ UI å˜åŒ–åº”åˆ‡æ¢ä¸»çº¿ç¨‹ æ¥å—è¯·æ±‚è¯¦æƒ…&amp;ç»“æœï¼šä½¿ç”¨ Delegateè¿™ä¸ªæ—¶å€™ session ä¸åº”è¯¥ä½¿ç”¨ sharedï¼Œè€Œæ˜¯è¦è‡ªå·±é…ç½®1234567private lazy var session: URLSession = &#123; let configuration = URLSessionConfiguration.default configuration.waitsForConnectivity = true return URLSession(configuration: configuration, delegate: self, delegateQueue: nil)&#125;()123456789101112131415161718192021222324252627282930313233343536373839var receivedData: Data?func startLoad() &#123; loadButton.isEnabled = false let url = URL(string: \"https://www.example.com/\")! receivedData = Data() let task = session.dataTask(with: url) task.resume()&#125;// delegate methodsfunc urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void) &#123; guard let response = response as? HTTPURLResponse, (200...299).contains(response.statusCode), let mimeType = response.mimeType, mimeType == \"text/html\" else &#123; completionHandler(.cancel) return &#125; completionHandler(.allow)&#125;func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data) &#123; self.receivedData?.append(data)&#125;func urlSession(_ session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?) &#123; DispatchQueue.main.async &#123; self.loadButton.isEnabled = true if let error = error &#123; handleClientError(error) &#125; else if let receivedData = self.receivedData, let string = String(data: receivedData, encoding: .utf8) &#123; self.webView.loadHTMLString(string, baseURL: task.currentRequest?.url) &#125; &#125;&#125;ä½¿ç”¨ä»£ç†çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†å¾ˆå¤šç‰¹æ®Šçš„æƒ…å†µï¼šauthentication challengesfollowing redirectsURL Loading System","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"Guide","slug":"iOS-Programming/Guide","permalink":"https://changzw.github.io/categories/iOS-Programming/Guide/"}]},{"title":"loadå’Œinitialize","date":"2019-07-12T03:58:04.000Z","path":"2019/07/12/loadå’Œinitialize/","text":"+ loadload æ˜¯é€šè¿‡ c å‡½æ•°è°ƒç”¨çš„load è°ƒç”¨åœ¨ main å‡½æ•°ä¹‹å‰ï¼ŒåŠ¨æ€é“¾æ¥å™¨é€šçŸ¥è°ƒç”¨ load_imagesï¼Œæ‰§è¡Œload æ–¹æ³•load åŠ è½½é¡ºåºï¼šçˆ¶ç±»-&gt; ç±»-&gt; åˆ†ç±»load æ–¹æ³•ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯æ–¹æ³•äº¤æ¢ method swizzling load æ–¹æ³•çš„è°ƒç”¨æ ˆåœ¨ + load æ–¹æ³•å‡ºæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹ load è°ƒç”¨æ ˆ1234560 +[XXObject load]1 call_class_loads()2 call_load_methods3 load_images4 dyld::notifySingle(dyld_image_states, ImageLoader const*)11 _dyld_startdyld(dynamic link editor)ï¼Œå®ƒæ˜¯è‹¹æœçš„åŠ¨æ€é“¾æ¥å™¨ã€‚åœ¨ç³»ç»Ÿå†…æ ¸åšå¥½ç¨‹åºå‡†å¤‡å·¥ä½œä¹‹åï¼Œäº¤ç”± dyld è´Ÿè´£ä½™ä¸‹çš„å·¥ä½œåœ¨ runtime æ—¶è°ƒç”¨ load_images æ–¹æ³•,é‚£ä¹ˆå°±çœ‹ä¸‹ä»–çš„æºç (objc4-756.2)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145/************************************************************************ load_images* Process +load in the given images which are being mapped in by dyld.** Locking: write-locks runtimeLock and loadMethodLock**********************************************************************/extern bool hasLoadMethods(const headerType *mhdr);extern void prepare_load_methods(const headerType *mhdr); void load_images(const char *path __unused, const struct mach_header *mh) &#123; if (!hasLoadMethods((const headerType *)mh)) return; recursive_mutex_locker_t lock(loadMethodLock); // Discover load methods &#123; mutex_locker_t lock2(runtimeLock); prepare_load_methods((const headerType *)mh); &#125; // Call +load methods (without runtimeLock - re-entrant) call_load_methods();&#125;void prepare_load_methods(const headerType *mhdr)&#123; size_t count, i; runtimeLock.assertLocked(); classref_t *classlist = _getObjc2NonlazyClassList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) &#123; schedule_class_load(remapClass(classlist[i])); &#125; category_t **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) &#123; category_t *cat = categorylist[i]; Class cls = remapClass(cat-&gt;cls); if (!cls) continue; // category for ignored weak-linked class if (cls-&gt;isSwiftStable()) &#123; _objc_fatal(\"Swift class extensions and categories on Swift \" \"classes are not allowed to have +load methods\"); &#125; realizeClassWithoutSwift(cls); assert(cls-&gt;ISA()-&gt;isRealized()); add_category_to_loadable_list(cat); &#125;&#125;/************************************************************************ prepare_load_methods* Schedule +load for classes in this image, any un-+load-ed * superclasses in other images, and any categories in this image.**********************************************************************/// Recursively schedule +load for cls and any un-+load-ed superclasses.// cls must already be connected.static void schedule_class_load(Class cls) &#123; if (!cls) return; assert(cls-&gt;isRealized()); // _read_images should realize if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return; // Ensure superclass-first ordering schedule_class_load(cls-&gt;superclass); add_class_to_loadable_list(cls); cls-&gt;setInfo(RW_LOADED); &#125;/************************************************************************ add_class_to_loadable_list* Class cls has just become connected. Schedule it for +load if* it implements a +load method.**********************************************************************/void add_class_to_loadable_list(Class cls) &#123; IMP method; method = cls-&gt;getLoadMethod(); if (!method) return; // Don't bother if cls has no +load method if (loadable_classes_used == loadable_classes_allocated) &#123; loadable_classes_allocated = loadable_classes_allocated*2 + 16; // åˆ†é…ç±»å¯¹è±¡ç©ºé—´ï¼ŒåŠ è½½ç±» loadable_classes = (struct loadable_class *) realloc(loadable_classes, loadable_classes_allocated * sizeof(struct loadable_class)); &#125; loadable_classes[loadable_classes_used].cls = cls; loadable_classes[loadable_classes_used].method = method; loadable_classes_used++;&#125;/************************************************************************ call_load_methods* Call all pending class and category +load methods.* Class +load methods are called superclass-first. * Category +load methods are not called until after the parent class's +load.* * This method must be RE-ENTRANT, because a +load could trigger * more image mapping. In addition, the superclass-first ordering * must be preserved in the face of re-entrant calls. Therefore, * only the OUTERMOST call of this function will do anything, and * that call will handle all loadable classes, even those generated * while it was running.** The sequence below preserves +load ordering in the face of * image loading during a +load, and make sure that no * +load method is forgotten because it was added during * a +load call.* Sequence:* 1. Repeatedly call class +loads until there aren't any more* 2. Call category +loads ONCE.* 3. Run more +loads if:* (a) there are more classes to load, OR* (b) there are some potential category +loads that have * still never been attempted.* Category +loads are only run once to ensure \"parent class first\" * ordering, even if a category +load triggers a new loadable class * and a new loadable category attached to that class. ** Locking: loadMethodLock must be held by the caller * All other locks must not be held.**********************************************************************/void call_load_methods(void) &#123; static bool loading = NO; bool more_categories; // Re-entrant calls do nothing; the outermost call will finish the job. if (loading) return; loading = YES; void *pool = objc_autoreleasePoolPush(); do &#123; // 1. Repeatedly call class +loads until there aren't any more while (loadable_classes_used &gt; 0) &#123; call_class_loads(); &#125; // 2. Call category +loads ONCE more_categories = call_category_loads(); // 3. Run more +loads if there are classes OR more untried categories &#125; while (loadable_classes_used &gt; 0 || more_categories); objc_autoreleasePoolPop(pool); loading = NO;&#125; initializeæƒ°æ€§æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–å®ä¾‹å¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ­£å¸¸æƒ…å†µï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡ä¸æ­£å¸¸æƒ…å†µï¼Œè°ƒç”¨å¤šæ¬¡ï¼Œå¤šä¸ªå­ç±»æ²¡æœ‰å®ç° initializeï¼Œé‚£ä¹ˆä¼šå¤šæ¬¡è°ƒç”¨çˆ¶ç±»çš„ initialize åˆ†æ initializeè°ƒç”¨æ ˆåˆ†æ12345670 +[XXObject initialize]1 _class_initialize2 lookUpImpOrForward3 _class_lookupMethodAndLoadCache34 objc_msgSend5 main6 startä½¿ç”¨ oc æ¶ˆæ¯æœºåˆ¶å‘é€çš„çˆ¶ç±»çš„initializeæ–¹æ³•ä¼šæ¯”å­ç±»å…ˆæ‰§è¡Œå½“å­ç±»æœªå®ç°initializeæ–¹æ³•æ—¶,ä¼šè°ƒç”¨çˆ¶ç±»initializeæ–¹æ³•,å­ç±»å®ç°initializeæ–¹æ³•æ—¶,ä¼šè¦†ç›–çˆ¶ç±»initializeæ–¹æ³•. cls.isInitialized åˆ¤æ–­è¯¥ç±»æ˜¯å¦è¢«å®ä¾‹åŒ–è¿‡å½“æœ‰å¤šä¸ªCategoryéƒ½å®ç°äº†initializeæ–¹æ³•,ä¼šè¦†ç›–ç±»ä¸­çš„æ–¹æ³•,åªæ‰§è¡Œä¸€ä¸ªä½ çœŸçš„äº†è§£ load æ–¹æ³•ä¹ˆï¼Ÿæ‡’æƒ°çš„ initialize æ–¹æ³•","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"å¥½æ–‡ç« ","date":"2019-06-03T02:58:25.000Z","path":"2019/06/03/å¥½æ–‡ç« /","text":"æ·±å…¥ç†è§£ Autolayout ä¸åˆ—è¡¨æ€§èƒ½ â€“ èƒŒé”…çš„ Cassowary å’Œå·æ‡’çš„ CPUæ·±å…¥æµ…å‡ºiOSç¼–è¯‘ä¸äº†è§£GIFçš„åŠ è½½åŸç†ï¼Ÿçœ‹æˆ‘å°±å¤Ÿäº†ï¼iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§iOSåº”ç”¨æ¶æ„è°ˆ ç»„ä»¶åŒ–æ–¹æ¡ˆå¦‚ä½•è®¾è®¡ä¸€ä¸ª iOS æ§ä»¶?(iOS æ§ä»¶å®Œå…¨è§£æ)RxSwift + MVVM: how to feed ViewModelsè°ƒè¯•å†…å­˜ä¸è¶³é—®é¢˜ï¼šä½¿ç”¨è¿è¡Œæ—¶é­”æ³•æ•è·å¸ƒå±€åé¦ˆå¾ªç¯","tags":[{"name":"readings","slug":"readings","permalink":"https://changzw.github.io/tags/readings/"}],"categories":[{"name":"favorite","slug":"favorite","permalink":"https://changzw.github.io/categories/favorite/"}]},{"title":"è¯»ä»£ç  Me","date":"2019-05-16T16:47:30.000Z","path":"2019/05/17/source-code/è¯»ä»£ç -Me/","text":"ä¸ºä»€ä¹ˆçœ‹æŠ½ç©ºæ™šä¸Šç¡ä¸ç€çœ‹ awesome-ios æä¾›çš„ä¼˜ç§€ä»£ç åº“[Me](https://github.com/pascalbros/Me æºç  ä»–æ˜¯åšä»€ä¹ˆçš„Me æ˜¯è§£å†³åµŒå¥—å¼‚æ­¥é—®é¢˜çš„ä¸€ä¸ªè½»é‡çº§åº“â€”â€”å°±ä¸€ä¸ªæ–‡ä»¶ ä½¿ç”¨ä»–ä»¥åçš„æ•ˆæœbefore123456789101112MyAPI.login &#123; //Do your stuff and then request posts... MyAPI.posts &#123; //Do your stuff and then request comments... MyAPI.comments &#123; //Do your stuff and then request likes... MyAPI.likes &#123; //We are done here &#125; &#125; &#125;&#125;after123456789101112131415161718192021Me.start &#123; (me) in MyAPI.login &#123; //Do your stuff and then request posts... me.runNext() &#125;&#125;.next &#123; (caller, me) in MyAPI.posts &#123; //Do your stuff and then request comments... me.runNext() &#125;&#125;.next &#123; (caller, me) in MyAPI.comments &#123; //Do your stuff and then request likes... me.runNext() &#125;&#125;.next &#123; (caller, me) in MyAPI.likes &#123; //We are done here me.end() &#125;&#125;.run()çœ‹æ•ˆæœï¼šMe æŠŠå¼‚æ­¥åµŒå¥—ä»£ç â€“&gt; é“¾å¼ä»£ç ï¼ˆæƒ³æƒ³ä»–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿï¼‰Me æ˜¯é“¾æ¡å‹çš„ï¼Œstartï¼Œnextï¼Œnext(name:)ï¼Œjump(toName:)ï¼Œendä»–æ˜¯å¦‚ä½•åšå¼‚æ­¥é€šçŸ¥çš„ï¼Ÿå¦‚ä½•å¼€å§‹ï¼Œå¦‚ä½•ç»“æŸï¼Ÿæ”¯æŒå®ç°å¤šé“¾æ¡å¹¶å‘æ‰§è¡Œå—ï¼Ÿä»æä¾›çš„æ¥å£ä¸Šå¯ä»¥çœ‹å‡ºMeå¼€å¯ç»“æŸè¦ç”±ç”¨æˆ·æ§åˆ¶èŠ‚ç‚¹é©±åŠ¨éœ€è¦ç”¨æˆ·è§¦å‘æ”¯æŒæŒ‡å®šèŠ‚ç‚¹è·³è½¬ok ä½¿ç”¨demo&amp;åŸºæœ¬ç‰¹æ€§åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥çœ‹æºç  æºç  å…ˆçœ‹æ¥å£123456789101112131415161718192021222324public typealias MeInitClosure = ((_ current: Me) -&gt; ())public typealias MeClosure = ((_ previous: Me?, _ current: Me) -&gt; ())public var first: Me &#123; get &#125;public var index: UInt &#123; get &#125;internal var name: String &#123; get &#125;public var parameters: [String : Any]// é“¾å¼èŠ‚ç‚¹å‡½æ•°ï¼Œstatic æ˜¯èµ·ç‚¹public static func start(name: String = \"\", this: @escaping MeInitClosure) -&gt; Mepublic static func run(this: @escaping MeClosure) -&gt; Mepublic func next(name: String = \"\", next: @escaping MeClosure) -&gt; Mepublic func run()public func end()public func runNext(queue: DispatchQueue)public func runNext()public func runNextOnMain()public func jump(toIndex jump: UInt = 0, queue: DispatchQueue)public func jump(toIndex jump: UInt = 0)public func jumpOnMain(toIndex jump: UInt = 0)public func jump(toName jump: String, queue: DispatchQueue)public func jump(toName jump: String)public func jumpOnMain(toName jump: String)æä¾› Me èŠ‚ç‚¹ indexï¼Œnameï¼Œä»£ç åº“å†…éƒ¨ç»´æŠ¤åªæä¾›å…¶å®èŠ‚ç‚¹ firstæä¾›çº¿ç¨‹é˜Ÿåˆ—è°ƒåº¦æ¥å£parameters æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿåƒæ˜¯ [name: MeClouse] å­—å…¸ï¼Œæ¯ä¸ª me èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªclouse çœ‹ä»£ç å®ç°æ ¸å¿ƒä»£ç ï¼Œè¿™ä¸ªåœ°æ–¹å°è£…äº† GCD1234567891011121314public func runNext(queue: DispatchQueue) &#123; if let next = self.next &#123; //self.nextObj!.parameters = self.parameters //enable to pass parameters to the next object queue.async &#123; next(self, self.nextObj!) &#125; &#125;&#125;public func jump(toIndex jump: UInt = 0, queue: DispatchQueue) &#123; if let to = me(at: jump) &#123; to.this(self, to) &#125;&#125;æœ‰ä¸ªé—®é¢˜æ˜¯ï¼šjump çš„queue æ²¡æœ‰ç”¨â€¦â€¦ï¼ˆè¿™ä¸ªåº“çš„ä½¿ç”¨ä»·å€¼ä¸å¤§ï¼‰åªæœ‰ runNext ç›¸å…³æ–¹æ³•å¯ä»¥è°ƒåº¦çº¿ç¨‹parameters: æ˜¯ me èŠ‚ç‚¹ä¿å­˜æ•°æ®ï¼Œç”¨äºç”¨æˆ·è‡ªå·±ä¼ é€’æ•°æ®ä½¿ç”¨å†…éƒ¨æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯é“¾è¡¨12private var nextObj: Me?private var _first: Me?","tags":[{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"}],"categories":[{"name":"è¯»æºç ","slug":"è¯»æºç ","permalink":"https://changzw.github.io/categories/%E8%AF%BB%E6%BA%90%E7%A0%81/"}]},{"title":"RxSwift + MVVM:å¦‚ä½•æä¾›ViewModels","date":"2019-04-16T12:58:40.000Z","path":"2019/04/16/RxSwfit+RAC/RxSwift-MVVM-å¦‚ä½•æä¾›ViewModels/","text":"åŸæ–‡ï¼šRxSwift + MVVM: how to feed ViewModels ä»‹ç»è‡ªä»æˆ‘ä»¬å¼€å§‹åœ¨BlaBlaCarçš„Model-View-ViewModelï¼ˆMVVMï¼‰æ¶æ„ä¸­ä½¿ç”¨RxSwiftä»¥æ¥ï¼Œå·²ç»å¿«ä¸€å¹´äº†ã€‚æˆ‘ä»¬å¯¹ç»“æœæ„Ÿåˆ°å…´å¥‹ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹æ³•ç¼–å†™çš„ä»£ç æ›´å®¹æ˜“ç†è§£ï¼Œç»´æŠ¤ï¼Œæµ‹è¯•å’Œæ‰©å±•ã€‚ä½†æ˜¯ï¼Œæœ€åˆçš„å‡ å‘¨å¹¶ä¸æ˜¯å°èœä¸€ç¢Ÿã€‚æˆ‘ä»¬å¿…é¡»åœ¨MVVM + RxSwiftæ¶æ„çš„æŸäº›æ–¹é¢è¿›è¡Œè¿­ä»£ï¼Œä»¥ä½¿äº‹æƒ…å˜å¾—æ­£ç¡®ã€‚å…¶ä¸­ä¸€ä¸ªæ–¹å¼â€”â€”ç»™ ViewModels æä¾› Inputsã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸¤ç§ä¸åŒæ–¹å¼ç»™ViewModels æä¾› Inputsï¼ˆRx Eventï¼‰ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç®€å•è°ˆä¸€ä¸‹ ViewModels ViewModelsViewModelçš„èŒè´£ï¼Œä½ å¿…é¡»æ­£ç¡®ç†è§£å®ƒï¼ˆä¸æ­¢ä¸€ä¸ªï¼‰ï¼šå®ƒåº”è¯¥æ˜¯å¯ä»¥æ’å…¥åˆ°ä»»ä½•Viewä¸Šçš„ã€‚æ¯”å¦‚ï¼Œä¸æ˜¯å…ˆé€ ä¸€ä¸ªViewå†å»å®šä¹‰ä¸€ä¸ªViewModelã€‚æ³¨æ„ï¼Œæ˜¯Viewæ‹¥æœ‰ViewModelã€‚ViewçŸ¥é“ViewModelï¼Œè€Œä¸æ˜¯åè¿‡æ¥ã€‚å®ƒæ˜¯å¯æµ‹è¯•çš„ã€‚æœ€ç»ˆï¼ŒMVVMæ¶æ„æœ€å¤§çš„å¥½å¤„å°±æ˜¯è®©ä¸šåŠ¡é€»è¾‘å¯æµ‹ã€‚MVVMä½¿ç”¨ç»‘å®šæœºåˆ¶æ›´åŠ ç‰›é€¼ï¼Œæ‰€ä»¥è®©ä½¿ç”¨ RxSwift æ¥æ›´å¥½åœ°åˆ©ç”¨ ViewModelto be continuedâ€¦","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"å¦‚ä½•è¯»ä»£ç å†™ä»£ç ","date":"2019-03-02T22:31:09.000Z","path":"2019/03/03/å¦‚ä½•è¯»ä»£ç å†™ä»£ç /","text":"æ€ä¹ˆè¯»è¿™ä¸ªåº“æ˜¯ç”¨æ¥å¹²å˜›ï¼Ÿçœ‹æ–‡ä»¶ç»“æ„æ€è€ƒä½œè€…åˆ†äº†é‚£äº›æ¨¡å—æ¯ä¸ªæ¨¡å—éƒ½æ˜¯å¹²å•¥çš„æ¨¡å—è”ç³»å®é™…åœºæ™¯æ˜¯å•¥ï¼Œæ–‡ä»¶ä¸Šç”¨äº†å“ªäº›æ¶æ„orè®¾è®¡æ¨¡å¼ï¼ˆMVCï¼ŒMVVMï¼ŒViewStateModelï¼ŒCoordinateï¼ŒMeditateâ€¦â€¦ï¼‰æ¨¡å—é—´æ˜¯å¦‚ä½•è”ç³»çš„â€”â€”æ•°æ®æµäº†è§£å…·ä½“æ¨¡å—ç»†èŠ‚çœ‹å…·ä½“åè®®&amp;ç±»çš„æ¥å£ä½œè€…æƒ³è¦ç»™ç”¨æˆ·æä¾›ä»€ä¹ˆåŠŸèƒ½ç±»çš„æ•°æ®å‡ºå£&amp;å…¥å£æ˜¯ä»€ä¹ˆç±»ä¹‹é—´å…³ç³»ä½¿ç”¨äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Œå¦‚ä½•æé«˜äº†å¤ç”¨æ€§çœ‹æ•°æ®æµå‘å¯¹äºæ–‡æ¡£å°‘&amp;æƒ³æ›´æ·±å…¥ç†è§£ä»£ç ï¼Œå€ŸåŠ© IDE è°ƒè¯•ä»£ç ï¼Œè·Ÿè¸ªæ•°æ®è¾“å…¥è¾“å‡ºï¼Œçœ‹å‡½æ•°è°ƒç”¨æ ˆæ ¹æ®æ•°æ®æµå‘å¯ä»¥æ›´æ¸…æ¥šç±»ä¹‹é—´çš„å…³ç³»çœ‹å…·ä½“å®ç°æƒ³çŸ¥é“å…·ä½“ç»†èŠ‚å¦‚ä½•å®ç°çš„æ—¶å€™ï¼Œçœ‹æ–‡ä»¶ï¼Œå®šä½æºç ä½ç½® æ€ä¹ˆå†™ç¡®å®šåŠŸèƒ½æ ¹æ®åŠŸèƒ½ç¡®å®šæ¨¡å—æ ¹æ®æ¨¡å—åˆ†æ–‡ä»¶å¤¹æ€è€ƒæ¨¡å—ä¹‹é—´å…³ç³»ï¼Œå‡ºå£å…¥å£ï¼Œç›¸äº’ä¾èµ–å…³ç³»æ¯ä¸ªæ¨¡å—å†™æ¥å£â€”â€”APIAPI å±‚çº§å…³ç³»ï¼ŒæŠ½è±¡å±‚çº§ï¼Œé«˜å±‚åŠå®ç°é€šç”¨åŠŸèƒ½æ¥å£å‡ºå£å…¥å£ï¼Œä¾èµ–æ³¨å…¥æ¥å£ä¹‹é—´ä¾èµ–å…³ç³»ï¼Œæ€è€ƒä½¿ç”¨ä½•ç§è®¾è®¡æ¨¡å¼æ ¹æ®æ¨¡å—ï¼Œå®ç°åè®®class å¼€å‘class ä¹‹é—´å…³ç³»ï¼Œä½¿ç”¨ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Œæé«˜å¤ç”¨æ•ˆç‡class çš„å‡ºå£å…¥å£ï¼Œä¾èµ–æ³¨å…¥ç§æœ‰æˆå‘˜å†…éƒ¨é€»è¾‘","tags":[{"name":"å­¦ä¹ æ„Ÿæ‚Ÿ","slug":"å­¦ä¹ æ„Ÿæ‚Ÿ","permalink":"https://changzw.github.io/tags/%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/"}],"categories":[{"name":"æ€è€ƒ","slug":"æ€è€ƒ","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/"},{"name":"å¼€å‘","slug":"æ€è€ƒ/å¼€å‘","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/%E5%BC%80%E5%8F%91/"}]},{"title":"é›ªçƒé€Ÿè¯»æ³•--è¿­ä»£æ ‘--æ•´ä½“&ç»†èŠ‚","date":"2019-02-05T11:01:50.000Z","path":"2019/02/05/é›ªçƒé€Ÿè¯»æ³•/","text":"é›ªçƒé€Ÿè¯»æ³•â€“æµ…æã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹ä¸­è¯´ï¼šé€Ÿè¯»çš„æ–¹å¼æ˜¯ï¼šé€Ÿåº¦æŠ€å·§ * èµ„æ–™åº“(å¤§å°) = é€Ÿè¯»åå¤è¯» n å˜æ¯æ¬¡å¿«é€Ÿé˜…è¯»ï¼Œè¦æ±‚1.ä¸æ±‚ç”šè§£ï¼Œ2.è„‘å­é‡Œä¸è¦æœ‰è¯»çš„å£°éŸ³å…·ä½“ï¼šå…ˆè¯è¯»ç›®å½•ï¼Œå‰è¨€ï¼Œåè®° ç”¨ 15~30ï¼Œæ€è€ƒä¹¦çš„æ•´ä½“ç»“æ„ï¼Œä½œè€…å†™ä½œæ„å›¾ä»æ¡†æ¶çš„å¤–å±‚ä¸€å±‚å±‚å‘çŸ¥è¯†ç»†èŠ‚æŒ–ï¼Œæ¯æ¬¡å¤„ç†ä¸€å±‚ï¼Œç†è§£ä¸€å±‚ï¼Œæ„å»ºè‡ªå·±å¯¹è¿™æœ¬ä¹¦çš„èµ„æ–™åº“ï¼ˆæ»šé›ªçƒçš„è¿‡ç¨‹ï¼‰è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¼ºè°ƒå…ˆæŒæ¡çŸ¥è¯†çš„æ¡†æ¶ï¼ä»æ•´ä½“çš„è§’åº¦ä¸€å±‚å±‚å­¦ä¹ çŸ¥è¯†ã€‚æœ‰äº†æ¡†æ¶å°±çŸ¥é“æ£®æ—å¤§æ¦‚çš„æ ·å­ï¼å¦‚æœå•çº¯çš„æŒ‰ç…§ç›®å½•ä¸€ç‚¹ç‚¹å­¦ä¹ ä¹¦æœ¬ä¸Šçš„çŸ¥è¯†ï¼Œä¼šé™·åœ¨å±€éƒ¨ç»†èŠ‚ä¸­å‡ºä¸æ¥æµªè´¹å¤§é‡æ—¶é—´ï¼Œè¯»ä¹¦æ—¶é—´è¿‡é•¿ï¼Œå‰é¢çš„çŸ¥è¯†ä¼šå¿˜ï¼Œåé¢ä¸ä¸€å®šä¼šè®¤çœŸè¯»å®Œï¼Œæœ€åæ•´æœ¬ä¹¦éƒ½å¾ˆéš¾ç†è§£ã€‚ä½œè€…æ˜¯ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼å†™ä¹¦çš„å‘¢ï¼Ÿç±»ä¼¼äºã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹å…ˆæœ‰ä¸­å¿ƒæ€æƒ³ï¼Œç›®å½•ï¼Œæ®µè½ï¼Œç„¶åè½å®åˆ°ç»†èŠ‚ï¼Œã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹å°±æ˜¯æŒ‰ç…§ä½œè€…çš„å†™ä½œçš„æ–¹å¼ç†è§£çŸ¥è¯†çš„è¿‡ç¨‹ã€‚é€Ÿè¯»ä¸å‘å‡ºå£°éŸ³ï¼Œæ›´æœ‰åˆ©äºè¯»è€…è·Ÿä½œè€…äº§ç”Ÿå…±é¸£ï¼è¿™ä¸ªä¹Ÿæ˜¯è¯»ä¹¦çš„ä¸€ä¸ªç›®çš„ ç›®æ ‡ vs ä»»åŠ¡ç›®æ ‡ï¼šä¸€ä¸ªä½ æƒ³è¦çœ‹è§çš„å¥½ç»“æœä»»åŠ¡ï¼šä¸ºå®ç°ç›®æ ‡ä½ è¦åšçš„äº‹åœ¨ç¼ºå°‘åŠ¨åŠ›çš„æ—¶å€™å¤šæ€è€ƒç›®æ ‡å¸¦æ¥é‚£äº›ç¾å¥½çš„æ„¿æ™¯ï¼Œç”¨ Deadline ç»™è‡ªå·±æ–½åŠ å‹åŠ›ï¼Œå¯¹æ¯”äººçš„æ‰¿è¯ºã€‚åœ¨æ‰§è¡Œçš„æ—¶å€™å¤šçœ‹ç»†èŠ‚ï¼Œä»»åŠ¡ï¼Œå› ä¸ºæ€»æ˜¯å…³æ³¨ç›®æ ‡ï¼Œä¼šæ— ä»ä¸‹æ‰‹ï¼Œå¾ˆå¤šç»†èŠ‚ä¸Šçš„å›°éš¾ä¹è§‚å¯¹å¾…ï¼å¯¼è‡´ç›®æ ‡æœ€ç»ˆææµ…ã€‚ æ ‘çŠ¶ç»“æ„çŸ¥è¯†æœ‰å…³æ ‘çŠ¶ç»“æ„ï¼ŒçŸ¥è¯†è¿­ä»£è¿‡ç¨‹éƒ½æ˜¯ä¸€å±‚å±‚åŒ…è£¹çš„çŸ¥è¯†ï¼Œæœ‰å†å²æ°”æ¯çš„çŸ¥è¯†éƒ½æ˜¯æ ‘çŠ¶ç»“æ„è¿™æ ·çš„çŸ¥è¯†å¯ä»¥åƒã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹ä¸€æ ·å±‚å±‚å­¦ä¹  è®¡ç®—æœºçŸ¥è¯†è®¡ç®—æœºçŸ¥è¯†å°±æ˜¯ä¸€ä¸ªå¤§å¤§çš„æ ‘ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¤§æ ‘æï¼Œç„¶åä¸€å±‚å±‚åˆ†è§£è¿™ä¸ªçŸ¥è¯†ç‚¹ç¨‹åºå¼€å‘çš„æ—¶å€™ä¹Ÿæ˜¯ï¼Œç°æœ‰ç»“æ„ï¼Œç„¶åå†æ˜¯ç»†èŠ‚ï¼æœ‰æ—¶é—´è¡¥å……","tags":[{"name":"å­¦ä¹ æ„Ÿæ‚Ÿ","slug":"å­¦ä¹ æ„Ÿæ‚Ÿ","permalink":"https://changzw.github.io/tags/%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/"}],"categories":[{"name":"æ€è€ƒ","slug":"æ€è€ƒ","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/"},{"name":"å¼€å‘","slug":"æ€è€ƒ/å¼€å‘","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/%E5%BC%80%E5%8F%91/"}]},{"title":"iOS æ¸²æŸ“è¿‡ç¨‹æ€§èƒ½ä¼˜åŒ–","date":"2019-02-05T07:13:29.000Z","path":"2019/02/05/iOS-æ¸²æŸ“è¿‡ç¨‹æ€§èƒ½ä¼˜åŒ–/","text":"æ­¤æ–‡æ•´ç†iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ å±å¹•æ˜¾ç¤ºåŸç† CRT æ˜¾ç¤ºå™¨åŸç†ä¸€å¸§ç”»é¢ï¼šCRT çš„ç”µå­æªä»ä¸Šåˆ°ä¸‹ä¸€è¡Œè¡Œæ‰«æï¼Œæ‰«æå®Œæˆåæ˜¾ç¤ºå™¨å°±å‘ˆç°ä¸€å¸§ç”»é¢ï¼Œéšåç”µå­æªå›åˆ°åˆå§‹ä½ç½®ç»§ç»­ä¸‹ä¸€æ¬¡æ‰«æã€‚ä¸ºäº†æŠŠæ˜¾ç¤ºå™¨çš„æ˜¾ç¤ºè¿‡ç¨‹å’Œç³»ç»Ÿçš„è§†é¢‘æ§åˆ¶å™¨è¿›è¡ŒåŒæ­¥ï¼Œæ˜¾ç¤ºå™¨ï¼ˆæˆ–è€…å…¶ä»–ç¡¬ä»¶ï¼‰ä¼šç”¨ç¡¬ä»¶æ—¶é’Ÿäº§ç”Ÿä¸€ç³»åˆ—çš„å®šæ—¶ä¿¡å·ã€‚HSync: å½“ç”µå­æªæ¢åˆ°æ–°çš„ä¸€è¡Œï¼Œå‡†å¤‡è¿›è¡Œæ‰«ææ—¶ï¼Œæ˜¾ç¤ºå™¨ä¼šå‘å‡ºä¸€ä¸ªæ°´å¹³åŒæ­¥ä¿¡å·ï¼ˆhorizonal synchronizationï¼‰VSync: è€Œå½“ä¸€å¸§ç”»é¢ç»˜åˆ¶å®Œæˆåï¼Œç”µå­æªå›å¤åˆ°åŸä½ï¼Œå‡†å¤‡ç”»ä¸‹ä¸€å¸§å‰ï¼Œæ˜¾ç¤ºå™¨ä¼šå‘å‡ºä¸€ä¸ªå‚ç›´åŒæ­¥ä¿¡å·ï¼ˆvertical synchronizationï¼‰ã€‚æ˜¾ç¤ºå™¨é€šå¸¸ä»¥å›ºå®šé¢‘ç‡è¿›è¡Œåˆ·æ–°ï¼Œè¿™ä¸ªåˆ·æ–°ç‡å°±æ˜¯ VSync ä¿¡å·äº§ç”Ÿçš„é¢‘ç‡ã€‚å°½ç®¡ç°åœ¨çš„è®¾å¤‡å¤§éƒ½æ˜¯æ¶²æ™¶æ˜¾ç¤ºå±äº†ï¼Œä½†åŸç†ä»ç„¶æ²¡æœ‰å˜ CPU, GPU å°†æ•°æ®äº¤ç»™æ˜¾ç¤ºå™¨CPU, GPU å°†æ•°æ®äº¤ç»™æ˜¾ç¤ºå™¨CPU è®¡ç®—å¥½æ˜¾ç¤ºå†…å®¹æäº¤åˆ° GPUGPU æ¸²æŸ“å®Œæˆåå°†æ¸²æŸ“ç»“æœæ”¾å…¥å¸§ç¼“å†²åŒºï¼Œéšåè§†é¢‘æ§åˆ¶å™¨ä¼šæŒ‰ç…§ VSync ä¿¡å·é€è¡Œè¯»å–å¸§ç¼“å†²åŒºçš„æ•°æ®ï¼Œç»è¿‡å¯èƒ½çš„æ•°æ¨¡è½¬æ¢ä¼ é€’ç»™æ˜¾ç¤ºå™¨æ˜¾ç¤ºã€‚åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œå¸§ç¼“å†²åŒºåªæœ‰ä¸€ä¸ªï¼Œè¿™æ—¶å¸§ç¼“å†²åŒºçš„è¯»å–å’Œåˆ·æ–°éƒ½éƒ½ä¼šæœ‰æ¯”è¾ƒå¤§çš„æ•ˆç‡é—®é¢˜ã€‚ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œæ˜¾ç¤ºç³»ç»Ÿé€šå¸¸ä¼šå¼•å…¥ä¸¤ä¸ªç¼“å†²åŒºï¼Œå³åŒç¼“å†²æœºåˆ¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒGPU ä¼šé¢„å…ˆæ¸²æŸ“å¥½ä¸€å¸§æ”¾å…¥ä¸€ä¸ªç¼“å†²åŒºå†…ï¼Œè®©è§†é¢‘æ§åˆ¶å™¨è¯»å–ï¼Œå½“ä¸‹ä¸€å¸§æ¸²æŸ“å¥½åï¼ŒGPU ä¼šç›´æ¥æŠŠè§†é¢‘æ§åˆ¶å™¨çš„æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒä¸ªç¼“å†²å™¨ã€‚å¦‚æ­¤ä¸€æ¥æ•ˆç‡ä¼šæœ‰å¾ˆå¤§çš„æå‡ã€‚åŒç¼“å†²è™½ç„¶èƒ½è§£å†³æ•ˆç‡é—®é¢˜ï¼Œä½†ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„é—®é¢˜ã€‚å½“è§†é¢‘æ§åˆ¶å™¨è¿˜æœªè¯»å–å®Œæˆæ—¶ï¼Œå³å±å¹•å†…å®¹åˆšæ˜¾ç¤ºä¸€åŠæ—¶ï¼ŒGPU å°†æ–°çš„ä¸€å¸§å†…å®¹æäº¤åˆ°å¸§ç¼“å†²åŒºå¹¶æŠŠä¸¤ä¸ªç¼“å†²åŒºè¿›è¡Œäº¤æ¢åï¼Œè§†é¢‘æ§åˆ¶å™¨å°±ä¼šæŠŠæ–°çš„ä¸€å¸§æ•°æ®çš„ä¸‹åŠæ®µæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œé€ æˆç”»é¢æ’•è£‚ç°è±¡ï¼Œå¦‚ä¸‹å›¾ï¼šä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒGPU é€šå¸¸æœ‰ä¸€ä¸ªæœºåˆ¶å«åšå‚ç›´åŒæ­¥ï¼ˆç®€å†™ä¹Ÿæ˜¯ V-Syncï¼‰ï¼Œå½“å¼€å¯å‚ç›´åŒæ­¥åï¼ŒGPU ä¼šç­‰å¾…æ˜¾ç¤ºå™¨çš„ VSync ä¿¡å·å‘å‡ºåï¼Œæ‰è¿›è¡Œæ–°çš„ä¸€å¸§æ¸²æŸ“å’Œç¼“å†²åŒºæ›´æ–°ã€‚è¿™æ ·èƒ½è§£å†³ç”»é¢æ’•è£‚ç°è±¡ï¼Œä¹Ÿå¢åŠ äº†ç”»é¢æµç•…åº¦ï¼Œä½†éœ€è¦æ¶ˆè´¹æ›´å¤šçš„è®¡ç®—èµ„æºï¼Œä¹Ÿä¼šå¸¦æ¥éƒ¨åˆ†å»¶è¿Ÿã€‚ å¡é¡¿äº§ç”Ÿçš„åŸå› å’Œè§£å†³æ–¹æ¡ˆåœ¨ VSync ä¿¡å·åˆ°æ¥åï¼Œç³»ç»Ÿå›¾å½¢æœåŠ¡ä¼šé€šè¿‡ CADisplayLink ç­‰æœºåˆ¶é€šçŸ¥ AppApp ä¸»çº¿ç¨‹ å¼€å§‹åœ¨ CPU ä¸­è®¡ç®—æ˜¾ç¤ºå†…å®¹ï¼Œæ¯”å¦‚è§†å›¾çš„åˆ›å»ºã€å¸ƒå±€è®¡ç®—ã€å›¾ç‰‡è§£ç ã€æ–‡æœ¬ç»˜åˆ¶ç­‰ã€‚éšå CPU ä¼šå°†è®¡ç®—å¥½çš„å†…å®¹æäº¤åˆ° GPU å»ï¼Œç”± GPU è¿›è¡Œå˜æ¢ã€åˆæˆã€æ¸²æŸ“ã€‚éšå GPU ä¼šæŠŠæ¸²æŸ“ç»“æœæäº¤åˆ°å¸§ç¼“å†²åŒºå»ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ VSync ä¿¡å·åˆ°æ¥æ—¶æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ å¡é¡¿åŸå› å¦‚æœåœ¨ä¸€ä¸ª VSync æ—¶é—´å†…ï¼ŒCPU æˆ–è€… GPU æ²¡æœ‰å®Œæˆå†…å®¹æäº¤ï¼Œåˆ™é‚£ä¸€å¸§å°±ä¼šè¢«ä¸¢å¼ƒï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æœºä¼šå†æ˜¾ç¤ºï¼Œè€Œè¿™æ—¶æ˜¾ç¤ºå±ä¼šä¿ç•™ä¹‹å‰çš„å†…å®¹ä¸å˜ã€‚è¿™å°±æ˜¯ç•Œé¢å¡é¡¿çš„åŸå› ã€‚ä»ä¸Šé¢çš„å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒCPU å’Œ GPU ä¸è®ºå“ªä¸ªé˜»ç¢äº†æ˜¾ç¤ºæµç¨‹ï¼Œéƒ½ä¼šé€ æˆæ‰å¸§ç°è±¡ã€‚æ‰€ä»¥å¼€å‘æ—¶ï¼Œä¹Ÿéœ€è¦åˆ†åˆ«å¯¹ CPU å’Œ GPU å‹åŠ›è¿›è¡Œè¯„ä¼°å’Œä¼˜åŒ–ã€‚ CPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ å¯¹è±¡åˆ›å»ºå¯¹è±¡çš„åˆ›å»ºä¼šåˆ†é…å†…å­˜ã€è°ƒæ•´å±æ€§ã€ç”šè‡³è¿˜æœ‰è¯»å–æ–‡ä»¶ç­‰æ“ä½œï¼Œæ¯”è¾ƒæ¶ˆè€— CPU èµ„æºã€‚å°½é‡ç”¨è½»é‡çš„å¯¹è±¡ä»£æ›¿é‡é‡çš„å¯¹è±¡ï¼Œå¯ä»¥å¯¹æ€§èƒ½æœ‰æ‰€ä¼˜åŒ–ã€‚eg:CALayer æ¯” UIView è¦è½»é‡è®¸å¤šï¼Œé‚£ä¹ˆä¸éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶çš„æ§ä»¶ï¼Œç”¨ CALayer æ˜¾ç¤ºä¼šæ›´åŠ åˆé€‚ã€‚å¦‚æœå¯¹è±¡ä¸æ¶‰åŠ UI æ“ä½œï¼Œåˆ™å°½é‡æ”¾åˆ°åå°çº¿ç¨‹å»åˆ›å»ºï¼Œä½†å¯æƒœçš„æ˜¯åŒ…å«æœ‰ CALayer çš„æ§ä»¶ï¼Œéƒ½åªèƒ½åœ¨ä¸»çº¿ç¨‹åˆ›å»ºå’Œæ“ä½œã€‚é€šè¿‡ Storyboard åˆ›å»ºè§†å›¾å¯¹è±¡æ—¶ï¼Œå…¶èµ„æºæ¶ˆè€—ä¼šæ¯”ç›´æ¥é€šè¿‡ä»£ç åˆ›å»ºå¯¹è±¡è¦å¤§éå¸¸å¤šï¼Œåœ¨æ€§èƒ½æ•æ„Ÿçš„ç•Œé¢é‡Œï¼ŒStoryboard å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ€æœ¯é€‰æ‹©ã€‚å°½é‡æ¨è¿Ÿå¯¹è±¡åˆ›å»ºçš„æ—¶é—´ï¼Œå¹¶æŠŠå¯¹è±¡çš„åˆ›å»ºåˆ†æ•£åˆ°å¤šä¸ªä»»åŠ¡ä¸­å»ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”å¸¦æ¥çš„ä¼˜åŠ¿å¹¶ä¸å¤šï¼Œä½†å¦‚æœæœ‰èƒ½åŠ›åšï¼Œè¿˜æ˜¯è¦å°½é‡å°è¯•ä¸€ä¸‹ã€‚å¦‚æœå¯¹è±¡å¯ä»¥å¤ç”¨ï¼Œå¹¶ä¸”å¤ç”¨çš„ä»£ä»·æ¯”é‡Šæ”¾ã€åˆ›å»ºæ–°å¯¹è±¡è¦å°ï¼Œé‚£ä¹ˆè¿™ç±»å¯¹è±¡åº”å½“å°½é‡æ”¾åˆ°ä¸€ä¸ªç¼“å­˜æ± é‡Œå¤ç”¨ã€‚ å¯¹è±¡è°ƒæ•´å¯¹è±¡çš„è°ƒæ•´ä¹Ÿç»å¸¸æ˜¯æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚è¿™é‡Œç‰¹åˆ«è¯´ä¸€ä¸‹ CALayerï¼šCALayer å†…éƒ¨å¹¶æ²¡æœ‰å±æ€§ï¼Œå½“è°ƒç”¨å±æ€§æ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨æ˜¯é€šè¿‡è¿è¡Œæ—¶ resolveInstanceMethod ä¸ºå¯¹è±¡ä¸´æ—¶æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æŠŠå¯¹åº”å±æ€§å€¼ä¿å­˜åˆ°å†…éƒ¨çš„ä¸€ä¸ª Dictionary é‡Œï¼ŒåŒæ—¶è¿˜ä¼šé€šçŸ¥ delegateã€åˆ›å»ºåŠ¨ç”»ç­‰ç­‰ï¼Œéå¸¸æ¶ˆè€—èµ„æºã€‚UIView çš„å…³äºæ˜¾ç¤ºç›¸å…³çš„å±æ€§ï¼ˆæ¯”å¦‚ frame/bounds/transformï¼‰ç­‰å®é™…ä¸Šéƒ½æ˜¯ CALayer å±æ€§æ˜ å°„æ¥çš„ï¼Œæ‰€ä»¥å¯¹ UIView çš„è¿™äº›å±æ€§è¿›è¡Œè°ƒæ•´æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºè¦è¿œå¤§äºä¸€èˆ¬çš„å±æ€§ã€‚å¯¹æ­¤ä½ åœ¨åº”ç”¨ä¸­ï¼Œåº”è¯¥å°½é‡å‡å°‘ä¸å¿…è¦çš„å±æ€§ä¿®æ”¹ã€‚å½“è§†å›¾å±‚æ¬¡è°ƒæ•´æ—¶ï¼ŒUIViewã€CALayer ä¹‹é—´ä¼šå‡ºç°å¾ˆå¤šæ–¹æ³•è°ƒç”¨ä¸é€šçŸ¥ï¼Œæ‰€ä»¥åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œåº”è¯¥å°½é‡é¿å…è°ƒæ•´è§†å›¾å±‚æ¬¡ã€æ·»åŠ å’Œç§»é™¤è§†å›¾ã€‚ å¯¹è±¡é”€æ¯å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚å¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚è¿™é‡Œæœ‰ä¸ªå° Tipï¼šæŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œå°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚12345NSArray *tmp = self.array;self.array = nil;dispatch_async(queue, ^&#123; [tmp class];&#125;);åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è®©å¼•ç”¨è®¡æ•°å˜ä¸º 0ï¼Œè¾¾åˆ°å¼‚æ­¥å›æ”¶ï¼Œswiftç‰ˆæœ¬ï¼Œ123456789101112131415161718192021222324252627282930class AsyncReleaseObjc: NSObject &#123; deinit &#123; print(\"AsyncReleaseObjc:\" + #function + \"\\(Thread.current)\") &#125;&#125;class AsyncReleaseObjcViewController: UIViewController &#123; var mainReleaseData: AsyncReleaseObjc? var threadReleaseData: AsyncReleaseObjc? override func viewDidLoad() &#123; super.viewDidLoad() view.backgroundColor = .white mainReleaseData = AsyncReleaseObjc() threadReleaseData = AsyncReleaseObjc() &#125; override func touchesEnded(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?) &#123; mainReleaseData = nil var tmp = threadReleaseData threadReleaseData = nil DispatchQueue.global().async &#123;// æ•è· threadReleaseDataï¼Œå½“async ç»“æŸæ—¶ï¼Œé‡Šæ”¾ tmp &#125; &#125; deinit &#123; print(\"AsyncReleaseObjcController:\" + #function) &#125;&#125; å¸ƒå±€è®¡ç®—è§†å›¾å¸ƒå±€çš„è®¡ç®—æ˜¯ App ä¸­æœ€ä¸ºå¸¸è§çš„æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚å¦‚æœèƒ½åœ¨åå°çº¿ç¨‹æå‰è®¡ç®—å¥½è§†å›¾å¸ƒå±€å¹¶ä¸”å¯¹è§†å›¾å¸ƒå±€è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹åŸºæœ¬å°±ä¸ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜äº†ã€‚ä¸è®ºé€šè¿‡ä½•ç§æŠ€æœ¯å¯¹è§†å›¾è¿›è¡Œå¸ƒå±€ï¼Œå…¶æœ€ç»ˆéƒ½ä¼šè½åˆ°å¯¹ UIView.frame/bounds/center ç­‰å±æ€§çš„è°ƒæ•´ä¸Šã€‚ä¸Šé¢ä¹Ÿè¯´è¿‡ï¼Œå¯¹è¿™äº›å±æ€§çš„è°ƒæ•´éå¸¸æ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥å°½é‡æå‰è®¡ç®—å¥½å¸ƒå±€ï¼Œåœ¨éœ€è¦æ—¶ä¸€æ¬¡æ€§è°ƒæ•´å¥½å¯¹åº”å±æ€§ï¼Œè€Œä¸è¦å¤šæ¬¡ã€é¢‘ç¹çš„è®¡ç®—å’Œè°ƒæ•´è¿™äº›å±æ€§ã€‚Autolayout å¯¹äºå¤æ‚è§†å›¾æ¥è¯´å¸¸å¸¸ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚éšç€è§†å›¾æ•°é‡çš„å¢é•¿ï¼ŒAutolayout å¸¦æ¥çš„ CPU æ¶ˆè€—ä¼šå‘ˆæŒ‡æ•°çº§ä¸Šå‡ã€‚(iOS12 æ€§èƒ½æ”¹å–„ï¼Œå‡ ä¹è·Ÿ frame å·®ä¸å¤š)å…·ä½“æ•°æ®å¯ä»¥çœ‹è¿™ä¸ªæ–‡ç« ï¼šhttp://pilky.me/36/ã€‚ å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨è°ƒæ•´ frame ç­‰å±æ€§ï¼Œä½ å¯ä»¥ç”¨ä¸€äº›å·¥å…·æ–¹æ³•æ›¿ä»£ï¼ˆæ¯”å¦‚å¸¸è§çš„ left/right/top/bottom/width/height å¿«æ·å±æ€§ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ ComponentKitã€AsyncDisplayKit ç­‰æ¡†æ¶ã€‚ æ–‡æœ¬è®¡ç®—å¦‚æœä¸€ä¸ªç•Œé¢ä¸­åŒ…å«å¤§é‡æ–‡æœ¬ï¼ˆæ¯”å¦‚å¾®åšå¾®ä¿¡æœ‹å‹åœˆç­‰ï¼‰ï¼Œæ–‡æœ¬çš„å®½é«˜è®¡ç®—ä¼šå ç”¨å¾ˆå¤§ä¸€éƒ¨åˆ†èµ„æºï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœä½ å¯¹æ–‡æœ¬æ˜¾ç¤ºæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå¯ä»¥å‚è€ƒä¸‹ UILabel å†…éƒ¨çš„å®ç°æ–¹å¼ï¼šç”¨ [NSAttributedString boundingRectWithSize:options:context:] æ¥è®¡ç®—æ–‡æœ¬å®½é«˜ï¼Œç”¨ -[NSAttributedString drawWithRect:options:context:] æ¥ç»˜åˆ¶æ–‡æœ¬ã€‚å°½ç®¡è¿™ä¸¤ä¸ªæ–¹æ³•æ€§èƒ½ä¸é”™ï¼Œä½†ä»æ—§éœ€è¦æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚å¦‚æœä½ ç”¨ CoreText ç»˜åˆ¶æ–‡æœ¬ï¼Œé‚£å°±å¯ä»¥å…ˆç”Ÿæˆ CoreText æ’ç‰ˆå¯¹è±¡ï¼Œç„¶åè‡ªå·±è®¡ç®—äº†ï¼Œå¹¶ä¸” CoreText å¯¹è±¡è¿˜èƒ½ä¿ç•™ä»¥ä¾›ç¨åç»˜åˆ¶ä½¿ç”¨ã€‚ æ–‡æœ¬æ¸²æŸ“å±å¹•ä¸Šèƒ½çœ‹åˆ°çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹æ§ä»¶åœ¨åº•å±‚éƒ½æ˜¯é€šè¿‡ CoreText æ’ç‰ˆã€ç»˜åˆ¶ä¸º Bitmap æ˜¾ç¤ºçš„ã€‚UIWebViewï¼ŒUILabelã€UITextView ç­‰å…¶æ’ç‰ˆå’Œç»˜åˆ¶éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå½“æ˜¾ç¤ºå¤§é‡æ–‡æœ¬æ—¶ï¼ŒCPU çš„å‹åŠ›ä¼šéå¸¸å¤§ã€‚å¯¹æ­¤è§£å†³æ–¹æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰æ–‡æœ¬æ§ä»¶ï¼Œç”¨ TextKit æˆ–æœ€åº•å±‚çš„ CoreText å¯¹æ–‡æœ¬å¼‚æ­¥ç»˜åˆ¶ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥éå¸¸éº»çƒ¦ï¼Œä½†å…¶å¸¦æ¥çš„ä¼˜åŠ¿ä¹Ÿéå¸¸å¤§ï¼ŒCoreText å¯¹è±¡åˆ›å»ºå¥½åï¼Œèƒ½ç›´æ¥è·å–æ–‡æœ¬çš„å®½é«˜ç­‰ä¿¡æ¯ï¼Œé¿å…äº†å¤šæ¬¡è®¡ç®—ï¼ˆè°ƒæ•´ UILabel å¤§å°æ—¶ç®—ä¸€éã€UILabel ç»˜åˆ¶æ—¶å†…éƒ¨å†ç®—ä¸€éï¼‰CoreText å¯¹è±¡å ç”¨å†…å­˜è¾ƒå°‘ï¼Œå¯ä»¥ç¼“å­˜ä¸‹æ¥ä»¥å¤‡ç¨åå¤šæ¬¡æ¸²æŸ“ã€‚ å›¾ç‰‡çš„è§£ç å½“ä½ ç”¨ UIImage æˆ– CGImageSource çš„é‚£å‡ ä¸ªæ–¹æ³•åˆ›å»ºå›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡æ•°æ®å¹¶ä¸ä¼šç«‹åˆ»è§£ç ã€‚å›¾ç‰‡è®¾ç½®åˆ° UIImageView æˆ–è€… CALayer.contents ä¸­å»ï¼Œå¹¶ä¸” CALayer è¢«æäº¤åˆ° GPU å‰ï¼ŒCGImage ä¸­çš„æ•°æ®æ‰ä¼šå¾—åˆ°è§£ç ã€‚è¿™ä¸€æ­¥æ˜¯å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœæƒ³è¦ç»•å¼€è¿™ä¸ªæœºåˆ¶ï¼Œå¸¸è§çš„åšæ³•æ˜¯åœ¨åå°çº¿ç¨‹å…ˆæŠŠå›¾ç‰‡ç»˜åˆ¶åˆ° CGBitmapContext ä¸­ï¼Œç„¶åä» Bitmap ç›´æ¥åˆ›å»ºå›¾ç‰‡ã€‚ç›®å‰å¸¸è§çš„ç½‘ç»œå›¾ç‰‡åº“éƒ½è‡ªå¸¦è¿™ä¸ªåŠŸèƒ½ã€‚ å›¾åƒçš„ç»˜åˆ¶å›¾åƒçš„ç»˜åˆ¶é€šå¸¸æ˜¯æŒ‡ç”¨é‚£äº›ä»¥ CG(CoreGraphic) å¼€å¤´çš„æ–¹æ³•æŠŠå›¾åƒç»˜åˆ¶åˆ°ç”»å¸ƒä¸­ï¼Œç„¶åä»ç”»å¸ƒåˆ›å»ºå›¾ç‰‡å¹¶æ˜¾ç¤ºè¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚è¿™ä¸ªæœ€å¸¸è§çš„åœ°æ–¹å°±æ˜¯ [UIView drawRect:] é‡Œé¢äº†ã€‚ç”±äº CoreGraphic æ–¹æ³•é€šå¸¸éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å›¾åƒçš„ç»˜åˆ¶å¯ä»¥å¾ˆå®¹æ˜“çš„æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œã€‚ä¸€ä¸ªç®€å•å¼‚æ­¥ç»˜åˆ¶çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼ˆå®é™…æƒ…å†µä¼šæ¯”è¿™ä¸ªå¤æ‚å¾—å¤šï¼Œä½†åŸç†åŸºæœ¬ä¸€è‡´ï¼‰ï¼š1234567891011- (void)display &#123; dispatch_async(backgroundQueue, ^&#123; CGContextRef ctx = CGBitmapContextCreate(...); // draw in context... CGImageRef img = CGBitmapContextCreateImage(ctx); CFRelease(ctx); dispatch_async(mainQueue, ^&#123; layer.contents = img; &#125;); &#125;);&#125; GPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆç›¸å¯¹äº CPU æ¥è¯´ï¼ŒGPU èƒ½å¹²çš„äº‹æƒ…æ¯”è¾ƒå•ä¸€ï¼šæ¥æ”¶æäº¤çš„çº¹ç†ï¼ˆTextureï¼‰å’Œé¡¶ç‚¹æè¿°ï¼ˆä¸‰è§’å½¢ï¼‰åº”ç”¨å˜æ¢ï¼ˆtransformï¼‰ã€æ··åˆå¹¶æ¸²æŸ“ï¼Œç„¶åè¾“å‡ºåˆ°å±å¹•ä¸Šã€‚é€šå¸¸ä½ æ‰€èƒ½çœ‹åˆ°çš„å†…å®¹ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯çº¹ç†ï¼ˆå›¾ç‰‡ï¼‰å’Œå½¢çŠ¶ï¼ˆä¸‰è§’æ¨¡æ‹Ÿçš„çŸ¢é‡å›¾å½¢ï¼‰ä¸¤ç±»ã€‚ çº¹ç†çš„æ¸²æŸ“æ‰€æœ‰çš„ Bitmapï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€æ–‡æœ¬ã€æ …æ ¼åŒ–çš„å†…å®¹ï¼Œæœ€ç»ˆéƒ½è¦ç”±å†…å­˜æäº¤åˆ°æ˜¾å­˜ï¼Œç»‘å®šä¸º GPU Textureã€‚ä¸è®ºæ˜¯æäº¤åˆ°æ˜¾å­˜çš„è¿‡ç¨‹ï¼Œè¿˜æ˜¯ GPU è°ƒæ•´å’Œæ¸²æŸ“ Texture çš„è¿‡ç¨‹ï¼Œéƒ½è¦æ¶ˆè€—ä¸å°‘ GPU èµ„æºã€‚å½“åœ¨è¾ƒçŸ­æ—¶é—´æ˜¾ç¤ºå¤§é‡å›¾ç‰‡æ—¶ï¼ˆæ¯”å¦‚ TableView å­˜åœ¨éå¸¸å¤šçš„å›¾ç‰‡å¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼‰ï¼ŒCPU å ç”¨ç‡å¾ˆä½ï¼ŒGPU å ç”¨éå¸¸é«˜ï¼Œç•Œé¢ä»ç„¶ä¼šæ‰å¸§ã€‚é¿å…è¿™ç§æƒ…å†µçš„æ–¹æ³•åªèƒ½æ˜¯å°½é‡å‡å°‘åœ¨çŸ­æ—¶é—´å†…å¤§é‡å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå°½å¯èƒ½å°†å¤šå¼ å›¾ç‰‡åˆæˆä¸ºä¸€å¼ è¿›è¡Œæ˜¾ç¤ºã€‚å½“å›¾ç‰‡è¿‡å¤§ï¼Œè¶…è¿‡ GPU çš„æœ€å¤§çº¹ç†å°ºå¯¸æ—¶ï¼Œå›¾ç‰‡éœ€è¦å…ˆç”± CPU è¿›è¡Œé¢„å¤„ç†ï¼Œè¿™å¯¹ CPU å’Œ GPU éƒ½ä¼šå¸¦æ¥é¢å¤–çš„èµ„æºæ¶ˆè€—ã€‚ç›®å‰æ¥è¯´ï¼ŒiPhone 4S ä»¥ä¸Šæœºå‹ï¼Œçº¹ç†å°ºå¯¸ä¸Šé™éƒ½æ˜¯ 4096Ã—4096ï¼Œæ›´è¯¦ç»†çš„èµ„æ–™å¯ä»¥çœ‹è¿™é‡Œï¼šiosres.comã€‚æ‰€ä»¥ï¼Œå°½é‡ä¸è¦è®©å›¾ç‰‡å’Œè§†å›¾çš„å¤§å°è¶…è¿‡è¿™ä¸ªå€¼ã€‚ è§†å›¾çš„æ··åˆ (Composing)å½“å¤šä¸ªè§†å›¾ï¼ˆæˆ–è€…è¯´ CALayerï¼‰é‡å åœ¨ä¸€èµ·æ˜¾ç¤ºæ—¶ï¼ŒGPU ä¼šé¦–å…ˆæŠŠä»–ä»¬æ··åˆåˆ°ä¸€èµ·ã€‚å¦‚æœè§†å›¾ç»“æ„è¿‡äºå¤æ‚ï¼Œæ··åˆçš„è¿‡ç¨‹ä¹Ÿä¼šæ¶ˆè€—å¾ˆå¤š GPU èµ„æºã€‚ä¸ºäº†å‡è½»è¿™ç§æƒ…å†µçš„ GPU æ¶ˆè€—åº”ç”¨åº”å½“å°½é‡å‡å°‘è§†å›¾æ•°é‡å’Œå±‚æ¬¡å¹¶åœ¨ä¸é€æ˜çš„è§†å›¾é‡Œæ ‡æ˜ opaque å±æ€§ä»¥é¿å…æ— ç”¨çš„ Alpha é€šé“åˆæˆã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•ï¼ŒæŠŠå¤šä¸ªè§†å›¾é¢„å…ˆæ¸²æŸ“ä¸ºä¸€å¼ å›¾ç‰‡æ¥æ˜¾ç¤ºã€‚ å›¾å½¢çš„ç”Ÿæˆç¦»å±æ¸²æŸ“é€šå¸¸å‘ç”Ÿåœ¨ GPU ä¸­:CALayer çš„ borderã€åœ†è§’ã€é˜´å½±ã€é®ç½©ï¼ˆmaskï¼‰CASharpLayer çš„çŸ¢é‡å›¾å½¢æ˜¾ç¤ºï¼Œé€šå¸¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼ˆoffscreen renderingï¼‰ã€‚å½“ä¸€ä¸ªåˆ—è¡¨è§†å›¾ä¸­å‡ºç°å¤§é‡åœ†è§’çš„ CALayerï¼Œå¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œå¯ä»¥è§‚å¯Ÿåˆ° GPU èµ„æºå·²ç»å æ»¡ï¼Œè€Œ CPU èµ„æºæ¶ˆè€—å¾ˆå°‘ã€‚è¿™æ—¶ç•Œé¢ä»ç„¶èƒ½æ­£å¸¸æ»‘åŠ¨ï¼Œä½†å¹³å‡å¸§æ•°ä¼šé™åˆ°å¾ˆä½ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å°è¯•å¼€å¯ CALayer.shouldRasterize å±æ€§ï¼Œä½†è¿™ä¼šæŠŠåŸæœ¬ç¦»å±æ¸²æŸ“çš„æ“ä½œè½¬å«åˆ° CPU ä¸Šå»ã€‚å¯¹äºåªéœ€è¦åœ†è§’çš„æŸäº›åœºåˆï¼Œä¹Ÿå¯ä»¥ç”¨ä¸€å¼ å·²ç»ç»˜åˆ¶å¥½çš„åœ†è§’å›¾ç‰‡è¦†ç›–åˆ°åŸæœ¬è§†å›¾ä¸Šé¢æ¥æ¨¡æ‹Ÿç›¸åŒçš„è§†è§‰æ•ˆæœã€‚æœ€å½»åº•çš„è§£å†³åŠæ³•ï¼Œå°±æ˜¯æŠŠéœ€è¦æ˜¾ç¤ºçš„å›¾å½¢åœ¨åå°çº¿ç¨‹ç»˜åˆ¶ä¸ºå›¾ç‰‡ï¼Œé¿å…ä½¿ç”¨åœ†è§’ã€é˜´å½±ã€é®ç½©ç­‰å±æ€§ã€‚","tags":[{"name":"æ€§èƒ½ä¼˜åŒ–","slug":"æ€§èƒ½ä¼˜åŒ–","permalink":"https://changzw.github.io/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"RxSwift 5.RxDataSources","date":"2019-01-31T05:58:32.000Z","path":"2019/01/31/RxSwfit+RAC/RxSwift-RxDataSources/","text":"åŸæ–‡: RxDataSources Table å’Œ Collection View data sources ç‰¹æ€§[x] O(N)è®¡ç®—å·®å¼‚çš„ç®—æ³•è¯¥ç®—æ³•å‡è®¾æ‰€æœ‰ sections å’Œ items éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤æ²¡æœ‰äºŒä¹‰æ€§å¦‚æœæœ‰æ­§ä¹‰ï¼Œåœ¨éåŠ¨ç”»åˆ·æ–°æ—¶è‡ªåŠ¨å›é€€[x] ä»–ä½¿ç”¨å…¶ä»–å¯å‘å¼æ–¹æ³•ä»¥å°†æœ€å°‘æ•°é‡çš„å‘½ä»¤å‘é€åˆ°åˆ†æ®µè§†å›¾å³ä½¿è¿è¡Œæ—¶é—´æ˜¯çº¿æ€§çš„ï¼Œå‘é€å‘½ä»¤çš„é¦–é€‰æ•°é‡é€šå¸¸ä¹Ÿæ¯”çº¿æ€§å°‘æœ€å¥½ï¼ˆå¹¶ä¸”æœ‰å¯èƒ½ï¼‰å°†æ›´æ”¹æ•°é‡é™åˆ¶ä¸ºè¾ƒå°çš„æ•°é‡ï¼Œå¹¶ä¸”å¦‚æœæ›´æ”¹æ•°é‡æœçº¿æ€§æ–¹å‘å¢é•¿ï¼Œåˆ™åªéœ€è¿›è¡Œæ­£å¸¸çš„reloadå³å¯[x] æ”¯æŒæ‰©å±•ä½ çš„ item å’Œ section ç»“æ„åªéœ€ä½¿ç”¨ IdentifiableType å’Œ Equatable æ‰©å±•ä½ çš„ itemï¼Œå¹¶ä½¿ç”¨ AnimatableSectionModelType æ‰©å±• section[x] æ”¯æŒ section å’Œ item çš„ä¸¤çº§åˆ†å±‚åŠ¨ç”»çš„æ‰€æœ‰ç»„åˆSection åŠ¨ç”»: Insert, Delete, MovItem åŠ¨ç”»: Insert, Delete, Move, Reload (å¦‚æœæ—§å€¼ä¸ç­‰äºæ–°å€¼)[x] å¯é…ç½®åŠ¨ç”»ç±»å‹å¯¹äº Insert, Reload and Delete (Automatic, Fade, â€¦)[x] ç¤ºä¾‹ app[x] éšæœºå‹åŠ›æµ‹è¯•ï¼ˆeg appï¼‰[x] æ”¯æŒå¼€ç®±å³ç”¨çš„ç¼–è¾‘ï¼ˆeg appï¼‰[x] åŒ UITableView å’Œ UICollectionView ä¸€èµ·å·¥ä½œ ä¸ºä»€ä¹ˆç¼–å†™ table å’Œ collection View æ•°æ®æºå¾ˆç¹çã€‚å¯¹äºæœ€ç®€å•çš„æƒ…å†µï¼Œéœ€è¦å®ç°å¤§é‡çš„å§”æ‰˜æ–¹æ³•ã€‚RxSwift é€šè¿‡ç®€å•çš„æ•°æ®ç»‘å®šæœºåˆ¶æœ‰åŠ©äºå‡è½»ä¸€äº›è´Ÿæ‹…ï¼šæŠŠä½ çš„æ•°æ®è½¬åŒ–æˆå¯è§å¬åºåˆ— Observableä½¿ç”¨ä¸‹é¢æ–¹æ³•æŠŠæ•°æ®ç»‘å®šåˆ° tableView/collectionView ä¸Šrx.items(dataSource:protocol&lt;RxTableViewDataSourceType, UITableViewDataSource&gt;)rx.items(cellIdentifier:String)rx.items(cellIdentifier:String:Cell.Type:_: )rx.items(:: )123456let data = Observable&lt;[String]&gt;.just([\"first element\", \"second element\", \"third element\"])data.bind(to: tableView.rx.items(cellIdentifier: \"Cell\")) &#123; index, model, cell in cell.textLabel?.text = model&#125;.disposed(by: disposeBag)è¿™é€‚ç”¨äºç®€å•æ•°æ®é›†ï¼Œä½†ä¸é€‚ç”¨äºéœ€è¦å°†å¤æ‚æ•°æ®é›†ä¸å¤šä¸ªsection ç»‘å®šæˆ–åœ¨æ·»åŠ /ä¿®æ”¹/åˆ é™¤item æ—¶éœ€è¦æ‰§è¡ŒåŠ¨ç”»çš„æƒ…å†µã€‚è¿™äº›æ­£æ˜¯RxDataSourceså¸®åŠ©è§£å†³çš„ç”¨ä¾‹ã€‚ä½¿ç”¨RxDataSourcesï¼Œå†™èµ·æ¥éå¸¸å®¹æ˜“1234let dataSource = RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String, Int&gt;&gt;(configureCell: configureCell)Observable.just([SectionModel(model: \"title\", items: [1, 2, 3])]) .bind(to: tableView.rx.items(dataSource: dataSource)) .disposed(by: disposeBag) æ€ä¹ˆç”¨ç»™å®šä»¥ä¸‹è‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼š12345struct CustomData &#123; var anInt: Int var aString: String var aCGPoint: CGPoint&#125;é¦–å…ˆä½¿ç”¨éµå¾ª SectionModelType åè®®çš„ç»“æ„å®šä¹‰ä½ çš„sectionï¼šå®šä¹‰ item ç±»å‹åˆ«åï¼šç­‰äºè¯¥ section å°†åŒ…å«çš„ item ç±»å‹å£°æ˜ä¸€ä¸ª items å±æ€§ï¼šItem ç±»å‹æ•°ç»„123456789101112struct SectionOfCustomData &#123; var header: String var items: [Item]&#125;extension SectionOfCustomData: SectionModelType &#123; typealias Item = CustomData init(original: SectionOfCustomData, items: [Item]) &#123; self = original self.items = items &#125;&#125;åˆ›å»ºä¸€ä¸ªdataSourceå¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ SectionOfCustomData ç±»å‹ï¼š1234567891011let dataSource = RxTableViewSectionedAnimatedDataSource&lt;MySection&gt;( configureCell: &#123; ds, tv, _, item in let cell = tv.dequeueReusableCell(withIdentifier: \"Cell\") ?? UITableViewCell(style: .default, reuseIdentifier: \"Cell\") cell.textLabel?.text = \"Item \\(item)\" return cell &#125;, titleForHeaderInSection: &#123; ds, index in return ds.sectionModels[index].header &#125;)æ ¹æ®éœ€è¦åœ¨dataSourceä¸Šè‡ªå®šä¹‰é—­åŒ…ï¼štitleForHeaderInSectiontitleForFooterInSectionetc123456789101112131415dataSource.titleForHeaderInSection = &#123; dataSource, index in return dataSource.sectionModels[index].header&#125;dataSource.titleForFooterInSection = &#123; dataSource, indexPath in return dataSource.sectionModels[index].footer&#125;dataSource.canEditRowAtIndexPath = &#123; dataSource, indexPath in return true&#125;dataSource.canMoveRowAtIndexPath = &#123; dataSource, indexPath in return true&#125;å°†å®é™…æ•°æ®å®šä¹‰ä¸º CustomData å¯¹è±¡çš„ Observableåºåˆ—ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°tableView12345678let sections = [ SectionOfCustomData(header: \"First section\", items: [CustomData(anInt: 0, aString: \"zero\", aCGPoint: CGPoint.zero), CustomData(anInt: 1, aString: \"one\", aCGPoint: CGPoint(x: 1, y: 1)) ]), SectionOfCustomData(header: \"Second section\", items: [CustomData(anInt: 2, aString: \"two\", aCGPoint: CGPoint(x: 2, y: 2)), CustomData(anInt: 3, aString: \"three\", aCGPoint: CGPoint(x: 3, y: 3)) ])]Observable.just(sections) .bind(to: tableView.rx.items(dataSource: dataSource)) .disposed(by: disposeBag) æ•°æ®æºåŠ¨ç”»RxDataSources æä¾›äº†ä¸¤ç§ç‰¹æ®Šçš„æ•°æ®æºç±»å‹ï¼Œå®ƒä»¬å¯ä»¥è‡ªåŠ¨å¤„ç†ç»‘å®šæ•°æ®æºä¸­çš„åŠ¨ç”»å˜åŒ–ï¼šRxTableViewSectionedAnimatedDataSource å’Œ RxCollectionViewSectionedAnimatedDataSource ã€‚è¦ä½¿ç”¨ä¸¤ä¸ªåŠ¨ç”»æ•°æ®æºä¹‹ä¸€ï¼Œä½ å¿…é¡»åœ¨ä¸Šè¿°æ¦‚è¿°çš„åŸºç¡€ä¸Šé‡‡å–ä¸€äº›é¢å¤–çš„æ­¥éª¤ï¼šSectionOfCustomDataéœ€è¦éµå®ˆ AnimatableSectionModelType åè®®æ•°æ®æ¨¡å‹å¿…é¡»ç¬¦åˆIdentifiableTypeï¼šIdentifiableType åè®®æä¾›çš„ identity å¿…é¡»æ˜¯è¡¨ç¤ºæ¨¡å‹å®ä¾‹çš„ä¸å¯å˜æ ‡è¯†ç¬¦(identifier)ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Car æ¨¡å‹ï¼Œä½ å¯èƒ½è¦ä½¿ç”¨ Car çš„plateNumber ä½œä¸ºå…¶æ ‡è¯†ã€‚Equatableï¼šéµä» Equatable åè®® æœ‰åŠ©äºRxDataSourcesç¡®å®šå“ªäº› cell å·²æ›´æ”¹ï¼Œå› æ­¤å®ƒåªèƒ½ä¸ºè¿™äº›ç‰¹å®š cell è®¾ç½®åŠ¨ç”»ã€‚è¿™æ„å‘³ç€ï¼Œæ›´æ”¹Caræ¨¡å‹çš„ä»»ä½•å±æ€§éƒ½ä¼šè§¦å‘è¯¥ cell çš„åŠ¨ç”»é‡æ–°åŠ è½½ã€‚ éœ€è¦Xcode 10.2Swift 5.0For Swift 4.x version please use versions 3.0.0 â€¦ 3.1.0 For Swift 3.x version please use versions 1.0 â€¦ 2.0.2 For Swift 2.3 version please use versions 0.1 â€¦ 0.9 å®‰è£… CocoaPodsPodfilepod â€˜RxDataSourcesâ€™, â€˜~&gt; 4.0â€™ CarthageCartfilegithub â€œRxSwiftCommunity/RxDataSourcesâ€ ~&gt; 4.0","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"GCD åŸç†+API åˆ†æ","date":"2018-12-21T02:39:22.000Z","path":"2018/12/21/GCD-åŸç†-API-åˆ†æ/","text":"GCD æ˜¯æ“ä½œç³»ç»Ÿå±‚çº§çš„æ¦‚å¿µï¼Œä»–ç»™ç”¨æˆ·æä¾›äº†æ“ä½œçº¿ç¨‹çš„ APIä»»åŠ¡æ´¾å‘ä¸­å¿ƒï¼Œå†…éƒ¨å®ç°åŸç†æ˜¯æœ‰äº† FIFO åˆ†å‘é˜Ÿåˆ—,GCD æºç ä½¿ç”¨ GCD ç”¨æˆ·ä¸éœ€è¦ç›´æ¥æ“ä½œç¹ççš„ threadï¼Œçº¿ç¨‹æ± ç”±ç³»ç»Ÿç®¡ç†ï¼Œç”¨æˆ·åªéœ€è¦ç»´æŠ¤åˆ†å‘é˜Ÿåˆ—ï¼Œå‘åˆ†å‘é˜Ÿåˆ—ä¸­æ”¾ task å°±å¯ä»¥äº†ã€‚ç›´æ¥ä½¿ç”¨çº¿ç¨‹å¯èƒ½ä¼šå¼•å‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœä½ çš„ä»£ç å’Œæ‰€åŸºäºçš„æ¡†æ¶ä»£ç éƒ½åˆ›å»ºè‡ªå·±çš„çº¿ç¨‹æ—¶ï¼Œé‚£ä¹ˆæ´»åŠ¨çš„çº¿ç¨‹æ•°é‡æœ‰å¯èƒ½ä»¥æŒ‡æ•°çº§å¢é•¿ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ¶ˆè€—ä¸€äº›å†…å­˜å’Œå†…æ ¸èµ„æºã€‚ ä¸»è¦åŸç†ä¸»è¦ç†è§£ä¸‰ä¸ªæ¦‚å¿µqueue: ç®¡ç†ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œç¡®å®šä»»åŠ¡æ´¾å‘æ–¹å¼task: ç”¨æˆ·è‡ªå®šä¹‰éœ€è¦æ‰§è¡Œçš„ task (ä»£ç æ®µ)thread: GCD æ ¹æ® queue å®šä¹‰çš„æ–¹å¼ï¼Œå°† task æ´¾å‘ç»™çº¿ç¨‹æ± ä¸­çš„æŒ‡å®šçº¿ç¨‹ï¼ˆthread ä¸éœ€è¦è‡ªå·±åˆ›å»ºï¼‰queueä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒä¸€ä¸ª thread ä¸Šä¸€ä¸ªæ¥ç€ä¸€ä¸ªçš„æ‰§è¡Œç‰¹ä¾‹ï¼šä¸»é˜Ÿåˆ— main_queueï¼Œæ‰€æœ‰ task åœ¨ mainThread ä¸­æ‰§è¡Œå¹¶å‘é˜Ÿåˆ—ï¼Œä»»åŠ¡å¯ä»¥åœ¨å¤šä¸ª thread ä¸­æ‰§è¡Œæ²¡æœ‰å›ºå®šæ‰§è¡Œé¡ºåºç‰¹ä¾‹ï¼šglobal é˜Ÿåˆ—1234567concurrentadj. adj. å¹¶å‘çš„ï¼›ä¸€è‡´çš„ï¼›åŒæ—¶å‘ç”Ÿçš„ï¼›å¹¶å­˜çš„n. [æ•°] å…±ç‚¹ï¼›åŒæ—¶å‘ç”Ÿçš„äº‹ä»¶å¯¹äºå¹¶è¡Œè·Ÿå¹¶å‘å¹¶å‘ï¼šå€¼å¾—æ˜¯ç¨‹åºä¸Šå¤šthreadå¹¶å‘æ‰§è¡Œï¼Œå…¶å®æ˜¯å¤šçº¿ç¨‹æŠ¢å èµ„æº -- cpu æ‰§è¡Œï¼ˆä»»åŠ¡æ˜¯ä»¥åœ¨å•æ ¸ CPU ä¸Šåˆ†æ—¶ï¼ˆæ—¶é—´å…±äº«ï¼‰ï¼‰å¹¶è¡Œï¼šæ˜¯ç¡¬ä»¶ä¸Šï¼Œå¤šä¸ªthreadåœ¨å¤šä¸ª cpu ä¸ŠåŒäº‹æ‰§è¡Œç€åŒæ­¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡sync æ‰€æœ‰ä»»åŠ¡è¦åœ¨ä¸€ä¸ª thread ä¸­æ‰§è¡Œï¼Œä¸€ä¸ªæ¥ç€ä¸€ä¸ªasync å…·å¤‡å¼€å¯çº¿ç¨‹çš„èƒ½åŠ›ï¼Œå¯ä»¥åœ¨å¤šä¸ªthread ä¸­å¹¶å‘æ‰§è¡Œä»»åŠ¡threadä½¿ç”¨ GCDï¼Œä¸ç”¨å†ç›´æ¥è·Ÿçº¿ç¨‹æ‰“äº¤é“äº†ï¼Œåªéœ€è¦å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»£ç å—(task)å³å¯ï¼ŒGCD åœ¨åç«¯ç®¡ç†ç€ä¸€ä¸ªçº¿ç¨‹æ± ã€‚ä½œä¸ºå¼€å‘è€…å¯ä»¥å°†å·¥ä½œè€ƒè™‘ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ä¸€å †çº¿ç¨‹ï¼Œè¿™ç§å¹¶è¡Œçš„æŠ½è±¡æ¨¡å‹æ›´å®¹æ˜“æŒæ¡å’Œä½¿ç”¨ã€‚æ ¹æ®ğŸ‘†å›¾ task çœŸæ­£çš„å¹¶å‘åªæœ‰ å³ä¸‹è§’çš„æ‰èƒ½å‡ºç°ï¼Œå¹¶å‘é˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œä»»åŠ¡P.S.ï¼šasync æ‰§è¡Œ taskçš„æ—¶å€™ thread çš„ä¸ªæ•°è·Ÿ task çš„ä¸ªæ•°æ²¡æœ‰å…³ç³»ï¼ˆç°åœ¨ iOSç³»ç»Ÿæ˜¯å¼€è¾Ÿ 6ä¸ª threadï¼Œä»¥å‰ä½ç‰ˆæœ¬çš„æ˜¯ 3ä¸ªï¼Œthread å¼€è¾Ÿå¤ªå¤šï¼Œä¼šç”¨æ‰å¤§é‡å†…å­˜ï¼‰æ¥ä¸‹æ¥è¯´ä¸€äº› GCD æ¥å£ï¼Œæ ¹æ®æ¥å£åˆ†æåŸç† åˆ†å‘é˜Ÿåˆ— é˜Ÿåˆ—çš„åˆ›å»ºGCD å…¬å¼€æœ‰ 5 ä¸ªä¸åŒçš„å…¨å±€é˜Ÿåˆ—ï¼šè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ main queueï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰global é˜Ÿåˆ—ï¼Œ3 ä¸ªä¸åŒä¼˜å…ˆçº§çš„åå°é˜Ÿåˆ—ï¼ˆå¹¶å‘é˜Ÿåˆ—ï¼‰ä»¥åŠä¸€ä¸ªä¼˜å…ˆçº§æ›´ä½çš„åå°é˜Ÿåˆ—ï¼ˆç”¨äº I/Oï¼‰ï¼ˆå¹¶å‘é˜Ÿåˆ—ï¼‰å¾—åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—12345678dispatch_queue_main_t mainDispatchQueue = dispatch_get_main_queue();/*#define DISPATCH_QUEUE_PRIORITY_HIGH 2#define DISPATCH_QUEUE_PRIORITY_DEFAULT 0#define DISPATCH_QUEUE_PRIORITY_LOW (-2)#define DISPATCH_QUEUE_PRIORITY_BACKGROUND INT16_MIN*/dispatch_queue_global_t globalDispatchQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);è‡ªå®šä¹‰é˜Ÿåˆ—ï¼šä¸²è¡Œæˆ–è€…å¹¶è¡Œé˜Ÿåˆ—ã€‚è‡ªå®šä¹‰é˜Ÿåˆ—éå¸¸å¼ºå¤§ï¼Œåœ¨è‡ªå®šä¹‰é˜Ÿåˆ—ä¸­è¢«è°ƒåº¦çš„æ‰€æœ‰ block æœ€ç»ˆéƒ½å°†è¢«æ”¾å…¥åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—ä¸­å’Œçº¿ç¨‹æ± ä¸­ã€‚123dispatch_queue_t queueconcurrentQueue = dispatch_queue_create(\"concurrent\", DISPATCH_QUEUE_CONCURRENT);dispatch_queue_t serialQueue = dispatch_queue_create(\"serial\", DISPATCH_QUEUE_SERIAL); åˆ›å»ºé˜Ÿåˆ—å¹¶è®¾ç½®ä¼˜å…ˆçº§è·å–å…¨å±€ global ç³»ç»Ÿé˜Ÿåˆ—æ—¶ä¼ é€’ä¼˜å…ˆçº§dipatch_queue_attr_make_with_qos_classdispatch_set_target_queueä½¿ç”¨ dispatch_queue_attr_t å±æ€§è®¾ç½®ä¼˜å…ˆçº§1234dispatch_queue_t queue;dispatch_queue_attr_t attr;attr = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_UTILITY, 0);queue = dispatch_queue_create(\"com.example.myqueue\", attr);12345* The global queue priorities map to the following QOS classes:* - DISPATCH_QUEUE_PRIORITY_HIGH: QOS_CLASS_USER_INITIATED* - DISPATCH_QUEUE_PRIORITY_DEFAULT: QOS_CLASS_DEFAULT* - DISPATCH_QUEUE_PRIORITY_LOW: QOS_CLASS_UTILITY* - DISPATCH_QUEUE_PRIORITY_BACKGROUND: QOS_CLASS_BACKGROUNDè®¾ç½®ç›®æ ‡é˜Ÿåˆ—dispatch_set_target_queue ç›¸å…³æ³¨é‡Šè¯´æ˜ 123456* When no quality of service class and relative priority is specified for a* dispatch queue at the time of creation, a dispatch queue's quality of service* class is inherited from its target queue. The dispatch_get_global_queue()* function may be used to obtain a target queue of a specific quality of* service class, however the use of dispatch_queue_attr_make_with_qos_class()* is recommended instead. QOS_CLASS_USER_INTERACTIVE æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—è´Ÿè´£æ‰§è¡Œä¸ç”¨æˆ·äº¤äº’ç›¸å…³çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ã€äº‹ä»¶å¤„ç†ã€æ›´æ–°UIç­‰ï¼Œæ‰€ä»¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚è¯¥ä¼˜å…ˆçº§çš„é˜Ÿåˆ—åº”è¯¥åªé™äºåšä¸ç”¨æˆ·äº¤äº’ç›¸å…³çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä¼˜å…ˆçº§çš„å®å®šä¹‰ä¸­å¹¶æ²¡æœ‰å°†å…¶æš´éœ²å‡ºæ¥ã€‚QOS_CLASS_USER_INITIATED æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨æ¥æ‰§è¡Œé‚£äº›ä¼šé˜»ç¢ç”¨æˆ·ä½¿ç”¨ä½ çš„Appçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§ä¹Ÿå¾ˆé«˜ã€‚QOS_CLASS_DEFAULT é»˜è®¤ä¼˜å…ˆçº§ã€‚QOS_CLASS_UTILITY æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨äºæ‰§è¡Œé‚£äº›ç”¨æˆ·ä¸éœ€è¦ç«‹å³å¾—åˆ°ç»“æœçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§ç›¸å¯¹è¾ƒä½ã€‚QOS_CLASS_BACKGROUND æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨äºæ‰§è¡Œç»´æŠ¤æˆ–æ¸…ç†ç­‰ä»»åŠ¡ï¼Œç”¨æˆ·ä¸éœ€è¦å…³å¿ƒå…¶ç»“æœã€‚å°†è‡ªå®šä¹‰ queue ä¸­çš„ task éƒ½å°†è¢«æ”¾å…¥åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—å’Œçº¿ç¨‹æ± ä¸­ï¼šé»˜è®¤æƒ…å†µä¸‹ä¼šæŠŠå¼€å‘è€…åˆ›å»ºçš„é˜Ÿåˆ—æ”¾å…¥åˆ°é»˜è®¤ä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ä½†æ˜¯ä¹Ÿå¯ä»¥ç»™è‡ªå®šä¹‰çš„é˜Ÿåˆ—è®¾ç½®ä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—æ”¹å˜è‡ªå®šä¹‰ queue çš„ä¼˜å…ˆçº§ï¼šè®©å…¶æ‰§è¡Œä¼˜å…ˆçº§ä¸è¯¥ç›®æ ‡é˜Ÿåˆ—çš„æ‰§è¡Œä¼˜å…ˆçº§ä¸€è‡´ã€‚æ”¹å˜ queue ä¸­ task æ‰§è¡Œçš„æ–¹å¼ï¼šä¸ä»…èƒ½æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ˜¯å…¶ç›®æ ‡é˜Ÿåˆ—æ˜¯ä¸²è¡Œçš„ï¼Œé‚£ä¹ˆå®é™…ä¸Šè¿™ä¸ªé˜Ÿåˆ—ä¹Ÿä¼šè½¬æ¢ä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚å†è€…ï¼Œä¸åŒä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œçš„ï¼Œå¦‚æœæŠŠè¿™äº›ä¸²è¡Œé˜Ÿåˆ—çš„ç›®æ ‡é˜Ÿåˆ—éƒ½è®¾ç½®ä¸ºåŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œé‚£è¿™äº›ä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å°†ä¸ä¼šå¹¶è¡Œæ‰§è¡Œã€‚12345678910111213 * @param object * The object to modify. * The result of passing NULL in this parameter is undefined. * * @param queue * The new target queue for the object. The queue is retained, and the * previous target queue, if any, is released. * If queue is DISPATCH_TARGET_QUEUE_DEFAULT, set the object's target queue * to the default target queue for the given object type. */DISPATCH_EXPORT DISPATCH_NOTHROWvoiddispatch_set_target_queue(dispatch_object_t object, dispatch_queue_t _Nullable queue);dispatch_set_target_queueï¼šå¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ä»¥è®¾ç½®é˜Ÿåˆ—å±‚çº§ä½“ç³»ï¼Œæ¯”å¦‚è®©å¤šä¸ªä¸²è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—åœ¨ç»Ÿä¸€ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œä¸²è¡Œæ‰§è¡Œdispatch_set_target_queueä½¿ç”¨åçš„æ•ˆæœ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253func setTarget() &#123; let serialQueue = DispatchQueue(label: \"serialQueue\") let aQueue = DispatchQueue(label: \"concurrent.queue.0\", attributes: .concurrent, target: serialQueue) let bQueue = DispatchQueue(label: \"concurrent.queue.1\", attributes: .concurrent, target: serialQueue) let alabel = aQueue.label let blabel = bQueue.label aQueue.async &#123; print(\"\\(alabel): 1\") sleep(3) &#125; bQueue.async &#123; print(\"\\(blabel): 2\") sleep(1) &#125; bQueue.async &#123; print(\"\\(blabel): 3\") sleep(2) &#125;&#125;/*concurrent.queue.0: 1concurrent.queue.1: 2concurrent.queue.1: 3*/func nosetTarget() &#123; let aQueue = DispatchQueue(label: \"concurrent.queue.0\", attributes: .concurrent) let bQueue = DispatchQueue(label: \"concurrent.queue.1\", attributes: .concurrent) let alabel = aQueue.label let blabel = bQueue.label aQueue.async &#123; print(\"\\(alabel): 1\") sleep(3) &#125; bQueue.async &#123; print(\"\\(blabel): 2\") sleep(1) &#125; bQueue.async &#123; print(\"\\(blabel): 3\") sleep(2) &#125;&#125;/*concurrent.queue.0: 1concurrent.queue.1: 3concurrent.queue.1: 2*/ GCD ä»»åŠ¡è°ƒåº¦12345678910public func sync(execute workItem: DispatchWorkItem)public func async(execute workItem: DispatchWorkItem)public func async(group: DispatchGroup, execute workItem: DispatchWorkItem)public func async(group: DispatchGroup? = nil, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention(block) () -&gt; Void)public func sync&lt;T&gt;(execute work: () throws -&gt; T) rethrows -&gt; Tpublic func sync&lt;T&gt;(flags: DispatchWorkItemFlags, execute work: () throws -&gt; T) rethrows -&gt; Tpublic func asyncAfter(deadline: DispatchTime, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention(block) () -&gt; Void)public func asyncAfter(wallDeadline: DispatchWallTime, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention(block) () -&gt; Void)public func asyncAfter(deadline: DispatchTime, execute: DispatchWorkItem)public func asyncAfter(wallDeadline: DispatchWallTime, execute: DispatchWorkItem) åªæ‰§è¡Œä¸€æ¬¡ taskdispatch_once åªæ‰§è¡Œä¸€æ¬¡æŒ‡å®šçš„blockã€‚å®ƒçš„æ€§èƒ½è¦æ¯”@synchronizedè¦å¥½ã€‚@synchronizedæ¯ä¸€æ¬¡éƒ½è¦å…ˆè·å–é”ï¼Œè€Œdispatch_onceä½¿ç”¨ä¸€ä¸ªtokenæ ‡è¯†ä»£ç æ˜¯å¦æ‰§è¡Œè¿‡ã€‚1234static dispatch_once_t onceToken;dispatch_once(&amp;onceToken, ^&#123;&#125;);åœ¨Swift 3.0ä¸­è¿™ä¸ªå‡½æ•°è¢«åºŸå¼ƒäº†ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨æ‡’åŠ è½½çš„å…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼Œä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚123let onceTask: String = &#123; return \"onceTask\"&#125;() æ·»åŠ æ …æ å‡½æ•°Dispatch Barrierè§£å†³å¤šçº¿ç¨‹å¤šè¯»å•å†™åŒä¸€ä¸ªèµ„æºå‘ç”Ÿæ­»é”é—®é¢˜åŒæ­¥é˜Ÿåˆ—ä¸­ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæ·»åŠ äº† .barrier task é‚£ä¹ˆåœ¨ .barrier task ä¹‹å‰æ·»åŠ çš„ä»»åŠ¡æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œä¹‹å‰éƒ½ä¼šæœ‰ä»»åŠ¡æ‰§è¡Œï¼Œåœ¨å…¨å±€å¹¶å‘é˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ä¸Šï¼Œæ•ˆæœå’Œdispatch_syncä¸€æ ·12345678910111213141516func barrier() &#123; let q = DispatchQueue(label: \"barrier\", attributes: .concurrent) q.async &#123; print(1) &#125; q.async(flags: .barrier) &#123; print(\"sleep 2s----\") sleep(2) &#125; q.async &#123; print(3) &#125; q.async &#123; print(4) &#125;&#125;ä¸€ä¸ª barrier åŠŸèƒ½çš„ PhotoManager 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253class PhotoManager &#123; private init() &#123;&#125; static let shared = PhotoManager() private let concurrentPhotoQueue = DispatchQueue( label: \"com.raywenderlich.GooglyPuff.photoQueue\", attributes: .concurrent) private var unsafePhotos: [Photo] = [] var photos: [Photo] &#123; var photosCopy: [Photo] = [] concurrentPhotoQueue.sync &#123; photosCopy = self.unsafePhotos &#125; return photosCopy &#125; func addPhoto(_ photo: Photo) &#123; concurrentPhotoQueue.async(flags: .barrier) &#123; [weak self] in guard let self = self else &#123; return &#125; self.unsafePhotos.append(photo) DispatchQueue.main.async &#123; [weak self] in self?.postContentAddedNotification() &#125; &#125; &#125; func downloadPhotos(withCompletion completion: BatchPhotoDownloadingCompletionClosure?) &#123; var storedError: NSError? for address in [PhotoURLString.overlyAttachedGirlfriend, PhotoURLString.successKid, PhotoURLString.lotsOfFaces] &#123; let url = URL(string: address) let photo = DownloadPhoto(url: url!) &#123; _, error in if error != nil &#123; storedError = error &#125; &#125; PhotoManager.shared.addPhoto(photo) &#125; completion?(storedError) &#125; private func postContentAddedNotification() &#123; NotificationCenter.default.post(name: PhotoManagerNotification.contentAdded, object: nil) &#125;&#125; æ·»åŠ  group é€šçŸ¥dispatch groupsæ˜¯ä¸“é—¨ç”¨æ¥ç›‘è§†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚dispatch_group_tå®ä¾‹ç”¨æ¥è¿½è¸ªä¸åŒé˜Ÿåˆ—ä¸­çš„ä¸åŒä»»åŠ¡ã€‚å½“groupé‡Œæ‰€æœ‰äº‹ä»¶éƒ½å®ŒæˆGCD APIæœ‰ä¸¤ç§æ–¹å¼å‘é€é€šçŸ¥ï¼Œç¬¬ä¸€ç§æ˜¯dispatch_group_waitï¼Œä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç­‰æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆæˆ–ç­‰å¾…è¶…æ—¶ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨dispatch_group_notifyï¼Œå¼‚æ­¥æ‰§è¡Œé—­åŒ…ï¼Œä¸ä¼šé˜»å¡ã€‚ä¸€ä¸ªå¾ˆæ£’çš„ ä½¿ç”¨ group åšåŒæ­¥çš„ä¾‹å­ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374class PhotoManager &#123; private init() &#123;&#125; static let shared = PhotoManager() private let concurrentPhotoQueue = DispatchQueue( label: \"com.raywenderlich.GooglyPuff.photoQueue\", attributes: .concurrent) private var unsafePhotos: [Photo] = [] var photos: [Photo] &#123; var photosCopy: [Photo]! concurrentPhotoQueue.sync &#123; photosCopy = self.unsafePhotos &#125; return photosCopy &#125; func addPhoto(_ photo: Photo) &#123; concurrentPhotoQueue.async(flags: .barrier) &#123; [weak self] in guard let self = self else &#123; return &#125; self.unsafePhotos.append(photo) DispatchQueue.main.async &#123; [weak self] in self?.postContentAddedNotification() &#125; &#125; &#125; func downloadPhotos(withCompletion completion: BatchPhotoDownloadingCompletionClosure?) &#123; var storedError: NSError? let downloadGroup = DispatchGroup() var addresses = [PhotoURLString.overlyAttachedGirlfriend, PhotoURLString.successKid, PhotoURLString.lotsOfFaces] addresses += addresses + addresses var blocks: [DispatchWorkItem] = [] for index in 0..&lt;addresses.count &#123; downloadGroup.enter() let block = DispatchWorkItem(flags: .inheritQoS) &#123; let address = addresses[index] let url = URL(string: address) let photo = DownloadPhoto(url: url!) &#123; _, error in if error != nil &#123; storedError = error &#125; downloadGroup.leave() &#125; PhotoManager.shared.addPhoto(photo) &#125; blocks.append(block) DispatchQueue.main.async(execute: block) &#125; for block in blocks[3..&lt;blocks.count] &#123; let cancel = Bool.random() if cancel &#123; block.cancel() downloadGroup.leave() &#125; &#125; downloadGroup.notify(queue: DispatchQueue.main) &#123; completion?(storedError) &#125; &#125; private func postContentAddedNotification() &#123; NotificationCenter.default.post(name: PhotoManagerNotification.contentAdded, object: nil) &#125;&#125; æŒ‚èµ·/æ¢å¤é˜Ÿåˆ—12queue.suspend()queue.resume()è¿™é‡ŒæŒ‚èµ·ä¸ä¼šæš‚åœæ­£åœ¨æ‰§è¡Œçš„block dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£123456789101112131415func apply() &#123; let q = DispatchQueue(label: \"apply\", attributes: .concurrent) __dispatch_apply(5, q)&#123; idx in print(idx)// å¼‚æ­¥å¹¶å‘ &#125; print(\"apply end\")// åŒæ­¥ç­‰å¾…&#125;/*04132apply end*/dispatch_applyåœ¨å¹¶å‘é˜Ÿåˆ—ä¸­ä½¿ç”¨å°† task è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­æ‰€æœ‰ task å¹¶å‘æ‰§è¡Œå®Œä»¥ååŒæ­¥æ‰§è¡Œåé¢çš„æ‰“å°dispatch_apply æ·»åŠ çš„ task æ˜¯å¼‚æ­¥å¹¶å‘æ‰§è¡Œï¼Œå¤–éƒ¨æ˜¯åŒæ­¥æ‰§è¡Œç”¨dispatch_applyæ›¿ä»£å¯¹æ•°ç»„ç­‰çš„forå¾ªç¯ï¼ŒæŠŠè¿™äº›blockæ”¾åˆ°å¹¶è¡Œé˜Ÿåˆ—ä¸­å¯ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚ Dispatch Semaphoreä½¿ç”¨å˜é‡ç®¡ç†å¤šçº¿ç¨‹çš„åŒæ­¥æ–¹æ³•123dispatch_semaphore_t dispatch_semaphore_create(long value);long dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout); long dispatch_semaphore_signal(dispatch_semaphore_t dsema);å¹¶å‘ç¼–ç¨‹ï¼šAPI åŠæŒ‘æˆ˜ç»†è¯´GCDï¼ˆGrand Central Dispatchï¼‰å¦‚ä½•ç”¨raywenderlich è¿™ä¸¤ç¯‡å®ä¾‹å¾ˆæ£’ï¼Grand Central Dispatch Tutorial for Swift 4: Part 1/2Grand Central Dispatch Tutorial for Swift 4: Part 2/2","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"ç®€åŒ–è®¾è®¡ App çš„è¿‡ç¨‹","date":"2018-12-06T09:31:17.000Z","path":"2018/12/06/ç®€åŒ–è®¾è®¡-App-çš„è¿‡ç¨‹/","text":"å‰è¨€ä¸€ä¸ª app åŸå‹&amp;éœ€æ±‚æ¥äº†ä»¥åï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿæœ¬æ¥ä¸€ä¸ªå®Œæˆçš„ä¸œè¥¿å¦‚ä½•æŠŠéœ€æ±‚ç¿»è¯‘æˆç¨‹åºå‘¢ï¼Ÿ æ­£å¸¸èŠ‚å¥ï¼šåˆ†æéœ€æ±‚åŸå‹åˆ†æéœ€æ±‚åˆ†ææŠ€æœ¯ç‚¹è°ƒç ”åˆ†ææ¶æ„æ–¹å¼ä½¿ç”¨ä»€ä¹ˆæ¡†æ¶ï¼ˆæ¡†æ¶å¯¹æ¯”ï¼‰View å±‚ä½¿ç”¨ä»€ä¹ˆæ¸²æŸ“æ–¹å¼ï¼ŒModelå±‚ä½¿ç”¨ä»€ä¹ˆç»„ä»¶ï¼Œä¸­é—´å±‚ä½¿ç”¨ä»€ä¹ˆå·¥å…·æ—¶é—´é¢„ä¼°æ–°æŠ€æœ¯å­¦ä¹ æ—¶é—´å¼€å‘æ—¶é—´è°ƒè¯•æ—¶é—´ é‡åˆ°é—®é¢˜éœ€æ±‚é‡å¤§ï¼Œå¼ºè°ƒä»£ç çš„å¤ç”¨æ€§ï¼æ€è€ƒæ—¶é—´è¿‡é•¿éœ€æ±‚ç†è§£é”™è¯¯ï¼Œç†è§£ä¸æ·±ï¼Œå·®å¼‚æ€§é—®é¢˜æ²¡æœ‰è§£å†³æ–°æŠ€æœ¯ï¼Œç†Ÿç»ƒåº¦é—®é¢˜ï¼Œé”™è¯¯ä½¿ç”¨æ²Ÿé€šé—®é¢˜ï¼ ç®€å•æ€è€ƒç®€åŒ–å¼€å‘æµç¨‹ï¼App ç¼–ç è¿‡ç¨‹ç…§ç€ç”» UIç¡®å®šæ•°æ®æ¸²æŸ“æ–¹å¼ï¼ç®€åŒ–è®© model å±‚æ•°æ®ä¼ åˆ° UI å±‚æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œè®©æ°´æµé€šï¼ˆæˆ‘å–œæ¬¢çš„æ–¹å¼æ˜¯å‡½æ•°å“åº”å¼ rxï¼‰æ•°æ®æµè¿æ¥å®Œæˆä»¥åï¼Œæ·»åŠ å„ç§é€»è¾‘å•é“¾é€»è¾‘ä¸€æ¡æ¡åŠ å¤ç”¨çš„åœ°æ–¹åœ¨å¤ç”¨ä»£ç ä¸æ˜¯ä¸€ä¸‹å­å®Œç¾çš„ï¼å¼€å§‹çš„æ—¶å€™ä¸è¦å¤ªå¤æ‚ä¸è¦ç”¨å¤ªé«˜ç«¯è‡ªå·±åˆä¸ç†Ÿæ‚‰çš„æŠ€å·§é‡æ„ä¼˜åŒ–ä½¿ç”¨æ›´å¥½åœ°æŠ€æœ¯æ‰‹æ®µéƒ½æ˜¯è¿­ä»£çš„è¿‡ç¨‹","tags":[{"name":"å­¦ä¹ æ„Ÿæ‚Ÿ","slug":"å­¦ä¹ æ„Ÿæ‚Ÿ","permalink":"https://changzw.github.io/tags/%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/"}],"categories":[{"name":"æ€è€ƒ","slug":"æ€è€ƒ","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/"},{"name":"å¼€å‘","slug":"æ€è€ƒ/å¼€å‘","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/%E5%BC%80%E5%8F%91/"}]},{"title":"viewController transitions","date":"2018-11-06T09:21:48.000Z","path":"2018/11/06/UI ç›¸å…³/viewController-transitions/","text":"å‰è¨€iOS ç³»ç»Ÿæä¾›äº†åƒ push, pop, cover vertically è¿™æ ·çš„ ViewController è¿‡æ¸¡ï¼Œè¯¥ç¯‡åˆ†æå¦‚ä½•è‡ªå®šä¹‰è‡ªå·±çš„ ViewController transitionsã€‚ä¸ºå•¥è¦å†™è¿™ä¸ªå› ä¸ºâ€œçœ‹ç€å¾ˆéº»çƒ¦â€ï¼Œæ¯”èµ· pushï¼Œpopï¼Œpresent æ¥è¯´â€¦â€¦æ€è€ƒï¼šViewController çš„ è¿‡æ¸¡æµç¨‹æ­¥éª¤æ˜¯ä»€ä¹ˆæ ·çš„éƒ½æœ‰ä»€ä¹ˆç»„æˆï¼Œä»–ä»¬ä¹‹é—´çš„é€»è¾‘æ˜¯ä»€ä¹ˆæ ·çš„ç”¨æˆ·å¦‚ä½•ä½¿ç”¨è¿‡æ¸¡çš„è¿‡ç¨‹ï¼Œåº”è¯¥æœ‰ï¼šè´Ÿè´£è§¦å‘äº‹ä»¶è´Ÿè´£ç®¡ç†è¿‡æ¸¡åŠ¨ç”»è´Ÿè´£è¿‡æ¸¡ç›¸å…³çš„ViewControllersï¼ŒViews transitions ç»“æ„transitioning API ä¸€ç»„ protocols ç»“åˆï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰åŒ–ï¼Œä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„ transition å¯¹è±¡ or è‡ªå·±å®šä¹‰ä¸€ä¸ªæ–°çš„ã€‚Q: æ¯ä¸ªåè®®çš„è´£ä»»æ˜¯ä»€ä¹ˆï¼ŸQ: æ‰§è¡Œæ­¥éª¤æ˜¯ä»€ä¹ˆ Transitioning Delegateæ¯ä¸ª ViewController éƒ½æœ‰å¯¹è±¡â€”â€” transitioningDelegate: UIViewControllerTransitioningDelegate ç”¨æ¥å¾—åˆ° Animation controller å¯¹è±¡12345extension CardViewController: UIViewControllerTransitioningDelegate &#123; func animationController(forPresented presented: UIViewController, presenting: UIViewController, source: UIViewController) -&gt; UIViewControllerAnimatedTransitioning? &#123; return FlipPresentAnimationController(originFrame: cardView.frame) &#125;&#125;å½“ä½  present or dismiss ViewController çš„æ—¶å€™ï¼ŒUIKit ä¼šå‘ transitioningDelegate è¦ä½ è‡ªå®šä¹‰çš„ Animation controller æ¥æ›¿ä»£é»˜è®¤åŠ¨ç”»ã€‚ä½ è¦åšçš„æ˜¯å®ç° UIViewControllerTransitioningDelegate ä»£ç†æ–¹æ³•è¿”å› Animation controller Animation Controllerç”¨æ¥åšè¿‡æ¸¡åŠ¨ç”»ï¼Œä»–å®ç°è‡ª UIViewControllerAnimatedTransitioning12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758class FlipPresentAnimationController: NSObject,UIViewControllerAnimatedTransitioning &#123;// è®¾ç½®åŠ¨ç”»æ—¶é—´ func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -&gt; TimeInterval &#123; return 0.6 &#125;// ä»UIViewControllerContextTransitioning ä¸­å¾—åˆ° toVc &amp; fromVcï¼Œå¯¹å…¶åˆ¶ä½œåŠ¨ç”» func animateTransition(using transitionContext: UIViewControllerContextTransitioning) &#123; //1 é€šè¿‡ transitionContext å¾—åˆ° fromVC æ˜¯è§¦å‘ presentçš„VCï¼ŒtoVC æ˜¯è¦è¢«å‘ˆç°çš„ VCï¼ŒsnapShotï¼Œæ˜¯toVC å‘ˆç°ä»¥åçš„view æˆªå›¾ç”¨äºåšåŠ¨ç”» guard let fromVC = transitionContext.viewController(forKey: .from), let toVC = transitionContext.viewController(forKey: .to), let snapshot = toVC.view.snapshotView(afterScreenUpdates: true) else &#123; return &#125;//containerView æ˜¯è¿‡æ¸¡è¿‡ç¨‹ä¸­çš„å®¹å™¨ view let containerView = transitionContext.containerView let finalFrame = transitionContext.finalFrame(for: toVC) snapshot.frame = originFrame snapshot.layer.cornerRadius = CardViewController.cardCornerRadius snapshot.layer.masksToBounds = true containerView.addSubview(toVC.view) containerView.addSubview(snapshot) toVC.view.isHidden = true AnimationHelper.perspectiveTransform(for: containerView) snapshot.layer.transform = AnimationHelper.yRotation(.pi / 2) let duration = transitionDuration(using: transitionContext) // å¯¹ view åšåŠ¨ç”»å¤„ç† UIView.animateKeyframes( withDuration: duration, delay: 0, options: .calculationModeCubic, animations: &#123; UIView.addKeyframe(withRelativeStartTime: 0.0, relativeDuration: 1/3) &#123; fromVC.view.layer.transform = AnimationHelper.yRotation(-.pi / 2) &#125; UIView.addKeyframe(withRelativeStartTime: 1/3, relativeDuration: 1/3) &#123; snapshot.layer.transform = AnimationHelper.yRotation(0.0) &#125; UIView.addKeyframe(withRelativeStartTime: 2/3, relativeDuration: 1/3) &#123; snapshot.frame = finalFrame snapshot.layer.cornerRadius = 0 &#125; &#125;, completion: &#123; _ in toVC.view.isHidden = false snapshot.removeFromSuperview() fromVC.view.layer.transform = CATransform3DIdentity transitionContext.completeTransition(!transitionContext.transitionWasCancelled) &#125;) &#125;&#125; ç®€è¿°å¯¹äºéœ€è¦è‡ªå®šä¹‰çš„ transitioning çš„ ViewControllerï¼ŒCustomViewControllerCustomViewController: UIViewControllerTransitioningDelegate å®ç°åè®®å®ç°åè®®çš„12animationController(presented:, presenting:, source:) -&gt; UIViewControllerAnimatedTransitioninganimationController(dismiss:) -&gt; UIViewControllerAnimatedTransitioningè‡ªå®šä¹‰ Animation Controllerï¼ˆCustomeAnimationController: UIViewControllerAnimatedTransitioning)å®ç° UIViewControllerAnimatedTransitioning ä¸­çš„12transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -&gt; TimeIntervalanimateTransition(transitionContext:) ç»™ dismiss æ·»åŠ æ‰‹åŠ¿äº¤äº’Custom UIViewController Transitions: Getting Started","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"App æ¶æ„","date":"2018-09-18T02:28:02.000Z","path":"2018/09/18/architecture/App-æ¶æ„/","text":"objc ã€ŠApp æ¶æ„ã€‹ ç¬”è®° å¦‚ä½•è®¾è®¡æ¶æ„ç¡®å®šæ¨¡å—ï¼ˆModel å±‚ï¼ŒView å±‚ï¼Œåè°ƒå™¨â€¦â€¦ï¼‰å¦‚ä½•ç¡®å®šæ¨¡å—ï¼Ÿè”æƒ³å®é™…åœºæ™¯ï¼Œåˆ†æè´£ä»»ã€è¡Œä¸ºï¼Œç¡®å®šæ¨¡å—ï¼ï¼ä¸ºä»€ä¹ˆè¦ç¡®å®šæ¨¡å—ï¼Ÿç¡®å®šæ¨¡å—åï¼Œç¨‹åºä¸ä¼šè¢«åº”ç”¨æ¡†æ¶ä¸­çš„å®ç°ç»†èŠ‚æ‰€æ”¯é…æ¨¡å—é—´çš„è”ç³»ï¼Œä¾èµ–ï¼Œå˜æ¢ï¼Œé€šçŸ¥è¡Œä¸ºå¦‚ä½•å®šä¹‰ã€‚å°½å¯èƒ½è®©æ•°æ®æµå‘å•å‘æ¸…æ™°ç¡®å®šæ•°æ®æµå‘è¡Œä¸ºç»Ÿä¸€ä¸€è‡´ï¼Œç»Ÿä¸€ç¨‹åºå¼€å‘ç»´æŠ¤delegateï¼Œnotificationï¼Œblockï¼Œkvoï¼ŒRxâ€¦â€¦ MVCModel å±‚åŒ…æ‹¬ï¼Œdata modelå’Œserver modelcontrolerï¼šå¼•ç”¨ server model MVVM-C ç½‘ç»œ MVC+ViewState Model é€‚é…å™¨ + View ç»‘å®šå™¨ Elm æ¶æ„","tags":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"}],"categories":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"}]},{"title":"â€œTâ€ å­—æ¨¡å‹","date":"2018-08-24T07:30:54.000Z","path":"2018/08/24/å¼€å‘ä¸Šçš„æ€è€ƒ/","text":"æ¶æ„çš„æ—¶å€™å®¹æ˜“ä¹±â€”â€”ä½¿ç”¨ â€œTâ€ å­—æ¨¡å‹æ€è€ƒåŸå› ï¼šæ¶æ„ä»£ç çš„æ—¶å€™ï¼Œæ€»æƒ³æœ‰æ²¡æœ‰æ›´å¥½åœ°è§£å†³æ–¹æ¡ˆï¼Œå¦‚ä½•å°½å¯èƒ½çš„æ¨¡å—è§£è€¦ï¼Œè´£ä»»å•ä¸€â€¦â€¦ï¼Œå¦‚ä½•æŸ¥åˆ†ç±»ï¼Œæ¶æ„ä¸­éœ€è¦æœ‰ä»€ä¹ˆæ¨¡å—ï¼Œéœ€è¦ä½¿ç”¨ä»€ä¹ˆå·¥å…·é“¾â€¦â€¦å¯æ˜¯ä¸€ä¸‹å­æŠŠæ‰€æœ‰é—®æ”¾åœ¨ä¸€èµ·ï¼Œæ•´ä¸ªäººå¾ˆå¤šæ—¶å€™ä¼šä¹±ï¼Œè€Œä¸”æƒ³çš„è¶Šå¤šè¶Šä¹±è§£å†³æ–¹æ¡ˆï¼šç®€å•åŒ–æ¨¡å—ï¼Œç°æœ‰æœ€åŸºæœ¬çš„æ¡†æ¶ eg MVVMï¼ŒMVCæŠŠæœ€ç®€å•çš„æ¨¡å‹å…ˆæ­å»ºèµ·æ¥ï¼Œç„¶åå®ç°ä¸€ä¸ªä¸»æµç¨‹åŠŸèƒ½æ¥ç€åœ¨å®ç°å…¶ä»–ä¸»æµç¨‹åŠŸèƒ½æƒ³æƒ³å¯ä»¥æ·»åŠ é‚£äº› æ¨¡å—ç»„ä»¶ è®©è‡ªå·±çš„æ¶æ„æ›´åŠ ä¼˜ç¾é‡æ„ï¼Œç„¶åå†å…ˆæœ‰ä¸ªä¸»æµç¨‹çº¿æ€»ç»“ï¼šç°æœ‰è¦åšçš„ä¸œè¥¿æœ‰ä¸ª å¤–åœ¨çš„æ•´ä½“è®¤è¯†ï¼Œæƒ³ç»™ç”¨æˆ·æä¾›ä»€ä¹ˆ æ¥å£ï¼å…ˆå®ç°ä¸€ä¸ªæ¥å£çš„åŠŸèƒ½ï¼Œç„¶åå†æŠŠæ‰€æœ‰çº¿çš„å®ç°å‡ºæ¥é‡æ„æ•´ä½“æ€æƒ³æ–¹å¼ æ˜¯ â€œTâ€ å­—æ€è€ƒ æ¨¡å—ç»„ä»¶é—´äº¤äº’ç¹æ‚â€”â€” ä¸ºä»€ä¹ˆæœ‰ ä¸­ä»‹è€…ç¨‹åºè°ƒç”¨æµç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ€ç»´æ··ä¹±çš„ç¨‹åºå‘˜å¾ˆå®¹æ˜“æŠŠè¿™æ¡çº¿æçš„æ‚ä¹±æ— ç« ï¼Œè™½ç„¶å¯ä»¥è®©ç¨‹åºè·‘èµ·æ¥ï¼Œå¯æ˜¯ç»´æŠ¤è´¹åŠ²ä¸­ä»‹è€…ï¼šæ¨¡å—ä¸­æä¾›ä¸­ä»‹è€…ï¼Œå®šä¹‰ä¸€ç§ç¼–ç¨‹è§„èŒƒï¼Œä½¿ç”¨ ä¸­ä»‹è€… è®©ä»£ç åˆ†ç±»ï¼Œè¿™æ ·æŠŠæ¨¡å—å‡å°‘ï¼Œå‡å°‘æ‚ä¹±çš„çº¿ï¼Œè¿™äº›çº¿æ”¾åœ¨ä¸­ä»‹è€…ä¸­ä¸­ä»‹è€…â€”â€” åƒä¸ªç®¡ç†è€…ä¸€æ ·ï¼Œåœ¨å®é™…ä¸­è°ƒåº¦å„ä¸ªéƒ¨é—¨ï¼Œéƒ¨é—¨æœ‰ä»€ä¹ˆé—®é¢˜æƒ³ä¸­ä»‹è€…æ±‡æŠ¥å¦‚æœæ²¡æœ‰ä¸­ä»‹è€…â€”â€”ç®¡ç†è€…ï¼Œé‚£ä¹ˆ éƒ¨é—¨ä¹‹é—´é—®é¢˜ç›¸äº’ç©¿æ’ orz","tags":[{"name":"å­¦ä¹ æ„Ÿæ‚Ÿ","slug":"å­¦ä¹ æ„Ÿæ‚Ÿ","permalink":"https://changzw.github.io/tags/%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/"}],"categories":[{"name":"æ€è€ƒ","slug":"æ€è€ƒ","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/"},{"name":"å¼€å‘","slug":"æ€è€ƒ/å¼€å‘","permalink":"https://changzw.github.io/categories/%E6%80%9D%E8%80%83/%E5%BC%80%E5%8F%91/"}]},{"title":"RxSwift æºç åˆ†æ","date":"2018-08-18T08:56:26.000Z","path":"2018/08/18/RxSwfit+RAC/RxSwift-æºç åˆ†æ/","text":"","tags":[{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"çˆ¬æ¥¼æ¢¯","date":"2018-07-03T06:49:50.000Z","path":"2018/07/03/çˆ¬æ¥¼æ¢¯/","text":"çˆ¬æ¥¼æ¢¯ é—®é¢˜æè¿°å‡è®¾ä½ æ­£åœ¨çˆ¬æ¥¼æ¢¯ã€‚éœ€è¦ n é˜¶ä½ æ‰èƒ½åˆ°è¾¾æ¥¼é¡¶ã€‚æ¯æ¬¡ä½ å¯ä»¥çˆ¬ 1 æˆ– 2 ä¸ªå°é˜¶ã€‚ä½ æœ‰å¤šå°‘ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶å‘¢ï¼Ÿ123456789101112131415æ³¨æ„ï¼šç»™å®š n æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚ç¤ºä¾‹ 1ï¼šè¾“å…¥ï¼š 2è¾“å‡ºï¼š 2è§£é‡Šï¼š æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶ã€‚1. 1 é˜¶ + 1 é˜¶2. 2 é˜¶ç¤ºä¾‹ 2ï¼šè¾“å…¥ï¼š 3è¾“å‡ºï¼š 3è§£é‡Šï¼š æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶ã€‚1. 1 é˜¶ + 1 é˜¶ + 1 é˜¶2. 1 é˜¶ + 2 é˜¶3. 2 é˜¶ + 1 é˜¶ åˆ†æå¯ä»¥æŸ¥åˆ†ä¸ºå­é—®é¢˜ï¼Œdivision ä½¿ç”¨é€’å½’æš´åŠ›è§£å†³é—®é¢˜æ‰¾åˆ°é€’å½’å…³ç³»é€’å½’ç»ˆæ­¢æ¡ä»¶ä¼˜åŒ–ä½¿ç”¨è®°å¿†åŒ–é€’å½’åŠ¨æ€è§„åˆ’æ ¹æ®å›¾æ€»å…±æœ‰ 8 ä¸ªæ–¹å¼èµ°åˆ°ç¬¬ 5 ä¸ªå°é˜¶å¯ä»¥å¾—åˆ°é€’å½’å…³ç³»climbStairs(i,n) = climbStairs(i+1,n) + climbStairs(i+2,n)å‚æ•°:i: å½“å‰ç¬¬å‡ å±‚å°é˜¶n: æ€»å°é˜¶æ•°ï¼Œä¸ºäº†æä¾›ç»ˆæ­¢é€’å½’æ¡ä»¶123456789101112func climbStairs(_ n: Int) -&gt; Int &#123; func climbStairs_(_ i: Int, _ n: Int) -&gt; Int &#123; if i &gt; n &#123; return 0 &#125;else if i == n &#123; return 1 &#125;else &#123; return climbStairs_(i+1, n) + climbStairs_(i+2, n) &#125; &#125; return climbStairs_(0, n)&#125;ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤šé‡å¤çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€æ¬¡ climbStairs(i,n) è°ƒç”¨æ‰€ä»¥å¯ä»¥ç»™é€’å½’æ·»åŠ ç¼“å­˜12345678910111213141516171819func climbStairs(_ n: Int) -&gt; Int &#123; var memo: [Int?] = Array(repeating: nil, count: n) func climbStairs(_ n: Int, _ memo: inout [Int?]) -&gt; Int &#123; if n &lt;= 2 &#123; return n &#125; let index = n - 1 if memo[index] != nil &#123; return memo[index]! &#125;else &#123; memo[index] = climbStairs(n - 1, &amp;memo) + climbStairs(n - 2, &amp;memo) &#125; return memo[index]! &#125; let res = climbStairs(n, &amp;memo) return res&#125;ä»¥ä¸Šéƒ½æ˜¯è‡ªé¡¶å‘ä¸‹çš„é€ä¸€æ‹†åˆ†å­é—®é¢˜åˆ†å†¶ç®—æ³•dpè¡¨å­˜å‚¨è·¯å¾„12345678910111213141516171819202122232425262728func climbStairs(_ n: Int) -&gt; Int &#123; guard n &gt; 1 else &#123; return n &#125; var dp: [Int] = [0,1,2] var i = 3 while i &lt;= n &#123; dp.append(dp[i-1] + dp[i - 2]) i += 1 &#125; return dp[n]&#125;æ–æ³¢é‚£å¥‘æ•°åˆ—func climbStairs(_ n: Int) -&gt; Int &#123; guard n &gt; 1 else &#123; return n &#125; var first = 1 var second = 2 var i = 3 while i &lt;= n &#123; let third = first + second first = second second = third i += 1 &#125; return second&#125;","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/tags/%E7%AE%97%E6%B3%95/"}],"categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"åŠ¨æ€è§„åˆ’","slug":"ç®—æ³•/åŠ¨æ€è§„åˆ’","permalink":"https://changzw.github.io/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"}]},{"title":"åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„","date":"2018-07-02T04:22:17.000Z","path":"2018/07/02/åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„/","text":"åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„ é¢˜ç›®æè¿°ç»™ä½ ä¸¤ä¸ªæœ‰åºæ•´æ•°æ•°ç»„ nums1 å’Œ nums2ï¼Œè¯·ä½ å°† nums2 åˆå¹¶åˆ° nums1 ä¸­ï¼Œä½¿ nums1 æˆä¸ºä¸€ä¸ªæœ‰åºæ•°ç»„ã€‚12345678910è¯´æ˜:åˆå§‹åŒ– nums1 å’Œ nums2 çš„å…ƒç´ æ•°é‡åˆ†åˆ«ä¸º m å’Œ n ã€‚ä½ å¯ä»¥å‡è®¾ nums1 æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼ˆç©ºé—´å¤§å°å¤§äºæˆ–ç­‰äº m + nï¼‰æ¥ä¿å­˜ nums2 ä¸­çš„å…ƒç´ ã€‚ ç¤ºä¾‹:è¾“å…¥:nums1 = [1,2,3,0,0,0], m = 3nums2 = [2,5,6], n = 3è¾“å‡º: [1,2,2,3,5,6] åˆ†ææœ‰åºæ•°ç»„åˆå¹¶ï¼Œç©ºé—´è¶³å¤Ÿï¼Œé‚£ä¹ˆä¸ä½¿ç”¨ç¼“å­˜å¤„ç†ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ä¸¤ä¸ªæ•°ç»„çš„æœ€åé¢pt1 = m - 1pt2 = n - 1æ•°ç»„é•¿åº¦len = 3 + 3nums1 å½“å‰æŒ‡é’ˆ curr = len - 1å› ä¸º nums1 æ˜¯è¿ç»­çš„ï¼Œnums2 æ”¾åˆ° nums1 é‡Œé¢ï¼Œé‚£ä¹ˆå½“ nums2 éå†å®Œåæ•´ä¸ªéå†å°±ç»“æŸäº†12345678910111213141516func merge(_ nums1: inout [Int], _ m: Int, _ nums2: [Int], _ n: Int) &#123; var cur = m + n - 1 var idx1 = m - 1 var idx2 = n - 1 while idx2 &gt;= 0 &#123; if idx1 &gt;= 0 &amp;&amp; nums1[idx1] &gt; nums2[idx2] &#123; nums1[cur] = nums1[idx1] idx1 -= 1 &#125;else &#123; nums1[cur] = nums2[idx2] idx2 -= 1 &#125; cur -= 1 &#125;&#125;","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/tags/%E7%AE%97%E6%B3%95/"}],"categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/categories/%E7%AE%97%E6%B3%95/"}]},{"title":"æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²","date":"2018-07-02T02:40:51.000Z","path":"2018/07/02/æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²/","text":"æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸² é¢˜ç›®æè¿°ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ æœ€é•¿å­ä¸² çš„é•¿åº¦ã€‚123456789101112131415ç¤ºä¾‹ 1:è¾“å…¥: \"abcabcbb\"è¾“å‡º: 3è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \"abc\"ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ç¤ºä¾‹ 2:è¾“å…¥: \"bbbbb\"è¾“å‡º: 1è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \"b\"ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚ç¤ºä¾‹ 3:è¾“å…¥: \"pwwkew\"è¾“å‡º: 3è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ \"wke\"ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ\"pwke\" æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚ åˆ†æä½¿ç”¨ä»€ä¹ˆæ–¹æ³•å‘¢ï¼Ÿæ¯ä¸ªæ˜¯ä¸æ˜¯éƒ½æ˜¯ ascii ç ï¼Ÿå¦‚æœæ˜¯å°±å°è¯•ä½¿ç”¨asciiåšæ˜ å°„åšæ»‘åŠ¨çª—å£ï¼Œä»å·¦å‘å³æ»‘åŠ¨åŠ¨æ€è§„åˆ’ç¼©å°èŒƒå›´å…ˆä½¿ç”¨æ»‘åŠ¨çª—å£çš„æ–¹æ³•åš æ»‘åŠ¨çª—å£è¦æœ‰å·¦å³æŒ‡é’ˆæŒ‡æ˜çª—å£ä½ç½®ï¼Œå¤§å°å³æŒ‡é’ˆå…ˆè¡Œèµ°åšéå†ï¼Œå·¦æŒ‡é’ˆæ ¹æ®å…·ä½“æ¡ä»¶å‘å³æ»‘åŠ¨å½“å³æŒ‡é’ˆèµ°åˆ°å°½å¤´ï¼Œéå†ç»“æŸé¢˜ç›®åˆ†æï¼š1234567left, right = 0right: 0 -&gt; n left å‘å³ç§»åŠ¨æ¡ä»¶ï¼š s[right]æ˜¯å¦å­˜åœ¨åœ¨çª—å£å­ä¸²ä¸­ left ç§»åŠ¨åˆ°çª—å£å­ä¸²ä¸­å­—ç¬¦ s[right] çš„ä¸‹ä¸€ä¸ªä½ç½® è®°å½•é•¿åº¦lengthè¿”å› max(right - left, length)123456789101112131415161718192021222324func lengthOfLongestSubstring(_ s: String) -&gt; Int &#123; var len = 0 var left = s.startIndex var right = left var window = \"\" while right != s.endIndex &#123; let curChar = s[right] if window.contains(curChar) &#123; let index = window.firstIndex(of: curChar)! let distance = window.distance(from: window.startIndex, to: index) left = s.index(left, offsetBy: distance + 1) &#125; right = s.index(after: right) window = String(s[left..&lt;right]) len = max(len, s.distance(from: left, to: right)) &#125; return len&#125;leetcode ç»“æœ104 ms 21.1 MB Swiftä½¿ç”¨ hashMap ç¼“å­˜window ä»¥åä¼˜åŒ–æ‰§è¡Œæ—¶é—´12345678910111213141516171819func lengthOfLongestSubstring(_ s: String) -&gt; Int &#123; var itemMap: [Character: Int] = [:] var left = 0, right = 0 var len = 0 for e in s &#123; if let idx = itemMap[e] &#123; //1. ä½¿ç”¨max å»æ‰ left ä¹‹å‰çš„å…ƒç´ ï¼Œä¹‹å‰æ˜¯è¿™æ ·ä¼šæœ‰é—®é¢˜left = idx + 1 left = max(idx + 1, left) &#125; itemMap[e] = right len = max(len, right - left + 1) right += 1 &#125; return len&#125;44 ms 21.1 MBå¯¹äºä¸Šé¢æ³¨é‡Šçš„ 1ï¼Œå¦‚æœä½¿ç”¨ left = idx + 1 çš„è¯ eg â€œabbaâ€å½“ curr æŒ‡é’ˆæŒ‡åˆ°ç¬¬äºŒä¸ª b æ—¶ï¼Œleft = 2å½“ curr æŒ‡é’ˆæŒ‡åˆ°ç¬¬äºŒä¸ª a æ—¶ï¼Œleft = 1æˆ‘ä»¬è¦åšçš„æ˜¯å¦‚ä½•æŠŠ itemMap ä¸­ç¬¬äºŒä¸ª b ä¹‹å‰ä¸åœ¨ window çš„å…ƒç´ æ¸…ç©ºæ‰ï¼Ÿå› ä¸ºç»“æœæ˜¯ index ç›¸å…³ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ max å°±å¯ä»¥äº† left = max(idx + 1, left)P.S: ä½¿ç”¨ maxæ–¹æ³•æˆªæ–­æ•°ç»„","tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"æ»‘åŠ¨çª—å£","slug":"æ»‘åŠ¨çª—å£","permalink":"https://changzw.github.io/tags/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/"}],"categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://changzw.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"æ»‘åŠ¨çª—å£","slug":"ç®—æ³•/æ»‘åŠ¨çª—å£","permalink":"https://changzw.github.io/categories/%E7%AE%97%E6%B3%95/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/"}]},{"title":"å…³è”å¯¹è±¡","date":"2018-07-01T14:32:13.000Z","path":"2018/07/01/deep analyse/å…³è”å¯¹è±¡/","text":"å…³è”å¯¹è±¡æ˜¯ä»€ä¹ˆä»–æ˜¯ objective-c runtime æœºåˆ¶ä¸­æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œè®©ç”¨æˆ·åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€çš„ç»™ç±»æ·»åŠ å…³è”å±æ€§ å…³è”å¯¹è±¡çš„ä¸»è¦ä½œç”¨å¼€å‘ä¸­å¦‚ä½•ç»™ category æ·»åŠ æˆå‘˜å±æ€§å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œå¦‚ä½•åœ¨è¿è¡Œæ—¶ç»™ class å…³è”æ–°çš„å±æ€§ï¼Ÿä¸»è¦ä½œç”¨ï¼šç»™category æ·»åŠ æˆå‘˜å˜é‡category åº•å±‚ç»“æ„çš„é™åˆ¶ï¼Œä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡åˆ°åˆ†ç±»ä¸­ã€‚ä½†å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ¥é—´æ¥æ·»åŠ ã€‚åˆ†ç±»ä¸­çš„ @property åªèƒ½å£°æ˜å±æ€§ï¼Œä¸æä¾› _name, getName, setName çš„å®ç°ç±»ä¸­ @property æä¾› _name, getName, setName çš„å®ç° å¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢ å…³è”å¯¹è±¡æ¥å£&lt;objc/runtime.h&gt; ä¸­å®šä¹‰çš„ä»¥ä¸‹ä¸‰ä¸ªå…è®¸ä½ å°†ä»»ä½•é”®å€¼åœ¨è¿è¡Œæ—¶å…³è”åˆ°å¯¹è±¡ä¸Šçš„å‡½æ•°ï¼šobjc_setAssociatedObjectobjc_getAssociatedObjectobjc_removeAssociatedObjects12345678910/*object :è¡¨ç¤ºå…³è”è€…ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå˜é‡åç†æ‰€å½“ç„¶ä¹Ÿæ˜¯objectkey :è·å–è¢«å…³è”è€…çš„ç´¢å¼•keyvalue :è¢«å…³è”è€…policy :å…³è”æ—¶é‡‡ç”¨çš„åè®®ï¼Œæœ‰assignï¼Œretainï¼Œcopyç­‰åè®®ï¼Œä¸€èˆ¬ä½¿ç”¨OBJC_ASSOCIATION_RETAIN_NONATOMIC */id objc_getAssociatedObject(id object, const void *key);void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy);//ç§»é™¤æŸä¸ªå¯¹è±¡èº«ä¸Šçš„æ‰€æœ‰å…³è”çš„å¯¹è±¡ã€‚void objc_removeAssociatedObjects(id object) å®é™…ä½¿ç”¨æ•ˆæœå¯¹æ¯”å­—å…¸å®ç°ç»™åˆ†ç±»æ·»åŠ  property1234@interface Banana (Test)@property (assign, nonatomic) CGFloat weight;@property (copy, nonatomic) NSString *name;@end123456789101112131415161718192021#define Key [NSString stringWithFormat:@\"%p\", self]@implementation Banana (Test)NSMutableDictionary *names_;NSMutableDictionary *weights_;+ (void)load &#123; weights_ = [NSMutableDictionary dictionary]; names_ = [NSMutableDictionary dictionary];&#125;- (void)setName:(NSString *)name &#123; names_[Key] = name;&#125;- (NSString *)name &#123; return names_[Key];&#125;- (void)setWeight:(int)weight &#123; weights_[Key] = @(weight);&#125;- (int)weight &#123; return [weights_[Key] intValue];&#125;@endä¸Šé¢ä½¿ç”¨å…¨å±€å­—å…¸çš„æ–¹å¼ï¼Œç»™åˆ†ç±»ä¸­çš„æˆå‘˜å˜é‡æ·»åŠ getï¼Œset å®ç°ä½“é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢ï¼Ÿå…³è”å¯¹è±¡å®ç°åˆ†ç±»æ·»åŠ æˆå‘˜å±æ€§123456789101112131415@implementation Banana (Test)- (void)setName:(NSString *)name&#123; objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);&#125;- (NSString *)name &#123; // éšå¼å‚æ•°_cmd == @selector(name) return objc_getAssociatedObject(self, _cmd);&#125;- (void)setWeight:(int)weight &#123; objc_setAssociatedObject(self, @selector(weight), @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;- (int)weight &#123; return [objc_getAssociatedObject(self, _cmd) intValue];&#125;@end å…³è”å¯¹è±¡æºç åˆ†æå…³è”å¯¹è±¡ä¹Ÿæ˜¯ç”¨å…¨å±€ hash è¡¨æ¥ä¿å­˜çš„ã€‚objc4-779.1æºç  è¿™ä¸ªæ–‡ä»¶ä¸­ objc-references.mmå…³è”å¯¹è±¡çš„æ ¸å¿ƒç±»AssociationsManagerAssociationsHashMapObjectAssociationMapObjcAssociation12345678910class AssociationsManager &#123; // associative references: object pointer -&gt; PtrPtrHashMap. static AssociationsHashMap *_map;&#125;;class AssociationsHashMap : public unordered_map&lt;disguised_ptr_t, ObjectAssociationMap *, DisguisedPointerHash, DisguisedPointerEqual, AssociationsHashMapAllocator&gt;class ObjectAssociationMap : public std::map&lt;void *, ObjcAssociation, ObjectPointerLess, ObjectAssociationMapAllocator&gt;class ObjcAssociation &#123; uintptr_t _policy; id _value;&#125;; å…³è”å¯¹è±¡ä½•æ—¶é‡Šæ”¾â€¦â€¦ ä¸æƒ³çœ‹äº†ï¼Œæƒ³çœ‹äº†å†è¡¥å……ï¼Œæ€»ä¹‹ä»–åœ¨æ‰€å…³è”çš„å¯¹è±¡é‡Šæ”¾åï¼Œä¼šé‡Šæ”¾çš„ å…³è”æ—¶é‡‡ç”¨çš„åè®®Behavior@property EquivalentDescriptionOBJC_ASSOCIATION_ASSIGN@property (assign) æˆ– @property (unsafe_unretained)æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚OBJC_ASSOCIATION_RETAIN_NONATOMIC@property (nonatomic, strong)æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚OBJC_ASSOCIATION_COPY_NONATOMIC@property (nonatomic, copy)æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚OBJC_ASSOCIATION_RETAIN@property (atomic, strong)æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚OBJC_ASSOCIATION_COPY@property (atomic, copy)æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ å®é™…ä¸­ä½¿ç”¨å…³è”å¯¹è±¡çš„ä¾‹å­ä½¿ç”¨ closures æ·»åŠ  Gesture Recognizers","tags":[{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"__weak å®ç°åˆ†æ","date":"2018-06-01T03:58:04.000Z","path":"2018/06/01/weak-å®ç°åˆ†æ/","text":"å‰è¨€runtime ç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼škeyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€valueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡æŒ‡é’ˆçš„åœ°å€ï¼‰æ•°ç»„ weak æºç åˆ†æåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€__weakå˜é‡çš„å­˜å‚¨12NSObject *obj = [[NSObject alloc] init];id __weak obj1 = obj;1234/* ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç  */id obj1;objc_initWeak(&amp;obj1, obj);objc_destroyWeak(&amp;obj1);123456789101112131415161718192021222324252627/** * Initialize a fresh weak pointer to some object location. * It would be used for code like: * * (The nil case) * __weak id weakPtr; * (The non-nil case) * NSObject *o = ...; * __weak id weakPtr = o; * * This function IS NOT thread-safe with respect to concurrent * modifications to the weak variable. (Concurrent weak clear is safe.) * * @param location Address of __weak ptr. * @param newObj Object ptr. */enum HaveOld &#123; DontHaveOld = false, DoHaveOld = true &#125;;enum HaveNew &#123; DontHaveNew = false, DoHaveNew = true &#125;;id objc_initWeak(id *location, id newObj)&#123; if (!newObj) &#123; *location = nil; return nil; &#125; return storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object*)newObj);&#125;12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879template &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;static id storeWeak(id *location, objc_object *newObj) &#123; Class previouslyInitializedClass = nil; id oldObj; SideTable *oldTable; SideTable *newTable; // Acquire locks for old and new values. // Order by lock address to prevent lock ordering problems. // Retry if the old value changes underneath us. retry: if (haveOld) &#123; oldObj = *location; oldTable = &amp;SideTables()[oldObj]; &#125; else &#123; oldTable = nil; &#125; if (haveNew) &#123; newTable = &amp;SideTables()[newObj]; &#125; else &#123; newTable = nil; &#125; SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); if (haveOld &amp;&amp; *location != oldObj) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); goto retry; &#125; // Prevent a deadlock between the weak reference machinery // and the +initialize machinery by ensuring that no // weakly-referenced object has an un-+initialized isa. if (haveNew &amp;&amp; newObj) &#123; Class cls = newObj-&gt;getIsa(); if (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) &#123; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); class_initialize(cls, (id)newObj); // If this class is finished with +initialize then we're good. // If this class is still running +initialize on this thread // (i.e. +initialize called storeWeak on an instance of itself) // then we may proceed but it will appear initializing and // not yet initialized to the check above. // Instead set previouslyInitializedClass to recognize it on retry. previouslyInitializedClass = cls; goto retry; &#125; &#125; // Clean up old value, if any. if (haveOld) &#123; weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location); &#125; // Assign new value, if any. if (haveNew) &#123; newObj = (objc_object *) weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating); // weak_register_no_lock returns nil if weak store should be rejected // Set is-weakly-referenced bit in refcount table. if (newObj &amp;&amp; !newObj-&gt;isTaggedPointer()) &#123; newObj-&gt;setWeaklyReferenced_nolock(); &#125; // Do not set *location anywhere else. That would introduce a race. *location = (id)newObj; &#125; else &#123; // No new value. The storage is not changed. &#125; SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); return (id)newObj;&#125; SideTable123456789struct SideTable &#123; // è‡ªæ—‹é”ï¼Œç”¨äºå¯¹SideTableæ“ä½œæ—¶è¿›è¡ŒåŠ é” spinlock_t slock; // å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•° RefcountMap refcnts; // å­˜å‚¨å¯¹è±¡çš„å¼±å¼•ç”¨ weak_table_t weak_table; ...&#125;ä» SideTables æ˜¯ä¸€ä¸ª StripedMap123static StripedMap&lt;SideTable&gt;&amp; SideTables() &#123; return *reinterpret_cast&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);&#125;12345678910111213141516171819202122template&lt;typename T&gt;class StripedMap &#123; // å®šä¹‰æ•£åˆ—è¡¨çš„å¤§å°#if TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR enum &#123; StripeCount = 8 &#125;;#else enum &#123; StripeCount = 64 &#125;;#endif struct PaddedT &#123; T value alignas(CacheLineSize); &#125;; PaddedT array[StripeCount]; // æ•£åˆ—å‡½æ•°ï¼šé€šè¿‡æŒ‡é’ˆåœ°å€è®¡ç®—å‡ºindex static unsigned int indexForPointer(const void *p) &#123; uintptr_t addr = reinterpret_cast&lt;uintptr_t&gt;(p); return ((addr &gt;&gt; 4) ^ (addr &gt;&gt; 9)) % StripeCount; &#125; ...&#125;åœ¨å‘ç”Ÿæ•£åˆ—å†²çªçš„æ—¶å€™ï¼Œå¤šä¸ªå¯¹è±¡ä¼šå…±ç”¨ä¸€ä¸ªSideTableï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå¯¹è±¡ä¼šå…±ç”¨ä¸€ä¸ªrefcntså’Œweak_tableã€‚weak_table_t12345678910struct weak_table_t &#123; // å­˜å‚¨weak_entry_t weak_entry_t *weak_entries; // å½“å‰weak_entry_tçš„ä¸ªæ•° size_t num_entries; // å½“å‰æ•°ç»„èƒ½å¤Ÿå®¹çº³çš„æœ€å¤§ä¸ªæ•° uintptr_t mask; // å‘ç”Ÿæ•£åˆ—å†²çªæ—¶ï¼Œèƒ½å¤Ÿéå†çš„å…ƒç´ çš„æœ€å¤§ä¸ªæ•° uintptr_t max_hash_displacement;&#125;;","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"autoreleasepool å®ç°åˆ†æ","date":"2018-05-31T08:20:55.000Z","path":"2018/05/31/autoreleasepool-å®ç°åˆ†æ/","text":"AutoRelease å†…éƒ¨ç»“æ„AutoReleasePool æ˜¯åˆ©ç”¨è¯­è¨€ä¸Šçš„ç‰¹æ€§ï¼Œç¨‹åºå†…å­˜è‡ªåŠ¨å›æ”¶é—®é¢˜çš„12345int main(int argc, char * argv[]) &#123; @autoreleasepool &#123; return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); &#125;&#125;@autoreleasepool æ˜¯ä»€ä¹ˆï¼Ÿåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ clang -rewrite-objc main.m è®©ç¼–è¯‘å™¨é‡æ–°æ”¹å†™è¿™ä¸ªæ–‡ä»¶ï¼š123456789struct __AtAutoreleasePool &#123; void * atautoreleasepoolobj; __AtAutoreleasePool() &#123; // æ„é€ å‡½æ•° atautoreleasepoolobj = objc_autoreleasePoolPush(); &#125; ~__AtAutoreleasePool() &#123;// ææ„å‡½æ•° objc_autoreleasePoolPop(atautoreleasepoolobj); &#125;&#125;;12345678int main(int argc, const char * argv[]) &#123; &#123; void * atautoreleasepoolobj = objc_autoreleasePoolPush(); // do whatever you want objc_autoreleasePoolPop(atautoreleasepoolobj); &#125; return 0;&#125;æ²¡æœ‰ AutoreleasePool ç›¸å…³çš„ç±»ï¼Œè€Œåœ¨ objc æºç ä¸­æœ objc_autoreleasePoolPush1234567void * objc_autoreleasePoolPush(void) &#123; return AutoreleasePoolPage::push();&#125;void objc_autoreleasePoolPop(void *ctxt) &#123; AutoreleasePoolPage::pop(ctxt);&#125; AutoreleasePage ç»“æ„AutoreleasePage æ˜¯å®ç° AutoreleasePool çš„ä¸»è¦ç±»12345678910111213141516171819202122class AutoreleasePoolPage &#123; static pthread_key_t const key = AUTORELEASE_POOL_KEY; static uint8_t const SCRIBBLE = 0xA3; // 0xA3A3A3A3 after releasing static size_t const SIZE =#if PROTECT_AUTORELEASEPOOL PAGE_MAX_SIZE; // must be multiple of vm page size#else PAGE_MAX_SIZE; // size and alignment, power of 2#endif static size_t const COUNT = SIZE / sizeof(id);//ä¸€ä¸ªpageé‡Œè¦ç®¡ç†é‡Šæ”¾å¯¹è±¡çš„ä¸ªæ•°#define EMPTY_POOL_PLACEHOLDER ((id*)1) // ç©ºæ± å ä½ #define POOL_BOUNDARY nil // é‡Šæ”¾æ± è¾¹ç•Œ magic_t const magic; // ç”¨æ¥æ ¡éªŒ AutoreleasePoolPage çš„ç»“æ„æ˜¯å¦å®Œæ•´ id *next; // å­˜å‚¨è¦ç”¨ AutoRelease é‡Šæ”¾çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘ begin() pthread_t const thread; // æ‰€å± thread AutoreleasePoolPage * const parent; // æŒ‡å‘çˆ¶ç»“ç‚¹ï¼Œç¬¬ä¸€ä¸ªç»“ç‚¹çš„ parent å€¼ä¸º nil AutoreleasePoolPage *child; // æŒ‡å‘å­ç»“ç‚¹ï¼Œæœ€åä¸€ä¸ªç»“ç‚¹çš„ child å€¼ä¸º nil uint32_t const depth; // ä»£è¡¨æ·±åº¦ï¼Œä» 0 å¼€å§‹ï¼Œå¾€åé€’å¢ 1 uint32_t hiwat; // (high water mark)æ•°æ®å®¹çº³çš„ä¸€ä¸ªä¸Šé™&#125;POOL_BOUNDARY æ˜¯ä¸€ä¸ªè¾¹ç•Œå¯¹è±¡ nil,ä¹‹å‰çš„æºä»£ç å˜é‡åæ˜¯ POOL_SENTINELå“¨å…µå¯¹è±¡,ç”¨æ¥åŒºåˆ«æ¯ä¸ªpageå³æ¯ä¸ª AutoreleasePoolPage è¾¹ç•Œ AutoreleasePage åŸç†åˆ†æä»¥ä¸ŠçŸ¥é“ AutoreleasePage çš„ç»“æ„ï¼Œæ ¹æ®åˆ†æè¿‡ç¨‹ï¼Œæ€è€ƒä¸ºä½•å¦‚æ­¤è®¾è®¡ Page::pushä¸€å¼€å§‹è°ƒç”¨çš„å°±æ˜¯ AutoreleasePage::push()12345678910111213141516static inline void *push() &#123; id *dest; dest = autoreleaseFast(POOL_BOUNDARY); // POOL_BOUNDARY æ˜¯ nilçš„å®å®šä¹‰ return dest;&#125;static inline id *autoreleaseFast(id obj)&#123; AutoreleasePoolPage *page = hotPage(); if (page &amp;&amp; !page-&gt;full()) &#123; return page-&gt;add(obj); &#125; else if (page) &#123; return autoreleaseFullPage(obj, page); &#125; else &#123; return autoreleaseNoPage(obj); &#125;&#125;autoreleaseFast æ’å…¥æ–° oc å¯¹è±¡å…ƒç´ çš„æ—¶å€™åˆ†ä¸‰ç§æƒ…å†µéœ€è¦å¤„ç†ï¼špageæœªæ»¡ï¼Œç›´æ¥æ’å…¥åˆ°å½“å‰pagepageå·²æ»¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°pageå¹¶æ’å…¥pageä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°pageå¹¶æ’å…¥æœ€ç»ˆéƒ½ä¼šé€šè¿‡ add æ–¹æ³•æŠŠå½“å‰éœ€è¦èƒŒ AutoRelease çš„å¯¹è±¡æ”¾åˆ° page ä¸­ï¼Œnext++12345678id *add(id obj)&#123; assert(!full()); unprotect(); id *ret = next; *next++ = obj; protect(); return ret;&#125;hotPage æ˜¯å½“å‰ä½¿ç”¨çš„é¡µå¯¹äºautoreleasePool å¤šå±‚åµŒå¥—é—®é¢˜ï¼Œæ¯ä¸€æ¬¡push é¦–å…ˆæ’å…¥ POOL_BOUNDARY ä½œä¸ºå“¨å…µï¼Œç„¶åæ¥ç€ hotPage ä¸­çš„ next æŒ‡é’ˆä¸€ä¸ªä¸ªæ·»åŠ å¯¹è±¡ Page::pop(ctxt)12345678910111213141516171819202122232425static inline void pop(void *token) &#123; AutoreleasePoolPage *page; id *stop; if (token == (void*)EMPTY_POOL_PLACEHOLDER) &#123; if (hotPage()) &#123; pop(coldPage()-&gt;begin()); &#125; else &#123; setHotPage(nil); &#125; return; &#125; page = pageForPointer(token); stop = (id *)token; page-&gt;releaseUntil(stop); // memory: delete empty children if (page-&gt;lessThanHalfFull()) &#123; page-&gt;child-&gt;kill(); &#125;else if (page-&gt;child-&gt;child) &#123; page-&gt;child-&gt;child-&gt;kill(); &#125;&#125;token : popåˆ°å‚æ•°å…ƒç´ æ‰€åœ¨çš„åœ°å€,æ•´ä½“è¿‡ç¨‹åˆ¤æ–­æ˜¯ä¸æ˜¯EMPTY_POOL_PLACEHOLDERï¼ˆEMPTY_POOL_PLACEHOLDERæ˜¯å­˜å‚¨åœ¨TLSä¸­çš„ç”¨æ¥è¡¨ç¤ºé“¾è¡¨æœ€ä¸Šå±‚æ²¡æœ‰å…ƒç´ çš„pool,è¿™æ ·å°±ä¸ç”¨åˆ›å»ºpoolå¯ä»¥èŠ‚çº¦å†…å­˜ã€‚TLSæ˜¯ä»€ä¹ˆä»¥åŠå…·ä½“å®ç°è¿™ç¯‡[æ–‡ç« ](https://blog.csdn.net/cywosp/article/details/26469435)ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†ï¼‰å¦‚æœå½“å‰ poolé‡Œé¢æœ‰æ•°æ®ï¼Œå°±æŠŠé‡Œé¢çš„æ•°æ®æ¸…ç©ºï¼›å¦è€…å°±æŠŠhotPageè®¾ç½®ä¸ºnilã€‚æ¥ç€è°ƒç”¨page-&gt;releaseUntil(stop)ç»™æ­¤å‚æ•°ä¹‹å‰çš„æ‰€æœ‰å¯¹è±¡å‘é€releaseé‡Šæ”¾å†…å­˜ï¼Œå¯¹è±¡å†…å­˜é‡Šæ”¾ä¹‹åç»ˆç‚¹pageä¹‹å‰çš„pageéƒ½ä¼šå˜æˆç©ºçš„æœ€åè°ƒç”¨page-&gt;child-&gt;kill()å›æ”¶è¿™äº›ç©ºpageèµ„æºã€‚ å¦‚ä½•ä½¿ç”¨ AutoReleasePoolå‘¢å®˜ç½‘æ–‡æ¡£ä½¿ç”¨ Cocoa æ¡†æ¶ åˆ›å»ºçš„ thread éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„ autorelease pool. å¦‚æœä½ ç”¨å…¶ä»–æ–¹å¼è‡ªå·±åˆ›å»ºçš„ thread éœ€è¦æ·»åŠ  autorelease pool.å¦‚æœä½ çš„ thread å¸¸é©»çš„ï¼Œä¼šäº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œé‚£å°±éœ€è¦ä½¿ç”¨ autorelease pool (like AppKit and UIKit do on the main thread)ä½¿ç”¨å®¹å™¨çš„blockç‰ˆæœ¬çš„æšä¸¾å™¨æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªAutoreleasePoolï¼š123[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) &#123; // è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€&#125;]; ä¸»çº¿ç¨‹çš„ AutoReleasePoolAppå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚å½“ç„¶ï¼Œåœ¨æ™®é€šforå¾ªç¯å’Œfor inå¾ªç¯ä¸­æ²¡æœ‰ï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯æ–°ç‰ˆçš„blockç‰ˆæœ¬æšä¸¾å™¨æ›´åŠ æ–¹ä¾¿ã€‚forå¾ªç¯ä¸­éå†äº§ç”Ÿå¤§é‡autoreleaseå˜é‡æ—¶ï¼Œå°±éœ€è¦æ‰‹åŠ å±€éƒ¨AutoreleasePoolå’¯ã€‚ å­çº¿ç¨‹ AutoReleasePoolå­çº¿ç¨‹é»˜è®¤ä¸ä¼šå¼€å¯ Runloopï¼Œé‚£å‡ºç° Autorelease å¯¹è±¡å¦‚ä½•å¤„ç†ï¼Ÿä¸æ‰‹åŠ¨å¤„ç†ä¼šå†…å­˜æ³„æ¼å—ï¼Ÿå¦‚æœåˆ›å»ºäº† pool äº§ç”Ÿçš„å¯¹è±¡ç”± pool ç®¡ç†å¦‚æœæ²¡æœ‰åˆ›å»º pool äº§ç”Ÿäº† AutoRelease å¯¹è±¡ï¼Œå°±ä¼šè°ƒç”¨ autoreleaseNoPage æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºä¸€ä¸ª hotpageï¼Œå¹¶è°ƒç”¨ page-&gt;add(obj)å°†å¯¹è±¡æ·»åŠ åˆ° AutoreleasePoolPage çš„æ ˆä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¸è¿›è¡Œæ‰‹åŠ¨çš„å†…å­˜ç®¡ç†ï¼Œä¹Ÿä¸ä¼šå†…å­˜æ³„æ¼Autoreleaseå¯¹è±¡æ˜¯åœ¨å½“å‰çš„runloopè¿­ä»£ç»“æŸæ—¶é‡Šæ”¾çš„ï¼Œè€Œå®ƒèƒ½å¤Ÿé‡Šæ”¾çš„åŸå› æ˜¯ç³»ç»Ÿåœ¨æ¯ä¸ªrunloopè¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± Pushå’ŒPop ä»€ä¹ˆå¯¹è±¡è‡ªåŠ¨åŠ å…¥åˆ° autoreleasepoolä¸­é»‘å¹•èƒŒåçš„Autoreleaseæ·±å…¥ç†è§£RunLoopdoes NSThread create autoreleasepool automatically nowé»‘å¹•èƒŒåçš„Autorelease","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"obj","slug":"obj","permalink":"https://changzw.github.io/tags/obj/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"}]},{"title":"swift åºåˆ—åŒ–Codable","date":"2018-05-10T02:10:46.000Z","path":"2018/05/10/swift è¯­æ³•/swift-åºåˆ—åŒ–Codable/","text":"å‰è¨€åºåˆ—åŒ–æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯è½¬æ¢ä¸ºå¯ä»¥å­˜å‚¨æˆ–ä¼ è¾“çš„å½¢å¼çš„è¿‡ç¨‹(å¯¹è±¡&lt;â€“&gt;I/Oæµ)ã€‚å¯¹è±¡ä¿¡æ¯åºåˆ—åŒ–ä»¥åå˜æˆ I/O æµï¼šå¯ä»¥æœ¬åœ°åŒ–å­˜å‚¨ï¼ˆæŒä¹…åŒ–å¯¹è±¡ï¼‰ç½‘ç»œé€šè®¯ï¼ˆç½‘ç»œä¼ è¾“å¯¹è±¡ï¼‰å®šåˆ¶åè®®ï¼Œè·¨å¹³å°ã€è·¨è¯­è¨€é€šè®¯ Swift ä¸­çš„åºåˆ—åŒ–Swift 4.0 ä¹‹å‰ä»éœ€è¦æ‰‹åŠ¨è§£æSwift 4.0 ä»¥åï¼Œæä¾› Codable åè®®ä»ç„¶å­˜åœ¨é—®é¢˜ æ²¡æœ‰Encoderå’ŒDecoder1234567891011121314151617181920212223let json: [String : Any] = [ \"name\": \"cap\", \"points\": 1, \"description\": \"this is a cat\",]struct Product &#123; var name: String var points: Int var description: String? // éœ€è¦æ‰‹åŠ¨è§£æ init?(json: [String: Any]) &#123; guard let name = json[\"name\"] as? String, let points = json[\"points\"] as? Int, let description = json[\"description\"] as? String else &#123; return nil &#125; self.name = name self.points = points self.description = description &#125;&#125;if let p = Product(json: json) &#123; print(p.name + \" \\(p.points) \" + p.description!)&#125; ä½¿ç”¨ç¼–ç å™¨ï¼Œç±»å‹éµå¾ª Codable(Encodable &amp; Decodable) åè®®ç±»å‹éµå¾ªCodableEncodeDecode2017å¹´6æœˆå‘å¸ƒçš„ Swift4.0 ä¸­çš„ Codable(Encodable &amp; Decodable) åè®®ï¼Œè¡¨æ˜è¯¥åè®®å…·æœ‰è¢«åºåˆ—åŒ–å’Œ/æˆ–ååºåˆ—åŒ–çš„èƒ½â¼’ã€‚Swift æ ‡å‡†åº“ä¸­çš„æ‰€æœ‰åŸºæœ¬ç±»å‹éƒ½éµå¾ª Codable åè®®ï¼ŒDataï¼ŒDateï¼Œ URLï¼ŒCGPoint å’Œ CGRect åœ¨å†…çš„è®¸å¤š Apple æ¡†æ¶ä¸­çš„å¸¸â½¤æ•°æ®ç±»å‹ï¼Œä¹Ÿå·²ç»é€‚é…äº† Codableã€‚è‡ªå®šä¹‰ç±»å‹éœ€è¦ç”¨æˆ·éµå¾ª Codableåè®®ã€‚12345678910public typealias Codable = Decodable &amp; Encodable/// æŸä¸ªç±»å‹å¯ä»¥å°†â¾ƒèº«ç¼–ç ä¸ºâ¼€ç§å¤–éƒ¨è¡¨ç¤ºpublic protocol Encodable &#123; /// å°†å€¼ç¼–ç åˆ°ç»™å®šçš„ encoder ä¸­ public func encode(to encoder: Encoder) throws&#125;/// æŸä¸ªç±»å‹å¯ä»¥ä»å¤–éƒ¨è¡¨ç¤ºä¸­è§£ç å¾—åˆ°â¾ƒèº«public protocol Decodable &#123; /// é€šè¿‡ä»ç»™å®šçš„ decoder ä¸­è§£ç æ¥åˆ›å»ºæ–°çš„å®ä¾‹ public init(from decoder: Decoder) throws&#125;â¼€æ—¦ä½ æ‹¥æœ‰ codable ç±»å‹çš„å€¼ï¼Œä½ å¯ä»¥åˆ›å»ºâ¼€ä¸ªç¼–ç å™¨ï¼Œå¹¶è®©å®ƒå°†è¿™ä¸ªå€¼è½¬æ¢åˆ°åƒæ˜¯ JSON è¿™æ ·çš„åºåˆ—åŒ–æ ¼å¼ã€‚åè¿‡æ¥ï¼Œâ¼€ä¸ªè§£ç å™¨å¯ä»¥å°†åºåˆ—åŒ–åçš„æ•°æ®è½¬å›ä¸ºå®ƒåŸæ¥ç±»å‹çš„â¼€ä¸ªå®ä¾‹ã€‚Swift â¾ƒå¸¦ä¸¤å¥—ç¼–ç è§£ç å™¨ï¼ŒJSONEncoder/JSONDecoder å’Œ PropertyListEncoder/PropertyListDecoderï¼Œå®ƒä»¬å­˜åœ¨äº Foundation ä¸­ã€‚ JSONEncoder/JSONDecoder ä¸éœ€è¦æ‰‹åŠ¨è§£ç å±æ€§å = keyï¼Œå±æ€§ç±»å‹ = value ç±»å‹ä¸€è‡´ï¼Œä½¿ç”¨ decoder å¯¹jsonè§£ç ï¼Œä¸éœ€è¦æ‰‹åŠ¨è§£ç äº†123456789101112131415161718192021222324252627282930313233343536373839let json = \"\"\"[ &#123; \"name\": \"Banana\", \"points\": 200, \"description\": \"A banana grown in Ecuador.\" &#125;, &#123; \"name\": \"Orange\", \"points\": 100 &#125;]\"\"\".data(using: .utf8)!struct GroceryProduct: Codable &#123; var name: String var points: Int var description: String?&#125;// è§£ç let decoder = JSONDecoder()let products = try decoder.decode([GroceryProduct].self, from: json)print(\"The following products are available:\")for product in products &#123; print(\"\\t\\(product.name) (\\(product.points) points)\") if let description = product.description &#123; print(\"\\t\\t\\(description)\") &#125;&#125;// ä¸ä¸Šæ–‡æ— å…³ï¼Œåªæè¿°ä¸‹ç¼–ç è¿‡ç¨‹let jsonEncoder = JSONEncoder()let jsonData = try? jsonEncoder.encode(products)let str = String(decoding: jsonData!, as: UTF8.self)print(str)let jsonObject = try JSONSerialization.jsonObject(with: jsonData!, options: .allowFragments)print(jsonObject)GroceryProduct ç±»ä¸­å±æ€§éƒ½éµå¾ª Codable åè®®ï¼ŒArrayä¹Ÿæ˜¯ï¼Œæ‰€ä»¥ä¸éœ€è¦å®ç° encode(to encoder: Encoder) å’Œ init(from decoder: Decoder) æ–¹æ³• éœ€è¦æ‰‹åŠ¨è§£ç  jsonä¸­çš„keyå€¼ä¸å±æ€§åç§°ä¸ä¸€è‡´ä½†æ˜¯è¿™ä¸ªç±»å‹å®é™…ä¸Šå¹¶ä¸â¼€å®šéœ€è¦æ˜¯æš ä¸¾)ã€‚æä¾›â¾ƒå®šä¹‰çš„ç¼–ç é”®æ˜¯â¼€ç§å¾ˆç®€å•ï¼Œâ½½ä¸”æ˜¯å£°æ˜å¼çš„æ”¹å˜ç±»å‹ç¼–ç çš„â½…å¼ã€‚åœ¨æšä¸¾ä¸­ï¼Œæˆ‘ ä»¬å¯ä»¥ï¼šâ†’ ä½¿â½¤æ˜ç¡®ç»™å®šçš„å­—ç¬¦ä¸²å€¼ï¼Œåœ¨ç¼–ç åçš„è¾“å‡ºä¸­é‡å‘½åå­—æ®µï¼Œæˆ–è€…â†’ å°†æŸä¸ªé”®ä»æšä¸¾ä¸­ç§»é™¤ï¼Œä»¥æ­¤å®Œå…¨è·³è¿‡å­—æ®µã€‚12345678910111213141516171819202122232425262728293031323334353637let json = \"\"\"[ &#123; \"product_name\": \"Bananas\", \"product_cost\": 200, \"description\": \"A banana grown in Ecuador.\" &#125;, &#123; \"product_name\": \"Oranges\", \"product_cost\": 100, \"description\": \"A juicy orange.\" &#125;]\"\"\".data(using: .utf8)!struct GroceryProduct: Codable &#123; var name: String var points: Int var description: String? private enum CodingKeys: String, CodingKey &#123; case name = \"product_name\" case points = \"product_cost\" case description &#125;&#125;let decoder = JSONDecoder()let products = try decoder.decode([GroceryProduct].self, from: json)print(\"The following products are available:\")for product in products &#123; print(\"\\t\\(product.name) (\\(product.points) points)\") if let description = product.description &#123; print(\"\\t\\t\\(description)\") &#125;&#125; ç±»å‹åµŒå¥—","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"}],"categories":[{"name":"å¼€å‘è¯­è¨€","slug":"å¼€å‘è¯­è¨€","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"},{"name":"swift","slug":"å¼€å‘è¯­è¨€/swift","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/swift/"}]},{"title":"Texture å¸ƒå±€","date":"2018-04-11T03:10:14.000Z","path":"2018/04/11/Texture-å¸ƒå±€/","text":"Texture ç›®æ ‡&amp;ä¼˜ç‚¹Texture çš„ Layout APIæ˜¯ UIKit AutoLayout çš„é«˜æ•ˆæ›¿ä»£å“Fastï¼šè‡ªåŠ¨å¸ƒå±€æ¯” AutoLayout å¿«çš„å¤šAsynchronous &amp; Concurrent: Layout åœ¨åå°è®¡ç®—ï¼Œæ‰€ä»¥ç”¨æˆ·äº¤äº’ä¸ä¼šè¢«ç»ˆç«¯Declarativeï¼šå¸ƒå±€ç”¨ä¸å¯å˜çš„æ•°æ®ç»“æ„å£°æ˜ã€‚è¿™ä½¿å¸ƒå±€ä»£ç æ›´æ˜“äºå¼€å‘ï¼Œæ–‡æ¡£ç¼–åˆ¶ï¼Œä»£ç å®¡æŸ¥ï¼Œæµ‹è¯•ï¼Œè°ƒè¯•ï¼Œé…ç½®æ–‡ä»¶å’Œç»´æŠ¤ã€‚Cacheableï¼šå¸ƒå±€ç»“æœæ˜¯ä¸å¯å˜çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤å¯ä»¥åœ¨åå°å¯¹å…¶è¿›è¡Œé¢„å…ˆè®¡ç®—å¹¶è¿›è¡Œç¼“å­˜ä»¥æé«˜ç”¨æˆ·çš„æ„ŸçŸ¥æ€§èƒ½ã€‚Extensibleï¼šæ˜“äºåœ¨ç±»ä¹‹é—´å…±äº«ä»£ç ã€‚å— CSS Flexbox æ¨¡å‹å¯å‘flexbox model åŸºæœ¬æ¦‚å¿µTexture å¸ƒå±€ç³»ç»Ÿçš„ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šLayout SpecsLayout Elements Layout Specsclass ASLayoutSpecå¸ƒå±€è§„èŒƒï¼ˆlayout specificationï¼‰é€šè¿‡äº†è§£è¿™äº›å­å¸ƒå±€å…ƒç´ ä¹‹é—´çš„ç›¸äº’å…³ç³»å¸ƒå±€å…ƒç´ ï¼Œæ˜¯å¸ƒå±€å…ƒç´ çš„å®¹å™¨ã€‚ Layout Elementsprotocol &lt;ASLayoutElement&gt;Layout Specs åŒ…å«å¹¶æ’åˆ— Layout Elementsæ‰€æœ‰ ASDisplayNodes &amp; ASLayoutSpecs éƒ½éµå¾ªåè®®123456-----------------------ASStackLayoutSpec----------------------| -----ASStackLayoutSpec----- -----ASStackLayoutSpec----- || | ASImageNode | | ASImageNode | || | ASImageNode | | ASImageNode | || --------------------------- --------------------------- |-------------------------------------------------------------- Layout Specs å­ç±»ASWrapperLayoutSpecASStackLayoutSpecASInsetLayoutSpecASOverlayLayoutSpecASBackgroundLayoutSpecASCenterLayoutSpecASRatioLayoutSpecASRelativeLayoutSpecASAbsoluteLayoutSpecASCornerLayoutSpec ASWrapperLayoutSpecå®ƒå¯ä»¥åŒ…è£¹ä¸€ä¸ª ASLayoutElement ï¼Œé€šè¿‡è¿™ä¸ª element çš„siez set è®¡ç®—è¿™ä¸ª element çš„layoutã€‚ç”¨äºï¼šASWrapperLayoutSpec å¯¹äºåœ¨ -layoutSpecThatFits: ä¸­åŒ…è£¹å•ä¸ª nodeï¼Œè¿”å›spec.1234567891011// return a single subnode from layoutSpecThatFits:override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; return ASWrapperLayoutSpec(layoutElement: _subnode)&#125;// set a size (but not position)override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; _subnode.style.preferredSize = CGSize(width: constrainedSize.max.width, height: constrainedSize.max.height / 2.0) return ASWrapperLayoutSpec(layoutElement: _subnode)&#125; ASInsetLayoutSpecç»™ element æ·»åŠ  inset marginã€‚element å¿…é¡»æœ‰ instrinsic size or æ˜¾ç¤ºè®¾ç½®çš„size123456override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; ... let insets = UIEdgeInsets(top: 10.0, left: 10.0, bottom: 10.0, right: 10.0) let headerWithInset = ASInsetLayoutSpec(insets: insets, child: textNode) return headerWithInset&#125; ASOverlayLayoutSpecé‡å å¸ƒå±€è§„èŒƒå°ºå¯¸æ˜¯æ ¹æ® element çš„å°ºå¯¸è®¡ç®—å¾—å‡ºçš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œelement æ˜¯è“è‰²å±‚é‡å å¸ƒå±€è§„èŒƒå°ºå¯¸æ˜¯æ ¹æ®åŒ…è£¹ element çš„å°ºå¯¸è®¡ç®—å‡ºæ¥çš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œå­å…ƒç´ æ˜¯è“è‰²å›¾å±‚ã€‚è“è‰² element ä¼šæŠŠä»–çš„ size ä½œä¸º constrainedSize ä¼ ç»™é‡å å¸ƒå±€å…ƒç´ ï¼ˆçº¢è‰²å›¾å±‚ï¼‰ã€‚æ‰€ä»¥ element ï¼ˆè“è‰²layerï¼‰å¿…é¡»è¦æœ‰è‡ªå·±çš„ intrinsic size æˆ–è€… å·²ç»è®¾ç½® sizeäº†ã€‚12345override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec&#123; let backgroundNode = ASDisplayNodeWithBackgroundColor(UIColor.blue) let foregroundNode = ASDisplayNodeWithBackgroundColor(UIColor.red) return ASOverlayLayoutSpec(child: backgroundNode, overlay: foregroundNode)&#125; ASBackgroundLayoutSpecASBackgroundLayoutSpec å¸ƒå±€ä¸€ä¸ªç»„ä»¶ï¼ˆè“è‰²ï¼‰ï¼Œå¹¶æ‹‰ä¼¸å…¶åçš„å¦ä¸€ä¸ªç»„ä»¶ä½œä¸ºèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰ã€‚background è§„èŒƒ sizeæ ¹æ® child çš„å°ºå¯¸è®¡ç®—ã€‚ä¸‹å›¾ä¸­ï¼Œè“è‰²æ˜¯childã€‚å°† blue child çš„size å½“åš constrainedSize ä¼ ç»™ background layout element (red layer). so child(blue layer) ä¸€å®šè¦æœ‰è‡ªå·±çš„intrinsic size æˆ–è€… å·²ç»è®¾ç½® sizeäº†ã€‚123456override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; let backgroundNode = ASDisplayNodeWithBackgroundColor(UIColor.red) let foregroundNode = ASDisplayNodeWithBackgroundColor(UIColor.blue) return ASBackgroundLayoutSpec(child: foregroundNode, background: backgroundNode)&#125; ASCenterLayoutSpecASCenterLayoutSpec åœ¨æœ€å¤§ constrainedSize å°†æ”¾åœ¨ child ä¸­å¿ƒä½ç½®ã€‚å¦‚æœcenter specâ€™s width å’Œ height æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆ ASCenterLayoutSpec ç¼©åˆ° child çš„sizeå¤§å°ã€‚ASCenterLayoutSpec ä¸¤ä¸ªå±æ€§:centeringOptions. ç¡®å®š child å¦‚ä½•åœ¨ä¸­å¿ƒè§„æ ¼å†…å±…ä¸­ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šNone, X, Y, XY.sizingOptions. ç¡®å®šä¸­å¿ƒè§„æ ¼å°†å ç”¨å¤šå°‘ç©ºé—´ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šDefault, minimum X, minimum Y, minimum XY.12345override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; let subnode = ASDisplayNodeWithBackgroundColor(UIColor.green, CGSize(width: 60.0, height: 100.0)) let centerSpec = ASCenterLayoutSpec(centeringOptions: .XY, sizingOptions: [], child: subnode) return centerSpec&#125; ASRatioLayoutSpecASRatioLayoutSpec ä½¿ç”¨å›ºå®šå®½é«˜æ¯”æ¥å¸ƒå±€ç»„ä»¶ã€‚ASRatioLayoutSpec ä»–çš„ constrainedSize å¿…é¡»è¦é…ç½® width or heightã€‚è¿™æ ·æ‰èƒ½å¤Ÿä½¿ç”¨ scaleASRatioLayoutSpec ç»å¸¸ç”¨äºé‚£äº›æ²¡æœ‰ intrinsic size çš„nodeï¼ˆASNetworkImageNode or ASVideoNodeï¼‰ã€‚123456override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; // Half Ratio let subnode = ASDisplayNodeWithBackgroundColor(UIColor.green, CGSize(width: 100, height: 100.0)) let ratioSpec = ASRatioLayoutSpec(ratio: 0.5, child: subnode) return ratioSpec&#125; ASRelativeLayoutSpecå¹¶æ ¹æ®å‚ç›´å’Œæ°´å¹³ä½ç½®è¯´æ˜ç¬¦å¯¹ç»„ä»¶è¿›è¡Œå¸ƒå±€.ä¸â€œ 9éƒ¨åˆ†â€å›¾åƒåŒºåŸŸç›¸ä¼¼ï¼Œå¯ä»¥å°†å­©å­æ”¾ç½®åœ¨4ä¸ªè§’çš„ä»»æ„ä¸€ä¸ªæˆ–4ä¸ªè¾¹ç¼˜ä¸­çš„ä»»æ„ä¸€ä¸ªçš„ä¸­é—´ä»¥åŠä¸­å¿ƒã€‚12345678910111213override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; ... let backgroundNode = ASDisplayNodeWithBackgroundColor(UIColor.blue) let foregroundNode = ASDisplayNodeWithBackgroundColor(UIColor.red, CGSize(width: 70.0, height: 100.0)) let relativeSpec = ASRelativeLayoutSpec(horizontalPosition: .start, verticalPosition: .start, sizingOption: [], child: foregroundNode) let backgroundSpec = ASBackgroundLayoutSpec(child: relativeSpec, background: backgroundNode) ...&#125; ASAbsoluteLayoutSpecé€šè¿‡è®¾ç½®å…¶å­èŠ‚ç‚¹çš„layoutPositionå±æ€§æ¥æŒ‡å®šå…¶å­èŠ‚ç‚¹çš„ç¡®åˆ‡ä½ç½®ï¼ˆx / yåæ ‡ï¼‰ã€‚ç»å¯¹å¸ƒå±€æ¯”å…¶ä»–ç±»å‹çš„å¸ƒå±€æ›´ä¸çµæ´»ä¸”éš¾ä»¥ç»´æŠ¤ã€‚å”¯ä¸€å±æ€§sizing: ç¡®å®š ASAbsoluteLayoutSpec å ç”¨å¤šå°‘ç©ºé—´ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šDefault å’Œ Size to Fitã€‚è¯·æ³¨æ„ï¼ŒSize to Fit é€‰é¡¹å°†å¤åˆ¶æ—§çš„ASStaticLayoutSpecçš„è¡Œä¸º123456789101112131415161718override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; let maxConstrainedSize = constrainedSize.max // Layout all nodes absolute in a static layout spec guitarVideoNode.style.layoutPosition = CGPoint.zero guitarVideoNode.style.preferredSize = CGSize(width: maxConstrainedSize.width, height: maxConstrainedSize.height / 3.0) nicCageVideoNode.style.layoutPosition = CGPoint(x: maxConstrainedSize.width / 2.0, y: maxConstrainedSize.height / 3.0) nicCageVideoNode.style.preferredSize = CGSize(width: maxConstrainedSize.width / 2.0, height: maxConstrainedSize.height / 3.0) simonVideoNode.style.layoutPosition = CGPoint(x: 0.0, y: maxConstrainedSize.height - (maxConstrainedSize.height / 3.0)) simonVideoNode.style.preferredSize = CGSize(width: maxConstrainedSize.width / 2.0, height: maxConstrainedSize.height / 3.0) hlsVideoNode.style.layoutPosition = CGPoint(x: 0.0, y: maxConstrainedSize.height / 3.0) hlsVideoNode.style.preferredSize = CGSize(width: maxConstrainedSize.width / 2.0, height: maxConstrainedSize.height / 3.0) return ASAbsoluteLayoutSpec(children: [guitarVideoNode, nicCageVideoNode, simonVideoNode, hlsVideoNode])&#125; ASCornerLayoutSpecASCornerLayoutSpec æä¾›ä¸€ä¸ªç®€å•æ–¹æ³•ï¼ŒæŠŠ element æ”¾åœ¨è§’è½ã€‚12345678override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec&#123; ... // Layout the center of badge to the top right corner of avatar. let cornerSpec = ASCornerLayoutSpec(child: avatarNode, corner: badgeNode, location: .topRight) // Slightly shift center of badge inside of avatar. cornerSpec.offset = CGPoint(x: -3, y: 3) ...&#125; ASLayoutSpecæ‰€æœ‰ layout spec éƒ½ç»§æ‰¿è‡ªå®ƒä¸»è¦ä»»åŠ¡ï¼šå¤„ç† children å¸ƒå±€ç®¡ç†ï¼Œç”¨æˆ·å¯ä»¥ å­ç±»åŒ–å®ƒå®ç°è‡ªå·±è‡ªå®šä¹‰ layout specã€‚ä½œä¸ºé—´éš”åŒºï¼šå……å½“ ASStackLayoutSpec çš„spacerï¼Œå½“ä½¿ç”¨ .flexGrow and/or .flexShrink æ—¶å€™12345678override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; ... let spacer = ASLayoutSpec() spacer.style.flexGrow = 1.0 stack.children = [imageNode, spacer, textNode] ...&#125; ASStackLayoutSpec(Flexbox Container)ç›¸å…³å±æ€§å¯¹ç…§flexbox-modelæœ‰ 7 ä¸ªå±æ€§ï¼šdirection. ç¡®å®š stack æ–¹å‘ã€‚å¦‚æœå·²ç»è®¾ç½®äº† horizontalAlignment and verticalAlignment, ä»–ä»¬ä¼šè¢«é‡æ–°è§£æä¸€éã€‚å¯¼è‡´ justifyContent and alignItemsä¹Ÿä¼šç›¸åº”çš„å˜åŒ–ã€‚spacing. æ¯ä¸ª child element ä¹‹é—´çš„è·ç¦».horizontalAlignment. æŒ‡å®š children æ˜¯å¦‚ä½•æ°´å¹³å¯¹é½çš„ã€‚æ ¹æ®stack directionæ–¹å‘ã€‚è®¾ç½®å¯¹é½æ–¹å¼ ä¼šå¯¼è‡´ justifyContent or alignItems æ›´æ–°ã€‚verticalAlignment. æŒ‡å®š children æ˜¯å¦‚ä½•å‚ç›´å¯¹é½çš„ã€‚æ ¹æ®stack directionæ–¹å‘ã€‚è®¾ç½®å¯¹é½æ–¹å¼ ä¼šå¯¼è‡´ justifyContent or alignItems æ›´æ–°ã€‚justifyContent. æ²¿ä¸»è½´çš„å¯¹é½æ–¹å¼.alignItems. æ²¿äº¤å‰è½´çš„æ–¹å‘å¸ƒå±€.flexWrap. element å †å æˆå•è¡Œè¿˜æ˜¯å¤šè¡Œã€‚é»˜è®¤ä¸ºå•è¡Œã€‚alignContent. å…ƒç´ ç»„æˆæœ‰å¤šè¡Œï¼Œcross-axisæ–¹å‘ç©ºé—´å……è¶³ï¼Œå†…å®¹è¡Œçš„å¯¹é½æ–¹å¼ã€‚12345678910111213override func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpec &#123; let mainStack = ASStackLayoutSpec(direction: .horizontal, spacing: 6.0, justifyContent: .start, alignItems: .center, children: [titleNode, subtitleNode]) // Set some constrained size to the stack mainStack.style.minWidth = ASDimensionMakeWithPoints(60.0) mainStack.style.maxHeight = ASDimensionMakeWithPoints(40.0) return mainStack&#125; Layout Element å±æ€§ASStackLayoutElement Propertiesï¼šåªä¼šåœ¨ StackLayoutSpec ä¸­çš„å…ƒç´ (node or layout spec)ç”Ÿæ•ˆASAbsoluteLayoutElement Propertiesï¼šåªä¼šåœ¨AbsoluateLayoutSpecä¸­çš„å…ƒç´ ï¼ˆ subnode æˆ– layoutSpecï¼‰ç”Ÿæ•ˆï¼›ASLayoutElement Propertiesï¼šé€‚ç”¨äºæ‰€æœ‰ Node å’Œ layoutSpecï¼› ASStackLayoutElement(flex-item)å±æ€§ç›¸å…³å±æ€§å¯¹ç…§flexbox-modelå±æ€§ç±»å‹æè¿°.style.spacingBeforeCGFloatdirection ä¸Šä¸å‰ä¸€ä¸ª node çš„é—´éš”.style.spacingAfterCGFloatdirection ä¸Šä¸åä¸€ä¸ª node çš„é—´éš”.style.flexGrowBoolå­èŠ‚ç‚¹å°ºå¯¸æ€»å’Œå°äº minimumå³å­˜åœ¨å‰©ä½™ç©ºé—´æ—¶ï¼Œæ˜¯å¦æ”¾å¤§.style.flexShrinkBoolå­èŠ‚ç‚¹æ€»å’Œå¤§äº maximumï¼Œå³ç©ºé—´ä¸è¶³æ—¶ï¼Œæ˜¯å¦ç¼©å°.style.flexBasisASDimensionåœ¨ä½¿ç”¨flexGrow æˆ– flexShrink å±æ€§ä¹‹å‰ï¼Œå¹¶ä¸”å‰©ä½™ç©ºé—´è¢«å‡åˆ†ä¹‹å‰ï¼ŒæŒ‡å®šitemçš„åˆå§‹size.style.alignSelfASStackLayoutAlignSelfitem åœ¨cross-axisæ–¹å‘å¸ƒå±€æ–¹å¼ï¼Œæ­¤å±æ€§ä¼šè¦†ç›– layoutSpec(flex-container) å±æ€§alignItemsï¼Œå¯é€‰å€¼æœ‰ï¼šAutoã€Startã€Endã€Centerã€Stretch.style.ascenderCGFloatç”¨äºåŸºçº¿å¯¹é½ï¼Œæè¿°å¯¹è±¡ä»é¡¶éƒ¨åˆ°å…¶åŸºçº¿çš„è·ç¦».style.descenderCGFloatç”¨äºåŸºçº¿å¯¹é½ï¼Œæè¿°å¯¹è±¡ä»åŸºçº¿åˆ°å…¶åº•éƒ¨çš„è·ç¦» ASAbsoluteLayoutElement å±æ€§å±æ€§ç±»å‹æè¿°.style.layoutPositionCGPointè¯¥å¯¹è±¡åœ¨ ASAbsoluteLayoutSpec ä¸­çš„ä½ç½® ASLayoutElement å±æ€§å±æ€§ç±»å‹æè¿°.style.widthASDimensionæŒ‡å®š ASLayoutElement å†…å®¹åŒºåŸŸçš„å®½åº¦ã€‚minWidth å’Œ maxWidth å±æ€§ä¼šè¦†ç›– widthï¼Œé»˜è®¤å€¼ä¸º ASDimensionAuto.style.heightASDimensionæŒ‡å®šASLayoutElement å†…å®¹åŒºåŸŸçš„é«˜åº¦ã€‚minHeight å’Œ maxHeight å±æ€§ä¼šè¦†ç›– heightï¼Œé»˜è®¤å€¼ä¸º ASDimensionAuto.style.minWidthASDimensionminWidth å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å°å®½åº¦.å®ƒå¯ä»¥é˜²æ­¢ width å±æ€§å€¼å°äº minWidth æŒ‡å®šçš„å€¼ï¼ŒminWidth çš„å€¼ä¼šè¦†ç›– maxWidth å’Œ width. é»˜è®¤å€¼ä¸º ASDimensionAuto.style.maxWidthASDimensionmaxWidth å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å¤§å®½åº¦.å®ƒå¯ä»¥é˜²æ­¢ width å±æ€§å€¼å¤§äº maxWidth æŒ‡å®šçš„å€¼. maxWidth çš„å€¼ä¼šè¦†ç›– widthï¼ŒminWidth ä¼šè¦†ç›– maxWidth. é»˜è®¤å€¼ä¸º ASDimensionAuto.style.minHeightASDimensionminHeight å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å°é«˜åº¦.å®ƒå¯ä»¥é˜²æ­¢ height å±æ€§å€¼å°äº minHeight æŒ‡å®šçš„å€¼.minHeight çš„å€¼ä¼šè¦†ç›– maxHeight å’Œ height. é»˜è®¤å€¼ä¸º ASDimensionAuto.style.maxHeightASDimensionmaxHeight å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å¤§é«˜åº¦ï¼Œå®ƒå¯ä»¥é˜²æ­¢ height å±æ€§å€¼å¤§äº maxHeight æŒ‡å®šçš„å€¼.maxHeight çš„å€¼ä¼šè¦†ç›– heightï¼ŒminHeight ä¼šè¦†ç›– maxHeight.é»˜è®¤å€¼ä¸º ASDimensionAuto.style.preferredSizeCGSizeæä¾›å¸ƒå±€å…ƒç´ çš„å»ºè®® size.å¦‚æœæä¾›äº† minSize æˆ– maxSizeï¼Œå¹¶ä¸” preferredSize è¶…è¿‡äº†è¿™äº›å€¼ï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨ minSize æˆ– maxSize.å¦‚æœæœªæä¾› preferredSizeï¼Œåˆ™å¸ƒå±€å…ƒç´ çš„ size é»˜è®¤ä¸º calculateSizeThatFits: æ–¹æ³•æä¾›çš„å›ºæœ‰å¤§å°.æ­¤æ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯å¯¹äºæ²¡æœ‰å›ºæœ‰å¤§å°æˆ–éœ€è¦ç”¨ä¸å›ºæœ‰å¤§å°ä¸åŒçš„çš„ size è¿›è¡Œå¸ƒå±€çš„èŠ‚ç‚¹ï¼Œåˆ™å¿…é¡»æŒ‡å®š preferredSize æˆ– preferredLayoutSize ä¸­çš„ä¸€ä¸ªï¼Œæ¯”å¦‚æ²¡è¿™ä¸ªå±æ€§å¯ä»¥åœ¨ ASImageNode ä¸Šè®¾ç½®ï¼Œä½¿è¿™ä¸ªèŠ‚ç‚¹çš„ size å’Œå›¾ç‰‡ size ä¸åŒ, è­¦å‘Šï¼šå½“ size çš„å®½åº¦æˆ–é«˜åº¦æ˜¯ç›¸å¯¹å€¼æ—¶è°ƒç”¨ getter å°†è¿›è¡Œæ–­è¨€.style.minSizeCGSizeå¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å°å°ºå¯¸ï¼Œå¦‚æœæä¾›ï¼ŒminSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ minSize å°äºå…¶å­çº§çš„ minSizeï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨å­çº§çš„ minSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤–,ä¾‹å¦‚ï¼Œå¦‚æœç»™å…¨å±å®¹å™¨ä¸­çš„æŸä¸ªå…ƒç´ è®¾ç½® 50ï¼… çš„ preferredSize ç›¸å¯¹å®½åº¦ï¼Œå’Œ 200pt çš„ minSize å®½åº¦ï¼ŒpreferredSize ä¼šåœ¨ iPhone å±å¹•ä¸Šäº§ç”Ÿ 160pt çš„å®½åº¦ï¼Œä½†ç”±äº 160pt ä½äº 200pt çš„ minSize å®½åº¦ï¼Œå› æ­¤æœ€ç»ˆè¯¥å…ƒç´ çš„å®½åº¦ä¼šæ˜¯ 200pt.style.maxSizeCGSizeå¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å¤§å°ºå¯¸ï¼Œå¦‚æœæä¾›ï¼ŒmaxSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.style.preferredLayoutSizeASLayoutSizeä¸ºå¸ƒå±€å…ƒç´ æä¾›å»ºè®®çš„ç›¸å¯¹ size.ASLayoutSize ä½¿ç”¨ç™¾åˆ†æ¯”è€Œä¸æ˜¯ç‚¹æ¥æŒ‡å®šå¸ƒå±€.ä¾‹å¦‚ï¼Œå­å¸ƒå±€å…ƒç´ çš„å®½åº¦åº”è¯¥æ˜¯çˆ¶å®½åº¦çš„ 50ï¼….å¦‚æœæä¾›äº†å¯é€‰çš„ minLayoutSize æˆ– maxLayoutSizeï¼Œå¹¶ä¸” preferredLayoutSize è¶…è¿‡äº†è¿™äº›å€¼ï¼Œåˆ™å°†ä½¿ç”¨ minLayoutSize æˆ– maxLayoutSize.style.minLayoutSizeASLayoutSizeå¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å°çš„ç›¸å¯¹å°ºå¯¸ï¼Œ å¦‚æœæä¾›ï¼ŒminLayoutSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ minLayoutSize å°äºå…¶å­çº§çš„ minLayoutSizeï¼Œåˆ™ä¼šå¼ºåˆ¶ä½¿ç”¨å­çº§çš„ minLayoutSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤–.style.maxLayoutSizeASLayoutSizeå¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å¤§çš„ç›¸å¯¹å°ºå¯¸.å¦‚æœæä¾›ï¼ŒmaxLayoutSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ maxLayoutSize å°äºå…¶å­çº§çš„ maxLayoutSizeï¼Œé‚£ä¹ˆå°†å¼ºåˆ¶ä½¿ç”¨å­çº§çš„ maxLayoutSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤– Layout API Sizingåœ¨Layout APIä¸­ï¼Œç†è§£å¤åˆå°ºå¯¸ç±»å‹çš„æœ€ç®€å•æ–¹æ³•æ˜¯æŸ¥çœ‹æ‰€æœ‰çš„ unit ä¹‹é—´çš„å…³ç³»ã€‚ Values (CGFloat, ASDimension)ASDimensionæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ™®é€šçš„CGFloatï¼Œæ”¯æŒè¡¨ç¤ºç‚¹å€¼ï¼Œç›¸å¯¹ç™¾åˆ†æ¯”å€¼æˆ–è‡ªåŠ¨å€¼ã€‚unit å…è®¸ç›¸åŒçš„APIæ¥å—å›ºå®šå€¼å’Œç›¸å¯¹å€¼ã€‚12345678// dimension returned is relative (%)ASDimensionMake(\"50%\")ASDimensionMakeWithFraction(0.5)// dimension returned in pointsASDimensionMake(\"70pt\")ASDimensionMake(70)ASDimensionMakeWithPoints(70) ä½¿ç”¨ ASDimension çš„ä¾‹å­ASDimension ç”¨äºè®¾ç½® ASStackLayoutSpec ä¸­element çš„ flexBasis. flexBasis å±æ€§åœ¨ stack layout ä¸­æŒ‡å®šå¯¹è±¡çš„åˆå§‹å¤§å°ï¼Œåœ¨ä¸‹é¢çš„è§†å›¾ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å·¦ä¾§å †æ ˆå æ®æ°´å¹³å®½åº¦çš„40ï¼…ï¼Œå³ä¾§å †æ ˆå æ®å®½åº¦çš„60ï¼…ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨æ°´å¹³å †æ ˆçš„ä¸¤ä¸ªå­çº§ä¸Šè®¾ç½®.flexBasiså±æ€§ï¼š1234self.leftStack.style.flexBasis = ASDimensionMake(\"40%\")self.rightStack.style.flexBasis = ASDimensionMake(\"60%\")horizontalStack.children = [self.leftStack, self.rightStack] Sizes (CGSize, ASLayoutSize)ASLayoutSizeä¸CGSizeç›¸ä¼¼ï¼Œä½†æ˜¯å…¶å®½åº¦å’Œé«˜åº¦å€¼å¯ä»¥è¡¨ç¤ºç‚¹æˆ–ç™¾åˆ†æ¯”å€¼ã€‚å®½åº¦å’Œé«˜åº¦çš„ç±»å‹æ˜¯ç‹¬ç«‹çš„ï¼›ä¸€ä¸ªå¯ä»¥æ˜¯ç‚¹æˆ–ç™¾åˆ†æ¯”å€¼ã€‚1ASLayoutSizeMake(ASDimension width, ASDimension height);ASLayoutSizeç”¨äºè®¾ç½®å¸ƒå±€å…ƒç´ çš„ .preferredLayoutSize , .minLayoutSize å’Œ .maxLayoutSize å±æ€§ã€‚å®ƒå…è®¸ç›¸åŒçš„APIæ¥å—å›ºå®šå¤§å°ä»¥åŠç›¸å¯¹å¤§å°ã€‚12345// Dimension type \"Auto\" indicates that the layout element may // be resolved in whatever way makes most sense given the circumstanceslet width = ASDimensionMake(.auto, 0)let height = ASDimensionMake(\"50%\")layoutElement.style.preferredLayoutSize = ASLayoutSizeMake(width, height)å¦‚æœä¸éœ€è¦ç›¸å¯¹å€¼ï¼Œåˆ™å¯ä»¥è®¾ç½®å¸ƒå±€å…ƒç´ çš„.preferredSizeï¼Œ.minSizeå’Œ.maxSizeå±æ€§ã€‚è¿™äº›å±æ€§é‡‡ç”¨å¸¸è§„CGSizeå€¼ã€‚1layoutElement.style.preferredSize = CGSize(width: 30, height: 60)å¤§å¤šæ•°æ—¶å€™ï¼Œéƒ½ä¸æƒ³åŒæ—¶é™åˆ¶å®½åº¦å’Œé«˜åº¦ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ASDimensionå€¼åˆ†åˆ«è®¾ç½®å¸ƒå±€å…ƒç´ çš„å°ºå¯¸å±æ€§ã€‚1234567layoutElement.style.width = ASDimensionMake(\"50%\")layoutElement.style.minWidth = ASDimensionMake(\"50%\")layoutElement.style.maxWidth = ASDimensionMake(\"50%\")layoutElement.style.height = ASDimensionMake(\"50%\")layoutElement.style.minHeight = ASDimensionMake(\"50%\")layoutElement.style.maxHeight = ASDimensionMake(\"50%\") Size Range (ASSizeRange)UIKitæ²¡æœ‰æä¾›ç»„åˆæœ€å°å’Œæœ€å¤§CGSizeçš„ structã€‚å› æ­¤ï¼Œåˆ›å»ºäº†ASSizeRangeä»¥æ”¯æŒæœ€å°å’Œæœ€å¤§CGSizeå¯¹ã€‚ASSizeRangeé€šå¸¸ç”¨äºå¸ƒå±€APIçš„å†…éƒ¨ã€‚ä½†æ˜¯ï¼Œä½œä¸ºè¾“å…¥ä¼ é€’ç»™layoutSpecThatFitsï¼šçš„constrainedSizeå€¼æ˜¯ASSizeRangeã€‚1func layoutSpecThatFits(_ constrainedSize: ASSizeRange) -&gt; ASLayoutSpecä¼ é€’ç»™ASDisplayNodeå­ç±»çš„layoutSpecThatFitsï¼šæ–¹æ³•çš„constrainedSizeæ˜¯èŠ‚ç‚¹åº”é€‚åˆçš„æœ€å°å’Œæœ€å¤§å¤§å°ã€‚constrainedSizeä¸­åŒ…å«çš„æœ€å°CGSizeå’Œæœ€å¤§CGSizeå¯ç”¨äºè°ƒæ•´èŠ‚ç‚¹çš„å¸ƒå±€å…ƒç´ çš„å¤§å°ã€‚","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"},{"name":"Texture","slug":"Texture","permalink":"https://changzw.github.io/tags/Texture/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"UI å¸ƒå±€","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/UI-å¸ƒå±€","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/UI-%E5%B8%83%E5%B1%80/"}]},{"title":"deallocçš„è°ƒç”¨æ—¶æœº","date":"2018-04-02T07:06:19.000Z","path":"2018/04/02/deallocçš„è°ƒç”¨æ—¶æœº/","text":"ä¸€èˆ¬æƒ³æ³• delloc ä¼šåœ¨å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™è°ƒç”¨ã€‚ç”¨æˆ·é‡è½½è¯¥æ–¹æ³•é‡Šæ”¾è‡ªå·±åˆ†é…çš„å †æ§ä»¶ï¼Œç§»é™¤è®¢é˜…â€¦â€¦åœ¨ MRC ä¸­12345678- (void)dealloc &#123; self.array = nil; self.string = nil; // ... // // éObjcå¯¹è±¡å†…å­˜çš„é‡Šæ”¾ï¼Œå¦‚CFRelease(...) // ... // [super dealloc];&#125;ARC ä¸­12345- (void)dealloc &#123; // ... // // éObjcå¯¹è±¡å†…å­˜çš„é‡Šæ”¾ï¼Œå¦‚CFRelease(...) // ... //&#125;å¯¹æ¯”ä¸¤ç«¯ä»£ç ï¼šè¿™ä¸ªå¯¹è±¡å®ä¾‹å˜é‡ï¼ˆIvarsï¼‰çš„é‡Šæ”¾å»å“ªå„¿äº†ï¼Ÿæ²¡æœ‰æ˜¾ç¤ºçš„è°ƒç”¨[super dealloc]ï¼Œä¸Šå±‚çš„ææ„å»å“ªå„¿äº†ï¼Ÿ ARCæ–‡æ¡£ä¸­å¯¹deallocè¿‡ç¨‹çš„è§£é‡ŠA class may provide a method definition for an instance method named dealloc. This method will be called after the final release of the object but before it is deallocated or any of its instance variables are destroyed. The superclassâ€™s implementation of dealloc will be called automatically when the method returns.å¤§æ¦‚æ„æ€æ˜¯ï¼šdeallocæ–¹æ³•åœ¨æœ€åä¸€æ¬¡releaseåè¢«è°ƒç”¨ï¼Œä½†æ­¤æ—¶å®ä¾‹å˜é‡ï¼ˆIvarsï¼‰å¹¶æœªé‡Šæ”¾ï¼Œçˆ¶ç±»çš„deallocçš„æ–¹æ³•å°†åœ¨å­ç±»deallocæ–¹æ³•è¿”å›åè‡ªåŠ¨è°ƒç”¨The instance variables for an ARC-compiled class will be destroyed at some point after control enters the dealloc method for the root class of the class. The ordering of the destruction of instance variables is unspecified, both within a single class and between subclasses and superclasses.ç†è§£ï¼šARCä¸‹å¯¹è±¡çš„Ivarsåœ¨æ ¹ç±»[NSObject dealloc]ä¸­é‡Šæ”¾ï¼ˆé€šå¸¸root classéƒ½æ˜¯NSObjectï¼‰ï¼Œå˜é‡é‡Šæ”¾é¡ºåºå„ç§ä¸ç¡®å®šï¼ˆä¸€ä¸ªç±»å†…çš„ä¸ç¡®å®šï¼Œå­ç±»å’Œçˆ¶ç±»é—´ä¹Ÿä¸ç¡®å®šï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç”¨careé‡Šæ”¾é¡ºåºï¼‰é—®é¢˜ï¼š[super delloc] ä¸ºä»€ä¹ˆå¯ä»¥åœ¨å­ç±»çš„ delloc è¿”å›åè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ Ivars ä¸ºä»€ä¹ˆä¼šåœ¨æ ¹ç±»çš„ delloc ä¸­é‡Šæ”¾ delloc è°ƒç”¨æ ˆåˆ†æè°ƒç”¨è¿‡ç¨‹dealloc -&gt; _objc_rootDealloc -&gt; object_dispose -&gt; objc_destructInstance123456789101112131415161718192021222324252627282930313233343536373839404142434445- (void)dealloc &#123; _objc_rootDealloc(self); &#125; void _objc_rootDealloc(id obj) &#123; obj-&gt;rootDealloc(); &#125;inline void objc_object::rootDealloc() &#123; if (isTaggedPointer()) return; // fixme necessary? if (fastpath(isa.nonpointer &amp;&amp; !isa.weakly_referenced &amp;&amp; // å¼±å¼•ç”¨ !isa.has_assoc &amp;&amp; // å…³è”å¯¹è±¡ !isa.has_cxx_dtor &amp;&amp; // ææ„å™¨ !isa.has_sidetable_rc)) &#123; // æ•£åˆ—è¡¨ assert(!sidetable_present()); free(this); &#125; else &#123; object_dispose((id)this); &#125;&#125;id object_dispose(id obj) &#123; objc_destructInstance(obj); free(obj); return nil;&#125;/************************************************************************ objc_destructInstance* Destroys an instance without freeing memory.* Calls C++ destructors.* Calls ARC ivar cleanup.* Removes associative references.* Returns `obj`. Does nothing if `obj` is nil.**********************************************************************/void *objc_destructInstance(id obj) &#123; if (obj) &#123; // Read all of the flags at once for performance. bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); // This order is important. if (cxx) object_cxxDestruct(obj);// æ¸…ç† ivars if (assoc) _object_remove_assocations(obj);// æ¸…ç†å…³è”å¯¹è±¡ obj-&gt;clearDeallocating();// æ¸…ç† weak è¡¨ &#125; return obj;&#125;ä¸»è¦æ˜¯è¿™ä¸ªæ–¹æ³•objc_destructInstanceï¼Œæ ¹æ®ä»–çš„æ³¨é‡Šé”€æ¯å®ä¾‹å¯¹è±¡ï¼Œä½†æ²¡æœ‰é‡Šæ”¾å†…å­˜è°ƒç”¨ C++ çš„ destructoræ‰ç”¨ ARC å°† ivar æ¸…ç†æ¸…ç†å…³è”å¯¹è±¡object_cxxDestruct åšäº†ä»€ä¹ˆï¼ŸclearDeallocating åšäº†ä»€ä¹ˆï¼Ÿ clearDeallocating æ¸…ç©ºå¼±å¼•ç”¨12345678910inline void objc_object::clearDeallocating() &#123; if (slowpath(!isa.nonpointer)) &#123; // Slow path for raw pointer isa. sidetable_clearDeallocating(); &#125; else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) &#123; // Slow path for non-pointer isa with weak refs and/or side table data. clearDeallocating_slow(); &#125; assert(!sidetable_present());&#125;ok clearDeallocating ç”¨äºæ¸…ç©ºå¼•ç”¨è®¡æ•°è¡¨å¹¶æ¸…é™¤å¼±å¼•ç”¨è¡¨ï¼Œå°†æ‰€æœ‰weakå¼•ç”¨æŒ‡nil object_cxxDestructä»è¿™ç¯‡æ–‡ç« ä¸­ï¼šARC actually creates a -.cxx_destruct method to handle freeing instance variables. This method was originally created for calling C++ destructors automatically when an object was destroyed.object_cxxDestruct æ–¹æ³•ç”¨äºé‡Šæ”¾å®ä¾‹çš„ ivarså’Œã€ŠEffective Objective-C 2.0ã€‹ä¸­æåˆ°çš„ï¼šWhen the compiler saw that an object contained C++ objects, it would generate a method called .cxx_destruct. ARC piggybacks on this method and emits the required cleanup code within it.å¯ä»¥äº†è§£åˆ°ï¼Œ.cxx_destructæ–¹æ³•åŸæœ¬æ˜¯ä¸ºäº†C++å¯¹è±¡ææ„çš„ï¼ŒARCå€Ÿç”¨äº†è¿™ä¸ªæ–¹æ³•æ’å…¥ä»£ç å®ç°äº†è‡ªåŠ¨å†…å­˜é‡Šæ”¾çš„å·¥ä½œ1234567891011121314151617181920212223242526272829void object_cxxDestruct(id obj)&#123; if (!obj) return; if (obj-&gt;isTaggedPointer()) return; object_cxxDestructFromClass(obj, obj-&gt;ISA());&#125;/************************************************************************ object_cxxDestructFromClass.* Call C++ destructors on obj, starting with cls's * dtor method (if any) followed by superclasses' dtors (if any), * stopping at cls's dtor (if any).* Uses methodListLock and cacheUpdateLock. The caller must hold neither.**********************************************************************/static void object_cxxDestructFromClass(id obj, Class cls) &#123; void (*dtor)(id); // Call cls's dtor first, then superclasses's dtors. for ( ; cls; cls = cls-&gt;superclass) &#123; if (!cls-&gt;hasCxxDtor()) return; dtor = (void(*)(id)) lookupMethodInClassAndLoadCache(cls, SEL_cxx_destruct); if (dtor != (void(*)(id))_objc_msgForward_impcache) &#123; if (PrintCxxCtors) &#123; _objc_inform(\"CXX: calling C++ destructors for class %s\", cls-&gt;nameForLogging()); &#125; (*dtor)(obj); &#125; &#125;&#125;åœ¨å®ä¾‹å¯¹è±¡çš„æœ€åä¸€ä¸ª release æ–¹æ³•è°ƒç”¨ï¼Œå¼•ç”¨è®¡æ•° = 0 è°ƒç”¨deallocå®ä¾‹å¯¹è±¡æ˜¯å¦æ˜¯ isTaggedPointeré€šè¿‡ C++ çš„ææ„å™¨é‡Šæ”¾ ivars æˆå‘˜å˜é‡å†…å­˜ç§»é™¤å…³è”å¯¹è±¡ç§»é™¤ weak å¼•ç”¨ç›¸å…³æ•°æ®ï¼Œweak å˜é‡ç½®ä¸º nilARCä¸‹deallocè¿‡ç¨‹åŠ.cxx_destructçš„æ¢ç©¶","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"åŠŸèƒ½ç»†èŠ‚è®°å½•","date":"2018-03-24T00:08:47.000Z","path":"2018/03/24/åŠŸèƒ½ç»†èŠ‚è®°å½•/","text":"ä½¿å¾—ç³»ç»Ÿsettingé¡µé¢ä¸­æœ‰è‡ªå·±app çš„è®¾ç½®iOSå¼€å‘ä¹‹Settings Bundleçš„ä½¿ç”¨ app å’Œ app Extension å…±äº«æ•°æ®UserDefault ä½¿ç”¨ groupName åˆå§‹åŒ–å°±å¯ä»¥äº†FileManager æ•°æ®è·å–ä¸€å®šä½¿ç”¨ URL æ ¼å¼æ‹¼æ¥ groupï¼Œå¦‚æœä½¿ç”¨ String ä¼šè¯»ä¸åˆ°æ•°æ®","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"22-æ¯”è¾ƒçº§å€’è£…","date":"2018-03-15T15:04:54.000Z","path":"2018/03/15/English/22-å€’è£…å¥/","text":"ä»‹ç»å€’è£…å¥æ˜¯â¼€ç§æŠŠåŠ¨è¯ï¼ˆæˆ–åŠ©åŠ¨è¯ï¼‰ç§»åˆ°ä¸»è¯­å‰â¾¯çš„å¥å‹ã€‚ä»¥è¿™ä¸ªå®šä¹‰æ¥çœ‹ï¼Œâ¼€èˆ¬ çš„ç–‘é—®å¥éƒ½å¯ä»¥ç®—æ˜¯å€’è£…å¥ã€‚æ’‡å¼€ç–‘é—®å¥è¿™ç§åªå…·æœ‰è¯­æ³•åŠŸèƒ½çš„å€’è£…å¥ä¸è°ˆï¼Œâ½è¾ƒå€¼å¾—ç ”ç©¶çš„æ˜¯å…·æœ‰ä¿®è¾åŠŸèƒ½çš„å€’è£…å¥ã€‚æ°å½“åœ°è¿â½¤å€’è£…å¥ï¼Œå¯ä»¥å¼ºè°ƒè¯­â½“ã€å¢å¼ºæ¸…æ¥šæ€§ä¸ç®€æ´æ€§ï¼Œä»¥åŠ æ›´æµç•…åœ°è¡”æ¥å‰åçš„å¥â¼¦ã€‚ä»¥ä¸‹åˆ†åˆ«å°±â¼ç§é‡è¦çš„å€’è£…å¥æ¥çœ‹çœ‹å®ƒå€’è£…çš„æ¡ä»¶ï¼Œ ä»¥åŠå¯è¾¾åˆ°çš„ä¿®è¾æ•ˆæœã€‚ æ¯”è¾ƒçº§çš„å€’è£…Girls like cats more than boys.(ä¸æ¸…æ¥šï¼‰ è¿™ä¸ªå¥â¼¦å¯èƒ½æœ‰ä¸¤ç§æ„æ€ï¼šGirls like cats more than boys do. (â¼¥å­©æ¯”ç”·å­©æ›´å–œæ¬¢çŒ«ã€‚ï¼‰Girls like cats more than they like boys. (â¼¥å­©æ¯”è¾ƒå–œæ¬¢çŒ«ï¼Œæ¯”è¾ƒä¸å–œæ¬¢ç”·å­©ã€‚ï¼‰â½è¾ƒçº§çš„å¥å‹é€šå¸¸ä¼šç‰µæ¶‰åˆ°ä¸¤ä¸ªä»å¥äº’ç›¸â½è¾ƒã€‚è¿™ä¸¤ä¸ªä»å¥é—´åº”æœ‰é‡å¤çš„éƒ¨ åˆ†æ‰èƒ½â½è¾ƒã€‚â¼€æ—¦æœ‰é‡å¤ï¼Œå°±æœ‰çœç•¥çš„ç©ºé—´ã€‚ä½†æ˜¯å¦‚æœçœç•¥ä¸å½“ï¼Œå°±ä¼šä¼¤å®³å¥â¼¦ çš„æ¸…æ¥šæ€§ã€‚ å…³ç³»ä»å¥çš„å€’è£… å‡è®¾è¯­æ°”çš„å€’è£… å¼•ç”¨å¥çš„å€’è£… ç±»ä¼¼ there is/are çš„å€’è£… å¦å®šå‰¯è¯å¼€å¤´çš„å€’è£…","tags":[{"name":"è¯­æ³•","slug":"è¯­æ³•","permalink":"https://changzw.github.io/tags/%E8%AF%AD%E6%B3%95/"}],"categories":[{"name":"è‹±è¯­å­¦ä¹ ","slug":"è‹±è¯­å­¦ä¹ ","permalink":"https://changzw.github.io/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/"},{"name":"è¯­æ³•","slug":"è‹±è¯­å­¦ä¹ /è¯­æ³•","permalink":"https://changzw.github.io/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/%E8%AF%AD%E6%B3%95/"}]},{"title":"è‹±è¯­è¯­æ³•å­¦ä¹ ","date":"2018-03-15T14:35:33.000Z","path":"2018/03/15/English/è‹±è¯­è¯­æ³•å­¦ä¹ /","text":"ä½¿ç”¨æ•°æ®ï¼šè‹±è¯­é­”æ³•å¸ˆä¹‹è¯­æ³•ä¿±ä¹éƒ¨è®°å½•è‡ªå·±å­¦ä¹ è‹±è¯­çš„è¿‡ç¨‹","tags":[{"name":"English","slug":"English","permalink":"https://changzw.github.io/tags/English/"}],"categories":[{"name":"è‹±è¯­å­¦ä¹ ","slug":"è‹±è¯­å­¦ä¹ ","permalink":"https://changzw.github.io/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/"},{"name":"è¯­æ³•","slug":"è‹±è¯­å­¦ä¹ /è¯­æ³•","permalink":"https://changzw.github.io/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/%E8%AF%AD%E6%B3%95/"}]},{"title":"å¦‚ä½•ç»™è‡ªå·±çš„åº“æ·»åŠ å‰ç¼€","date":"2018-03-12T15:12:42.000Z","path":"2018/03/12/å¦‚ä½•ç»™è‡ªå·±çš„åº“æ·»åŠ å‰ç¼€/","text":"åœ¨ Rxswiftä¸­rx_tap : åŸå§‹è¯­æ³•The original syntaxrxTap : åŒä¸Šï¼Œä½†æ˜¯è¯­ä¹‰æœ‰æ­§ä¹‰ï¼Œå¦‚æœä¸æ˜¯ Rxswiftåº“ä¸­å´æ˜¯ç”¨ rxABC è¿™æ ·çš„reactiveTap : è¯­ä¹‰å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å¤ªé•¿äº†rx.tap : âœ¨ğŸ˜²âœ¨ è¿™æ ·å°±å¾ˆå¥½äº†ï¼Œä¸€ä¸ªæ¼‚äº®çš„å‘½åç©ºé—´. æƒ³æ³•æ¥æºLazySequence12myArray.map &#123; ... &#125;myArray.lazy.map &#123; ... &#125;æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ RxCocoa ä¸­æœ‰åŒæ ·çš„è¯­æ³•:12if myButton.enabled &#123; ... &#125;myButton.rx.enabled.subscribeNext &#123; ... &#125; å®ç°ç»†èŠ‚ å…±äº«çš„ä»£ç æˆ‘æƒ³æˆ‘ä»¬å¯ä»¥æŠŠ Reactive protocol è½¬æ¢æˆä¸€ä¸ªæ³›å‹ struct :123456public struct Reactive&lt;Base: AnyObject&gt; &#123; public let base: Base public init(_ base: Base) &#123; self.base = base &#125;&#125;æ¥ç€æˆ‘ä»¬æ‰©å±• NSObjectProtocol åè®®æ¥åˆ›å»º rx ä»£ç† :12345public extension NSObjectProtocol &#123; public var rx: Reactive&lt;Self&gt; &#123; return Reactive(self) &#125;&#125;RxSwift ä¸­çš„å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public struct Reactive&lt;Base&gt; &#123; /// Base object to extend. public let base: Base public init(_ base: Base) &#123; self.base = base &#125;&#125;/// A type that has reactive extensions.public protocol ReactiveCompatible &#123; /// Extended type associatedtype ReactiveBase @available(*, deprecated, message: \"Use `ReactiveBase` instead.\") typealias CompatibleType = ReactiveBase /// Reactive extensions. static var rx: Reactive&lt;ReactiveBase&gt;.Type &#123; get set &#125; /// Reactive extensions. var rx: Reactive&lt;ReactiveBase&gt; &#123; get set &#125;&#125;extension ReactiveCompatible &#123; /// Reactive extensions. public static var rx: Reactive&lt;Self&gt;.Type &#123; get &#123; return Reactive&lt;Self&gt;.self &#125; set &#123; // this enables using Reactive to \"mutate\" base type &#125; &#125; /// Reactive extensions. public var rx: Reactive&lt;Self&gt; &#123; get &#123; return Reactive(self) &#125; set &#123; // this enables using Reactive to \"mutate\" base object &#125; &#125;&#125;import class Foundation.NSObject/// Extend NSObject with `rx` proxy.extension NSObject: ReactiveCompatible &#123; &#125; å› ä¸ºæˆ‘ä»¬ä½¿ç”¨Selfï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰©å±•åè®®è€Œä¸æ˜¯å…·ä½“ç±»å‹ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘å»ºè®®ä½¿ç”¨NSObjectProtocolï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´æœ‰æ„ä¹‰çš„åè®®ï¼Œä¾‹å¦‚ReactiveCompatibleæˆ–ç±»ä¼¼çš„åè®®ã€‚è‡ªå·±å®ç°ä¸€ä¸ªå°çš„æ‰©å±•ä½¿ç”¨ æ³›å‹ï¼ˆæ¨¡æ¿ï¼‰åˆ›å»ºè‡ªå·±çš„ç±»å‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public struct Czw&lt;Base&gt; &#123; public let base: Base public init(_ base: Base) &#123; self.base = base &#125;&#125;public protocol CzwCompatible &#123; associatedtype CzwBase static var czw: Czw&lt;CzwBase&gt;.Type &#123; get set &#125; var czw: Czw&lt;CzwBase&gt; &#123; get set &#125;&#125;extension CzwCompatible &#123; public static var czw: Czw&lt;Self&gt;.Type &#123; get &#123; return Czw&lt;Self&gt;.self &#125; set &#123; // this enables using Czw to \"mutate\" base type &#125; &#125; /// Czw extensions. public var czw: Czw&lt;Self&gt; &#123; get &#123; return Czw(self) &#125; set &#123; // this enables using Czw to \"mutate\" base object &#125; &#125;&#125;import class Foundation.NSObjectextension NSObject: CzwCompatible &#123; &#125;extension String: CzwCompatible &#123;&#125;extension Czw where Base == String &#123; var x: String &#123; get &#123; \"233\" &#125; &#125;&#125;let a = \"1\"let b = a.czw.x å…·ä½“æ‰©å±•ç°åœ¨è¦å°† reactive extensions æ·»åŠ åˆ°ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é€šç”¨çº¦æŸæ¥æ‰©å±•Reactiveï¼Œè€Œä¸æ˜¯æ‰©å±•ç›®æ ‡ç±»å‹æœ¬èº«ã€‚å› æ­¤å¯¹äºä¸‹é¢è¿™æ®µä»£ç ï¼š12345extension UIButton &#123; public var rx_tap: ControlEvent&lt;Void&gt; &#123; return rx_controlEvent(.touchUpInside) &#125;&#125;æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåš12345extension Reactive where Base: UIButton &#123; public var tap: ControlEvent&lt;Void&gt; &#123; return controlEvent(.touchUpInside) &#125;&#125; å†…å­˜ç®¡ç†æ³¨æ„äº‹é¡¹æˆ‘çœ‹åˆ°çš„è¿™ç§æ–°è¯­æ³•çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå®ƒå¯èƒ½å¯¼è‡´é—­åŒ…å†…éƒ¨ä¸å¤ªç›´è§‚çš„å†…å­˜ç®¡ç†ã€‚å®é™…ä¸Šï¼Œç°åœ¨ï¼Œå“åº”å¼æ‰©å±•å±äºReactiveç±»å‹ï¼ˆä»£ç†ï¼‰ã€‚å› æ­¤ï¼Œæ— è®ºåœ¨æ–¹æ³•å®ç°ä¸­ä½¿ç”¨ self çš„ä»€ä¹ˆåœ°æ–¹ï¼Œå®ƒéƒ½å¼•ç”¨ä»£ç†è€Œä¸æ˜¯ baseã€‚ä½†æ˜¯ç”±äºè¿™ä¸ª proxy æ˜¯ä¸€ç§å€¼ç±»å‹ï¼Œæ— æ³•å¼±åŒ–(weakify)å®ƒï¼Œå¹¶ä¸”æ¯æ¬¡åœ¨é—­åŒ…å†…ä½¿ç”¨ self æ—¶ï¼Œå®ƒå®é™…ä¸Šéƒ½ä¼š strongifyï¼ˆretainï¼‰å…¶æ‰€æœ‰å¼•ç”¨ç±»å‹æˆå‘˜ï¼ˆå³ base ï¼‰ã€‚å› æ­¤ï¼Œåœ¨å®ç°æ‰©å±•æ—¶éœ€è¦æ ¼å¤–å°å¿ƒã€‚ è®©æˆ‘ä»¬ä»¥UISearchBarä¸ºä¾‹ã€‚Sample 1 : å½“å‰çš„å®ç°1234567891011121314151617181920212223extension UISearchBar &#123; public var rx_delegate: DelegateProxy &#123; return RxSearchBarDelegateProxy.proxyForObject(self) &#125; public var rx_text: ControlProperty&lt;String&gt; &#123; let source: Observable&lt;String&gt; = Observable.deferred &#123; [weak self] () -&gt; Observable&lt;String&gt; in let text = self?.text ?? \"\" return (self?.rx_delegate.observe(#selector(UISearchBarDelegate.searchBar(_:textDidChange:))) ?? Observable.empty()) .map &#123; a in return a[1] as? String ?? \"\" &#125; .startWith(text) &#125; let bindingObserver = UIBindingObserver(UIElement: self) &#123; (searchBar, text: String) in searchBar.text = text &#125; return ControlProperty(values: source, valueSink: bindingObserver) &#125;&#125;Sample 2 : é”™è¯¯å†…å­˜ç®¡ç†çš„æ–°å®ç°1234567891011121314151617181920212223extension Reactive where Base: UISearchBar &#123; public var delegate: DelegateProxy &#123; return RxSearchBarDelegateProxy.proxyForObject(self.base) &#125; public var text: ControlProperty&lt;String&gt; &#123; let source: Observable&lt;String&gt; = Observable.deferred &#123; [weak searchBar = self.base] () -&gt; Observable&lt;String&gt; in let text = searchBar?.text ?? \"\" return self.delegate.observe(#selector(UISearchBarDelegate.searchBar(_:textDidChange:))) .map &#123; a in return a[1] as? String ?? \"\" &#125; .startWith(text) &#125; let bindingObserver = UIBindingObserver(UIElement: self.base) &#123; (searchBar, text: String) in searchBar.text = text &#125; return ControlProperty(values: source, valueSink: bindingObserver) &#125;&#125;Sample 3 : å…·æœ‰è‰¯å¥½å†…å­˜ç®¡ç†çš„æ–°å®ç°1234567891011121314151617181920212223extension Reactive where Base: UISearchBar &#123; public var delegate: DelegateProxy &#123; return RxSearchBarDelegateProxy.proxyForObject(self.base) &#125; public var text: ControlProperty&lt;String&gt; &#123; let source: Observable&lt;String&gt; = Observable.deferred &#123; [weak searchBar = self.base] () -&gt; Observable&lt;String&gt; in let text = searchBar?.text ?? \"\" return (searchBar?.rx.delegate.observe(#selector(UISearchBarDelegate.searchBar(_:textDidChange:))) ?? Observable.empty()) .map &#123; a in return a[1] as? String ?? \"\" &#125; .startWith(text) &#125; let bindingObserver = UIBindingObserver(UIElement: self.base) &#123; (searchBar, text: String) in searchBar.text = text &#125; return ControlProperty(values: source, valueSink: bindingObserver) &#125;&#125;å…³é”®éƒ¨åˆ†æ˜¯åœ¨æ¯ä¸ª sample ä»£ç çš„ç¬¬ 10è¡Œsample2 å¾ˆå®¹æ˜“é€šè¿‡ self è®¿é—® delegate è§‚å¯Ÿè€…ï¼Œå› ä¸º delegate æ˜¯åœ¨åŒä¸€ proxy æ‰©å±•ä¸Šå®šä¹‰çš„ã€‚ä½†æ˜¯è¿™æ ·åšï¼Œé—­åŒ…æ•è·äº† self å¹¶ä¿ç•™äº†å…¶æ‰€æœ‰å¼•ç”¨æˆå‘˜ã€‚å› æ­¤ï¼Œå®ƒå–æ¶ˆäº† [weak searchBar = self.base] æ•è·åˆ—è¡¨é¿å…è¿™ç§æƒ…å†µçš„æ­£ç¡®æ–¹æ³•æ˜¯ï¼Œæ€»æ˜¯åœ¨æ—§çš„å®ç°ä¸­ç”¨ base æ›¿æ¢ self ï¼Œå¹¶ä¸”æ¯å½“æœ‰rx_å‰ç¼€æ—¶ï¼Œéƒ½åº”è¯¥ç”¨ rx. ä»£ç†æ›¿æ¢å®ƒã€‚Move from rx_ prefix to a rx. proxy (for swift3 update ?)","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"},{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"Rx+MVVM å®é™…åº”ç”¨","date":"2018-03-04T11:13:20.000Z","path":"2018/03/04/RxSwfit+RAC/Rx-MVVM-å®é™…åº”ç”¨/","text":"åœ¨çœ‹æ–‡ RxSwift ç›¸å…³å®˜æ–¹æ–‡æ¡£ä»¥åï¼ŒçŸ¥é“ RxSwift æä¾›çš„å¤šç§åŠŸèƒ½ä»¥åï¼Œåœ¨å®é™…åœºæ™¯ä¸­æˆ‘ä»¬è¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ å‰è¨€æœ¬ç¯‡æ–‡ç« åªè°ˆ rx åœ¨ MVVM ä¸­å¦‚ä½•ä½¿ç”¨ã€‚RxSwift çš„åŠŸèƒ½å¼ºå¤§ï¼ŒåŠ ä¸Š Apple æä¾›çš„frameworkä¹Ÿæä¾›äº†å¾ˆå¤šæ–¹å¼ï¼Œæ¥å¤„ç† MVVM ä¸­äº‹ä»¶ç›‘å¬å›è°ƒâ€¦â€¦ä½¿ç”¨ RxSwift çš„ä¼˜ç¼ºç‚¹ä¸è°ˆï¼Œå•å•è¯´ RxSwift ä»£ç é›¶æ•£åœ¨ Viewå±‚ï¼ŒViewModelå±‚å°±è®©äººå›°æ‰°ï¼Œåˆ°åº•ä»€ä¹ˆæ ·çš„äº‹ä»¶æµæ‰æ˜¯æœ€åˆé€‚çš„ï¼Œè¿™ä¸ªå› äººè€Œå¼‚ï¼Œä¸è¿‡åœ¨å›¢é˜Ÿå¼€å‘ä¸­æ¡†æ¶ä½¿ç”¨çš„æ–¹å¼è¦ç»Ÿä¸€ï¼è¿™æ ·å¯ä»¥å¤§å¤§æé«˜å¼€å‘æ•ˆç‡â€¦â€¦MVVM å¤åˆæ¨¡å¼çš„æ ·å­1234567891011ViewController * ç®¡ç†è§†å›¾å¸ƒå±€æ¸²æŸ“ * æ§åˆ¶å™¨ç”Ÿå‘½å‘¨æœŸ * æ¥å—è§†å›¾ actionsï¼Œå¹¶ä½œå‡ºç›¸åº” * æ§åˆ¶å™¨è·³è½¬ * ....ViewModel * å„ç§ Server çš„ä¸­ä»‹å™¨ * netServerï¼ŒDBServerï¼ŒOtherManagerâ€¦â€¦ * .... ä¸ºä»€ä¹ˆè¦åœ¨ MVVM ä¸­ä½¿ç”¨ RxæŠ›å»ä¸Šæ®µè¡¥å……ä¿¡æ¯ï¼Œåªå…³æ³¨event/dataçš„æµåŠ¨æ–¹å‘ï¼Œå¾—å‡ºä¸‹å›¾é‚£ä¹ˆå¯ä¸å¯ä»¥æŠŠ input/output å½“åšæ§½å£æ§½å£ï¼ï¼Œå¦‚æœçœ‹ RxSwift æºç å¯ä»¥çœ‹åˆ°å¤§é‡çš„ sink(æ°´æ§½) ç±»ï¼Œsink æ˜¯è¿æ¥å„ç§ Observable å’Œ Observer çš„ç®¡é“:Observable æµè¿›æ°´æ§½çš„æ§½å£ï¼Œæµå‡ºï¼ˆevent(data?)ï¼‰Observer æµå‡ºæ°´æ§½çš„æ§½å£ï¼Œæ¥å—ï¼ˆevent(data?)ï¼‰æ‰€ä»¥ï¼Œä½¿ç”¨ RxSwift æ¥åˆ¶ä½œ Viewå±‚å’ŒViewModel å±‚çš„æ§½å£ï¼ŒRxSwift vs äº‹ä»¶/æ•°æ®çš„æµç¨‹ vs App æµç¨‹123456protocol ViewModelType &#123; associatedtype Input associatedtype Output var input: Input &#123; get &#125; var output: Output &#123; get &#125;&#125;ä¸€ä¸ªè¯¦ç»†çš„ demo12345678910111213141516171819202122232425262728final class SayHelloViewModel: ViewModelType &#123; let input: Input let output: Output struct Input &#123; let name: AnyObserver&lt;String&gt; let validate: AnyObserver&lt;Void&gt; &#125; struct Output &#123; let greeting: Driver&lt;String&gt; &#125; private let nameSubject = ReplaySubject&lt;String&gt;.create(bufferSize: 1) private let validateSubject = PublishSubject&lt;Void&gt;() init() &#123; let greeting = validateSubject .withLatestFrom(nameSubject) .map &#123; name in return \"Hello \\(name)!\" &#125; .asDriver(onErrorJustReturn: \":-(\") self.output = Output(greeting: greeting) self.input = Input(name: nameSubject.asObserver(), validate: validateSubject.asObserver()) &#125;&#125;Subjectæ˜¯ç§æœ‰çš„ã€‚æ²¡æœ‰éæ³•ä¾µå…¥ViewModelçš„æ–¹å¼ï¼Œåªèƒ½é€šè¿‡å…¬å…±çš„Inputå’Œoutputå±æ€§ã€‚ViewModel å¯ä»¥æ’å…¥åˆ°ä»»ä½•viewï¼Œå®¹æ˜“å•å…ƒæµ‹è¯•å’ŒRxç»‘å®šã€‚view ä½¿ç”¨è¿™ç§æ–¹å¼ç»‘å®šçš„ demo cell ç›‘å¬å¤ç”¨é—®é¢˜cell å¼•ç”¨çš„ Observable tableView:cellForRowAtIndexPath: ä¸­è¢«è®¢é˜…ï¼Œè¯¥æ–¹æ³•åå¤è°ƒç”¨çš„è¿‡ç¨‹ cell ä¸ä¼šè¢«é‡Šæ”¾ï¼Œåªæ˜¯è¢«å¤ç”¨ï¼Œæ‰€ä»¥æ¯æ¬¡ cell åœ¨è¯¥æ–¹æ³•ä¸­è®¢é˜…çš„æ—¶å€™éƒ½åº”è¯¥å…ˆè§£é™¤ä¸Šä¸€æ¬¡çš„è®¢é˜…ã€‚å¦‚æœä¸è§£é™¤ï¼Œè¿™ä¸ª Observable ä¼šæœ‰å¤šä¸ªè®¢é˜…è€…é‚£ä¹ˆå¦‚ä½•æœ‰æ•ˆçš„è§£é™¤ä¸Šæ¬¡ cell å¤ç”¨äº§ç”Ÿçš„è®¢é˜…å‘¢ï¼Ÿæ€è·¯ä¸€ï¼šæœ‰ä¸‰ç§å®ç°æ–¹å¼123456789101112131415override func prepareForReuse() &#123; super.prepareForReuse()// Clean Rx subscriptions disposeBag = nil&#125;func bind(to viewModel: ViewModel) &#123; let bag = DisposeBag() nameTextField.rx .text .orEmpty .bind(to: viewModel.input.name) .disposed(by: bag) disposeBag = bag&#125;or12345override func prepareForReuse() &#123; super.prepareForReuse()// Clean Rx subscriptions disposeBag = DisposeBag()&#125;ç¬¬ä¸‰é‚£ç§ ä½¿ç”¨ swizzle cell-rx1234567891011121314extension UITableViewCell: SelfAware &#123; @objc func rx_prepareForReuse() &#123; self.rx_prepareForReuse() rx_reusableDisposeBag = DisposeBag() &#125; public class func swizzle() &#123; // make sure this isn't a subclass guard self === UITableViewCell.self else &#123; return &#125; self.swizzleMethodForSelector(#selector(self.prepareForReuse), withMethodForSelector: #selector(self.rx_prepareForReuse)) &#125; public static func awake() &#123; UITableViewCell.swizzle() &#125;&#125;or è‡ªå®šä¹‰ Rx extensionï¼Œä½¿ç”¨ takeUntil(rx.prepareReuse)å¼•ç”¨ï¼šRxSwift + MVVM: how to feed ViewModels","tags":[{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"swift è¯­æ³•å°è®°","date":"2018-02-09T13:44:00.000Z","path":"2018/02/09/swift è¯­æ³•/swift-è¯­æ³•å°è®°/","text":"Swift è¯­æ³• Swift ä¸­ä½ç§»æšä¸¾å¦‚ä½•è¡¨ç¤ºOC ä¸­ä½ç§»æšä¸¾1234567// ä½ç§»æšä¸¾typedef NS_OPTIONS(NSUInteger, Direction) &#123; Top = 1 &lt;&lt; 0, // 0000 0001, Bottom = 1 &lt;&lt; 1, // 0000 0010, Left = 1 &lt;&lt; 2, // 0000 0100, Right = 1 &lt;&lt; 3, // 0000 1000,&#125;Swiftä¸­ä½ç§»æšä¸¾,æ›¿æ¢æ–¹æ¡ˆæ˜¯é€‰é¡¹é›†åˆ(OptionSet)1234567891011121314struct Direction: OptionSet &#123; let rawValue: UInt static let top = Direction(rawValue: 1 &lt;&lt; 0) static let bottom = Direction(rawValue: 1 &lt;&lt; 1) static let left = Direction(rawValue: 1 &lt;&lt; 2) static let right = Direction(rawValue: 1 &lt;&lt; 3)&#125;åœ¨Swiftå°±ä¸å†ä½¿ç”¨ &amp;, | è¿ç®—äº†ï¼Œ å¦‚æœæƒ³ä½¿ç”¨å¤šé€‰ï¼Œéœ€è¦ç”¨æ•°ç»„ä»£æ›¿ï¼Œä¾‹å¦‚```swiftlet options: Direction = [.top, .bottom] // ä¸OCä¸­ Top | Bottom ç›¸åŒçš„ä½œç”¨options.contains(.top)options.contains(.left) Counter loop1234567891011121314151617181920212223for i in 1...10 &#123;&#125;var g = (0..&lt;10).generate()while let i = g.next() &#123;&#125;// iterate over every other integerfor i in 0.stride(to: 10, by: 2) &#123; print(i) &#125;// skip a specific numberfor i in (0..&lt;10).filter(&#123; $0 != 5 &#125;) &#123; print(i) &#125;let a = [\"one\",\"two\",\"three\",\"four\"]// ok so this oneâ€™s a bit convoluted...let everyOther = a.enumerate().filter &#123; $0.0 % 2 == 0 &#125;.map &#123; $0.1 &#125;.lazyfor s in everyOther &#123; print(s)&#125; ç¼–è¯‘ç¬¦@discardableResult1234567891011func sum(a: Int, b: Int) -&gt; Int &#123; return a + b&#125;sum(a: 1, b: 2) // Result of call to 'sum(a:b:)' is unused//è¡¨ç¤ºå–æ¶ˆä¸ä½¿ç”¨è¿”å›å€¼çš„è­¦å‘Š@discardableResult func sum(a: Int, b: Int) -&gt; Int &#123; return a + b&#125;sum(a: 1, b: 2) // No longer produce the warningåœ¨ Objective-cä¸­1- (NSString *)greeting __attribute__((warn_unused_result)); Stringä½¿ç”¨ String(describing: Class.self) æ–¹æ³• ä»£æ›¿ NSStringFromClass å¾—åˆ° ç±»çš„å­—ç¬¦ä¸² GCD once","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"}],"categories":[{"name":"å¼€å‘è¯­è¨€","slug":"å¼€å‘è¯­è¨€","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"},{"name":"swift","slug":"å¼€å‘è¯­è¨€/swift","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/swift/"}]},{"title":"Texture æµ…æ","date":"2018-02-09T08:10:24.000Z","path":"2018/02/09/Texture-æµ…æ/","text":"NodesASDisplayNode æ˜¯ UIView çš„æŠ½è±¡å±‚, å°±åƒ UIView æ˜¯ CALayer çš„æŠ½è±¡å±‚ä¸€æ ·. ä¸åŒçš„æ˜¯ UIKit åªèƒ½è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œnodes æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨åå°çº¿ç¨‹ä¸Šå¹¶è¡Œå®ä¾‹åŒ–å’Œé…ç½®å®ƒä»¬çš„æ•´ä¸ªå±‚æ¬¡ç»“æ„ã€‚ å­ç±»åŒ– è‡ªå®šä¹‰ ASDisplayNode å­ç±»å¦‚æœæƒ³ä½¿ç”¨ Textureï¼Œéœ€è¦è‡ªå®šä¹‰ç±»ç»§æ‰¿è‡ª ASDisplayNode éœ€è¦æ³¨æ„æ–¹æ³•ï¼šæ³¨æ„ï¼šUIKit ç›¸å…³å±æ€§æ–¹æ³•åªèƒ½åœ¨ main thread ä¸­ä½¿ç”¨ï¼Œæ³¨æ„ ASDisplayNode æ–¹æ³•åœ¨ main/background thread ä¸­å®ç°å¾ˆé‡è¦ASDisplayNodeæ–¹æ³•çº¿ç¨‹åŠŸèƒ½æè¿°initbackgroundè¿™ä¸ªæ–¹æ³•å¾ˆå°‘ç”¨ï¼ˆå› ä¸ºbackgroundï¼‰ï¼Œä½¿ç”¨ nodeBlocks çš„æ—¶è°ƒç”¨ï¼Œåˆå§‹åŒ–æ–¹æ³•è°ƒç”¨æ‰å¯ä»¥è°ƒç”¨å…¶ä»–æ–¹æ³•didLoadmainç±»ä¼¼ viewDidLoadï¼Œæ·»åŠ  UIKit objectsåˆå§‹åŒ–ï¼Œé…ç½®objects å±æ€§ï¼Œäº‹ä»¶â€¦â€¦layoutSpecThatFitsbackgroundå¸ƒå±€ä»£ç (è¿”å› layout spec objectå¸ƒå±€nodes)ï¼Œlayout spec object å¯¹è±¡ä¸ä¼šcacheï¼Œè€Œæ˜¯åœ¨åˆé€‚(å•¥æ—¶å€™ï¼Ÿ)çš„æ—¶å€™è°ƒç”¨é‡æ–°åˆ›å»ºlayoutmainè°ƒç”¨ super.layout æ–¹æ³•ä¼šè°ƒç”¨layoutSpecThatFitsï¼Œè¿™æ ·æ‰€æœ‰çš„ nodes éƒ½ä¼šå¸ƒå±€å®Œæˆï¼Œç±»ä¼¼ viewWillLayoutSubviews æ–¹æ³•ï¼Œå¾ˆå°‘ä½¿ç”¨ï¼Œå¦‚æœæƒ³è¿™æ ·subnode.frame = self.bounds é‚£å°±ç”¨å§ è‡ªå®šä¹‰ ASViewController å­ç±»ASViewController æ˜¯ UIViewController çš„å­ç±»ï¼Œæ‰€ä»¥ ASViewController éœ€è¦åœ¨ main thread ä¸­ä½¿ç”¨ã€‚ASViewController ç®¡ç† node å°±åƒ UIViewController ç®¡ç† view ä¸€æ ·ä½†æ˜¯ ASViewController çš„æŒ‡æ´¾æ„é€ å‡½æ•°ä¸ UIViewController ä¸åŒ1234567init() &#123; let pagerNode = ASPagerNode() super.init(node: pagerNode) pagerNode.setDataSource(self) pagerNode.setDelegate(self)&#125;-loadViewåœ¨ loadView å¦‚æœä½ ä¸æ”¹å˜ self.view çš„å€¼ï¼Œå°±å¯ä»¥ï¼Œä¸è¿‡å»ºè®®ä½ ä½¿ç”¨ viewDidLoad æ–¹æ³•. è°ƒç”¨ [super loadView] ä¼šè®¾ç½® node.view .-viewDidLoadåœ¨ ASViewController çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä¸ªæ–¹æ³•åªä¼šï¼Œåœ¨ loadView è°ƒç”¨ä»¥åç«‹å³è°ƒç”¨ä¸€æ¬¡ã€‚é‚£äº›åªä¼šè°ƒç”¨ä¸€æ¬¡çš„é…ç½®æ”¾åœ¨è¿™é‡Œæœ€å¥½ã€‚å¸ƒå±€ä»£ç ä¸åº”è¯¥æ”¾åœ¨è¿™é‡Œï¼Œå› ä¸ºå‡ ä½•å…ƒç´ æ”¹å˜è¿™ä¸ªæ–¹æ³•ä¸ä¼šè°ƒç”¨ï¼ˆå½“ç„¶å¯ä»¥åœ¨viewDidLoadä¸­é…ç½®ç›‘å¬è€…æ¨¡å¼ç›‘å¬ï¼‰-viewWillLayoutSubviewsè¯¥æ–¹æ³•ä¸ node çš„ -layout æ–¹æ³•åœ¨åŒä¸€æ—¶é—´è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨ASViewControllerçš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ã€‚åªè¦ ASViewController çš„ node çš„ bounds æ”¹å˜ï¼ˆåŒ…æ‹¬æ—‹è½¬ï¼Œåˆ†å±ï¼Œé”®ç›˜æ˜¾ç¤ºï¼‰ï¼Œä»¥åŠå±‚æ¬¡ç»“æ„å‘ç”Ÿäº†æ›´æ”¹ï¼ˆæ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹äº† childrenï¼‰ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œæœ€ä½³åšæ³•æ˜¯å°†æ‰€æœ‰å¸ƒå±€ä»£ç æ”¾å…¥æ­¤æ–¹æ³•ä¸­ã€‚å› ä¸ºå®ƒçš„è°ƒç”¨é¢‘ç‡ä¸é«˜ï¼Œæ‰€ä»¥ä¸ç›´æ¥ä¾èµ–äºå¤§å°çš„ä»£ç ä¹Ÿå±äºæ­¤å¤„ã€‚-viewWillAppear: / -viewDidDisappear:è¿™äº›æ–¹æ³•åœ¨ASViewControllerçš„nodeå‡ºç°åœ¨å±å¹•ä¸Šä¹‹å‰ï¼ˆæœ€æ—©å¯è§ï¼‰å’Œåˆšä»è§†å›¾å±‚æ¬¡ç»“æ„ä¸­åˆ é™¤ä¹‹åï¼ˆä¸å†å¯è§çš„æœ€æ—©æ—¶é—´ï¼‰è¢«è°ƒç”¨ã€‚è¿™äº›æ–¹æ³•æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šæ¥å¯åŠ¨æˆ–åœæ­¢ä¸æ§åˆ¶å™¨çš„æ¼”ç¤ºæˆ–è§£é›‡æœ‰å…³çš„åŠ¨ç”»ã€‚è¿™ä¹Ÿæ˜¯è®°å½•ç”¨æˆ·æ“ä½œçš„å¥½åœ°æ–¹ã€‚å°½ç®¡å¯ä»¥å¤šæ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•å¹¶ä¸”å¯ä»¥è·å–å‡ ä½•å›¾å½¢ä¿¡æ¯ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¸ºæ‰€æœ‰å‡ ä½•å›¾å½¢æ›´æ”¹è°ƒç”¨å®ƒä»¬ï¼Œå› æ­¤ï¼Œä¸åº”å°†å®ƒä»¬ç”¨äºæ ¸å¿ƒå¸ƒå±€ä»£ç ï¼ˆè¶…å‡ºç‰¹å®šåŠ¨ç”»æ‰€éœ€çš„è®¾ç½®ï¼‰ã€‚ å¸ƒå±€ Node æ˜¯å¦‚ä½•ç»˜åˆ¶çš„ä¸‹é¢æ˜¯ ä¸€ä¸ª swift ç‰ˆæœ¬çš„ YYAyncLayer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146public class AsyncLayer: CALayer &#123;// 1. å¤šä¸²è¡Œé˜Ÿåˆ—æ§åˆ¶threadå¹¶å‘æ•° private static let queues: [DispatchQueue] = &#123; (0 ... $0).map &#123; _ in DispatchQueue(label: \"com.lee.async.render\") &#125; &#125; (max(min(ProcessInfo().activeProcessorCount, 16), 1)) private static var current = 0 // æ‹¿åˆ°æŒ‡å®šçš„ queue åˆ†é…ä»»åŠ¡ private static var display: DispatchQueue &#123; objc_sync_enter(self) current += current == Int.max ? -current : 1 objc_sync_exit(self) return queues[current % queues.count] &#125; private var sentinel = 0 /// æ˜¯å¦å¼‚æ­¥å¤„ç† public var isAsynchronously: Bool = true public override class func defaultValue(forKey key: String) -&gt; Any? &#123; guard key == \"isAsynchronously\" else &#123; return super.defaultValue(forKey: key) &#125; return true &#125; // å¦‚æœé€šçŸ¥é‡æ–°æ¸²æŸ“äº†å°±å–æ¶ˆï¼Œå°±å–æ¶ˆå½“å‰æ¸²æŸ“ public override func setNeedsDisplay() &#123; cancel() super.setNeedsDisplay() &#125; public override func display() &#123; super.contents = super.contents display(isAsynchronously) &#125; public func cancel() &#123; objc_sync_enter(self) sentinel += 1 objc_sync_exit(self) &#125; deinit &#123; cancel() &#125;&#125;extension AsyncLayer &#123; private func display(_ async: Bool) &#123; guard let delegate = delegate as? AsyncLayerDelegate else &#123; return &#125; delegate.display(will: self) if async &#123; let size = bounds.size let opaque = isOpaque let scale = UIScreen.main.scale let background = (opaque &amp;&amp; (backgroundColor != nil)) ? backgroundColor : nil // ä½¿ç”¨é—­åŒ…æ•è·å½“å‰å€¼ï¼Œè·Ÿ self.sentinel æ¯”è¾ƒï¼Œå¦‚æœself.sentinel çš„å€¼å˜äº†ï¼Œè¯´æ˜æ¸²æŸ“å–æ¶ˆ let current = sentinel let isCancelled = &#123; return current != self.sentinel &#125; AsyncLayer.display.async &#123; [weak self] in guard let self = self else &#123; return &#125; guard !isCancelled() else &#123; return &#125; UIGraphicsBeginImageContextWithOptions(size, opaque, scale) guard let context = UIGraphicsGetCurrentContext() else &#123; return &#125; if opaque &#123;// ä¸é€æ˜ context.saveGState() let rect = CGRect(x: 0, y: 0, width: size.width * scale, height: size.height * scale) if background == nil || background?.alpha != 1 &#123; context.setFillColor(#colorLiteral(red: 1, green: 1, blue: 1, alpha: 1)) context.addRect(rect) context.fillPath() &#125; if let color = background &#123; context.setFillColor(color) context.addRect(rect) context.fillPath() &#125; context.restoreGState() &#125; delegate.display(draw: self, at: context, with: size, isCancelled: isCancelled) if isCancelled() &#123; UIGraphicsEndImageContext()// ä¸»çº¿ç¨‹ä¼šå›è°ƒæ¸²æŸ“ DispatchQueue.main.async &#123; delegate.display(did: self, with: false) &#125; return &#125; let image = UIGraphicsGetImageFromCurrentImageContext() UIGraphicsEndImageContext() if isCancelled() &#123; UIGraphicsEndImageContext() DispatchQueue.main.async &#123; delegate.display(did: self, with: false) &#125; return &#125; DispatchQueue.main.async &#123; if isCancelled() &#123; delegate.display(did: self, with: false) &#125; else &#123; self.contents = image?.cgImage delegate.display(did: self, with: true) &#125; &#125; &#125; &#125; else &#123; UIGraphicsBeginImageContextWithOptions(bounds.size, isOpaque, UIScreen.main.scale) guard let context = UIGraphicsGetCurrentContext() else &#123; return &#125; if isOpaque &#123; var size = bounds.size size.width *= contentsScale size.height *= contentsScale context.saveGState() if backgroundColor == nil || backgroundColor!.alpha &lt; 1 &#123; context.setFillColor(UIColor.white.cgColor) context.addRect(CGRect(origin: .zero, size: size)) context.fillPath() &#125; if let color = backgroundColor &#123; context.setFillColor(color) context.addRect(CGRect(origin: .zero, size: size)) context.fillPath() &#125; context.restoreGState() &#125; delegate.display(draw: self, at: context, with: bounds.size) &#123; false &#125; let image = UIGraphicsGetImageFromCurrentImageContext() UIGraphicsEndImageContext() contents = image?.cgImage delegate.display(did: self, with: true) &#125; &#125;&#125;è§¦å‘ç»˜ç”»çš„äº‹åŠ¡struct Transaction {} extension Transaction { static func commit(_ target: AnyObject, with selector: Selector) { let item = Item(target, with: selector) Transaction.configObserver waits.insert(item) } } extension Transaction { // transaction item é›†åˆï¼Œç¡®ä¿æ’å…¥äº‹åŠ¡å”¯ä¸€ private static var waits: Set&lt;Item&gt; = [] private static let configObserver: Void = { let runloop = CFRunLoopGetCurrent() // observer é€šçŸ¥ä»€ä¹ˆæ—¶å€™æ¸²æŸ“ let observer = CFRunLoopObserverCreate( kCFAllocatorDefault, CFRunLoopActivity.beforeWaiting.rawValue | CFRunLoopActivity.exit.rawValue, true, // repeat 0xFFFFFF, // after CATransaction(2000000) callback, nil ) CFRunLoopAddObserver(runloop, observer, .commonModes) } () private static let callback: CFRunLoopObserverCallBack = { _,_,_ in waits.forEach { _ = $0.target.perform($0.selector) } waits = [] } } extension Transaction { private struct Item: Hashable { let target: AnyObject let selector: Selector init(_ target: AnyObject, with selector: Selector) { self.target = target self.selector = selector } func hash(into hasher: inout Hasher) { hasher.combine(target.hash) hasher.combine(selector) } static func == (lhs: Transaction.Item, rhs: Transaction.Item) -&gt; Bool { return lhs.target === rhs.target &amp;&amp; lhs.selector == rhs.selector } } } å¼•ç”¨ï¼šTexture","tags":[{"name":"swift","slug":"swift","permalink":"https://changzw.github.io/tags/swift/"},{"name":"Texture","slug":"Texture","permalink":"https://changzw.github.io/tags/Texture/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"UI å¸ƒå±€","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/UI-å¸ƒå±€","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/UI-%E5%B8%83%E5%B1%80/"}]},{"title":"RxSwift å­¦ä¹ ç¬”è®°","date":"2018-02-06T02:08:45.000Z","path":"2018/02/06/RxSwfit+RAC/RxSwift-å­¦ä¹ ç¬”è®°/","text":"å­¦ä¹ ç›®çš„çŸ¥é“ rxswift éƒ½æœ‰ä»€ä¹ˆçŸ¥é“ä»–ä»¬éƒ½æ€ä¹ˆç”¨çŸ¥é“ä¸ºä»€ä¹ˆæœ‰è¿™äº›ä¸œè¥¿æ ¹ç±»å½’çº³æ•´ç†å¦‚ä½•è‡ªå·±æ‰©å±•é€‚å½“åˆ†ææºç  ä¸»è¦æ¦‚å¿µå¯ç›‘å¬åºåˆ—(ä¿¡å·)operator(ä¿¡å·å˜æ¢&amp;ç»„åˆ)observer(è§‚å¯Ÿè€…)è®¢é˜…ï¼ˆç»‘å®šï¼‰Disposableå–æ¶ˆè®¢é˜… å¦‚ä½•åˆ›å»ºä¿¡å· å¯ç›‘å¬åºåˆ—event12345public enum Event&lt;Element&gt; &#123; case next(Element) case error(Swift.Error) case completed &#125;1234567891011121314let numbers: Observable&lt;Int&gt; = Observable.create &#123; observer -&gt; Disposable in observer.onNext(0) observer.onNext(1) observer.onCompleted() return Disposables.create()&#125;Observable&lt;Int&gt;.just(one)Observable.of(one, two, three)Observable.from([one, two, three])Observable&lt;Void&gt;.empty()Observable&lt;Any&gt;.never()Observable&lt;Int&gt;.range(start: 1, count: 10)Observable&lt;String&gt;.create ç‰¹å¾åºåˆ— Single1234public enum SingleEvent&lt;Element&gt; &#123; case success(Element) case error(Swift.Error) &#125;å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œæˆ–â¼€ä¸ªerror äº‹ä»¶ä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤â¼€ä¸ªâ½è¾ƒå¸¸â»…çš„ä¾‹â¼¦å°±æ˜¯æ‰§â¾ HTTP è¯·æ±‚ï¼Œç„¶åè¿”å›â¼€ä¸ªåº”ç­”æˆ–é”™è¯¯ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥â½¤ Single æ¥æè¿°ä»»ä½•åªæœ‰â¼€ä¸ªå…ƒç´ çš„åºåˆ—ã€‚123456789101112131415161718192021func getRepo(_ repo: String) -&gt; Single&lt;[String: Any]&gt; &#123; return Single&lt;[String: Any]&gt;.create &#123; single in let url = URL(string: \"https://api.github.com/repos/\\(repo)\")! let task = URLSession.shared.dataTask(with: url) &#123; data, _, error in if let error = error &#123; single(.error(error)) return &#125; guard let data = data, let json = try? JSONSerialization.jsonObject(with: data, options: .mutableLeaves), let result = json as? [String: Any] else &#123; single(.error(DataError.cantParseJSON)) return &#125; single(.success(result)) &#125; task.resume() return Disposables.create &#123; task.cancel() &#125; &#125; &#125;å¯ä»¥å¯¹ Observable è°ƒâ½¤ .asSingle() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Singleã€‚ Completableæ²¡æœ‰ next æ—¶é—´å‘å‡º completed æˆ–error äº‹ä»¶ä¸ä¼šå…±äº«é™„åŠ ä½œCompletable é€‚â½¤äºé‚£ç§ä½ åªå…³â¼¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œâ½½ä¸éœ€è¦åœ¨æ„ä»»åŠ¡è¿”å›å€¼çš„æƒ…å†µã€‚å®ƒå’Œ Observableæœ‰ç‚¹ç›¸ä¼¼ã€‚1234567891011121314func cacheLocally() -&gt; Completable &#123; return Completable.create &#123; completable in // Store some data locally ... ... guard success else &#123; completable(.error(CacheError.failedCaching)) return Disposables.create &#123;&#125; &#125; completable(.completed) return Disposables.create &#123;&#125; &#125;&#125; Maybeå‘å‡ºâ¼€ä¸ªnextï¼Œcompletedæˆ–error äº‹ä»¶ä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤å¦‚æœä½ é‡åˆ°é‚£ç§å¯èƒ½éœ€è¦å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œâ¼œå¯èƒ½ä¸éœ€è¦å‘å‡ºæ—¶ï¼Œå°±å¯ä»¥ä½¿â½¤ Maybeã€‚12345678910func generateString() -&gt; Maybe&lt;String&gt; &#123; return Maybe&lt;String&gt;.create &#123; maybe in maybe(.success(\"RxSwift\")) // OR maybe(.completed) // OR maybe(.error(error)) return Disposables.create &#123;&#125; &#125; &#125;ä»¥å¯¹ Observable è°ƒâ½¤ .asMaybe() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Maybeã€‚ Driverä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ– UI å±‚çš„ä»£ç ä¸ä¼šäº§â½£ error äº‹ä»¶â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰å…±äº«é™„åŠ ä½œâ½¤ä½¿ç”¨ driver çš„åŸå› 1234567891011121314151617181920let results = query.rx.text .throttle(0.3, scheduler: MainScheduler.instance) .flatMapLatest &#123; query in fetchAutoCompleteItems(query) .observeOn(MainScheduler.instance) // ç»“æœåœ¨ä¸»çº¿ç¨‹è¿”å› .catchErrorJustReturn([]) // é”™è¯¯è¢«å¤„ç†äº†ï¼Œè¿™æ ·â¾„å°‘ä¸ä¼šç»ˆâ½Œæ•´ä¸ªåºåˆ— &#125; .share(replay: 1)// HTTP è¯·æ±‚æ˜¯è¢«å…±äº«çš„results .map &#123; \"\\($0.count)\" &#125; .bind(to: resultCount.rx.text) .disposed(by: disposeBag)results .bind(to: resultsTableView.rx.items(cellIdentifier: \"Cell\")) &#123; (_, result, cell) in cell.textLabel?.text = \"\\(result)\" &#125; .disposed(by: disposeBag)ä½¿ç”¨ drive1234567891011121314151617let results = query.rx.text.asDriver() // å°†ControlProperty è½¬æ¢ä¸º Driver .throttle(0.3, scheduler: MainScheduler.instance) .flatMapLatest &#123; query in fetchAutoCompleteItems(query) .asDriver(onErrorJustReturn: []) // ä»…ä»…æä¾›å‘â½£é”™è¯¯æ—¶çš„å¤‡é€‰è¿”å›å€¼ &#125;results .map &#123; \"\\($0.count)\" &#125; .drive(resultCount.rx.text) // è¿™â¾¥æ”¹â½¤ `drive` â½½ä¸æ˜¯ `bindTo` .disposed(by: disposeBag) // è¿™æ ·å¯ä»¥ç¡®ä¿å¿…å¤‡æ¡ä»¶éƒ½å·²ç»æ»¡â¾œäº†results .drive(resultsTableView.rx.items(cellIdentifier: \"Cell\")) &#123; (_, result, cell) in cell.textLabel?.text = \"\\(result)\" &#125; .disposed(by: disposeBag) SignalSignal å’Œ Driver ç›¸ä¼¼ï¼Œå”¯â¼€çš„åŒºåˆ«æ˜¯ï¼ŒDriver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ï¼ˆé‡æ–°å‘é€ï¼‰ä¸Šâ¼€ä¸ªå…ƒç´ ï¼Œâ½½ Signal ä¸ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ã€‚ä¸ä¼šäº§â½£ error äº‹ä»¶â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰å…±äº«é™„åŠ ä½œâ½¤â¼€èˆ¬æƒ…å†µä¸‹çŠ¶æ€åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Driver è¿™ä¸ªç±»å‹ï¼Œäº‹ä»¶åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Signal è¿™ä¸ªç±»å‹ã€‚ ControlEventControlEvent ä¸“â»”â½¤äºæè¿° UI æ§ä»¶æ‰€äº§â½£çš„äº‹ä»¶ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼šä¸ä¼šäº§â½£ error äº‹ä»¶â¼€å®šåœ¨ MainSchedulerâ¼€å®šåœ¨ MainScheduler è®¢é˜…ï¼ˆä¸»çº¿ç¨‹è®¢é˜…ï¼‰ ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰å…±äº«é™„åŠ ä½œâ½¤ è§‚å¯Ÿè€… AnyObserver ç‰¹å¾è§‚å¯Ÿè€… Binderä¸ä¼šå¤„ç†é”™è¯¯äº‹ä»¶ç¡®ä¿ç»‘å®šéƒ½æ˜¯åœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼ˆé»˜è®¤ MainSchedulerï¼‰åªå¤„ç† next äº‹ä»¶åœ¨ä»‹ç» AnyObserver æ—¶ï¼Œæˆ‘ä»¬ä¸¾äº†è¿™æ ·â¼€ä¸ªä¾‹â¼¦ï¼š123456789101112let observer: AnyObserver&lt;Bool&gt; = AnyObserver &#123; [weak self] (event) in switch event &#123; case .next(let isHidden): self?.usernameValidOutlet.isHidden = isHidden default: break &#125; &#125;usernameValid .bind(to: observer) .disposed(by: disposeBag)ç”±äºè¿™ä¸ªè§‚å¯Ÿè€…æ˜¯â¼€ä¸ª UI è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥å®ƒåœ¨å“åº”äº‹ä»¶æ—¶ï¼Œåªä¼šå¤„ç† next äº‹ä»¶ï¼Œå¹¶ä¸”æ›´æ–° UI çš„æ“ä½œéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§â¾ã€‚å› æ­¤â¼€ä¸ªæ›´å¥½çš„â½…æ¡ˆå°±æ˜¯ä½¿â½¤ Binderï¼š123456let observer: Binder&lt;Bool&gt; = Binder(usernameValidOutlet) &#123; (view, isHidden) in view.isHidden = isHidden &#125; usernameValid .bind(to: observer) .disposed(by: disposeBag)Binder å¯ä»¥åªå¤„ç† next äº‹ä»¶ï¼Œå¹¶ä¸”ä¿è¯å“åº” next äº‹ä»¶çš„ä»£ç ä¸€å®šä¼šåœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼Œè¿™â¾¥é‡‡â½¤é»˜è®¤çš„ MainSchedulerã€‚å¤ç”¨ç”±äºâ»šâ¾¯æ˜¯å¦éšè—æ˜¯â¼€ä¸ªå¸¸â½¤çš„è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥åº”è¯¥è®©æ‰€æœ‰çš„ UIView éƒ½æä¾›è¿™ç§è§‚å¯Ÿè€…ï¼š123456789101112extension Reactive where Base: UIView &#123; public var isHidden: Binder&lt;Bool&gt; &#123; return Binder(self.base) &#123; view, hidden in view.isHidden = hidden &#125; &#125; &#125;//-----usernameValid .bind(to: usernameValidOutlet.rx.isHidden) .disposed(by: disposeBag) å³ä½¿è§‚å¯Ÿåºåˆ—åˆæ˜¯è§‚å¯Ÿè€… AsyncSubject PublishSubject ReplaySubject BehaviorSubject ControlProperty RxRelay PublishRelayPublishRelay å°±æ˜¯ PublishSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError æˆ– onCompleted ã€‚ BehaviorRelayBehaviorRelay å°±æ˜¯ BehaviorSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ æ¼”ç¤º onError æˆ– onCompleted ã€‚ å¦‚ä½•é€‰æ‹©operatorObservable åˆ›å»ºäº§â½£ç‰¹å®šçš„â¼€ä¸ªå…ƒç´ ï¼šjustç»è¿‡â¼€æ®µå»¶æ—¶ï¼štimerä»â¼€ä¸ªåºåˆ—æ‹‰å–å…ƒç´ ï¼šfromé‡å¤çš„äº§â½£æŸâ¼€ä¸ªå…ƒç´ ï¼šrepeatElementå­˜åœ¨â¾ƒå®šä¹‰é€»è¾‘ï¼šcreateæ¯æ¬¡è®¢é˜…æ—¶äº§â½£ï¼šdeferredæ¯éš”â¼€æ®µæ—¶é—´ï¼Œå‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼šintervalåœ¨â¼€æ®µå»¶æ—¶åï¼štimerâ¼€ä¸ªç©ºåºåˆ—ï¼Œåªæœ‰â¼€ä¸ªå®Œæˆäº‹ä»¶ï¼šemptyâ¼€ä¸ªä»»ä½•äº‹ä»¶éƒ½æ²¡æœ‰äº§â½£çš„åºåˆ—ï¼šneverObservableç»„åˆä»»æ„â¼€ä¸ª Observable äº§â½£äº†å…ƒç´ ï¼Œå°±å‘å‡ºè¿™ä¸ªå…ƒç´ ï¼šmergeå½“ä¸Šâ¼€ä¸ª Observable æ‰èƒ½å¼€å§‹å‘å‡ºå…ƒç´ ï¼šconcatç»„åˆå¤šä¸ª Observables çš„å…ƒç´ å½“æ¯â¼€ä¸ª Observable éƒ½å‘å‡ºâ¼€ä¸ªæ–°çš„å…ƒç´ ï¼šzipå½“ä»»æ„â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªæ–°çš„å…ƒç´ ï¼šcombineLatestObservableè½¬æ¢å¯¹æ¯ä¸ªå…ƒç´ ç›´æ¥è½¬æ¢ï¼šmapè½¬æ¢åˆ°å¦â¼€ä¸ª Observable ï¼šflatMapåªæ¥æ”¶æœ€æ–°çš„å…ƒç´ è½¬æ¢çš„ Observable æ‰€äº§â½£çš„å…ƒç´ ï¼šflatMapLatestæ¯â¼€ä¸ªå…ƒç´ è½¬æ¢çš„ Observable æŒ‰é¡ºåºäº§â½£å…ƒç´ ï¼šconcatMapåŸºäºæ‰€æœ‰éå†è¿‡çš„å…ƒç´ ï¼šscanåŸºäºæ—¶é—´åºæ‹–å»¶â¼€æ®µæ—¶é—´åå†å‘å‡ºï¼šdelayæƒ³è¦å°†äº§â½£çš„äº‹ä»¶å°è£…æˆå…ƒç´ å‘é€å‡ºæ¥å°†ä»–ä»¬å°è£…æˆ Eventï¼šmaterializeç„¶åè§£å°å‡ºæ¥ï¼šdematerializeåŸºäºæ•°é‡çš„æ“ä½œå¿½ç•¥æ‰æ‰€æœ‰çš„ next äº‹ä»¶ï¼Œåªæ¥æ”¶ completed å’Œ error äº‹ä»¶ï¼šignoreElementsåˆ›å»ºâ¼€ä¸ªæ–°çš„ Observable åœ¨åŸæœ‰çš„åºåˆ—å‰â¾¯åŠ â¼Šâ¼€äº›å…ƒç´ ï¼šstartWithæˆ‘æƒ³ä» Observable ä¸­æ”¶é›†å…ƒç´ ï¼Œç¼“å­˜è¿™äº›å…ƒç´ ä¹‹ååœ¨å‘å‡ºï¼šbufferæˆ‘æƒ³å°† Observable æ‹†åˆ†æˆå¤šä¸ª Observables ï¼šwindowåŸºäºå…ƒç´ çš„å…±åŒç‰¹å¾ï¼šgroupByæˆ‘æƒ³åªæ¥æ”¶ Observable ä¸­ç‰¹å®šçš„å…ƒç´ å‘å‡ºå”¯â¼€çš„å…ƒç´ ï¼šsingleæˆ‘æƒ³é‡æ–°ä» Observable ä¸­å‘å‡ºæŸäº›å…ƒç´ é€šè¿‡åˆ¤å®šæ¡ä»¶è¿‡æ»¤å‡ºâ¼€äº›å…ƒç´ ï¼šfilterä»…å‘å‡ºå¤´â¼ä¸ªå…ƒç´ ï¼štakeä»…å‘å‡ºå°¾éƒ¨çš„â¼ä¸ªå…ƒç´ ï¼štakeLastä»…ä»…å‘å‡ºç¬¬ n ä¸ªå…ƒç´ ï¼šelementAtè·³è¿‡å¤´â¼ä¸ªå…ƒç´ è·³è¿‡å¤´ n ä¸ªå…ƒç´ ï¼šskipè·³è¿‡å¤´â¼ä¸ªæ»¡â¾œåˆ¤å®šçš„å…ƒç´ ï¼šskipWhileï¼ŒskipWhileWithIndexè·³è¿‡æŸæ®µæ—¶é—´å†…äº§â½£çš„å¤´â¼ä¸ªå…ƒç´ ï¼šskipè·³è¿‡å¤´â¼ä¸ªå…ƒç´ ç›´åˆ°å¦â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼šskipUntilåªå–å¤´â¼ä¸ªå…ƒç´ åªå–å¤´â¼ä¸ªæ»¡â¾œåˆ¤å®šçš„å…ƒç´ ï¼štakeWhileï¼ŒtakeWhileWithIndexåªå–æŸæ®µæ—¶é—´å†…äº§â½£çš„å¤´â¼ä¸ªå…ƒç´ ï¼štakeåªå–å¤´â¼ä¸ªå…ƒç´ ç›´åˆ°å¦â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼štakeUntilå‘¨æœŸæ€§çš„å¯¹ Observable æŠ½æ ·ï¼šsampleå‘å‡ºé‚£äº›å…ƒç´ ï¼Œè¿™äº›å…ƒç´ äº§â½£åçš„ç‰¹å®šçš„æ—¶é—´å†…ï¼Œæ²¡æœ‰æ–°çš„å…ƒç´ äº§â½£ï¼šdebounceç›´åˆ°å…ƒç´ çš„å€¼å‘â½£å˜åŒ–ï¼Œæ‰å‘å‡ºæ–°çš„å…ƒç´ ï¼šdistinctUntilChangedå¹¶æä¾›å…ƒç´ æ˜¯å¦ç›¸ç­‰çš„åˆ¤å®šå‡½æ•°ï¼šdistinctUntilChangedåœ¨å¼€å§‹å‘å‡ºå…ƒç´ æ—¶ï¼Œå»¶æ—¶åè¿›â¾è®¢é˜…ï¼šdelaySubscriptionæˆ‘æƒ³è¦ä»â¼€äº› Observables ä¸­ï¼Œåªå–ç¬¬â¼€ä¸ªäº§â½£å…ƒç´ çš„ Observable ï¼šambæˆ‘æƒ³è¯„ä¼° Observable çš„å…¨éƒ¨å…ƒç´ å¹¶ä¸”å¯¹æ¯ä¸ªå…ƒç´ åº”â½¤èšåˆâ½…æ³•ï¼Œå¾…æ‰€æœ‰å…ƒç´ éƒ½åº”â½¤èšåˆâ½…æ³•åï¼Œå‘å‡ºç»“æœï¼šreduceå¹¶ä¸”å¯¹æ¯ä¸ªå…ƒç´ åº”â½¤èšåˆâ½…æ³•ï¼Œæ¯æ¬¡åº”â½¤èšåˆâ½…æ³•åï¼Œå‘å‡ºç»“æœï¼šscanæˆ‘æƒ³åœ¨æŸä¸ª Scheduler åº”â½¤æ“ä½œç¬¦ï¼šsubscribeOnåœ¨æŸä¸ª Scheduler ç›‘å¬ï¼šobserveOnæˆ‘æƒ³è¦ Observable å‘â½£æŸä¸ªäº‹ä»¶æ—¶, é‡‡å–æŸä¸ªâ¾åŠ¨ï¼šdoæˆ‘æƒ³è¦ Observable å‘å‡ºâ¼€ä¸ª error äº‹ä»¶ï¼šerrorå¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰äº§â½£å…ƒç´ ï¼štimeoutæˆ‘æƒ³è¦ Observable å‘â½£é”™è¯¯æ—¶ï¼Œä¼˜é›…çš„æ¢å¤å¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰äº§â½£å…ƒç´ ï¼Œå°±åˆ‡æ¢åˆ°å¤‡é€‰ Observable ï¼štimeoutå¦‚æœäº§â½£é”™è¯¯ï¼Œå°†é”™è¯¯æ›¿æ¢æˆæŸä¸ªå…ƒç´  ï¼šcatchErrorJustReturnå¦‚æœäº§â½£é”™è¯¯ï¼Œå°±åˆ‡æ¢åˆ°å¤‡é€‰ Observable ï¼šcatchErrorå¦‚æœäº§â½£é”™è¯¯ï¼Œå°±é‡è¯• ï¼šretryæˆ‘åˆ›å»ºâ¼€ä¸ª Disposable èµ„æºï¼Œä½¿å®ƒä¸ Observable å…·æœ‰ç›¸åŒçš„å¯¿å‘½ï¼šusingæˆ‘åˆ›å»ºâ¼€ä¸ª Observable ï¼Œç›´åˆ°æˆ‘é€šçŸ¥å®ƒå¯ä»¥äº§â½£å…ƒç´ åï¼Œæ‰èƒ½äº§â½£å…ƒç´ ï¼špublishå¹¶ä¸”ï¼Œå°±ç®—æ˜¯åœ¨äº§â½£å…ƒç´ åè®¢é˜…ï¼Œä¹Ÿè¦å‘å‡ºå…¨éƒ¨å…ƒç´ ï¼šreplayå¹¶ä¸”ï¼Œâ¼€æ—¦æ‰€æœ‰è§‚å¯Ÿè€…å–æ¶ˆè§‚å¯Ÿï¼Œä»–å°±è¢«é‡Šæ”¾æ‰ï¼šrefCounté€šçŸ¥å®ƒå¯ä»¥äº§â½£å…ƒç´ äº†ï¼šconnect åŠ¨æ€ä¿¡å·1234567RACSignal *s = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123; [subscriber sendNext:@0]; [subscriber sendCompleted]; return [RACDisposable disposableWithBlock:^&#123; &#125;];&#125;]; Cocoa æ¡¥æ¥12345678910111213141516171819202122232425262728293031323334- (void) bridge &#123; RACSignal *sO = RACObserver(self, button); self.sigSetFrame = [self.button rac_signalForSelector:@selector(setFrame:)]; [_sigSetFrame subscribeNext:^(id x) &#123; NSLog(@\"setFrame:%@\", x); &#125;]; self.sigClick = [self.button rac_signalForControlEvents:UIControlEventTouchUpInside]; [_sigClick subscribeNext:^(id x) &#123; NSLog(@\"event: %@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignals:_sigClick, nil] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignalsFromArray:@[[_sigClick map:^id(id value) &#123; return @[@3]; &#125;]]] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [self rac_liftSelector:@selector(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@1)]];&#125;- (int) lift:(id)value&#123; printf(\"lift: %s\", __func__); return 1;&#125; ä¿¡å·å˜åŒ–(å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„)123[_sigClick map:^id(id value) &#123; return @[@3];&#125;]; åºåˆ—è½¬æ¢1self.sigSequence = [[RACSequence return:@3] concat:[RACSequence return:@4]].signal; è®¢é˜…ï¼ˆç»‘å®šï¼‰ä¿¡å·çš„æ–¹å¼ ç›´æ¥è®¢é˜…æ–¹æ³•1234[self.sigSample subscribeNext:^(id x) &#123; NSLog(@\"sample: %@\", x);&#125;]; ç»‘å®š1RAC(self, a) = Signal; Cocoa æ¡¥æ¥1234567891011121314151617181920- (void)signal &#123; [[self rac_liftSelector:@selector(lift:) withSignals:_sigClick, nil] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignalsFromArray:@[[_sigClick map:^id(id value) &#123; return @[@3]; &#125;]]] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [self rac_liftSelector:@selector(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@1)]];&#125;- (int) lift:(id)value&#123; printf(\"lift: %s\", __func__); return 1;&#125; ä¿¡å·å˜åŒ–&amp;ç»„åˆå•ä¸ªä¿¡å·çš„å˜åŒ–å¤šä¸ªä¿¡å·çš„ç»„åˆé«˜é˜¶æ“ä½œ å€¼æ“ä½œé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„å€¼æ“ä½œæ–¹æ³•ï¼Ÿè‡ªå·±å¦‚ä½•æ‰©å±•æ–°çš„å€¼æ–¹æ³•transform è¿™äº›ç”¨çš„æ¯”è¾ƒå¤šmapMapReplaceReduceEach tuple(a, b) -&gt; cå€¼åˆ¤æ–­é€»è¾‘å˜æ¢notandorç”¨çš„æ¯”è¾ƒå°‘reduceApply è¿™ä¸ªä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œç”¨combineLatest: reduceEach: å°±å¯ä»¥åšäº†ï¼Œè€Œä¸”ä»£ç çœ‹èµ·æ¥æ›´å¥½ã€‚materializedematerialize æ•°é‡æ“ä½œrepeat ä¸€ç›´ä¼šæœ‰å€¼æ¡ä»¶è¿‡æ»¤1ignoreignoreValuesdistinctUntilChangedæ¡ä»¶è¿‡æ»¤2takeUntilBlock:(BOOL (^)(id x))predicatetakeWhileBlock:(BOOL (^)(id x))predicate;skipUntilBlock:(BOOL (^)(id x))predicate;skipWhileBlock:(BOOL (^)(id x))predicate;æ•°é‡åˆ¤æ–­ï¼Œå¦‚æœæœ‰å€¼å°±å‘é€any;any:(BOOL (^)(id object))predicateBlock;all:(BOOL (^)(id object))predicateBlock;é‡è¯•retryretry: Countcollect æ±‡èš ä¿¡å·å¿…é¡»æœ‰è¿”å›å€¼å‰¯ä½œç”¨ï¼šâ€“ å¯¹äºä¿¡å·å€¼å˜åŒ–ä»¥å¤–çš„ä¸€äº›æ“ä½œdoNextdoCompleteddoErroræŠ˜å å‡½æ•°ä¸å¬å¯¹ä¸€ä¸ªvalue æ“ä½œï¼Œä½¿ç”¨æŠ˜å å‡½æ•°è§£å†³è¿™ä¸ªé—®é¢˜123[sig10 aggregateWithStart:@0 reduce:^id(id running, id next) &#123; return @([running intValue] + [next intValue]);&#125;];(RACSignal *)aggregateWithStart:(id)start reduce:(id (^)(id running, id next))reduceBlock;(RACSignal *)aggregateWithStart:(id)start reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;(RACSignal *)aggregateWithStartFactory:(id (^)(void))startFactory reduce:(id (^)(id running, id next))reduceBlock;(instancetype)scanWithStart:(id)startingValue reduce:(id (^)(id running, id next))reduceBlock;(instancetype)scanWithStart:(id)startingValue reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock; æ—¶é—´æ“ä½œ+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler;+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler withLeeway:(NSTimeInterval)leeway;delaythrottle é˜€é—¨ï¼Œåœ¨å›ºå®šæ—¶é—´å†…æ²¡æœ‰æ–°å€¼å‘é€çš„æ—¶å€™ï¼Œä¼šå‘é€æœ€åçš„å€¼ å¤šä¸ªä¿¡å·ç»„åˆé—®é¢˜ï¼šå—å“ªä¸ªä¿¡å·ç»ˆæ­¢è€Œç»ˆæ­¢ï¼Ÿé”™è¯¯ä¼ é€’ï¼Ÿå„ä¸ªä¿¡å·ä½•æ—¶å¼€å§‹å¼€å§‹è®¢é˜…ï¼Ÿåœ¨å“ªä¸ªçº¿ç¨‹å‘å‡ºï¼Ÿconcatç¬¬ä¸€ä¸ªç»“æŸåï¼Œè®¢é˜…ç¬¬äºŒä¸ªç¬¬ä¸€ä¸ªerror åï¼Œå°±ç›´æ¥ errormergezipcombineLatestsampletakeUntiltakeUntilReplacement, å½“ B æ¥äº†ç›´æ¥æ›¿æ¢ Aï¼Œå¼€å§‹è®¢é˜… B ä¿¡å·çš„é«˜é˜¶æ“ä½œï¼ˆå‡é˜¶é™é˜¶ï¼‰å‡é˜¶ S(v) -&gt; S(s(v))é™é˜¶ S(s(v)) -&gt; S(v)1234RACSignal *signal = @[@1, @2, @3, @4].rac_sequence.signal;RACSignal *signalB = [[signal map:^id(id value) &#123; return [[RACSignal return:value] delay:1];&#125;] concat];é™é˜¶æ“ä½œswitchToLatestsif/then/elseswitch/cases/defaultflattenflatten ç±»ä¼¼ merge åªä¸è¿‡ä¸€ä¸ªæ˜¯æ¥æ”¶çš„ valueæ˜¯ signalï¼Œå¦ä¸€ä¸ªæ¥æ”¶çš„å°±æ˜¯ valueflatten:count æŒ‰ä¸ªæ•°å±•å¼€ä¿¡å·ï¼Œå½“ä¿¡å·ä¸ªæ•° &gt; count ä»¥åç­‰å¾…ï¼Œå¦‚æœæœ‰ sig completedï¼Œé‚£ä¹ˆæŠŠç­‰å¾…ä¸­çš„sig æ”¾å…¥å±•å¼€æ•°ç»„é‡Œé¢flatten:1 == concatflattenMapæ»¡è¶³ monad çš„éƒ¨åˆ†å®šä¹‰ï¼Œç»å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ flattenMap å®ç°bindå¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ bind å®ç° å†·ä¿¡å·&amp;çƒ­ä¿¡å· ä¸€äº›ä¹ é¢˜å¦‚ä½•è·å¾—æ— é™é€’å¢çš„ä¿¡å·12345678RACSignal *increment(int inc) &#123; RACSignal *repeat = [[RACSignal return:@(inc)] repeat]; return [[repeat scanWithStart:0 reduce:^id(id running, id next) &#123; return @([running intValue] + [next intValue]); &#125;] delay:1];&#125;fibonacci1234567RACSignal *fibonacci() &#123; RACSignal *repeat = [[RACSignal return:nil] repeat]; return [repeat scanWithStart:RACTuplePack(@1, @1) reduce:^id(RACTuple *running, id _) &#123; int next = [running.first intValue] + [running.second intValue]; return RACTuplePack(running.second, @(next)); &#125;];&#125;","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxSwift 4.Action","date":"2018-02-03T12:27:31.000Z","path":"2018/02/03/RxSwfit+RAC/RxSwift-Action/","text":"åŸæ–‡ï¼šActionè¯¥åº“ä¸RxSwiftä¸€èµ·ä½¿ç”¨ï¼Œä»¥åœ¨å¯è§‚å¯Ÿå¯¹è±¡ä¹‹ä¸Šæä¾›æŠ½è±¡ï¼šActionã€‚Action æ˜¯è¯´â€œå˜¿ï¼Œç¨åæˆ‘éœ€è¦ä½ è®¢é˜…æ­¤å†…å®¹â€çš„ä¸€ç§æ–¹å¼ã€‚å®é™…ä¸Šï¼Œå®ƒæ¶‰åŠçš„æ›´å¤šã€‚Action åˆå§‹åŒ–æ—¶éœ€è¦ workFactory: ä¸€ä¸ªéœ€è¦ä¸€äº›è¾“å…¥å¹¶äº§ç”Ÿå¯è§‚å¯Ÿå€¼çš„é—­åŒ…ã€‚è°ƒç”¨ execute() æ—¶ï¼Œå®ƒå°†å‚æ•°ä¼ é€’ç»™æ­¤é—­åŒ…å¹¶è®¢é˜…å·¥ä½œã€‚åªæœ‰åœ¨â€œenabledâ€æ—¶æ‰å¯ä»¥æ‰§è¡Œï¼ˆå¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä¸ºtrueï¼‰ä¸€æ¬¡åªæ‰§è¡Œä¸€ä»¶äº‹ã€‚æ±‡æ€»å„ä¸ªæ‰§è¡Œä¸­çš„ next/error äº‹ä»¶Action å’Œ UIButton é…åˆä½¿ç”¨ã€‚å®ƒç®¡ç†æŒ‰é’®çš„ enable çŠ¶æ€ï¼Œç¡®ä¿åœ¨å·¥ä½œå®Œæˆæ—¶ç¦ç”¨æŒ‰é’® å¦‚ä½•ä½¿ç”¨å¿…é¡»ä¼ é€’ä¸€ä¸ª workFactory ï¼Œè¯¥å·¥å‚æ¥å—è¾“å…¥å¹¶è¿”å›ä¸€ä¸ª Observableæ¯å½“ä½ è°ƒç”¨ execute(input)ï¼Œä½ ä¼ å…¥çš„ input ä¼ å…¥åˆ° workFactory æ‰§è¡Œè¯¥ Action è®¢é˜… Observable å¯¹è±¡ï¼Œç„¶ååœ¨ Action çš„ elements å±æ€§ä¸Šå‘ Observable çš„ Nextäº‹ä»¶å¦‚æœ Observable å‘å‡º event äº‹ä»¶ï¼Œè¿™ä¸ª error ä¼šä»¥ next äº‹ä»¶åœ¨ Action çš„ errors å±æ€§ä¸­ä»¥ next äº‹ä»¶å‘å‡ºActions æ¯æ¬¡åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœä½ å°è¯•æ‰§è¡Œä¸€ä¸ªæ­£åœ¨ executing çš„ actionï¼Œä¼šå¾—åˆ°ä¸€ä¸ª errorã€‚Action çš„ executing å±æ€§ä¼šå‘é€ next äº‹ä»¶ï¼Œå…³è”å€¼æ˜¯ ture or false12345action: Action&lt;String, Bool&gt; = Action(workFactory: &#123; input in return networkLibrary.checkEmailExists(input)&#125;)...action.execute(\"ash@ashfurrow.com\")æ³¨æ„ï¼šç¬¬ä¸€ä¸ªæ³›å‹å‚æ•°æ˜¯ input çš„ç±»å‹ã€‚ç¬¬äºŒä¸ªæ³›å‹æ˜¯ workFactory é—­åŒ…åˆ›å»ºçš„ Observable å‘é€ next äº‹ä»¶çš„æ•°æ®ç±»å‹ï¼ˆä½ å¯ä»¥æŠŠå®ƒçœ‹åš Action çš„Outputï¼‰è¿˜å¯ä»¥ä¸º Action åˆå§‹åŒ–ç¨‹åºæŒ‡å®š enabledIf å‚æ•°ã€‚1234let validEmailAddress = emailTextField.rx.text.map(isValidEmail)action: Action&lt;String, Bool&gt; = Action(enabledIf: validEmailAddress, workFactory: &#123; input in return networkLibrary.checkEmailExists(input)&#125;)æ­¤æ—¶ execute() åªæœ‰å½“ email address åˆæ³•æ‰ä¼šæ‰§è¡Œ.æ³¨æ„ï¼Œ enabledIf ä¸ enabled å±æ€§ä¸åŒã€‚UIButton æ‰©å±•ï¼šå®ƒæ¥å—CocoaActionï¼Œå®ƒçš„ç±»å‹æ˜¯ Action &lt;Voidï¼ŒVoid&gt;ã€‚1button.rx.action = actionå½“æŒ‰ä¸‹æŒ‰é’®æ—¶ï¼Œaction æ‰§è¡Œæ“ä½œã€‚button çš„ enable å±æ€§å’Œ action çš„ enabled å±æ€§ç»‘å®šã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†è¡¨å•éªŒè¯é€»è¾‘ä½œä¸ºä¿¡å·è¾“å…¥åˆ° action ä¸­ï¼Œå¹¶ä¸ºä½ å¤„ç†æŒ‰é’®çš„å¯ç”¨çŠ¶æ€ã€‚åŒæ ·ï¼Œç”¨æˆ·ä¸èƒ½åœ¨åŠ¨ä½œå®Œæˆæ‰§è¡Œä¹‹å‰å†æ¬¡æŒ‰ä¸‹æŒ‰é’®ï¼Œå› ä¸ºå®ƒä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä»¶äº‹ã€‚çœ‹çœ‹è¿™ä¸ªå®é™…çš„CocoaActionä»£ç ç¤ºä¾‹ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ Action è¿›è¡Œå¤æ‚çš„æ“ä½œï¼Œä¾‹å¦‚ä½¿ç”¨ä¸‹è½½è¿›åº¦æŠ¥å‘Šä¸‹è½½æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°UIä¸­çš„è¿›åº¦æ¡ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ Action&lt;Voidï¼ŒInt&gt; ä»£æ›¿CocoaActionã€‚å¼€ç®±å³ç”¨çš„CocoaActionæ— æ³•å‘å‡ºè¿›åº¦å€¼ï¼Œä½ è‡ªå·±çš„ Action&lt;Voidï¼ŒInt&gt; å°†åšåˆ°è¿™ä¸€ç‚¹ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æœ¬æ–‡ã€‚å¦‚æœä½ çš„æ–¹æ¡ˆæ¶‰åŠè®¸å¤šéœ€è¦è§¦å‘åŒä¸€æ“ä½œä»¥æä¾›ä¸åŒè¾“å…¥çš„æŒ‰é’®ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªUIButtonä¸Šä½¿ç”¨bindToï¼Œå¹¶ä½¿ç”¨é—­åŒ…è¿”å›æ­£ç¡®çš„è¾“å…¥ã€‚12345678let button1 = UIButton()let button2 = UIButton()let action = Action&lt;String, String&gt; &#123; input in print(input) return .just(input)&#125;button1.rx.bindTo(action) &#123; _ in return \"Hello\"&#125;button2.rx.bindTo(action) &#123; _ in return \"Goodbye\"&#125;button1å’Œbutton2å…±äº«ç›¸åŒçš„Actionï¼Œä½†æ˜¯å®ƒä»¬ä½¿ç”¨ä¸åŒçš„è¾“å…¥ï¼ˆç›¸åº”çš„è¾“å‡ºHelloå’ŒGoodbyeï¼‰æ›´å¤æ‚çš„ç”¨ä¾‹å¯ä»¥æ˜¯ä¸UIViewControllerç›¸å…³çš„å•ä¸ªæ“ä½œï¼Œè¯¥æ“ä½œç®¡ç†ä½ çš„å¯¼èˆªï¼Œé”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‹¥æœ‰ä»»æ„æ•°é‡çš„ UIButtonï¼ˆæˆ–UIBarButtonItemsï¼‰ï¼Œåœ¨ä¸€ä¸ªå…¬å…±ä½ç½®ä¸€æ¬¡æ€§è®¢é˜… executing ï¼Œerrors å’Œ elementsã€‚UIAlertController è¿˜ä½¿ç”¨äº†ä¸€ä¸ªéå¸¸é…·çš„ UIAlertAction æ‰©å±•ã€‚ä¸€æ‹›ï¼šç”±äºè¯¥ç±»çš„é™åˆ¶ï¼Œä½ æ— æ³•ä½¿ç”¨å¸¸è§„çš„åˆå§‹åŒ–ç¨‹åºå®ä¾‹åŒ–å®ƒã€‚ç›¸åï¼Œè¯·è°ƒç”¨æ­¤ç±»æ–¹æ³•ï¼š1let action = UIAlertAction.Action(\"Hi\", style: .default)","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxSwift 3.Subject(Observable & Observer)","date":"2018-02-02T10:33:57.000Z","path":"2018/02/02/RxSwfit+RAC/RxSwift-3-Subject(Observable&Observer)/","text":"é¦–å…ˆåœ¨å¼€å‘çš„æ—¶å€™æ€è€ƒï¼Œä»–æ˜¯ä¸€ä¸ª Observable AsyncSubjectç‰¹ç‚¹ï¼šå½“ Observable Sequence å‘é€ complete äº‹ä»¶ï¼ŒAsyncSubject æ‰ä¼šå‘é€æœ€åä¸€ä¸ª next äº‹ä»¶å’Œ completeå½“ Observable Sequence å‘é€ error äº‹ä»¶ï¼ŒAsyncSubject åªå‘é€ error äº‹ä»¶ï¼Œä¸ä¼šå‘é€æœ€åä¸€ä¸ª next2. æ¼”ç¤º 123456789let disposeBag = DisposeBag() let subject = AsyncSubject&lt;String&gt;()subject .subscribe &#123; print(\"Subscription: 1 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\" \")subject.onNext(\" \")subject.onNext(\" \")subject.onCompleted() è¾“å‡ºç»“æœï¼š 12Subscription: 1 Event: next(Î¯ )Subscription: 1 Event: completed PublishSubjectç‰¹ç‚¹ï¼šPublishSubject å‘é€è®¢é˜…åäº§â½£çš„å…ƒç´ .PublishSubject ä¸å‘é€è®¢é˜…å‰äº§â½£çš„å…ƒç´ .2. æ¼”ç¤º 123456789101112let disposeBag = DisposeBag()let subject = PublishSubject&lt;String&gt;()subject .subscribe &#123; print(\"Subscription: 1 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\" \")subject.onNext(\" \")subject .subscribe &#123; print(\"Subscription: 2 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\"A \")subject.onNext(\"B \") 123456Subscription: 1 Event: next( )Subscription: 1 Event: next( )Subscription: 1 Event: next(A )Subscription: 2 Event: next(A )Subscription: 1 Event: next(B )Subscription: 2 Event: next(B ) ReplaySubjectç‰¹ç‚¹ï¼šReplaySubject å°†å¯¹è§‚å¯Ÿè€…å‘é€å…¨éƒ¨çš„å…ƒç´ ï¼Œâ½†è®ºè§‚å¯Ÿè€…æ˜¯ä½•æ—¶è¿›â¾è®¢é˜…çš„ã€‚2. æ¼”ç¤º 123456789101112let disposeBag = DisposeBag()let subject = ReplaySubject&lt;String&gt;.create(bufferSize: 1)subject .subscribe &#123; print(\"Subscription: 1 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\" \")subject.onNext(\" \")subject .subscribe &#123; print(\"Subscription: 2 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\"A \")subject.onNext(\"B \") 1234567Subscription: 1 Event: next( ) Subscription: 1 Event: next( ) Subscription: 2 Event: next( )Subscription: 1 Event: next(A )Subscription: 2 Event: next(A )Subscription: 1 Event: next(B )Subscription: 2 Event: next(B ) BehaviorSubjectç‰¹ç‚¹ï¼šå…·æœ‰é»˜è®¤å€¼å½“è®¢é˜… BehaviorSubject æ—¶ï¼Œå®ƒä¼šå°†æº Observable ä¸­æœ€æ–°çš„å…ƒç´ å‘é€å‡ºæ¥ï¼ˆå¦‚æœä¸å­˜åœ¨æœ€æ–°çš„å…ƒç´ ï¼Œå°±å‘å‡ºé»˜è®¤å…ƒç´ ï¼‰ã€‚ç„¶åå°†éšåäº§â½£çš„å…ƒç´ å‘é€å‡ºæ¥ã€‚å¦‚æœ Observable å‘ error äº‹ä»¶ï¼Œé‚£ä¹ˆBehaviorSubjectä¸ä¼šå†å‘é€ next äº‹ä»¶ï¼Œè€Œåªæ˜¯ä¼ é€’æ¥è‡ªæº Observable çš„ error äº‹ä»¶ã€‚normalerror2. æ¼”ç¤º 12345678910111213141516171819let disposeBag = DisposeBag()let subject = BehaviorSubject(value: \" \")subject .subscribe &#123; print(\"Subscription: 1 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\" \") subject.onNext(\" \") subject .subscribe &#123; print(\"Subscription: 2 Event:\", $0) &#125; .disposed(by: disposeBag)subject.onNext(\"A \") subject.onNext(\"B \") subject .subscribe &#123; print(\"Subscription: 3 Event:\", $0) &#125; .disposed(by: disposeBag) subject.onNext(\" \") subject.onNext(\" \") 123456789101112131415Subscription: 1 Event: next( )Subscription: 1 Event: next( )Subscription: 1 Event: next( )Subscription: 2 Event: next( )Subscription: 1 Event: next(A )Subscription: 2 Event: next(A )Subscription: 1 Event: next(B )Subscription: 2 Event: next(B )Subscription: 3 Event: next(B )Subscription: 1 Event: next( )Subscription: 2 Event: next( )Subscription: 3 Event: next( )Subscription: 1 Event: next( )Subscription: 2 Event: next( )Subscription: 3 Event: next( ) Variableï¼ˆå¼ƒç”¨ï¼‰åœ¨ RxSwift 5.x ä¸­ï¼Œä»–è¢«å®˜â½…çš„æ­£å¼çš„å¼ƒâ½¤äº†ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶ï¼Œæ¨èä½¿â½¤ BehaviorRelay æˆ–è€… BehaviorSubjectã€‚ RelayRxRelayæä¾›ä¸¤ç§ä¸­ç»§ï¼šPublishRelay å’Œ BehaviorRelayã€‚å®ƒä»¬çš„è¡Œä¸ºä¸å¯¹åº”çš„ Subjects å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸¤ä¸ªå˜åŒ–ï¼šRelays never complete.Relays never emit errors.æœ¬è´¨ä¸Šï¼Œä¸­ç»§ä»…å‘å‡º.nextäº‹ä»¶ï¼Œå¹¶ä¸”æ°¸ä¸ç»ˆæ­¢ï¼Œæœ‰äº†ä»–ï¼Œæˆ‘ä»¬å°† API è½¬åŒ–ä¸º Rx æ ·å¼æ—¶ï¼Œå°±ä¸å¿…æ‹…â¼¼â¼€ä¸ªæ„å¤–çš„ç»ˆâ½Œäº‹ä»¶ï¼Œå¯¼è‡´åç»­äº‹ä»¶è½¬å‘å¤±æ•ˆã€‚ PublishRelayPublishRelay å°±æ˜¯ PublishSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError å’Œ onCompletedã€‚ç¤ºä¾‹ï¼š1234567891011let disposeBag = DisposeBag() let relay = PublishRelay&lt;String&gt;() relay .subscribe &#123; print(\"Event:\", $0) &#125; .disposed(by: disposeBag)relay.accept(\" \")relay.accept(\" \")// outputEvent: next( )Event: next( ) BehaviorRelayBehaviorRelay å°±æ˜¯ BehaviorSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError å’Œ onCompletedã€‚ç¤ºä¾‹ï¼š123456789101112let disposeBag = DisposeBag() let relay = BehaviorRelay(value: \" \")relay .subscribe &#123; print(\"Event:\", $0) &#125; .disposed(by: disposeBag)relay.accept(\" \")relay.accept(\" \")// outputEvent: next( )Event: next( )Event: next( )","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxSwift 2.Observer","date":"2018-02-02T06:47:35.000Z","path":"2018/02/02/RxSwfit+RAC/RxSwift-Observer/","text":"Observer: ç›‘å¬ Observable Sequenceï¼Œæ¥å—å®ƒä¼ æ¥çš„ events å¦‚ä½•åˆ›å»º Observer Observable çš„ subscribe æ–¹æ³•åˆ›å»ºè§‚å¯Ÿè€…æœ€ç›´æ¥çš„â½…æ³•å°±æ˜¯åœ¨ Observable çš„ subscribe â½…æ³•åâ¾¯æè¿°ï¼Œäº‹ä»¶å‘â½£æ—¶ï¼Œéœ€è¦å¦‚ ä½•åšå‡ºå“åº”ã€‚1234567tap.subscribe(onNext: &#123; [weak self] in self?.showAlert() &#125;, onError: &#123; error in print(\"å‘â½£é”™è¯¯ï¼š \\(error.localizedDescription)\") &#125;, onCompleted: &#123; print(\"ä»»åŠ¡å®Œæˆ\")&#125;)subscribe æ–¹æ³•å†…éƒ¨ä¼šäº§ç”Ÿ AnonymousObserver å¯¹è±¡ï¼ˆRxSwift åº“ç§æœ‰çš„ï¼‰1234567public func subscribe(_ on: @escaping (Event&lt;Element&gt;) -&gt; Void) -&gt; Disposable &#123; let observer = AnonymousObserver &#123; e in on(e) &#125; return self.asObservable().subscribe(observer)&#125; AnyObserver-- ä»»æ„è§‚å¯Ÿè€…ç±»æ³¨é‡Šï¼šA type-erased ObserverType.å°†æ“ä½œè½¬å‘åˆ°å…·æœ‰ç›¸åŒ Element ç±»å‹çš„ä»»æ„åŸºç¡€è§‚å¯Ÿè€…ï¼Œéšè—åŸºç¡€è§‚å¯Ÿè€…ç±»å‹çš„ç»†èŠ‚ã€‚AnyObserver å¯ä»¥â½¤æ¥æå™ä»»æ„â¼€ç§è§‚å¯Ÿè€…ã€‚eg: æ‰“å°â½¹ç»œè¯·æ±‚ç»“æœï¼š1234567URLSession.shared.rx.data(request: URLRequest(url: url)) .subscribe(onNext: &#123; data in print(\"Data Task Success with count: \\(data.count)\") &#125;, onError: &#123; error in print(\"Data Task Error: \\(error)\") &#125;) .disposed(by: disposeBag)å¯ä»¥çœ‹ä½œæ˜¯ï¼š1234567891011121314let observer: AnyObserver&lt;Data&gt; = AnyObserver &#123; (event) in switch event &#123; case .next(let data): print(\"Data Task Success with count: \\(data.count)\") case .error(let error): print(\"Data Task Error: \\(error)\") default: break &#125; &#125;URLSession.shared.rx.data(request: URLRequest(url: url)) .subscribe(observer) .disposed(by: disposeBag)â½¤æˆ·åæç¤ºè¯­æ˜¯å¦éšè—ï¼š123usernameValid .bind(to: usernameValidOutlet.rx.isHidden) .disposed(by: disposeBag)å¯ä»¥çœ‹ä½œæ˜¯ï¼š123456789101112let observer: AnyObserver&lt;Bool&gt; = AnyObserver &#123; [weak self] (event) in switch event &#123; case .next(let isHidden): self?.usernameValidOutlet.isHidden = isHidden default: break &#125; &#125;usernameValid .bind(to: observer) .disposed(by: disposeBag) Binderâ€“UI è§‚å¯Ÿè€…ç±»æ³¨é‡Šï¼šå¼ºåˆ¶æ‰§è¡Œæ¥å£ç»‘å®šè§„åˆ™çš„è§‚å¯Ÿè€…:æ— æ³•ç»‘å®šé”™è¯¯ï¼ˆåœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ï¼Œé”™è¯¯çš„ç»‘å®šä¼šå¯¼è‡´è‡´å‘½é”™è¯¯ï¼Œåœ¨å‘å¸ƒç‰ˆæœ¬ä¸­çš„é”™è¯¯ä¼šè¢«è®°å½•ï¼‰ç¡®ä¿åœ¨ç‰¹å®šçš„è°ƒåº¦ç¨‹åºä¸Šæ‰§è¡Œç»‘å®šBinder ä¸ä¼šä¿ç•™ç›®æ ‡ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾ç›®æ ‡çš„æƒ…å†µä¸‹ï¼Œå…ƒç´ ä¹Ÿä¸ä¼šç»‘å®šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒç»‘å®šä¸»è°ƒåº¦ç¨‹åºä¸Šçš„å…ƒç´ Binder ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹å¾ï¼šå¤„ç† next äº‹ä»¶ä¸å¤„ç†é”™è¯¯äº‹ä»¶ç¡®ä¿ç»‘å®šéƒ½æ˜¯åœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼ˆé»˜è®¤ MainSchedulerï¼‰â¼€æ—¦äº§â½£é”™è¯¯äº‹ä»¶ï¼Œåœ¨è°ƒè¯•ç¯å¢ƒä¸‹å°†æ‰§â¾ fatalErrorï¼Œåœ¨å‘å¸ƒç¯å¢ƒä¸‹å°†æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚ç¤ºä¾‹ï¼Œå¯¹æ¯”ä¸Šé¢çš„ AnyObserverç¤ºä¾‹ç”±äºè¿™ä¸ªè§‚å¯Ÿè€…æ˜¯â¼€ä¸ª UI è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥å®ƒåœ¨å“åº”äº‹ä»¶æ—¶ï¼Œåªä¼šå¤„ç† next äº‹ä»¶ å¹¶ä¸”æ›´æ–° UI çš„æ“ä½œéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§â¾ã€‚ å› æ­¤â¼€ä¸ªæ›´å¥½çš„â½…æ¡ˆå°±æ˜¯ä½¿â½¤ Binderï¼š1234567let observer: Binder&lt;Bool&gt; = Binder(usernameValidOutlet) &#123; (view, isHidden) in view.isHidden = isHidden &#125;usernameValid .bind(to: observer) .disposed(by: disposeBag)RxCocoa ä¸­çš„ rx æ‰©å±•å¯¹äº Binder çš„ä½¿ç”¨ï¼šä½ ä¹Ÿå¯ä»¥â½¤è¿™ç§â½…å¼æ¥åˆ›å»ºâ¾ƒå®šä¹‰çš„ UI è§‚å¯Ÿè€…ã€‚1234567extension Reactive where Base: UIView &#123; public var isHidden: Binder&lt;Bool&gt; &#123; return Binder(self.base) &#123; view, hidden in view.isHidden = hidden &#125; &#125; &#125;1234567extension Reactive where Base: UILabel &#123; public var text: Binder&lt;String?&gt; &#123; return Binder(self.base) &#123; label, text in label.text = text &#125; &#125; &#125;å¼•ç”¨ï¼šObserver - è§‚å¯Ÿè€…","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"Hot å’Œ Cold Observables","date":"2018-02-02T03:05:12.000Z","path":"2018/02/02/RxSwfit+RAC/Hot-å’Œ-Cold-Observables/","text":"åŸæ–‡: Hot and Cold Observablesæ•æˆ‘ç›´è¨€ï¼Œæˆ‘å»ºè®®æ›´å¤šåœ°å°†å…¶è§†ä¸ºåºåˆ—çš„å±æ€§ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬ç”±å®Œå…¨é€‚åˆå®ƒä»¬çš„ç›¸åŒæŠ½è±¡è¡¨ç¤ºï¼Œå³å¯è§‚å¯Ÿåºåˆ—ã€‚è¿™æ˜¯ReactiveX.ioçš„å®šä¹‰:Observableä½•æ—¶å¼€å§‹å‘å‡ºå…¶é¡¹ç›®åºåˆ—ï¼Ÿè¿™å–å†³äº Observable.â€œhotâ€ Observable å¯¹è±¡å¯èƒ½ä¼šåœ¨åˆ›å»ºåç«‹å³å¼€å§‹å‘å°„é¡¹ç›®ï¼Œå› æ­¤ä»¥åè®¢é˜…è¯¥ Observable å¯¹è±¡çš„ä»»ä½•è§‚å¯Ÿè€…éƒ½å¯ä»¥å¼€å§‹è§‚å¯Ÿä¸­é—´ä½ç½®çš„åºåˆ—ã€‚â€œcoldâ€Observableå¯¹è±¡è¦ç­‰åˆ°è§‚å¯Ÿè€…è®¢é˜…å®ƒï¼Œç„¶åæ‰èƒ½å¼€å§‹å‘å°„é¡¹ç›®ï¼Œå› æ­¤å¯ä»¥ä¿è¯è¿™æ ·çš„è§‚å¯Ÿè€…ä»ä¸€å¼€å§‹å°±å¯ä»¥çœ‹åˆ°æ•´ä¸ªåºåˆ—ã€‚Hot ObservablesCold observablesâ€¦ are sequencesâ€¦ are sequencesUse resources (â€œproduce heatâ€) no matter if there is any observer subscribed.Donâ€™t use resources (donâ€™t produce heat) until observer subscribes.Variables / properties / constants, tap coordinates, mouse coordinates, UI control values, current timeAsync operations, HTTP Connections, TCP connections, streamsUsually contains ~ N elementsUsually contains ~ 1 elementSequence elements are produced no matter if there is any observer subscribed.Sequence elements are produced only if there is a subscribed observer.Observable Sequence è¢«å¤šä¸ªè®¢é˜…å®ƒçš„ observers å…±äº«æ¯ä¸ªè®¢é˜…çš„ observer éƒ½ä¼šæœ‰ä¸€ä¸ª Observable SequenceUsually statefulUsually stateless","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RAC","slug":"RAC","permalink":"https://changzw.github.io/tags/RAC/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxSwift 1.ç‰¹å¾","date":"2018-01-31T12:32:57.000Z","path":"2018/01/31/RxSwfit+RAC/RxSwift-ç‰¹å¾/","text":"ç‰¹æ€§å®Œå…¨æ˜¯å¯é€‰çš„ã€‚ä½ å¯ä»¥è‡ªç”±åœ°åœ¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨åŸå§‹çš„Observableåºåˆ—ï¼Œå› ä¸ºæ‰€æœ‰æ ¸å¿ƒRxSwift / RxCocoa APIéƒ½æ”¯æŒå®ƒä»¬ã€‚ ç‰¹å¾æ˜¯å¦‚ä½•å·¥ä½œçš„ç‰¹æ€§åªæ˜¯ Observable sequence çš„åŒ…è£…å™¨ç»“æ„ã€‚ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºå¯è§‚å¯Ÿåºåˆ—çš„ä¸€ç§æ„å»ºå™¨æ¨¡å¼å®ç°ã€‚æ„å»ºç‰¹è´¨åï¼Œè°ƒç”¨.asObservable() ä¼šå°†å…¶è½¬æ¢å›åŸå§‹çš„å¯è§‚å¯Ÿåºåˆ—ã€‚1234567struct Single&lt;Element&gt; &#123; let source: Observable&lt;Element&gt;&#125;struct Driver&lt;Element&gt; &#123; let source: Observable&lt;Element&gt;&#125; å¯è§‚å¯Ÿåºåˆ—Observable Sequence: å®ƒæ˜¯ä¿¡å·æºï¼Œäº§ç”Ÿäº‹ä»¶ï¼ŒRxSwift é‡è§† Observable&lt;T&gt; ç±»ã€‚ä¸‹é¢ä»‹ç»çš„å‡ ä¸ªç±»å‹éƒ½æ˜¯åœ¨ Observable&lt;T&gt; ç±»çš„åŸºç¡€ä¸Šå®šåˆ¶åŒ–å‡ºæ¥çš„ç‰¹å¾åºåˆ—ã€‚Observable&lt;T&gt; å¯å‘é€å‡ºæ¥çš„äº‹ä»¶ç±»å‹12345public enum Event&lt;Element&gt; &#123; case next(Element) case error(Swift.Error) case completed &#125; RxSwift ç‰¹å¾ Single/Completable/Maybe SingleSingle åªèƒ½å‘é€ä¸¤ä¸ªäº‹ä»¶123456public enum SingleEvent&lt;Element&gt; &#123; /// One and only sequence element is produced. (underlying observable sequence emits: `.next(Element)`, `.completed`) case success(Element) /// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`) case error(Swift.Error)&#125;åœ¨ Single çš„åˆå§‹åŒ–ä¸­å¯ä»¥çœ‹åˆ°åšäº† SingleEvent -&gt; Event çš„å¤„ç†1234567891011121314public static func create(subscribe: @escaping (@escaping SingleObserver) -&gt; Disposable) -&gt; Single&lt;Element&gt; &#123; let source = Observable&lt;Element&gt;.create &#123; observer in return subscribe &#123; event in switch event &#123; case .success(let element): observer.on(.next(element)) observer.on(.completed) case .error(let error): observer.on(.error(error)) &#125; &#125; &#125; return PrimitiveSequence(raw: source)&#125;åœ¨ .success äº‹ä»¶ä¸­ï¼ŒSingle å‘é€äº†ä¸€ä¸ª .next åç´§è·Ÿç€åˆå‘é€äº† .completed äº‹ä»¶ï¼Œæ‰€ä»¥:success - äº§â½£â¼€ä¸ªå•ç‹¬çš„å…ƒç´ error - äº§â½£â¼€ä¸ªé”™è¯¯ä¸ä¼šå…±äº«é™„åŠ ä½œç”¨Single å®é™…åœºæ™¯ï¼šSingle çš„ä¾‹â¼¦å°±æ˜¯æ‰§â¾ HTTP è¯·æ±‚ï¼Œç„¶åè¿”å›â¼€ä¸ªåº”ç­”æˆ–é”™è¯¯ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥â½¤ Single æ¥æè¿° ä»»ä½•åªæœ‰â¼€ä¸ªå…ƒç´ çš„åºåˆ—ã€‚12345678910111213141516171819func getRepo(_ repo: String) -&gt; Single&lt;[String: Any]&gt; &#123; return Single&lt;[String: Any]&gt;.create &#123; single in let task = URLSession.shared.dataTask(with: URL(string: \"https://api.github.com/repos/\\(repo)\")!) &#123; data, _, error in if let error = error &#123; single(.error(error)) return &#125; guard let data = data, let json = try? JSONSerialization.jsonObject(with: data, options: .mutableLeaves), let result = json as? [String: Any] else &#123; single(.error(DataError.cantParseJSON)) return &#125; single(.success(result)) &#125; task.resume() return Disposables.create &#123; task.cancel() &#125; &#125;&#125;è®¢é˜…ï¼š12345678910getRepo(\"ReactiveX/RxSwift\") .subscribe &#123; event in switch event &#123; case .success(let json): print(\"JSON: \", json) case .error(let error): print(\"Error: \", error) &#125; &#125; .disposed(by: disposeBag)or12345678getRepo(\"ReactiveX/RxSwift\") .subscribe(onSuccess: &#123; json in print(\"JSON: \", json) &#125;, onError: &#123; error in print(\"Error: \", error) &#125;) .disposed(by: disposeBag)å¯ä»¥å¯¹ Observable è°ƒâ½¤ .asSingle() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Singleã€‚ CompletableCompletable ä¹Ÿåªèƒ½å‘é€ä¸¤ä¸ªäº‹ä»¶ï¼Œä»–æ²¡æœ‰ .next äº‹ä»¶ï¼Œæ‰€ä»¥ä»–ä»¬æœ‰æ¥å—æ•°æ®å€¼ç›¸å…³çš„äº‹ä»¶ï¼123456public enum CompletableEvent &#123; /// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`) case error(Swift.Error) /// Sequence completed successfully. case completed&#125;Completable åˆ›å»ºæ–¹æ³•åŒ Singleï¼Œä¹Ÿæ˜¯åšäº† CompletableEvent -&gt; Event çš„å¤„ç†æ²¡æœ‰ next äº‹ä»¶ï¼Œä¸ä¼šå‘å‡ºå…ƒç´ åªå‘é€ completed æˆ–è€… errorä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤Completable å®é™…åœºæ™¯ï¼šCompletable é€‚â½¤äºé‚£ç§ä½ åªå…³â¼¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œâ½½ä¸éœ€è¦åœ¨æ„ä»»åŠ¡è¿”å›å€¼çš„æƒ…å†µã€‚å®ƒå’Œ Observableæœ‰ç‚¹ç›¸ä¼¼ã€‚123456789101112func cacheLocally() -&gt; Completable &#123; return Completable.create &#123; completable in // Store some data locally ... guard success else &#123; completable(.error(CacheError.failedCaching)) return Disposables.create &#123;&#125; &#125; completable(.completed) return Disposables.create &#123;&#125; &#125;&#125;è®¢é˜…12345678910cacheLocally() .subscribe &#123; completable in switch completable &#123; case .completed: print(\"Completed with no error\") case .error(let error): print(\"Completed with an error: \\(error.localizedDescription)\") &#125; &#125; .disposed(by: disposeBag)or12345678cacheLocally() .subscribe(onCompleted: &#123; print(\"Completed with no error\") &#125;, onError: &#123; error in print(\"Completed with an error: \\(error.localizedDescription)\") &#125;) .disposed(by: disposeBag) Maybeå®ƒä»‹äº Single å’Œ Completable ä¹‹é—´ï¼Œå®ƒè¦ä¹ˆåªèƒ½å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œè¦ä¹ˆäº§â½£â¼€ä¸ª completed äº‹ä»¶ï¼Œè¦ä¹ˆäº§â½£â¼€ä¸ª error äº‹ä»¶ã€‚12345678public enum MaybeEvent&lt;Element&gt; &#123; /// One and only sequence element is produced. (underlying observable sequence emits: `.next(Element)`, `.completed`) case success(Element) /// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`) case error(Swift.Error) /// Sequence completed successfully. case completed&#125;Maybe åˆå§‹åŒ–æ–¹æ³•ï¼Œåšäº† MaybeEvent -&gt; Event çš„å¤„ç†12345678910111213141516public static func create(subscribe: @escaping (@escaping MaybeObserver) -&gt; Disposable) -&gt; PrimitiveSequence&lt;Trait, Element&gt; &#123; let source = Observable&lt;Element&gt;.create &#123; observer in return subscribe &#123; event in switch event &#123; case .success(let element): observer.on(.next(element)) observer.on(.completed) case .error(let error): observer.on(.error(error)) case .completed: observer.on(.completed) &#125; &#125; &#125; return PrimitiveSequence(raw: source)&#125;ä½¿ç”¨åœºæ™¯Observable è°ƒâ½¤ .asMaybe() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Maybeã€‚ RxCocoa ç‰¹å¾ Driver/Signal/ControlEvent Driverä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ– UI å±‚çš„ä»£ç ã€‚ä¸è¿‡å¦‚æœä½ é‡åˆ°çš„åº åˆ—å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿â½¤å®ƒï¼šä¸ä¼šäº§â½£ error äº‹ä»¶â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰å…±äº«é™„åŠ ä½œâ½¤ä¸ºä»€ä¹ˆè¦å« Driver å‘¢ï¼Ÿå®ƒçš„ç›®çš„æ˜¯è®© model æ•°æ®å±‚é©±åŠ¨ UI å˜åŒ–ã€‚E.g.Drive UI from CoreData model.Drive UI using values from other UI elements (bindings). â€¦åˆå­¦è€…ä¼šä½¿ç”¨è¿™æ ·çš„ï¼š12345678910111213141516let results = query.rx.text .throttle(.milliseconds(300), scheduler: MainScheduler.instance) .flatMapLatest &#123; query in fetchAutoCompleteItems(query) &#125;results .map &#123; \"\\($0.count)\" &#125; .bind(to: resultCount.rx.text) .disposed(by: disposeBag)results .bind(to: resultsTableView.rx.items(cellIdentifier: \"Cell\")) &#123; (_, result, cell) in cell.textLabel?.text = \"\\(result)\" &#125; .disposed(by: disposeBag)ä¸Šé¢çš„ä»£ç ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚æœ fetchAutoCompleteItems observable sequence å‘å‡º error (egè¿æ¥å¤±è´¥ï¼Œè§£æé”™è¯¯), è¿™æ ·çš„é”™è¯¯ä¸ä¼šè§£ç»‘è®¢é˜…ï¼ŒUIå†ä¹Ÿä¸ä¼šå“åº”æ–°çš„æŸ¥è¯¢å¦‚æœ fetchAutoCompleteItems è¿”å›çš„ç»“æœåœ¨æŸä¸ªåå°çº¿ç¨‹ï¼Œåå°çº¿ç¨‹è¿”å›çš„ç»“æœä¼šç»‘å®šåˆ° UIå…ƒç´ ï¼Œå¯¼è‡´ç¡®å®šæ€§çš„ crashsç»“æœç»‘å®šåˆ°ä¸¤ä¸ª UI å…ƒç´ ä¸Šï¼Œæ„å‘³ç€æ¯æ¬¡ç”¨æˆ·æŸ¥è¯¢éƒ½ä¼šå‘é€ 2æ¬¡ HTTP è¯·æ±‚ï¼Œè¿™ä¸æ˜¯å¼€å‘è€…çš„æœ¬æ„è¯¥ä»£ç çš„æ›´åˆé€‚ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š1234567891011121314151617181920212223let results = query.rx.text .throttle(.milliseconds(300), scheduler: MainScheduler.instance) .flatMapLatest &#123; query in fetchAutoCompleteItems(query) .observeOn(MainScheduler.instance) // results are returned on MainScheduler .catchErrorJustReturn([]) // in the worst case, errors are handled &#125; .share(replay: 1) // HTTP requests are shared and results replayed // to all UI elementsresults .map &#123; \"\\($0.count)\" &#125; .bind(to: resultCount.rx.text) .disposed(by: disposeBag)results .bind(to: resultsTableView.rx.items(cellIdentifier: \"Cell\")) &#123; (_, result, cell) in cell.textLabel?.text = \"\\(result)\" &#125; .disposed(by: disposeBag)ç¡®ä¿åœ¨å¤§å‹ç³»ç»Ÿä¸­æ­£ç¡®å¤„ç†æ‰€æœ‰éœ€æ±‚å¾ˆå…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†æ˜¯æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•ï¼Œä½¿ç”¨ç¼–è¯‘å™¨å’Œç‰¹å¾æ¥è¯æ˜æ»¡è¶³è¿™äº›è¦æ±‚ã€‚ä»¥ä¸‹ä»£ç ï¼š12345678910111213141516171819202122let results = query.rx.text.asDriver()// This converts a normal sequence into a `Driver` sequence. .throttle(.milliseconds(300), scheduler: MainScheduler.instance) .flatMapLatest &#123; query in fetchAutoCompleteItems(query) .asDriver(onErrorJustReturn: []) // Builder just needs info about what to return in case of error. &#125;results .map &#123; \"\\($0.count)\" &#125; //Driver çš„è®¢é˜…è¦ä½¿ç”¨ driveæ¥åš .drive(resultCount.rx.text) // If there is a `drive` method available instead of `bind(to:)`, .disposed(by: disposeBag) // that means that the compiler has proven that all properties // are satisfied.results .drive(resultsTableView.rx.items(cellIdentifier: \"Cell\")) &#123; (_, result, cell) in cell.textLabel?.text = \"\\(result)\" &#125; .disposed(by: disposeBag)æ‰€ä»¥ä¸Šé¢ä»£ç å‘ç”Ÿäº†ä»€ä¹ˆï¼ŸasDriveræ–¹æ³•å°†ControlPropertyç‰¹æ€§è½¬æ¢ä¸ºDriverç‰¹æ€§ã€‚1query.rx.text.asDriver()æ³¨æ„ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…è¦åšã€‚Driver å…·æœ‰ ControlProperty ç‰¹æ€§çš„æ‰€æœ‰å±æ€§ï¼Œä»¥åŠå…¶ä»–ä¸€äº›å±æ€§ã€‚åº•å±‚çš„ observable sequence åªæ˜¯åŒ…è£…ä¸ºDriver traitï¼Œä»…æ­¤è€Œå·²ã€‚observable sequence è½¬åŒ–ä¸º Driver1.asDriver(onErrorJustReturn: [])P.S. ä»»ä½• observable sequence è½¬åŒ–ä¸º Driver éƒ½å¿…é¡»æ»¡è¶³ä¸‹é¢ä¸‰ç‚¹Canâ€™t error out.Observe on main scheduler.Sharing side effects (share(replay: 1, scope: .whileConnected)).é‚£ä¹ˆï¼Œå¦‚ä½•ç¡®ä¿æ»¡è¶³è¿™äº›å‘¢ï¼Ÿåªéœ€ä½¿ç”¨æ™®é€šçš„Rxè¿ç®—ç¬¦å³å¯ã€‚asDriver(onErrorJustReturn:[])ç­‰æ•ˆäºä»¥ä¸‹ä»£ç ã€‚123456let safeSequence = xs .observeOn(MainScheduler.instance) // observe events on main scheduler .catchErrorJustReturn(onErrorJustReturn) // can't error out .share(replay: 1, scope: .whileConnected) // side effects sharingreturn Driver(raw: safeSequence) // wrap it upæœ€åä¸€æ­¥æ˜¯ä½¿ç”¨ drive ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ bind(to:)ã€‚ SignalSignal å’Œ Driver ç›¸ä¼¼ï¼Œå”¯â¼€çš„åŒºåˆ«æ˜¯ï¼ŒDriver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ï¼ˆé‡æ–°å‘é€ï¼‰ä¸Šâ¼€ä¸ªå…ƒç´ ï¼Œâ½½ Signal ä¸ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ã€‚ä¸ä¼šäº§â½£ error äº‹ä»¶åœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰å…±äº«é™„åŠ ä½œâ½¤Signal å’Œ Driver çš„åŒºåˆ«ç¤ºä¾‹123456789let textField: UITextField = ... let nameLabel: UILabel = ... let nameSizeLabel: UILabel = ... let state: Driver&lt;String?&gt; = textField.rx.text.asDriver() let observer = nameLabel.rx.text state.drive(observer) // ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·è¾“â¼Šå§“ååè¿â¾ let newObserver = nameSizeLabel.rx.text state.map &#123; $0?.count.description &#125;.drive(newObserver)è¿™ä¸ªä¾‹â¼¦æ˜¯å°†â½¤æˆ·è¾“â¼Šçš„å§“åç»‘å®šåˆ°å¯¹åº”çš„æ ‡ç­¾ä¸Šã€‚å½“â½¤æˆ·è¾“â¼Šå§“ååï¼Œæˆ‘ä»¬åˆ›å»ºäº†â¼€ä¸ªæ–°çš„è§‚å¯Ÿè€…ï¼Œâ½¤äºè®¢é˜…å§“åçš„å­—æ•°ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè®¢é˜…æ—¶ï¼Œå±•ç¤ºå­—æ•°çš„æ ‡ç­¾ä¼šâ½´å³æ›´æ–°å—ï¼Ÿ å› ä¸º Driver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ï¼ˆå½“å‰å§“åï¼‰ï¼Œæ‰€ä»¥è¿™â¾¥æ˜¯ä¼šæ›´æ–°çš„ã€‚åœ¨å¯¹ä»–è¿›â¾è®¢é˜…æ—¶ï¼Œæ ‡ç­¾çš„é»˜è®¤â½‚æœ¬ä¼šè¢«åˆ·æ–°ã€‚è¿™æ˜¯åˆç†çš„ã€‚é‚£å¦‚æœæˆ‘ä»¬â½¤ Driver æ¥æè¿°ç‚¹å‡»äº‹ä»¶å‘¢ï¼Œè¿™æ ·åˆç†å—ï¼Ÿ12345678let button: UIButton = ... let showAlert: (String) -&gt; Void = ... let event: Driver&lt;Void&gt; = button.rx.tap.asDriver() let observer: () -&gt; Void = &#123; showAlert(\"å¼¹å‡ºæç¤ºæ¡†1\") &#125; event.drive(onNext: observer) // ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·ç‚¹å‡» button åè¿â¾ let newObserver: () -&gt; Void = &#123; showAlert(\"å¼¹å‡ºæç¤ºæ¡†2\") &#125; event.drive(onNext: newObserver)å½“â½¤æˆ·ç‚¹å‡»â¼€ä¸ªæŒ‰é’®åï¼Œåˆ›å»ºâ¼€ä¸ªæ–°çš„è§‚å¯Ÿè€…ï¼Œæ¥å“åº”ç‚¹å‡»äº‹ä»¶ã€‚æ­¤æ—¶ä¼šå‘â½£ä»€ä¹ˆï¼ŸDriver ä¼šæŠŠä¸Šâ¼€æ¬¡çš„ç‚¹å‡»äº‹ä»¶å›æ”¾ç»™æ–°è§‚å¯Ÿè€…ã€‚æ‰€ä»¥ï¼Œè¿™â¾¥çš„ newObserver åœ¨è®¢é˜…æ—¶ï¼Œå°±ä¼šæ¥å—åˆ°ä¸Šæ¬¡çš„ç‚¹å‡»äº‹ä»¶ï¼Œç„¶åå¼¹å‡ºæç¤ºæ¡†ã€‚è¿™ä¼¼ä¹ä¸å¤ªåˆç†ã€‚äºæ˜¯æˆ‘ä»¬å°±å¼•â¼Šäº† Signal:1234567...let event: Signal&lt;Void&gt; = button.rx.tap.asSignal()let observer: () -&gt; Void = &#123; showAlert(\"å¼¹å‡ºæç¤ºæ¡†1\") &#125; event.emit(onNext: observer) // ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·ç‚¹å‡» button åè¿â¾ let newObserver: () -&gt; Void = &#123; showAlert(\"å¼¹å‡ºæç¤ºæ¡†2\") &#125; event.emit(onNext: newObserver)åœ¨åŒæ ·çš„åœºæ™¯ä¸­ï¼ŒSignal ä¸ä¼šæŠŠä¸Šâ¼€æ¬¡çš„ç‚¹å‡»äº‹ä»¶å›æ”¾ç»™æ–°è§‚å¯Ÿè€…ï¼Œâ½½åªä¼šå°†è®¢é˜…åäº§â½£çš„ç‚¹å‡»äº‹ä»¶ï¼Œå‘å¸ƒç»™æ–°è§‚å¯Ÿè€…ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ç»“è®º: â¼€èˆ¬æƒ…å†µä¸‹çŠ¶æ€åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Driver è¿™ä¸ªç±»å‹ï¼Œäº‹ä»¶åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Signal è¿™ä¸ªç±»å‹ã€‚ ControlPropertyå®ƒæ˜¯ Observable / ObservableType ç‰¹æ€§ï¼Œè¡¨ç¤ºUIå…ƒç´ çš„å±æ€§ã€‚å€¼åºåˆ—ä»…è¡¨ç¤ºåˆå§‹æ§åˆ¶å€¼å’Œç”¨æˆ·å¯åŠ¨çš„å€¼æ›´æ”¹ã€‚ç¨‹åºåŒ–ä»·å€¼çš„å˜åŒ–å°†ä¸ä¼šæŠ¥å‘Šã€‚å®ƒçš„ç‰¹ç‚¹ï¼šæ°¸è¿œä¸ä¼šå¤±è´¥share(replay: 1)å…±äº«æœ€æ–°å€¼å®ƒæ˜¯æœ‰çŠ¶æ€çš„ï¼Œä¸€æ—¦è®¢é˜…å¦‚æœæœ‰äº§ç”Ÿè¿‡å€¼ï¼Œé‚£ä¹ˆæœ€æ–°çš„å€¼ä¼šç«‹å³é‡æ’­å½“æ§ä»¶é”€æ¯çš„æ—¶å€™å‘é€ complete äº‹ä»¶ä¸å‘é€ error äº‹ä»¶åœ¨ä¸»çº¿ç¨‹ä¸Šä¼ æ’­ eventså®é™…ä½¿ç”¨æ¡ˆä¾‹1234567891011121314151617extension Reactive where Base: UISearchBar &#123; /// Reactive wrapper for `text` property. public var value: ControlProperty&lt;String?&gt; &#123; let source: Observable&lt;String?&gt; = Observable.deferred &#123; [weak searchBar = self.base as UISearchBar] () -&gt; Observable&lt;String?&gt; in let text = searchBar?.text return (searchBar?.rx.delegate.methodInvoked(#selector(UISearchBarDelegate.searchBar(_:textDidChange:))) ?? Observable.empty()) .map &#123; a in return a[1] as? String &#125; .startWith(text) &#125; let bindingObserver = Binder(self.base) &#123; (searchBar, text: String?) in searchBar.text = text &#125; return ControlProperty(values: source, valueSink: bindingObserver) &#125;&#125;123456789101112131415161718extension Reactive where Base: UISegmentedControl &#123; /// Reactive wrapper for `selectedSegmentIndex` property. public var selectedSegmentIndex: ControlProperty&lt;Int&gt; &#123; return value &#125; /// Reactive wrapper for `selectedSegmentIndex` property. public var value: ControlProperty&lt;Int&gt; &#123; return UIControl.rx.value( self.base, getter: &#123; segmentedControl in segmentedControl.selectedSegmentIndex &#125;, setter: &#123; segmentedControl, value in segmentedControl.selectedSegmentIndex = value &#125; ) &#125;&#125; ControlEventå®ƒæ˜¯ Observable / ObservableType ç‰¹æ€§ï¼Œè¡¨ç¤ºUIå…ƒç´ çš„äº‹ä»¶ã€‚ç‰¹ç‚¹ï¼šæ°¸ä¸å¤±è´¥è®¢é˜…çš„æ—¶å€™ä¸ä¼šå‘é€åˆè¯•å€¼å½“æ§ä»¶é”€æ¯æ—¶ï¼Œå‘é€ completeä¸å‘é€ errors äº‹ä»¶åœ¨ä¸»çº¿ç¨‹å‘é€ eventså®é™…ä½¿ç”¨æ¡ˆä¾‹è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ç¤ºä¾‹ï¼Œä½ å¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨å®ƒï¼š1234567public extension Reactive where Base: UIViewController &#123; /// Reactive wrapper for `viewDidLoad` message `UIViewController:viewDidLoad:`. public var viewDidLoad: ControlEvent&lt;Void&gt; &#123; let source = self.methodInvoked(#selector(Base.viewDidLoad)).map &#123; _ in &#125; return ControlEvent(events: source) &#125;&#125;åœ¨UICollectionView + Rxä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°å®ƒï¼š12345678910extension Reactive where Base: UICollectionView &#123; /// Reactive wrapper for `delegate` message `collectionView:didSelectItemAtIndexPath:`. public var itemSelected: ControlEvent&lt;IndexPath&gt; &#123; let source = delegate.methodInvoked(#selector(UICollectionViewDelegate.collectionView(_:didSelectItemAt:))) .map &#123; a in return a[1] as! IndexPath &#125; return ControlEvent(events: source) &#125;&#125;å¼•ç”¨ï¼šTraits","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"åè°ƒå™¨ Redux","date":"2018-01-24T11:22:03.000Z","path":"2018/01/24/architecture/åè°ƒå™¨-Redux/","text":"åŸæ–‡ï¼šCoordinators Reduxä»Šå¹´å¹´åˆæˆ‘å†™è¿‡å…³äº åè°ƒå™¨çš„æ–‡ç« , ä½†æ˜¯è‡ªä»é‚£ä»¥åå¯¹äºåè°ƒå™¨çš„æ€è€ƒå·²ç»æˆç†Ÿäº†å¾ˆå¤šï¼Œæˆ‘æƒ³é€šè¿‡è¿™å‡ ä¸ªæœˆæ‰€å­¦çš„ä¸œè¥¿æ¥æ¥é‡æ–°ä»‹ç»è¿™ä¸ªè¯é¢˜ã€‚è¿™æ˜¯æ ¹æ®æˆ‘ä»Šå¹´åœ¨NSSpainçš„ä¸€æ¬¡æ¼”è®²æ”¹ç¼–è€Œæˆã€‚æ­¤å¤„æ‰¾åˆ°å¹»ç¯ç‰‡ã€‚åœ¨è¿™é‡Œæ‰¾åˆ°è§†é¢‘ã€‚ ä¸‰ä¸ªé—®é¢˜ 1. App Delegates ä¸­æ”¾çš„ä¸œè¥¿å¤ªå¤šäº†è‹¹æœå…¬å¸åœ¨æŒ‡å¯¼æˆ‘ä»¬å°†ä»£ç æ”¾åœ¨åˆé€‚çš„åœ°æ–¹æ–¹é¢åšå¾—éå¸¸ç³Ÿç³•ã€‚å¼„æ¸…å¦‚ä½•æ„å»º App å®Œå…¨ç”±æˆ‘ä»¬è‡ªå·±å†³å®šã€‚æœ€å¼€å§‹å†™ä»£ç çš„åœ°æ–¹æ˜¾è€Œæ˜“è§æ˜¯ appâ€™s delegate.app delegate æ˜¯æ¯ä¸ª App çš„å…¥å£ã€‚å®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»æ“ä½œç³»ç»Ÿåˆ°åº”ç”¨ç¨‹åºçš„å­ç³»ç»Ÿæ¥å›ä¼ é€’æ¶ˆæ¯ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºå®ƒä½äºæ‰€æœ‰äº‹ç‰©çš„ä¸­å¿ƒï¼Œå› æ­¤å¾ˆå®¹æ˜“åœ¨ä¸œè¥¿æ”¾åœ¨è¿™ã€‚è¿™æ ·è®¾è®¡æ–¹å¼ä¸­çš„ä¸€ä¸ªå—å®³è€…å°±æ˜¯ rootViewController çš„é…ç½®ã€‚å¦‚æœä½ çš„ä½¿ç”¨ tabbarController ä½œä¸º rootï¼Œé‚£ä¹ˆä½ å¿…é¡»è¦åœ¨æŸä¸ªé…ç½®æ‰€æœ‰çš„ tabbarController çš„ childrenï¼Œå¹¶ä¸” App delegate å°±æ˜¯ä¸ªå¾ˆå¥½çš„åœºæ‰€ã€‚æˆ‘å†™çš„ç¬¬ä¸€ä¸ª Appï¼ˆå¯¹äºå¤§å¤šæ•°è¯»è€…æˆ‘çŒœæµ‹ï¼Œè¿™æ˜¯çœŸçš„ï¼‰ï¼Œæˆ‘åœ¨æˆ‘çš„AppDelegateä¸­ï¼Œä¸º rootviewcontroller é…ç½®äº†æ‰€æœ‰é…ç½®ã€‚é‚£äº›ä»£ç çœŸçš„ä¸å±äºè¿™é‡Œï¼Œå†™åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿ã€‚åœ¨æˆ‘å†™å®Œæˆ‘ç¬¬ä¸€ä¸ª app ä»¥åæˆ‘æ„è¯†åˆ°äº†è¿™ä¸ªï¼Œç„¶åæˆ‘å˜å¾—èªæ˜äº†ï¼Œæˆ‘æ˜¯ç”¨äº†è¿™æ ·çš„æŠ€å·§ï¼š1@interface SKTabBarController : UITabBarControlleræˆ‘ä¼šåˆ›å»ºä¸€ä¸ªæˆ‘æƒ³è¦ä½¿ç”¨çš„ rootViewController å­ç±»ï¼Œç„¶åæˆ‘ä¼šæŠŠä»£ç æŒªåˆ°è¿™é‡Œã€‚è¿™åªæ˜¯å…³äºè¿™ä¸ªé—®é¢˜çš„ä¸´æ—¶è¡¥ä¸ï¼Œæœ€åå‘ç°è¿™ä¹Ÿä¸æ˜¯æ­¤ä»£ç è¯¥æ”¾çš„åœ°æ–¹ã€‚æˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶è¿™ä¸ªå¯¹è±¡â€”â€”rootViewControllerï¼Œä»è´£ä»»çš„è§’åº¦ã€‚ç®¡ç†å­è§†å›¾æ§åˆ¶å™¨å±äºè¿™äº›èŒè´£ï¼Œä½†åˆ†é…å’Œé…ç½®å®ƒä»¬çš„èŒè´£ä¸å¤šã€‚æˆ‘ä»¬æ­£åœ¨å¯¹ä¸€ä¸ªä»æœªæ‰“ç®—è¿›è¡Œå­ç±»åŒ–çš„ä¸œè¥¿è¿›è¡Œå­ç±»åŒ–ï¼Œåªæ˜¯ä¸ºäº†æˆ‘ä»¬å¯ä»¥éšè—ä¸€äº›æ— å®¶å¯å½’çš„ä»£ç ã€‚å¯¹äºæ­¤åº”ç”¨ç¨‹åºé…ç½®é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¥½çš„å®¶ã€‚ 2.å¤ªå¤šè´£ä»»è¿™é‡Œæœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚å•ä¸ªViewControllerä¹Ÿé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼ŒæŠŠå¤§é‡çš„è´£ä»»æ”¾å€¾å€’App delegateé‡Œé¢ã€‚ViewController ä¸­è´Ÿè´£çš„ä¸€äº›äº‹æƒ…ï¼šæ¨¡å‹è§†å›¾ç»‘å®šå­è§†å›¾åˆ†é…å†…å­˜è·å–æ•°æ®å¸ƒå±€æ•°æ®è½¬æ¢å¯¼èˆªæµç¨‹ç”¨æˆ·è¾“å…¥æ¨¡å‹å˜åŒ–è¿˜æœ‰æ›´å¤šæˆ‘æè¿‡ä¸€äº›æ–¹æ³•å°†è¿™äº›è´£ä»»è—åˆ° ViewController çš„ childrenä¸­ï¼Œæ–¹æ³•åœ¨8 Patterns to Help You Destroy Massive View Controllerä¸­. æ‰€æœ‰è´£ä»»ä¸èƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™æ · ViewController ä¸­çš„ä»£ç å°±ä¼šå°‘äº 3000è¡Œäº†ã€‚å“ªäº›ä¸œè¥¿åº”è¯¥åœ¨è¿™ä¸ªç±»ï¼Ÿå“ªäº›åº”è¯¥åœ¨åˆ«çš„åœ°æ–¹ï¼ŸViewControllerçš„å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿè¿™äº›é—®é¢˜è¿˜æ²¡æœ‰ç†æ¸…æ¥šã€‚å¼•ç”¨ Graham Lee è¯´çš„ä¸€å¥è¯ï¼Œæˆ‘å¾ˆå–œæ¬¢ã€‚When you get overly attached to MVC, then you look at every class you create and ask the question â€œis this a model, a view, or a controller?â€. Because this question makes no sense, the answer doesnâ€™t either: anything that isnâ€™t evidently data or evidently graphics gets put into the amorphous â€œcontrollerâ€ collection, which eventually sucks your entire codebase into its innards like a black hole collapsing under its own weight.ä»€ä¹ˆæ˜¯ViewControllerï¼ŸSmalltalkianæ„ä¹‰ä¸Šçš„æ§åˆ¶å™¨æœ€åˆä¸¥æ ¼æ˜¯ä¸ºç”¨æˆ·è¾“å…¥è€Œè®¾è®¡çš„ã€‚ç”šè‡³â€œæ§åˆ¶â€ä¸€è¯ä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†éº»çƒ¦ã€‚å¦‚æˆ‘ä¹‹å‰æ‰€å†™ï¼šWhen you call something a Controller, it absolves you of the need to separate your concerns. Nothing is out of scope, since its purpose is to control things. Your code quickly devolves into a procedure, reaching deep into other objects to query their state and manipulate them from afar. Boundless, it begins absorbing responsibilities. å¹³ç¼“çš„ Flowæœ€åä¸€ä¸ªæˆ‘æƒ³è¦è®¨è®ºçš„é—®é¢˜æ˜¯ï¼šnavigation flow12345- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath &#123; id object = [self.dataSource objectAtIndexPath:indexPath]; SKDetailViewController *detailViewController = [[SKDetailViewController alloc] initWithDetailObject:object]; [self.navigationController pushViewController:detailViewController animated:YES]; &#125;è¿™äº‹ä¸€æ®µå¾ˆå¸¸è§çš„ä»£ç ï¼Œä¸å¹¸çš„æ˜¯ï¼Œä»–æ˜¯åƒåœ¾ä»£ç ã€‚è®©æˆ‘ä»¬ä¸€è¡Œè¡Œçœ‹ï¼š1id object = [self.dataSource objectAtIndexPath:indexPath];ç¬¬ä¸€è¡Œçš„ dataSource æ˜¯ ViewController é€»è¾‘ä¸Šçš„ childï¼Œç„¶åæˆ‘ä»¬æ­£åœ¨è·Ÿä»–è¦æˆ‘ä»¬éœ€è¦å¼•ç”¨çš„çš„å¯¹è±¡ã€‚1SKDetailViewController *detailViewController = [[SKDetailViewController alloc] initWithDetailObject:object];è¿™é‡Œäº‹æƒ…å¼€å§‹å˜å¾—éº»çƒ¦ã€‚ViewController æ­£åœ¨å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ ViewControllerï¼Œç„¶åé…ç½®å®ƒã€‚è¿™ä¸ª ViewController â€çŸ¥é“â€œ åœ¨ flow ä¸­æ¥ä¸‹æ¥ä¼šæµå‡ºä»€ä¹ˆã€‚ä»–çŸ¥é“æ–°çš„ ViewController æ˜¯æ€ä¹ˆé…ç½®çš„ã€‚æ­£åœ¨æ‰§è¡Œ Presenting çš„ ViewController çŸ¥é“ä»–æ‰€åœ¨ App ä½ç½®ä¸­çš„å¤§é‡ç»†èŠ‚ï¼ˆæ–° ViewControllerçš„é…ç½®ç»†èŠ‚ï¼‰ã€‚1[self.navigationController pushViewController:detailViewController animated:YES];ç¬¬ä¸‰è¡Œæ˜¯å®ƒå®Œå…¨åç¦»è½¨é“çš„åœ°æ–¹ã€‚è¿™ä¸ª ViewController çŸ¥é“äº†ä»–çš„çˆ¶çº§ ViewControllerï¼Œå› ä¸ºè¯·è®°ä½ï¼Œè¿™äº›è§†å›¾æ§åˆ¶å™¨åœ¨åŒä¸€å±‚æ¬¡ç»“æ„ä¸­ï¼Œå­ ViewController ä¼šå‘çˆ¶ ViewController å‘é€æ¶ˆæ¯ï¼Œå‘Šè¯‰ä»–è¦åšä»€ä¹ˆã€‚å­ ViewController æ­£åœ¨æŒ‡æŒ¥ä»–çš„çˆ¶äº²ã€‚åœ¨ç°å®ä¸–ç•Œé‡Œï¼Œå­©å­ä¸åº”è¯¥åˆ°å¤„æŒ‡æŒ¥è‡ªå·±çš„çˆ¶äº²ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä¼šè¯´å­©å­ç”šè‡³ä¸åº”è¯¥çŸ¥é“ä»–ä»¬çš„çˆ¶äº²æ˜¯è°ï¼åœ¨8ç§æ¨¡å¼å¸®åŠ©ä½ å¹²æ‰å¤§é‡çš„ViewController, æˆ‘å»ºè®®ä½¿ç”¨ä¸€ä¸ª Navigator ç±»å‹ï¼Œå®ƒå¯ä»¥æ³¨å…¥åˆ°é‚£äº›åŒ…å«å¯¼èˆªé€»è¾‘çš„ ViewControllers ä¸­ã€‚å¦‚æœä½ æƒ³è¦æŠŠå¯¼èˆªé€»è¾‘æ”¾åˆ°åŒä¸€ä¸ªåœ°æ–¹ï¼Œ Navigators æ˜¯ä¸€ä¸ªä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå¿«é‡åˆ°ä¸€ä¸ªå¯¼èˆªå™¨æ²¡åŠæ³•å¸®æˆ‘ä»¬è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ä¸‰è¡Œä»£ç ä¸­æœ‰å¾ˆå¤šé€»è¾‘ï¼Œä½†æ˜¯ ViewController ä¸æ˜¯è¿™äº›é€»è¾‘å‘ç”Ÿçš„åœ°æ–¹ã€‚æƒ³è±¡ä½ æœ‰ä¸ªç¼–è¾‘å›¾åƒçš„ appä½ çš„ PhotoSelectionViewController presents StraighteningViewController presents FilteringViewController presents CaptioningViewControllerã€‚ä½ çš„å¯¼èˆª flow ç°åœ¨åˆ†å¸ƒåœ¨ä¸‰ä¸ªä¸åŒçš„å¯¹è±¡ä¹‹é—´ã€‚è¿›ä¸€æ­¥è¯´ï¼ŒæŸä¸ª ViewController presenting PhotoSelectionViewController ï¼Œä½†æ˜¯ dismissal é€»è¾‘å¿…é¡»è¦åœ¨ CaptioningViewController ä¸­å¤„ç†ã€‚ä¼ é€’ Navigator ä½¿è¿™äº› ViewControllers ä¿æŒé“¾çŠ¶è¿æ¥åœ¨ä¸€èµ·ï¼Œå¹¶ä¸èƒ½çœŸæ­£è§£å†³æ¯ä¸ª ViewController çŸ¥é“é“¾ä¸­ä¸‹ä¸€ä¸ªçš„é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿéœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ Libraries vs Frameworksæˆ‘è®¤ä¸ºApple å¸Œæœ›æˆ‘ä»¬ä»¥æ‰€æœ‰è¿™äº›æ–¹å¼ç¼–å†™ä»£ç ã€‚ä»–ä»¬å¸Œæœ›æˆ‘ä»¬ä½¿ç”¨ ViewController æˆä¸ºä¸–ç•Œä¸­å¿ƒï¼Œå› ä¸ºæ‰€æœ‰ä»¥ç›¸åŒæ ·å¼ç¼–å†™çš„ app éƒ½å¯ä»¥é€šè¿‡æ›´æ”¹SDKå‘æŒ¥æœ€å¤§çš„å½±å“åŠ›ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºå¼€å‘è€…ï¼Œè¿™å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„ä¸¾åŠ¨ã€‚æˆ‘ä»¬æ˜¯è´Ÿè´£å°†æ¥ç»´æŠ¤ app çš„äººï¼Œå¯é çš„è®¾è®¡å’Œä»£ç å¯æ‰©å±•æ€§æ˜¯æˆ‘ä»¬æœ€çœ‹é‡çš„ã€‚ä»–ä»¬è¯´libraries å’Œ frameworks çš„åŒºåˆ«æ˜¯ï¼Œä½ è°ƒç”¨ librariesï¼Œframeworks è°ƒç”¨ä½ ã€‚æˆ‘æƒ³å°½å¯èƒ½åƒä¾èµ– libraries çš„æ–¹å¼ï¼Œå¯¹å¾… 3rd-party ä¾èµ–ã€‚å½“ä½¿ç”¨ UIKit ï¼Œä½ ä¸éœ€è¦è´Ÿè´£ä»€ä¹ˆã€‚è°ƒç”¨ -pushViewController:animated: ç„¶åå®ƒåšä¸€äº›å·¥ä½œã€‚å¹¶ä¸”åœ¨å°†æ¥çš„æŸä¸ªä¸ç¡®å®šçš„æ—¶é—´ï¼Œä¸‹ä¸€ä¸ªViewControllerå‡ºç°ä»–ä¼šè°ƒç”¨ viewDidLoad: åœ¨è¿™é‡Œé¢ä½ å¯åšæ›´å¤šäº‹ã€‚ä½ ä¸åº”è¯¥è®© UIKit å†³å®šä½•æ—¶è¿è¡Œä»£ç ï¼Œè€Œæ˜¯åº”å°½å¿«é€€å‡º UIKit -land, ä»¥ä¾¿ä½ å¯ä»¥å®Œå…¨æ§åˆ¶ä»£ç çš„æµå‘ã€‚æˆ‘æ›¾ç»å°†ViewControllerä¸º app ä¸­æœ€é«˜ç­‰çº§çš„ä¸œè¥¿ï¼Œè¿™äº›ä¸œè¥¿çŸ¥é“å¦‚ä½•è¿è¡Œæ•´ä¸ªappã€‚ä½†æ˜¯æˆ‘å¼€å§‹æƒ³é¢ è¦†è¿™ä¸ªæƒ³æ³•åä»–ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚view å¯¹å…¶ ViewControlleræ˜¯é€æ˜çš„ã€‚view ç”± ViewController æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä»¥ç›¸åŒçš„æ–¹å¼ä½¿è§†å›¾æ§åˆ¶å™¨åªæ˜¯å¦ä¸€é€æ˜çš„ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿ Coordinatorsä»€ä¹ˆæ˜¯ Coordinators ï¼ŸCoordinator æ˜¯ç”¨äºç®¡ç†ä¸€ä¸ªor å¤šä¸ªViewControllerçš„å¯¹è±¡ã€‚å°†æ‰€æœ‰é©±åŠ¨é€»è¾‘ä» ViewControllerä¸­ç§»é™¤ï¼Œå¹¶å°†è¿™äº›å†…å®¹å‘ä¸Šç§»åŠ¨ä¸€å±‚ï¼Œè¿™ä¼šä½¿ä½ çš„ç”Ÿæ´»å˜å¾—æ›´åŠ ç¾å¥½ã€‚è¿™ä¸€åˆ‡éƒ½ä» app Coordinator å¼€å§‹ã€‚Coordinatorè§£å†³ app delegate ä¸­å†…å®¹è¿‡å¤šçš„é—®é¢˜ã€‚app delegate å¯ä»¥ä¿ç•™app Coordinatorå¹¶å¯åŠ¨å®ƒã€‚app Coordinator å°†ä¸ºapp è®¾ç½®ä¸»è§†å›¾æ§åˆ¶å™¨ã€‚å¯ä»¥åœ¨æ–‡çŒ®ä¸­æ‰¾åˆ°è¿™ç§æ¨¡å¼ï¼Œä¾‹å¦‚ä¼ä¸šåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„æ¨¡å¼ä¹‹ç±»çš„ä¹¦ã€‚ä»–ä»¬æŠŠ Coordinator å«åš Application Controller. app coordinator æ˜¯ Application Controller çš„ç‰¹åˆ«ç‰ˆï¼Œå°¤å…¶å¯¹äº iOSã€‚app coordinator å¯ä»¥åˆ›å»ºå¹¶é…ç½® ViewControllerï¼Œæˆ–è€…å®ƒå¯ä»¥é•¿ç”Ÿæ–°çš„å­ Coordinatoræ¥æ‰§è¡Œå­ä»»åŠ¡ã€‚coordinators å¯ä»¥æ¥ç®¡ ViewControllerçš„å“ªäº›ä»»åŠ¡ï¼Ÿä¸»è¦æ˜¯ navigation å’Œ model å˜åŒ–.(æˆ‘çš„æ„æ€æ˜¯é€šè¿‡æ¨¡å‹å˜åŒ–å°†ç”¨æˆ·çš„æ›´æ”¹ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œæˆ–è€…å¯¹ API è¿›è¡Œ PUT or POST è¯·æ±‚ï¼Œè¿™äº›éƒ½ä¼šç ´åæ€§åœ°ä¿®æ”¹ç”¨æˆ·çš„æ•°æ®ã€‚)å½“ä½ æŠŠè¿™äº›ä»»åŠ¡ä»ViewControllerä¸­æ‹¿èµ°ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†ä¸€ä¸ªæƒ°æ€§çš„ ViewControllerã€‚å®ƒå¯ä»¥å‘ˆç°ï¼Œå¯ä»¥è·å–æ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œè½¬æ¢ä»¥è¿›è¡Œå‘ˆç°ã€æ˜¾ç¤ºï¼Œä½†è‡³å…³é‡è¦çš„æ˜¯æ— æ³•å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œæ¯å½“å±•ç¤º ViewController æ—¶ï¼Œéƒ½ä¸ä¼šè®©ä»–è‡ªå·±æ§åˆ¶ã€‚æ¯å½“éœ€è¦è®©æˆ‘ä»¬çŸ¥é“äº‹ä»¶æˆ–ç”¨æˆ·è¾“å…¥æ—¶ï¼Œå®ƒéƒ½ä¼šä½¿ç”¨å§”æ‰˜æ–¹æ³•ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä»£ç ç¤ºä¾‹ã€‚ ä»£ç ç¤ºä¾‹è®©æˆ‘ä»¬ä» App delegateå¼€å§‹1234567- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123; self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds]; self.rootViewController = [[UINavigationController alloc] init]; self.appCoordinator = [[SKAppCoordinator alloc] initWithNavigationController:self.rootViewController]; [self.appCoordinator start]; [self.window makeKeyAndVisible]; &#125;app delegate æ„å»º app çš„window å’Œ root ViewControllerï¼Œç„¶åå¼€å¯ app Coordinatorã€‚Coordinatorçš„åˆå§‹åŒ–ä¸å¼€å§‹å·¥ä½œæ˜¯åˆ†å¼€çš„ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŒ‰è‡ªå·±çš„æ„æ„¿ï¼ˆæ‡’æƒ°ï¼Œè´ªå©ªç­‰ï¼‰åˆ›å»ºå®ƒï¼Œå¹¶ä¸”åªæœ‰åœ¨å‡†å¤‡å¥½åæ‰èƒ½å¯åŠ¨å®ƒã€‚Coordinator å°±æ˜¯ä¸€ä¸ª NSObject:1@interface SKAppCoordinator : NSObjectè¿™å¾ˆæ£’ï¼Œè¿™é‡Œæ²¡æœ‰ç§˜å¯†ï¼ŒUIViewController æœ‰ä¸Šåƒè¡Œä»£ç ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å½“æˆ‘ä»¬è°ƒç”¨ä»–çš„æ–¹æ³•æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºä»–æ˜¯é—­æºçš„ã€‚ç®€å•çš„ NSObject ç±»å‹å¯¹è±¡è¿è¡Œappï¼Œå¯ä½¿ä¸€åˆ‡å˜å¾—æ›´åŠ ç®€å•ã€‚app coordinator ä½¿ç”¨ä»–éœ€è¦çš„æ•°æ®åˆå§‹åŒ–ï¼Œè¿™äº›æ•°æ®åŒ…æ‹¬ root ViewController123456- (instancetype)initWithNavigationController:(UINavigationController *)navigationController &#123; self = [super init]; if (!self) return nil; _navigationController = navigationController; return self; &#125;ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨ -start æ–¹æ³•ï¼Œcoordinatorå°±ä¼šå¼€å§‹å·¥ä½œ1234567- (void)start &#123; if ([self isLoggedIn]) &#123; [self showContent]; &#125; else &#123; [self showAuthentication]; &#125; &#125;ä»ä¸€å¼€å§‹ Coordinator å°±åšå†³å®šï¼ä»¥å‰åƒè¿™æ ·çš„é€»è¾‘æ²¡æœ‰å›ºå®šä½ç½®ï¼Œä½ å¯ä»¥æŠŠä»–æ”¾åœ¨ appdelegateä¸­æˆ–è€… ViewControllerä¸­ï¼Œä½†æ˜¯æ”¾è¿™ä¸¤ä¸ªåœ°æ–¹éƒ½æœ‰å„è‡ªçš„ç¼ºé™·ã€‚åœ¨ ViewControllerä¸­ï¼Œä½ æœ‰ä¸€ä¸ª ViewControlleråšè¶…å‡ºå®ƒæœ¬èº«è´£ä»»çš„äº‹æƒ…ã€‚åœ¨ appdelegateä¸­ï¼Œä½ ä¼šæ”¾å…¥ä¸€äº›ä¸ä»–ä¸ç›¸å…³çš„ä»£ç æ±¡æŸ“ä»–ã€‚è®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹ -showAuthentication æ–¹æ³•ã€‚åœ¨è¿™é‡Œï¼Œbase Coordinator ç”Ÿæˆ å­ Coordinatorï¼Œå¹¶è®©å…¶æ‰§è¡Œå­ä»»åŠ¡123456- (void)showAuthentication &#123; SKAuthenticationCoordinator *authCoordinator = [[SKKAuthenticationCoordinator alloc] initWithNavigationViewController:self.navigationController]; authCoordinator.delegate = self; [authCoordinator start]; [self.childCoordinators addObject:authCoordinator]; &#125;æˆ‘ä»¬ä½¿ç”¨ childCoordinators æ•°ç»„å¼•ç”¨ Coordinatorsï¼Œé˜²æ­¢å…¶è¢«é”€æ¯ã€‚ViewControllerå­˜åœ¨ä¸€æ£µæ ‘ä¸­ï¼Œå¹¶ä¸”æ¯ä¸ª ViewControlleréƒ½åŒ…å«ä¸€ä¸ª viewã€‚ viewå­˜åœ¨äº subViews æ ‘ä¸­ï¼Œè€Œä¸”æ¯ä¸ª subview æœ‰ä¸€ä¸ª layerã€‚layersä¹Ÿå­˜åœ¨äºä¸€æ£µæ ‘ä¸­ã€‚å› ä¸º childCoordinators ï¼Œä½ ä¹Ÿä¼šå¾—åˆ°ä¸€æ£µ Coordinators æ ‘ã€‚å­ Coordinator ä¼šåˆ›å»ºä¸€äº› ViewControllersï¼Œç­‰å¾…ä»–ä»¬å·¥ä½œï¼Œviewcontroller å·¥ä½œå®Œå Coordinatorä¼šé€šçŸ¥æˆ‘ä»¬ã€‚å½“ Coordinator å‘é€ä¿¡å·å‘ŠçŸ¥ViewControllerå·¥ä½œå®Œæ—¶ï¼Œå®ƒä¼šæ¸…ç†è‡ªå·±ï¼Œå¼¹å‡ºä»–æ·»åŠ çš„æ‰€æœ‰ ViewControllerï¼Œç„¶åä½¿ç”¨å§”æ‰˜å°†æ¶ˆæ¯å‘é€åˆ°çˆ¶çº§ã€‚ä¸€æ—¦æˆ‘ä»¬å·²è®¤è¯ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª delegate æ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬å…è®¸å­ Coordinator é”€æ¯ï¼Œç„¶åæˆ‘ä»¬è¿”å›å¹³å¸¸çš„ç¨‹åºä¸­ã€‚1234- (void)coordinatorDidAuthenticate:(SKAuthenticationCoordinator *)coordinator &#123; [self.childCoordinators removeObject:coordinator]; [self showContent]; &#125;åœ¨èº«ä»½éªŒè¯ Coordinator å†…éƒ¨ï¼Œå®ƒåˆ›å»ºæ‰€éœ€çš„ä»»ä½•Viewcontrollerï¼Œå¹¶å°†å…¶æ¨å…¥å¯¼èˆªæ§åˆ¶å™¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ã€‚12345678910@implementation AuthCoordinator- (instancetype)initWithNavigationController:(UINavigationController *)navigationController &#123; self = [super init]; if (!self) return nil; _navigationController = navigationController; return self; &#125;åˆå§‹åŒ–ç±»ä¼¼äºapp coordinator.12345- (void)start &#123; SKFirstRunViewController *firstRunViewcontroller = [SKFirstRunViewController new]; firstRunViewcontroller.delegate = self; [self.navigationController pushViewController:firstRunViewcontroller animated:NO]; &#125;èº«ä»½éªŒè¯éœ€è¦ä»â€œé¦–æ¬¡è¿è¡Œ viewcontrollerâ€å¼€å§‹ã€‚è¯¥viewcontrollerå…·æœ‰ç”¨äºæ³¨å†Œå’Œç™»å½•çš„æŒ‰é’®ï¼Œè¿˜å¯èƒ½åŒ…å«ä¸€äº›å¹»ç¯ç‰‡ï¼Œè§£é‡Šäº†appã€‚è®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨è¯¥Viewcontroller å¹¶æˆä¸ºå…¶ä»£è¡¨ã€‚è¯¥ViewController æœ‰ä¸€ä¸ª delegateï¼Œå› æ­¤å½“ç”¨æˆ·ç‚¹å‡»â€œæ³¨å†Œâ€æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°é€šçŸ¥ã€‚Coordinator å°†å¤„ç†è¯¥æ“ä½œï¼Œè€Œä¸æ˜¯ViewControlleréœ€è¦çŸ¥é“è¦åˆ›å»ºå’Œå‘ˆç°çš„æ³¨å†ŒViewControllerã€‚12345- (void)firstRunViewControllerDidTapSignup:(SKFirstRunViewController *)firstRunViewController &#123; SKSignUpViewController *signUpViewController = [[SKSignUpViewController alloc] init]; signupViewController.delegate = self; [self.navigationController pushViewController:signupViewController animated:YES]; &#125;Coordinator æˆä¸ºè¿™ä¸ªæ³¨å†Œè¿‡çš„ ViewControllerçš„ä»£ç†ï¼Œä¸ºäº†å®ƒå¯ä»¥åœ¨æŒ‰ä¸‹æŒ‰é’®æ—¶é€šçŸ¥æˆ‘ä»¬ã€‚123- (void)signUpViewController:(SKSignUpViewController *)signupViewController didTapSignupWithEmail:(NSString *)email password:(NSString *)password &#123; //... &#125;è¯¸å¦‚æ­¤ç±»ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®é™…ä¸Šæ‰§è¡Œäº†æ³¨å†ŒAPIè¯·æ±‚å¹¶ä¿å­˜äº†èº«ä»½éªŒè¯ tokenï¼Œç„¶åé€šçŸ¥äº†çˆ¶coordinatorã€‚æ¯å½“ViewControllerå‘ç”Ÿä»»ä½•äº‹æƒ…ï¼ˆä¾‹å¦‚ç”¨æˆ·è¾“å…¥ï¼‰æ—¶ï¼ŒViewControlleréƒ½ä¼šå‘Šè¯‰å…¶delegateï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºCoordinatorï¼‰ï¼Œå¹¶ä¸”Coordinatorå°†æ‰§è¡Œç”¨æˆ·æƒ³è¦çš„å®é™…ä»»åŠ¡ã€‚è®©Coordinatoræ¥å®Œæˆè¿™é¡¹å·¥ä½œå¾ˆé‡è¦ï¼Œä»¥ä¾¿ ViewController ä¿æŒæƒ°æ€§ã€‚ ä¸ºä»€ä¹ˆ Coordinators å¾ˆå¥½ç”¨ 1.æ¯ä¸ª ViewController ç°åœ¨æ˜¯å­¤ç«‹çš„é™¤äº†çŸ¥é“å¦‚ä½•å‘ˆç°æ•°æ®ï¼ŒViewController å•¥éƒ½ä¸çŸ¥é“ã€‚æ¯å½“æœ‰ä»€ä¹ˆäº‹å‘ç”Ÿæ—¶ï¼Œå®ƒéƒ½ä¼šé€šçŸ¥ delegateï¼Œä½†æ˜¯å½“ç„¶å®ƒä¸çŸ¥é“å…¶ delegate æ˜¯è°ã€‚ä»¥å‰ï¼Œå½“åˆ†æ”¯æ—¶ï¼ŒViewController éœ€è¦é—®â€œå¥½å§ï¼Œæˆ‘åœ¨iPadè¿˜æ˜¯iPhoneä¸Šï¼Ÿâ€ã€‚â€œç”¨æˆ·æ˜¯å¦æ­£åœ¨æ¥å—A / Bæµ‹è¯•ï¼Ÿâ€ ä»–ä»¬ä¸å†éœ€è¦æè¿™æ ·çš„é—®é¢˜ã€‚æˆ‘ä»¬æ˜¯å¦åªæ˜¯å°†è¿™ä¸ªæœ‰æ¡ä»¶çš„é—®é¢˜æ¨ç»™äº† Coordinator ï¼Ÿä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»¥æ›´å¥½çš„æ–¹å¼è§£å†³å®ƒã€‚å½“ç¡®å®éœ€è¦ä¸€æ¬¡å…·æœ‰ä¸¤ä¸ª flow æ—¶ï¼Œå¯¹äºA / Bæµ‹è¯•æˆ–å¤šä¸ª size classesï¼Œä½ å¯ä»¥äº¤æ¢æ•´ä¸ª Coordinator å¯¹è±¡ï¼Œè€Œä¸å¿…åœ¨æ•´ä¸ª ViewController ä¸Šç²˜è´´ä¸€å †æ¡ä»¶ã€‚å¦‚æœä½ æƒ³äº†è§£ flow çš„å·¥ä½œæ–¹å¼ï¼Œé‚£ä¹ˆè¿™éå¸¸å®¹æ˜“ï¼Œå› ä¸ºæ‰€æœ‰ä»£ç éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚ 2.ViewControllers ç°åœ¨å¯ä»¥å¤ç”¨ViewControllers å¯¹è¦æ˜¾ç¤ºçš„ä¸Šä¸‹æ–‡æˆ–æŒ‰é’®çš„ç”¨é€”ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚å®ƒä»¬å¯ä»¥è¢«ä½¿ç”¨å’Œé‡æ–°ä½¿ç”¨ï¼Œä»¥ä¿æŒå…¶ç¾è§‚ï¼Œè€Œä¸ä¼šæ‹–ç´¯ä»»ä½•é€»è¾‘ã€‚å¦‚æœä½ è¦ç¼–å†™iPadç‰ˆæœ¬çš„appï¼Œåˆ™åªéœ€æ›¿æ¢ Coordinator å³å¯ï¼Œå¹¶ä¸”å¯ä»¥é‡å¤ä½¿ç”¨æ‰€æœ‰ViewControllersã€‚ 3.appä¸­æ¯ä¸ªä»»åŠ¡å’Œå­ä»»åŠ¡éƒ½æœ‰ä¸€ç§ä¸“ç”¨çš„å°è£…æ–¹å¼å³ä½¿ä»»åŠ¡å¯ä»¥åœ¨å¤šä¸ª ViewControllers ä¸Šè¿è¡Œï¼Œå®ƒä¹Ÿä¼šè¢«å°è£…ã€‚å¦‚æœä½ çš„iPadç‰ˆæœ¬é‡å¤ä½¿ç”¨äº†å…¶ä¸­çš„ä¸€äº›å­ä»»åŠ¡ï¼Œä½†æ²¡æœ‰é‡å¤ä½¿ç”¨ï¼Œåˆ™ä»…ä½¿ç”¨è¿™äº›å­ä»»åŠ¡å°±éå¸¸å®¹æ˜“ã€‚ 4.Coordinator å°†æ˜¾ç¤ºç»‘å®šä¸å‰¯ä½œç”¨åˆ†å¼€ä½ å†ä¹Ÿä¸å¿…æ‹…å¿ƒåœ¨å‘ˆç° ViewControlleræ—¶ï¼ŒViewControllerç ´åæ•°æ®äº†ã€‚å®ƒåªèƒ½è¯»å–å’Œæ˜¾ç¤ºï¼Œä¸èƒ½å†™å…¥æˆ–ç ´åæ•°æ®ã€‚è¿™ä¸å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»ç›¸ä¼¼ã€‚ 5. Coordinatoræ˜¯å®Œå…¨ç”±ä½ æ§åˆ¶çš„å¯¹è±¡ä½ ä¸å¿…ç­‰å¾… -viewDidLoad è°ƒç”¨äº†ï¼Œæ‰å¯ä»¥è¿›è¡Œå·¥ä½œã€‚ç°åœ¨å®Œå…¨å¯ä»¥è‡ªå·±æ§åˆ¶å·¥ä½œã€‚åœ¨UIViewControllerè¶…ç±»ä¸­æ²¡æœ‰çœ‹ä¸è§çš„ä»£ç åœ¨åšä½ ä¸çŸ¥é“çš„äº‹ã€‚å–ä»£è¢«è°ƒç”¨ï¼Œä½ å¼€å§‹è¿™ä¸ªè°ƒç”¨ã€‚ç¿»è½¬æ­¤æ¨¡å‹å¯ä»¥æ›´è½»æ¾åœ°äº†è§£å‘ç”Ÿäº†ä»€ä¹ˆã€‚appçš„è¡Œä¸ºå¯¹ä½ å®Œå…¨é€æ˜ï¼ŒUIKit ç°åœ¨åªæ˜¯ä½ è¦ä½¿ç”¨å®ƒæ—¶è°ƒç”¨çš„åº“ã€‚Backchannel SDK ä½¿ç”¨æ­¤æ¨¡å¼æ¥ç®¡ç†å…¶æ‰€æœ‰ ViewControllersã€‚app coordinator å’Œèº«ä»½éªŒè¯ coordinator ç¤ºä¾‹æ¥è‡ªè¯¥é¡¹ç›®ã€‚æœ€åï¼ŒCoordinator åªæ˜¯ä¸€ç§ç»„ç»‡æ¨¡å¼ã€‚æ²¡æœ‰ä½ èƒ½ä½¿ç”¨çš„ Coordinator åº“ï¼Œå› ä¸ºå®ƒå¾ˆç®€å•ã€‚æ²¡æœ‰å¯ä»¥ pod çš„ Coordinatoråº“ï¼Œä¹Ÿç±³æœ‰å¯ä»¥ç»§æ‰¿çš„å­ç±»ã€‚ç”šè‡³æ²¡æœ‰ä¸€ä¸ªå¯éµå¾ªçš„åè®®ã€‚è¿™ä¸æ˜¯ç¼ºç‚¹ï¼Œè€Œæ˜¯ä½¿ç”¨åƒCoordinatorè¿™æ ·çš„æ¨¡å¼çš„ä¼˜ç‚¹ï¼šå®ƒåªæ˜¯ä½ çš„ä»£ç ï¼Œæ²¡æœ‰ä¾èµ–é¡¹ã€‚ä»–ä»¬å°†ä½¿ä½ çš„appå’Œä»£ç æ›´æ˜“äºç®¡ç†ã€‚ViewControllerå°†å…·æœ‰æ›´é«˜çš„å¯é‡ç”¨æ€§ï¼Œå¹¶ä¸”æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´å®¹æ˜“å¼€å‘ä½ çš„ appã€‚","tags":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"}]},{"title":"RxFlow 3: æç¤ºå’ŒæŠ€å·§","date":"2018-01-22T02:28:43.000Z","path":"2018/01/22/RxSwfit+RAC/RxFlow-3-æç¤ºå’ŒæŠ€å·§/","text":"è¿™ç¯‡æ˜¯ RxFlow ç³»åˆ—æ–‡ç« çš„æœ€åä¸€ç« ã€‚åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å·²ç»ä»‹ç»äº†æ‰€æœ‰å…³é”®åŠŸèƒ½/åŸç†è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨æˆ‘åœ¨å“åº”å¼ç¼–ç¨‹ä¸­å‘ç°çš„æŠ€å·§å’Œçªé—¨ã€‚ UIViewController æ”¯æŒ Reactiveæ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬2ç¯‡ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦ä»¥å“åº”æ–¹å¼çŸ¥é“ä½•æ—¶æ˜¾ç¤ºä¸€ä¸ªPresentableã€‚ä¸€ä¸ª Presentable æš´éœ²ä¸‰ä¸ª Observablesï¼šcode 12345678910/// Observable that triggers a bool indicating if/// the current Presentable is being displayedvar rxVisible: Observable&lt;Bool&gt; &#123; get &#125;/// Single triggered when this presentable is displayed/// for the first timevar rxFirstTimeVisible: Single&lt;Void&gt; &#123; get &#125;/// Single triggered when this presentable is dismissedvar rxDismissed: Single&lt;Void&gt; &#123; get &#125; åœ¨ RxFlow ä¸­ï¼ŒUIViewController éµä» Presentable åè®®ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°æ–¹æ³•è®©ä»–ä»¬æ”¯æŒ Reactiveã€‚å¹¸è¿çš„æ˜¯åœ¨æ­¤è¿‡ç¨‹ä¸­å‘ç°çš„ä¸€ä¸ªé¡¹ç›®åœ¨æ­¤æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§ä½œç”¨ï¼šRxViewController.é€šè¿‡åº”ç”¨æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­(Swiftä¸­çš„é™æ€åç§°ç©ºé—´)æè¿°çš„æ¨¡å¼ï¼Œå®ƒä¸ºUIViewControllersæä¾›äº†Reactiveæ‰©å±•ã€‚å®ƒä½¿ç”¨RxCocoaå†…ç½®å‡½æ•°å…è®¸è§‚å¯Ÿé€‰æ‹©å™¨è°ƒç”¨ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€æ¦‚å¿µï¼Œä¾¿å¯¹UIViewControllerè¿›è¡Œäº†è‡ªå·±çš„æ‰©å±•ã€‚code 123456789101112131415161718192021222324extension Reactive where Base: UIViewController &#123; /// Observable, triggered when the view has appeared for the first time public var firstTimeViewDidAppear: Single&lt;Void&gt; &#123; return sentMessage(#selector(Base.viewDidAppear)).map &#123; _ in return Void() &#125;.take(1).asSingle() &#125; /// Observable, triggered when the view is being dismissed public var dismissed: ControlEvent&lt;Bool&gt; &#123; let source = sentMessage(#selector(Base.dismiss)) .map &#123; $0.first as? Bool ?? false &#125; return ControlEvent(events: source) &#125; /// Observable, triggered when the view appearance state changes public var displayed: Observable&lt;Bool&gt; &#123; let viewDidAppearObs = sentMessage(#selector(Base.viewDidAppear)) .map &#123; _ in true &#125; let viewWillDisappearObs = sentMessage(#selector(Base.viewWillDisappear)) .map &#123; _ in false &#125; return Observable&lt;Bool&gt;.merge(viewDidAppearObs, viewWillDisappearObs) &#125;&#125; ä½œä¸ºè®°å½•ï¼Œè¿™å°±æ˜¯ Coordinator çš„ç”¨æ³•ï¼Œå…¶ä¸­ â€œnextPresentableâ€ æ˜¯ç”± Flow ä¸Šçš„ â€œnavigateï¼ˆto : )â€ å‡½æ•°ç”Ÿæˆçš„ Presentable ã€‚åœ¨å·²ç»å…³è”çš„Presentableé¦–æ¬¡æ˜¾ç¤ºä¹‹åï¼Œæˆ‘ä»¬ä»…ç›‘å¬ä¸‹ä¸€ä¸ªStepperã€‚code 1234567891011121314151617nextPresentable.rxFirstTimeVisible.subscribe(onSuccess: &#123; [unowned self, unowned nextPresentable, unowned nextStepper] (_) in // we listen to the presentable's Stepper. // For each new Step value, we trigger a new navigation process // this is the core principle of the whole RxFlow mechanism // The process is paused each time the presentable is not currently displayed // for instance when another presentable is above it in the VCs hierarchy. nextStepper.steps .pausable(nextPresentable.rxVisible.startWith(true)) .asDriver(onErrorJustReturn: NoStep()) .drive(onNext: &#123; [unowned self] (step) in // the nextPresentable's Stepper fires a new Step self.steps.onNext(step) &#125;).disposed(by: nextPresentable.disposeBag)&#125;).disposed(by: self.disposeBag) æš‚åœåœ¨ RxFlow ä¸­å¦ä¸€ä¸ªå…³é”®åŸåˆ™ï¼šFlow ä¸­å‘ç”Ÿä»€ä¹ˆå°±è¦åœç•™åœ¨ Flow ä¸­ã€‚å› æ­¤æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªæ–¹å¼","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxFlow 2: å®è·µ","date":"2018-01-21T08:24:56.000Z","path":"2018/01/21/RxSwfit+RAC/RxFlow-2-å®è·µ/","text":"æ³¨æ„ï¼ï¼ï¼1public typealias NextFlowItems = FlowContributorsåŸæ–‡RxFlow Part 2: In Practiceä¸Šç¯‡ï¼šRxFlow-1-åŸç†å‡ å‘¨å‰æˆ‘ä»‹ç»äº† RxFlow æ¡†æ¶ï¼Œæˆ‘å·²ç»åœ¨è¿™ä¸ªæ¡†æ¶ä¸Šå·¥ä½œäº†å‡ ä¸ªæœˆï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨äº†ã€‚å¦‚æœæ‚¨å°šæœªé˜…è¯»ï¼Œå»ºè®®æ‚¨çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ã€‚æ€»ç»“ï¼ŒRxFlow æ—¨åœ¨ï¼šè½»æ¾çš„å°†ä½ çš„å¯¼èˆªåˆ‡æˆé€»è¾‘éƒ¨åˆ†æŠŠå¯¼èˆªä»£ç ä» ViewController ä¸­åˆ é™¤é¼“åŠ± ViewController å¤ç”¨æ€§ä¿ƒè¿› å“åº”å¼ç¼–ç¨‹ä¿ƒè¿› ä¾èµ–æ³¨å…¥å¿«é€Ÿå›å¿†ä¸‹ä»¥ä¸‹æœ¯è¯­ï¼šFlow: æ¯ä¸ª Flow éƒ½åœ¨åº”ç”¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªå¯¼èˆªåŒºåŸŸã€‚Step: åœ¨åº”ç”¨ä¸­ï¼Œæ¯ä¸ª Step å°±æ˜¯ä¸€ä¸ªå¯¼èˆªçŠ¶æ€ï¼ŒFlows å’Œ Steps çš„ç»“åˆæè¿°äº†æœ‰æ‰€å¯¼èˆªæ“ä½œçš„å¯èƒ½ã€‚Stepper: ä»»ä½•å¯ä»¥å‘å‡º Steps çš„ä¸œè¥¿ã€‚Steppers è´Ÿè´£è§¦å‘æ¯ä¸ªåœ¨ Flows ä¸­çš„å¯¼èˆªæ“ä½œPresentable: å¯ä»¥è¢«å‘ˆç°å‡ºæ¥çš„äº‹ç‰©çš„æŠ½è±¡ï¼ˆåŸºæœ¬ä¸Šæ˜¯ UIViewController å’Œ å¯ä»¥å‘ˆç°çš„ Flowï¼‰NextFlowItem(FlowContributors): ä»–ä¼šå‘Šè¯‰ Coordinatorï¼Œåœ¨ä»–çš„å“åº”æœºåˆ¶ä¸­ï¼Œæ¥ä¸‹æ¥å°†ä¼šæ˜¯ä»€ä¹ˆäº§ç”Ÿæ–°çš„ StepsCoordinator: Coordinator çš„å·¥ä½œæ˜¯ä»¥ä¸€ç§ä¸€ç›´çš„æ–¹å¼æ··åˆFlows and Stepsç»„åˆåŒæ ·é‡è¦çš„æ˜¯è¦è®°ä½ï¼ŒRxFlowä½¿ç”¨é¢å‘åè®®çš„ç¨‹åºè®¾è®¡ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šå°†ä»£ç å†»ç»“åœ¨ç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­ã€‚åœ¨ RxFlow repo ä¸­ï¼Œä½ å°†æ‰¾åˆ°ä¸€ä¸ªæ¼”ç¤ºåº”ç”¨ç¨‹åºã€‚å®ƒå‡ ä¹æ˜¾ç¤ºäº†æ¯ç§å¯èƒ½çš„å¯¼èˆªç±»å‹Navigation stackTab barMaster / detailModal popup éƒ½æ˜¯å…³äº StatesRxFlow ä¸»è¦æ˜¯ä½¿ç”¨å“åº”å¼çš„æ–¹å¼å¤„ç†å¯¼èˆªçŠ¶æ€ã€‚ä¸ºäº†åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­å¤ç”¨ï¼Œè¿™äº›çŠ¶æ€ä¸€å®šè¦ä¸çŸ¥é“å½“å‰ä½¿ç”¨çš„å¯¼èˆª Flowã€‚å› æ­¤ï¼ŒçŠ¶æ€ä¸æ˜¯è¡¨ç¤ºâ€œæˆ‘è¦è·³è½¬åˆ°æ­¤å±å¹•â€ï¼Œè€Œæ˜¯è¡¨ç¤ºâ€œæŸäººæˆ–æŸç‰©æ‰§è¡Œæ­¤æ“ä½œâ€ï¼Œç„¶åRxFlowä¼šæ ¹æ®å½“å‰å¯¼èˆª Flow é€‰æ‹©æ­£ç¡®çš„screenã€‚å¯¹äº RxFlowï¼Œè¿™ä¸ªå¯¼èˆªçŠ¶æ€ç§°ä¸ºâ€œStepsâ€ã€‚æšä¸¾æ˜¯æè¿° Steps çš„å¥½æ–¹æ³•:æšä¸¾æ–¹ä¾¿ä½¿ç”¨ä¸€ä¸ª value åªå¯ä»¥è¢«å®šä¹‰ä¸€æ¬¡(å› æ­¤ä¸€ä¸ªçŠ¶æ€æ˜¯æƒŸä¸€çš„)æšä¸¾å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå› ä¸ºSwiftåœ¨ switch è¯­æ³•ä¸­è¦æ±‚ä½ å®ç°æ‰€æœ‰å¯èƒ½å€¼æšä¸¾å¯ä»¥å…³è” valueï¼Œè¿™äº›value å¯ä»¥ä»ä¸€ä¸ª screen ä¼ åˆ°å¦ä¸€ä¸ª screenæšä¸¾æ˜¯å€¼ç±»å‹ï¼Œå› æ­¤ä¸å­˜åœ¨ä¼ é€’ä¸å—æ§åˆ¶çš„å…±äº«å‚è€ƒeg: åœ¨ demo App ä¸­ï¼Œè¿™äº›éƒ½æ˜¯æˆ‘ä»¬æ¶µç›–å¯¼èˆªå¯èƒ½æ€§æ‰€éœ€çš„æ‰€æœ‰ Stepsã€‚ 1234567891011121314import RxFlowenum DemoStep: Step &#123; case apiKey case apiKeyIsComplete case movieList case moviePicked (withMovieId: Int) case castPicked (withCastId: Int) case settings case settingsDone case about&#125; ä½¿ç”¨ Flowå¯¹äº RxFlowï¼Œæ‰€æœ‰å¯¼èˆªä»£ç éƒ½åœ¨ Flow ä¸­å£°æ˜ï¼Œegï¼špresenting æˆ–è€… pushing ViewControllerã€‚åœ¨ä½ çš„ App ä¸­ä¸€ä¸ª Flow ä»£è¡¨äº†å¯¼èˆªé€»è¾‘æ®µï¼Œå½“ Flow å’Œä¸€ä¸ªæ˜ç¡®çš„ Step ç»“åˆåï¼ŒFlowè§¦å‘å¯¼èˆªåŠ¨ä½œã€‚ä¸ºæ­¤ï¼ŒFlow è¦å®ç°ï¼šä¸€ä¸ª â€œnavigate(to:)â€ æ–¹æ³•æ ¹æ® Flow å’Œ Stepï¼Œæ‰§è¡Œå¯¼èˆªæ“ä½œä¸€ä¸ª â€œrootâ€ UIViewControllerï¼Œä»–å°†åŸºäºåœ¨æ­¤ Flow ä¸­çš„å¯¼èˆªæœ‰ä¸ª Flow æ§åˆ¶ UINavigationController å’Œ stackçš„ä¾‹å­ã€‚åœ¨è¿™ä¸ª Flow ä¸­ï¼Œå¯ä»¥æ‰§è¡Œ3ä¸ªå¯¼èˆªæ“ä½œã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758import RxFlowimport UIKitclass WatchedFlow: Flow &#123; var root: UIViewController &#123; return self.rootViewController &#125; private let rootViewController = UINavigationController() private let service: MoviesService init(withService service: MoviesService) &#123; self.service = service &#125; func navigate(to step: Step) -&gt; [NextFlowItem] /*FlowContributors*/ &#123; guard let step = step as? DemoStep else &#123; return NextFlowItem.noNavigation &#125; switch step &#123; case .movieList: return navigateToMovieListScreen() case .moviePicked(let movieId): return navigateToMovieDetailScreen(with: movieId) case .castPicked(let castId): return navigateToCastDetailScreen(with: castId) default: return NextFlowItem.noNavigation &#125; &#125; private func navigateToMovieListScreen () -&gt; [NextFlowItem]/*FlowContributors*/ &#123; let viewModel = WatchedViewModel(with: self.service) let viewController = WatchedViewController.instantiate(with: viewModel) viewController.title = \"Watched\" self.rootViewController.pushViewController(viewController, animated: true) return [NextFlowItem(nextPresentable: viewController, nextStepper: viewModel)] &#125; private func navigateToMovieDetailScreen (with movieId: Int) -&gt; [NextFlowItem]/*FlowContributors*/ &#123; let viewModel = MovieDetailViewModel(withService: self.service, andMovieId: movieId) let viewController = MovieDetailViewController.instantiate(with: viewModel) viewController.title = viewModel.title self.rootViewController.pushViewController(viewController, animated: true) return [NextFlowItem(nextPresentable: viewController, nextStepper: viewModel)] &#125; private func navigateToCastDetailScreen (with castId: Int) -&gt; [NextFlowItem]/*FlowContributors*/ &#123; let viewModel = CastDetailViewModel(withService: self.service, andCastId: castId) let viewController = CastDetailViewController.instantiate(with: viewModel) viewController.title = viewModel.name self.rootViewController.pushViewController(viewController, animated: true) return NextFlowItem.noNavigation &#125;&#125; å¯¼èˆªæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨åœ¨å­¦ä¹ å‡½æ•°å“åº”å¼ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸è¯»åˆ° å‰¯ä½œç”¨ã€‚FRP çš„ç›®çš„æ˜¯ä¼ é€’äº‹ä»¶ï¼Œç„¶åå†æ•´è¿‡ç¨‹ä¸­ä½¿ç”¨ FRP çš„å‡½æ•°å¤„ç†äº‹ä»¶ã€‚è¿™äº›functions å¯ä»¥è½¬æ¢äº‹ä»¶ï¼Œæœ€ç»ˆ(ä½†æ˜¯ä¸æ˜¯å¿…é¡»)å°†æ‰§è¡Œä½ æƒ³è¦çš„ä»»ä½•åŠŸèƒ½çš„ä»£ç (ç½‘ç»œè¯·æ±‚ï¼Œä¿å­˜æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸€ä¸ª alertâ€¦â€¦)ï¼šè¿™äº›æ˜¯ å‰¯ä½œç”¨å› ä¸º RxFlow ä¾èµ–å“åº”å¼ç¼–ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¯†åˆ«å‡ºå›ºæœ‰çš„æ¦‚å¿µï¼ševentsï¼šå‘å‡º Stepsfunctionï¼šå°±æ˜¯ â€œnavigate(to:)â€ functiontransformationï¼šâ€œnavigate(to:)â€ å°† Step è½¬æ¢æˆå¦ä¸€ä¸ª NextFlowItem (FlowContributors)side effectsï¼šæ‰§è¡Œåœ¨â€œnavigate(to:)â€ä¸­çš„å¯¼èˆªæ“ä½œï¼ˆeg: â€œnavigateToMovieListScreen()â€ æ–¹æ³•åœ¨navigation stack ä¸Š push ä¸€ä¸ªæ–°çš„UIViewControllerï¼‰ Navigating æ˜¯ä¸ºäº†ç”Ÿæˆ NextFlowItems(FlowContributors)æ¥ç€æ¥è¯´ï¼Œä¸€ä¸ª NextFlowItem(FlowContributors) æ˜¯ä¸€ä¸ªæŒæœ‰ä¸€ä¸ª Presentable å’Œä¸€ä¸ª Stepper ç®€å•çš„æ•°æ®ç»“æ„ã€‚Presentable å‘Šè¯‰ Coordinator æ¥ä¸‹æ¥ä½ è¦ present å‡ºæ¥çš„æ˜¯ä»€ä¹ˆStepper å‘Šè¯‰ Coordinator æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆä¸œè¥¿å‘å‡º Stepsé»˜è®¤æƒ…å†µï¼Œæ‰€æœ‰çš„ UIViewController éƒ½æ˜¯ Presentable. Flows ä¹Ÿæ˜¯ Presentableï¼Œå› ä¸ºæœ‰äº‹ï¼Œä½ æƒ³å¯åŠ¨ä¸€ä¸ªæ–°çš„å¯¼èˆªåŒºåŸŸï¼Œè¯¥åŒºåŸŸåœ¨ä»–è‡ªå·±çš„ Flow ä¸­æè¿°ï¼Œæ‰€ä»¥ RxFlow ä¹Ÿä¼šæŠŠä»–å½“åšå¯ä»¥è¢« present çš„ä¸œè¥¿ä¸ºä»€ä¹ˆ Coordinator è¦çŸ¥é“ Presentablesï¼ŸPresentable æ˜¯ä¸€ä¸ªæè¿°å¯ä»¥è¢«å‘ˆç°çš„äº‹ç‰©çš„æŠ½è±¡ç±»ã€‚å› ä¸º Step ä¸ä¼šè¢«å‘å‡ºï¼Œé™¤éä»–å…³è”çš„ Presentable è¢«æ˜¾ç¤ºï¼ŒPresentable æä¾› Observablesï¼ŒCoordinator ä¼šè®¢é˜…è¿™ä¸ª Observablesï¼ˆæ‰€ä»¥ Coordinator ä¼šçŸ¥é“ Presentable çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰ã€‚å› æ­¤ Presentable æ²¡æœ‰å®Œå…¨æ˜¾ç¤ºçš„æ—¶å€™å‘é€ä¸€ä¸ª Step ä¸å­˜åœ¨ä»»ä½•å±é™©ã€‚Stepper å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼šè‡ªå®šä¹‰çš„ UIViewControllerï¼ŒViewModelï¼ŒPresenterâ€¦â€¦ ä¸€æ—¦ä»–åœ¨ Coordinator ä¸­æ³¨å†Œï¼ŒStepper å°±å¯ä»¥é€šè¿‡ä»–çš„ â€step&quot; å±æ€§å‘é€ Steps(step æ˜¯ RxSwift ä¸­çš„ subject)ã€‚ Coordinator ä¼šç›‘å¬ Stepper å‘é€å‡ºæ¥çš„ Stepsï¼Œè°ƒç”¨ Flowâ€™s â€œnavigate(to:)â€åœ¨ demo App ä¸­æœ‰ä¸€ä¸ª Stepper ä¾‹å­ï¼š 123456789101112131415161718192021import RxFlowimport RxSwiftclass WatchedViewModel: Stepper &#123; let movies: [MovieViewModel] init(with service: MoviesService) &#123; // we can do some data refactoring in order to display // things exactly the way we want (this is the aim of a ViewModel) self.movies = service.watchedMovies().map(&#123; (movie) -&gt; MovieViewModel in return MovieViewModel(id: movie.id, title: movie.title, image: movie.image) &#125;) &#125; public func pick (movieId: Int) &#123; self.step.onNext(DemoStep.moviePicked(withMovieId: movieId)) &#125;&#125; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ª movieçš„æ—¶å€™ä¼šè°ƒç”¨ pick å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ¨ â€œself.stepâ€ Rx Stream ä¸­å‘å‡ºä¸€ä¸ªnew valueã€‚æ€»ç»“å¯¼èˆªè¿‡ç¨‹ï¼šnavigate(to:) å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼ å…¥ä¸€ä¸ª Step ä½œä¸ºå‚æ•°æ ¹æ®è¿™ä¸ª Stepï¼Œä¸€äº›å¯¼èˆªä»£ç è¢«è°ƒç”¨ï¼ˆside effectsï¼‰ä¹Ÿæ ¹æ®è¿™ä¸ª Stepï¼Œäº§ç”Ÿ NextFlowItems (FlowContributors)ã€‚å› æ­¤ï¼ŒPresentables å’Œ Steppers è¢«æ³¨å†Œè¿› Coordinator ä¸­Steppers å‘å‡ºæ–°çš„ Stepsï¼Œç„¶åå†æ¥ä¸€æ¬¡ä»¥ä¸Šè¿‡ç¨‹ ä¸ºä»€ä¹ˆå¯¹ä¸ä¸€ä¸ª Flow &amp; Step ç»„åˆäº§ç”Ÿå¤šä¸ª NextFlowItems (FlowContributors)æ˜¯å¯ä»¥çš„ï¼Ÿå› ä¸ºåœ¨æŸä¸€ä¸ªæ—¶é—´æ²¡æœ‰ä»€ä¹ˆç¦æ­¢ä¸€ä¸ªappæœ‰å¤šä¸ªå¯¼èˆªã€‚eg: tab barä¸Šé¢çš„æ¯ä¸€ä¸ªitem å¤šä¼šå¯¼å‘ä¸€ä¸ª navigation stackã€‚Step è§¦å‘UITabbarController æ˜¾ç¤ºï¼Œå°†åœ¨æ¯ä¸ªnavigation stack ä¸­ç”Ÿæˆä¸€ä¸ª NextFlowItem (FlowContributors)ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ demo app ç†è§£ä¸€ä¸‹æ¦‚å¿µã€‚è¿™é‡Œæœ‰æˆ‘ä»¬æŠŠä¸€ä¸ª UITabbarController å’Œ 2ä¸ªFlowsè¿æ¥çš„ä¸€æ®µä»£ç ã€‚ 1234567891011121314151617181920212223242526272829private func navigationToDashboardScreen () -&gt; [NextFlowItem] /*(FlowContributors)*/ &#123; let tabbarController = UITabBarController() let wishlistStepper = WishlistStepper() let wishListFlow = WishlistWarp(withService: self.service, andStepper: wishlistStepper) let watchedFlow = WatchedFlow(withService: self.service) Flows.whenReady(flow1: wishListFlow, flow2: watchedFlow, block: &#123; [unowned self] (root1: UINavigationController, root2: UINavigationController) in let tabBarItem1 = UITabBarItem(title: \"Wishlist\", image: UIImage(named: \"wishlist\"), selectedImage: nil) let tabBarItem2 = UITabBarItem(title: \"Watched\", image: UIImage(named: \"watched\"), selectedImage: nil) root1.tabBarItem = tabBarItem1 root1.title = \"Wishlist\" root2.tabBarItem = tabBarItem2 root2.title = \"Watched\" tabbarController.setViewControllers([root1, root2], animated: false) self.rootViewController.pushViewController(tabbarController, animated: true) &#125;) return ([NextFlowItem(nextPresentable: wishListFlow, nextStepper: wishlistStepper), NextFlowItem(nextPresentable: watchedFlow, nextStepper: OneStepper(withSingleStep: DemoStep.movieList))])&#125; é™æ€æ–¹æ³• â€œFlows.whenReady()â€ å¸¦ç€å‚æ•° Flows å¯åŠ¨è¿˜å¸¦æœ‰ä¸€ä¸ªé—­åŒ…ï¼Œå½“ Flows å‡†å¤‡æ˜¾ç¤ºçš„æ—¶å€™å›è°ƒï¼ˆå³å½“Flowçš„ç¬¬ä¸€ä¸ªå±å¹•è¢«é€‰ä¸­çš„æ—¶å€™ï¼‰ ä¸ºä»€ä¹ˆå¯¹äºFlowå’ŒStepçš„ç»„åˆå®Œå…¨ä¸äº§ç”ŸNextFlowItem(FlowContributors)ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ï¼Ÿå› ä¸ºå¯¼èˆª Flow å¿…é¡»è¦æœ‰ä¸€ä¸ªç»ˆç‚¹ï¼eg å¯¼èˆªstackçš„æœ€åä¸€ä¸ªå±å¹•ä¸ä¼šå†å‘ä¸‹å¯¼èˆªï¼Œä»–åªå¯ä»¥ pop backã€‚åœ¨è¿™ç§æƒ…å†µï¼Œâ€œnavigate(to:)â€ è¿”å› NextFlowItem.noNavigationã€‚ åœ¨ Flow ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆâ€¦â€¦åœç•™åœ¨ Flow ä¸­ï¼æ­£å¦‚æˆ‘ä»¬å·²ç»çœ‹åˆ°çš„ï¼Œåœ¨åŒä¸€æ—¶é—´æœ‰å¤šä¸ª Flows è¢«å¯¼èˆªæ˜¯å¯ä»¥çš„ã€‚egï¼šåœ¨ navigation stack ä¸­çš„ä¸€ä¸ª screen å¯ä»¥å¯åŠ¨å¼¹å‡ºçª—å£ï¼Œè¯¥å¼¹å‡ºçª—å£ä¹Ÿå¯ä»¥åŒ…å«å¦ä¸€ä¸ªnavigation stackã€‚ä» UIKit çš„è§’åº¦ä¸Šçœ‹ï¼ŒUIViewControllerçš„å±‚çº§ç»“æ„éå¸¸é‡è¦ï¼Œæˆ‘ä»¬ä¸èƒ½å¼„æ·· Coordinator å†…éƒ¨çš„å±‚æ¬¡ç»“æ„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“ä¸€ä¸ª Flow æ²¡æœ‰æ˜¾ç¤ºï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯å½“ç¬¬ä¸€ä¸ª navigation stack åœ¨å¼¹å‡ºçª—å£ä¹‹ä¸‹ï¼‰ï¼ŒCoordinatorå°†å¿½è§† Flow ä¸­å¯èƒ½å‘å‡ºæ¥çš„ Stepsã€‚ä»æ›´ä¸€èˆ¬çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨ Flow ä¸Šä¸‹æ–‡ä¸­å‘å‡ºçš„ Steps åªèƒ½åœ¨è¯¥ Flow ä¸Šä¸‹æ–‡ä¸­è§£é‡Šï¼ˆå®ƒä»¬ä¸èƒ½è¢«å…¶ä»– Flow æ•è·ï¼‰ã€‚ ä¾èµ–æ³¨å…¥å˜å¾—å®¹æ˜“DI æ˜¯RxFlowçš„ä¸€ä¸ªä¸»è¦ç›®æ ‡ã€‚åŸºæœ¬ä¸Šï¼Œä¾èµ–æ³¨å…¥å¯ä»¥é€šè¿‡å°†æŸç§å®ç°ï¼ˆæœåŠ¡ï¼Œç®¡ç†å™¨ç­‰ï¼‰ä½œä¸ºå‚æ•°ä¼ é€’ç»™åˆå§‹åŒ–ç¨‹åºæˆ–æ–¹æ³•æ¥å®Œæˆï¼ˆä¹Ÿå¯ä»¥é€šè¿‡å±æ€§æ¥å®Œæˆï¼‰ã€‚åœ¨ RxFlow ä¸­, å¼€å‘äººå‘˜è´Ÿè´£å®ä¾‹åŒ–UIViewControllersï¼ŒViewModelsï¼ŒPresenterç­‰,è¿™æ˜¯ä¸€ä¸ªæ³¨å…¥ä½ æ‰€éœ€ä»£ç çš„ç»ä½³æœºä¼šã€‚ä¸‹é¢æ˜¯ViewModelä¸­ä¾èµ–é¡¹æ³¨å…¥çš„ç¤ºä¾‹ã€‚ 123456789101112131415161718192021222324import RxFlowimport UIKitclass WatchedFlow: Flow &#123; ... private let service: MoviesService init(withService service: MoviesService) &#123; self.service = service &#125; ... private func navigateToMovieListScreen () -&gt; [NextFlowItem] /*(FlowContributors)*/ &#123; // inject Service into ViewModel let viewModel = WatchedViewModel(with: self.service) // injecy ViewMNodel into UIViewController let viewController = WatchedViewController.instantiate(with: viewModel) viewController.title = \"Watched\" self.rootViewController.pushViewController(viewController, animated: true) return [NextFlowItem(nextPresentable: viewController, nextStepper: viewModel)] &#125; ...&#125; å¦‚ä½•å¼•å¯¼å¯¼èˆªè¿‡ç¨‹æ—¢ç„¶å·²ç»çŸ¥é“å¦‚ä½•å°†äº‹ç‰©ç»„åˆåœ¨ä¸€èµ·ï¼Œå°† Flows å’Œ Steps æ··åˆåœ¨ä¸€èµ·ä»¥è§¦å‘å¯¼èˆªåŠ¨ä½œå¹¶äº§ç”ŸNextFlowItems (FlowContributors)ï¼Œå‰©ä¸‹è¦åšçš„ä¸€ä»¶äº‹ï¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¼•å¯¼å¯¼èˆªè¿‡ç¨‹ã€‚ä¸€åˆ‡éƒ½åœ¨AppDelegateä¸­å‘ç”Ÿï¼Œå¹¶ä¸”ä¼šå‘ç°è¿™éå¸¸ç®€å•ï¼šå®ä¾‹åŒ– Coordinatorå®ä¾‹åŒ–è¦å¯¼èˆªçš„ç¬¬ä¸€ä¸ª Flowè®© Coordinator ä½¿ç”¨ç¬¬ä¸€ä¸ª Step æ¥è°ƒåº¦ Flowå½“ç¬¬ä¸€ä¸ª Flow å‡†æœ¬å¥½äº†ï¼ŒæŠŠä»–çš„ root é…ç½®æˆ Windowçš„ rootViewControlleråœ¨ demo App ä¸­ï¼š 1234567891011121314151617181920212223242526272829303132import UIKitimport RxFlowimport RxSwiftimport RxCocoa@UIApplicationMainclass AppDelegate: UIResponder, UIApplicationDelegate &#123; let disposeBag = DisposeBag() var window: UIWindow? var coordinator = Coordinator() let movieService = MoviesService() lazy var mainFlow = &#123; return MainFlow(with: self.movieService) &#125;() func application(_ application: UIApplication, didFinishWithOptions options: [UIApplicationLaunchOptionsKey: Any]?) -&gt; Bool &#123; guard let window = self.window else &#123; return false &#125; Flows.whenReady(flow: mainFlow, block: &#123; [unowned window] (root) in window.rootViewController = root &#125;) coordinator.coordinate(flow: mainFlow, withStepper: OneStepper(withSingleStep: DemoStep.apiKey)) return true &#125;&#125; å¥–åŠ±åè°ƒå™¨æœ‰ä¸¤ä¸ªå“åº”å¼æ‰©å±•ï¼šwillNavigateå’ŒdidNavigateã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨AppDelegateä¸­è®¢é˜…å®ƒä»¬ã€‚123coordinator.rx.didNavigate.subscribe(onNext: &#123; (flow, step) in print (\"did navigate to flow=\\(flow) and step=\\(step)\")&#125;).disposedå°†ä¼šç”Ÿæˆå¦‚ä¸‹ logï¼š 12345678910111213did navigate flow=RxFlowDemo.MainFlow step=apiKeyIsCompletedid navigate flow=RxFlowDemo.WishlistFlow step=movieListdid navigate flow=RxFlowDemo.WatchedFlow step=movieListdid navigate flow=RxFlowDemo.WishlistFlow step=moviePicked(23452)did navigate flow=RxFlowDemo.WishlistFlow step=castPicked(2)did navigate flow=RxFlowDemo.WatchedFlow step=moviePicked(55423)did navigate flow=RxFlowDemo.WatchedFlow step=castPicked(5)did navigate flow=RxFlowDemo.WishlistFlow step=settingsdid navigate flow=RxFlowDemo.SettingsFlow step=settingsdid navigate flow=RxFlowDemo.SettingsFlow step=apiKeydid navigate flow=RxFlowDemo.SettingsFlow step=aboutdid navigate flow=RxFlowDemo.SettingsFlow step=apiKeydid navigate flow=RxFlowDemo.SettingsFlow step=settingsDone æ—¥å¿—å¯¹äºåˆ†æå’Œdebug ç¨‹åºå¾ˆæœ‰å¸®åŠ©","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"RxFlow 1: åŸç†","date":"2018-01-21T06:26:59.000Z","path":"2018/01/21/RxSwfit+RAC/RxFlow-1-åŸç†/","text":"åŸæ–‡RxFlow Part 1: In Theoryè¿™ç¯‡æ˜¯è¯¥ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œè¯¥ç¯‡ä¹Ÿæ˜¯è¯¥ç³»åˆ—æ–‡ç« çš„æ ¸å¿ƒã€‚æˆ‘ä¼šä»‹ç» RxFlow ï¼šå®ƒæ˜¯ä¸€ä¸ªæˆ‘åŸºäº iOS Appä¸Šè®¾è®¡å®ç°çš„å“åº”å¼æµ\bä¸­ä»‹å™¨(Reactive Flow Coordinator) äº‹å®å…³äºiOSåº”ç”¨ç¨‹åºä¸­çš„å¯¼èˆªï¼Œæœ‰ä¸¤ç§é€‰æ‹©ï¼šä½¿ç”¨ Apple Xcode æä¾›çš„å†…å»ºæœºåˆ¶ï¼šstoryboards å’Œ seguesç”¨ä»£ç å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æœºåˆ¶è¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼šå†…å»ºæœºåˆ¶ï¼šnavigation ç›¸å¯¹æ¥è¯´é™æ­¢ï¼Œstoryboards ç›¸å¯¹æ¥è¯´è¿‡äºåºå¤§ã€‚å¯¼èˆªä»£ç æ±¡æŸ“äº† UIViewControllersè‡ªå®šä¹‰æœºåˆ¶ï¼šä»£ç å¯èƒ½éš¾ä»¥è®¾ç½®ï¼Œä¹Ÿå¯èƒ½å¾ˆå¤æ‚ï¼Œå…·ä½“å–å†³äºæ‰€é€‰çš„è®¾è®¡æ¨¡å¼ï¼ˆRouterï¼ŒCoordinatorï¼‰ RxFlow æ—¨åœ¨ä¿ƒè¿›å°† storyboards åˆ‡å‰²æˆåŸå­å•å…ƒï¼Œä»¥å®ç°UIViewControllersçš„åä½œå’Œå¯é‡ç”¨æ€§å…è®¸ UIViewController æ ¹æ®å¯¼èˆªä¸Šä¸‹æ–‡ä»¥ä¸åŒæ–¹å¼å‘ˆç°ç®€åŒ–ä¾èµ–æ³¨å…¥çš„å®ç°ä»UIViewControllersåˆ é™¤å¯¼èˆªæœºåˆ¶ä¿ƒè¿›å“åº”å¼ç¼–ç¨‹åœ¨å¤„ç†å¤§å¤šæ•°å¯¼èˆªæ¡ˆä¾‹çš„åŒæ—¶ï¼Œä»¥å£°æ˜çš„æ–¹å¼è¡¨ç¤ºå¯¼èˆªï¼ˆä»¥å£°æ˜å¼çš„æ–¹å¼å¤„ç†å¯¼èˆªè¿‡ç¨‹ï¼‰ä¿ƒè¿›å°†åº”ç”¨ç¨‹åºåˆ‡æˆé€»è¾‘å¯¼èˆªå— ä» Storyboard åˆ° Coordinator æ¨¡å¼ä½œä¸º iOS å¼€å‘äººå‘˜ï¼Œéšç€å¼€å‘èƒ½åŠ›æé«˜ï¼ˆAndroidæˆ–è€…webï¼‰ï¼Œæˆ‘ç»å¸¸é‡åˆ°å…³äºå¯¼èˆªçš„åŒæ ·ç–‘é—®ã€‚å¯¹äºå…¶ä»–æ‰€æœ‰æ¦‚å¿µé—®é¢˜ï¼Œæœ‰å¾ˆå¤šæ¨¡å¼å¯ä»¥è§£å†³å¸¸è§çš„ä½“ç³»ç»“æ„é—®é¢˜å’Œå…³æ³¨ç‚¹åˆ†ç¦»éœ€æ±‚ï¼ˆMVC,MVP,MVVM,VIPER)ä½†æ˜¯ï¼Œä¸€æ—¦è®¾è®¡å¯¼èˆªï¼Œæˆ‘å°±çŠ¯æ„äº†ï¼šå¦‚ä½•åœ¨Storyboard / Seguesä¸­ä½¿ç”¨ä¾èµ–é¡¹æ³¨å…¥ï¼Ÿå¦‚ä½•æ§åˆ¶åº”ç”¨ç¨‹åºçš„æµç¨‹ï¼Ÿå¦‚ä½•æ‘†è„±UIViewControllersä¸­çš„å¯¼èˆªæ ·æ¿ä»£ç ï¼Ÿéšç€æ—¶é—´çš„æµé€ï¼Œæˆ‘å¯¹iOSåº”ç”¨ç¨‹åºä» MVCæ¨¡å¼å¸¦ä¸€ä¸ªStoryboard åˆ° MVCæ¨¡å¼å¾…å¤šä¸ª Storyboardsï¼Œæœ€ååˆ° MVVMæ¨¡å¼ + Flow Coordinator â€”â€” ç›®å‰æ¥è¯´ä»–æ˜¯æˆ‘ä»¬å¯ä»¥å«ä¸Šåå­—çš„æœ€ä½³å®è·µäº†ã€‚MVVMæ¨¡å¼ + Flow Coordinator å¥½æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¾èµ–æ³¨å…¥ï¼ŒUIViewController å¯å¤ç”¨è¡Œï¼Œå¯æµ‹è¯•æ€§ã€‚æˆ‘æœ‰æœºä¼šå°†æ­¤æ¨¡å¼åº”ç”¨äºç”Ÿäº§ä¸­çš„å¤§å‹å¤æ‚åº”ç”¨ç¨‹åºã€‚ä½†æ˜¯æœ€åï¼Œä»ç„¶æœ‰ä¸€äº›é—®é¢˜å›°æ‰°ç€æˆ‘ï¼šæˆ‘æ€»æ˜¯ä¸å¾—ä¸ä¸€æ¬¡æ¬¡åœ°å†™ Coordinator æ¨¡å¼ä½¿ç”¨å¤§é‡ delegate æ¨¡å¼ï¼Œè®© ViewModels å¾—åˆ° Coordinator å›è°ƒä¿¡æ¯ä¸€å¼€å§‹æˆ‘çœ‹ Redux æ¨¡å¼ï¼Œå°¤å…¶æ˜¯å¯¼èˆªçŠ¶æ€æœºã€‚æˆ‘ä»¬å¯ä»¥æœ‰ä¸ªå…¨å±€å¯¼èˆªçŠ¶æ€ï¼Œä½¿ç”¨ RxSwift Observablesæš´éœ²å‡ºæ¥ï¼Œç„¶åç›‘å¬çŠ¶æ€é©±åŠ¨å¯¼èˆªã€‚å”¯ä¸€å›°æ‰°æˆ‘çš„æ˜¯å¯¼èˆªçŠ¶æ€çš„å”¯ä¸€æ€§ï¼Œä»¥åŠå®ƒå¯èƒ½å…·æœ‰ä¸å—æ§åˆ¶çš„è´£ä»»ï¼ˆä»¥åŠå®ƒå¯ä»¥å­˜å‚¨çš„æµ·é‡æ•°æ®ï¼‰å‡ºç°äº†è¿™æ ·çš„ä¸€ä¸ªæƒ³æ³•ï¼šå¯¼èˆªåªæ˜¯ä¸€ç§çŠ¶æ€çš„åå°„ï¼Œè¿™ç§çŠ¶æ€å¯ä»¥ä¸€æ­¥æ­¥ä¿®æ”¹ã€‚ä¸€ä¸ªçŠ¶æ€ï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºç»“æ„ä¸­ä¼ æ’­ï¼Œä¸æ˜¯å­˜å‚¨åœ¨å•ä¸ªä½ç½®ä¸­ï¼Œè€Œæ˜¯ç”±è§‚å¯Ÿè€…ç»Ÿä¸€èµ·æ¥ï¼Œå¯ä»¥å¯¹å®ƒä½œå‡ºååº”å¹¶å› æ­¤é©±åŠ¨å¯¼èˆªã€‚æ–‡ç« ä¹‹åï¼Œè¿™äº›åˆ†æ•£åœ¨åº”ç”¨ç¨‹åºä¸­çš„å°çŠ¶æ€ç§°ä¸ºâ€œStepsâ€ï¼Œè§‚å¯Ÿè€…ç§°ä¸ºâ€œCoordinatorâ€ã€‚RxFlow æ¥è‡ªç»éªŒæ€»ç»“ï¼Œä»–è§£å†³äº†ä¼ ç»Ÿä¸­ä»ç„¶å­˜åœ¨çš„ä¸¤ä¸ªä¸»è¦é—®é¢˜;Coordinator pattern:å¼€å‘äººå‘˜ä¸å¿…å†ç¼–å†™Coordinatorï¼Œä»–åªéœ€è¦å£°æ˜å¯¼èˆªåŠå…¶æ‰€é’ˆå¯¹çš„çŠ¶æ€ä¸éœ€è¦ delegateï¼Œå› ä¸º state æ˜¯ç”± Loom ç›‘å¬ RxSwift Observable å…³é”®åŸåˆ™è¦äº†è§£æœ‰å…³ Coordinator æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œæˆ‘å»ºè®®ä½ å¼€ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  Coordinator Reduxå°½ç®¡è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ¶æ„ï¼Œä½†æ˜¯Coordinatoræ¨¡å¼ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼šæ¯æ¬¡å¼•å¯¼åº”ç”¨ç¨‹åºæ—¶éƒ½å¿…é¡»ç¼–å†™åè°ƒæœºåˆ¶å› ä¸ºè¦ä½¿ç”¨ delegate æ¨¡å¼æ¥å¤„ç†ä¸ Coordinator ä¹‹é—´é€šä¿¡ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šæ ·æ¿ä»£ç RxFlow æ˜¯ä¸€ä¸ªä»¥å“åº”å¼æ–¹å¼å®ç°çš„ Coordinator æ¨¡å¼ï¼Œå®ƒæœ‰ Coordinator æ¨¡å¼æ¶æ„ä¸­çš„æ‰€æœ‰é‡è¦åŠŸèƒ½ï¼Œä½†è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼šä½¿å¯¼èˆªæ›´å…·å£°æ˜æ€§æä¾›ä¸€ä¸ªå†…ç½®çš„åè°ƒå™¨ï¼Œç”¨äºå¤„ç†ä½ å£°æ˜çš„å¯¼èˆªæµä½¿ç”¨å“åº”å¼ç¼–ç¨‹å¤„ç†å’Œ Coordinator é€šè®¯çš„é—®é¢˜ å¿…é¡»ç†Ÿæ‚‰6ä¸ªæœ¯è¯­æ‰èƒ½ç†è§£RxFlowFlowï¼šæ¯ä¸ª Flow éƒ½åœ¨åº”ç”¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªå¯¼èˆªåŒºåŸŸã€‚è¿™æ˜¯ä½ å£°æ˜å¯¼èˆªåŠ¨ä½œçš„åœ°æ–¹Stepï¼šæ¯ä¸ª Step åœ¨ App ä¸­æ˜¯ä¸€ä¸ªå¯¼èˆªçŠ¶æ€ã€‚Flows å’Œ Steps çš„ç»„åˆæè¿°äº†æ‰€æœ‰å¯èƒ½çš„å¯¼èˆªæ“ä½œã€‚Step ç”šè‡³å¯ä»¥å†…åµŒå€¼ï¼ˆegï¼šIdsï¼ŒURLsâ€¦ï¼‰å°†ä¼šä¼ æ’­åˆ° Flows ä¸­å£°æ˜çš„å±å¹•Stepperï¼šå®ƒå¯ä»¥æ˜¯ä»»ä½•å‘å‡º Steps çš„ä¸œè¥¿ï¼ŒSteppers è´Ÿè´£è§¦å‘ Flowsä¸­çš„æ¯ä¸ªå¯¼èˆªè¿‡ç¨‹ã€‚Presentableï¼šå®ƒæ˜¯å¯ä»¥å‘ˆç°çš„äº‹ç‰©çš„æŠ½è±¡ç±»ï¼ˆåŸºæœ¬ä¸Šæ˜¯UIViewControllerå’ŒFlowæ˜¯å¯å‘ˆç°çš„ï¼‰ã€‚Presentables æä¾›å“åº”å¼ Observablesï¼Œ Coordinator å°†ä»¥å…¼å®¹ UIKit çš„æ–¹å¼ï¼Œè®¢é˜…è¿™ä¸ª Observables æ¥æ§åˆ¶Flowçš„ StepsFlowableï¼šå®ƒæ˜¯ä¸€ä¸ªç»“åˆäº†Presentableå’ŒStepperçš„ç®€å•æ•°æ®ç»“æ„ã€‚å®ƒå‘Šè¯‰ Coordinator ä¸‹ä¸€æ­¥å°†å‘ç”Ÿä»€ä¹ˆï¼Œè¿™å°†åœ¨æ‚¨çš„å“åº”å¼æœºåˆ¶ä¸­äº§ç”Ÿæ–°çš„ StepsCoordinatorï¼šä¸€æ—¦å¼€å‘äººå‘˜å®šä¹‰å®Œ ä»£è¡¨å¯¼èˆªå¯èƒ½æ€§çš„æµç¨‹å’Œæ­¥éª¤çš„ç»„åˆï¼ŒCoordinator çš„å·¥ä½œå°±æ˜¯ä»¥ä¸€è‡´çš„æ–¹å¼æ··åˆè¿™äº›ç»„åˆã€‚ç¬¬ä¸€ç¯‡æ–‡ç« åªæ˜¯è¯´æ˜æ¡†æ¶çš„ æ¦‚å¿µç†è®ºï¼Œæ¥ä¸‹çš„æ–‡ç« å°†ä¼šä»æºç çš„è§’åº¦è®¨è®ºæ›´å¤š æœ‰å…³ RxFlow çš„æŠ€æœ¯ç‚¹ã€‚","tags":[{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"},{"name":"RxSwift","slug":"RxSwift","permalink":"https://changzw.github.io/tags/RxSwift/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"RxSwift","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/RxSwift","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/RxSwift/"}]},{"title":"OC å¯¹è±¡åˆ†æ","date":"2018-01-09T09:08:06.000Z","path":"2018/01/09/deep analyse/OC-å¯¹è±¡åˆ†æ/","text":"å¼•ç”¨æºç ï¼šobjc4æ€è€ƒï¼šé—®è‡ªå·±çš„é—®é¢˜å®ä¾‹å¯¹è±¡ï¼Œç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡ä¹‹é—´çš„å…³ç³»å¯¹è±¡çš„å±æ€§&amp;æ–¹æ³•æ˜¯æ€ä¹ˆä¼ çš„å¯¹è±¡æ–¹æ³•æ˜¯å¦‚ä½•æŸ¥è¯¢çš„oc çš„æ¶ˆæ¯æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„è¿™äº›ç†è®ºå¯ä»¥åº”ç”¨åˆ°ä»€ä¹ˆåœ°æ–¹ï¼Ÿ Objective-Cä¸­çš„å¯¹è±¡æœ‰å“ªäº›Objective-Cä¸­ä¸‡ç‰©æ¥å¯¹è±¡ï¼Œå¯¹è±¡ä¸»è¦åˆ†ä¸º3ç§instanceå¯¹è±¡classå¯¹è±¡meta-classå¯¹è±¡ objc_object æºç ç»“æ„ objc_class æºç ç»“æ„class å’Œ meta-class çš„ç»“æ„ç›¸åŒ isa å’Œ superclass æŒ‡é’ˆisa æŒ‡å‘ç”Ÿäº§ä»–è¿™ä¸ªå¯¹è±¡çš„å¯¹è±¡ï¼šinstance å¯¹è±¡çš„isa æ˜¯class å¯¹è±¡class å¯¹è±¡çš„ isa æ˜¯ meta-class å¯¹è±¡meta-class çš„ isa æ˜¯ root-metaclass å¯¹è±¡ï¼ˆæ‰€æœ‰å…ƒç±»çš„ isa éƒ½æŒ‡å‘ä»–ï¼‰ class_rw_t å’Œ class_ro_tè§ä¸Šå›¾ ğŸ‘†","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"}]},{"title":"Meta Class","date":"2018-01-03T14:32:46.000Z","path":"2018/01/03/deep analyse/Meta-Class/","text":"smallTalk ä¸­ Metaclass çš„ 7ä¸ªè¦ç´ object æ˜¯ class çš„å®ä¾‹class æœ€ç»ˆç»§æ‰¿è‡ª objectclass æ˜¯ metaclass çš„å®ä¾‹metaclass å’Œ class çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„metaclass ç»§æ‰¿è‡ª class å’Œ behaviormetaclass æ˜¯ Metaclass çš„å®ä¾‹Metaclass çš„ metaclass æ˜¯ Metaclass çš„å®ä¾‹ object æ˜¯ class çš„å®ä¾‹ æ¯ä¸ª class éƒ½ç»§æ‰¿è‡ª Objectå®ä¾‹å¯¹è±¡çš„ class éƒ½ç»§æ‰¿è‡ª Object is-a çš„å«ä¹‰å½“ Object æ¥æ”¶ msg çš„æ—¶å€™ï¼Œåœ¨ä»–çš„ class å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾ï¼Œä¸€ç›´æ²¿ç€ superclasses ï¼ŒçŸ¥é“ Object å¯¹è±¡æŸ¥æ‰¾è¿™ä¸ªæ¶ˆæ¯ Object çš„è´£ä»»æè¿° Object çš„å…¬å…±è¡Œä¸ºerror-handling, halting â€¦æ‰€æœ‰ç±»æœ€ç»ˆéƒ½ç»§æ‰¿è‡ª Object class æ˜¯ metaclass çš„å®ä¾‹Class ä¹Ÿæ˜¯å¯¹è±¡ï¼šæ¯ä¸ª class A æ˜¯ä»–çš„ metaclass çš„å”¯ä¸€å®ä¾‹ï¼Œå«åš A class metaclasses æ˜¯éšå¼çš„å½“åˆ›å»º class çš„æ˜¯æ—¶å€™ï¼Œä¼šéšå¼åˆ›å»º Metaclassæ²¡æœ‰å…±äº«çš„ metaclass(class å’Œ metaclass æ˜¯ä¸€ä¸€å¯¹åº”çš„) metaclass å’Œ class çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„class å’Œ object çš„ä¸€è‡´æ€§object æœ‰çš„ä¸œè¥¿ï¼Œclass ä¹Ÿæœ‰åŒæ ·çš„æ–¹æ³•æŸ¥è¯¢ç­–ç•¥object åœ¨class çš„ method å­—å…¸ä¸­æŸ¥æ‰¾class åœ¨ metaclass çš„method å­—å…¸ä¸­æŸ¥æ‰¾ metaclass ç»§æ‰¿è‡ª class å’Œ behavior metaclass æ˜¯ Metaclass çš„å®ä¾‹ Metaclass çš„ metaclass æ˜¯ Metaclass çš„å®ä¾‹ ä¸ºä»€ä¹ˆè¦æœ‰ MetaClassobjc_class: objc_object, æ‰€ä»¥object æœ‰çš„ä¸œè¥¿ class ä¹Ÿæœ‰object æ˜¯ class çš„å®ä¾‹ï¼Œclass æ˜¯ metaclass çš„å®ä¾‹object æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®æ–¹æ³•éƒ½ä¿å­˜åœ¨ class å¯¹è±¡ä¸­ï¼›classæ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®æ–¹æ³•éƒ½ä¿å­˜åœ¨ metaclass å¯¹è±¡ä¸­class æ˜¯ object çš„å·¥å‚ï¼Œmetaclass æ˜¯class çš„å·¥å‚å› ä¸ºclass ç»§æ‰¿è‡ª object æ‰€ä»¥æ¶ˆæ¯æŸ¥æ‰¾æ–¹å¼ç›¸åŒå¦‚æœæ²¡æœ‰ metaclass å‘¢ï¼Ÿsmalltalk-76ï¼Œç±»çš„ç±»éƒ½æ˜¯ Class ï¼Œè¯¥ç±»å®ç°äº†ä»»ä½•ç±»éƒ½éœ€è¦çš„æ–¹æ³•-eg. newæ–¹æ³•ã€‚å¦‚æœæƒ³æ·»åŠ ä¸€ä¸ªç±»æ–¹æ³•ï¼Œå¿…é¡»æ·»åŠ åˆ° Classobjc_msgSend(void /* id self, SEL op, â€¦ */) å¤ç”¨æ¶ˆæ¯é€šé“ï¼Œç±»æ–¹æ³•ä¹Ÿå¯ä»¥æ”¾åœ¨Classé‡Œï¼Œä½†å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦å¢åŠ ä¸€ä¸ªå‚æ•°","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"flexbox model","date":"2017-12-09T15:04:50.000Z","path":"2017/12/09/flexbox-model/","text":"flex-container å±æ€§demoflex-item å±æ€§demo åŸºç¡€&amp;æœ¯è¯­main axis - flex container ä¸»è½´ï¼Œflex-items æ²¿ç€è¿™ä¸ªè½´å¸ƒå±€ã€‚å…·ä½“å“ªä¸ªæ–¹å‘å–å†³äº flex-direction å±æ€§ (see below).main-start | main-end - flex-items åœ¨ flex-container ä¸­ä» main-start åˆ° main-end å¸ƒå±€.main size - flex-item main-axis æ–¹å‘çš„é•¿åº¦cross axis - å‚ç›´äº main-axis çš„è½´ã€‚å³å‚ç›´äº flex-items æ’åˆ—å¸ƒå±€æ–¹å‘çš„è½´ã€‚cross-start | cross-end - Flex-item å¸ƒå±€å‚ç›´æ–¹å‘å¸ƒå±€ä» cross-start åˆ° cross-end.cross size - flex-item cross-axis æ–¹å‘é•¿åº¦ å±æ€§å±æ€§æè¿°å¯å–å€¼displayæŒ‡å®š HTML å…ƒç´ ç›’å­ç±»å‹flex,inline-flexflex-directionæŒ‡å®šäº†å¼¹æ€§å®¹å™¨ä¸­å­å…ƒç´ çš„æ’åˆ—æ–¹å¼row,columnflex-wrapè®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ è¶…å‡ºçˆ¶å®¹å™¨æ—¶æ˜¯å¦æ¢è¡Œwrap,nowrap,wrap-reversejustify-contentè®¾ç½®å¼¹æ€§ç›’å­å…ƒç´ åœ¨ä¸»è½´ï¼ˆæ¨ªè½´ï¼‰æ–¹å‘ä¸Šçš„å¯¹é½æ–¹å¼flex-start,flex-end,center,space-around,space-betweenalign-selfåœ¨å¼¹æ€§å­å…ƒç´ ä¸Šä½¿ç”¨è¦†ç›–å®¹å™¨çš„ align-items å±æ€§flex-start,flex-end,centeralign-itemsè®¾ç½®å¼¹æ€§ç›’å­å…ƒç´ åœ¨ä¾§è½´ï¼ˆçºµè½´ï¼‰æ–¹å‘ä¸Šçš„å¯¹é½æ–¹å¼flex-start ,flex-end,center,stretch,baselinealign-contentä¿®æ”¹ flex-wrap å±æ€§çš„è¡Œä¸ºï¼Œç±»ä¼¼align-items, ä½†ä¸æ˜¯è®¾ç½®å­å…ƒç´ å¯¹é½ï¼Œè€Œæ˜¯è®¾ç½®è¡Œå¯¹é½flex-start,flex-end,center,space-around,space-between,stretchorderè®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ æ’åˆ—é¡ºåºintegerflexè®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ å¦‚ä½•åˆ†é…ç©ºé—´integerflex-basisæŒ‡å®š flex å…ƒç´ åœ¨ä¸»è½´æ–¹å‘ä¸Šçš„åˆå§‹å¤§å°ã€‚å¦‚æœä¸ä½¿ç”¨ box-sizing æ”¹å˜ç›’æ¨¡å‹çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±å†³å®šäº† flex å…ƒç´ çš„å†…å®¹ç›’ï¼ˆcontent-boxï¼‰çš„å°ºå¯¸ã€‚integerflex-growå…ƒç´ çš„æ‰©å¤§æ¯”ç‡integerflex-shrinkå…ƒç´ çš„æ”¶ç¼©æ¯”ç‡integer çˆ¶çº§çš„å±æ€§â€“flex-container flex-direction123.container &#123; flex-direction: row | row-reverse | column | column-reverse;&#125; flex-wrap123.container&#123; flex-wrap: nowrap | wrap | wrap-reverse;&#125;nowrap (default): æ‰€æœ‰ items éƒ½åœ¨ä¸€è¡Œæ˜¾ç¤ºwrap: flex items å°†ä»ä¸Šåˆ°ä¸‹å¤šè¡Œæ˜¾ç¤ºã€‚wrap-reverse: å°†ä»ä¸‹åˆ°ä¸Šå¤šè¡Œæ˜¾ç¤ºã€‚flex-wrap å¯è§†åŒ–demoä½¿ç”¨ demoçš„æ—¶å€™è°ƒæ•´æµè§ˆå™¨å¤§å° justify-contentmain-axis æ–¹å‘ flex-items å¸ƒå±€æ–¹å¼ã€‚123.container &#123; justify-content: flex-start | flex-end | center | space-between | space-around | space-evenly | start | end | left | right ... + safe | unsafe;&#125;justify-content: demo align-itemscross-axis æ–¹å‘ flex-items å¸ƒå±€æ–¹å¼123.container &#123; align-items: stretch | flex-start | flex-end | center | baseline | first baseline | last baseline | start | end | self-start | self-end + ... safe | unsafe;&#125; align-contentç±»ä¼¼align-items, ä½†ä¸æ˜¯è®¾ç½®å­å…ƒç´ å¯¹é½ï¼Œè€Œæ˜¯è®¾ç½®è¡Œå¯¹é½123.container &#123; align-content: flex-start | flex-end | center | space-between | space-around | space-evenly | stretch | start | end | baseline | first baseline | last baseline + ... safe | unsafe;&#125; æ¬¡çº§å±æ€§(flex items) orderå…ƒç´ æ’åˆ—é¡ºåº123.item &#123; order: &lt;integer&gt;; /* default is 0 */&#125; flex-growå…ƒç´ çš„æ‰©å±•æ¯”ç‡123.item &#123; flex-grow: &lt;number&gt;; /* default 0 */&#125; flex-shrinkå…ƒç´ çš„æ”¶ç¼©æ¯”ç‡ flex-basisflex-basis æŒ‡å®šäº† flex å…ƒç´ åœ¨ä¸»è½´æ–¹å‘ä¸Šçš„åˆå§‹å¤§å°ã€‚å¦‚æœä¸ä½¿ç”¨ box-sizing æ”¹å˜ç›’æ¨¡å‹çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±å†³å®šäº† flex å…ƒç´ çš„å†…å®¹ç›’ï¼ˆcontent-boxï¼‰çš„å°ºå¯¸ã€‚ align-selfåœ¨å¼¹æ€§å­å…ƒç´ ä¸Šä½¿ç”¨ã€‚è¦†ç›–å®¹å™¨çš„ align-items å±æ€§ã€‚123.item &#123; align-self: auto | flex-start | flex-end | center | baseline | stretch;&#125;å¼•ç”¨ï¼šCSS3 å¼¹æ€§ç›’å­(Flex Box)A Complete Guide to FlexboxComplete Guide to Flexbox","tags":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"}],"categories":[{"name":"è®¾è®¡æ€æƒ³","slug":"è®¾è®¡æ€æƒ³","permalink":"https://changzw.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"}]},{"title":"TCP/IP","date":"2017-11-18T15:01:11.000Z","path":"2017/11/18/TCP-IP/","text":"TCP/IP TCP/IP ä¸‰æ¬¡æ¡æ‰‹http æ˜¯åŸºäº TCP/IP åè®®ï¼ŒåŒå…¨å·¥ä¸ºä»€ä¹ˆè¦3æ¬¡æ¡æ‰‹ï¼Ÿæœ€ç®€å•çš„å›ç­”ï¼Œåä¸€ä¸ªæ¬¡æ¡æ‰‹éƒ½æ˜¯ç¡®å®šå‰ä¸€æ¬¡æ¡æ‰‹çš„æ¥å—æˆåŠŸï¼é™¤äº†ç¬¬ä¸€æ¬¡æ˜¯æœ‰ seq=xï¼Œå…¶ä»–æ¯æ¬¡æ¡æ‰‹éƒ½è¦å¸¦ä¸Š ack=x+1ï¼Œç¡®å®šä¸Šä¸€æ¬¡çš„ seqæ¥å—æˆåŠŸè¿™ä¹Ÿè¯´æ˜æœ€åä¸€æ¬¡æ¡æ‰‹æ°¸è¿œæ˜¯å¦èƒ½å¤Ÿæ¥å—éƒ½æ˜¯æ— æ³•ä¿éšœçš„ï¼Œä½†æ˜¯ &gt;= ä¸‰æ¬¡æ¡æ‰‹åŸºæœ¬æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€å†æµªè´¹èµ„æºä¸ºä»€ä¹ˆè¦4æ¬¡æŒ¥æ‰‹ï¼Ÿä¸‰æ¬¡å°±å¯ä»¥æ»¡è¶³åŒæ–¹éƒ½çŸ¥é“ç»“æœäº†å‘€ï¼Ÿåˆ†æ‰‹è¦åŒæ–¹éƒ½æå‡ºï¼Œæˆ‘è¦åˆ†æ‰‹ï¼Œæ¯ä¸€æ–¹æå‡ºéƒ½è¦å¯¹æ–¹ç¡®è®¤ä¸€ä¸‹ï¼æ‰€ä»¥æœ‰äº†ä¸€å¯¹ (fin=x â€“ ack=x+1), (fin=y â€“ ack=y+1)fin=x æ˜¯æå‡ºåˆ†æ‰‹ï¼Œç¼–å·xï¼Œack=x+1 æ˜¯ç¡®å®šå—åˆ° fin=xæŠ¥æ–‡æ•°æ®ï¼Œç„¶åæˆ‘ä¹Ÿè¦å‘ä¸€æ¬¡æˆ‘è¦åˆ†æ‰‹ä¸ºä»€ä¹ˆè¦åŒæ–¹éƒ½è¦ä¸»åŠ¨å‘é€ fin å‘¢ï¼Ÿå› ä¸ºä¸€æ–¹å‘é€ fin ä»¥åï¼Œå¦ä¸€å‘æœ‰å¯èƒ½è¿˜æœ‰æ²¡æœ‰å‘å®Œçš„æ•°æ®ï¼Œç¡®è®¤åŒæ–¹éƒ½æ˜¯æ²¡æœ‰äº‹è¦åšäº† WireShark ä½¿ç”¨éªŒè¯ TCP/IP è¿æ¥12nc -l 12345 //ç›‘å¬nc 127.0.0.1 12345 //å»ºç«‹è¿æ¥WireShark, Loopback:lo0","tags":[{"name":"è®¡ç®—æœºåŸºç¡€","slug":"è®¡ç®—æœºåŸºç¡€","permalink":"https://changzw.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"}],"categories":[{"name":"è®¡ç®—æœºåŸºç¡€çŸ¥è¯†","slug":"è®¡ç®—æœºåŸºç¡€çŸ¥è¯†","permalink":"https://changzw.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}]},{"title":"Categoryåˆ†æ","date":"2017-11-17T14:00:06.000Z","path":"2017/11/17/deep analyse/Categoryåˆ†æ/","text":"å½“ç»™ç±»æ·»åŠ æ–¹æ³•çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæƒ³åˆ°ä½¿ç”¨ categoryï¼Œç»™ç±»æ·»åŠ æ–¹æ³•oc çš„åœ¨runtime çš„æ—¶å€™ åˆ†ç±»æ˜¯å¦‚ä½•åŠ è½½çš„æŸ¥çœ‹ objc æºç è°ƒç”¨è¿‡ç¨‹objc-os.mm_objc_initmap_imagesmap_images_nolockobjc-runtime-new.mm_read_imagesremethodizeClassattachCategoriesattachListsreallocã€memmoveã€ memcpy1234567891011121314151617struct category_t &#123; const char *name; classref_t cls; struct method_list_t *instanceMethods; struct method_list_t *classMethods; struct protocol_list_t *protocols; struct property_list_t *instanceProperties; // Fields below this point are not always present on disk. struct property_list_t *_classProperties; method_list_t *methodsForMeta(bool isMeta) &#123; if (isMeta) return classMethods; else return instanceMethods; &#125; property_list_t *propertiesForMeta(bool isMeta, struct header_info *hi);&#125;;","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"}]},{"title":"CAShapeLayer ç”»å›¾","date":"2017-10-27T02:14:56.000Z","path":"2017/10/27/UI ç›¸å…³/CAShapeLayer-ç”»å›¾/","text":"ä¸ºä»€ä¹ˆè¦æœ‰ ShapeLayerï¼Ÿå› ä¸ºå¹³å¸¸å¼€å‘ä¸­ ä¸»è¦æ˜¯ çŸ©å½¢çš„ç»˜åˆ¶ï¼Œå¾ˆå°‘ç”¨åˆ°å…¶ä»–å¤šè¾¹å½¢çš„ï¼ˆä¸€èˆ¬éƒ½ç”¨å›¾ç‰‡ä»£æ›¿ï¼‰ä½¿ç”¨ ShapeLayerï¼Œé€šè¿‡ path æ¥å®šä¹‰è‡ªå·±çš„å›¾å½¢å—¯ shapelayer å°±æ˜¯ä¸€ä¸ª ç»˜åˆ¶ path çš„å·¥å…·ä¹Ÿå¯ä»¥ç”¨ Core Graphics ç›´æ¥å‘åŸå§‹çš„CALyerçš„å†…å®¹ä¸­ç»˜åˆ¶è·¯å¾„CAShapeLayeræ˜¯ä¸€ä¸ªé€šè¿‡ çŸ¢é‡ å›¾å½¢è€Œä¸æ˜¯ bitmap æ¥ç»˜åˆ¶çš„å›¾å±‚CALayerçš„å­ç±»ã€‚ç›¸æ¯”ç›´ä¸‹ï¼Œä½¿ç”¨CAShapeLayeræœ‰ä»¥ä¸‹ä¸€äº›ä¼˜ç‚¹ï¼šæ¸²æŸ“å¿«é€Ÿ: CAShapeLayerä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œç»˜åˆ¶åŒä¸€å›¾å½¢ä¼šæ¯”ç”¨Core Graphicså¿«å¾ˆå¤šé«˜æ•ˆä½¿ç”¨å†…å­˜: ä¸€ä¸ªCAShapeLayerä¸éœ€è¦åƒæ™®é€šCALayerä¸€æ ·åˆ›å»ºä¸€ä¸ªå¯„å®¿å›¾å½¢ï¼Œæ‰€ä»¥æ— è®ºæœ‰å¤šå¤§ï¼Œéƒ½ä¸ä¼šå ç”¨å¤ªå¤šçš„å†…å­˜ä¸ä¼šè¢«å›¾å±‚è¾¹ç•Œå‰ªè£æ‰: ä¸€ä¸ªCAShapeLayerå¯ä»¥åœ¨è¾¹ç•Œä¹‹å¤–ç»˜åˆ¶:ä½ çš„å›¾å±‚è·¯å¾„ä¸ä¼šåƒåœ¨ä½¿ç”¨Core Graphicsçš„æ™®é€šCALayerä¸€æ ·è¢«å‰ªè£æ‰ä¸ä¼šå‡ºç°åƒç´ åŒ–: å½“ä½ ç»™CAShapeLayeråš3Då˜æ¢æ—¶ï¼Œå®ƒä¸åƒä¸€ä¸ªæœ‰å¯„å®¿å›¾çš„æ™®é€šå›¾å±‚ä¸€æ ·å˜å¾—åƒç´ åŒ–","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æ€§èƒ½","slug":"æ€§èƒ½","permalink":"https://changzw.github.io/tags/%E6%80%A7%E8%83%BD/"},{"name":"UI","slug":"UI","permalink":"https://changzw.github.io/tags/UI/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"UI","slug":"iOS-Programming/UI","permalink":"https://changzw.github.io/categories/iOS-Programming/UI/"}]},{"title":"è‡ªåŠ¨å¸ƒå±€åŒ…è£¹è§†å›¾","date":"2017-09-21T08:24:56.000Z","path":"2017/09/21/è‡ªåŠ¨å¸ƒå±€åŒ…è£¹è§†å›¾/","text":"åŸæ–‡ Auto Layout and Views that Wrapç†è§£åŒ…è£¹æ–‡æœ¬å’Œå…¶ä»–æµåŠ¨å¸ƒå±€ã€‚åœ¨è§†å±ä¸­ï¼Œç›’å­é‡Œçš„é¢ï¼Œå½“container resized çš„æ—¶å€™ï¼ŒUILabel (æˆ–è€… Mac ç³»ç»Ÿé‡Œé¢çš„ NSTextField) åŒ…è£¹çš„æ–‡å­—çš„è¡Œä¸ºåƒè¿™æ ·ï¼švideo1è¿™ç¯‡æ–‡ç« å°†ä¼šè®²è§£ï¼Œå½“ container resized çš„æ—¶å€™ UILabel çš„è¡Œä¸ºä¼šæ˜¯è¿™æ ·çš„ï¼švideo2 ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™æ ·çš„æ•ˆæœåœ¨è‡ªåŠ¨å¸ƒå±€ä¸­ï¼Œview æœ‰ä¸€ä¸ªâ€œå›ºæœ‰å°ºå¯¸â€ï¼ˆintrinsic content sizeï¼‰çš„æ¦‚å¿µï¼šå®½å’Œé«˜ï¼ˆéƒ½æœ‰ï¼Œæˆ–æœ‰å…¶ä¸€ï¼Œæˆ–éƒ½æ²¡æœ‰ï¼‰åˆšå¥½æ»¡è¶³view çš„å¤§å°ã€‚å¸ƒå±€ç³»ç»Ÿæ ¹æ®viewçš„ â€œcompression resistanceâ€çš„ ä¼˜å…ˆçº§ï¼Œè‡³å°‘ä¼šç»™view ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºé—´ã€‚å¸ƒå±€ç³»ç»Ÿåˆ†åˆ«å¯¹å¾… width å’Œ heightã€‚ä¸¾ä¾‹ï¼šå¦‚æœä¸€ä¸ª segmented controlâ€™sçš„æ–‡æœ¬å¾ˆé•¿ä»¥è‡³äºè¶…å‡ºåŒ…è£¹viewçš„å®½åº¦ï¼Œå®ƒçš„å›ºæœ‰é«˜åº¦ä»ç„¶å°è¯•æ»¡è¶³ åœ¨viewçš„é«˜åº¦ã€‚è¿™ç§æ•ˆæœå¯¹äºå·²ç»å®šä¹‰sizeçš„ view éå¸¸å¥½ï¼Œsuch as buttons, sliders, and small labels.ä½†æ˜¯åŒ…è£¹çš„view ä¼šæœ‰ååˆ†å¤æ‚çš„è¡Œä¸ºï¼šä»–ä»¬çš„ width å’Œ height ç›¸äº’å…³è”ï¼Œç³»ç»Ÿæœ‰çš„æ—¶å€™ä¼šè®©å›ºæœ‰ width ç…§é¡¾å›ºæœ‰ heightï¼Œåè¿‡æ¥ä¹Ÿæ˜¯ã€‚è¿™ç§æƒ…å†µä¸èƒ½å•çº¯çš„ç”¨ å¸ƒå±€é™åˆ¶æ¥è§£é‡Šè¯æ˜: æ€è€ƒä¸€ä¸ªç®€åŒ–æ¨¡å‹ï¼Œå¿½ç•¥word æˆªæ–­å’Œå¤æ‚çš„æ–‡æœ¬å†…å®¹ã€‚æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæœ‰å›ºå®šé¢ç§¯çš„ view,i.e. width Ã— height = constant. å¸ƒå±€é™åˆ¶ä¸€å®šè¦è¿™ä¹Ÿæ ·çš„æ ¼å¼ï¼šattribute1 = multiplier Ã— attribute2+ constant (ä¸ºäº†è®©ç³»ç»Ÿå¯ä»¥æä¾›ç¡®å®šçš„æ‰§è¡Œæ•ˆæœ). æ²¡æœ‰å•¥æ–¹å¼ä½¿ç”¨ç¬¬äºŒä¸ªç­‰å¼æ¥è¡¨ç¤ºç¬¬ä¸€ä¸ªç­‰å¼ã€‚å› æ­¤ä¹Ÿæ²¡æœ‰å•¥æ–¹å¼æè¿°å¸ƒå±€é™åˆ¶åŒ…è£¹çš„ viewã€‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å¸ƒå±€å¼•æ“è®¡ç®—å‡ºæ¥çš„ width å’Œ height ä½œä¸ºè‡ªç”±å˜é‡ã€‚æœ€ç®€å•çš„æ–¹å¼â€“ä¹Ÿæ˜¯apple ä½¿ç”¨çš„ä¸€ç§â€“æ˜¯å›ºå®š widthï¼Œç„¶åè®© height è‡ªé€‚åº”ï¼ˆå–å†³label çš„å†…å®¹å¤§å°ï¼‰ æ¨æ–­æœ€å¤§ å¸ƒå±€ å®½åº¦UILabel å’Œ NSTextField æœ‰ preferredMaxLayoutWidth è¿™ä¸ªå±æ€§ã€‚å¦‚æœå®ƒ é 0ï¼Œä»–å°±ä¼šä½œä¸ºlabel çš„å›ºæœ‰å°ºå¯¸çš„æœ€å¤§å®½åº¦ï¼Œå½“ labelæœ‰è¶…è¿‡ container View å®¹é‡çš„æ–‡å­—æ˜¯ï¼Œlabelå¯ä»¥é€‚é…åˆ° è¿™ä¸ª width ä¸Šã€‚è¿™ä¸ª label å°†ä¼šè¿”å›ä¸€ä¸ªæ›´å¤§çš„å›ºæœ‰ heightã€‚(å¦‚æœ label åªæœ‰å°‘é‡æ–‡å­—ï¼Œé‚£ä¹ˆlabel çš„å›ºæœ‰width å°±å›å°äº__preferredMaxLayoutWidth__)iOS ä¸Šï¼ŒUILabel çš„ preferredMaxLayoutWidth__è¢«è®¾ç½®ä¸ºlabel çš„widthåœ¨ å®ƒæ˜¾ç¤ºåœ¨nib ä¸Šçš„æ—¶å€™ï¼ˆå³ä½¿åœ¨ runtime å®ƒçš„size æ”¹å˜ï¼‰OS X ä¸Š, NSTextField å¯é€‰__preferredMaxLayoutWidthï¼Œåœ¨å¸ƒå±€ä¹‹åã€‚å¦‚æœ label çš„æœ‰æ•ˆç©ºé—´å¯ä»¥æ”¹å˜ï¼Œåƒæœ€ä¸Šé¢ video1é‡Œé¢çš„demoï¼Œæˆ–è€…å¦‚æœcontainer å¯ä»¥resized ï¼ˆæˆ–è€…rotatedï¼‰ï¼Œä½ å°±éœ€è¦åŠ¨æ€çš„æ”¹å˜ preferredMaxLayoutWidthã€‚ è°ƒæ•´ preferredMaxLayoutWidthä¸ºäº†åŠ¨æ€çš„è®¾ç½®preferredMaxLayoutWidth, éœ€è¦é‡è½½ label çš„çˆ¶ç±»æ–¹æ³•ï¼š12 -[UIView layoutSubviews] -[NSView layout]ä¸ºäº†å¾—åˆ°æœ€ä¸Šé¢video2çš„æ•ˆæœï¼Œè¦å°†__preferredMaxLayoutWidth__è®¾ç½®ä¸ºæœ‰æ•ˆçš„labelä¾‹å­çš„å¸ƒå±€ï¼Œlabel è¦æœ‰è¿™å‡ ä¸ªé™åˆ¶:å›ºå®šå·¦å³é™åˆ¶ï¼Œä½¿labelå æ®æ•´ä¸ªæ°´å¹³ç©ºé—´ï¼Œä»£ç é‡Œä¸è¦ä½¿ç”¨ æ•°å­— ç¡¬ç¼–ç ä½ çš„ constrain. è¿™ä¼šæ˜¯ä½ çš„å¸ƒå±€ååˆ†è„†å¼±ã€‚å–è€Œä»£æ›¿çš„, å¯ä»¥åˆ©ç”¨å¸ƒå±€ç³»ç»Ÿæ¥è¾¾åˆ°æ•ˆæœï¼Œéœ€è¦åšä¸¤æ­¥ã€‚ä¸Šé¢ video2é‡Œé¢ï¼Œåœ¨label ä¸­ ä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼š123456- (void)layoutSubviews &#123; [super layoutSubviews]; CGFloat availableLabelWidth = self.label.frame.size.width; self.label.preferredMaxLayoutWidth = availableLabelWidth; [super layoutSubviews];&#125;å®ç°è°ƒç”¨ [super layoutSubviews]ï¼Œå°†ä¼šè®¡ç®—labelä¸Šçš„ constraintsï¼ˆå› ä¸ºä»–æ˜¯ä¸€ä¸ªé—´æ¥çš„å­viewï¼‰ç›¸åº”çš„æ”¹å˜å®ƒçš„frameã€‚æ­¤æ—¶ width æ˜¯æœ‰ç”¨çš„ï¼Œä½†æ˜¯heightä¸æ˜¯ï¼›height ç”¨çš„æ˜¯label çš„å›ºæœ‰heightï¼Œå®ƒä¾èµ– ä»¥å‰ preferredMaxLayoutWidth çš„å€¼ã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† label çš„å®é™…widthï¼Œæˆ‘ä»¬è®¾ç½®å®ƒçš„æœ€å¤§å¸ƒå±€width. åœ¨å†…éƒ¨,åœ¨ä¸‹ä¸€æ¬¡æŸ¥è¯¢label çš„å›ºæœ‰å°ºå¯¸æ—¶ï¼Œ labelçš„å›ºæœ‰å°ºå¯¸æ˜¯æ— æ•ˆçš„ï¼Œè€Œå¯¹äºå½“å‰çš„ widthä¼šæœ‰ ç²¾ç¡®çš„ heightã€‚æ‰€æœ‰å¸ƒå±€ä¿¡æ¯å°±ç»ª, å†æ¬¡è°ƒç”¨ [super layoutSubviews]again. åˆ›å»ºå±äºä½ è‡ªå·±çš„ åŒ…è£¹viewWrapDemo. è¿™ä¸ªä¾‹å­æœ‰ä¸€ä¸ª preferredMaxLayoutWidth å±æ€§ that the superview sets, å’Œ ä¸€ä¸ªå…±äº«å¸ƒå±€æ–¹æ³• (-[MyWrappingView enumerateItemRectsForLayoutWidth:usingBlock:]). è¿™ä¸ªæ–¹æ³•åœ¨ -intrinsicContentSize ä¸­è°ƒç”¨â€“é€šè¿‡preferredMaxLayoutWidth è®¡ç®—åŸºæœ¬å°ºå¯¸ã€‚åœ¨ -layoutSubviews ä¸­è°ƒç”¨ï¼Œç®—å‡ºé‚£äº› æ‰¾è‰²çš„item çš„å®é™… size å’Œ ä½ç½®video3 å‹ç¼© åŒ…è£¹æœ€åï¼Œæœ‰å¾ˆå¤šæ¬¡æˆ‘ä»¬æƒ³æŠŠåŒ…è£¹view å’Œå†…å®¹æŠ±ç´§ contenthugging çš„æ–¹å¼ç»„åˆã€‚å¯ä»¥æ·»åŠ çº¦æŸï¼Œä»¥ä½¿å®ƒä»¥ä¸­å¿ƒä¸ºä¸­å¿ƒï¼Œå¹¶è‡³å°‘æœ‰ä¸€äº›è·ç¦»ï¼Œè€Œä¸æ˜¯å›ºå®š label çš„leadingå’Œtrailingç©ºé—´ä½ç½®ã€‚å°†å…¶ä¸ä¸Šé¢çš„- layoutsubviewsç»“åˆèµ·æ¥å®ç°æä¾›ä»¥ä¸‹è¡Œä¸º:video4è¾¹ç¼˜çš„ç©ºé—´æ˜¯å……è¶³çš„ï¼Œå¦‚æœå®ƒå¤§äºæˆ–ç­‰äºå¸¸æ•°-å®ƒåªä¼šæŠŠæ ‡ç­¾æ¨è¿›å»ï¼Œå®ƒå°±ä¸ä¼šæŠŠå®ƒæ‹‰å‡ºæ¥ã€‚æˆ‘ä»¬æƒ³è¦åšçš„æ˜¯æ‰¾åˆ°æ ‡ç­¾å¯ä»¥å ç”¨çš„å®½åº¦ï¼Œè€Œä¸éœ€è¦å ç”¨æ‰€æœ‰çš„å®½åº¦ã€‚è‡ªåŠ¨å¸ƒå±€APIåªæä¾›ä¸€ç§è®¡ç®—è·ç¦»çš„æ–¹æ³•:å¸ƒå±€ï¼Œç„¶åæµ‹é‡ã€‚å› æ­¤ï¼Œä¸ºäº†æ‰¾å‡ºæ ‡ç­¾çš„å®½åº¦ï¼Œæˆ‘ä»¬å‘Šè¯‰å®ƒè¦å˜å¾—éå¸¸å®½(ä»”ç»†é€‰æ‹©ä¼˜å…ˆçº§)ï¼ŒæŠŠå®ƒæ”¾åœ¨å¤–é¢ï¼Œæµ‹é‡å®ƒï¼Œç„¶åä½¿ç”¨ç»“æœä½œä¸ºé¦–é€‰çš„æœ€å¤§å¸ƒå±€å®½åº¦ã€‚è¯¥æ ‡ç­¾çš„å†…åœ¨å°ºå¯¸å°†å®Œæˆå…¶ä½™éƒ¨åˆ†ã€‚123456789101112131415161718192021- (void)layoutSubviews &#123; NSLayoutConstraint *labelAsWideAsPossibleConstraint = [NSLayoutConstraint constraintWithItem:self.label attribute:NSLayoutAttributeWidth relatedBy:NSLayoutRelationGreaterThanOrEqual toItem:nil attribute:0 multiplier:1.0 constant:1e8]; // a big number labelAsWideAsPossibleConstraint.priority = [self.label contentCompressionResistancePriorityForAxis:UILayoutConstraintAxisHorizontal]; [self.label addConstraint:labelAsWideAsPossibleConstraint]; [super layoutSubviews]; CGFloat availableLabelWidth = self.label.frame.size.width; self.label.preferredMaxLayoutWidth = availableLabelWidth; [self.label removeConstraint:labelAsWideAsPossibleConstraint]; [super layoutSubviews];&#125;æ‰€æœ‰ä¾‹å­ä»£ç  WrapDemo project on GitHub.æ„Ÿè°¢Kevin Catheyåœ¨å¸ƒå±€æ–¹é¢çš„å¸®åŠ©å’Œè§è§£ã€‚æ€»ç»“ï¼šUILabel çš„ preferredMaxLayoutWidthå½“åº”ç”¨å¸ƒå±€çº¦æŸæ—¶ï¼Œè¿™ä¸ªå±æ€§ä¼šå½±å“æ ‡ç­¾çš„å¤§å°ã€‚åœ¨å¸ƒå±€ä¸­ï¼Œå¦‚æœæ–‡æœ¬è¶…å‡ºäº†è¯¥å±æ€§æŒ‡å®šçš„å®½åº¦ï¼Œåˆ™é¢å¤–çš„æ–‡æœ¬å°†æµå‘ä¸€ä¸ªæˆ–å¤šä¸ªæ–°è¡Œï¼Œä»è€Œå¢åŠ æ ‡ç­¾çš„é«˜åº¦ã€‚ å…¶ä»–å‚è€ƒæ–‡ç« Apple: iOS UILabeliOS: Multi-line UILabel in Auto LayoutAdvanced Auto Layout Toolbox","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"iOS ç¦»å±æ¸²æŸ“","date":"2017-09-20T02:23:06.000Z","path":"2017/09/20/UI ç›¸å…³/iOS-ç¦»å±æ¸²æŸ“/","text":"ä»€ä¹ˆæ˜¯ç¦»å±æ¸²æŸ“ï¼Ÿä»–å¯¹æ€§èƒ½æœ‰ä»€ä¹ˆå½±å“ï¼Ÿå¦‚ä½•é¿å…ç¦»å±æ¸²æŸ“ï¼Ÿ iOS æ¸²æŸ“å¦‚æœæƒ³è¦äº†è§£ç¦»å±æ¸²æŸ“ï¼Œåº”è¯¥å…ˆçŸ¥é“iOSæ¸²æŸ“æ¡†æ¶æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è®©å±å¹•é¡µé¢æµç•…åº”è¯¥ä¿è¯é¡µé¢åˆ·æ–°ç‡ä¸º 60 å¸§/ç§’ï¼Œ1 å¸§çš„æ—¶é—´å¤§æ¦‚å°±æ˜¯ 16.67 msäº†ã€‚iOS çš„æ¸²æŸ“æ¡†æ¶ï¼š Core Animationç»„åˆå±å¹•ä¸Šçš„å†…å®¹ï¼Œè¿½è¸ªè§†å›¾ç»“æ„å’Œå†…å®¹çš„å˜åŒ–ã€‚æµç¨‹å›¾ä¸­ Commit Transaction å‰é¢çš„çº¢æ¡†ä»£è¡¨è§¦å‘è§†å›¾å†…å®¹å˜åŒ–çš„äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»æŒ‰é’®ä¹‹åCore Animation æ¡†æ¶ä¼šæ•è·åˆ°å±å¹•å†…å®¹çš„å˜åŒ–å¹¶æäº¤ç»™ Render Serverï¼ˆæ¸²æŸ“æœåŠ¡å™¨ï¼‰Render Server é‡Œå¦å¤–ä¸€ä¸ªç‰ˆæœ¬çš„ Core Animation æ¡†æ¶è´Ÿè´£è§£ç å¹¶ç»˜åˆ¶å†…å®¹ã€‚CPU è§£ç å®Œæˆåå°†æ•°æ®äº¤ç»™ GPUGPU æ¸²æŸ“å®Œæˆåæ˜¾ç¤ºç¦»å±æ¸²æŸ“æ˜¯ä¸ºäº† ç¼“å­˜çš„ç¦»å±æ¸²æŸ“ç©ºé—´åªæœ‰å±å¹•çš„ 2.5å€100ms ä»¥åå¦‚æœç¼“å­˜æ²¡æœ‰ä½¿ç”¨å°±ä¼šè¢«é‡Šæ”¾æ‰åœ†è§’å›¾ç‰‡ç”±äºGPUçš„æµ®ç‚¹è¿ç®—èƒ½åŠ›æ¯”CPUå¼ºï¼ŒCPUæ¸²æŸ“çš„æ•ˆç‡å¯èƒ½ä¸å¦‚ç¦»å±æ¸²æŸ“ã€‚ä½†å¦‚æœä»…ä»…æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„æ•ˆæœï¼Œç›´æ¥ä½¿ç”¨ CPU æ¸²æŸ“çš„æ•ˆç‡åˆå¯èƒ½æ¯”ç¦»å±æ¸²æŸ“å¥½ï¼Œæ¯•ç«Ÿæ™®é€šçš„ç¦»å±æ¸²æŸ“è¦æ¶‰åŠåˆ°ç¼“å†²åŒºåˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰è€—æ—¶æ“ä½œã€‚å¯¹ä¸€äº›ç®€å•çš„ç»˜åˆ¶è¿‡ç¨‹æ¥è¯´ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰å¯èƒ½ç”¨CoreGraphicsï¼Œå…¨éƒ¨ç”¨CPUæ¥å®Œæˆåè€Œä¼šæ¯”GPUåšå¾—æ›´å¥½ã€‚ä¸€ä¸ªå¸¸è§çš„ CPU æ¸²æŸ“çš„ä¾‹å­æ˜¯ï¼šé‡å†™ drawRect æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨ä»»ä½• Core Graphics çš„æŠ€æœ¯è¿›è¡Œäº†ç»˜åˆ¶æ“ä½œï¼Œå°±æ¶‰åŠåˆ°äº† CPU æ¸²æŸ“ã€‚æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹ç”± CPU åœ¨ App å†…åŒæ­¥åœ°å®Œæˆï¼Œæ¸²æŸ“å¾—åˆ°çš„bitmapæœ€åå†äº¤ç”±GPUç”¨äºæ˜¾ç¤ºã€‚æ€»ä¹‹ï¼Œå…·ä½“ä½¿ç”¨ CPU æ¸²æŸ“è¿˜æ˜¯ä½¿ç”¨ GPU ç¦»å±æ¸²æŸ“æ›´å¤šçš„æ—¶å€™éœ€è¦è¿›è¡Œæ€§èƒ½ä¸Šçš„å…·ä½“æ¯”è¾ƒæ‰å¯ä»¥ã€‚ä¸€ä¸ªå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–çš„ä¾‹å­å°±æ˜¯å¦‚ä½•ç»™ UIView/UIImageView åŠ åœ†è§’ã€‚å¦‚ä¸‹æ˜¯ä¸‰ç§åŠ åœ†è§’çš„æ–¹å¼ï¼šè®¾ç½® cornerRadiusUIBezierPathCore Graphics(ä¸º UIView åŠ åœ†è§’)ä¸ç›´æ¥æˆªå–å›¾ç‰‡(ä¸º UIImageView åŠ åœ†è§’)å¦‚ä¸‹æ˜¯è¿™ä¸‰ç§æ–¹æ³•çš„æ¯”è¾ƒï¼šâ€”Advanced Graphics and Animations for iOS Appsï¼ˆWWDC14 419)","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æ€§èƒ½","slug":"æ€§èƒ½","permalink":"https://changzw.github.io/tags/%E6%80%A7%E8%83%BD/"},{"name":"UI","slug":"UI","permalink":"https://changzw.github.io/tags/UI/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"UI","slug":"iOS-Programming/UI","permalink":"https://changzw.github.io/categories/iOS-Programming/UI/"}]},{"title":"å¦‚ä½•ä½¿ç”¨ RunLoop","date":"2017-08-30T11:00:54.000Z","path":"2017/08/30/runloop/å¦‚ä½•ä½¿ç”¨-RunLoop/","text":"æœ¬æ–‡ä¸»è¦ä»¥ç¿»è¯‘ä¸ºä¸»ï¼Œæœ‰ç¿»è¯‘orç†è§£é”™çš„åœ°æ–¹è¯·æå‡ºï¼Œ3Q ä½¿ç”¨ RunLoop å¯¹è±¡Apple æ¡†æ¶ä¸­æ˜¯å¦‚ä½•æè¿° RunLoop çš„:æ¡†æ¶RunLoopçº¿ç¨‹å®‰å…¨CocoaNSRunLoop å®ä¾‹å¯¹è±¡ä¸å®‰å…¨Core FoundationCFRunLoopRefæŒ‡é’ˆå®‰å…¨å¸¦ç€é—®é¢˜ï¼Ÿrunloop ä½¿ç”¨éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™ä½¿ç”¨ runloopç³»ç»Ÿæ¡†æ¶å“ªäº›åœ°æ–¹ä½¿ç”¨äº† runloopï¼Ÿrunloop è¿è¡Œæ—¶çš„å†…éƒ¨å®ä½“ç»“æ„åˆ†æï¼Ÿ è·å¾—ä¸€ä¸ª runloop å¯¹è±¡swift12var a = RunLoop.currentvar b = CFRunLoopGetCurrent()oc12id a = [NSRunLoop currentRunLoop];id b = CFRunLoopGetCurrent();__CFRunLoop ç»“æ„ä½“ 123456789101112131415161718struct __CFRunLoop &#123; CFRuntimeBase _base; pthread_mutex_t _lock; //* locked for accessing mode list */ __CFPort _wakeUpPort; // used for CFRunLoopWakeUp Boolean _unused; volatile _per_run_data *_perRunData;// reset for runs of the run loop pthread_t _pthread; uint32_t _winthread; CFMutableSetRef _commonModes; // å½“å‰ runloop è¦ç›‘å¬çš„ mode CFMutableSetRef _commonModeItems; // æ‰€æœ‰æ¨¡å¼ä¸‹ è¦ç›‘å¬çš„ source0,source1,observer, timer CFRunLoopModeRef _currentMode; CFMutableSetRef _modes; struct _block_item *_blocks_head; struct _block_item *_blocks_tail; CFAbsoluteTime _runTime; CFAbsoluteTime _sleepTime; CFTypeRef _counterpart;&#125;; app è¿è¡Œæ—¶ CFRunLoop å†…éƒ¨æ ·å­ç®€ç‰ˆ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798CFRunLoop &#123; current mode = kCFRunLoopDefaultMode common modes = &#123; UITrackingRunLoopMode kCFRunLoopDefaultMode &#125; common mode items = &#123; // source0 (manual) CFRunLoopSource &#123;order =-1, &#123; callout = _UIApplicationHandleEventQueue&#125;&#125; CFRunLoopSource &#123;order =-1, &#123; callout = PurpleEventSignalCallback &#125;&#125; CFRunLoopSource &#123;order = 0, &#123; callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125; // source1 (mach port) CFRunLoopSource &#123;order = 0, &#123;port = 17923&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 12039&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 16647&#125;&#125; CFRunLoopSource &#123;order =-1, &#123; callout = PurpleEventCallback&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 2407, callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 1c03, callout = __IOHIDEventSystemClientAvailabilityCallback&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 1b03, callout = __IOHIDEventSystemClientQueueCallback&#125;&#125; CFRunLoopSource &#123;order = 1, &#123;port = 1903, callout = __IOMIGMachPortPortCallback&#125;&#125; // Ovserver CFRunLoopObserver &#123;order = -2147483647, activities = 0x1, // Entry callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; CFRunLoopObserver &#123;order = 0, activities = 0x20, // BeforeWaiting callout = _UIGestureRecognizerUpdateObserver&#125; CFRunLoopObserver &#123;order = 1999000, activities = 0xa0, // BeforeWaiting | Exit callout = _afterCACommitHandler&#125; CFRunLoopObserver &#123;order = 2000000, activities = 0xa0, // BeforeWaiting | Exit callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125; CFRunLoopObserver &#123;order = 2147483647, activities = 0xa0, // BeforeWaiting | Exit callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; // Timer CFRunLoopTimer &#123;firing = No, interval = 3.1536e+09, tolerance = 0, next fire date = 453098071 (-4421.76019 @ 96223387169499), callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)&#125; &#125;, modes ï¼ &#123; CFRunLoopMode &#123; sources0 = &#123; /* same as 'common mode items' */ &#125;, sources1 = &#123; /* same as 'common mode items' */ &#125;, observers = &#123; /* same as 'common mode items' */ &#125;, timers = &#123; /* same as 'common mode items' */ &#125;, &#125;, CFRunLoopMode &#123; sources0 = &#123; /* same as 'common mode items' */ &#125;, sources1 = &#123; /* same as 'common mode items' */ &#125;, observers = &#123; /* same as 'common mode items' */ &#125;, timers = &#123; /* same as 'common mode items' */ &#125;, &#125;, CFRunLoopMode &#123; sources0 = &#123; CFRunLoopSource &#123;order = 0, &#123; callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125; &#125;, sources1 = (null), observers = &#123; CFRunLoopObserver &gt;&#123;activities = 0xa0, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125; )&#125;, timers = (null), &#125;, CFRunLoopMode &#123; sources0 = &#123; CFRunLoopSource &#123;order = -1, &#123; callout = PurpleEventSignalCallback&#125;&#125; &#125;, sources1 = &#123; CFRunLoopSource &#123;order = -1, &#123; callout = PurpleEventCallback&#125;&#125; &#125;, observers = (null), timers = (null), &#125;, CFRunLoopMode &#123; sources0 = (null), sources1 = (null), observers = (null), timers = (null), &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode: kCFRunLoopDefaultMode: Appçš„é»˜è®¤ Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª Mode ä¸‹è¿è¡Œçš„ã€‚ UITrackingRunLoopMode: ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“ã€‚ UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚ GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°ã€‚ kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½çš„ Modeï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚ app è¿è¡Œæ—¶ CFRunLoop å†…éƒ¨æ ·å­ï¼Œæ‰“å° runloop å¯¹è±¡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372&lt;CFRunLoop 0x6000008b0000 [0x7fff80615350]&gt;&#123; wakeup port = 0x2703, stopped = false, ignoreWakeUps = true, current mode = (none), common modes = &lt;CFBasicHash 0x600003afbb70 [0x7fff80615350]&gt;&#123; type = mutable set, count = 2, entries =&gt; 0 : &lt;CFString 0x7fff86743f40 [0x7fff80615350]&gt;&#123; contents = \"UITrackingRunLoopMode\"&#125; 2 : &lt;CFString 0x7fff80628740 [0x7fff80615350]&gt;&#123; contents = \"kCFRunLoopDefaultMode\"&#125; &#125;, common mode items = &lt;CFBasicHash 0x600003aa7690 [0x7fff80615350]&gt;&#123; type = mutable set, count = 13, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001bc180 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x7fff384399f5) &#125; &#125; 1 : &lt;CFRunLoopSource 0x6000001b0240 [0x7fff80615350]&gt;&#123; signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x6000010b8e40, callout = FBSSerialQueueRunLoopSourceHandler (0x7fff365a092a) &#125; &#125; 2 : &lt;CFRunLoopSource 0x6000001b40c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 1, info = 0x510b, callout = PurpleEventCallback (0x7fff38439a01) &#125; &#125; 5 : &lt;CFRunLoopSource 0x6000001b80c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae95f0&gt; &#123; port = 430b, callback = 0x0 &#125; &#125; 7 : &lt;CFRunLoopObserver 0x6000005b0820 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123; type = mutable-small, count = 0, values = () &#125; &#125; 8 : &lt;CFRunLoopObserver 0x6000005b0780 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123; type = mutable-small, count = 0, values = () &#125; &#125; 9 : &lt;CFRunLoopObserver 0x6000005b06e0 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x7fff47879310), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt; &#125; 10 : &lt;CFRunLoopObserver 0x6000005b0640 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x7fff478792a7), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt; &#125; 12 : &lt;CFRunLoopSource 0x6000001b8b40 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x6000001b0180, callout = __handleEventQueue (0x7fff478e3efb) &#125; &#125; 16 : &lt;CFRunLoopSource 0x6000001b89c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae9650&gt; &#123; port = 3f0b, callback = 0x0 &#125; &#125; 18 : &lt;CFRunLoopObserver 0x6000005b0140 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x7fff473eda72), context = &lt;CFRunLoopObserver context 0x600001fb5180&gt; &#125; 21 : &lt;CFRunLoopSource 0x6000001b8a80 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x6000034a8160&gt; &#123; port = 4207, callback = 0x7fff2e3fdd33 &#125; &#125; 22 : &lt;CFRunLoopSource 0x6000001b8cc0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x600003a9fe70, callout = __handleHIDEventFetcherDrain (0x7fff478e3f07) &#125; &#125; &#125;, modes = &lt;CFBasicHash 0x600003afbba0 [0x7fff80615350]&gt;&#123; type = mutable set, count = 3, entries =&gt; 0 : &lt;CFRunLoopMode 0x600000fb8270 [0x7fff80615350]&gt;&#123; name = UITrackingRunLoopMode, port set = 0x2c03, queue = 0x600001ab9180, source = 0x600001ab9200 (not fired), timer port = 0x5303, sources0 = &lt;CFBasicHash 0x600003aa76f0 [0x7fff80615350]&gt;&#123; type = mutable set, count = 4, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001bc180 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x7fff384399f5) &#125; &#125; 1 : &lt;CFRunLoopSource 0x6000001b8b40 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x6000001b0180, callout = __handleEventQueue (0x7fff478e3efb) &#125; &#125; 2 : &lt;CFRunLoopSource 0x6000001b0240 [0x7fff80615350]&gt;&#123; signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x6000010b8e40, callout = FBSSerialQueueRunLoopSourceHandler (0x7fff365a092a) &#125; &#125; 3 : &lt;CFRunLoopSource 0x6000001b8cc0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x600003a9fe70, callout = __handleHIDEventFetcherDrain (0x7fff478e3f07) &#125; &#125; &#125;, sources1 = &lt;CFBasicHash 0x600003aa7720 [0x7fff80615350]&gt;&#123; type = mutable set, count = 4, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001b40c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 1, info = 0x510b, callout = PurpleEventCallback (0x7fff38439a01) &#125; &#125; 4 : &lt;CFRunLoopSource 0x6000001b89c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae9650&gt; &#123; port = 3f0b, callback = 0x0 &#125; &#125; 5 : &lt;CFRunLoopSource 0x6000001b8a80 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x6000034a8160&gt; &#123; port = 4207, callback = 0x7fff2e3fdd33 &#125; &#125; 6 : &lt;CFRunLoopSource 0x6000001b80c0 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae95f0&gt; &#123; port = 430b, callback = 0x0 &#125; &#125; &#125; , observers = ( \"&lt;CFRunLoopObserver 0x6000005b0780 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = () &#125; &#125;\", \"&lt;CFRunLoopObserver 0x6000005b0140 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x7fff473eda72), context = &lt;CFRunLoopObserver context 0x600001fb5180&gt; &#125;\", \"&lt;CFRunLoopObserver 0x6000005b0640 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x7fff478792a7), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt; &#125;\", \"&lt;CFRunLoopObserver 0x6000005b06e0 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x7fff47879310), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt; &#125;\", \"&lt;CFRunLoopObserver 0x6000005b0820 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123; type = mutable-small, count = 0, values = () &#125; &#125;\" ), timers = (null), currently 600930818 (56642367633481) / soft deadline in: 1.84466874e+10 sec (@ -1) / hard deadline in: 1.84466874e+10 sec (@ -1) &#125;, 1 : &lt;CFRunLoopMode 0x600000fb8340 [0x7fff80615350]&gt;&#123; name = GSEventReceiveRunLoopMode, port set = 0x5203, queue = 0x600001ab9280, source = 0x600001ab9380 (not fired), timer port = 0x2e03, sources0 = &lt;CFBasicHash 0x600003aa77b0 [0x7fff80615350]&gt;&#123; type = mutable set, count = 1, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001bc180 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x7fff384399f5) &#125; &#125; &#125;, sources1 = &lt;CFBasicHash 0x600003aa77e0 [0x7fff80615350]&gt;&#123; type = mutable set, count = 1, entries =&gt; 2 : &lt;CFRunLoopSource 0x6000001b4180 [0x7fff80615350]&gt;&#123; signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123; version = 1, info = 0x510b, callout = PurpleEventCallback (0x7fff38439a01) &#125; &#125; &#125;, observers = (null), timers = (null), currently 600930818 (56642369572615) / soft deadline in: 1.84466874e+10 sec (@ -1) / hard deadline in: 1.84466874e+10 sec (@ -1) &#125;, 2 : &lt;CFRunLoopMode 0x600000fb01a0 [0x7fff80615350]&gt;&#123; name = kCFRunLoopDefaultMode, port set = 0x2603, queue = 0x600001ab0880, source = 0x600001ab0980 (not fired), timer port = 0x1f03, sources0 = &lt;CFBasicHash 0x600003aa7750 [0x7fff80615350]&gt;&#123; type = mutable set, count = 4, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001bc180 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x7fff384399f5)&#125;&#125; 1 : &lt;CFRunLoopSource 0x6000001b8b40 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6000001b0180, callout = __handleEventQueue (0x7fff478e3efb)&#125;&#125; 2 : &lt;CFRunLoopSource 0x6000001b0240 [0x7fff80615350]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6000010b8e40, callout = FBSSerialQueueRunLoopSourceHandler (0x7fff365a092a)&#125;&#125; 3 : &lt;CFRunLoopSource 0x6000001b8cc0 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x600003a9fe70, callout = __handleHIDEventFetcherDrain (0x7fff478e3f07)&#125;&#125; &#125;, sources1 = &lt;CFBasicHash 0x600003aa7780 [0x7fff80615350]&gt;&#123; type = mutable set, count = 4, entries =&gt; 0 : &lt;CFRunLoopSource 0x6000001b40c0 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x510b, callout = PurpleEventCallback (0x7fff38439a01)&#125;&#125; 4 : &lt;CFRunLoopSource 0x6000001b89c0 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae9650&gt; &#123;port = 3f0b, callback = 0x0&#125;&#125; 5 : &lt;CFRunLoopSource 0x6000001b8a80 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x6000034a8160&gt; &#123;port = 4207, callback = 0x7fff2e3fdd33&#125;&#125; 6 : &lt;CFRunLoopSource 0x6000001b80c0 [0x7fff80615350]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;MSHRunLoopSource 0x600003ae95f0&gt; &#123;port = 430b, callback = 0x0&#125;&#125; &#125;, observers = ( \"&lt;CFRunLoopObserver 0x6000005b0780 [0x7fff80615350]&gt;&#123; valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;&#125;\", \"&lt;CFRunLoopObserver 0x6000005b0140 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x7fff473eda72), context = &lt;CFRunLoopObserver context 0x600001fb5180&gt;&#125;\", \"&lt;CFRunLoopObserver 0x6000005b0640 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x7fff478792a7), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;&#125;\", \"&lt;CFRunLoopObserver 0x6000005b06e0 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x7fff47879310), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;&#125;\", \"&lt;CFRunLoopObserver 0x6000005b0820 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;&#125;\" ), timers = &lt;CFArray 0x6000010b6400 [0x7fff80615350]&gt;&#123; type = mutable-small, count = 1, values = ( 0 : &lt;CFRunLoopTimer 0x6000001b86c0 [0x7fff80615350]&gt;&#123;valid = Yes, firing = No, interval = 0, tolerance = 0, next fire date = 600930808 (-10.16959 @ 56632202715119), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (0x7fff2574c7d2 / 0x7fff46da0bb6) (/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore), context = &lt;CFRunLoopTimer context 0x6000021ef300&gt;&#125; ) &#125;, currently 600930818 (56642369637217) / soft deadline in: 1.84467441e+10 sec (@ 56632202715119) / hard deadline in: 1.84467441e+10 sec (@ 56632202715119) &#125;, &#125;&#125; NSRunLoop æ˜¯å¯¹CFRunLoopRefæŒ‡é’ˆçš„å°è£…ï¼Œè™½ç„¶ä¸¤è€…ä¹‹é—´ç±»å‹è½¬æ¢ä¸æ¶ˆè€—æ€§èƒ½ï¼Œä½†æ˜¯NSRunLoop class å®šä¹‰ä¸€ä¸ªå¾—åˆ° CFRunLoopRef çš„æ–¹æ³• getCFRunLoop é…ç½® RunLoopåœ¨å­çº¿ç¨‹ä¸Šè¿è¡Œ RunLoopï¼Œä½ ä¸€å®šè¦å‘ runloop ä¸­è‡³å°‘æ·»åŠ ä¸€ä¸ª input source æˆ–è€… timerï¼Œå¦‚æœ runloop ä¸­æ²¡æœ‰å¯ç›‘å¬çš„ sourcesï¼Œé‚£ä¹ˆåœ¨ runloop è¿è¡Œçš„æ—¶å€™ä»–å°±ä¼šç«‹åˆ»é€€å‡ºã€‚è¯¦æƒ…çœ‹ä¸‹æ–‡ é…ç½® RunLoop äº‹ä»¶æº(sources)é™¤äº†æ·»åŠ äº‹ä»¶æº sourcesï¼Œä½ å¯èƒ½è¿˜è¦ç»™ runloop æ·»åŠ  observersï¼ˆä½¿ç”¨å®ƒæ¥ç›‘å¬å½“å‰ runloop çš„æ‰§è¡Œé˜¶æ®µï¼‰ã€‚åˆ›å»º run loop observer 123456789101112131415161718192021222324252627282930- (void)threadMain&#123; // The application uses garbage collection, so no autorelease pool is needed. NSRunLoop* myRunLoop = [NSRunLoop currentRunLoop]; // Create a run loop observer and attach it to the run loop. CFRunLoopObserverContext context = &#123;0, self, NULL, NULL, NULL&#125;; CFRunLoopObserverRef observer = CFRunLoopObserverCreate( kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, &amp;myRunLoopObserver, &amp;context); if (observer)&#123; CFRunLoopRef cfLoop = [myRunLoop getCFRunLoop]; CFRunLoopAddObserver(cfLoop, observer, kCFRunLoopDefaultMode); &#125; // Create and schedule the timer. [NSTimer scheduledTimerWithTimeInterval:0.1 target:self selector:@selector(doFireTimer:) userInfo:nil repeats:YES]; NSInteger loopCount = 10; do&#123; // Run the run loop 10 times to let the timer fire. [myRunLoop runUntilDate:[NSDate dateWithTimeIntervalSinceNow:1]]; loopCount--; &#125; while (loopCount);&#125; ç»™ thread é…ç½® runloop è®©å¤„äºä¿æ´»çŠ¶æ€ï¼Œç»™runloop æ·»åŠ ä¸€ä¸ª input sourcesæ¥æ¥å—æ¶ˆæ¯ä¼šæ¯”è¾ƒå¥½ã€‚è™½ç„¶åªæœ‰ä¸€ä¸ª timer sources ä¹Ÿå¯ä»¥è¿›å…¥ runloopï¼Œä½†æ˜¯ä¸€æ—¦ timer firesï¼Œtimer å°±ä¼šå¤±æ•ˆï¼Œå¯¼è‡´ runloop é€€å‡ºã€‚æ·»åŠ ä¸€ä¸ª repeating timer å¯ä»¥è®© runloop ä¿æ´»ï¼Œå¯æ˜¯åå¤è°ƒç”¨ timer fireï¼Œä¼šåå¤å”¤é†’thread(è¿™å®é™…ä¸Šæ˜¯è½®è¯¢çš„å¦ä¸€ç§å½¢å¼)ï¼Œç›¸å¯¹æ¥è¯´ï¼Œä½¿ç”¨ input source æ¥ç­‰å¾… event å‘ç”Ÿï¼Œæ²¡å‘ç”Ÿå‰thread éƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚ å¼€å¯ RunLoopåªæœ‰å­çº¿ç¨‹æ‰éœ€è¦å¼€å¯ RunLoopä¸€ä¸ª RunLoop å®ä¾‹è‡³å°‘æœ‰ä¸€ä¸ª input source or timer æ¥ç›‘å¬äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰å¯ç›‘å¬çš„sourcesï¼ŒRunLoopå¼€å¯åä¼šç«‹å³é€€å‡ºã€‚å¯åŠ¨ RunLoop çš„æ–¹æ³•ï¼šæ–¹å¼æ–¹æ³•å(NSRunLoop)è§£é‡Šæ— æ¡ä»¶runæœ€ç®€å•ä½†ä¹Ÿæœ€ä¸å¯å–çš„æ–¹æ¡ˆã€‚ä¼šè®©çº¿ç¨‹è¿›å…¥æ— é™å¾ªç¯ï¼Œå¯¹ run loop å¾ˆéš¾æ§åˆ¶ã€‚å¯ä»¥æ·»åŠ å’Œç§»é™¤ input source å’Œ timerï¼Œä½†åªèƒ½é€šè¿‡ kill çš„æ–¹å¼åœæ­¢ run loopã€‚æ— æ³•åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹è¿è¡Œ runloopã€‚è®¾å®šæ—¶é—´é™åˆ¶runUntilDate:run loop åœ¨æ”¶åˆ°äº‹ä»¶æˆ–è¶…æ—¶å‰ä¼šä¸€ç›´è¿è¡Œã€‚run loop ç»“æŸåå¯ä»¥é‡å¯ï¼Œå¹¶å¤„ç†æ¥ä¸‹æ¥çš„äº‹æƒ…ã€‚æ¯”ä¸Šä¸€ç§æ–¹å¼æ›´å¥½ï¼Œæä¾›äº†æ—¶é—´é™åˆ¶ã€‚å¤„äºç‰¹å®šæ¨¡å¼runMode:beforeDate:ç›¸æ¯”ä¸Šä¸€ç§æ–¹å¼ï¼Œå¢åŠ äº†åœ¨ç‰¹å®šæ¨¡å¼ä¸‹è¿è¡Œ run loopRunning a run loop 123456789101112131415161718192021- (void)skeletonThreadMain &#123; // Set up an autorelease pool here if not using garbage collection. BOOL done = NO; // Add your sources or timers to the run loop and do any other setup. do&#123; // Start the run loop but return after each source is handled. SInt32 result = CFRunLoopRunInMode(kCFRunLoopDefaultMode, 10, YES); // If a source explicitly stopped the run loop, or if there are no // sources or timers, go ahead and exit. if ((result == kCFRunLoopRunStopped) || (result == kCFRunLoopRunFinished)) done = YES; // Check for any other exit conditions here and set the // done variable as needed. &#125; while (!done); // Clean up code here. Be sure to release any allocated autorelease pools.&#125; å¯ä»¥é€’å½’å¯åŠ¨ run loopã€‚ä¹Ÿå°±æ˜¯è¯´å¯ä»¥åœ¨ input source æˆ– timer çš„å›è°ƒå¤„ç†å‡½æ•°ä¸­è°ƒç”¨ CFRunLoopRun, CFRunLoopRunInMode æˆ–ä¸Šé¢æåˆ°çš„ NSRunLoop çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œè€Œä¸”åµŒå¥—çš„ run loop å¯ä»¥åœ¨ä»»æ„ Mode ä¸‹è¿è¡Œã€‚ é€€å‡º RunLoopåœ¨å¤„ç†äº‹ä»¶ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®© RunLoopé€€å‡ºï¼šç»™ run loop é…ç½® timeout å€¼å‘Šè¯‰ run loop åœæ­¢ä½¿ç”¨timeoutçš„æ–¹å¼ï¼šRunLoop é€€å‡ºä¹‹å‰ä¼šæ‰§è¡Œå®Œæ‰€æœ‰æ­£å¸¸æƒ…å†µä¸‹çš„å¤„ç†ï¼ŒåŒ…æ‹¬å‘ observers å‘é€é€šçŸ¥ã€‚ä½¿ç”¨ CFRunLoopStop()ï¼šå’Œ timeoutæ–¹å¼ç›¸ä¼¼ã€‚RunLoop ä¼šæŠŠå‰©ä¸‹çš„æ‰€æœ‰çŠ¶æ€å‘é€ç»™ observersï¼Œç„¶åé€€å‡ºã€‚ä¸åŒçš„æ˜¯ï¼šä½ åªèƒ½ä½¿ç”¨ CFRunLoopStop åœæ­¢ä»¥ Unconditionally æ–¹å¼å¼€å¯çš„ RunLoopã€‚è¦æ³¨æ„çš„æ˜¯ CFRunLoopStop åªä¼šåœæ­¢å¯¹ CFRunLoopRun å’Œ CFRunLoopRunInMode çš„è°ƒç”¨ã€‚å¯¹äº Cocoa æ¡†æ¶ç›¸å½“äºåªåœæ­¢ä¸€æ¬¡ runMode:beforeDate: çš„è°ƒç”¨ï¼Œè€Œä¸æ˜¯é€€å‡º run loopã€‚stop ä¸€æ¬¡è¿è¡Œå’Œ exit æ•´ä¸ª run loop æ˜¯ä¸ä¸€æ ·çš„ã€‚è™½ç„¶ç§»é™¤ RunLoop çš„ input source å’Œ timer ä¹Ÿä¼šå¯¼è‡´å…¶é€€å‡ºï¼Œä½†è¿™ç§æ–¹æ³•ä¸å¯é ã€‚å› ä¸ºæœ‰äº›ç³»ç»Ÿç¨‹åºä¼šå‘ RunLoop ä¸­æ·»åŠ  input sourceï¼Œå¼€å‘è€…æ ¹æœ¬ä¸çŸ¥é“æœ‰è¿™å›äº‹ï¼Œç§»é™¤çš„æ—¶å€™å°±ä¼šæ¼æ‰ï¼Œè‡ªç„¶å°±ä¸ä¼šå¯¼è‡´ RunLoop é€€å‡ºã€‚ é…ç½® RunLoop äº‹ä»¶æº(sources) å®šä¹‰ Custom Input Sourceåˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æºæ¶‰åŠå®šä¹‰ä»¥ä¸‹å†…å®¹ï¼šä½ æƒ³è®© input source å¤„ç†çš„ä¿¡æ¯A scheduler routineï¼šç”¨äºè®©å¤–éƒ¨ client è·çŸ¥å¦‚ä½•è”ç³» input sourceA handler routineï¼šæ‰§è¡Œä»»ä½• client å‘å‡ºè¯·æ±‚çš„A cancellation routineï¼šä½¿ input source å¤±æ•ˆå› ä¸ºä½ ä½¿ç”¨ custom input source æ¥å¤„ç† custom informationï¼Œé…ç½®çš„è¿‡ç¨‹ä¼šç›¸å½“çµæ´»ã€‚The scheduler, handler, and cancellation routinesï¼Œæ˜¯ä½ åˆ›å»º custome input source çš„å…³é”®ã€‚ä½†æ˜¯ï¼Œinput source å‰©ä¸‹çš„å¤§éƒ¨åˆ†è¡Œä¸ºéƒ½æ²¡æœ‰åœ¨è¿™å‡ ä¸ªå†ç¨‹ä¸­ï¼Œegï¼šå‘ input source ä¼ é€’æ•°æ®çš„æ–¹å¼éœ€è¦ä½ è‡ªå·±å®ç°è®©å…¶ä»–çº¿ç¨‹çŸ¥é“è¿™ä¸ª input source çš„å­˜åœ¨ä¸‹å›¾ç»™å‡ºäº†ä¸€ä¸ª custom input source é…ç½® demoã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œapp çš„ä¸»çº¿ç¨‹ç»´æŠ¤ ï¼šå¼•ç”¨ input sourceå¼•ç”¨ input source è‡ªå®šä¹‰çš„ command bufferå¼•ç”¨ runloop[å·²ç»æŠŠinput source åŠ åˆ°é‡Œé¢äº†]å½“ main thread æœ‰ä¸€ä¸ªtaskæƒ³è¦ worker thread å¤„ç†ï¼Œmain thread ä¼špost ä¸€ä¸ª command åˆ° command buffer ä¸­ï¼Œé¡ºå¸¦æŠŠ worker thread éœ€è¦çš„ä¿¡æ¯å‘ç»™å®ƒï¼Œç„¶å main thread å¼€å¯ taskï¼ˆå› ä¸ºmain thread å’Œ worker thread éƒ½æœ‰å¯ä»¥è®¿é—® command bufferï¼Œæ‰€ä»¥è®¿é—® command buffer çš„è¿‡ç¨‹è¦ syncï¼‰ã€‚ä¸€æ—¦å‘½ä»¤å‘å¸ƒï¼Œmain thread å‘ input source å‘é€æ¶ˆæ¯ï¼Œå”¤èµ· worker thread çš„runloopã€‚worker thread çš„ runloop ä¸€æ—¦æ¥å—åˆ°å”¤èµ·å‘½ä»¤ï¼Œä»–å°±ä¼šè°ƒç”¨ input source çš„ handler ç¨‹åºï¼Œhandler ä¼šå¤„ç† command buffer ä¸­çš„å‘½ä»¤ã€‚æ“ä½œ custom input source å®šä¹‰ Input Sourceå®šä¹‰ custome input source éœ€è¦ Core Foundationï¼Œæ¥å£éƒ½æ˜¯åŸºäº C çš„ï¼ä¸‹é¢ä»£ç å°è£…æˆ OCï¼šRunLoopSource å°è£…äº† CFRunLoopSourceRefï¼Œå¹¶ç®¡ç†ä¸€ä¸ª command bufferï¼Œå¹¶ä½¿ç”¨ buffer æ¥æ”¶å…¶ä»–çº¿ç¨‹çš„æ¶ˆæ¯ã€‚RunLoopContext å°è£…äº† CFRunLoopRef å’Œ RunLoopSource æŒ‡é’ˆï¼Œç”¨äºå‘åº”ç”¨ä¸»çº¿ç¨‹ä¼ é€’ source å¯¹è±¡å’Œ run loop å¼•ç”¨ã€‚Custom Input Source å¯¹è±¡å®šä¹‰ 123456789101112131415161718192021222324252627282930313233// These are the CFRunLoopSourceRef callback functions.void RunLoopSourceScheduleRoutine (void *info, CFRunLoopRef rl, CFStringRef mode);void RunLoopSourcePerformRoutine (void *info);void RunLoopSourceCancelRoutine (void *info, CFRunLoopRef rl, CFStringRef mode);@interface RunLoopSource : NSObject&#123; CFRunLoopSourceRef runLoopSource; NSMutableArray* commands;&#125; - (id)init;- (void)addToCurrentRunLoop;- (void)invalidate; // Handler method- (void)sourceFired; // Client interface for registering commands to process- (void)addCommand:(NSInteger)command withData:(id)data;- (void)fireAllCommandsOnRunLoop:(CFRunLoopRef)runloop; @end // RunLoopContext is a container object used during registration of the input source.@interface RunLoopContext : NSObject&#123; CFRunLoopRef runLoop; RunLoopSource* source;&#125;@property (readonly) CFRunLoopRef runLoop;@property (readonly) RunLoopSource* source; - (id)initWithSource:(RunLoopSource*)src andLoop:(CFRunLoopRef)loop;@end è™½ç„¶ Objective-C ä»£ç ç®¡ç† input source çš„è‡ªå®šä¹‰æ•°æ®ï¼Œä½†æ˜¯æŠŠ input source æ·»åŠ åˆ° runloop ä¸­éœ€è¦åŸºäº c çš„æ–¹æ³•ã€‚ ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ä¾‹ç¨‹æ˜¯ schedulerï¼Œå½“ä½ æŠŠ source æ·»åŠ åˆ° runloop æ—¶å°±ä¼šè°ƒç”¨ã€‚ input source åªæœ‰ä¸€ä¸ª clientï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹ã€‚è¿™é‡Œ scheduler åšçš„äº‹æƒ…å°±æ˜¯ç”¨ application delegate çš„ registerSource: æ–¹æ³•å°† RunLoopContext å¯¹è±¡ä¸­çš„ä¿¡æ¯ä¼ é€’è¿‡å»ï¼Œä»¥ä¾¿ä¹‹å application delegate ä¸ input source é€šä¿¡æ—¶ä½¿ç”¨ã€‚Scheduling a run loop source12345678void RunLoopSourceScheduleRoutine (void *info, CFRunLoopRef rl, CFStringRef mode)&#123; RunLoopSource* obj = (RunLoopSource*)info; AppDelegate* del = [AppDelegate sharedAppDelegate]; RunLoopContext* theContext = [[RunLoopContext alloc] initWithSource:obj andLoop:rl]; [del performSelectorOnMainThread:@selector(registerSource:) withObject:theContext waitUntilDone:NO];&#125;å½“å‘ input source å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œç”¨äºå¤„ç†æ•°æ®çš„ perform å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒæ˜¯æœ€é‡è¦çš„å›è°ƒä¹‹ä¸€ã€‚ä¸‹é¢çš„è¿™ä¸ªæ–¹æ³•åªæ˜¯æŠŠè¯·æ±‚è½¬å‘ç»™äº† RunLoopSource çš„ sourceFired æ–¹æ³•ã€‚åé¢ä¼šåˆ—å‡º sourceFired å¤„ç† command buffer çš„é€»è¾‘ã€‚12345//Performing work in the input sourcevoid RunLoopSourcePerformRoutine (void *info)&#123; RunLoopSource* obj = (__bridge RunLoopSource*)info; [obj sourceFired];&#125;å¦‚æœä½ ä»¥å‰ä½¿ç”¨ CFRunLoopSourceInvalidate() æ–¹æ³•æŠŠ input source ä»runloopä¸­ç§»é™¤ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ input source çš„ cancellation routine. ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ª routine é€šçŸ¥ clientsï¼Œä½ çš„input source å¤±æ•ˆï¼Œéœ€è¦ç§»é™¤ä»–ä»¬å¯¹ input source çš„å¼•ç”¨ã€‚ä¸‹é¢çš„ cancellation routine ä½“ç”¨ç³»ç»Ÿä¼ å…¥çš„ RunLoopSourceï¼Œrunloopï¼ŒrunloopMode åˆ›å»ºä¸€ä¸ªæ–°çš„ RunLoopContextï¼Œå¹¶ä¼ ç»™ application delegateã€‚Invalidating a run loop source:12345678void RunLoopSourceCancelRoutine (void *info, CFRunLoopRef rl, CFStringRef mode)&#123; RunLoopSource* obj = (__bridge RunLoopSource*)info; AppDelegate* del = [AppDelegate sharedAppDelegate]; RunLoopContext* theContext = [[RunLoopContext alloc] initWithSource:obj andLoop:rl]; [del performSelectorOnMainThread:@selector(removeSource:) withObject:theContext waitUntilDone:YES];&#125;æ³¨æ„ application delegateâ€™s çš„ registerSource: and removeSource: æ–¹æ³•åœ¨ä¸‹é¢æœ‰ æŠŠ Input Source æ·»åŠ åˆ° Run Loop12345678910111213141516- (id)init&#123; CFRunLoopSourceContext context = &#123;0, self, NULL, NULL, NULL, NULL, NULL, &amp;RunLoopSourceScheduleRoutine, RunLoopSourceCancelRoutine, RunLoopSourcePerformRoutine&#125;; _runLoopSource = CFRunLoopSourceCreate(NULL, 0, &amp;context); commands = [[NSMutableArray alloc] init]; return self;&#125;- (void)addToCurrentRunLoop&#123; CFRunLoopRef runLoop = CFRunLoopGetCurrent(); CFRunLoopAddSource(runLoop, _runLoopSource, kCFRunLoopDefaultMode);&#125;å½“ worker çº¿ç¨‹è°ƒç”¨ addToCurrentRunLoop æ–¹æ³•æ—¶ï¼Œæ‰ä¼šå°† input source æ”¾åˆ° runloop ä¸­ï¼Œå¹¶åœ¨æ­¤æ—¶è°ƒç”¨ RunLoopSourceScheduleRoutine ã€‚input source åŠ åˆ° runloop ä¹‹åï¼Œthread å°±å¯ä»¥è·‘èµ·ä»–çš„ runloop ï¼Œç­‰å¾…ä»–æ´¾å‘ task ã€‚CFRunLoopSourceContext ç»“æ„ä½“æè¿°äº† custom input sourceï¼ˆsource0ï¼‰çš„ä¸Šä¸‹æ–‡CFRunLoopSourceContext1 ç»“æ„ä½“æè¿°äº† port-based input sourceï¼ˆsource1ï¼‰çš„ä¸Šä¸‹æ–‡12345678910111213141516171819202122232425262728293031typedef struct &#123; CFIndex version; void * info; const void *(*retain)(const void *info); void (*release)(const void *info); CFStringRef (*copyDescription)(const void *info); Boolean (*equal)(const void *info1, const void *info2); CFHashCode (*hash)(const void *info); void (*schedule)(void *info, CFRunLoopRef rl, CFRunLoopMode mode); void (*cancel)(void *info, CFRunLoopRef rl, CFRunLoopMode mode); void (*perform)(void *info);&#125; CFRunLoopSourceContext;typedef struct &#123; CFIndex version; void * info; const void *(*retain)(const void *info); void (*release)(const void *info); CFStringRef (*copyDescription)(const void *info); Boolean (*equal)(const void *info1, const void *info2); CFHashCode (*hash)(const void *info);#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)) || (TARGET_OS_EMBEDDED || TARGET_OS_IPHONE) mach_port_t (*getPort)(void *info); void * (*perform)(void *msg, CFIndex size, CFAllocatorRef allocator, void *info);#else void * (*getPort)(void *info); void (*perform)(void *info);#endif&#125; CFRunLoopSourceContext1; Input Source ä¸ Client çš„åä½œæƒ³ä½¿ç”¨ input sourceï¼Œä½ éœ€è¦ä»å…¶ä»– thread å‘é€æ¶ˆæ¯ã€‚input source çš„å…¨éƒ¨ç›®çš„æ˜¯ä½¿å…¶å…³è” thread å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰äº‹è¦åšã€‚è¿™éœ€è¦è®©ä½ çš„åº”ç”¨ç¨‹åºä¸­çš„å…¶ä»–çº¿ç¨‹çŸ¥é“è¾“å…¥æºå¹¶æœ‰ä¸€ç§ä¸ä¹‹é€šä¿¡çš„æ–¹æ³•ã€‚å½“ input source ç¬¬ä¸€æ¬¡è£…è½½åˆ° run loop çš„æ—¶å€™ï¼Œå¯ä»¥å‘ client å‘é€æ³¨å†Œ input source çš„è¯·æ±‚ã€‚å¯ä»¥å°†ä¸€ä¸ª input source ç›´æ¥æˆ–é—´æ¥æ³¨å†Œåˆ°å¤šä¸ª client ä¸­ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº† application delegate æä¾›çš„æ³¨å†Œæ–¹æ³• registerSource:ï¼Œä¹‹å‰æåˆ°è¿‡å›è°ƒå‡½æ•° RunLoopSourceScheduleRoutine çš„å®ç°ä¼šè°ƒç”¨ registerSource:ã€‚ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œæµç¨‹æ˜¯ install(addToCurrentRunLoop) -&gt; schedule(RunLoopSourceScheduleRoutine) -&gt; register(registerSource:)ã€‚å¯¹åº”åœ°ï¼Œå½“ input source ä» run loop ä¸­è¢«ç§»é™¤ï¼Œå›è°ƒå‡½æ•° RunLoopSourceCancelRoutine ä¸­ä¼šè°ƒç”¨ removeSource: æ–¹æ³•ã€‚scheduler an input source å’Œ Invalidating an input source1234567891011121314151617- (void)registerSource:(RunLoopContext*)sourceInfo;&#123; [sourcesToPing addObject:sourceInfo];&#125; - (void)removeSource:(RunLoopContext*)sourceInfo&#123; id objToRemove = nil; for (RunLoopContext* context in sourcesToPing) &#123; if ([context isEqual:sourceInfo]) &#123; objToRemove = context; break; &#125; &#125; if (objToRemove) [sourcesToPing removeObject:objToRemove];&#125; å‘ Input Source å‘é€ä¿¡å·åœ¨å°†æ•°æ®äº¤ç»™ Input Source åï¼Œå®¢æˆ·ç«¯å¿…é¡»å‘ä¿¡å·é€šçŸ¥æºå¹¶å”¤é†’å…¶ runloopã€‚æ¶ˆæ¯ä¼ è¾¾ input source ä»¥åï¼Œthread å¯ä»¥å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä½ åº”è¯¥æ˜¾ç¤ºçš„å”¤èµ· runloopï¼Œå¦‚æœå¤„ç†å®Œäº†å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ç»“æœï¼Waking up the run loop:1234- (void)fireCommandsOnRunLoop:(CFRunLoopRef)runloop &#123; CFRunLoopSourceSignal(runLoopSource); CFRunLoopWakeUp(runloop);&#125; é…ç½® Timer Sourcesåˆ›å»º Timer Sourcesï¼šåˆ›å»ºä¸€ä¸ª timer å¯¹è±¡ï¼Œç„¶ååœ¨ runloopä¸­è°ƒåº¦å®ƒã€‚Cocoa ä¸­ä½¿ç”¨ NSTimerï¼ŒCore Foundation ä¸­ä½¿ç”¨ CFRunLoopTimerRef ç±»å‹ã€‚è™½ç„¶äºŒè€…æ˜¯ toll-free bridged çš„ï¼Œä½†æ˜¯ NSTimer æä¾›çš„ API æ›´ä¾¿æ·ï¼š12scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:scheduledTimerWithTimeInterval:invocation:repeats:ä¸Šé¢è¿™2ä¸ªæ–¹æ³•ä¼šåˆ›å»º timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹ runloop çš„ DefaultMode ä¸­ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª NSTimer å¯¹è±¡å¹¶ç”¨ NSRunLoop çš„ addTimer:forMode: æ–¹æ³•å°†å…¶æ·»åŠ åˆ° runloop çš„æŒ‡å®š Mode ä¸­ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸¤ç§æ·»åŠ  timer çš„æ–¹å¼ï¼šç¬¬ä¸€ä¸ª timer å»¶è¿Ÿ 1 ç§’è§¦å‘å¹¶æ¯éš” 0.1 ç§’é‡å¤è§¦å‘ï¼Œç¬¬äºŒä¸ª timer å»¶è¿Ÿ 0.2 ç§’è§¦å‘ç„¶åæ¯éš” 0.2 ç§’é‡å¤è§¦å‘ã€‚Creating and scheduling timers using NSTimer:123456789101112131415161718NSRunLoop* myRunLoop = [NSRunLoop currentRunLoop]; // Create and schedule the first timer.NSDate* futureDate = [NSDate dateWithTimeIntervalSinceNow:1.0];NSTimer* myTimer = [[NSTimer alloc] initWithFireDate:futureDate interval:0.1 target:self selector:@selector(myDoFireTimer1:) userInfo:nil repeats:YES];[myRunLoop addTimer:myTimer forMode:NSDefaultRunLoopMode]; // Create and schedule the second timer.[NSTimer scheduledTimerWithTimeInterval:0.2 target:self selector:@selector(myDoFireTimer2:) userInfo:nil repeats:YES];Creating and scheduling a timer using Core Foundation:123456CFRunLoopRef runLoop = CFRunLoopGetCurrent();CFRunLoopTimerContext context = &#123;0, NULL, NULL, NULL, NULL&#125;;CFRunLoopTimerRef timer = CFRunLoopTimerCreate(kCFAllocatorDefault, 0.1, 0.3, 0, 0, &amp;myCFTimerCallback, &amp;context); CFRunLoopAddTimer(runLoop, timer, kCFRunLoopCommonModes); é…ç½® a Port-Based Input SourceCocoa and Core Foundation éƒ½æä¾›äº† port-based å¯¹è±¡ç”¨äºçº¿ç¨‹ or è¿›ç¨‹é—´é€šè®¯ï¼Œä¸‹é¢ä¼šä½¿ç”¨ä¸åŒç±»å‹çš„ ports å®ç°å»ºç«‹ port é€šè®¯ é…ç½® NSMachPort Objectä½¿ç”¨ NSMachPort å¯¹è±¡å»ºç«‹æœ¬åœ°è¿æ¥ï¼šåˆ›å»º NSMachPort å¯¹è±¡å¹¶æ·»åŠ åˆ° primary çº¿ç¨‹çš„ runloop ä¸­ã€‚å½“å¯åŠ¨ secondary çº¿ç¨‹æ—¶å°†è¿™ä¸ª NSMachPort å¯¹è±¡ä¼ é€’ç»™ secondary çº¿ç¨‹çš„å…¥å£å‡½æ•°ã€‚secondary çº¿ç¨‹ä¼šç”¨è¿™ä¸ª NSMachPort å¯¹è±¡å¾€ primary çº¿ç¨‹å‘æ¶ˆæ¯ã€‚ main thread ä»£ç å®ç°ä¸‹é¢çš„ä»£ç æ˜¯å¯åŠ¨ secondary worker çº¿ç¨‹çš„ä¸»è¦ä»£ç ã€‚ä½¿ç”¨ Cocoa æ¡†æ¶çš„ä»£ç è¦æ¯” Core Foundation çš„å°‘ï¼Œæ•ˆæœå‡ ä¹ä¸€æ ·ã€‚æœ‰ä¸ªä¸åŒç‚¹æ˜¯ Cocoa ç›´æ¥ä¼ é€’ NSPort å¯¹è±¡ï¼Œè€Œ Core Foundation ä¼ é€’ç«¯å£åå­—ç¬¦ä¸²ã€‚1234567891011121314- (void)launchThread&#123; NSPort* myPort = [NSMachPort port]; if (myPort) &#123; // This class handles incoming port messages. [myPort setDelegate:self]; // Install the port as an input source on the current run loop. [[NSRunLoop currentRunLoop] addPort:myPort forMode:NSDefaultRunLoopMode]; // Detach the thread. Let the worker release the port. [NSThread detachNewThreadSelector:@selector(LaunchThreadWithPort:) toTarget:[MyWorkerClass class] withObject:myPort]; &#125;&#125;ä¸ºäº†å»ºç«‹å¥½ threads é—´çš„é€šè®¯ï¼Œä½ å¯èƒ½æƒ³è¦å¾—åˆ° worker thread å°†ä»–çš„æœ¬åœ°ç«¯å£å·å‘é€ç»™ main threadï¼ŒæŠŠè¿™ä¸ªå½“åšæ ¡éªŒæ¶ˆæ¯ã€‚main thread å¾—åˆ° worker thread çš„ç«¯å£å·ï¼Œæ ¡éªŒå®Œæ¯•ï¼Œå°±çŸ¥é“å¯åŠ¨ secondary thread çš„è¿‡ç¨‹ä¸€åˆ‡è¿›å±•é¡ºåˆ©ã€‚ä¸»çº¿ç¨‹ä¼šå°† worker thread çš„ portID ä¿å­˜èµ·æ¥ã€‚ä¸‹é¢çš„ handlePortMessage: æ–¹æ³•ä¼šåœ¨çº¿ç¨‹è‡ªå·±çš„æœ¬åœ°ç«¯å£æ”¶åˆ°æ•°æ®åè¢«è°ƒç”¨ã€‚NSPortMessage æŒæœ‰ä¸¤ä¸ªç«¯å£å¯¹è±¡ï¼šå‘é€ç«¯å£å’Œæ¥æ”¶ç«¯å£ã€‚handlePortMessage: æ–¹æ³•ä¸­ä½¿ç”¨ [portMessage sendPort] è·å–åˆ°äº†å‘é€ç«¯å£å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ secondary thread æ‹¥æœ‰çš„æœ¬åœ°ç«¯å£ã€‚ä¹Ÿå°±æ˜¯ secondary thread å¯åŠ¨åä¼šç»™ primary thread å‘æ¶ˆæ¯ï¼Œå‘ŠçŸ¥è‡ªå·±çš„ç«¯å£å¯¹è±¡ï¼Œä¸»çº¿ç¨‹ä¼šå°†å…¶å­˜ä¸‹æ¥ä»¥å¤‡æ—¥åä½¿ç”¨ã€‚msgid æ ‡è®°äº†æ¶ˆæ¯çš„å”¯ä¸€ IDã€‚Handling Mach port messages:1234567891011121314151617#define kCheckinMessage 100// Handle responses from the worker thread.- (void)handlePortMessage:(NSPortMessage *)portMessage&#123; unsigned int message = [portMessage msgid]; NSPort* distantPort = nil; if (message == kCheckinMessage) &#123; // Get the worker threadâ€™s communications port. distantPort = [portMessage sendPort]; // Retain and save the worker port for later use. [self storeDistantPort:distantPort]; &#125; else&#123; // Handle other messages. &#125;&#125; secondary thread ä»£ç å®ç°å¯¹äº secondary worker thread, ä½ ä¸€å®šè¦æ˜ç¡®ä»–çš„ç«¯å£å·ï¼ç”¨å®ƒä¸ primary thread é€šè®¯ã€‚ä¸‹é¢ä»£ç ï¼šå¦‚ä½•é…ç½® worker threadï¼Œworker thread çš„å…¥å£å‡½æ•°ä¼šè¢«ä¼ å…¥ primary thread çš„ç«¯å£å¯¹è±¡ã€‚ä¸‹é¢ä»£ç ä¸­çš„ MyWorkerClass æ˜¯ä¸ªè¾…åŠ©ç±»ï¼Œå®ƒçš„ sendCheckinMessage: æ–¹æ³•è´Ÿè´£åˆ›å»ºworker threadçš„æœ¬åœ°ç«¯å£ï¼Œå¹¶å‘æ¶ˆæ¯ç»™ primary thread ã€‚12345678910111213141516171819+(void)LaunchThreadWithPort:(id)inData&#123; NSAutoreleasePool* pool = [[NSAutoreleasePool alloc] init]; // Set up the connection between this thread and the main thread. NSPort* distantPort = (NSPort*)inData; MyWorkerClass* workerObj = [[self alloc] init]; [workerObj sendCheckinMessage:distantPort]; [distantPort release]; // Let the run loop process things. do &#123; [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]; &#125; while (![workerObj shouldExit]); [workerObj release]; [pool release];&#125; é…ç½® NSMessagePort Object ä½¿ç”¨ Core Foundation é…ç½® Port-Based Input SourceThreading Programming Guide-RunLoopThreading Programming Guide(2)","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"runloop","slug":"iOS-Programming/runloop","permalink":"https://changzw.github.io/categories/iOS-Programming/runloop/"}]},{"title":"RunLoop åŸç†åˆ†æ","date":"2017-08-27T11:49:54.000Z","path":"2017/08/27/runloop/RunLoopåˆ†æ/","text":"å¸¦ç€é—®é¢˜æ€è€ƒ QuestionsRunLoop ä»–æ˜¯ä»€ä¹ˆï¼ŸRunLoop ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä¸ºä»€ä¹ˆè¦æ˜¯è¿™æ ·çš„ç»“æ„ï¼Œå…¶ä»–çš„æ ·å­ä¸å¯ä»¥å—ï¼ŸRunLoop å†…éƒ¨åˆ†æï¼Ÿç³»ç»Ÿä¸­æœ‰å“ªäº›åŠŸèƒ½ä½¿ç”¨äº† runloopï¼Ÿå¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨ RunLoopå¼•ç”¨ CFRunLoopRef æºç ï¼šCF-1153.18.tar.gz RunLoop æ¥æºä¸€èˆ¬æ¥è¯´ï¼Œthread åªè¿è¡Œä¸€æ¬¡ï¼Œç„¶åç»ˆæ­¢. åƒå‘½ä»¤è¡Œé©±åŠ¨ç¨‹åºã€‚ä½†æ˜¯è¿™æ ·çš„ç¨‹åºæ²¡æœ‰ç”¨æˆ·äº¤äº’æ€§ä¸ºäº†ä½¿ç¨‹åºå¢åŠ ç”¨æˆ·äº¤äº’æ€§ï¼Œå°±éœ€è¦ä¸€ä¸ªæœºåˆ¶è®©ç¨‹åºä¸é€€å‡ºç­‰å¾…ç”¨æˆ·æ“ä½œã€‚ä½¿ç”¨Event Loopè®¾è®¡æ¨¡å¼ï¼Œè®© thread å…³è”ä¸€ä¸ª event loopï¼Œç›‘å¬ eventï¼Œç„¶åè°ƒç”¨äº‹ä»¶çš„ reactor å¤„ç†äº‹ä»¶é€šå¸¸æ˜¯äº¤ç”± event loop å…³è”çš„ thread å¤„ç†ã€‚è¿™æ ·ä½¿ thread ä¿æ´»1234567function main initialize() while message != quit message := get_next_message() process_message(message) end whileend functionè€Œå¯¹äºæ²¡æœ‰ runloop çš„thread123456789101112@objcfunc task2() &#123; print(#function)&#125;override func touchesEnded(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?) &#123; let thread = Thread &#123; print(\"task1\") &#125; thread.start() perform(#selector(LongLiveViewController.task2), on: thread, with: nil, waitUntilDone: false)&#125;ç»“æœåªä¼šæ‰“å° task1ï¼Œå› ä¸º thread æ²¡æœ‰ runloopï¼Œæ‰€ä»¥æ‰§è¡Œå®Œå½“å‰ä»»åŠ¡ task1 ä»¥åä¼šè‡ªåŠ¨é€€å‡º123456789func withoutRunloop() &#123; let thread = Thread &#123; print(\"task 1\") RunLoop.current.add(Port(), forMode: .default) RunLoop.current.run(mode: .default, before: Date.distantFuture) &#125; thread.start() perform(#selector(LongLiveViewController.task2), on: thread, with: nil, waitUntilDone: true)&#125;æ‰“å° task1ï¼Œtask2()ï¼Œåªæœ‰å½“ Port ä» runloop ä¸­ç§»é™¤è¿™ä¸ªçº¿ç¨‹å°±ä¼šé€€å‡ºï¼Œå¦åˆ™ä»–çš„ç”Ÿå‘½å‘¨æœŸç”± runloop ç»´æŠ¤ç€ï¼Œå…·ä½“çœ‹ä¸‹æ–‡ Event loop æœºåˆ¶Event Loop åœ¨å¾ˆå¤šå¹³å°ä¸Šéƒ½æœ‰ï¼Œæ— è®ºæ˜¯ GUIï¼Œå¼€å§‹ç³»ç»Ÿäº‹ä»¶éƒ½éœ€è¦ Event Loop æ¨¡å¼æ¥å¤„ç†äº¤äº’ç¨‹åºç¯å¢ƒEvent_Loopå¯¹åº”åç§°OSX/iOSRunLoopWindowsæ¶ˆæ¯é˜Ÿåˆ—Linuxepollï¼Œselectæ¶ˆæ¯é˜Ÿåˆ—ä½¿å¾—è°ƒç”¨æ–¹è·Ÿè¢«è°ƒç”¨æ–¹ä¹‹é—´è§£è€¦ OSX/iOS ä¸­çš„ Event Loop RunLoop ç‰¹ç‚¹ï¼šä»–æ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€æ¶æ„çš„ä¸€éƒ¨åˆ†ï¼Œå……å½“ç€å¾ªç¯å¤„ç†ã€è°ƒåº¦äº‹ä»¶/è½¬å‘æ¶ˆæ¯çš„è§’è‰²ï¼Œç®¡ç†threadè¿è¡ŒçŠ¶æ€ã€‚å®ƒä½¿å¾—çº¿ç¨‹ä¸ä¼šæ‰§è¡Œå®Œå•ä¸ªä»»åŠ¡åå°±ç«‹åˆ»ç»“æŸè®©çº¿ç¨‹åœ¨æ²¡æœ‰ä»»åŠ¡æ—¶ä¿æŒä¼‘çœ çŠ¶æ€åœ¨éœ€è¦å¤„ç†æ¶ˆæ¯æ—¶è¢«ç«‹åˆ»å”¤é†’RunLoop æ˜¯ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æœ‰å¯¹åº”çš„ runloopã€‚runloopçš„ç®¡ç†æœºåˆ¶å¹¶ä¸å®Œå…¨æ˜¯è‡ªåŠ¨çš„ï¼Œæœ‰æ—¶éœ€è¦è®¾è®¡å¥½ runloop çš„è¿è¡Œæ—¶é—´å’Œäº‹ä»¶å¤„ç†å›è°ƒã€‚é™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œå­çº¿ç¨‹éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å»é…ç½®å¹¶è¿è¡Œå®ƒçš„ runloopä¸»çº¿ç¨‹çš„ runloop å·²ç»ç”±ç³»ç»Ÿè‡ªåŠ¨é…ç½®å¹¶è¿è¡Œäº†ã€‚runloop åœ¨ Cocoa å’Œ Core Foundation æœ‰ä¸¤ä¸ªå¯¹åº”çš„ç±»ï¼šNSRunLoop å’Œ CFRunLoop Run Loop å†…éƒ¨æ‰§è¡Œæµç¨‹çº¿ç¨‹çš„ run loop æ¯æ¬¡è¿è¡Œéƒ½ä¼šå¤„ç†å¾…å†³çš„äº‹ä»¶ï¼Œå¹¶ä¸ºç»‘å®šçš„æ‰€æœ‰ observer ç”Ÿæˆé€šçŸ¥ã€‚æ¬¡åºå¦‚ä¸‹ï¼šå¦‚æœmodeé‡Œæ²¡æœ‰source/timer/observer, ç›´æ¥è¿”å›ã€‚é€šçŸ¥ observer å·²ç»è¿›å…¥ run loop (kCFRunLoopEntry)é€šçŸ¥ observer æœ‰ timer å°†è¦è§¦å‘ (kCFRunLoopBeforeTimers)é€šçŸ¥ observer æœ‰éåŸºäºç«¯å£çš„ input source(source0) å°†è¦è§¦å‘ (kCFRunLoopBeforeSources)è§¦å‘æ‰€æœ‰å·²å°±ç»ªçš„éåŸºäºç«¯å£çš„ input source(source0)å¦‚æœä¸€ä¸ªåŸºäºç«¯å£çš„ input source(source1, ç³»ç»Ÿè§¦å‘) å·²å°±ç»ªå¹¶ç­‰å¾…è§¦å‘ï¼Œç«‹å³å¤„ç†äº‹ä»¶ï¼Œå¹¶è½¬è‡³ç¬¬ 9 æ­¥é€šçŸ¥ observer çº¿ç¨‹å³å°†ä¼‘çœ  (kCFRunLoopBeforeWaiting)è®©çº¿ç¨‹ä¼‘çœ ï¼Œç›´åˆ°è¢«ä»¥ä¸‹æ¡ä»¶å”¤é†’ï¼šæœ‰åŸºäºç«¯å£çš„ input source äº‹ä»¶åˆ°è¾¾timer è§¦å‘run loop è®¾å®šçš„è¶…æ—¶æ—¶é—´åˆ°äº†run loop è¢«æ‰‹åŠ¨å”¤é†’é€šçŸ¥ observer çº¿ç¨‹åˆšåˆšè¢«å”¤é†’ (kCFRunLoopAfterWaiting)å¤„ç†å¾…å†³äº‹ä»¶å¦‚æœç”¨æˆ·å®šä¹‰çš„ timer è§¦å‘äº†ï¼Œå¤„ç† timer äº‹ä»¶å¹¶é‡å¯ run loopï¼Œè·³å›åˆ°ç¬¬ 2 æ­¥å¦‚æœ input source è§¦å‘äº†ï¼Œåˆ†å‘äº‹ä»¶å¦‚æœ run loop è¢«å”¤é†’ä¸”æ²¡æœ‰è¶…æ—¶ï¼Œé‡å¯ run loopï¼Œè·³å›åˆ°ç¬¬ 2 æ­¥é€šçŸ¥ observer å·²ç»é€€å‡º run loop (kCFRunLoopExit)å¯¹åº”ç®€åŒ–æºç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495int CFRunLoopRunSpecific(runloop, modeName, seconds, stopAfterHandle) &#123; CFRunLoopModeRef currentMode = __CFRunLoopFindMode(runloop, modeName, false); // å¦‚æœmodeé‡Œæ²¡æœ‰source/timer/observer, ç›´æ¥è¿”å›ã€‚ if (__CFRunLoopModeIsEmpty(currentMode)) return; // 1. é€šçŸ¥ Observers: RunLoop å³å°†è¿›å…¥ loopã€‚ __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopEntry); // å†…éƒ¨å‡½æ•°ï¼Œè¿›å…¥loop __CFRunLoopRun(runloop, currentMode, seconds, returnAfterSourceHandled) &#123; Boolean sourceHandledThisLoop = NO; int retVal = 0; do &#123; // 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚ __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeTimers); // 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚ __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeSources); // æ‰§è¡Œè¢«åŠ å…¥çš„block __CFRunLoopDoBlocks(runloop, currentMode); // 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚ sourceHandledThisLoop = __CFRunLoopDoSources0(runloop, currentMode, stopAfterHandle); // æ‰§è¡Œè¢«åŠ å…¥çš„block __CFRunLoopDoBlocks(runloop, currentMode); // 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚ if (__Source0DidDispatchPortLastTime) &#123; Boolean hasMsg = __CFRunLoopServiceMachPort(dispatchPort, &amp;msg) if (hasMsg) goto handle_msg; &#125; // é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚ if (!sourceHandledThisLoop) &#123; __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeWaiting); &#125; // 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ã€‚ // â€¢ ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚ // â€¢ ä¸€ä¸ª Timer åˆ°æ—¶é—´äº† // â€¢ RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº† // â€¢ è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’ __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort) &#123; mach_msg(msg, MACH_RCV_MSG, port); // thread wait for receive msg &#125; // 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†ã€‚ __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopAfterWaiting); // æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚ handle_msg: // 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒã€‚ if (msg_is_timer) &#123; __CFRunLoopDoTimers(runloop, currentMode, mach_absolute_time()) &#125; // 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblockã€‚ else if (msg_is_dispatch) &#123; __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg); &#125; // 9.3 å¦‚æœä¸€ä¸ª Source1 (åŸºäºport) å‘å‡ºäº‹ä»¶äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶ else &#123; CFRunLoopSourceRef source1 = __CFRunLoopModeFindSourceForMachPort(runloop, currentMode, livePort); sourceHandledThisLoop = __CFRunLoopDoSource1(runloop, currentMode, source1, msg); if (sourceHandledThisLoop) &#123; mach_msg(reply, MACH_SEND_MSG, reply); &#125; &#125; // æ‰§è¡ŒåŠ å…¥åˆ°Loopçš„block __CFRunLoopDoBlocks(runloop, currentMode); if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123; // è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚ retVal = kCFRunLoopRunHandledSource; &#125; else if (timeout) &#123; // è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº† retVal = kCFRunLoopRunTimedOut; &#125; else if (__CFRunLoopIsStopped(runloop)) &#123; // è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº† retVal = kCFRunLoopRunStopped; &#125; else if (__CFRunLoopModeIsEmpty(runloop, currentMode)) &#123; // source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº† retVal = kCFRunLoopRunFinished; &#125; // å¦‚æœæ²¡è¶…æ—¶ï¼Œmodeé‡Œæ²¡ç©ºï¼Œloopä¹Ÿæ²¡è¢«åœæ­¢ï¼Œé‚£ç»§ç»­loopã€‚ &#125; while (retVal == 0); &#125; // 10. é€šçŸ¥ Observers: RunLoop å³å°†é€€å‡ºã€‚ __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);&#125; å®é™…ä¸Š RunLoop å°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-while å¾ªç¯ã€‚å½“ä½ è°ƒç”¨ CFRunLoopRun() æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼›ç›´åˆ°è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›ã€‚ RunLoopåº•å±‚å®ç°æ ¸å¿ƒæ˜¯æºç ä¸­çš„ç¬¬ 7 æ­¥ï¼š7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’mach_msg() å‡½æ•°å®é™…ä¸Šæ˜¯è°ƒç”¨äº†ä¸€ä¸ª Mach é™·é˜± (trap)ï¼Œå³å‡½æ•°mach_msg_trap()ï¼Œé™·é˜±è¿™ä¸ªæ¦‚å¿µåœ¨ Mach ä¸­ç­‰åŒäºç³»ç»Ÿè°ƒç”¨ã€‚å½“ä½ åœ¨ç”¨æˆ·æ€è°ƒç”¨ mach_msg_trap() æ—¶ä¼šè§¦å‘é™·é˜±æœºåˆ¶ï¼Œåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼›å†…æ ¸æ€ä¸­å†…æ ¸å®ç°çš„ mach_msg() å‡½æ•°ä¼šå®Œæˆå®é™…çš„å·¥ä½œï¼Œå¦‚ä¸‹å›¾ï¼šä½¿ç”¨ xcodeï¼Œå½“ç¨‹åºä¸æ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œclick debug çš„æš‚åœåœ¨æ²¡æœ‰äº‹ä»¶å¤„ç†æ—¶ï¼šThread 1 Queue : com.apple.main-thread (serial)com.apple.uikit.eventfetch-thread (6)è¿™ä¸¤ä¸ªçº¿ç¨‹çš„runloopéƒ½åœç•™åœ¨mach_msg_trapçŠ¶æ€ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚å…¶ä»–çº¿ç¨‹éƒ½æ˜¯ _workq_kernreturnï¼šç­‰å¾… spinlock æŠ€æœ¯ï¼Œä»è€Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª taskï¼ˆæˆ–è€…é€€å‡ºï¼‰ RunLoopç»“æ„ Modeé¦–å…ˆè¦çŸ¥é“ Mode çš„ä½œç”¨ï¼šä¸ºäº†å‡å°‘runloopç›‘å¬çš„source/timer/observer çš„ä¸ªæ•°RunLoop å’Œ Mode ç®€åŒ–æºç 123456789101112131415161718typedef struct __CFRunLoopMode *CFRunLoopModeRef;struct __CFRunLoopMode &#123; CFStringRef _name; // Mode Name, ä¾‹å¦‚ @\"kCFRunLoopDefaultMode\" CFMutableSetRef _sources0; // Set è‡ªå®šä¹‰çš„ input sourceï¼Œç”±å…¶ä»– thread å‘é€æ¶ˆæ¯ CFMutableSetRef _sources1; // Set åŸºäº port åŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ CFMutableArrayRef _observers; // Array CFMutableArrayRef _timers; // Array ...&#125;; typedef struct __CFRunLoop *CFRunLoopRef;struct __CFRunLoop &#123; pthread thread; CFMutableSetRef _commonModes; // Set é€šç”¨ modesé›†åˆï¼Œä»»ä½•Source/Observer/Timer åŠ å…¥å…¶ä¸­ä»¥åï¼Œ_commonModes ä¸­çš„æ¯ä¸ª mode éƒ½ä¼šå¼•ç”¨è¿™äº›(Source/Observer/Timer ),å¹¶å¯¹å…¶åšç›¸åº”å¤„ç† CFMutableSetRef _commonModeItems; // Set æ‰€æœ‰_commonModesä¸­å¼•ç”¨ &lt;Source/Observer/Timer&gt; CFRunLoopModeRef _currentMode; // Current Runloop Mode CFRunLoopCopyAllModesæ–¹æ³•ä¼šå¾—åˆ°å®ƒ ...&#125;;Input Sources:Port-Based Sourcesï¼šç›‘å¬Appçš„ Mach Portï¼Œç”±å†…æ ¸å‘å‡ºä¿¡å·ï¼Œè¾“å…¥æºæ”¶åˆ°ä¿¡å·åï¼Œæ‰§è¡Œç›¸å…³çš„ä¾‹ç¨‹ã€‚(sources1)Custom Input Sourcesï¼šç›‘å¬è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œéœ€è¦åœ¨å…¶å®ƒçº¿ç¨‹æ‰‹åŠ¨å‘é€ä¿¡å·ï¼Œè¾“å…¥æºæ”¶åˆ°ä¿¡å·åï¼Œæ‰§è¡Œç›¸å…³çš„ä¾‹ç¨‹ã€‚(sources0)Cocoa Perform Selector Sourcesï¼šCocoaä¸­è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œç›®çš„æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼ŒåŒä¸€çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯é¡ºåºæ‰§è¡Œçš„,å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆåç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤è¿™ä¸ªæºã€‚ï¼ˆæ³¨æ„ï¼šåœ¨ç›®æ ‡çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªç›®æ ‡çº¿ç¨‹å¿…é¡»æœ‰æ´»è·ƒçš„RunLoopï¼‰(sources0)æ—¶é—´æº time sourceséœ€è¦ç›‘å¬runloopçš„å½“å‰çŠ¶æ€çš„ï¼šç›‘å¬è€… observersRunLoop çš„æ¯æ¬¡è¿è¡Œéƒ½ä¼šåœ¨æŸä¸ªç‰¹å®šæ¨¡å¼ä¸‹ï¼Œè€Œä¸”åªæœ‰è¿™ä¸ªæ¨¡å¼æ‰€åŒ…å«çš„ item é›†åˆæ‰ä¼šå‚ä¸å‘é€äº‹ä»¶(è¢«ç›‘å¬)å’Œæ¥æ”¶é€šçŸ¥ã€‚å¦‚æœæ”¹ item æ²¡æœ‰åŠ å…¥åˆ°æŒ‡å®šæ¨¡å¼ä¸‹çš„runloopï¼Œé‚£ä¹ˆè¯¥æ¨¡å¼ä¸‹å°±ä¸ä¼šæ‰§é€šçŸ¥orç›‘å¬è¯¥ itemï¼Œå¦‚æœæ²¡æœ‰ item é‚£ä¹ˆä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚mode ä¸­éœ€è¦æ³¨æ„çš„ default å’Œ tracing è¿™ä¸¤ç§ï¼Œåœ¨å®é™…å¼€å‘ä¸­ä¼šç»å¸¸ä½¿ç”¨Modeåç§°æè¿°DefaultNSDefaultRunLoopMode (Cocoa), kCFRunLoopDefaultMode (Core Foundation)Appçš„é»˜è®¤è¿è¡Œæ¨¡å¼ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªè¿è¡Œæ¨¡å¼ä¸‹è¿è¡ŒConnectionNSConnectionReplyMode (Cocoa)Cocoa ä¸­ç»“åˆ NSConnection ä½¿ç”¨ï¼Œç”¨äºç›‘å¬å›å¤(Reply)ï¼Œæå°‘ç”¨åˆ°ã€‚(å·²å¼ƒç”¨)ModalNSModalPanelRunLoopMode (Cocoa)Cocoa ä¸­ modal panel ä½¿ç”¨å®ƒæ¥æ”¶ä¸ä¹‹ç›¸å…³ Source çš„äº‹ä»¶Event trackingNSEventTrackingRunLoopMode (Cocoa), UITrackingRunLoopMode (Cocoa Touch)è·Ÿè¸ªç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ï¼‰Common modesNSRunLoopCommonModes (Cocoa), kCFRunLoopCommonModes (Core Foundation)è¿™æ˜¯ä¸€ç»„å¯é…ç½®çš„é€šç”¨é›†åˆï¼Œå¦‚æœå°†æŸä¸ª input source æ³¨å†Œåˆ°è¯¥æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆ input source åœ¨é€šç”¨æ¨¡å¼é›†åˆä¸­çš„æ¯ä¸ª mode ä¸­éƒ½ä¼šæ³¨å†Œã€‚Cocoa æ¡†æ¶ä¸­çš„ Common modes é»˜è®¤åŒ…å« Default, Modal, Event tracking ä¸‰ç§ Modeï¼›Core Foundation åªåŒ…å« Defaultï¼Œå¯ä»¥ä½¿ç”¨ CFRunLoopAddCommonMode å‡½æ•°å‘é›†åˆä¸­æ·»åŠ è‡ªå®šä¹‰ Modeã€‚Common modes ä¸æ˜¯ä¸€ä¸ªmodeï¼Œè€Œæ˜¯ä¸€ä¸ª modes é›†åˆï¼eg: åœ¨ Cocoa æ¡†æ¶ä¸­ï¼Œå¦‚æœ Sources, timers, observers æ·»åŠ åˆ° CommonModesä¸­ï¼Œé‚£ä¹ˆ Sources, timers, observers ä¼šè¢« CommonModes ç»“åˆä¸­(Default, Modal, Event tracking)æ‰€æœ‰æ¨¡å¼å…±äº«ï¼1void CFRunLoopAddCommonMode(CFRunLoopRef rl, CFRunLoopMode mode);ä¸€æ—¦ mode æ·»åŠ åˆ° runloop çš„_commonModesä»¥åå°±ä¸å¯ä»¥è¢«åˆ é™¤äº†ï¼æ­¤æ—¶éœ€è¦åˆ›å»ºæ–°çš„ runloop å¯¹è±¡ï¼ŒæŠŠæ—§ runloop ä¸­éœ€è¦çš„ mode copy å‡ºæ¥ï¼Œæ”¾åœ¨æ–°çš„ runloop ä¸­CFRunLoopCopyCurrentMode/CFRunLoopCopyAllModes RunLoop ä¸­çš„sources å’Œ observersåœ¨ RunLoop å¯¹è±¡ç»“æ„ä¸­æœ‰ä¸ª Modeï¼Œæ˜¯ä¸ºäº†åœ¨æŸç§æ¨¡å¼ä¸‹ RunLoop æ‰ä¼šå¤„ç†ï¼Œå¯ä»¥å‡å°‘æ¯æ¬¡éœ€è¦ç›‘å¬çš„äº‹ä»¶æº Sources äº‹ä»¶æº Input Sourcessourceåˆ†ä¸ºä¸¤ç±»ï¼Œsource0å’Œsource1ã€‚source0åªå«æœ‰å›è°ƒæŒ‡é’ˆï¼Œå¤„ç†å¦‚UIEventï¼ŒCFSocketè¿™ç±»äº‹ä»¶ã€‚å®ƒåªèƒ½æ‰‹åŠ¨å”¤é†’ã€‚source1åˆ™æ˜¯æœ‰ä¸€ä¸ªmach portå’Œå›è°ƒæŒ‡é’ˆï¼Œèƒ½è¢«Machå†…æ ¸ä¼ é€’çš„ä¿¡æ¯å”¤é†’ã€‚è§¦æ‘¸äº‹ä»¶å…¶å®æ˜¯source1æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ååœ¨å›è°ƒ __IOHIDEventSystemClientQueueCallback__IOHIDEventSystemClientQueueCallback() å†…è§¦å‘çš„ Source0Source0 å†è§¦å‘çš„ _UIApplicationHandleEventQueue()è¾“å…¥æºï¼šå°†äº‹ä»¶ä»¥ asynchronous çš„æ–¹å¼å‘ thread å‘é€ eventè¾“å…¥æºPort-Based SourcesCustom Input Sourceså¯¹åº” mode ç»“æ„ä½“source1source0æ¶ˆæ¯ä»ä½•æ¥(å‘é€æ–¹)kernel çº¿ç¨‹å…¶ä»–ç”¨æˆ·threadç›‘å¬äº‹ä»¶Mach portsï¼ˆå†…æ ¸ portsï¼‰eventç”¨æˆ·è‡ªå®šä¹‰Input sources çš„eventæ·»åŠ æ–¹æ³•NSPort å¯¹è±¡CFRunLoopSourceRef Timer Sourcesæ—¶é—´æºï¼šåœ¨é¢„è®¾æ—¶é—´åä»¥åŒæ­¥çš„æ–¹å¼æŠŠ event ä¼ é€’ç»™ threadTimerï¼šæ˜¯çº¿ç¨‹é€šçŸ¥è‡ªå·±åšæŸäº‹çš„ä¸€ç§æ–¹å¼ Run Loop Observers è§‚å¯Ÿè€…ä¸åŒäº source åœ¨åŒæ­¥æˆ–å¼‚æ­¥äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘ï¼Œobserver ä¼šåœ¨ runloop è¿è¡ŒæœŸé—´çš„æŸäº›ç‰¹æ®Šåœ°æ–¹è§¦å‘ã€‚CFRunLoopObserverRefæ˜¯ runloop çŠ¶æ€çš„è§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬RunLoopæ‰€æœ‰çš„çŠ¶æ€æ”¹å˜ã€‚è¿›å…¥ run loopå½“ run loop å³å°†å¤„ç†ä¸€ä¸ª timerå½“ run loop å³å°†å¤„ç†ä¸€ä¸ª input sourceå½“ run loop å³å°†ä¼‘çœ å½“ run loop å·²ç»è¢«å”¤é†’ï¼Œä½†åœ¨å®ƒå¤„ç†å”¤é†’å®ƒçš„äº‹ä»¶ä¹‹å‰é€€å‡º run loopå¯¹åº” CFRunLoopActivity æšä¸¾12345678910111213141516typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123; // å³å°†è¿›å…¥Loop kCFRunLoopEntry = (1UL &lt;&lt; 0), // å³å°†å¤„ç†Timer kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1), // å³å°†å¤„ç†Source kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // å³å°†è¿›å…¥ä¼‘çœ  kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), // åˆšä»ä¼‘çœ ä¸­å”¤é†’ kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6), // å³å°†é€€å‡ºLoop kCFRunLoopExit = (1UL &lt;&lt; 7), // æ‰€æœ‰çŠ¶æ€ kCFRunLoopAllActivities = 0x0FFFFFFFU&#125;; RunLoop æ ¸å¿ƒå¯¹è±¡çš„æºç ç»“æ„RunLoop 123456789101112131415161718struct __CFRunLoop &#123; CFRuntimeBase _base; __CFPort _wakeUpPort; // used for CFRunLoopWakeUp Boolean _unused; volatile _per_run_data *_perRunData; // reset for runs of the run loop pthread_t _pthread; CFMutableSetRef _commonModes; CFMutableSetRef _commonModeItems; // CFSetAddValue(rl-&gt;_commonModeItems, rls); CFRunLoopSourceRef rlo // CFSetAddValue(rl-&gt;_commonModeItems, rlo); CFRunLoopObserverRef rlo CFRunLoopModeRef _currentMode; CFMutableSetRef _modes; struct _block_item *_blocks_head; struct _block_item *_blocks_tail; CFAbsoluteTime _runTime; CFAbsoluteTime _sleepTime; CFTypeRef _counterpart;&#125;; RunLoopMode 123456789101112131415161718192021struct __CFRunLoopMode &#123; CFStringRef _name; Boolean _stopped; CFMutableSetRef _sources0; CFMutableSetRef _sources1; CFMutableArrayRef _observers; CFMutableArrayRef _timers; CFMutableDictionaryRef _portToV1SourceMap; __CFPortSet _portSet; CFIndex _observerMask;#if USE_DISPATCH_SOURCE_FOR_TIMERS dispatch_source_t _timerSource; dispatch_queue_t _queue; Boolean _timerFired; // set to true by the source when a timer has fired Boolean _dispatchTimerArmed;#endif#if USE_MK_TIMER_TOO mach_port_t _timerPort; Boolean _mkTimerArmed;#endif&#125;; RunLoopSource 12345678910struct __CFRunLoopSource &#123; CFRuntimeBase _base; uint32_t _bits; CFIndex _order; /* immutable */ CFMutableBagRef _runLoops; union &#123; CFRunLoopSourceContext version0; /* immutable, except invalidation */ CFRunLoopSourceContext1 version1; /* immutable, except invalidation */ &#125; _context;&#125;; RunLoop Observers 123456789struct __CFRunLoopObserver &#123; CFRuntimeBase _base; CFRunLoopRef _runLoop; CFIndex _rlCount; CFOptionFlags _activities; /* immutable */ CFIndex _order; /* immutable */ CFRunLoopObserverCallBack _callout; /* immutable */ CFRunLoopObserverContext _context; /* immutable, except invalidation */&#125;; RunLoop Timer 12345678910111213struct __CFRunLoopTimer &#123; CFRuntimeBase _base; CFRunLoopRef _runLoop; CFMutableSetRef _rlModes; CFAbsoluteTime _nextFireDate; CFTimeInterval _interval; /* immutable */ CFTimeInterval _tolerance; /* mutable */ uint64_t _fireTSR; /* TSR units */ CFIndex _order; /* immutable */ CFRunLoopTimerCallBack _callout; /* immutable */ CFRunLoopTimerContext _context; /* immutable, except invalidation */&#125;; ä½¿ç”¨åˆ° RunLoop çš„ç›¸å…³å®è·µå…ˆåˆ†æä¸‹ç³»ç»Ÿä¸­éƒ½ä½¿ç”¨ runLoop åšäº†ä»€ä¹ˆ ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨ RunLoopapp è¿è¡Œæ—¶ï¼Œæ‰“å°CFRunLoop å†…éƒ¨æ · 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778CFRunLoop &#123; current mode = kCFRunLoopDefaultMode common modes = &#123; UITrackingRunLoopMode, kCFRunLoopDefaultMode &#125; common mode items = &#123; // source0 (manual) CFRunLoopSource &#123;order =-1, &#123;callout = _UIApplicationHandleEventQueue&#125;&#125; CFRunLoopSource &#123;order =-1, &#123;callout = PurpleEventSignalCallback &#125;&#125; CFRunLoopSource &#123;order = 0, &#123;callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125; // source1 (mach port) CFRunLoopSource &#123;order = 0, &#123;port = 17923&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 12039&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 16647&#125;&#125; CFRunLoopSource &#123;order =-1, &#123;callout = PurpleEventCallback&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 2407, callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 1c03, callout = __IOHIDEventSystemClientAvailabilityCallback&#125;&#125; CFRunLoopSource &#123;order = 0, &#123;port = 1b03, callout = __IOHIDEventSystemClientQueueCallback&#125;&#125; CFRunLoopSource &#123;order = 1, &#123;port = 1903, callout = __IOMIGMachPortPortCallback&#125;&#125; // Obvserver // Entry CFRunLoopObserver &#123;order = -2147483647, activities = 0x1, callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; // BeforeWaiting CFRunLoopObserver &#123;order = 0, activities = 0x20, callout = _UIGestureRecognizerUpdateObserver&#125; // BeforeWaiting | Exit CFRunLoopObserver &#123;order = 1999000, activities = 0xa0, callout = _afterCACommitHandler&#125; // BeforeWaiting | Exit CFRunLoopObserver &#123;order = 2000000, activities = 0xa0, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125; // BeforeWaiting | Exit CFRunLoopObserver &#123;order = 2147483647, activities = 0xa0, callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; // Timer CFRunLoopTimer &#123; firing = No, interval = 3.1536e+09, tolerance = 0, next fire date = 453098071 (-4421.76019 @ 96223387169499), callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)&#125; &#125;// end commons, modes ï¼ &#123; CFRunLoopMode &#123; sources0 = &#123; /* same as 'common mode items' */ &#125;, sources1 = &#123; /* same as 'common mode items' */ &#125;, observers = &#123; /* same as 'common mode items' */ &#125;, timers = &#123; /* same as 'common mode items' */ &#125;, &#125;, CFRunLoopMode &#123; sources0 = &#123; /* same as 'common mode items' */ &#125;, sources1 = &#123; /* same as 'common mode items' */ &#125;, observers = &#123; /* same as 'common mode items' */ &#125;, timers = &#123; /* same as 'common mode items' */ &#125;, &#125;, CFRunLoopMode &#123; sources0 = &#123; CFRunLoopSource &#123;order = 0, &#123; callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125; &#125;, sources1 = (null), observers = &#123; CFRunLoopObserver &gt;&#123;activities = 0xa0, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;)&#125;, timers = (null), &#125;, CFRunLoopMode &#123; sources0 = &#123; CFRunLoopSource &#123;order = -1, &#123; callout = PurpleEventSignalCallback&#125;&#125; &#125;, sources1 = &#123; CFRunLoopSource &#123;order = -1, &#123; callout = PurpleEventCallback&#125;&#125; &#125;, observers = (null), timers = (null), &#125;, CFRunLoopMode &#123; sources0 = (null), sources1 = (null), observers = (null), timers = (null), &#125; &#125;&#125; æ‰“å¼€ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode:Observerï¼š123//å†…å­˜ç®¡ç†ç›¸å…³ï¼š_wrapRunLoopWithAutoreleasePoolHandlerï¼š //AutoReleasePoolæœ€é«˜ä¼˜å…ˆçº§å¤„ç† (observer)_wrapRunLoopWithAutoreleasePoolHandlerï¼š //AutoReleasePoolæœ€ä½ä¼˜å…ˆçº§å¤„ç† (observer)123//ç•Œé¢åˆ·æ–°ç›¸å…³ï¼šafterCACommitHandlerï¼š //ç›‘å¬CATransactionï¼Œåˆ·æ–°UIï¼ˆobserverï¼‰, ä¼˜å…ˆçº§å¾ˆä½_beforeCACommitHandlerï¼š //ç›‘å¬CATransaction12//æ‰‹åŠ¿æ£€æµ‹å›è°ƒï¼šæ‰‹åŠ¿å˜åŒ–æ—¶éƒ½ä¼šè¢«è¿™ä¸ªè§‚å¯Ÿè€…æ•è·ã€‚mach_msg_trapçŠ¶æ€æ—¶ä¹Ÿéœ€è¦è¢«RunLoopå”¤é†’ä»¥åå¤„ç†ã€‚_UIGestureRecognizerUpdateObserverï¼š //ç›‘å¬CATransactionï¼Œåˆ·æ–°UIï¼ˆobserverï¼‰Sourceï¼š12_handleHIDEventFetcherDrainï¼š //é‡Šæ”¾IOHIDEventå¯¹è±¡çš„callbackï¼ˆsource0)ï¼Œæ‰€ä»¥æœ‰IOHIDEventäº‹ä»¶çš„ä½ç½®ï¼ˆé€šå¸¸æ˜¯å”¤é†’RunLoopçš„ä½ç½®ï¼‰éƒ½ä¼šæœ‰è¿™ä¸ªå›è°ƒæ–¹æ³•ã€‚_handleEventQueueï¼š //ç”¨æˆ·äº‹ä»¶å›è°ƒ(source0)ï¼Œä¸€èˆ¬çš„addTarget: action: forControlEvents:æ–¹æ³•éƒ½ä¼šåŠ åœ¨source0ï¼Œå¹¶ç”±_handleEventQueueæ‰§è¡Œã€‚ AutoreleasePoolæ ¹æ®ä¸Šè¿°åˆ†æï¼Œé€šè¿‡ RunLoop Observerï¼Œç›‘å¬ RunLoop çŠ¶æ€æ¥ç®¡ç† AutoreleasePoolçš„ã€‚è‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚ äº‹ä»¶å“åº”è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º __IOHIDEventSystemClientQueueCallback()ã€‚å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± IOKit.framework ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒè¿™é‡Œã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ _UIApplicationHandleEventQueue() è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚_UIApplicationHandleEventQueue() ä¼šæŠŠ IOHIDEvent å¤„ç†å¹¶åŒ…è£…æˆ UIEvent è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚ æ‰‹åŠ¿è¯†åˆ«å½“ä¸Šé¢çš„ _UIApplicationHandleEventQueue() è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin/Move/End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ _UIGestureRecognizerUpdateObserver()ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚ ç•Œé¢æ›´æ–°å½“åœ¨æ“ä½œ UI æ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº† Frameã€æ›´æ–°äº† UIView/CALayer çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•åï¼Œè¿™ä¸ª UIView/CALayer å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(å³å°†è¿›å…¥ä¼‘çœ ) å’Œ Exit (å³å°†é€€å‡ºLoop) äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView/CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚1234567891011_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv() QuartzCore:CA::Transaction::observer_callback: CA::Transaction::commit(); CA::Context::commit_transaction(); CA::Layer::layout_and_display_if_needed(); CA::Layer::layout_if_needed(); [CALayer layoutSublayers]; [UIView layoutSubviews]; CA::Layer::display_if_needed(); [CALayer display]; [UIView drawRect]; å®šæ—¶å™¨NSTimer å…¶å®å°±æ˜¯ CFRunLoopTimerRefï¼Œä»–ä»¬ä¹‹é—´æ˜¯ toll-free bridged çš„ã€‚ä¸€ä¸ª NSTimer æ³¨å†Œåˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚ä¾‹å¦‚ 10:00, 10:10, 10:20 è¿™å‡ ä¸ªæ—¶é—´ç‚¹ã€‚RunLoopä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ªTimerã€‚Timer æœ‰ä¸ªå±æ€§å«åš Tolerance (å®½å®¹åº¦)ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚å°±æ¯”å¦‚ç­‰å…¬äº¤ï¼Œå¦‚æœ 10:10 æ—¶æˆ‘å¿™ç€ç©æ‰‹æœºé”™è¿‡äº†é‚£ä¸ªç‚¹çš„å…¬äº¤ï¼Œé‚£æˆ‘åªèƒ½ç­‰ 10:20 è¿™ä¸€è¶Ÿäº†ã€‚CADisplayLink æ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡ä¸€è‡´çš„å®šæ—¶å™¨ï¼ˆä½†å®é™…å®ç°åŸç†æ›´å¤æ‚ï¼Œå’Œ NSTimer å¹¶ä¸ä¸€æ ·ï¼Œå…¶å†…éƒ¨å®é™…æ˜¯æ“ä½œäº†ä¸€ä¸ª Sourceï¼‰ã€‚å¦‚æœåœ¨ä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´æ‰§è¡Œäº†ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œé‚£å…¶ä¸­å°±ä¼šæœ‰ä¸€å¸§è¢«è·³è¿‡å»ï¼ˆå’Œ NSTimer ç›¸ä¼¼ï¼‰ï¼Œé€ æˆç•Œé¢å¡é¡¿çš„æ„Ÿè§‰ã€‚åœ¨å¿«é€Ÿæ»‘åŠ¨TableViewæ—¶ï¼Œå³ä½¿ä¸€å¸§çš„å¡é¡¿ä¹Ÿä¼šè®©ç”¨æˆ·æœ‰æ‰€å¯Ÿè§‰ã€‚Facebook å¼€æºçš„ AsyncDisplayLink å°±æ˜¯ä¸ºäº†è§£å†³ç•Œé¢å¡é¡¿çš„é—®é¢˜ï¼Œå…¶å†…éƒ¨ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œè¿™ä¸ªç¨åæˆ‘ä¼šå†å•ç‹¬å†™ä¸€é¡µåšå®¢æ¥åˆ†æã€‚ PerformSelecterå½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚ å…³äºGCDå®é™…ä¸Š RunLoop åº•å±‚ä¹Ÿä¼šç”¨åˆ° GCD çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ RunLoop æ˜¯ç”¨ dispatch_source_t å®ç°çš„ Timerï¼ˆè¯„è®ºä¸­æœ‰äººæé†’ï¼ŒNSTimer æ˜¯ç”¨äº† XNU å†…æ ¸çš„ mk_timerï¼Œæˆ‘ä¹Ÿä»”ç»†è°ƒè¯•äº†ä¸€ä¸‹ï¼Œå‘ç° NSTimer ç¡®å®æ˜¯ç”± mk_timer é©±åŠ¨ï¼Œè€Œé GCD é©±åŠ¨çš„ï¼‰ã€‚ä½†åŒæ—¶ GCD æä¾›çš„æŸäº›æ¥å£ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œ ä¾‹å¦‚ dispatch_async()ã€‚å½“è°ƒç”¨ dispatch_async(dispatch_get_main_queue(), block) æ—¶ï¼ŒlibDispatch ä¼šå‘ä¸»çº¿ç¨‹çš„ RunLoop å‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å–å¾—è¿™ä¸ª blockï¼Œå¹¶åœ¨å›è°ƒ CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE() é‡Œæ‰§è¡Œè¿™ä¸ª blockã€‚ä½†è¿™ä¸ªé€»è¾‘ä»…é™äº dispatch åˆ°ä¸»çº¿ç¨‹ï¼Œdispatch åˆ°å…¶ä»–çº¿ç¨‹ä»ç„¶æ˜¯ç”± libDispatch å¤„ç†çš„ã€‚ å…³äºç½‘ç»œè¯·æ±‚iOS ä¸­ï¼Œå…³äºç½‘ç»œè¯·æ±‚çš„æ¥å£è‡ªä¸‹è‡³ä¸Šæœ‰å¦‚ä¸‹å‡ å±‚:1234CFSocketCFNetwork -&gt;ASIHttpRequestNSURLConnection -&gt;AFNetworkingNSURLSession -&gt;AFNetworking2, Alamofireâ€¢ CFSocket æ˜¯æœ€åº•å±‚çš„æ¥å£ï¼Œåªè´Ÿè´£ socket é€šä¿¡ã€‚â€¢ CFNetwork æ˜¯åŸºäº CFSocket ç­‰æ¥å£çš„ä¸Šå±‚å°è£…ï¼ŒASIHttpRequest å·¥ä½œäºè¿™ä¸€å±‚ã€‚â€¢ NSURLConnection æ˜¯åŸºäº CFNetwork çš„æ›´é«˜å±‚çš„å°è£…ï¼Œæä¾›é¢å‘å¯¹è±¡çš„æ¥å£ï¼ŒAFNetworking å·¥ä½œäºè¿™ä¸€å±‚ã€‚â€¢ NSURLSession æ˜¯ iOS7 ä¸­æ–°å¢çš„æ¥å£ï¼Œè¡¨é¢ä¸Šæ˜¯å’Œ NSURLConnection å¹¶åˆ—çš„ï¼Œä½†åº•å±‚ä»ç„¶ç”¨åˆ°äº† NSURLConnection çš„éƒ¨åˆ†åŠŸèƒ½ (æ¯”å¦‚ com.apple.NSURLConnectionLoader çº¿ç¨‹)ï¼ŒAFNetworking2 å’Œ Alamofire å·¥ä½œäºè¿™ä¸€å±‚ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹ NSURLConnection çš„å·¥ä½œè¿‡ç¨‹ã€‚é€šå¸¸ä½¿ç”¨ NSURLConnection æ—¶ï¼Œä½ ä¼šä¼ å…¥ä¸€ä¸ª Delegateï¼Œå½“è°ƒç”¨äº† [connection start] åï¼Œè¿™ä¸ª Delegate å°±ä¼šä¸åœæ”¶åˆ°äº‹ä»¶å›è°ƒã€‚å®é™…ä¸Šï¼Œstart è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šä¼šè·å– CurrentRunLoopï¼Œç„¶ååœ¨å…¶ä¸­çš„ DefaultMode æ·»åŠ äº†4ä¸ª Source0 (å³éœ€è¦æ‰‹åŠ¨è§¦å‘çš„Source)ã€‚CFMultiplexerSource æ˜¯è´Ÿè´£å„ç§ Delegate å›è°ƒçš„ï¼ŒCFHTTPCookieStorage æ˜¯å¤„ç†å„ç§ Cookie çš„ã€‚å½“å¼€å§‹ç½‘ç»œä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NSURLConnection åˆ›å»ºäº†ä¸¤ä¸ªæ–°çº¿ç¨‹ï¼šcom.apple.NSURLConnectionLoader å’Œ com.apple.CFSocket.privateã€‚å…¶ä¸­ CFSocket çº¿ç¨‹æ˜¯å¤„ç†åº•å±‚ socket è¿æ¥çš„ã€‚NSURLConnectionLoader è¿™ä¸ªçº¿ç¨‹å†…éƒ¨ä¼šä½¿ç”¨ RunLoop æ¥æ¥æ”¶åº•å±‚ socket çš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡ä¹‹å‰æ·»åŠ çš„ Source0 é€šçŸ¥åˆ°ä¸Šå±‚çš„ Delegateã€‚NSURLConnectionLoader ä¸­çš„ RunLoop é€šè¿‡ä¸€äº›åŸºäº mach port çš„ Source æ¥æ”¶æ¥è‡ªåº•å±‚ CFSocket çš„é€šçŸ¥ã€‚å½“æ”¶åˆ°é€šçŸ¥åï¼Œå…¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºå‘ CFMultiplexerSource ç­‰ Source0 å‘é€é€šçŸ¥ï¼ŒåŒæ—¶å”¤é†’ Delegate çº¿ç¨‹çš„ RunLoop æ¥è®©å…¶å¤„ç†è¿™äº›é€šçŸ¥ã€‚CFMultiplexerSource ä¼šåœ¨ Delegate çº¿ç¨‹çš„ RunLoop å¯¹ Delegate æ‰§è¡Œå®é™…çš„å›è°ƒã€‚ å¼•ç”¨Threading Programming Guide â€“ Run LoopsCFRunLoopAddCommonModeæ·±å…¥ç†è§£RunLoop æœ¬æ–‡å®ä¾‹ä½¿ç”¨åˆ° RunLoop çš„ç›¸å…³å®è·µ å¤§é‡å‚è€ƒè¯¥æ–‡ç« ï¼Œæ•¬ä½©~Event loopåç«¯eventloopEvent-driven programmingThreading Programming Guide(2)","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"runloop","slug":"iOS-Programming/runloop","permalink":"https://changzw.github.io/categories/iOS-Programming/runloop/"}]},{"title":"Method Swizzling","date":"2017-08-01T04:23:17.000Z","path":"2017/08/01/deep analyse/Method-Swizzling/","text":"Method swizzling çš„ä½œç”¨ä»–æ˜¯ä¸€ç§ äº¤æ¢æŒ‡é’ˆæŒ‡å‘ çš„æŠ€æœ¯Method swizzling ç”¨äºæ”¹å˜ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ selector çš„å®ç°ã€‚åœ¨è¿è¡Œæ—¶é€šè¿‡æ”¹å˜ selector åœ¨ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä¸­çš„æ˜ å°„ä»è€Œæ”¹å˜åŸæœ‰æ–¹æ³•ã€‚ä¾‹å¦‚ï¼šåœ¨ app ä¸­è¿½è¸ªæ¯ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨è¢«ç”¨æˆ·å‘ˆç°äº†å‡ æ¬¡ï¼šé€šè¿‡åœ¨ viewDidAppear: æ–¹æ³•ä¸­æ·»åŠ è¿½è¸ªä»£ç æ¥å®ç°ï¼Œä½†ä¼šæœ‰å¤§é‡é‡å¤ä»£ç ã€‚ç»§æ‰¿æ˜¯å¦ä¸€ç§å¯è¡Œçš„æ–¹å¼ï¼Œä½†æ˜¯è¿™è¦æ±‚æ‰€æœ‰è¢«ç»§æ‰¿çš„è§†å›¾æ§åˆ¶å™¨å¦‚ UIViewController, UITableViewController, UINavigationController éƒ½åœ¨ viewDidAppearï¼šå®ç°è¿½è¸ªä»£ç ï¼Œè¿™åŒæ ·ä¼šé€ æˆå¾ˆå¤šé‡å¤ä»£ç ã€‚è¿™é‡Œæœ‰å¦å¤–ä¸€ç§å¯è¡Œçš„æ–¹å¼ï¼šä» category å®ç° method swizzling ã€‚ä¸‹é¢æ˜¯å®ç°æ–¹å¼ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142#import &lt;objc/runtime.h&gt;@implementation UIViewController (Tracking)+ (void)load &#123; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; Class class = [self class];// 1. å¾—åˆ°æ–¹æ³•åç§° selector SEL originalSelector = @selector(viewWillAppear:); SEL swizzledSelector = @selector(xxx_viewWillAppear:);// 2. å¾—åˆ°æ–¹æ³•ç±»å‹ï¼ˆæ–¹æ³•ç­¾åï¼‰ Method originalMethod = class_getInstanceMethod(class, originalSelector); Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector); // When swizzling a class method, use the following: // Class class = object_getClass((id)self); // ... // Method originalMethod = class_getClassMethod(class, originalSelector); // Method swizzledMethod = class_getClassMethod(class, swizzledSelector);// 3. ç»™ originalSelector æ·»åŠ æ–°methodçš„å®ç°å’Œå‚æ•°ç±»ï¼Œå¦‚æœoriginSelåœ¨ cls ä¸­æ²¡æœ‰å®ç°ä½“ï¼Œé‚£ä¹ˆä¼šæ·»åŠ å„ä¸€ä¸ªå®ç°ä½“ï¼Œå¹¶return YESï¼Œå¦‚æœå·²ç»æœ‰å®ç°ä½“ return NO BOOL didAddMethod = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); if (didAddMethod) &#123; // 4. æ›¿æ¢ class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); &#125; else &#123; method_exchangeImplementations(originalMethod, swizzledMethod); &#125; &#125;);&#125;#pragma mark - Method Swizzling- (void)xxx_viewWillAppear:(BOOL)animated &#123; [self xxx_viewWillAppear:animated]; // viewWillAppear NSLog(@\"viewWillAppear: %@\", self);&#125;@endclass_addMethod ã€‚è¦å…ˆå°è¯•æ·»åŠ  originSel æ˜¯ä¸ºäº†åšä¸€å±‚ä¿æŠ¤ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªç±»æ²¡æœ‰å®ç° originSel ï¼Œä½†å…¶çˆ¶ç±»å®ç°äº†ï¼Œé‚£ class_getInstanceMethod ä¼šè¿”å›çˆ¶ç±»çš„æ–¹æ³•ã€‚è¿™æ · method_exchangeImplementations æ›¿æ¢çš„æ˜¯çˆ¶ç±»çš„é‚£ä¸ªæ–¹æ³•ã€‚æ‰€ä»¥å…ˆå°è¯•æ·»åŠ  originSelï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œå†ç”¨ method_exchangeImplementations æŠŠåŸæ–¹æ³•çš„å®ç°è·Ÿæ–°çš„æ–¹æ³•å®ç°ç»™äº¤æ¢æ‰ã€‚è¿‡ç¨‹å˜åŒ–å›¾ åº”è¯¥åœ¨å“ªäº›åœ°æ–¹ä½¿ç”¨ method swizzling swizzling åº”è¯¥åªåœ¨ +load ä¸­åœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ªç±»æœ‰ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚+load æ˜¯åœ¨ä¸€ä¸ªç±»è¢«åˆå§‹è£…è½½æ—¶è°ƒç”¨ï¼Œ[åªä¼šè°ƒç”¨ä¸€æ¬¡]+initialize æ˜¯åœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•å‰è°ƒç”¨çš„ã€‚[å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡]ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ–¹æ³•è¢«å®ç°çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è°ƒç”¨ã€‚ dispatch_onceswizzling åº”è¯¥åªåœ¨ dispatch_once ä¸­å®Œæˆã€‚swizzling æ”¹å˜äº†å…¨å±€çš„çŠ¶æ€ç¡®ä¿ä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚Grand Central Dispatch çš„ dispatch_once æä¾›åŸå­æ€§ Selectors, Methods, &amp; Implementationsåœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œselectors, methods, implementations æŒ‡ä»£äº†ä¸åŒæ¦‚å¿µï¼Œç„¶è€Œæˆ‘ä»¬é€šå¸¸ä¼šè¯´åœ¨æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸‰ä¸ªæ¦‚å¿µæ˜¯å¯ä»¥ç›¸äº’è½¬æ¢çš„ã€‚ ä¸‹é¢æ˜¯è‹¹æœ Objective-C Runtime Referenceä¸­çš„æè¿°ï¼šSelectorï¼ˆtypedef struct objc_selector *SELï¼‰:åœ¨è¿è¡Œæ—¶ Selectors ç”¨æ¥ä»£è¡¨ä¸€ä¸ªæ–¹æ³•çš„åå­—ã€‚Selector æ˜¯ä¸€ä¸ªåœ¨è¿è¡Œæ—¶è¢«æ³¨å†Œï¼ˆæˆ–æ˜ å°„ï¼‰çš„Cç±»å‹å­—ç¬¦ä¸²ã€‚Selectorç”±ç¼–è¯‘å™¨äº§ç”Ÿå¹¶ä¸”åœ¨å½“ç±»è¢«åŠ è½½è¿›å†…å­˜æ—¶ç”±è¿è¡Œæ—¶è‡ªåŠ¨è¿›è¡Œåå­—å’Œå®ç°çš„æ˜ å°„ã€‚Methodï¼ˆtypedef struct objc_method *Methodï¼‰:æ–¹æ³•æ˜¯ä¸€ä¸ªä¸é€æ˜çš„ç”¨æ¥ä»£è¡¨ä¸€ä¸ªæ–¹æ³•çš„å®šä¹‰çš„ç±»å‹ã€‚123456// Method ç»“æ„struct method_t &#123; SEL name; const char *types; MethodListIMP imp;&#125;;Implementationï¼ˆtypedef id (*IMP)(id, SEL,...)ï¼‰:è¿™ä¸ªæ•°æ®ç±»å‹æŒ‡å‘ä¸€ä¸ªæ–¹æ³•çš„å®ç°çš„æœ€å¼€å§‹çš„åœ°æ–¹ã€‚è¯¥æ–¹æ³•ä¸ºå½“å‰CPUæ¶æ„ä½¿ç”¨æ ‡å‡†çš„Cæ–¹æ³•è°ƒç”¨æ¥å®ç°ã€‚è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘è°ƒç”¨æ–¹æ³•çš„è‡ªèº«ï¼ˆå³å†…å­˜ä¸­ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè‹¥æ˜¯è°ƒç”¨ç±»æ–¹æ³•ï¼Œè¯¥æŒ‡é’ˆåˆ™æ˜¯æŒ‡å‘å…ƒç±»å¯¹è±¡ metaclass ï¼‰ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿™ä¸ªæ–¹æ³•çš„åå­— selectorï¼Œè¯¥æ–¹æ³•çš„çœŸæ­£å‚æ•°ç´§éšå…¶åã€‚ç†è§£ selector, method, implementation è¿™ä¸‰ä¸ªæ¦‚å¿µä¹‹é—´å…³ç³»çš„æœ€å¥½æ–¹å¼æ˜¯ï¼šåœ¨è¿è¡Œæ—¶ï¼Œç±»ï¼ˆClassï¼‰ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯åˆ†å‘åˆ—è¡¨æ¥è§£å†³æ¶ˆæ¯çš„æ­£ç¡®å‘é€ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨çš„å…¥å£æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ˆMethodï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•æ˜ å°„äº†ä¸€å¯¹é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å€¼æ˜¯è¿™ä¸ªæ–¹æ³•çš„åå­— selectorï¼ˆSELï¼‰ï¼Œå€¼æ˜¯æŒ‡å‘è¿™ä¸ªæ–¹æ³•å®ç°çš„å‡½æ•°æŒ‡é’ˆ implementationï¼ˆIMPï¼‰ã€‚ Method swizzling ä¿®æ”¹äº†ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä½¿å¾—å·²ç»å­˜åœ¨çš„ selector æ˜ å°„äº†å¦ä¸€ä¸ªå®ç° implementationï¼ŒåŒæ—¶é‡å‘½åäº†åŸç”Ÿæ–¹æ³•çš„å®ç°ä¸ºä¸€ä¸ªæ–°çš„ selectorã€‚ è°ƒç”¨ _cmdä¸‹é¢ä»£ç åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šå‡ºç°å¾ªç¯ï¼š1234- (void)xxx_viewWillAppear:(BOOL)animated &#123; [self xxx_viewWillAppear:animated]; NSLog(@\"viewWillAppear: %@\", NSStringFromClass([self class]));&#125;ç„¶è€Œåœ¨äº¤æ¢äº†æ–¹æ³•å®ç°åå°±ä¸ä¼šå‡ºç°å¾ªç¯äº†ã€‚å¥½çš„ç¨‹åºå‘˜åº”è¯¥å¯¹è¿™é‡Œå‡ºç°çš„æ–¹æ³•çš„é€’å½’è°ƒç”¨æœ‰æ‰€è­¦è§‰ï¼Œè¿™é‡Œæˆ‘ä»¬åº”è¯¥ç†æ¸…åœ¨ method swizzling åæ–¹æ³•çš„å®ç°ç©¶ç«Ÿå˜æˆäº†ä»€ä¹ˆã€‚åœ¨äº¤æ¢äº†æ–¹æ³•çš„å®ç°åï¼Œxxx_viewWillAppear:æ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºäº† UIViewController -viewWillAppearï¼šçš„åŸç”Ÿå®ç°ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯åœ¨é€’å½’è°ƒç”¨ã€‚ç”±äº xxx_viewWillAppear: è¿™ä¸ªæ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºäº† viewWillAppear: çš„å®ç°ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†è°ƒç”¨ viewWillAppear: æ—¶ä¾¿ä¼šé€ æˆé€’å½’å¾ªç¯ã€‚è®°ä½ç»™éœ€è¦è½¬æ¢çš„æ‰€æœ‰æ–¹æ³•åŠ ä¸ªå‰ç¼€ä»¥åŒºåˆ«åŸç”Ÿæ–¹æ³•ã€‚ æ¶‰åŠ runtime æ–¹æ³•é€šè¿‡ SEL è·å–ä¸€ä¸ªæ–¹æ³• MethodMethod class_getInstanceMethod(Class cls, SEL name);é€šè¿‡ Method è·å–è¯¥æ–¹æ³•çš„å®ç° IMPIMP method_getImplementation(Method m);è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæè¿°äº†æ–¹æ³•çš„å‚æ•°å’Œè¿”å›ç±»å‹const char * method_getTypeEncoding(Method m);é€šè¿‡ SEL ä»¥åŠ IMP ç»™ä¸€ä¸ªç±»æ·»åŠ æ–°çš„æ–¹æ³• Methodï¼Œå…¶ä¸­ types å°±æ˜¯ method_getTypeEncoding çš„è¿”å›å€¼ã€‚BOOL class_addMethod(Class cls, SEL name, IMP imp, const char *types);å½“ cls ä¸­æœ‰ name æ–¹æ³•å®ç°ï¼Œæ·»åŠ method return NOå½“ cls ä¸­æ²¡æœ‰ name æ–¹æ³•ï¼Œåˆ™æ·»åŠ æ–¹æ³•å®ç° return YESé€šè¿‡ç»™å®šçš„ SEL æ›¿æ¢åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•çš„å®ç° IMPï¼Œå…¶ä¸­ SEL æ˜¯æƒ³è¦æ›¿æ¢çš„ selector åï¼ŒIMP æ˜¯æ›¿æ¢åçš„å®ç°ã€‚IMP class_replaceMethod(Class cls, SEL name, IMP imp, const char *types);äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç° IMPvoid method_exchangeImplementations(Method m1, Method m2); æ€è€ƒå¾ˆå¤šäººè®¤ä¸ºäº¤æ¢æ–¹æ³•å®ç°ä¼šå¸¦æ¥æ— æ³•é¢„æ–™çš„ç»“æœã€‚ç„¶è€Œé‡‡å–äº†ä»¥ä¸‹é¢„é˜²æªæ–½å, method swizzling ä¼šå˜å¾—å¾ˆå¯é ï¼šåœ¨äº¤æ¢æ–¹æ³•å®ç°åè®°å¾—è¦è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°ï¼ˆé™¤éä½ éå¸¸ç¡®å®šå¯ä»¥ä¸ç”¨è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°ï¼‰ï¼šAPIs æä¾›äº†è¾“å…¥è¾“å‡ºçš„è§„åˆ™ï¼Œè€Œåœ¨è¾“å…¥è¾“å‡ºä¸­é—´çš„æ–¹æ³•å®ç°å°±æ˜¯ä¸€ä¸ªçœ‹ä¸è§çš„é»‘ç›’ã€‚äº¤æ¢äº†æ–¹æ³•å®ç°å¹¶ä¸”ä¸€äº›å›è°ƒæ–¹æ³•ä¸ä¼šè°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°è¿™å¯èƒ½ä¼šé€ æˆåº•å±‚å®ç°çš„å´©æºƒã€‚é¿å…å†²çªï¼šä¸ºåˆ†ç±»çš„æ–¹æ³•åŠ å‰ç¼€ï¼Œä¸€å®šè¦ç¡®ä¿è°ƒç”¨äº†åŸç”Ÿæ–¹æ³•çš„æ‰€æœ‰åœ°æ–¹ä¸ä¼šå› ä¸ºä½ äº¤æ¢äº†æ–¹æ³•çš„å®ç°è€Œå‡ºç°æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚ç†è§£å®ç°åŸç†ï¼šåªæ˜¯ç®€å•çš„æ‹·è´ç²˜è´´äº¤æ¢æ–¹æ³•å®ç°çš„ä»£ç è€Œä¸å»ç†è§£å®ç°åŸç†ä¸ä»…ä¼šè®© App å¾ˆè„†å¼±ï¼Œå¹¶ä¸”æµªè´¹äº†å­¦ä¹  Objective-C è¿è¡Œæ—¶çš„æœºä¼šã€‚é˜…è¯» Objective-C Runtime Reference å¹¶ä¸”æµè§ˆ &lt;obje/runtime.h&gt; èƒ½å¤Ÿè®©ä½ æ›´å¥½ç†è§£å®ç°åŸç†ã€‚æŒç»­çš„é¢„é˜²ï¼šä¸ç®¡ä½ å¯¹ä½ ç†è§£ swlzzling æ¡†æ¶ï¼ŒUIKit æˆ–è€…å…¶ä»–å†…åµŒæ¡†æ¶æœ‰å¤šè‡ªä¿¡ï¼Œä¸€å®šè¦è®°ä½æ‰€æœ‰ä¸œè¥¿åœ¨ä¸‹ä¸€ä¸ªå‘è¡Œç‰ˆæœ¬éƒ½å¯èƒ½å˜å¾—ä¸å†å¥½ä½¿ã€‚åšå¥½å‡†å¤‡ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªé»‘é­”æ³•ä¸­èµ°å¾—æ›´è¿œï¼Œä¸è¦è®©ç¨‹åºåè€Œå‡ºç°ä¸å¯æ€è®®çš„è¡Œä¸ºã€‚ swift ä¸­å¦‚ä½• swizzleç›®å‰ swift çš„ç‰ˆæœ¬å·²ç»ä¸å…è®¸ä½¿ç”¨ load å’Œ initialize æ–¹æ³•ä¹Ÿæ²¡æœ‰äº† dispatch_once æ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®ä¿ swizzle åªæ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿå¼•ç”¨ Method Swizzling","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"åº•å±‚","slug":"åº•å±‚","permalink":"https://changzw.github.io/tags/%E5%BA%95%E5%B1%82/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"objc","slug":"iOS-Programming/objc","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/"},{"name":"runtime","slug":"iOS-Programming/objc/runtime","permalink":"https://changzw.github.io/categories/iOS-Programming/objc/runtime/"}]},{"title":"CollectionView ä½¿ç”¨","date":"2017-06-15T02:41:33.000Z","path":"2017/06/15/UI ç›¸å…³/CollectionView-ä½¿ç”¨/","text":"åŸºæœ¬å®ç°æ³¨æ„ç‚¹CollectionView åœ¨å‘ˆç°çš„æ•°æ®å’Œç”¨äºå‘ˆç°è¯¥æ•°æ®çš„è§†è§‰å…ƒç´ ä¹‹é—´ä¿æŒä¸¥æ ¼çš„åŒºåˆ†ï¼ˆview + layoutï¼‰ã€‚åŸºæœ¬ä½¿ç”¨çš„è¿‡ç¨‹ï¼šè‡ªå·±çš„å¸ƒå±€å¯¹è±¡ï¼šå­ç±»åŒ– layoutè‡ªå®šä¹‰ collectionView ä¸­çš„ itemï¼ˆcellï¼Œsupplementary views å’Œ decoration viewsï¼‰åœ¨layout çš„ prepare æ–¹æ³•ä¸­è®¡ç®—å‡ºæ‰€æœ‰ attributeï¼ˆç”¨æ¥ä¿®é¥° cellï¼Œsupplementary views å’Œ decoration viewsï¼‰å¹¶ç¼“å­˜åœ¨ layout å¯¹è±¡ä¸­æ¯ä¸ª attribute çš„indexPathï¼Œframeï¼ŒzIndex â€¦â€¦æ ¹æ® attribute è®¡ç®—å‡º collectionViewContentSizeè®¡ç®— attribute çš„æ•°æ®å¯ä»¥ç»™ layout è‡ªå®šä¹‰ä¸€ä¸ª delegate åè®®ï¼Œè®©ä»–å»å‘ collectionView æ‹¿layoutAttributesForElementsInRect è·å–è§†å›¾çš„å¯è§çŸ©å½¢åŒºåŸŸä¸­çš„æ‰€æœ‰ UICollectionViewLayoutAttributesï¼Œç±»ä¼¼å®ç° layoutAttributesForItem:atIndexPathï¼Œ layoutAttributesForSupplementaryViewOfKind:atIndexPath ï¼ŒlayoutAttributesForDecorationViewOfKind:atIndexPath1234567891011121314// å¯ä»¥ä½¿ç”¨ binaryTree ç®—æ³•ï¼Œå°†å¤æ‚åº¦é™åˆ° O(log(n))override func layoutAttributesForElements(in rect: CGRect) -&gt; [UICollectionViewLayoutAttributes]? &#123; var visibleLayoutAttributes: [UICollectionViewLayoutAttributes] = [] for attributes in cache &#123; if attributes.frame.intersects(rect) &#123; visibleLayoutAttributes.append(attributes) &#125; &#125; return visibleLayoutAttributes&#125;override func layoutAttributesForItem(at indexPath: IndexPath) -&gt; UICollectionViewLayoutAttributes? &#123; return cache[indexPath.item]&#125;æ˜¯å¦åˆ·æ–°é¡µé¢å½“ collection view çš„ bounds æ”¹å˜æ—¶ï¼Œå¸ƒå±€éœ€è¦å‘Šè¯‰ collection view æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å¸ƒå±€ã€‚æˆ‘çš„çŒœæƒ³æ˜¯ï¼šå½“ collection view æ”¹å˜å¤§å°æ—¶ï¼Œå¤§å¤šæ•°å¸ƒå±€ä¼šè¢«ä½œåºŸï¼Œæ¯”å¦‚è®¾å¤‡æ—‹è½¬çš„æ—¶å€™ã€‚å› æ­¤ï¼Œä¸€ä¸ªå¹¼ç¨šçš„å®ç°å¯èƒ½åªä¼šç®€å•çš„è¿”å› YESã€‚è™½ç„¶å®ç°åŠŸèƒ½å¾ˆé‡è¦ï¼Œä½†æ˜¯ scroll view çš„ bounds åœ¨æ»šåŠ¨æ—¶ä¹Ÿä¼šæ”¹å˜ï¼Œè¿™æ„å‘³ç€ä½ çš„å¸ƒå±€æ¯ç§’ä¼šè¢«ä¸¢å¼ƒå¤šæ¬¡ã€‚æ ¹æ®è®¡ç®—çš„å¤æ‚æ€§åˆ¤æ–­ï¼Œè¿™å°†ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚å½“ collection view çš„å®½åº¦æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€å¿…é¡»è¢«ä¸¢å¼ƒï¼Œä½†è¿™æ»šåŠ¨å¹¶ä¸ä¼šå½±å“åˆ°å¸ƒå±€ã€‚å¹¸è¿çš„æ˜¯ï¼Œcollection view å°†å®ƒçš„æ–° bounds ä¼ ç»™ shouldInvalidateLayoutForBoundsChange: æ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿èƒ½æ¯”è¾ƒè§†å›¾å½“å‰çš„bounds å’Œæ–°çš„ bounds æ¥ç¡®å®šè¿”å›å€¼ï¼š12345678override func shouldInvalidateLayout(forBoundsChange newBounds: CGRect) -&gt; Bool &#123; let oldBounds = collectionView?.bounds if newBounds.width != oldBounds?.width &#123; return true &#125;else &#123; return false &#125;&#125; åˆ†æ UICollectionView.h ä¸­çš„ç±»ç»“æ„12345678@class UICollectionView, UICollectionReusableView, UICollectionViewCell, UICollectionViewLayout, UICollectionViewTransitionLayout, UICollectionViewLayoutAttributes, UITouch, UINib;@class UIDragItem, UIDragPreviewParameters, UIDragPreviewTarget;@class UICollectionViewDropProposal, UICollectionViewPlaceholder, UICollectionViewDropPlaceholder;@class UIContextMenuConfiguration, UITargetedPreview;@protocol UIContextMenuInteractionCommitAnimating;@protocol UIDataSourceTranslating, UISpringLoadedInteractionContext;@protocol UIDragSession, UIDropSession;@protocol UICollectionViewDragDelegate, UICollectionViewDropDelegate, UICollectionViewDropCoordinator, UICollectionViewDropItem, UICollectionViewDropPlaceholderContext;å¼•ç”¨ï¼šè‡ªå®šä¹‰ Collection View å¸ƒå±€","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"c å¯å˜å‚æ•°å®æ•´ç†","date":"2017-06-01T10:47:00.000Z","path":"2017/06/01/c-å®æ•´ç†/","text":"#ã€##ã€__VA_ARGS__å’Œ##__VA_ARGS__çš„ä½œç”¨ #ç”¨æ¥æŠŠå‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²å®ä¾‹1123456789#define P(A) printf(\"%s:%d\\n\",#A,A);int main(int argc, char **argv)&#123; int a = 1, b = 2; P(a); P(b); P(a+b); system(\"pause\"); &#125;è¾“å‡ºä¸ºï¼š123a:1b:2a+b:3å®ä¾‹212#define SQUARE(x) printf(\"The square of \"#x\" is %d.\\n\", ((x)*(x)));SQUARE(8)è¾“å‡ºçš„æ˜¯ï¼šThe square of 8 is 64 ##è¿ç®—ç¬¦å¯ä»¥ç”¨äºå®å‡½æ•°çš„æ›¿æ¢éƒ¨åˆ†è¿™ä¸ªè¿ç®—ç¬¦æŠŠä¸¤ä¸ªè¯­è¨€ç¬¦å·ç»„åˆæˆå•ä¸ªè¯­è¨€ç¬¦å·ï¼Œä¸ºå®æ‰©å±•æä¾›äº†ä¸€ç§è¿æ¥å®é™…å˜å…ƒçš„æ‰‹æ®µå®ä¾‹11#define XNAME(n) x ## nå¦‚æœè¿™æ ·ä½¿ç”¨å®ï¼šXNAME(8)åˆ™ä¼šè¢«å±•å¼€æˆè¿™æ ·ï¼šx8##å°±æ˜¯ä¸ªç²˜åˆå‰‚ï¼Œå°†å‰åä¸¤éƒ¨åˆ†ç²˜åˆèµ·æ¥ï¼Œä¹Ÿå°±æ˜¯æœ‰â€œå­—ç¬¦åŒ–â€çš„æ„æ€ã€‚ä½†æ˜¯â€œ##â€ä¸èƒ½éšæ„ç²˜åˆä»»æ„å­—ç¬¦ï¼Œå¿…é¡»æ˜¯åˆæ³•çš„Cè¯­è¨€æ ‡ç¤ºç¬¦ã€‚åœ¨å•ä¸€çš„å®å®šä¹‰ä¸­ï¼Œæœ€å¤šå¯ä»¥å‡ºç°ä¸€æ¬¡â€œ#â€æˆ–â€œ##â€é¢„å¤„ç†æ“ä½œç¬¦ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šä¸â€œ#â€æˆ–â€œ##â€é¢„å¤„ç†æ“ä½œç¬¦ç›¸å…³çš„è®¡ç®—æ¬¡åºï¼Œåˆ™ä¼šäº§ç”Ÿé—®é¢˜ã€‚ä¸ºé¿å…è¯¥é—®é¢˜ï¼Œåœ¨å•ä¸€çš„å®å®šä¹‰ä¸­åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§æ“ä½œç¬¦(å³ï¼Œä¸€ä»½â€œ#â€æˆ–ä¸€ä¸ªâ€œ##â€ï¼Œæˆ–éƒ½ä¸ç”¨)ã€‚é™¤ééå¸¸æœ‰å¿…è¦ï¼Œå¦åˆ™å°½é‡ä¸è¦ä½¿ç”¨â€œ#â€å’Œâ€œ##â€ã€‚ __VA_ARGS__ æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°çš„å®è¿™ä¸ªå¯å˜å‚æ•°çš„å®æ˜¯æ–°çš„C99è§„èŒƒä¸­æ–°å¢çš„ï¼Œç›®å‰ä¼¼ä¹åªæœ‰gccæ”¯æŒï¼ˆVC6.0çš„ç¼–è¯‘å™¨ä¸æ”¯æŒï¼‰ã€‚å®ç°æ€æƒ³å°±æ˜¯å®å®šä¹‰ä¸­å‚æ•°åˆ—è¡¨çš„æœ€åä¸€ä¸ªå‚æ•°ä¸ºçœç•¥å·ï¼ˆä¹Ÿå°±æ˜¯ä¸‰ä¸ªç‚¹ï¼‰ã€‚ ##__VA_ARGS__å®å‰é¢åŠ ä¸Š##çš„ä½œç”¨åœ¨äºï¼Œå½“å¯å˜å‚æ•°çš„ä¸ªæ•°ä¸º0æ—¶ï¼Œè¿™é‡Œçš„##èµ·åˆ°æŠŠå‰é¢å¤šä½™çš„&quot;,&quot;å»æ‰çš„ä½œç”¨,å¦åˆ™ä¼šç¼–è¯‘å‡ºé”™ä¸€èˆ¬è¿™ä¸ªç”¨åœ¨è°ƒè¯•ä¿¡æ¯ä¸Šå¤šä¸€ç‚¹ä¾‹å¦‚ï¼š1234567891011121314151617#define my_print1(...) printf(\\_\\_VA_ARGS__)my_print1(\"i=%d,j=%d\\n\",i,j) æ­£ç¡®æ‰“å°#define my_print2(fmt,...) printf(fmt, \\_\\_VA_ARGS__) my_print1(\"i=%d,j=%d\\n\",i,j) æ­£ç¡®æ‰“å°my_print1(\"iiiiiii\\n\") ç¼–è¯‘å¤±è´¥æ‰“å°ï¼Œå› ä¸ºæ‰©å±•å‡ºæ¥åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œè‡³å°‘è¦ä¸¤ä¸ªåŠä»¥ä¸Šå‚æ•°``` å¦‚æœæ˜¯#define my_print2(fmt,...) printf(fmt,##\\_\\_VA_ARGS__) é‚£ä¹ˆ my_print1 é‡Œé¢ä¸ç®¡æ˜¯å‡ ä¸ªå‚æ•°éƒ½èƒ½æ­£ç¡®æ‰“å°```c#define MODULE_NAME \"MY_LIB\"#define error_print(fmt, ...) printf(\"[ERROR][\"MODULE_NAME\"](%s|%d)\" fmt, __func__, __LINE__, ##__VA_ARGS__) C åº“å® - va_start()","tags":[{"name":"C/C++","slug":"C-C","permalink":"https://changzw.github.io/tags/C-C/"}],"categories":[{"name":"å¼€å‘è¯­è¨€","slug":"å¼€å‘è¯­è¨€","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"},{"name":"C/C++","slug":"å¼€å‘è¯­è¨€/C-C","permalink":"https://changzw.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/C-C/"}]},{"title":"Masonry åˆ†æ","date":"2017-06-01T05:47:00.000Z","path":"2017/06/01/source-code/Masonry-åˆ†æ/","text":"åˆ†ææºç ï¼šè¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿéœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿ Masonry æ˜¯ä»€ä¹ˆMasonryæºç Masonryæ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¸ƒå±€æ¡†æ¶ï¼Œå®ƒä»¥æ›´å¥½çš„è¯­æ³•åŒ…è£…äº†AutoLayoutMasonryæ‹¥æœ‰è‡ªå·±çš„å¸ƒå±€DSLï¼Œå®ƒæä¾›äº†å¯é“¾å¼è¯­æ³•æ¥æè¿°NSLayoutConstraintsï¼Œä»è€Œä½¿å¸ƒå±€ä»£ç æ›´ç®€æ´æ˜“è¯»ã€‚ï¼ˆDSL å…¶å®æ˜¯ Domain Specific Language çš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ ä¸ºä»€ä¹ˆè¦è®¾è®¡ Masonryå¯¹æ¯”ä¸€ä¸‹ AutoLayout ä¸­ä½¿ç”¨ NSLayoutConstraint æ˜¯å¤šä¹ˆç³Ÿç³•12345678910111213141516171819202122232425UIView *superview = self.view;UIView *view1 = [[UIView alloc] init];view1.translatesAutoresizingMaskIntoConstraints = NO;view1.backgroundColor = [UIColor greenColor];[superview addSubview:view1];UIEdgeInsets padding = UIEdgeInsetsMake(10, 10, 10, 10);[superview addConstraints:@[ //view1 constraints [NSLayoutConstraint constraintWithItem:view1 attribute:NSLayoutAttributeTop relatedBy:NSLayoutRelationEqual toItem:superview attribute:NSLayoutAttributeTop multiplier:1.0 constant:padding.top], ... bottom, left [NSLayoutConstraint constraintWithItem:view1 attribute:NSLayoutAttributeRight relatedBy:NSLayoutRelationEqual toItem:superview attribute:NSLayoutAttributeRight multiplier:1 constant:-padding.right], ]];å¦‚æœä½¿ç”¨ Masonry123[view1 mas_makeConstraints:^(MASConstraintMaker *make) &#123; make.edges.equalTo(superview).insets(padding);&#125;];P.S. Masonry å†…éƒ¨ä¼šå¸®ä½ è°ƒç”¨ view.translatesAutoresizingMaskIntoConstraints = NO;Masonry è®¾è®¡çš„ç›®çš„ï¼Œå°±æ˜¯ä»¥é“¾å¼ç¼–ç¨‹æ‰‹æ®µå°è£… NSLayoutConstraint å†—ä½™ä»£ç ï¼å¦‚ä½•å¤„ç†åŸæ¥ç¹æ‚æ¥å£å¦‚ä½•å®ç°é“¾å¼å¦‚ä½•å°è£… NSLayoutConstraint çš„ä½¿ç”¨äº†ä½•ç§ç¼–ç¨‹æ‰‹æ®µ[æ•´ä½“æ¶æ„è®¾è®¡ï¼Œè®¾è®¡æ¨¡å¼ï¼Œè¯­æ³•æŠ€å·§]å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæ ¹æ®æºç ç»“æ„åˆ†æå‡ºæ¥ Masonry ä»£ç ç»“æ„åˆ†æ ä»è°ƒç”¨å±‚æ¬¡åˆ†æè¿™é‡Œæˆ‘è¦åƒæ´‹è‘±ä¸€æ ·ä¸€å±‚ä¸€å±‚çš„æ‹¨å¼€æœ€å¤–å±‚æ¥å£æ ¹æ®è¿™æ®µä»£ç åˆ†æUIView category ä¸­å®ç° View+MASAdditions.h (View+MASShorthandAdditions.h)1234567891011121314151617181920#define MAS_VIEW UIView@interface MAS_VIEW (MASAdditions)- (NSArray *)mas_makeConstraints:(void(^)(MASConstraintMaker *make))block;- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block;- (NSArray *)mas_remakeConstraints:(void(^)(MASConstraintMaker *make))block;//NSLayoutAttribute properties@property (nonatomic, strong, readonly) MASViewAttribute *mas_left;@property (nonatomic, strong, readonly) MASViewAttribute *mas_top;@property (nonatomic, strong, readonly) MASViewAttribute *mas_right;...è¿˜æœ‰å¾ˆå¤šå¸ƒå±€å±æ€§è¿™é‡Œçœç•¥@property (nonatomic, strong, readonly) MASViewAttribute *(^mas_attribute)(NSLayoutAttribute attr);@property (nonatomic, strong, readonly) MASViewAttribute *mas_firstBaseline;@property (nonatomic, strong, readonly) MASViewAttribute *mas_lastBaseline;//a key to associate with this view@property (nonatomic, strong) id mas_key;ä»ğŸ‘†æºç å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªè§åçŸ¥æ„çš„æ–¹æ³•æ–¹æ³•å‚æ•° MASConstraintMaker è¿™ä¸ªå°±æ˜¯ makeå±æ€§ MASViewAttribute è¿™ä¸ªå°±æ˜¯ make åé¢çš„ make.edgesid mas_key è¿™ä¸ªæ˜¯å•¥ï¼Œç›®å‰ä¸çŸ¥é“æˆ‘æƒ³çŸ¥é“ï¼Œä»–çš„é“¾å¼æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¦‚ä½•å°è£… autolayout ç›¸å…³çš„æ•°æ®çš„ï¼Œç›®å‰çœ‹åˆ°çš„åªæ˜¯å¹³å¸¸ä½¿ç”¨çš„æ¥å£æˆ‘è¿˜è¦æ‰¾åˆ° ä¸‹å›¾çš„è¿™äº›ä¿¡æ¯æ¥ç€å¾€é‡Œé¢çœ‹MASViewAttribute: ä¸€ä¸ªä¸å¯å˜å…ƒç»„ï¼Œå­˜ç€ receiver view, related view å’Œå…³è”çš„ NSLayoutAttribute [æ ¹æ®æ–‡æ¡£æ³¨é‡Š]123@property (nonatomic, weak, readonly) MAS_VIEW *view;@property (nonatomic, weak, readonly) id item;@property (nonatomic, assign, readonly) NSLayoutAttribute layoutAttribute;ç›®å‰ç†è§£ä¸ºä¸‹å›¾ç­‰å¼çš„ç›¸å…³ä¿¡æ¯MASConstraintMakerï¼šæä¾›ä¸€ä¸ªå·¥å‚æ–¹æ³•æ¥åˆ›å»º MASConstraints, è¿™äº› constraints åªæœ‰åœ¨è¢« installed çš„æ—¶å€™æ‰ä¼šè¢«æ”¶é›†[æ ¹æ®æ–‡æ¡£æ³¨é‡Š]MASConstraintMaker.h123456789@property (nonatomic, strong, readonly) MASConstraint *left;@property (nonatomic, strong, readonly) MASConstraint *top;@property (nonatomic, strong, readonly) MASConstraint *right;...@property (nonatomic, strong, readonly) MASConstraint *firstBaseline;@property (nonatomic, strong, readonly) MASConstraint *lastBaseline;// è¿™ä¸ªæ˜¯å¹²å•¥çš„ï¼Ÿ@property (nonatomic, strong, readonly) MASConstraint *(^attributes)(MASAttribute attrs);MASConstraintï¼Ÿè·Ÿ NSLayoutConstraint å¥½åƒå…è®¸ä½¿ç”¨å¯é“¾æ¥çš„è¯­æ³•åˆ›å»ºçº¦æŸçº¦æŸå¯ä»¥è¡¨ç¤ºå•ä¸ª NSLayoutConstraintï¼ˆMASViewConstraintï¼‰æˆ–ä¸€ç»„ NSLayoutConstraintsï¼ˆMASComposisteConstraintï¼‰bingoï¼Œåˆ°è¿™é‡Œä¸‹é¢è¿™ä¸¤ä¸ªé—®é¢˜æœ‰çœ‰ç›®äº†, æœ€å¼€å§‹çš„å‡ ä¸ªé—®é¢˜122. å¦‚ä½•å®ç°é“¾å¼3. å¦‚ä½•å°è£… `NSLayoutConstraint` çš„ åˆ†æ Masonry é“¾å¼å°è£… ä¸»è¦ç»„ä»¶ç»“æ„MASConstraintMakerMASConstraintMASViewConstraintMASComposisteConstraintMASConstraintDelegate ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ12345678[redView mas_makeConstraints:^(MASConstraintMaker *make) &#123; make.top.equalTo(superview.mas_top).with.offset(padding); //with with make.left.equalTo(greenView.mas_right).offset(padding); //without with make.bottom.equalTo(blueView.mas_top).offset(-padding); make.right.equalTo(superview.mas_right).offset(-padding); make.width.equalTo(greenView.mas_width); make.height.equalTo(@[greenView, blueView]); //can pass array of views&#125;];masonry call stack step1: ä¸»æµç¨‹ masonry call stack step2ï¼šè°ƒç”¨block æ”¶é›†å¸ƒå±€ä¿¡æ¯ masonry call stack step3ï¼šinstall constraints æ•´ä½“æµç¨‹&amp;æ ¸å¿ƒè°ƒç”¨æ ˆåˆ†æç»“æŸåï¼Œæ¥ä¸‹æ¥å†çœ‹ç»†èŠ‚æŠ€å·§å°±å®¹æ˜“å¤šäº† ä»£ç ç»„ä»¶åˆ†æMASConstraintMakerMASConstraintMASViewConstraintMASComposisteConstraintMASConstraintDelegateMASViewAttributeNSLayoutConstraint çš„é—®é¢˜å¸ƒå±€æ•°æ®åˆ†æ•£ï¼Œä½¿ç”¨å‘½ä»¤å¼æ–¹æ³•è°ƒç”¨ï¼Œæ¥å£å‚æ•°å°±æ˜¯å¸ƒå±€å±æ€§ï¼Œå¯¼è‡´ç”¨æˆ·ä½¿ç”¨é—¹å¿ƒMasonry æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿéœ€è¦åˆ›å»ºå¯¹è±¡ä¿å­˜ model æ•°æ®åˆ›å»ºé“¾èŠ‚ç‚¹(æŠŠå¤§é‡å‚æ•°ä»¥é“¾èŠ‚ç‚¹çš„æ–¹å¼é€ä¸€æ”¾åœ¨èŠ‚ç‚¹ä¸­ï¼ˆMASViewConstraintèŠ‚ç‚¹ï¼‰)è°ƒç”¨ç³»ç»Ÿ NSLayoutConstraint æ–¹æ³•æ•´ä½“æ­¥éª¤ï¼šnode1: åˆ›å»º MASConstraint èŠ‚ç‚¹ï¼Œç»‘å®šç¬¬ä¸€ä¸ª item1 å’Œ attr1node2: åˆ›å»º MASViewAttribute(item2, attr2)ï¼Œå¹¶æ·»åŠ ç­‰å¼çš„ relation (block é—­åŒ…è°ƒç”¨)node3: æ·»åŠ  valueOffsetï¼Œpriorityï¼ŒdivideBy â€¦â€¦ å¸¸é‡æ•°æ® ï¼ˆblock é—­åŒ…ä½å•Šç”¨ï¼‰block ç»“æŸï¼Œæ‰€æœ‰ constraint é…ç½®å®Œï¼Œè¿›è¡Œ install å†…éƒ¨è°ƒç”¨ NSLayoutConstraint æ–¹æ³•ï¼ŒæŠŠå¤æ‚çš„æ–¹æ³•å°è£…åœ¨å†…éƒ¨ model å±‚æ•°æ®æ ¹æ®è¿™ä¸ªç­‰å¼ ç­‰å¼ä¿¡æ¯ï¼šåˆ›å»ºä¸€ä¸ª constraint éœ€è¦ï¼šä¸¤å¯¹ï¼ˆview, attr)relationmulityconstantpriorityMASViewAttribute å…ƒç»„å°è£… (item, constraintAttr)MASViewConstraint åœ¨ MASViewAttribute åŸºç¡€ä¸Šå°è£… (mas_attr = 1.0 * mas_attr + constant) ç”Ÿæˆ MASViewAttribute çš„æ–¹å¼UIView+MASAdditions123456789// è®¡ç®—å±æ€§@property (nonatomic, strong, readonly) MASViewAttribute *mas_left;@property (nonatomic, strong, readonly) MASViewAttribute *mas_top;@property (nonatomic, strong, readonly) MASViewAttribute *mas_right;@property (nonatomic, strong, readonly) MASViewAttribute *mas_bottom;- (MASViewAttribute *)mas_left &#123; return [[MASViewAttribute alloc] initWithView:self layoutAttribute:NSLayoutAttributeLeft];&#125;MASConstraintMaker ç”Ÿæˆé“¾æ¡èŠ‚ç‚¹ MASConstraint æ—¶ï¼Œä½¿ç”¨å·¥å‚æ–¹æ³•å†…éƒ¨é…ç½® MASViewAttribute MASConstraint é…ç½®è¿‡ç¨‹make.bottom.equalTo(blueView.mas_top).offset(-padding);attr1: ç”± MASConstraintMaker ä¸­çš„è®¡ç®—å±æ€§æ–¹æ³•åˆ›å»º make.top.leftrelation: ç”± MASConstraint ä¸­çš„æ–¹æ³• equalTo æ·»åŠ attr2: ç”± UIView+MASAdditions æ‰©å±•æ–¹æ³•å¾—åˆ°offset: ç”± MASConstraint ä¸­çš„æ–¹æ³• equalTo æ·»åŠ priority: ç”± MASConstraint ä¸­çš„æ–¹æ³• priority æ·»åŠ  å¸ƒå±€å·¥å‚ MASConstraintMakerä»–çš„ product æ˜¯ MASConstraintä»–çš„å·¥å‚æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839// 1. è®¡ç®—å±æ€§ï¼Œæˆ‘ç†è§£ä¸ºå·¥å‚æ–¹æ³•@property (nonatomic, strong, readonly) MASConstraint *left;@property (nonatomic, strong, readonly) MASConstraint *top;@property (nonatomic, strong, readonly) MASConstraint *right;@property (nonatomic, strong, readonly) MASConstraint *bottom;...// è®¡ç®—å±æ€§çš„ get æ–¹æ³•- (MASConstraint *)top &#123; return [self addConstraintWithLayoutAttribute:NSLayoutAttributeTop];&#125;- (MASConstraint *)addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute &#123; return [self constraint:nil addConstraintWithLayoutAttribute:layoutAttribute];&#125;// 2. çœŸæ­£çš„å·¥å‚æ–¹æ³•ï¼ŒåŒæ—¶ ä»–ä¹Ÿæ˜¯ ç»™ constraint æ·»åŠ  NSLayoutAttribute çš„åœ°æ–¹- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute &#123; MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] initWithView:self.view layoutAttribute:layoutAttribute]; MASViewConstraint *newConstraint = [[MASViewConstraint alloc] initWithFirstViewAttribute:viewAttribute];// 2.2 make.top.left.equalTo(superview).insets(padding); [left èŠ‚ç‚¹çš„æ—¶å€™è°ƒç”¨ï¼Œäº§ç”Ÿç¬¬äºŒä¸ª èŠ‚ç‚¹ä»¥åæ‰€æœ‰èŠ‚ç‚¹çš„æ–¹æ³•] if ([constraint isKindOfClass:MASViewConstraint.class]) &#123; //replace with composite constraint NSArray *children = @[constraint, newConstraint]; MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children]; compositeConstraint.delegate = self; [self constraint:constraint shouldBeReplacedWithConstraint:compositeConstraint]; return compositeConstraint; &#125;// 2.1 make.top.left.equalTo(superview).insets(padding); [top èŠ‚ç‚¹çš„æ—¶å€™è°ƒç”¨ï¼Œäº§ç”Ÿç¬¬ä¸€ä¸ª èŠ‚ç‚¹çš„æ–¹æ³•] if (!constraint) &#123; newConstraint.delegate = self; [self.constraints addObject:newConstraint]; &#125; return newConstraint;&#125;å¾—å‡ºç»“è®ºï¼šæ ¹æ®ä¸Šé¢ä»£ç ä¸­çš„ 2.1ï¼Œ2.2 çŸ¥é“ make.left.right.topâ€¦â€¦ ä¼šç”Ÿäº§ 3 ä¸ª MASViewConstraintï¼Œå¹¶ç»„åˆåˆ° MASCompositeConstraint é‡Œé¢2333 è¿™å°±çŸ¥é“äº† ä¸ºä»€ä¹ˆè¦æœ‰ MASCompositeConstraintï¼Œä»–çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯ å®ç°é“¾å¼å…¼å®¹å•Šï¼ï¼ˆå› ä¸ºèµ¤è£¸è£¸çš„ 3ä¸ª MASViewConstraintï¼Œæ€ä¹ˆå˜æˆä¸€ä¸ª èŠ‚ç‚¹å•Šï¼‰é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œmake.left.right.top(view)ï¼Œæ˜¯æ€ä¹ˆå®ç° left = view.left, right = view.right â€¦â€¦ çš„å‘¢ï¼Ÿç­‰å¼å…³ç³»ï¼Œä½¿ç”¨å‡½æ•°è¡¨ç¤ºï¼Œå†…éƒ¨ç›´æ¥æŠŠå¯¹åº” relation é…ç½®ç»™ constraint123- (MASConstraint * (^)(id attr))mas_equalTo;- (MASConstraint * (^)(id attr))mas_greaterThanOrEqualTo;- (MASConstraint * (^)(id attr))mas_lessThanOrEqualTo;æ¥ä¸‹æ¥çš„é“¾å¼éƒ½æ˜¯ç”¨å‡½æ•°é—­åŒ…çš„æ–¹å¼ï¼ŒæŠŠå‚æ•°ä¼ ç»™ constraint çš„ [é—­åŒ…æ ¼å¼ MASConstraint * (^)(parameter å‚æ•°)]MASConstraintDelegate æ˜¯å·¥å‚æ–¹æ³•åè®®, ä» è¿™æ®µä»£ç çš„ 2 çœ‹ï¼Œä»–æ˜¯è®© constraint ç”Ÿæˆ constraint çš„æ–¹æ³•è¿‡æ¸¡ç‚¹ã€‚ä»–æ˜¯ä¸ºäº†æ»¡è¶³ make.top.left ä¸­ top.left é€šè¿‡ topConstraint ç”Ÿæˆä¸€ä¸ª leftConstraintçš„æ–¹æ³•æ‰€ä»¥å¯¹äºé“¾å¼ç¼–ç¨‹æŠ€å·§ï¼šé“¾æ¡çš„å¼€å§‹ï¼Œåˆ›å»ºæˆé“¾çš„èµ·å§‹èŠ‚ç‚¹å¯¹è±¡ä¸€æ¡é“¾ä¸Šåº”è¯¥åªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œåé¢çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å¯¹äºè¿™ä¸ªå¯¹è±¡çš„å±æ€§é…ç½®æ·»åŠ å¦‚æœåŒä¸€æ¡é“¾ä¸Šæœ‰å¤šä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆä½¿ç”¨ç»„åˆæ¨¡å¼ï¼ŒæŠŠå¤šä¸ªèŠ‚ç‚¹å¯¹è±¡å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡12ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é—­åŒ…ä¼ ï¼Ÿä½¿ç”¨æ–¹æ³•æ¶ˆæ¯ä¼ ä¸å¥½å—ï¼Ÿå¥½åƒå°±æ˜¯ä¸ºäº†ä¸è¦ `[]` è¿™ä¸ªç¬¦å·å§â€¦â€¦ï¼Œä½¿ç”¨ `.` é“¾å¼è°ƒç”¨çœ‹ç€å¥½çœ‹ å…¶ä»–å¼€å‘ç»†èŠ‚åˆ†æä¸‹é¢è¿™äº›æ˜¯å•¥ï¼Ÿéƒ½æ˜¯ä¸€äº› c è¯­è¨€çš„å®ï¼Œåœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†æè¿‡äº†1234567891011121314151617181920212223242526272829303132333435363738394041//MASUtilities.h#define MASAttachKeys(...) \\ &#123; \\ NSDictionary *keyPairs = NSDictionaryOfVariableBindings(__VA_ARGS__); \\ for (id key in keyPairs.allKeys) &#123; \\ id obj = keyPairs[key]; \\ NSAssert([obj respondsToSelector:@selector(setMas_key:)], \\ @\"Cannot attach mas_key to %@\", obj); \\ [obj setMas_key:key]; \\ &#125; \\ &#125;static inline id _MASBoxValue(const char *type, ...)#define MASBoxValue(value) _MASBoxValue(@encode(__typeof__((value))), (value))//View+MASShorthandAdditions.h#define MAS_ATTR_FORWARD(attr) \\- (MASViewAttribute *)attr &#123; \\ return [self mas_##attr]; \\&#125;#define MAS_ATTR_FORWARD_AVAILABLE(attr, available) \\- (MASViewAttribute *)attr available &#123; \\ return [self mas_##attr]; \\&#125;//MASConstraint.h#define mas_equalTo(...) equalTo(MASBoxValue((__VA_ARGS__)))#define mas_greaterThanOrEqualTo(...) greaterThanOrEqualTo(MASBoxValue((__VA_ARGS__)))#define mas_lessThanOrEqualTo(...) lessThanOrEqualTo(MASBoxValue((__VA_ARGS__)))#define mas_offset(...) valueOffset(MASBoxValue((__VA_ARGS__)))#ifdef MAS_SHORTHAND_GLOBALS#define equalTo(...) mas_equalTo(__VA_ARGS__)#define greaterThanOrEqualTo(...) mas_greaterThanOrEqualTo(__VA_ARGS__)#define lessThanOrEqualTo(...) mas_lessThanOrEqualTo(__VA_ARGS__)#define offset(...) mas_offset(__VA_ARGS__) runtime çš„è¿ç”¨ä¸»è¦æ˜¯ç»™ view æ·»åŠ å…³è”å¯¹è±¡123456789101112131415161718192021222324252627//MASViewConstraint.m@interface MAS_VIEW (MASConstraints)// è§åçŸ¥æ„@property (nonatomic, readonly) NSMutableSet *mas_installedConstraints; @end@implementation MAS_VIEW (MASConstraints)static char kInstalledConstraintsKey; - (NSMutableSet *)mas_installedConstraints &#123; NSMutableSet *constraints = objc_getAssociatedObject(self, &amp;kInstalledConstraintsKey); if (!constraints) &#123; constraints = [NSMutableSet set]; objc_setAssociatedObject(self, &amp;kInstalledConstraintsKey, constraints, OBJC_ASSOCIATION_RETAIN_NONATOMIC); &#125; return constraints;&#125;@end//View+MASAdditions.m- (id)mas_key &#123; return objc_getAssociatedObject(self, @selector(mas_key));&#125;- (void)setMas_key:(id)key &#123; objc_setAssociatedObject(self, @selector(mas_key), key, OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;mas_key æ˜¯ä¸ºäº†è°ƒè¯•å¸ƒå±€ç”¨çš„Masonry å¸ƒå±€å†²çªå¿«é€Ÿå®šä½å¦‚ä½•å¿«é€Ÿå®šä½å“ªä¸ª View å‡ºç°äº†çº¦æŸè­¦å‘Šï¼ŸAuto Layout Guide","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"æºç ","slug":"æºç ","permalink":"https://changzw.github.io/tags/%E6%BA%90%E7%A0%81/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"UI å¸ƒå±€","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/UI-å¸ƒå±€","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/UI-%E5%B8%83%E5%B1%80/"}]},{"title":"iOS View ç¼–ç¨‹æŒ‡å—","date":"2017-05-15T01:31:54.000Z","path":"2017/05/15/UI ç›¸å…³/iOS-View-ç¼–ç¨‹æŒ‡å—/","text":"View å’Œ Window æ¶æ„ View ç»“æ„åŸºç¡€layer ç®¡ç† view è¾…åŠ©å­˜å‚¨å™¨ï¼Œå¤„ç†view ç›¸å…³çš„åŠ¨ç”»ã€‚ View å±‚çº§å’Œå­view ç®¡ç† View ç»˜åˆ¶å¾ªç¯UIViewç±»ä½¿ç”¨æŒ‰éœ€ç»˜åˆ¶æ¨¡å‹æ¥å‘ˆç°å†…å®¹ã€‚å½“è§†å›¾é¦–æ¬¡å‡ºç°åœ¨å±å¹•ä¸Šæ—¶ï¼Œç³»ç»Ÿè¦æ±‚å®ƒç»˜åˆ¶å…¶å†…å®¹ã€‚ç³»ç»Ÿæ•è·è¯¥å†…å®¹çš„å¿«ç…§å¹¶å°†è¯¥å¿«ç…§ç”¨ä½œ view çš„è§†è§‰è¡¨ç¤ºã€‚å¦‚æœä¸æ›´æ”¹è§†å›¾çš„å†…å®¹ï¼Œåˆ™å¯èƒ½æ°¸è¿œä¸ä¼šå†æ¬¡è°ƒç”¨è§†å›¾çš„ç»˜å›¾ä»£ç ã€‚å¿«ç…§å›¾åƒå¯ç”¨äºæ¶‰åŠè§†å›¾çš„å¤§å¤šæ•°æ“ä½œã€‚å¦‚æœæ›´æ”¹äº†å†…å®¹ï¼Œåˆ™ä¼šé€šçŸ¥ç³»ç»Ÿè§†å›¾å·²æ›´æ”¹ã€‚ç„¶åï¼Œè§†å›¾é‡å¤ç»˜åˆ¶è§†å›¾å’Œæ•è·æ–°ç»“æœå¿«ç…§çš„è¿‡ç¨‹ã€‚å½“è§†å›¾çš„å†…å®¹æ›´æ”¹æ—¶ï¼Œæ‚¨ä¸ä¼šç›´æ¥é‡ç»˜è¿™äº›æ›´æ”¹ã€‚è€Œæ˜¯ä½¿ç”¨setNeedsDisplayæˆ–setNeedsDisplayInRectï¼šæ–¹æ³•ä½¿è§†å›¾æ— æ•ˆã€‚è¿™äº›æ–¹æ³•å‘Šè¯‰ç³»ç»Ÿè§†å›¾çš„å†…å®¹å·²æ›´æ”¹ï¼Œå¹¶ä¸”éœ€è¦åœ¨ä¸‹ä¸€ä¸ªæœºä¼šé‡æ–°ç»˜åˆ¶ã€‚åœ¨å¯åŠ¨ä»»ä½•ç»˜å›¾æ“ä½œä¹‹å‰ï¼Œç³»ç»Ÿå°†ä¸€ç›´ç­‰åˆ°å½“å‰è¿è¡Œå¾ªç¯ç»“æŸã€‚è¿™ç§å»¶è¿Ÿä½¿ä½ æœ‰æœºä¼šä¸€æ¬¡ä½¿å¤šä¸ªè§†å›¾æ— æ•ˆï¼Œä»å±‚æ¬¡ç»“æ„ä¸­æ·»åŠ æˆ–åˆ é™¤è§†å›¾ï¼Œéšè—è§†å›¾ï¼Œè°ƒæ•´è§†å›¾å¤§å°ä»¥åŠé‡æ–°æ”¾ç½®è§†å›¾ã€‚æ‰€åšçš„æ‰€æœ‰æ›´æ”¹éƒ½å°†åŒæ—¶åæ˜ å‡ºæ¥ã€‚é—®é¢˜ï¼šéƒ½æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å‡ºå‘è§†å›¾é‡æ–°ç»˜åˆ¶ï¼Ÿ å†…å®¹ Modes å¯æ‹‰ä¼¸ Views å†…å»ºåŠ¨ç”»æ”¯æŒ View å‡ ä½•å’Œåæ ‡ç³» The Relationship of the Frame, Bounds, and Center Properties åæ ‡ç³»è½¬æ¢CGContextGetCTMReturns the current transformation matrix. Points Versus Pixels The Runtime Interaction Model for Views Tips for Using Views Effectively Views Do Not Always Have a Corresponding View Controller Minimize Custom Drawing Take Advantage of Content Modes Declare Views as Opaque Whenever Possible Adjust Your Viewâ€™s Drawing Behavior When Scrolling Do Not Customize Controls by Embedding Subviews","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"ç¿»è¯‘","slug":"ç¿»è¯‘","permalink":"https://changzw.github.io/tags/%E7%BF%BB%E8%AF%91/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"Guide","slug":"iOS-Programming/Guide","permalink":"https://changzw.github.io/categories/iOS-Programming/Guide/"}]},{"title":"Swift é¢å‘åè®®ç¼–ç¨‹","date":"2017-05-13T16:30:52.000Z","path":"2017/05/14/swift è¯­æ³•/Swift-é¢å‘åè®®ç¼–ç¨‹/","text":"WWDC 2015Developer ToolsProtocol-Oriented Programming in SwiftSession 408 Classé¢å‘å¯¹è±¡çš„è®¾è®¡æ€æƒ³å°è£…ï¼šæŠŠç›¸å…³æ•°æ®å’Œæ“ä½œè¿›è¡Œåˆ†ç»„è®¿é—®æ§åˆ¶ï¼šæ„å»ºä¸€é¢å¢™æŠŠé‡Œé¢ä»£ç å’Œå¤–é¢ä»£ç åˆ†å¼€æŠ½è±¡æ¥å£ï¼šæŠ½è±¡æ¥å£è¡¨è¾¾ç±»çš„ä½œç”¨å’Œé€šè®¯åŠŸèƒ½å‘½åç©ºé—´ï¼šé¿å…ä»£ç åç§°å†²çªExpressive syntaxï¼šè¡¨è¾¾å¼è¯­æ³•ï¼ˆä¸‹æ ‡æ‰©å±•ï¼‰extension æ‰©å±•æ€§ï¼šå¿˜äº†ç»™ç±»åŠ ä¸œè¥¿ï¼Œå¯ä»¥ä½¿ç”¨ extension ç»™ä»–åŠ ä¸Šä½†æ˜¯ï¼Œåœ¨ swift é‡Œä¸Šé¢çš„è¿™äº›éƒ½å¯ä»¥ç”¨ struct or enum åšBuilding Better Apps with Value Types in Swift","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"WWDC","slug":"WWDC","permalink":"https://changzw.github.io/tags/WWDC/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"},{"name":"WWDC","slug":"iOS-Programming/WWDC","permalink":"https://changzw.github.io/categories/iOS-Programming/WWDC/"}]},{"title":"RAC-å­¦ä¹ ç¬”è®°01","date":"2017-04-06T02:08:45.000Z","path":"2017/04/06/RxSwfit+RAC/RAC-å­¦ä¹ ç¬”è®°01/","text":"å­¦ä¹ ç›®çš„çŸ¥é“ rac éƒ½æœ‰ä»€ä¹ˆçŸ¥é“ä»–ä»¬éƒ½æ€ä¹ˆç”¨çŸ¥é“ä¸ºä»€ä¹ˆæœ‰è¿™äº›ä¸œè¥¿æ ¹ç±»å½’çº³æ•´ç†å¦‚ä½•è‡ªå·±æ‰©å±•é€‚å½“åˆ†ææºç  ä¸»è¦æ¦‚å¿µä¿¡å·ä¿¡å·å˜æ¢&amp;ç»„åˆè®¢é˜…ï¼ˆç»‘å®šï¼‰å–æ¶ˆè®¢é˜…RACSignal : åŸºäºæ—¶é—´çš„å¼‚æ­¥äº‹ä»¶æµRACSequence : æƒ°æ€§é›†åˆï¼ŒåŒæ­¥ï¼ˆå¾ˆå°‘ç”¨ï¼‰ï¼Œcollectionç±»å‹çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ Streamï¼ˆmonadï¼‰å°è£…çš„å‡½æ•°å¼æ–¹å¼ å¦‚ä½•åˆ›å»ºä¿¡å· å•å…ƒä¿¡å·1234RACSignal *sig0 = [RACSignal error:NSError.new];RACSignal *sig1 = [RACSignal return:@0];RACSignal *sig2 = [RACSignal empty];RACSignal *sig3 = [RACSignal never]; åŠ¨æ€ä¿¡å·1234567RACSignal *s = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123; [subscriber sendNext:@0]; [subscriber sendCompleted]; return [RACDisposable disposableWithBlock:^&#123; &#125;];&#125;]; Cocoa æ¡¥æ¥12345678910111213141516171819202122232425262728293031323334- (void) bridge &#123; RACSignal *sO = RACObserver(self, button); self.sigSetFrame = [self.button rac_signalForSelector:@selector(setFrame:)]; [_sigSetFrame subscribeNext:^(id x) &#123; NSLog(@\"setFrame:%@\", x); &#125;]; self.sigClick = [self.button rac_signalForControlEvents:UIControlEventTouchUpInside]; [_sigClick subscribeNext:^(id x) &#123; NSLog(@\"event: %@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignals:_sigClick, nil] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignalsFromArray:@[[_sigClick map:^id(id value) &#123; return @[@3]; &#125;]]] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [self rac_liftSelector:@selector(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@1)]];&#125;- (int) lift:(id)value&#123; printf(\"lift: %s\", __func__); return 1;&#125; ä¿¡å·å˜åŒ–(å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„)123[_sigClick map:^id(id value) &#123; return @[@3];&#125;]; åºåˆ—è½¬æ¢1self.sigSequence = [[RACSequence return:@3] concat:[RACSequence return:@4]].signal; è®¢é˜…ï¼ˆç»‘å®šï¼‰ä¿¡å·çš„æ–¹å¼ ç›´æ¥è®¢é˜…æ–¹æ³•1234[self.sigSample subscribeNext:^(id x) &#123; NSLog(@\"sample: %@\", x);&#125;]; ç»‘å®š1RAC(self, a) = Signal; Cocoa æ¡¥æ¥1234567891011121314151617181920- (void)signal &#123; [[self rac_liftSelector:@selector(lift:) withSignals:_sigClick, nil] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [[self rac_liftSelector:@selector(lift:) withSignalsFromArray:@[[_sigClick map:^id(id value) &#123; return @[@3]; &#125;]]] subscribeNext:^(id x) &#123; NSLog(@\"%@\", x); &#125;]; [self rac_liftSelector:@selector(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@1)]];&#125;- (int) lift:(id)value&#123; printf(\"lift: %s\", __func__); return 1;&#125; ä¿¡å·å˜åŒ–&amp;ç»„åˆå•ä¸ªä¿¡å·çš„å˜åŒ–å¤šä¸ªä¿¡å·çš„ç»„åˆé«˜é˜¶æ“ä½œ å€¼æ“ä½œé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„å€¼æ“ä½œæ–¹æ³•ï¼Ÿè‡ªå·±å¦‚ä½•æ‰©å±•æ–°çš„å€¼æ–¹æ³•transform è¿™äº›ç”¨çš„æ¯”è¾ƒå¤šmapMapReplaceReduceEach tuple(a, b) -&gt; cå€¼åˆ¤æ–­é€»è¾‘å˜æ¢notandorç”¨çš„æ¯”è¾ƒå°‘reduceApply è¿™ä¸ªä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œç”¨combineLatest: reduceEach: å°±å¯ä»¥åšäº†ï¼Œè€Œä¸”ä»£ç çœ‹èµ·æ¥æ›´å¥½ã€‚materializedematerialize æ•°é‡æ“ä½œrepeat ä¸€ç›´ä¼šæœ‰å€¼æ¡ä»¶è¿‡æ»¤1ignoreignoreValuesdistinctUntilChangedæ¡ä»¶è¿‡æ»¤2takeUntilBlock:(BOOL (^)(id x))predicatetakeWhileBlock:(BOOL (^)(id x))predicate;skipUntilBlock:(BOOL (^)(id x))predicate;skipWhileBlock:(BOOL (^)(id x))predicate;æ•°é‡åˆ¤æ–­ï¼Œå¦‚æœæœ‰å€¼å°±å‘é€any;any:(BOOL (^)(id object))predicateBlock;all:(BOOL (^)(id object))predicateBlock;é‡è¯•retryretry: Countcollect æ±‡èš ä¿¡å·å¿…é¡»æœ‰è¿”å›å€¼å‰¯ä½œç”¨ï¼šâ€“ å¯¹äºä¿¡å·å€¼å˜åŒ–ä»¥å¤–çš„ä¸€äº›æ“ä½œdoNextdoCompleteddoErroræŠ˜å å‡½æ•°ä¸å¬å¯¹ä¸€ä¸ªvalue æ“ä½œï¼Œä½¿ç”¨æŠ˜å å‡½æ•°è§£å†³è¿™ä¸ªé—®é¢˜123[sig10 aggregateWithStart:@0 reduce:^id(id running, id next) &#123; return @([running intValue] + [next intValue]);&#125;];(RACSignal *)aggregateWithStart:(id)start reduce:(id (^)(id running, id next))reduceBlock;(RACSignal *)aggregateWithStart:(id)start reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;(RACSignal *)aggregateWithStartFactory:(id (^)(void))startFactory reduce:(id (^)(id running, id next))reduceBlock;(instancetype)scanWithStart:(id)startingValue reduce:(id (^)(id running, id next))reduceBlock;(instancetype)scanWithStart:(id)startingValue reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock; æ—¶é—´æ“ä½œ+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler;+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler withLeeway:(NSTimeInterval)leeway;delaythrottle é˜€é—¨ï¼Œåœ¨å›ºå®šæ—¶é—´å†…æ²¡æœ‰æ–°å€¼å‘é€çš„æ—¶å€™ï¼Œä¼šå‘é€æœ€åçš„å€¼ å¤šä¸ªä¿¡å·ç»„åˆé—®é¢˜ï¼šå—å“ªä¸ªä¿¡å·ç»ˆæ­¢è€Œç»ˆæ­¢ï¼Ÿé”™è¯¯ä¼ é€’ï¼Ÿå„ä¸ªä¿¡å·ä½•æ—¶å¼€å§‹å¼€å§‹è®¢é˜…ï¼Ÿåœ¨å“ªä¸ªçº¿ç¨‹å‘å‡ºï¼Ÿconcatç¬¬ä¸€ä¸ªç»“æŸåï¼Œè®¢é˜…ç¬¬äºŒä¸ªç¬¬ä¸€ä¸ªerror åï¼Œå°±ç›´æ¥ errormergezipcombineLatestsampletakeUntiltakeUntilReplacement, å½“ B æ¥äº†ç›´æ¥æ›¿æ¢ Aï¼Œå¼€å§‹è®¢é˜… B ä¿¡å·çš„é«˜é˜¶æ“ä½œï¼ˆå‡é˜¶é™é˜¶ï¼‰å‡é˜¶ S(v) -&gt; S(s(v))é™é˜¶ S(s(v)) -&gt; S(v)1234RACSignal *signal = @[@1, @2, @3, @4].rac_sequence.signal;RACSignal *signalB = [[signal map:^id(id value) &#123; return [[RACSignal return:value] delay:1];&#125;] concat];é™é˜¶æ“ä½œswitchToLatestsif/then/elseswitch/cases/defaultflattenflatten ç±»ä¼¼ merge åªä¸è¿‡ä¸€ä¸ªæ˜¯æ¥æ”¶çš„ valueæ˜¯ signalï¼Œå¦ä¸€ä¸ªæ¥æ”¶çš„å°±æ˜¯ valueflatten:count æŒ‰ä¸ªæ•°å±•å¼€ä¿¡å·ï¼Œå½“ä¿¡å·ä¸ªæ•° &gt; count ä»¥åç­‰å¾…ï¼Œå¦‚æœæœ‰ sig completedï¼Œé‚£ä¹ˆæŠŠç­‰å¾…ä¸­çš„sig æ”¾å…¥å±•å¼€æ•°ç»„é‡Œé¢flatten:1 == concatflattenMapæ»¡è¶³ monad çš„éƒ¨åˆ†å®šä¹‰ï¼Œç»å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ flattenMap å®ç°bindå¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ bind å®ç° å†·ä¿¡å·&amp;çƒ­ä¿¡å· ä¸€äº›ä¹ é¢˜å¦‚ä½•è·å¾—æ— é™é€’å¢çš„ä¿¡å·12345678RACSignal *increment(int inc) &#123; RACSignal *repeat = [[RACSignal return:@(inc)] repeat]; return [[repeat scanWithStart:0 reduce:^id(id running, id next) &#123; return @([running intValue] + [next intValue]); &#125;] delay:1];&#125;fibonacci1234567RACSignal *fibonacci() &#123; RACSignal *repeat = [[RACSignal return:nil] repeat]; return [repeat scanWithStart:RACTuplePack(@1, @1) reduce:^id(RACTuple *running, id _) &#123; int next = [running.first intValue] + [running.second intValue]; return RACTuplePack(running.second, @(next)); &#125;];&#125;","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"},{"name":"objc","slug":"objc","permalink":"https://changzw.github.io/tags/objc/"},{"name":"RAC","slug":"RAC","permalink":"https://changzw.github.io/tags/RAC/"}],"categories":[{"name":"ç¬¬ä¸‰æ–¹æ¡†æ¶","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"},{"name":"ReactiveCocoa","slug":"ç¬¬ä¸‰æ–¹æ¡†æ¶/ReactiveCocoa","permalink":"https://changzw.github.io/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/ReactiveCocoa/"}]},{"title":"è¿›ç¨‹&çº¿ç¨‹é—´é€šä¿¡","date":"2017-03-09T02:09:25.000Z","path":"2017/03/09/è¿›ç¨‹-çº¿ç¨‹é—´é€šä¿¡/","text":"ä¸€ã€è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼ ç®¡é“( pipe )ç®¡é“æ˜¯ä¸€ç§åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚è¿›ç¨‹çš„äº²ç¼˜å…³ç³»é€šå¸¸æ˜¯æŒ‡çˆ¶å­è¿›ç¨‹å…³ç³»ã€‚ æœ‰åç®¡é“ (namedpipe)æœ‰åç®¡é“ä¹Ÿæ˜¯åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œä½†æ˜¯å®ƒå…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚ ä¿¡å·é‡(semophore )ä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚å®ƒå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚ æ¶ˆæ¯é˜Ÿåˆ—( messagequeue )æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ã€ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚ ä¿¡å· (sinal )ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚ å…±äº«å†…å­˜(shared memory )å…±äº«å†…å­˜å°±æ˜¯æ˜ å°„ä¸€æ®µèƒ½è¢«å…¶ä»–è¿›ç¨‹æ‰€è®¿é—®çš„å†…å­˜ï¼Œè¿™æ®µå…±äº«å†…å­˜ç”±ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œä½†å¤šä¸ªè¿›ç¨‹éƒ½å¯ä»¥è®¿é—®ã€‚å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ IPC æ–¹å¼ï¼Œå®ƒæ˜¯é’ˆå¯¹å…¶ä»–è¿›ç¨‹é—´é€šä¿¡æ–¹å¼è¿è¡Œæ•ˆç‡ä½è€Œä¸“é—¨è®¾è®¡çš„ã€‚å®ƒå¾€å¾€ä¸å…¶ä»–é€šä¿¡æœºåˆ¶ï¼Œå¦‚ä¿¡å·ä¸¤ï¼Œé…åˆä½¿ç”¨ï¼Œæ¥å®ç°è¿›ç¨‹é—´çš„åŒæ­¥å’Œé€šä¿¡ã€‚ å¥—æ¥å­—(socket )å¥—è§£å£ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œä¸å…¶ä»–é€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ç”¨äºä¸åŒåŠå…¶é—´çš„è¿›ç¨‹é€šä¿¡ã€‚ äºŒã€çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼é”æœºåˆ¶ï¼šåŒ…æ‹¬äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”äº’æ–¥é”æä¾›äº†ä»¥æ’ä»–æ–¹å¼é˜²æ­¢æ•°æ®ç»“æ„è¢«å¹¶å‘ä¿®æ”¹çš„æ–¹æ³•ã€‚è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«æ•°æ®ï¼Œè€Œå¯¹å†™æ“ä½œæ˜¯äº’æ–¥çš„ã€‚æ¡ä»¶å˜é‡å¯ä»¥ä»¥åŸå­çš„æ–¹å¼é˜»å¡è¿›ç¨‹ï¼Œç›´åˆ°æŸä¸ªç‰¹å®šæ¡ä»¶ä¸ºçœŸä¸ºæ­¢ã€‚å¯¹æ¡ä»¶çš„æµ‹è¯•æ˜¯åœ¨äº’æ–¥é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œçš„ã€‚æ¡ä»¶å˜é‡å§‹ç»ˆä¸äº’æ–¥é”ä¸€èµ·ä½¿ç”¨ã€‚ä¿¡å·é‡æœºåˆ¶(Semaphore)ï¼šåŒ…æ‹¬æ— åçº¿ç¨‹ä¿¡å·é‡å’Œå‘½åçº¿ç¨‹ä¿¡å·é‡ä¿¡å·æœºåˆ¶(Signal)ï¼šç±»ä¼¼è¿›ç¨‹é—´çš„ä¿¡å·å¤„ç†çº¿ç¨‹é—´çš„é€šä¿¡ç›®çš„ä¸»è¦æ˜¯ç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œæ‰€ä»¥çº¿ç¨‹æ²¡æœ‰åƒè¿›ç¨‹é€šä¿¡ä¸­çš„ç”¨äºæ•°æ®äº¤æ¢çš„é€šä¿¡æœºåˆ¶ã€‚","tags":[{"name":"è®¡ç®—æœºåŸºç¡€","slug":"è®¡ç®—æœºåŸºç¡€","permalink":"https://changzw.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"}],"categories":[{"name":"è®¡ç®—æœºåŸºç¡€çŸ¥è¯†","slug":"è®¡ç®—æœºåŸºç¡€çŸ¥è¯†","permalink":"https://changzw.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}]},{"title":"è‡ªå®šä¹‰æ§ä»¶[è½¬è½½objccn]","date":"2017-01-13T05:34:47.000Z","path":"2017/01/13/è‡ªå®šä¹‰æ§ä»¶/","text":"å¯ä»¥ç›´æ¥çœ‹ objccn.io çš„è¿™ç¯‡è‡ªå®šä¹‰æ§ä»¶æ§ä»¶æ¸²æŸ“æ–¹å¼æ§ä»¶äº¤äº’æ–¹å¼optional æ•°æ®æº è§†å›¾å±‚æ¬¡æ¦‚è§ˆ12345UIResponder â†‘ UIView â†‘ UIControl UIResponder(å“åº”é“¾)UIResponder æ˜¯ UIView çš„çˆ¶ç±»ã€‚responder èƒ½å¤Ÿå¤„ç†è§¦æ‘¸ã€æ‰‹åŠ¿ã€è¿œç¨‹æ§åˆ¶ç­‰äº‹ä»¶ã€‚ä¹‹æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„ç±»è€Œæ²¡æœ‰åˆå¹¶åˆ° UIView ä¸­ï¼Œæ˜¯å› ä¸º UIResponder æœ‰æ›´å¤šçš„å­ç±»ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯ UIApplication å’Œ UIViewControllerã€‚é€šè¿‡é‡å†™ UIResponder çš„æ–¹æ³•ï¼Œå¯ä»¥å†³å®šä¸€ä¸ªç±»æ˜¯å¦å¯ä»¥æˆä¸ºç¬¬ä¸€å“åº”è€… (first responder)ï¼Œä¾‹å¦‚å½“å‰è¾“å…¥ç„¦ç‚¹å…ƒç´ ã€‚å½“ touches (è§¦æ‘¸) æˆ– motion (æŒ‡ä¸€ç³»åˆ—è¿åŠ¨ä¼ æ„Ÿå™¨) ç­‰äº¤äº’è¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œå®ƒä»¬è¢«å‘é€ç»™ç¬¬ä¸€å“åº”è€… (é€šå¸¸æ˜¯ä¸€ä¸ªè§†å›¾)ã€‚å¦‚æœç¬¬ä¸€å“åº”è€…æ²¡æœ‰å¤„ç†ï¼Œåˆ™è¯¥è¡Œä¸ºæ²¿ç€å“åº”é“¾åˆ°è¾¾è§†å›¾æ§åˆ¶å™¨ï¼Œå¦‚æœè¡Œä¸ºä»ç„¶æ²¡æœ‰è¢«å¤„ç†ï¼Œåˆ™ç»§ç»­ä¼ é€’ç»™åº”ç”¨ã€‚å¦‚æœæƒ³ç›‘æµ‹æ™ƒåŠ¨æ‰‹åŠ¿ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åœ¨è¿™3å±‚ä¸­çš„ä»»æ„ä½ç½®å¤„ç†ã€‚UIResponder è¿˜å…è®¸è‡ªå®šä¹‰è¾“å…¥æ–¹æ³•ï¼Œä» inputAccessoryView å‘é”®ç›˜æ·»åŠ è¾…åŠ©è§†å›¾åˆ°ä½¿ç”¨ inputView æä¾›ä¸€ä¸ªå®Œå…¨è‡ªå®šä¹‰çš„é”®ç›˜ã€‚ UIView(æ¸²æŸ“layerå®¿ä¸»)UIView å­ç±»å¤„ç†æ‰€æœ‰è·Ÿå†…å®¹ç»˜åˆ¶æœ‰å…³çš„äº‹æƒ…ä»¥åŠè§¦æ‘¸æ—¶é—´ã€‚ä½†æˆ‘ä»¬é‡ç”³ä¸€äº›æŠ€å·§ç‚¹:ä¸€ä¸ªæ™®éé”™è¯¯çš„æ¦‚å¿µï¼šè§†å›¾çš„åŒºåŸŸæ˜¯ç”±å®ƒçš„ frame å®šä¹‰çš„ã€‚å®é™…ä¸Š frame æ˜¯ä¸€ä¸ªæ´¾ç”Ÿå±æ€§ï¼Œæ˜¯ç”± center å’Œ bounds åˆæˆè€Œæ¥ã€‚ä¸ä½¿ç”¨ Auto Layout æ—¶ï¼Œå¤§å¤šæ•°äººä½¿ç”¨ frame æ¥æ”¹å˜è§†å›¾çš„ä½ç½®å’Œå¤§å°ã€‚å°å¿ƒäº›ï¼Œå®˜æ–¹æ–‡æ¡£ç‰¹åˆ«è¯¦ç»†è¯´æ˜äº†ä¸€ä¸ªæ³¨æ„äº‹é¡¹:å¦‚æœ transform å±æ€§ä¸æ˜¯ identity transform çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼Œå› æ­¤åº”è¯¥å°†å…¶å¿½ç•¥å¦ä¸€ä¸ªå…è®¸å‘è§†å›¾æ·»åŠ äº¤äº’çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ‰‹åŠ¿è¯†åˆ«ã€‚æ³¨æ„å®ƒä»¬å¯¹ responders å¹¶ä¸èµ·ä½œç”¨ï¼Œè€Œåªå¯¹è§†å›¾åŠå…¶å­ç±»å¥æ•ˆã€‚ UIControl(äº¤äº’æ§ä»¶)UIControl å»ºç«‹åœ¨è§†å›¾ä¸Šï¼Œå¢åŠ äº†æ›´å¤šçš„äº¤äº’æ”¯æŒã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¢åŠ äº† target / action æ¨¡å¼ã€‚çœ‹ä¸€ä¸‹å…·ä½“çš„å­ç±»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æŒ‰é’®ï¼Œæ—¥æœŸé€‰æ‹©å™¨ (Date pickers)ï¼Œæ–‡æœ¬æ¡†ç­‰ç­‰ã€‚åˆ›å»ºäº¤äº’æ§ä»¶æ—¶ï¼Œä½ é€šå¸¸æƒ³è¦å­ç±»åŒ–ä¸€ä¸ª UIControlã€‚ä¸€äº›å¸¸è§çš„åƒ bar buttons (è™½ç„¶ä¹Ÿæ”¯æŒ target / action) å’Œ text view (è¿™é‡Œéœ€è¦ä½ ä½¿ç”¨ä»£ç†æ¥è·å¾—é€šçŸ¥) çš„ç±»å…¶å®å¹¶ä¸æ˜¯ UIControlã€‚ æ¸²æŸ“ç°åœ¨ï¼Œæˆ‘ä»¬è½¬å‘å¯è§éƒ¨åˆ†ï¼šè‡ªå®šä¹‰æ¸²æŸ“ã€‚æ­£å¦‚ Daniel åœ¨ä»–çš„æ–‡ç« ä¸­æåˆ°çš„ï¼Œä½ å¯èƒ½æƒ³é¿å…åœ¨ CPU ä¸Šåšæ¸²æŸ“è€Œå°†å…¶ä¸¢ç»™ GPUã€‚è¿™é‡Œæœ‰ä¸€æ¡ç»éªŒï¼šå°½é‡é¿å… drawRect:ï¼Œä½¿ç”¨ç°æœ‰çš„è§†å›¾æ„å»ºè‡ªå®šä¹‰è§†å›¾ã€‚é€šå¸¸æœ€å¿«é€Ÿçš„æ¸²æŸ“æ–¹æ³•æ˜¯ä½¿ç”¨å›¾ç‰‡è§†å›¾ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³ç”»ä¸€ä¸ªå¸¦æœ‰è¾¹æ¡†çš„åœ†å½¢å¤´åƒï¼Œåƒä¸‹é¢å›¾ç‰‡ä¸­è¿™æ ·:ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬ç”¨ä»¥ä¸‹çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå›¾ç‰‡è§†å›¾çš„å­ç±»:1234567// called from initializer- (void)setupView &#123; self.clipsToBounds = YES; self.layer.cornerRadius = self.bounds.size.width / 2; self.layer.borderWidth = 3; self.layer.borderColor = [UIColor darkGrayColor].CGColor;&#125;æˆ‘é¼“åŠ±å„ä½è¯»è€…æ·±å…¥äº†è§£ CALayer åŠå…¶å±æ€§ï¼Œå› ä¸ºä½ ç”¨å®ƒèƒ½å®ç°çš„å¤§å¤šæ•°äº‹æƒ…ä¼šæ¯”ç”¨ Core Graphics è‡ªå·±ç”»è¦å¿«ã€‚ç„¶è€Œä¸€å¦‚æ—¢å¾€ï¼Œç›‘æµ‹è‡ªå·±çš„ä»£ç çš„æ€§èƒ½æ˜¯ååˆ†é‡è¦çš„ã€‚æŠŠå¯æ‹‰ä¼¸çš„å›¾ç‰‡å’Œå›¾ç‰‡è§†å›¾ä¸€èµ·ä½¿ç”¨ä¹Ÿå¯ä»¥æå¤§çš„æé«˜æ•ˆç‡ã€‚åœ¨ Taming UIButton è¿™ä¸ªå¸–å­ä¸­ï¼ŒReda Lemeden æ¢ç´¢äº†å‡ ç§ä¸åŒçš„ç»˜å›¾æ–¹æ³•ã€‚åœ¨æ–‡ç« ç»“å°¾å¤„æœ‰ä¸€ä¸ªå¾ˆæœ‰ä»·å€¼çš„æ¥è‡ª UIKit å›¢é˜Ÿçš„å·¥ç¨‹å¸ˆ Andy Matuschak çš„å›å¤ï¼Œè§£é‡Šäº†å¯æ‹‰ä¼¸å›¾ç‰‡æ˜¯è¿™äº›æŠ€æœ¯ä¸­æœ€å¿«çš„ã€‚åŸå› æ˜¯å¯æ‹‰ä¼¸å›¾ç‰‡åœ¨ CPU å’Œ GPU ä¹‹é—´çš„æ•°æ®è½¬ç§»é‡æœ€å°ï¼Œå¹¶ä¸”è¿™äº›å›¾ç‰‡çš„ç»˜åˆ¶æ˜¯ç»è¿‡é«˜åº¦ä¼˜åŒ–çš„ã€‚å¤„ç†å›¾ç‰‡æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®© GPU ä¸ºä½ å·¥ä½œæ¥ä»£æ›¿ä½¿ç”¨ Core Graphicsã€‚ä½¿ç”¨ Core Imageï¼Œä½ ä¸å¿…ç”¨ CPU åšä»»ä½•çš„å·¥ä½œå°±å¯ä»¥åœ¨å›¾ç‰‡ä¸Šå»ºç«‹å¤æ‚çš„æ•ˆæœã€‚ä½ å¯ä»¥ç›´æ¥åœ¨ OpenGL ä¸Šä¸‹æ–‡ä¸Šç›´æ¥æ¸²æŸ“ï¼Œæ‰€æœ‰çš„å·¥ä½œéƒ½åœ¨ GPU ä¸Šå®Œæˆã€‚ è‡ªå®šä¹‰ç»˜åˆ¶å¦‚æœå†³å®šäº†é‡‡ç”¨è‡ªå®šä¹‰ç»˜åˆ¶ï¼Œæœ‰å‡ ç§ä¸åŒçš„é€‰é¡¹å¯ä¾›é€‰æ‹©ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥ç”Ÿæˆä¸€å¼ å›¾ç‰‡å¹¶åœ¨å†…å­˜å’Œç£ç›˜ä¸Šç¼“å­˜èµ·æ¥ã€‚å¦‚æœå†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œä¹Ÿè®¸ä½ å¯ä»¥ä½¿ç”¨ Core Animationï¼Œå¦‚æœè¿˜æ˜¯è¡Œä¸é€šï¼Œä½¿ç”¨ Core Graphicsã€‚å¦‚æœä½ çœŸçš„æƒ³è¦æ¥è¿‘åº•å±‚ï¼Œä½¿ç”¨ GLKit å’ŒåŸç”Ÿ OpenGL ä¹Ÿä¸æ˜¯é‚£ä¹ˆéš¾ï¼Œä½†æ˜¯éœ€è¦åšå¾ˆå¤šå·¥ä½œã€‚å¦‚æœä½ çœŸçš„é€‰æ‹©äº†é‡å†™ drawRect:ï¼Œç¡®ä¿æ£€æŸ¥å†…å®¹æ¨¡å¼ã€‚é»˜è®¤çš„æ¨¡å¼æ˜¯å°†å†…å®¹ç¼©æ”¾ä»¥å¡«å……è§†å›¾çš„èŒƒå›´ï¼Œè¿™åœ¨å½“è§†å›¾çš„ frame æ”¹å˜æ—¶å¹¶ä¸ä¼šé‡æ–°ç»˜åˆ¶ã€‚ è‡ªå®šä¹‰äº¤äº’è‡ªå®šä¹‰æ§ä»¶çš„æ—¶å€™ï¼Œä½ å‡ ä¹ä¸€å®šä¼šæ‰©å±•ä¸€ä¸ª UIControl çš„å­ç±»ã€‚åœ¨ä½ çš„å­ç±»é‡Œï¼Œå¯ä»¥ä½¿ç”¨ target action æœºåˆ¶è§¦å‘äº‹ä»¶ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­:1[self sendActionsForControlEvents:UIControlEventValueChanged];ä¸ºäº†å“åº”è§¦æ‘¸ï¼Œä½ å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨æ‰‹åŠ¿è¯†åˆ«ã€‚ç„¶è€Œå¦‚æœæƒ³è¦æ›´æ¥è¿‘åº•å±‚ï¼Œä»ç„¶å¯ä»¥é‡å†™ touchesBeganï¼Œ touchesMoved å’Œ touchesEnded æ–¹æ³•æ¥è®¿é—®åŸå§‹çš„è§¦æ‘¸è¡Œä¸ºã€‚ä½†è™½è¯´å¦‚æ­¤ï¼Œåˆ›å»ºä¸€ä¸ªæ‰‹åŠ¿è¯†åˆ«çš„å­ç±»æ¥æŠŠæ‰‹åŠ¿å¤„ç†ç›¸å…³çš„é€»è¾‘ä»ä½ çš„è§†å›¾æˆ–è€…è§†å›¾æ§åˆ¶å™¨ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯ä¸€ç§æ›´åˆé€‚çš„æ–¹å¼ã€‚åˆ›å»ºè‡ªå®šä¹‰æ§ä»¶æ—¶æ‰€é¢å¯¹çš„ä¸€ä¸ªæ™®éçš„è®¾è®¡é—®é¢˜æ˜¯å‘æ‹¥æœ‰å®ƒä»¬çš„ç±»ä¸­å›ä¼ è¿”å›å€¼ã€‚æ¯”å¦‚ï¼Œå‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªç»˜åˆ¶äº¤äº’é¥¼çŠ¶å›¾çš„è‡ªå®šä¹‰æ§ä»¶ï¼Œæƒ³çŸ¥é“ç”¨æˆ·ä½•æ—¶é€‰æ‹©äº†å…¶ä¸­ä¸€ä¸ªéƒ¨åˆ†ã€‚ä½ å¯ä»¥ç”¨å¾ˆå¤šç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚é€šè¿‡ target action æ¨¡å¼ï¼Œä»£ç†ï¼Œblock æˆ–è€… KVOï¼Œç”šè‡³é€šçŸ¥ã€‚ ä½¿ç”¨ Target-Actioné€šå¸¸ä¹Ÿæ˜¯æœ€æ–¹ä¾¿çš„åšæ³•æ˜¯ä½¿ç”¨ target-actionã€‚åœ¨ç”¨æˆ·é€‰æ‹©åä½ å¯ä»¥åœ¨è‡ªå®šä¹‰çš„è§†å›¾ä¸­åšç±»ä¼¼è¿™æ ·çš„äº‹æƒ…:1[self sendActionsForControlEvents:UIControlEventValueChanged];å¦‚æœæœ‰ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨åœ¨ç®¡ç†è¿™ä¸ªè§†å›¾ï¼Œéœ€è¦è¿™æ ·åš:123456789- (void)setupPieChart &#123; [self.pieChart addTarget:self action:@selector(updateSelection:) forControlEvents:UIControlEventValueChanged];&#125;- (void)updateSelection:(id)sender&#123; NSLog(@\"%@\", self.pieChart.selectedSector);&#125;è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯åœ¨è‡ªå®šä¹‰è§†å›¾å­ç±»ä¸­éœ€è¦åšçš„äº‹æƒ…å¾ˆå°‘ï¼Œå¹¶ä¸”è‡ªåŠ¨è·å¾—å¤šç›®æ ‡æ”¯æŒ ä½¿ç”¨ä»£ç†å¦‚æœä½ éœ€è¦æ›´å¤šçš„æ§åˆ¶ä»è§†å›¾å‘é€åˆ°è§†å›¾æ§åˆ¶å™¨çš„æ¶ˆæ¯ï¼Œé€šå¸¸ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚åœ¨æˆ‘ä»¬çš„é¥¼çŠ¶å›¾ä¸­ï¼Œä»£ç çœ‹èµ·æ¥å¤§æ¦‚æ˜¯è¿™æ ·:1[self.delegate pieChart:self didSelectSector:self.selectedSector];åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œä½ è¦å†™å¦‚ä¸‹ä»£ç :123456789@interface MyViewController &lt;PieChartDelegate&gt; ...- (void)setupPieChart&#123; self.pieChart.delegate = self;&#125;- (void)pieChart:(PieChart*)pieChart didSelectSector:(PieChartSector*)sector&#123; // å¤„ç†åŒºå—&#125;å½“ä½ æƒ³è¦åšæ›´å¤šå¤æ‚çš„å·¥ä½œè€Œä¸ä»…ä»…æ˜¯é€šçŸ¥æ‰€æœ‰è€…å€¼å‘ç”Ÿäº†å˜åŒ–æ—¶ï¼Œè¿™ä¹ˆåšæ˜¾ç„¶æ›´åˆé€‚ã€‚ä¸è¿‡è™½ç„¶å¤§å¤šæ•°å¼€å‘äººå‘˜å¯ä»¥éå¸¸å¿«é€Ÿçš„å®ç°è‡ªå®šä¹‰ä»£ç†ï¼Œä½†è¿™ç§æ–¹å¼ä»ç„¶æœ‰ä¸€äº›ç¼ºç‚¹ï¼šä½ å¿…é¡»æ£€æŸ¥ä»£ç†æ˜¯å¦å®ç°äº†ä½ æƒ³è¦è°ƒç”¨çš„æ–¹æ³• (ä½¿ç”¨ respondsToSelector:)ï¼Œæœ€é‡è¦çš„ï¼Œé€šå¸¸ä½ åªæœ‰ä¸€ä¸ªä»£ç† (æˆ–è€…éœ€è¦åˆ›å»ºä¸€ä¸ªä»£ç†æ•°ç»„)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦è§†å›¾æ‰€æœ‰è€…å’Œè§†å›¾ä¹‹é—´çš„é€šä¿¡å˜å¾—ç¨å¾®å¤æ‚ï¼Œæˆ‘ä»¬å‡ ä¹æ€»æ˜¯ä¼šé‡‡å–è¿™ç§æ¨¡å¼ã€‚ ä½¿ç”¨ Blockå¦ä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨ blockã€‚å†ä¸€æ¬¡ç”¨é¥¼çŠ¶å›¾ä¸¾ä¾‹ï¼Œä»£ç çœ‹èµ·æ¥å¤§æ¦‚æ˜¯è¿™æ ·:123@interface PieChart : UIControl @property (nonatomic,copy) void(^selectionHandler)(PieChartSection* selectedSection); @endåœ¨é€‰å–è¡Œä¸ºçš„ä»£ç ä¸­ï¼Œä½ åªéœ€è¦æ‰§è¡Œå®ƒã€‚åœ¨æ­¤ä¹‹å‰æ£€æŸ¥ä¸€ä¸‹blockæ˜¯å¦è¢«èµ‹å€¼éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œä¸€ä¸ªæœªè¢«èµ‹å€¼çš„ block ä¼šä½¿ç¨‹åºå´©æºƒã€‚123if (self.selectionHandler != NULL) &#123; self.selectionHandler(self.selectedSection);&#125;è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æŠŠç›¸å…³çš„ä»£ç æ•´åˆåœ¨è§†å›¾æ§åˆ¶å™¨ä¸­:12345- (void)setupPieChart &#123; self.pieChart.selectionHandler = ^(PieChartSection* section) &#123; // å¤„ç†åŒºå— &#125;&#125;å°±åƒä»£ç†ï¼Œæ¯ä¸ªåŠ¨ä½œé€šå¸¸åªæœ‰ä¸€ä¸ª blockã€‚å¦ä¸€ä¸ªé‡è¦çš„é™åˆ¶æ˜¯ä¸è¦å½¢æˆå¼•ç”¨å¾ªç¯ã€‚å¦‚æœä½ çš„è§†å›¾æ§åˆ¶å™¨æŒæœ‰é¥¼çŠ¶å›¾çš„å¼ºå¼•ç”¨ï¼Œé¥¼çŠ¶å›¾æŒæœ‰ blockï¼Œblock åˆæŒæœ‰è§†å›¾æ§åˆ¶å™¨ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªå¼•ç”¨å¾ªç¯ã€‚åªè¦åœ¨ block ä¸­å¼•ç”¨ self å°±ä¼šé€ æˆè¿™ä¸ªé”™è¯¯ã€‚æ‰€ä»¥é€šå¸¸ä»£ç ä¼šå†™æˆè¿™ä¸ªæ ·å­ï¼š12345__weak id weakSelf = self;self.pieChart.selectionHandler = ^(PieChartSection* section) &#123; MyViewController* strongSelf = weakSelf; [strongSelf handleSectionChange:section];&#125;ä¸€æ—¦ block ä¸­çš„ä»£ç è¦å¤±å»æ§åˆ¶ (æ¯”å¦‚ block ä¸­è¦å¤„ç†çš„äº‹æƒ…å¤ªå¤šï¼Œå¯¼è‡´ block ä¸­çš„ä»£ç è¿‡å¤š)ï¼Œä½ è¿˜åº”è¯¥å°†å®ƒä»¬æŠ½ç¦»æˆç‹¬ç«‹çš„æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µçš„è¯å¯èƒ½ç”¨ä»£ç†ä¼šæ›´å¥½ä¸€äº›ã€‚ ä½¿ç”¨ KVOå¦‚æœå–œæ¬¢ KVOï¼Œä½ ä¹Ÿå¯ä»¥ç”¨å®ƒæ¥è§‚å¯Ÿã€‚è¿™æœ‰ä¸€ç‚¹ç¥å¥‡è€Œä¸”æ²¡é‚£ä¹ˆç›´æ¥ï¼Œä½†å½“åº”ç”¨ä¸­å·²ç»ä½¿ç”¨ï¼Œå®ƒæ˜¯å¾ˆå¥½çš„è§£è€¦è®¾è®¡æ¨¡å¼ã€‚åœ¨é¥¼çŠ¶å›¾ç±»ä¸­ï¼Œç¼–å†™ä»£ç :1self.selectedSegment = theNewSelectedSegment;å½“ä½¿ç”¨åˆæˆå±æ€§ï¼ŒKVO ä¼šæ‹¦æˆªåˆ°è¯¥å˜åŒ–å¹¶å‘å‡ºé€šçŸ¥ã€‚åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œç¼–å†™ç±»ä¼¼çš„ä»£ç :12345678- (void)setupPieChart&#123; [self.pieChart addObserver:self forKeyPath:@\"selectedSegment\" options:0 context:NULL];&#125;- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context &#123; if(object == self.pieChart &amp;&amp; [keyPath isEqualToString:@\"selectedSegment\"]) &#123; // å¤„ç†æ”¹å˜ &#125;&#125;æ ¹æ®ä½ çš„éœ€è¦ï¼Œåœ¨ viewWillDisappear: æˆ– dealloc ä¸­ï¼Œè¿˜éœ€è¦ç§»é™¤è§‚å¯Ÿè€…ã€‚å¯¹åŒä¸€ä¸ªå¯¹è±¡è®¾ç½®å¤šä¸ªè§‚å¯Ÿè€…å¾ˆå®¹æ˜“é€ æˆæ··ä¹±ã€‚æœ‰ä¸€äº›æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ ReactiveCocoa æˆ–è€…æ›´è½»é‡çº§çš„ THObserversAndBindersã€‚ ä½¿ç”¨é€šçŸ¥ä½œä¸ºæœ€åä¸€ä¸ªé€‰æ‹©ï¼Œå¦‚æœä½ æƒ³è¦ä¸€ä¸ªéå¸¸æ¾æ•£çš„è€¦åˆï¼Œå¯ä»¥ä½¿ç”¨é€šçŸ¥æ¥ä½¿å…¶ä»–å¯¹è±¡å¾—çŸ¥å˜åŒ–ã€‚å¯¹äºé¥¼çŠ¶å›¾æ¥è¯´ä½ å‡ ä¹è‚¯å®šä¸æƒ³è¿™æ ·ï¼Œä¸è¿‡ä¸ºäº†è®²è§£çš„å®Œæ•´ï¼Œè¿™é‡Œä»‹ç»å¦‚ä½•å»åšã€‚åœ¨é¥¼çŠ¶å›¾çš„çš„å¤´æ–‡ä»¶ä¸­ï¼š1extern NSString* const SelectedSegmentChangedNotification;åœ¨å®ç°æ–‡ä»¶ä¸­ï¼š12345NSString* const SelectedSegmentChangedNotification = @\"selectedSegmentChangedNotification\";...- (void)notifyAboutChanges&#123; [[NSNotificationCenter defaultCenter] postNotificationName:SelectedSegmentChangedNotification object:self];&#125;ç°åœ¨è®¢é˜…é€šçŸ¥ï¼Œåœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼š123456789- (void)setupPieChart&#123; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(segmentChanged:) name:SelectedSegmentChangedNotification object:self.pieChart];&#125;- (void)segmentChanged:(NSNotification*)note&#123;&#125;å½“æ·»åŠ äº†è§‚å¯Ÿè€…ï¼Œä½ å¯ä»¥ä¸å°†é¥¼çŠ¶å›¾ä½œä¸ºå‚æ•° objectï¼Œè€Œæ˜¯ä¼ é€’ nilï¼Œä»¥æ¥æ”¶æ‰€æœ‰é¥¼çŠ¶å›¾å¯¹è±¡å‘å‡ºçš„é€šçŸ¥ã€‚å°±åƒ KVO é€šçŸ¥ï¼Œä½ ä¹Ÿéœ€è¦åœ¨æ°å½“çš„åœ°æ–¹é€€è®¢è¿™äº›é€šçŸ¥ã€‚è¿™é¡¹æŠ€æœ¯çš„å¥½å¤„æ˜¯å®Œå…¨çš„è§£è€¦ã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å¤±å»äº†ç±»å‹å®‰å…¨ï¼Œå› ä¸ºåœ¨å›è°ƒä¸­ä½ å¾—åˆ°çš„æ˜¯ä¸€ä¸ªé€šçŸ¥å¯¹è±¡ï¼Œè€Œä¸åƒä»£ç†ï¼Œç¼–è¯‘å™¨æ— æ³•æ£€æŸ¥é€šçŸ¥å‘é€è€…å’Œæ¥å—è€…ä¹‹é—´çš„ç±»å‹æ˜¯å¦åŒ¹é…ã€‚ è¾…åŠ©åŠŸèƒ½ (Accessibility)è‹¹æœå®˜æ–¹æä¾›çš„æ ‡å‡† iOS æ§ä»¶å‡æœ‰è¾…åŠ©åŠŸèƒ½ã€‚è¿™ä¹Ÿæ˜¯æ¨èç”¨æ ‡å‡†æ§ä»¶åˆ›å»ºè‡ªå®šä¹‰æ§ä»¶çš„å¦ä¸€ä¸ªåŸå› ã€‚è¿™æˆ–è®¸å¯ä»¥ä½œä¸ºä¸€æ•´æœŸçš„ä¸»é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³ç¼–å†™è‡ªå®šä¹‰è§†å›¾ï¼ŒAccessibility Programming Guide è¯´æ˜äº†å¦‚ä½•åˆ›å»ºè¾…åŠ©æ§åˆ¶å™¨ã€‚æœ€ä¸ºå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè§†å›¾ä¸­æœ‰å¤šä¸ªéœ€è¦è¾…åŠ©åŠŸèƒ½çš„å…ƒç´ ï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯è¯¥è§†å›¾çš„å­è§†å›¾ï¼Œä½ å¯ä»¥è®©è§†å›¾å®ç° UIAccessibilityContainer åè®®ã€‚å¯¹äºæ¯ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæè¿°å®ƒçš„ UIAccessibilityElement å¯¹è±¡ã€‚ æœ¬åœ°åŒ–åˆ›å»ºè‡ªå®šä¹‰è§†å›¾æ—¶ï¼Œæœ¬åœ°åŒ–ä¹ŸåŒæ ·é‡è¦ã€‚åƒè¾…åŠ©åŠŸèƒ½ä¸€æ ·ï¼Œè¿™ä¸ªå¯ä»¥ä½œä¸ºä¸€æ•´æœŸçš„è¯é¢˜ã€‚æœ¬åœ°åŒ–è‡ªå®šä¹‰è§†å›¾çš„æœ€ç›´æ¥å·¥ä½œå°±æ˜¯å­—ç¬¦ä¸²å†…å®¹ã€‚å¦‚æœä½¿ç”¨ NSStringï¼Œä½ ä¸å¿…æ‹…å¿ƒç¼–ç é—®é¢˜ã€‚å¦‚æœåœ¨è‡ªå®šä¹‰è§†å›¾ä¸­å±•ç¤ºæ—¥æœŸæˆ–æ•°å­—ï¼Œä½¿ç”¨æ—¥æœŸå’Œæ•°å­—æ ¼å¼åŒ–ç±»æ¥å±•ç¤ºå®ƒä»¬ã€‚ä½¿ç”¨ NSLocalizedString æœ¬åœ°åŒ–å­—ç¬¦ä¸²ã€‚å¦ä¸€ä¸ªæœ¬åœ°åŒ–è¿‡ç¨‹ä¸­å¾ˆæœ‰ç”¨çš„å·¥å…·æ˜¯ Auto Layoutã€‚ä¾‹å¦‚ï¼Œæœ‰åœ¨è‹±æ–‡ä¸­å¾ˆçŸ­çš„è¯åœ¨å¾·è¯­ä¸­å¯èƒ½ä¼šå¾ˆé•¿ã€‚å¦‚æœæ ¹æ®è‹±æ–‡å•è¯çš„é•¿åº¦å¯¹è§†å›¾çš„å°ºå¯¸åšç¡¬ç¼–ç ï¼Œé‚£ä¹ˆå½“ç¿»è¯‘æˆå¾·æ–‡çš„æ—¶å€™å‡ ä¹ä¸€å®šä¼šé‡ä¸Šéº»çƒ¦ã€‚é€šè¿‡ä½¿ç”¨ Auto Layoutï¼Œè®©æ ‡ç­¾æ§ä»¶è‡ªåŠ¨è°ƒæ•´ä¸ºå†…å®¹çš„å°ºå¯¸ï¼Œå¹¶å‘ä¾èµ–å…ƒç´ æ·»åŠ ä¸€äº›å…¶ä»–çš„é™åˆ¶ä»¥ç¡®ä¿é‡æ–°è®¾ç½®å°ºå¯¸ï¼Œä½¿è¿™é¡¹å·¥ä½œå˜å¾—éå¸¸ç®€å•ã€‚è‹¹æœä¸ºæ­¤æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»ã€‚å¦å¤–ï¼Œå¯¹äºç±»ä¼¼å¸Œä¼¯æ¥è¯­è¿™ç§é¡ºåºä»å³åˆ°å·¦çš„è¯­è¨€ï¼Œå¦‚æœä½ ä½¿ç”¨äº† leading å’Œ trailing å±æ€§ï¼Œæ•´ä¸ªè§†å›¾ä¼šè‡ªåŠ¨æŒ‰ç…§ä»å³åˆ°å·¦çš„é¡ºåºå±•ç¤ºï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„ä»å·¦è‡³å³ã€‚ æµ‹è¯•æœ€åï¼Œè®©æˆ‘ä»¬è€ƒè™‘æµ‹è¯•è§†å›¾çš„é—®é¢˜ã€‚å¯¹äºå•å…ƒæµ‹è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ Xcode è‡ªå¸¦çš„å·¥å…·æˆ–è€…å…¶å®ƒç¬¬ä¸‰æ–¹æ¡†æ¶ã€‚å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ UIAutomation æˆ–è€…å…¶å®ƒåŸºäºå®ƒçš„å·¥å…·ã€‚ä¸ºæ­¤ï¼Œä½ çš„è§†å›¾å®Œå…¨æ”¯æŒè¾…åŠ©åŠŸèƒ½æ˜¯å¿…è¦çš„ã€‚UIAutomation å¹¶æœªå……åˆ†å¾—åˆ°åˆ©ç”¨çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯æˆªå›¾ï¼›ä½ å¯ä»¥ç”¨å®ƒè‡ªåŠ¨å¯¹æ¯”è§†å›¾å’Œè®¾è®¡ä»¥ç¡®ä¿ä¸¤è€…æ¯ä¸€ä¸ªåƒç´ éƒ½åˆ†æ¯«ä¸å·®ã€‚(æ’ä¸€ä¸ªæ— å…³çš„å°æç¤ºï¼šä½ è¿˜å¯ä»¥ä½¿ç”¨å®ƒæ¥ä¸ºåº”ç”¨ä¸Šæ¶ App Store è‡ªåŠ¨ç”Ÿæˆæˆªå›¾ï¼Œè¿™åœ¨ä½ æœ‰å¤šä¸ªå¤šå›½è¯­è¨€çš„åº”ç”¨æ—¶ä¼šç‰¹åˆ«æœ‰ç”¨)ã€‚å¼•ç”¨è‡ªå®šä¹‰æ§ä»¶","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]},{"title":"iOS è®¾å¤‡å°ºå¯¸è¡¨","date":"2016-11-30T23:25:43.000Z","path":"2016/12/01/è®¾å¤‡å°ºå¯¸/","text":"å°ºå¯¸è¦æ±‚Apple Docå±å¹•å°ºå¯¸æ¨ªå±å¿«ç…§å°ºå¯¸ç«–å±å¿«ç…§å°ºå¯¸3.5å¯¸960 * 640640*9604å¯¸1136*640640*11364.7å¯¸1334*750750*13345.5å¯¸2208*12421242*22085.8å¯¸2436*11251125*24369.7å¯¸(iPad)1024*768768*102412.9å¯¸(iPad)2732*20482048*2732iTunesConnect ä¸Šæ¶å¯ä½¿ç”¨ é«˜å°ºå¯¸ä»£æ›¿ä½å°ºå¯¸","tags":[{"name":"iOS","slug":"iOS","permalink":"https://changzw.github.io/tags/iOS/"}],"categories":[{"name":"iOS Programming","slug":"iOS-Programming","permalink":"https://changzw.github.io/categories/iOS-Programming/"}]}]}