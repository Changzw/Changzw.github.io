<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SnapKit åˆ†æ</title>
      <link href="/2020/04/10/source-code/SnapKit-%E5%88%86%E6%9E%90/"/>
      <url>/2020/04/10/source-code/SnapKit-%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>å¯¹åº” <a href="https://changzw.github.io/2017/06/01/source-code/Masonry-%E5%88%86%E6%9E%90/">Masonry æºç åˆ†æ</a>, çœ‹è¿™ç¯‡æ–‡ç« å‰æœ€å¥½å…ˆçœ‹çœ‹è¿™ç¯‡</p><p>ï¼ˆDSL å…¶å®æ˜¯ Domain Specific Language çš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰</p><p>åˆ†ææºç ï¼š</p><ol><li>è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>éœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†</li><li>æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„</li><li>ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„</li><li>æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹</li><li>ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿ</li></ol><h2 id="snapkit-æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#snapkit-æ˜¯ä»€ä¹ˆ"></a> <code>SnapKit</code> æ˜¯ä»€ä¹ˆ</h2><p><a href="https://github.com/SnapKit/SnapKit" target="_blank" rel="noopener">SnapKit æºç åœ°å€</a></p><h2 id="ä¸ºä»€ä¹ˆè¦è®¾è®¡-snapkit"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆè¦è®¾è®¡-snapkit"></a> ä¸ºä»€ä¹ˆè¦è®¾è®¡ <code>SnapKit</code></h2><p>é¦–å…ˆå’Œç³»ç»Ÿæä¾›æ¥å£å¯¹æ¯”ä¸‹</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">label.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> constraint1 = <span class="type">NSLayoutConstraint</span>.<span class="keyword">init</span>(item: label,</span><br><span class="line">                                          attribute: .<span class="keyword">left</span>,</span><br><span class="line">                                          relatedBy: .<span class="built_in">equal</span>,</span><br><span class="line">                                          toItem: view,</span><br><span class="line">                                          attribute: .<span class="keyword">left</span>,</span><br><span class="line">                                          multiplier: <span class="number">1</span>,</span><br><span class="line">                                          constant: <span class="number">150</span>);</span><br><span class="line">constraint1.isActive = <span class="literal">true</span></span><br><span class="line">... top, width</span><br><span class="line"><span class="keyword">let</span> constraint4 = <span class="type">NSLayoutConstraint</span>.<span class="keyword">init</span>(item: label,</span><br><span class="line">                                          attribute: .height,</span><br><span class="line">                                          relatedBy: .<span class="built_in">equal</span>,</span><br><span class="line">                                          toItem: view,</span><br><span class="line">                                          attribute: .notAnAttribute,</span><br><span class="line">                                          multiplier: <span class="number">1</span>,</span><br><span class="line">                                          constant: <span class="number">20</span>);</span><br><span class="line">constraint4.isActive = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>Anchor: åªæ”¯æŒ ios &gt;= 9</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">label.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line"><span class="type">NSLayoutConstraint</span>.activate([</span><br><span class="line">  label.leftAnchor.constraint(equalTo: view.leftAnchor, constant: <span class="number">150</span>),</span><br><span class="line">  label.topAnchor.constraint(equalTo: view.topAnchor, constant: <span class="number">200</span>),</span><br><span class="line">  label.widthAnchor.constraint(equalToConstant: <span class="number">200</span>),</span><br><span class="line">  label.heightAnchor.constraint(equalToConstant: <span class="number">200</span>),</span><br><span class="line">])</span><br></pre></td></tr></table></figure><p><span id="code1"></span></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">label.snp.makeConstraints &#123; (make) <span class="keyword">in</span></span><br><span class="line">  make.<span class="keyword">left</span>.equalTo(view).offset(<span class="number">150</span>)</span><br><span class="line">  make.top.equalToSuperview().offset(<span class="number">200</span>)</span><br><span class="line">  make.size.equalTo(<span class="type">CGSize</span>(width: <span class="number">200</span>, height: <span class="number">20</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>P.S. SnapKit å†…éƒ¨ä¼šå¸®ä½ è°ƒç”¨ view.translatesAutoresizingMaskIntoConstraints = true</p><p>SnapKit è®¾è®¡çš„ç›®çš„ï¼Œå°±æ˜¯ä»¥é“¾å¼ç¼–ç¨‹æ‰‹æ®µå°è£… <code>NSLayoutConstraint</code> å†—ä½™ä»£ç ï¼</p><ol><li>å¦‚ä½•å¤„ç†åŸæ¥ç¹æ‚æ¥å£</li><li>å¦‚ä½•å®ç°é“¾å¼</li><li>å¦‚ä½•å°è£… <code>NSLayoutConstraint</code> çš„</li><li>å¦‚ä½•æŠŠå¤šä¸ª <code>NSLayoutConstraint</code> å°è£…æˆç®€å•çš„ä¸€å¥æå®šçš„</li><li>ä½¿ç”¨äº†ä½•ç§ç¼–ç¨‹æ‰‹æ®µ</li></ol><hr><h2 id="snapkit-ä»£ç ç»“æ„åˆ†æ"><a class="markdownIt-Anchor" href="#snapkit-ä»£ç ç»“æ„åˆ†æ"></a> <code>SnapKit</code> ä»£ç ç»“æ„åˆ†æ</h2><h3 id="ä»è°ƒç”¨å±‚æ¬¡åˆ†æ"><a class="markdownIt-Anchor" href="#ä»è°ƒç”¨å±‚æ¬¡åˆ†æ"></a> ä»è°ƒç”¨å±‚æ¬¡åˆ†æ</h3><p>è¿™é‡Œæˆ‘è¦åƒæ´‹è‘±ä¸€æ ·ä¸€å±‚ä¸€å±‚çš„æ‹¨å¼€</p><ol><li>æœ€å¤–å±‚æ¥å£<br>æ ¹æ®è¿™æ®µä»£ç åˆ†æ</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">label.snp.makeConstraints &#123; (make) <span class="keyword">in</span></span><br><span class="line">  make.<span class="keyword">left</span>.equalTo(view).offset(<span class="number">150</span>)</span><br><span class="line">  make.size.equalTo(<span class="type">CGSize</span>(width: <span class="number">200</span>, height: <span class="number">20</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConstraintMaker.swift</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintMaker</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">ConstraintMakerExtendable</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> top: <span class="type">ConstraintMakerExtendable</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> bottom: <span class="type">ConstraintMakerExtendable</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">ConstraintMakerExtendable</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">prepareConstraints</span><span class="params">(item: LayoutConstraintItem, closure: <span class="params">(<span class="number">_</span> make: ConstraintMaker)</span></span></span> -&gt; <span class="type">Void</span>) -&gt; [<span class="type">Constraint</span>]</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">makeConstraints</span><span class="params">(item: LayoutConstraintItem, closure: <span class="params">(<span class="number">_</span> make: ConstraintMaker)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">remakeConstraints</span><span class="params">(item: LayoutConstraintItem, closure: <span class="params">(<span class="number">_</span> make: ConstraintMaker)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">(item: LayoutConstraintItem, closure: <span class="params">(<span class="number">_</span> make: ConstraintMaker)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ğŸ‘†æºç å¯ä»¥çœ‹åˆ°</p><ul><li>ä¸‰ä¸ªè§åçŸ¥æ„çš„æ–¹æ³•</li><li>æ–¹æ³•å‚æ•° <code>ConstraintMaker</code> è¿™ä¸ªå°±æ˜¯ make</li><li>å±æ€§ <code>ConstraintMakerExtendable</code> è¿™ä¸ªå°±æ˜¯ make åé¢çš„ make.left</li></ul><p>æˆ‘æƒ³çŸ¥é“ï¼Œä»–çš„é“¾å¼æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¦‚ä½•å°è£… autolayout ç›¸å…³çš„æ•°æ®çš„ï¼Œç›®å‰çœ‹åˆ°çš„åªæ˜¯å¹³å¸¸ä½¿ç”¨çš„æ¥å£<br>æˆ‘è¿˜è¦æ‰¾åˆ° ä¸‹å›¾çš„è¿™äº›ä¿¡æ¯<br><img src="/img/view_formula.jpeg" alt="view formula"></p><ol start="2"><li>æ¥ç€å¾€é‡Œé¢çœ‹</li></ol><ul><li><code>ConstraintMakerExtendable</code> ç»§æ‰¿è‡ª <code>ConstraintMakerRelatable</code></li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintMakerExtendable</span> : <span class="title">ConstraintMakerRelatable</span>  </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">ConstraintMakerExtendable</span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.description.attributes += .<span class="keyword">left</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> top: <span class="type">ConstraintMakerExtendable</span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.description.attributes += .top</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> bottom: <span class="type">ConstraintMakerExtendable</span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.description.attributes += .bottom</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">ConstraintMakerExtendable</span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.description.attributes += .<span class="keyword">right</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure><ul><li><p>é—®é¢˜&amp;çŒœæµ‹ï¼š</p><ul><li><code>description</code> æ˜¯å•¥ï¼Ÿä¸çŸ¥é“</li><li>ä¸è¿‡ä»–æœ‰ <code>attributes</code> å±æ€§ï¼Œçœ‹æ ·å­å¯¹åº” <code>NSLayoutConstraint.Attribute</code></li><li>left, top â€¦â€¦ è¿™äº›éƒ½è¿”å› <code>ConstraintMakerExtendable</code> ï¼ŒçŒœæµ‹ä»–æ˜¯é“¾çš„èŠ‚ç‚¹å¯¹è±¡</li></ul></li><li><p>ç»§ç»­çœ‹ <code>ConstraintMakerRelatable</code></p></li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintMakerRelatable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> description: <span class="type">ConstraintDescription</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(<span class="number">_</span> description: <span class="type">ConstraintDescription</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.description = description</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">relatedTo</span><span class="params">(<span class="number">_</span> other: ConstraintRelatableTarget, relation: ConstraintRelation, file: String, line: UInt)</span></span> -&gt; <span class="type">ConstraintMakerEditable</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> related: <span class="type">ConstraintItem</span></span><br><span class="line">    <span class="keyword">let</span> constant: <span class="type">ConstraintConstantTarget</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> other = other <span class="keyword">as</span>? <span class="type">ConstraintItem</span> &#123;</span><br><span class="line">      <span class="keyword">guard</span> other.attributes == <span class="type">ConstraintAttributes</span>.<span class="keyword">none</span> ||</span><br><span class="line">          other.attributes.layoutAttributes.<span class="built_in">count</span> &lt;= <span class="number">1</span> ||</span><br><span class="line">          other.attributes.layoutAttributes == <span class="keyword">self</span>.description.attributes.layoutAttributes ||</span><br><span class="line">          other.attributes == .edges &amp;&amp; <span class="keyword">self</span>.description.attributes == .margins ||</span><br><span class="line">          other.attributes == .margins &amp;&amp; <span class="keyword">self</span>.description.attributes == .edges ||</span><br><span class="line">          other.attributes == .directionalEdges &amp;&amp; <span class="keyword">self</span>.description.attributes == .directionalMargins ||</span><br><span class="line">          other.attributes == .directionalMargins &amp;&amp; <span class="keyword">self</span>.description.attributes == .directionalEdges <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"Cannot constraint to multiple non identical attributes. (\(file), \(line))"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      related = other</span><br><span class="line">      constant = <span class="number">0.0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> other = other <span class="keyword">as</span>? <span class="type">ConstraintView</span> &#123;</span><br><span class="line">      related = <span class="type">ConstraintItem</span>(target: other, attributes: <span class="type">ConstraintAttributes</span>.<span class="keyword">none</span>)</span><br><span class="line">      constant = <span class="number">0.0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> other = other <span class="keyword">as</span>? <span class="type">ConstraintConstantTarget</span> &#123;</span><br><span class="line">      related = <span class="type">ConstraintItem</span>(target: <span class="literal">nil</span>, attributes: <span class="type">ConstraintAttributes</span>.<span class="keyword">none</span>)</span><br><span class="line">      constant = other</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> #available(iOS <span class="number">9.0</span>, <span class="type">OSX</span> <span class="number">10.11</span>, *), <span class="keyword">let</span> other = other <span class="keyword">as</span>? <span class="type">ConstraintLayoutGuide</span> &#123;</span><br><span class="line">      related = <span class="type">ConstraintItem</span>(target: other, attributes: <span class="type">ConstraintAttributes</span>.<span class="keyword">none</span>)</span><br><span class="line">      constant = <span class="number">0.0</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">fatalError</span>(<span class="string">"Invalid constraint. (\(file), \(line))"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> editable = <span class="type">ConstraintMakerEditable</span>(<span class="keyword">self</span>.description)</span><br><span class="line">    editable.description.sourceLocation = (file, line)</span><br><span class="line">    editable.description.relation = relation</span><br><span class="line">    editable.description.related = related</span><br><span class="line">    editable.description.constant = constant</span><br><span class="line">    <span class="keyword">return</span> editable</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@discardableResult</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">equalTo</span><span class="params">(<span class="number">_</span> other: ConstraintRelatableTarget, <span class="number">_</span> file: String = #file, <span class="number">_</span> line: UInt = #line)</span></span> -&gt; <span class="type">ConstraintMakerEditable</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.relatedTo(other, relation: .<span class="built_in">equal</span>, file: file, line: line)</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°äº†</p><ul><li>ConstraintConstantTarget(struct)</li><li>ConstraintRelation(struct)</li><li>ConstraintAttributes(struct)</li><li>ConstraintDescription(class)</li><li>ConstraintItem(class)</li><li>ConstraintMakerEditable(class)</li></ul><h3 id="model-å±‚æ•°æ®åˆ†æ"><a class="markdownIt-Anchor" href="#model-å±‚æ•°æ®åˆ†æ"></a> model å±‚æ•°æ®åˆ†æ</h3><h4 id="constraintconstanttarget"><a class="markdownIt-Anchor" href="#constraintconstanttarget"></a> ConstraintConstantTarget</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">LayoutAttribute</span> = <span class="type">NSLayoutConstraint</span>.<span class="type">Attribute</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">ConstraintConstantTarget</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CGPoint</span>: <span class="title">ConstraintConstantTarget</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CGSize</span>: <span class="title">ConstraintConstantTarget</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ConstraintInsets</span>: <span class="title">ConstraintConstantTarget</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSDirectionalEdgeInsets</span> : <span class="title">ConstraintConstantTarget</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ConstraintConstantTarget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">constraintConstantTargetValueFor</span><span class="params">(layoutAttribute: LayoutAttribute)</span></span> -&gt; <span class="type">CGFloat</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æºç çŸ¥é“ <code>ConstraintConstantTarget</code> æ˜¯ autolayout æ–¹ç¨‹å¼ä¸­çš„ constantï¼Œä»–æ˜¯è¿™ä¸ª constant æ‰©å±•å°è£…</p><h4 id="constraintrelation"><a class="markdownIt-Anchor" href="#constraintrelation"></a> ConstraintRelation</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">enum</span> <span class="title">ConstraintRelation</span> : <span class="title">Int</span> </span>&#123; </span><br><span class="line">  <span class="keyword">case</span> <span class="built_in">equal</span> </span><br><span class="line">  <span class="keyword">case</span> lessThanOrEqual </span><br><span class="line">  <span class="keyword">case</span> greaterThanOrEqual </span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> layoutRelation: <span class="type">LayoutRelation</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ConstraintRelation</code> æ˜¯ æ–¹ç¨‹å¼ä¸­çš„ å…³ç³»ç¬¦å·</p><h4 id="constraintattributes"><a class="markdownIt-Anchor" href="#constraintattributes"></a> ConstraintAttributes</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">struct</span> <span class="title">ConstraintAttributes</span> : <span class="title">OptionSet</span>, <span class="title">ExpressibleByIntegerLiteral</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">none</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">1</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> top: <span class="type">ConstraintAttributes</span> &#123;  <span class="keyword">return</span> <span class="number">2</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">4</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> bottom: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">8</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> leading: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">16</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> trailing: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">32</span> &#125;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> width: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="number">64</span> &#125;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> layoutAttributes:[<span class="type">LayoutAttribute</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> attrs = [<span class="type">LayoutAttribute</span>]()</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="built_in">contains</span>(<span class="type">ConstraintAttributes</span>.<span class="keyword">left</span>)) &#123;</span><br><span class="line">      attrs.append(.<span class="keyword">left</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="built_in">contains</span>(<span class="type">ConstraintAttributes</span>.top)) &#123;</span><br><span class="line">      attrs.append(.top)</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attrs</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> + <span class="params">(<span class="keyword">left</span>: ConstraintAttributes, <span class="keyword">right</span>: ConstraintAttributes)</span></span> -&gt; <span class="type">ConstraintAttributes</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">left</span>.union(<span class="keyword">right</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> +=<span class="params">(<span class="keyword">left</span>: <span class="keyword">inout</span> ConstraintAttributes, <span class="keyword">right</span>: ConstraintAttributes)</span></span> &#123;</span><br><span class="line">  <span class="keyword">left</span>.formUnion(<span class="keyword">right</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ConstraintAttributes ä½¿ç”¨äº†swift çš„é€‰æ‹©é›†(å¯é€‰æšä¸¾)</li><li>é‡è½½äº†è¿ç®—ç¬¦</li><li>ä¾ç„¶çŒœæµ‹ å®ƒå¯¹åº” <code>NSLayoutConstraint.Attribute</code></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConstraintItem.swift</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintItem</span> </span>&#123;</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">weak</span> <span class="keyword">var</span> target: <span class="type">AnyObject?</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">let</span> attributes: <span class="type">ConstraintAttributes</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">init</span>(target: <span class="type">AnyObject?</span>, attributes: <span class="type">ConstraintAttributes</span>)</span><br><span class="line">  <span class="keyword">internal</span> <span class="keyword">var</span> layoutConstraintItem: <span class="type">LayoutConstraintItem?</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.target <span class="keyword">as</span>? <span class="type">LayoutConstraintItem</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: ConstraintItem, rhs: ConstraintItem)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LayoutConstraintItem.swift</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">LayoutConstraintItem</span>: <span class="title">class</span> </span>&#123;&#125;</span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">9.0</span>, <span class="type">OSX</span> <span class="number">10.11</span>, *)</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ConstraintLayoutGuide</span> : <span class="title">LayoutConstraintItem</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ConstraintView</span> : <span class="title">LayoutConstraintItem</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">ConstraintLayoutGuide</span> = <span class="type">UILayoutGuide</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">ConstraintView</span> = <span class="type">UIView</span></span><br></pre></td></tr></table></figure><p>nice~<br>ConstraintItem å°±æ˜¯ view å’Œ ä»–å¯¹åº”å¸ƒå±€å±æ€§çš„å…ƒç»„ (view, attr)</p><h4 id="constraintdescription"><a class="markdownIt-Anchor" href="#constraintdescription"></a> ConstraintDescription</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintDescription</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">let</span> item: <span class="type">LayoutConstraintItem</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> attributes: <span class="type">ConstraintAttributes</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> relation: <span class="type">ConstraintRelation?</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> sourceLocation: (<span class="type">String</span>, <span class="type">UInt</span>)?</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> label: <span class="type">String?</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> related: <span class="type">ConstraintItem?</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> multiplier: <span class="type">ConstraintMultiplierTarget</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> constant: <span class="type">ConstraintConstantTarget</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> priority: <span class="type">ConstraintPriorityTarget</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="built_in">lazy</span> <span class="keyword">var</span> constraint: <span class="type">SnapKit</span>.<span class="type">Constraint?</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125; <span class="comment">// main</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">init</span>(item: <span class="type">LayoutConstraintItem</span>, attributes: <span class="type">ConstraintAttributes</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ConstraintDescription</code> åŒ…å«äº† autolayout å¸ƒå±€æ–¹ç¨‹å¼ä¸­æ‰€æœ‰ä¿¡æ¯ï¼Œå¯æ˜¯ä¸çŸ¥é“ä¸ºå•¥ä¸åœ¨è¿™é‡Œè°ƒç”¨ NSLayoutConstraint æ·»åŠ å±æ€§ï¼Œéè¦æä¸€ä¸ª SnapKit.Constraintæ¥åšè¿™äº›äº‹</p><ul><li>ConstraintMakerEditable æ˜¯é“¾å¼ç¼–ç¨‹æŠ€å·§é‡Œé¢çš„å¾€åçœ‹</li></ul><h3 id="åˆ†æ-snapkit-é“¾å¼å°è£…"><a class="markdownIt-Anchor" href="#åˆ†æ-snapkit-é“¾å¼å°è£…"></a> åˆ†æ <code>SnapKit</code> é“¾å¼å°è£…</h3><h4 id="ä¸»è¦ç»„ä»¶ç»“"><a class="markdownIt-Anchor" href="#ä¸»è¦ç»„ä»¶ç»“"></a> ä¸»è¦ç»„ä»¶ç»“</h4><ul><li>æ–‡ä»¶åˆ†ç»„<br><img src="/img/snapkit_files.jpeg" alt="snapkit_files"></li></ul><h4 id="ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ"><a class="markdownIt-Anchor" href="#ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ"></a> ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ</h4><details><summary>SnapKit ä¸»æµç¨‹</summary><pres><p><img src="/img/snapKit_main_flow.jpeg" alt="snapKit main flow"><br></p></pres><p></p></details><details><summary>SnapKit é“¾å¼æµç¨‹</summary><pres><p><img src="/img/snapKit_chain.jpeg" alt="snapKit chain"><br></p></pres><p></p></details><p>maker åˆ›å»ºä¸€ä¸ªå…¶å®èŠ‚ç‚¹ ContraintExtentableï¼Œä»–ç»´æŠ¤è‡ªå·±çš„ description<br>maker ä¿å­˜ descriptions[] æ•°ç»„</p><p>ä¼ é€’ description æ¥å»¶ç»­é“¾èŠ‚ç‚¹</p><p>to be continued</p><h3 id="ä»£ç ç»„ä»¶åˆ†æ"><a class="markdownIt-Anchor" href="#ä»£ç ç»„ä»¶åˆ†æ"></a> ä»£ç ç»„ä»¶åˆ†æ</h3><blockquote><p><a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/AutolayoutPG/index.html#//apple_ref/doc/uid/TP40010853-CH7-SW1" target="_blank" rel="noopener">Auto Layout Guide</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> UI å¸ƒå±€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
            <tag> iOS </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ closures ä»£æ›¿ Gesture Recognizers é€‰æ‹©å™¨</title>
      <link href="/2020/03/08/%E4%BD%BF%E7%94%A8-closures-%E6%B7%BB%E5%8A%A0-Gesture-Recognizers/"/>
      <url>/2020/03/08/%E4%BD%BF%E7%94%A8-closures-%E6%B7%BB%E5%8A%A0-Gesture-Recognizers/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p><a href="https://medium.com/@sdrzn/adding-gesture-recognizers-with-closures-instead-of-selectors-9fb3e09a8f0b" target="_blank" rel="noopener">åŸæ–‡ Adding Gesture Recognizers with Closures Instead of Selectors<br></a></p><p>æ·»åŠ UITapGestureRecognizeræˆ–ä»»ä½• recognizer/target action çš„æœ€ç³Ÿç³•çš„éƒ¨åˆ†æ˜¯ä»…é’ˆå¯¹é€‰æ‹©å™¨å‚æ•°å®ç°æ–°åŠŸèƒ½ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³åˆ†äº«ä¸€ä¸ªå·§å¦™çš„æŠ€å·§ï¼Œè®©ä½ æ·»åŠ ä¸å¸¦é€‰æ‹©å™¨çš„æ‰‹åŠ¿è¯†åˆ«å™¨ã€‚</p><p>å‡è®¾æˆ‘ä»¬åœ¨View Controllerä¸­æœ‰ä¸€ä¸ªUIImageViewï¼Œæˆ‘ä»¬æƒ³å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ªUITapGestureRecognizerï¼Œä»¥ä¾¿åœ¨ç‚¹å‡»å®ƒæ—¶æ‰“å°å‡ºä¸€æ¡è¯­å¥.</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª UITapGestureRecognizer çš„å®ä¾‹ï¼Œå¹¶å°†å…¶ç›®æ ‡è®¾ç½®ä¸ºè§†å›¾æ§åˆ¶å™¨åŠå…¶é€‰æ‹©å™¨ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå¿«é€Ÿå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·(myImageViewTapped(senderï¼šUITapGestureRecognizer))ã€‚</p><p>è¿™å¯èƒ½ä¼šæœ‰ç‚¹å¤šä½™ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´è¦æ·»åŠ äº¤äº’æ€§çš„æ¯ä¸ªå­è§†å›¾çš„å‡½æ•°çš„ä»£ç æ··ä¹±ã€‚</p><p>æˆ‘ä»¥ä¸ºæˆ‘å¯ä»¥å¿«é€Ÿæ‰©å±•ä¸€ä¸‹ï¼Œä»¥ä¾¿ä¸ºæˆ‘çš„å›¾åƒè§†å›¾æ·»åŠ æ•²å‡»æ‰‹åŠ¿è¯†åˆ«å™¨ï¼Œä½†æ˜¯ç„¶åæˆ‘å¿…é¡»ä¸ºæ¯ä¸ªè¯†åˆ«å™¨åˆ›å»ºä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå¯¹å—ï¼Ÿé”™è¯¯ï¼åˆ©ç”¨å…³è”å¯¹è±¡çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥å°†é—­åŒ…å­˜å‚¨ä¸ºæ‰©å±•ä¸­çš„è®¡ç®—å±æ€§ï¼</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIView</span> </span>&#123;</span><br><span class="line">  <span class="comment">// In order to create computed properties for extensions, we need a key to </span></span><br><span class="line">  <span class="comment">// store and access the stored property</span></span><br><span class="line">  <span class="keyword">fileprivate</span> <span class="class"><span class="keyword">struct</span> <span class="title">AssociatedObjectKeys</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> tapGestureRecognizer = <span class="string">"MediaViewerAssociatedObjectKey_mediaViewer"</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">fileprivate</span> <span class="keyword">typealias</span> <span class="type">Action</span> = (() -&gt; <span class="type">Void</span>)?</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set our computed property type to a closure</span></span><br><span class="line">  <span class="keyword">fileprivate</span> <span class="keyword">var</span> tapGestureRecognizerAction: <span class="type">Action?</span> &#123;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> newValue = newValue &#123;</span><br><span class="line">        <span class="comment">// Computed properties get stored as associated objects</span></span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, &amp;<span class="type">AssociatedObjectKeys</span>.tapGestureRecognizer, newValue, objc_AssociationPolicy.<span class="type">OBJC_ASSOCIATION_RETAIN</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> tapGestureRecognizerActionInstance = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;<span class="type">AssociatedObjectKeys</span>.tapGestureRecognizer) <span class="keyword">as</span>? <span class="type">Action</span></span><br><span class="line">      <span class="keyword">return</span> tapGestureRecognizerActionInstance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// This is the meat of the sauce, here we create the tap gesture recognizer and</span></span><br><span class="line">  <span class="comment">// store the closure the user passed to us in the associated object we declared above</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">addTapGestureRecognizer</span><span class="params">(action: <span class="params">(<span class="params">()</span></span></span></span> -&gt; <span class="type">Void</span>)?) &#123;</span><br><span class="line">    <span class="keyword">self</span>.isUserInteractionEnabled = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">self</span>.tapGestureRecognizerAction = action</span><br><span class="line">    <span class="keyword">let</span> tapGestureRecognizer = <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: #selector(handleTapGesture))</span><br><span class="line">    <span class="keyword">self</span>.addGestureRecognizer(tapGestureRecognizer)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Every time the user taps on the UIImageView, this function gets called,</span></span><br><span class="line">  <span class="comment">// which triggers the closure we stored</span></span><br><span class="line">  <span class="meta">@objc</span> <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">handleTapGesture</span><span class="params">(sender: UITapGestureRecognizer)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> action = <span class="keyword">self</span>.tapGestureRecognizerAction &#123;</span><br><span class="line">      action?()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"no action"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬è¦å°†UITapGestureRecognizeræ·»åŠ åˆ°UIViewæˆ–UIViewå­ç±»ï¼ˆå¦‚UIImageViewï¼‰æ—¶ï¼Œéƒ½å¯ä»¥è¿™æ ·åšï¼Œè€Œæ— éœ€ä¸ºé€‰æ‹©å™¨åˆ›å»ºå…³è”çš„åŠŸèƒ½ï¼è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sampleImageView.addTapGestureRecognizer &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"image tapped"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰UITapGestureRecognizerså®ä¾‹ï¼Œæ²¡æœ‰targetsï¼Œæ²¡æœ‰selectorsï¼Œæ²¡æœ‰ä¸å¿…è¦çš„functionsï¼</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
            <tag> iOS </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªå®šä¹‰ keyboard</title>
      <link href="/2020/02/17/%E8%87%AA%E5%AE%9A%E4%B9%89-keyboard/"/>
      <url>/2020/02/17/%E8%87%AA%E5%AE%9A%E4%B9%89-keyboard/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p>åŸæ–‡ï¼š<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/CustomKeyboard.html" target="_blank" rel="noopener">CustomKeyboard</a></p><h3 id="è‡ªå®šä¹‰é”®ç›˜api"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰é”®ç›˜api"></a> è‡ªå®šä¹‰é”®ç›˜API</h3><p>å¼€å‘è‡ªå®šä¹‰é”®ç›˜çš„å¿«é€Ÿå…¥é—¨,å¦‚ä¸‹å›¾ï¼Œå®ƒå±•ç¤ºäº†é”®ç›˜è¿è¡Œè¿‡ç¨‹ä¸­ä¸€äº›é‡è¦çš„å¯¹è±¡ï¼Œä»¥åŠå®ƒä»¬åœ¨å¼€å‘æµç¨‹ä¸­çš„çš„ä½ç½®ï¼š</p><p><img src="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/Art/keyboard_architecture_2x.png" alt="keyboard"></p><p>è‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿ï¼ˆåœ¨iOSâ€œApplication Extensionâ€ç›®æ ‡æ¨¡æ¿ç»„ï¼‰åŒ…å«ä¸€ä¸ªUIInputViewControllerçš„å­ç±»ï¼Œå®ƒæ˜¯ä½ å¼€å‘çš„é”®ç›˜çš„ä¸»è§†å›¾æ§åˆ¶å™¨ã€‚è¯¥æ¨¡æ¿åŒ…å«</p><p>é”®ç›˜æ‰€å¿…éœ€çš„â€œä¸‹ä¸€ä¸ªé”®ç›˜â€æŒ‰é’®çš„å®ç°ï¼Œå®ƒè°ƒç”¨äº†UIInputViewControllerç±»çš„advanceToNextInputModeæ–¹æ³•ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥åœ¨è¾“å…¥è§†å›¾æ§åˆ¶å™¨çš„ä¸»è§†å›¾ï¼ˆåœ¨å…¶inputViewå±æ€§ï¼‰ä¸­æ·»åŠ å­è§†å›¾ã€æ§åˆ¶å™¨ä»¥åŠæ‰‹åŠ¿è¯†åˆ«å™¨ç­‰ã€‚å¯¹äºå…¶å®ƒç±»å‹çš„æ‰©å±•åº”ç”¨ï¼Œåœ¨ç›®æ ‡ä¸Šå¹¶ä¸å­˜åœ¨çª—ä½“ï¼Œå› æ­¤ä¹Ÿå°±æ²¡æœ‰æ ¹è§†å›¾æ§åˆ¶å™¨äº†ã€‚</p><p>åœ¨æ¨¡æ¿çš„Info.plistæ–‡ä»¶ä¸­æœ‰é¢„å…ˆé…ç½®å¥½çš„é”®ç›˜æ‰€éœ€è¦çš„æœ€åŸºæœ¬çš„å€¼ã€‚å‚è§å…¶ä¸­çš„NSExtensionAttributeså­—å…¸å…³é”®å­—ï¼Œé…ç½®ä¸€ä¸ªé”®ç›˜çš„å…³é”®å­—åœ¨<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/CustomKeyboard.html#//apple_ref/doc/uid/TP40014214-CH16-SW18" target="_blank" rel="noopener">ã€Šé…ç½®è‡ªå®šä¹‰é”®ç›˜çš„Info.plistæ–‡ä»¶ã€‹</a>ä¸­æœ‰ä»‹ç»ã€‚</p><p>é»˜è®¤ï¼Œé”®ç›˜ä¸èƒ½è®¿é—®ç½‘ç»œï¼Œä¸èƒ½å’Œå®ƒçš„appå…±äº«å®¹å™¨ã€‚å¦‚æœè¦å…·å¤‡è¿™ç§èƒ½åŠ›ï¼Œå¿…é¡»è¦å°†Info.plistæ–‡ä»¶ä¸­RequestsOpenAccessçš„å€¼ç½®ä¸ºYESã€‚è¿™éœ€è¦æ‰©å±•é”®ç›˜çš„æ²™ç›’ï¼Œåœ¨<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/CustomKeyboard.html#//apple_ref/doc/uid/TP40014214-CH16-SW3" target="_blank" rel="noopener">ã€Šè®¾è®¡ç”¨æˆ·ä¿¡ä»»ã€‹</a>ä¸­æœ‰ä»‹ç»ç›¸å…³å†…å®¹ã€‚</p><p>ä¸€ä¸ªè¾“å…¥è§†å›¾æ§åˆ¶å™¨éµä»å„ç§ä¸æ–‡æœ¬è¾“å…¥å¯¹è±¡å†…å®¹äº¤äº’çš„åè®®ï¼š</p><ul><li>å“åº”è§¦æ‘¸æ¶ˆæ¯æ—¶å¦‚æœè¦æ’å…¥æˆ–åˆ é™¤æ–‡æœ¬ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://developer.apple.com/reference/uikit/uikeyinput" target="_blank" rel="noopener">UIKeyInput</a>åè®®çš„insertText:å’ŒdeleteBackwardæ–¹æ³•ã€‚å¯ä»¥åœ¨è§†å›¾æ§åˆ¶å™¨çš„<a href="https://developer.apple.com/reference/uikit/uiinputviewcontroller/1618193-textdocumentproxy" target="_blank" rel="noopener">textDocumentProxy</a>å±æ€§ä¸­è°ƒç”¨è¿™äº›æ–¹æ³•ï¼Œè¯¥å±æ€§ä»£è¡¨å½“å‰æ–‡æœ¬è¾“å…¥å¯¹è±¡ï¼Œå®ƒéµä»<a href="https://developer.apple.com/reference/uikit/uitextdocumentproxy" target="_blank" rel="noopener">UITextDocumentProxy</a>åè®®ã€‚å¦‚ä¸‹ï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.textDocumentProxy insertText:<span class="string">@"hello "</span>]; <span class="comment">// Inserts the string "hello " at the insertion point</span></span><br><span class="line">[<span class="keyword">self</span>.textDocumentProxy deleteBackward];       <span class="comment">// Deletes the character to the left of the insertion point</span></span><br><span class="line">[<span class="keyword">self</span>.textDocumentProxy insertText:<span class="string">@"\n"</span>];     <span class="comment">// In a text view, inserts a newline character at the insertion point</span></span><br></pre></td></tr></table></figure><ul><li>åœ¨è°ƒç”¨deleteBackwardä¹‹å‰è¦å…ˆå†³å®šåˆ é™¤çš„å­—ç¬¦æ•°ã€‚å¯ä»¥é€šè¿‡textDocumentProxyçš„<a href="https://developer.apple.com/reference/uikit/uitextdocumentproxy/1618190-documentcontextbeforeinput" target="_blank" rel="noopener">documentContextBeforeInput</a>å±æ€§ï¼Œæ¥è·å¾—å…‰æ ‡é™„è¿‘çš„æ–‡æœ¬ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *precedingContext = <span class="keyword">self</span>.textDocumentProxy.documentContextBeforeInput;</span><br></pre></td></tr></table></figure><ul><li>ä¸ºäº†æ§åˆ¶å…‰æ ‡æ‰€åœ¨ä½ç½®çš„æ“ä½œï¼Œæ¯”å¦‚æ”¯æŒå‘å‰åˆ é™¤æ–‡å­—ï¼Œéœ€è¦è°ƒç”¨UITextDocumentProxyåè®®ä¸­çš„<a href="https://developer.apple.com/reference/uikit/uitextdocumentproxy/1618194-adjusttextposition" target="_blank" rel="noopener">adjustTextPositionByCharacterOffset:</a>æ–¹æ³•ã€‚æ¯”å¦‚å‘å‰åˆ é™¤ä¸€ä¸ªå­—ç¬¦ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) deleteForward &#123;</span><br><span class="line">    [<span class="keyword">self</span>.textDocumentProxy adjustTextPositionByCharacterOffset: <span class="number">1</span>];</span><br><span class="line">    [<span class="keyword">self</span>.textDocumentProxy deleteBackward];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡å®ç°<a href="https://developer.apple.com/reference/uikit/uitextinputdelegate" target="_blank" rel="noopener">UITextInputDelegate</a>åè®®ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥å“åº”å½“å‰è¾“å…¥æ–‡æœ¬å¯¹è±¡çš„ä¸€äº›å˜åŒ–ï¼Œæ¯”å¦‚å†…å®¹å˜åŒ–ä»¥åŠç”¨æˆ·è§¦å‘çš„å…‰æ ‡ä½ç½®çš„å˜åŒ–ã€‚</li></ul><p>ä¸ºäº†å±•ç°ä¸å½“å‰æ–‡æœ¬è¾“å…¥å¯¹è±¡é€‚é…çš„é”®ç›˜å¸ƒå±€ï¼Œéœ€è¦å‚ç…§è¯¥å¯¹è±¡çš„<a href="https://developer.apple.com/reference/uikit/uikeyboardtype" target="_blank" rel="noopener">UIKeyboardType</a>å±æ€§ï¼Œæ ¹æ®æ¯ç§ä½ çš„é”®ç›˜æ‰€èƒ½æ”¯æŒçš„å±æ€§ï¼Œå˜åŒ–å¸ƒå±€å†…å®¹ã€‚</p><p><strong>åœ¨è‡ªå®šä¹‰é”®ç›˜ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æ”¯æŒå¤šè¯­è¨€ï¼š</strong></p><ul><li>ä¸ºæ¯ä¸ªè¯­è¨€åˆ›å»ºä¸€ä¸ªé”®ç›˜ï¼Œæ¯ä¸ªé”®ç›˜éƒ½ä½œä¸ºå‘å®¹å™¨appæ·»åŠ çš„ç‹¬ç«‹çš„Target</li><li>åˆ›å»ºä¸€ä¸ªå¤šè¯­è¨€é”®ç›˜ï¼ŒåŠ¨æ€åˆ‡æ¢å½“å‰è¯­è¨€ã€‚å¯ä»¥ä½¿ç”¨UIInputViewControllerç±»çš„primaryLanguageå±æ€§æ¥åŠ¨æ€åˆ‡æ¢è¯­è¨€ã€‚</li></ul><p>æ ¹æ®ä½ è¦æ”¯æŒçš„è¯­è¨€æ•°é‡ä»¥åŠä½ æƒ³æä¾›çš„ç”¨æˆ·ä½“éªŒï¼Œä½ å¯ä»¥ä»ä¸Šé¢é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆã€‚</p><p>æ¯ç§è‡ªå®šä¹‰é”®ç›˜ï¼ˆéœ€è¦RequestsOpenAccessï¼‰éƒ½å¯ä»¥é€šè¿‡UILexiconç±»è®¿é—®è‡ªåŠ¨çº é”™çš„è¯å…¸ã€‚é€šè¿‡ä½¿ç”¨è¯¥ç±»ï¼Œå¹¶ç»“åˆä½ è‡ªå·±çš„è¯å…¸è®¾è®¡ï¼Œå¯ä»¥åœ¨ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­ä¸ºä»–æä¾›è¾“å…¥å»ºè®®å’Œè‡ªåŠ¨çº é”™ã€‚UILexiconå¯¹è±¡åŒ…å«æ¥è‡ªå¦‚ä¸‹æºçš„å•è¯ï¼š</p><ul><li>æ¥è‡ªç”¨æˆ·é€šè®¯å½•çš„äººåå’Œå§“</li><li>åœ¨ è®¾ç½® &gt; é€šç”¨ &gt; é”®ç›˜ &gt; å¿«æ·æ–¹å¼ï¼ˆæ–‡æœ¬æ›¿æ¢ï¼‰ åˆ—è¡¨</li><li>é€šç”¨è¯å…¸</li></ul><p>ä½ å¯ä»¥ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€æ¥è°ƒæ•´ä½ çš„è‡ªå®šä¹‰é”®ç›˜ä¸»è§†å›¾çš„é«˜åº¦ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰é”®ç›˜ä¼šæ ¹æ®å±å¹•å°ºå¯¸ä»¥åŠè®¾å¤‡æ–¹å‘ï¼Œå’Œç³»ç»Ÿé”®ç›˜çš„å°ºå¯¸ä¿æŒä¸€è‡´ã€‚è‡ªå®šä¹‰é”®ç›˜çš„å®½åº¦é€šå¸¸ä¸å±å¹•å½“å‰å®½åº¦ä¸€è‡´ã€‚ä¿®æ”¹è‡ªå®šä¹‰é”®ç›˜ä¸»è§†å›¾çš„é«˜åº¦çº¦æŸå³å¯ä¿®æ”¹å…¶é«˜åº¦ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•å®šä¹‰å’Œæ·»åŠ çº¦æŸï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGFloat</span> _expandedHeight = <span class="number">500</span>;</span><br><span class="line"><span class="built_in">NSLayoutConstraint</span> *_heightConstraint = </span><br><span class="line">    [<span class="built_in">NSLayoutConstraint</span> constraintWithItem: <span class="keyword">self</span>.view </span><br><span class="line">                                 attribute: <span class="built_in">NSLayoutAttributeHeight</span> </span><br><span class="line">                                 relatedBy: <span class="built_in">NSLayoutRelationEqual</span> </span><br><span class="line">                                    toItem: <span class="literal">nil</span> </span><br><span class="line">                                 attribute: <span class="built_in">NSLayoutAttributeNotAnAttribute</span></span><br><span class="line">                                multiplier: <span class="number">0.0</span> </span><br><span class="line">                                  constant: _expandedHeight];</span><br><span class="line">[<span class="keyword">self</span>.view addConstraint: _heightConstraint];</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘å…³é”®"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘å…³é”®"></a> è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘å…³é”®</h2><p>è‡ªå®šä¹‰é”®ç›˜å¼€å‘æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p><ul><li>ä¿¡ä»»ã€‚ è‡ªå®šä¹‰é”®ç›˜èƒ½è®¿é—®ç”¨æˆ·è¾“å…¥çš„å†…å®¹ ï¼Œå› æ­¤åœ¨é”®ç›˜å’Œç”¨æˆ·é—´å»ºç«‹ä¿¡ä»»éå¸¸å…³é”®ã€‚</li><li>â€œä¸‹ä¸€ä¸ªé”®ç›˜â€é”®ã€‚ é€šè¿‡é”®ç›˜ç•Œé¢å¿…é¡»èƒ½è®©ç”¨æˆ·èƒ½åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé”®ç›˜ã€‚</li></ul><h3 id="ä¸ºç”¨æˆ·ä¿¡ä»»æ‰€åšçš„è®¾è®¡"><a class="markdownIt-Anchor" href="#ä¸ºç”¨æˆ·ä¿¡ä»»æ‰€åšçš„è®¾è®¡"></a> ä¸ºç”¨æˆ·ä¿¡ä»»æ‰€åšçš„è®¾è®¡</h3><p>ä½œä¸ºè‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘è€…ï¼Œä½ é¦–å…ˆåº”å½“è€ƒè™‘çš„æ˜¯å¦‚ä½•å»ºç«‹å’Œç»´æŠ¤ç”¨æˆ·ä¿¡ä»»ã€‚ä½ è¦ç†è§£éšç§ç­–ç•¥çš„æœ€ä½³å®è·µå¹¶çŸ¥é“å¦‚ä½•å®ç°å®ƒæ‰èƒ½å¾ˆå¥½åœ°è·µè¡Œã€‚</p><blockquote><p>æ³¨æ„<br>æœ¬èŠ‚ä¸ºä½ åˆ›å»ºè‡ªå®šä¹‰é”®ç›˜æä¾›ç›¸å…³çš„å¼€å‘æ‰‹å†Œï¼Œè¯¥æ‰‹å†Œè¦æ±‚å°Šé‡ç”¨æˆ·éšç§ã€‚äº†è§£iOSç¼–ç¨‹è¦æ±‚ï¼Œè¯·é˜…è¯»åº”ç”¨å•†åº—å®¡æ ¸æ‰‹å†Œï¼ŒiOSäººæœºäº¤äº’æ‰‹å†Œï¼ŒiOSå¼€å‘è®¸å¯åè®®ï¼Œè¯·å‚è§è‹¹æœçš„<a href="https://developer.apple.com/support/appstore/app-review/" target="_blank" rel="noopener">ã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹</a>ï¼Œ<a href="https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/ExpectedAppBehaviors/ExpectedAppBehaviors.html#//apple_ref/doc/uid/TP40007072-CH3-SW6" target="_blank" rel="noopener">ã€Šæ”¯æŒç”¨æˆ·éšç§ã€‹</a>ï¼Œ<a href="https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007072" target="_blank" rel="noopener">ã€ŠiOSåº”ç”¨ç¼–ç¨‹æŒ‡å—ã€‹</a>ã€‚</p></blockquote><p>å¯¹äºé”®ç›˜ï¼Œå¦‚ä¸‹ä¸‰ä¸ªæ–¹é¢å¯¹äºå»ºç«‹å’Œç»´æŠ¤ç”¨æˆ·ä¿¡ä»»è‡³å…³é‡è¦ï¼š</p><ul><li>æŒ‰é”®æ•°æ®çš„å®‰å…¨ã€‚ ç”¨æˆ·å¸Œæœ›ä»–ä»¬çš„æ•²é”®ä¼šè½åœ¨æ–‡æ¡£ä»¥åŠè¾“å…¥åŒºåŸŸå†…ï¼Œè€Œä¸æ˜¯ä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–è€…ç”¨äºå…¶ä»–ä¸æ˜ç›®çš„ã€‚</li><li>æœ€å°åŒ–åˆç†åˆ©ç”¨å…¶å®ƒç”¨æˆ·æ•°æ®ã€‚ å¦‚æœä½ çš„é”®ç›˜è¿˜éœ€è¦ä½¿ç”¨å…¶ä»–ç”¨æˆ·æ•°æ®ï¼Œä¾‹å¦‚å®šä½æœåŠ¡æˆ–è€…é€šè®¯å½•ï¼Œä½ æœ‰ä¹‰åŠ¡è§£é‡Šè¿™ç»™ç”¨æˆ·å¸¦æ¥çš„å¥½å¤„æ˜¯ä»€ä¹ˆã€‚</li><li>å‡†ç¡®ã€‚ æŠŠè¾“å…¥äº‹ä»¶è½¬æ¢æˆæ–‡æœ¬è¦æ±‚ç²¾å‡†ï¼Œè¿™æœ¬èº«è™½ç„¶ä¸æ˜¯ä¸€ä¸ªéšç§è¯é¢˜ï¼Œä½†ä»–ä¼šå½±å“åˆ°ä¿¡ä»»ï¼šæ¯æ¬¡æ–‡å­—è½¬æ¢éœ€è¦ä½“ç°å‡ºä½ çš„ä»£ç çš„ç²¾å‡†ã€‚</li></ul><p>åœ¨ä¿¡ä»»çš„å¼€å‘è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆè€ƒè™‘çš„æ˜¯æ˜¯å¦è¦è·å–open accessæƒé™ã€‚å°½ç®¡å¼€å¯äº†open accessæƒé™èƒ½ç»™è‡ªå®šä¹‰é”®ç›˜å¼€å‘å¸¦æ¥æå¤§ä¾¿åˆ©ï¼Œä½†è¿™ä¹Ÿå¢åŠ äº†ä½ ä½œä¸ºå¼€å‘è€…çš„è´£ä»»ã€‚ä¸‹é¢æ˜¯æ ‡å‡†çš„open accessçš„èƒ½åŠ›å’Œéšç§è€ƒè™‘ï¼š</p><table><thead><tr><th>Open Access</th><th>èƒ½åŠ›å’Œé™åˆ¶</th><th>éšç§è€ƒè™‘</th></tr></thead><tbody><tr><td>Off(default)</td><td>Â·é”®ç›˜å¯ä»¥æ‰§è¡Œæ‰€æœ‰åŸºæœ¬é”®ç›˜çš„èŒè´£<br>Â·å¯ä»¥è®¿é—®é€šç”¨è¯å…¸ä»¥æ”¯æŒè‡ªåŠ¨çº é”™å’Œè¾“å…¥å»ºè®®<br>Â·è®¿é—®è®¾ç½®é‡Œçš„å¿«æ·çŸ­è¯­<br>Â·ä¸ä¸containingåº”ç”¨å…±äº«å®¹å™¨<br>Â·ä¸è®¿é—®é”®ç›˜å®¹å™¨ä»¥å¤–çš„æ–‡ä»¶ç³»ç»Ÿ<br>Â·ä¸è®¿é—®é”®ç›˜å®¹å™¨ä»¥å¤–çš„æ–‡ä»¶ç³»ç»Ÿ<br>Â·ä¸èƒ½ç›´æ¥æˆ–é—´æ¥è®¿é—®iCloudæˆ–æ¸¸æˆä¸­å¿ƒæˆ–åº”ç”¨å†…è´­ä¹°</td><td>ç”¨æˆ·äº†è§£æŒ‰é”®ä»…ä»…è¢«å‘é€åˆ°å½“å‰ä½¿ç”¨é”®ç›˜çš„åº”ç”¨é‡Œ</td></tr><tr><td>On</td><td>Â·å…·å¤‡éè”ç½‘è‡ªå®šä¹‰é”®ç›˜çš„æ‰€æœ‰èƒ½åŠ›<br>Â·åœ¨ç”¨æˆ·è®¸å¯æƒ…å†µä¸‹å¯ä»¥è®¿é—®ä½ç½®æœåŠ¡å’Œé€šè®¯å½•<br>Â·é”®ç›˜å’Œcontaining appå¯ä»¥è®¿é—®å…±äº«å®¹å™¨<br>Â·é”®ç›˜å¯ä»¥ä¸ºæœåŠ¡å™¨ä¾§å¤„ç†è¿‡ç¨‹å‘é€æŒ‰é”®æˆ–å…¶ä»–è¾“å…¥äº‹ä»¶<br>Â·containing appè‡ªåŠ¨çº é”™å­—å…¸æä¾›ç¼–è¾‘ç•Œé¢<br>Â·é€šè¿‡containing appé”®ç›˜å¯ä»¥ä½¿ç”¨iCloudæ¥ä¿è¯è‡ªåŠ¨çº é”™è¯å…¸å’Œè®¾ç½®çš„æ›´æ–°<br>Â·é€šè¿‡containing appï¼Œé”®ç›˜å¯ä»¥å‚ä¸åˆ°æ¸¸æˆä¸­å¿ƒå’Œåº”ç”¨å†…è´­ä¹°<br>Â·å¦‚æœé”®ç›˜æ”¯æŒç§»åŠ¨è®¾å¤‡ç®¡ç†(MDM)ï¼Œå®ƒå¯ä¸è¢«ç®¡ç†çš„åº”ç”¨å…±åŒå·¥ä½œ</td><td>Â·ç”¨æˆ·äº†è§£é”®ç›˜å¼€å‘è€…ä¼šåˆ©ç”¨æŒ‰é”®æ•°æ®<br>Â·ä½ å¿…é¡»éµå®ˆæœ‰è”ç½‘èƒ½åŠ›çš„é”®ç›˜å¼€å‘æ‰‹å†Œå’ŒiOSå¼€å‘è®¸å¯åè®®ï¼Œå¯å‚è§ã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹</td></tr></tbody></table><p>å¦‚æœä½ çš„è‡ªå®šä¹‰é”®ç›˜ä¸éœ€è¦open accessæƒé™ï¼Œç³»ç»Ÿç¡®ä¿æ•²é”®ä¿¡æ¯ä¸ä¼šè¢«å‘é€ç»™ä½ çš„é”®ç›˜ä»¥åŠåˆ«çš„åœ°æ–¹ã€‚å¦‚æœåªæƒ³æä¾›ä¸€èˆ¬çš„é”®ç›˜åŠŸèƒ½ï¼Œè¯·ä¸è¦ç»™é”®ç›˜é…å¤‡è”ç½‘èƒ½åŠ›ã€‚ç”±äºæœ‰æ²™ç›’é™åˆ¶ï¼Œä¸è”ç½‘çš„é”®ç›˜ä¸€å®šæ˜¯æ»¡è¶³è‹¹æœçš„æ•°æ®éšç§æ‰‹å†Œå¹¶èƒ½è·å¾—ç”¨æˆ·ä¿¡ä»»çš„ã€‚</p><p>å¼€å¯open accessæƒé™ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼Œå¯ä»¥åœ¨Info.plistæ–‡ä»¶ä¸­é…ç½®ï¼‰ï¼Œèƒ½ç»™ä½ çš„å¼€å‘å¸¦æ¥æ›´å¤šå¯èƒ½æ€§ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥æ›´å¤šçš„è´£ä»»ã€‚</p><blockquote><p>æ³¨æ„<br>å‘åº”ç”¨å•†åº—æäº¤ä¸€ä¸ªopen-accessçš„é”®ç›˜å¿…é¡»éµå®ˆè‹¹æœã€Šåº”ç”¨å®¡æ ¸æ”¯æŒã€‹ä¸­çš„ç›¸å…³æ¡æ¬¾ã€‚</p></blockquote><p>æ¯ä¸€ä¸ªä¸open accessç›¸å…³çš„åŠŸèƒ½éƒ½éœ€è¦ä½ å±¥è¡Œç›¸åº”çš„è´£ä»»ï¼Œåº”å½“æœ€å¤§é™åº¦åœ°å°Šé‡ç”¨æˆ·æ•°æ®ï¼Œä¸å¾—ç”¨äºä¸ç”¨æˆ·è¾“å…¥æ— å…³çš„å…¶ä»–ä»»ä½•ç›®çš„ã€‚ä¸‹è¡¨åˆ—å‡ºäº†open accesså¸¦æ¥çš„å¥½å¤„ä»¥åŠå¼€å‘è€…éœ€æ‰¿æ‹…çš„è´£ä»»ï¼š</p><table><thead><tr><th>èƒ½åŠ›</th><th>ç”¨æˆ·åˆ©ç›Šç¤ºä¾‹</th><th>å¼€å‘è€…è´£ä»»</th></tr></thead><tbody><tr><td>ä¸containing appå…±äº«å®¹å™¨</td><td>ä¸ºé”®ç›˜çš„è‡ªåŠ¨çº é”™è¯å…¸ç®¡ç†UIç•Œé¢</td><td>è¦è€ƒè™‘åˆ°è‡ªåŠ¨çº é”™æ•°æ®å±äºç”¨æˆ·éšç§ã€‚ä¸è¦æŠŠä»–å‘åˆ°ä½ çš„æœåŠ¡å™¨ï¼Œç”¨ä½œä¸è¾“å…¥æ— å…³çš„ç”¨é€”ã€‚</td></tr><tr><td>æŠŠæŒ‰é”®æ•°æ®å‘åˆ°ä½ çš„æœåŠ¡å™¨</td><td>é€šè¿‡å¼€å‘è€…çš„è®¡ç®—èµ„æºå¯ä»¥æä¾›æ›´å¥½çš„æŒ‰é”®å¤„ç†ç»“æœå’Œè¾“å…¥é¢„æµ‹</td><td>åªæœ‰ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è¾“å…¥ä½“éªŒä¹‹ç”¨æ—¶ï¼Œæ‰èƒ½ä¿å­˜æŒ‰é”®å’Œè¯­éŸ³æ•°æ®</td></tr><tr><td>åŸºäºäº‘çš„è‡ªåŠ¨çº é”™è¯å…¸</td><td>æŠŠäººåã€åœ°åã€çƒ­ç‚¹æ–°é—»åŠ å…¥åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­</td><td>ä¸è¦æŠŠç”¨æˆ·èº«ä»½ä¸è¾“å…¥æ•°æ®å…³è”èµ·æ¥ï¼Œä¸å¾—å°†ç”¨æˆ·ä¿¡æ¯ç”¨ä½œä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„</td></tr><tr><td>é€šè®¯å½•</td><td>æŠŠäººåã€åœ°åã€ç”µè¯å·ç æ·»åŠ åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­</td><td>ä¸å¾—è®²é€šè®¯å½•ç”¨ä½œä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„</td></tr><tr><td>ä½ç½®æœåŠ¡</td><td>å°†é™„è¿‘çš„åœ°åæ·»åŠ åˆ°è‡ªåŠ¨çº é”™è¯å…¸ä¸­</td><td>ä¸è¦åœ¨åå°ä½¿ç”¨ä½ç½®æœåŠ¡ï¼Œä¸å¾—å°†ä½ç½®ä¿¡æ¯å‘é€åˆ°ä½ çš„æœåŠ¡å™¨å¹¶ç”¨äºä¸è¾“å…¥ä½“éªŒæ— å…³çš„å…¶ä»–ç›®çš„</td></tr></tbody></table><p>ä¸€ä¸ªå…·æœ‰open-accessæƒé™çš„é”®ç›˜å’Œå…¶containing appèƒ½å°†æŒ‰é”®æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œé€šè¿‡è¿™äº›æ•°æ®å¯ä»¥ä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è¾“å…¥ä½“éªŒã€‚å¦‚æœä½ ä½¿ç”¨äº†è¿™äº›èƒ½åŠ›ï¼Œå½“ä¸éœ€è¦è¿™äº›æ•°æ®çš„æ—¶å€™ï¼Œè¯·åŠæ—¶åœ¨æœåŠ¡å™¨ç«¯åˆ é™¤ã€‚å‚è§ä¸Šé¢çš„è¡¨æ ¼æ¥å±¥è¡Œä½ ä½¿ç”¨open-accessæƒé™ä¸­çš„ä¹‰åŠ¡ã€‚</p><h3 id="æä¾›åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜çš„æ–¹æ³•"><a class="markdownIt-Anchor" href="#æä¾›åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜çš„æ–¹æ³•"></a> æä¾›åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜çš„æ–¹æ³•</h3><p>ç³»ç»Ÿé”®ç›˜çš„å°åœ°çƒæŒ‰é”®ç”¨äºåˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ï¼š<br><img src="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/Art/globe_key_2x.png" alt="The system keyboardâ€™s Globe key"></p><p>ä½ çš„è‡ªå®šä¹‰é”®ç›˜å¿…é¡»æä¾›ç±»ä¼¼çš„æœºåˆ¶èƒ½åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ã€‚</p><p>è°ƒç”¨UIInputViewControllerç±»çš„<a href="https://developer.apple.com/reference/uikit/uiinputviewcontroller/1618191-advancetonextinputmode" target="_blank" rel="noopener">advanceToNextInputMode</a>æ–¹æ³•å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–é”®ç›˜ã€‚ç³»ç»Ÿä¼šé€‰æ‹©ä¸‹ä¸€ä¸ªé”®ç›˜ï¼Œæ²¡æœ‰èƒ½è·å¾—é”®ç›˜åˆ—è¡¨çš„APIï¼Œä¹Ÿæ²¡æœ‰åˆ‡æ¢åˆ°æŒ‡å®šé”®ç›˜çš„APIã€‚</p><p>Xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿ä¸­å°±å·²ç»åœ¨ä¸‹ä¸€ä¸ªé”®ç›˜æŒ‰é’®ä¸Šå…·å¤‡äº†advanceToNextInputModeçš„åŠŸèƒ½ã€‚ä¸ºäº†æä¾›æœ€å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œåº”å½“æŠŠä½ çš„ä¸‹ä¸€ä¸ªé”®ç›˜æŒ‰é”®æ”¾åœ¨é è¿‘ç³»ç»Ÿé”®ç›˜çš„å°åœ°çƒé”®çš„ä½ç½®ã€‚</p><blockquote><p>æ³¨æ„<br>è¦é€šè¿‡åº”ç”¨å®¡æ ¸ï¼Œå¿…é¡»åœ¨ä½ çš„é”®ç›˜ä¸Šæä¾›æ˜æ˜¾å…è®¸ç”¨æˆ·åˆ‡æ¢é”®ç›˜çš„UIæ ‡è¯†ã€‚</p></blockquote><h2 id="å¼€å§‹è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘"><a class="markdownIt-Anchor" href="#å¼€å§‹è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘"></a> å¼€å§‹è‡ªå®šä¹‰é”®ç›˜çš„å¼€å‘</h2><h3 id="ä½¿ç”¨xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿"><a class="markdownIt-Anchor" href="#ä½¿ç”¨xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿"></a> ä½¿ç”¨Xcodeè‡ªå®šä¹‰é”®ç›˜æ¨¡æ¿</h3><p>åˆ›å»ºé”®ç›˜åŠå…¶containing appä¸å…¶ä»–æ‰©å±•åº”ç”¨ç•¥æœ‰ä¸åŒã€‚æœ¬èŠ‚å°†å¸¦ä½ é¢†ç•¥åŸºæœ¬é”®ç›˜çš„å¼€å‘å’Œè¿è¡Œã€‚</p><p><strong>åœ¨ä¸€ä¸ªå®¹å™¨appä¸­åˆ›å»ºé”®ç›˜ï¼Œæ­¥éª¤å¦‚ä¸‹</strong></p><ol><li>åœ¨Xcodeä¸­é€‰æ‹©File &gt; New &gt; Project &gt; iOS &gt; Applicationé€‰æ‹©Single View Applicationæ¨¡æ¿ã€‚</li><li>ç‚¹å‡»Nextã€‚</li><li>å¡«å†™Project Nameï¼ˆå¦‚CKImeï¼‰ï¼Œç‚¹å‡»Nextã€‚</li><li>é€‰æ‹©è¦ä¿å­˜çš„ä½ç½®ï¼Œç‚¹å‡»Createã€‚è¿™æ ·ï¼Œä½ å°±æœ‰äº†ä¸€ä¸ªç©ºappï¼Œè¯¥appåªèƒ½å®Œæˆä¸€ä¸ªç®€å•çš„æ“ä½œï¼Œæ¥ä¸‹æ¥å®ƒå°†æ‰¿è½½é”®ç›˜ã€‚åœ¨ä½ æäº¤åˆ°åº”ç”¨å•†åº—ä¹‹å‰ï¼Œä½ éœ€è¦å®Œæˆä¸€äº›æœ‰ç”¨çš„åŠŸèƒ½ã€‚è¯·åˆ°åº”ç”¨å®¡æ ¸æ”¯æŒå‚è€ƒåº”ç”¨å•†åº—å®¡æ ¸æŒ‡å—ã€‚</li><li>é€‰æ‹©File &gt; New &gt; Target &gt; iOS &gt; Application Extensioné€‰æ‹©Custom Keyboard Extensionï¼Œç‚¹å‡»Nextã€‚</li><li>å¡«å†™Product Nameï¼ˆå¦‚CKbdï¼‰ï¼Œç‚¹å‡»Finishã€‚</li><li>ç¡®è®¤Projectå’ŒEmbed in Applicationä¸­éƒ½æ˜¾ç¤ºçš„æ˜¯å®¹å™¨appçš„åå­—ï¼ˆCKImeï¼‰ï¼Œç‚¹å‡»Finishã€‚å¦‚æœå¼¹å‡ºActivate â€œCKbdâ€ schemeæç¤ºè®©æ¿€æ´»é”®ç›˜å·¥ç¨‹ï¼Œç‚¹å‡»Activateã€‚</li></ol><p><strong>å®šä¹‰é”®ç›˜group nameï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</strong></p><ol><li>åœ¨Xcodeå·¥ç¨‹å¯¼èˆªè§†å›¾ä¸­ï¼Œé€‰æ‹©å®¹å™¨appçš„Info.plistæ–‡ä»¶ï¼Œ</li><li>åœ¨å³ä¾§plistç¼–è¾‘å™¨ä¸­ï¼Œé¼ æ ‡hoveråˆ°Bundle nameä¸Šï¼Œç‚¹â€œ+â€æŒ‰é’®åˆ›å»ºä¸€è¡Œç©ºå±æ€§ã€‚</li><li>åœ¨Keyä¸­å¡«å†™Bundle display nameï¼Œå›è½¦</li><li>åŒå‡»è¯¥è¡Œçš„Valueï¼Œå¡«å†™ä½ è¦è‡ªå®šä¹‰çš„é”®ç›˜group nameã€‚</li><li>é€‰æ‹©File &gt; Saveä¿å­˜è®¾ç½®ã€‚</li></ol><p>ä¸‹è¡¨æ±‡æ€»äº†åœ¨å®¹å™¨appå’Œé”®ç›˜appçš„Info.plistæ–‡ä»¶ä¸­ä½ å¯ä»¥é…ç½®çš„UIå­—ç¬¦ä¸²ï¼š</p><table><thead><tr><th>iOS UIå­—ç¬¦ä¸²</th><th>Info.plistå…³é”®å­—</th></tr></thead><tbody><tr><td>Â· åœ¨ç³»ç»Ÿè®¾ç½®çš„å·²è´­é”®ç›˜åˆ—è¡¨ä¸­çš„é”®ç›˜group name</td><td>åœ¨å®¹å™¨appçš„Info.plistæ–‡ä»¶ä¸­çš„Bundle display name</td></tr><tr><td>Â· ç³»ç»Ÿè®¾ç½®ä¸­çš„é”®ç›˜åç§°<br>Â· é”®ç›˜æ¢åˆ—è¡¨ä¸­çš„é”®ç›˜åç§°</td><td>åœ¨é”®ç›˜appçš„Info.plistæ–‡ä»¶ä¸­çš„Bundle display name</td></tr></tbody></table><p><strong>è¿è¡Œè‡ªå®šä¹‰é”®ç›˜å¹¶å°†Xcodeè°ƒè¯•å™¨attachåˆ°å®ƒä¸Šé¢</strong></p><ol><li>åœ¨Xcodeï¼Œä½ çš„view controllerå®ç°ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ¯”å¦‚å¯ä»¥æ–­åœ¨viewDidLoadä¸Šï¼‰ã€‚</li><li>åœ¨Xcodeå·¥å…·æ ç¡®ä¿å½“å‰æ´»åŠ¨çš„é¡¹ç›®ä¸ºé”®ç›˜é¡¹ç›®ï¼Œå¹¶å¯¹åº”iOSæ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡ã€‚</li><li>é€‰æ‹©èœå•Project &gt; Runï¼Œæˆ–ç‚¹å‡»Build and then run the current schemeæŒ‰é’®ï¼ˆå³æ’­æ”¾æŒ‰é’®ï¼‰ã€‚Xcodeä¼šæç¤ºé€‰æ‹©host appã€‚é€‰æ‹©ä¸€ä¸ªå¸¦æœ‰è¾“å…¥æ¡†çš„ï¼Œæ¯”å¦‚é€šè®¯å½•æˆ–Safariã€‚</li><li>ç‚¹å‡»Runã€‚Xcodeå°†è¿è¡Œèµ·ä½ æŒ‡å®šçš„host appã€‚å¦‚æœè¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨é”®ç›˜æ‰©å±•åº”ç”¨ï¼Œéœ€è¦ç°åœ¨è®¾ç½®ä¸­æ·»åŠ å¹¶å¯ç”¨é”®ç›˜ï¼š<ol><li>Settings &gt; General &gt; Keyboard &gt; Keyboards</li><li>ç‚¹å‡»Add New Keyboardâ€¦</li><li>åœ¨OTHER IPHONE KEYBOARDSä¸­ç‚¹å‡»ä½ åˆšåˆšåˆ›å»ºçš„é”®ç›˜</li></ol></li><li>åœ¨iOSæ¨¡æ‹Ÿå™¨æˆ–çœŸæœºä¸Šï¼Œè°ƒå‡ºä½ çš„è‡ªå®šä¹‰é”®ç›˜ã€‚<br>ç‚¹å‡»ä»»æ„å¯è¾“å…¥åŒºåŸŸï¼Œå°†æ˜¾ç¤ºå‡ºç³»ç»Ÿé”®ç›˜ã€‚æŒ‰ä½å°åœ°çƒï¼Œé€‰æ‹©ä½ çš„è‡ªå®šä¹‰é”®ç›˜ã€‚<br>æ­¤æ—¶ä½ å°†çœ‹åˆ°è‡ªå®šä¹‰é”®ç›˜ï¼Œä½†æ˜¯è°ƒè¯•å™¨å°šæœªattachä¸Šæ¥ã€‚ä¸€ä¸ªä»æ¨¡æ¿æ„å»ºè€Œæ¥çš„æç®€é”®ç›˜ä»…æœ‰ä¸€ä¸ªNext KeyboardæŒ‰é’®ï¼Œç‚¹å‡»ååˆ‡æ¢å›å‰ä¸€ä¸ªé”®ç›˜ã€‚</li><li>å–æ¶ˆä½ çš„é”®ç›˜ï¼ˆä»¥ä¾¿åœ¨ç¬¬8æ­¥ä¸­ä½ å¯ä»¥å†æ¬¡è°ƒå‡ºé”®ç›˜ä»¥å‘½ä¸­viewDidLoadæ–­ç‚¹ï¼‰</li><li>åœ¨Xcodeä¸­ï¼Œé€‰æ‹©Debug &gt; Attach to Process &gt; By Process Identifier(PID) or Name åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ï¼Œè¾“å…¥ä½ çš„é”®ç›˜æ‰©å±•åº”ç”¨çš„åå­—ï¼ˆåŒ…å«ç©ºæ ¼ï¼‰.é»˜è®¤å°±æ˜¯è¯¥æ‰©å±•åº”ç”¨åœ¨å·¥ç¨‹å¯¼èˆªçª—å£é‡Œçš„group nameã€‚</li><li>ç‚¹å‡»Attachã€‚Xcodeå°†æ˜¾ç¤ºå‡ºç­‰å¾…attachçš„è°ƒè¯•å™¨ã€‚</li><li>åœ¨ä»»æ„èƒ½è¾“å…¥æ–‡å­—çš„appä¸­è°ƒå‡ºé”®ç›˜ã€‚<br>å½“ä½ çš„é”®ç›˜ä¸»è§†å›¾å¼€å§‹åŠ è½½æ—¶ï¼ŒXcodeè°ƒè¯•å™¨å°†attacheåˆ°ä½ çš„é”®ç›˜ï¼Œå¹¶å‘½ä¸­æ–­ç‚¹ã€‚</li></ol><h3 id="ä¸ºè‡ªå®šä¹‰é”®ç›˜é…ç½®infoplistæ–‡ä»¶"><a class="markdownIt-Anchor" href="#ä¸ºè‡ªå®šä¹‰é”®ç›˜é…ç½®infoplistæ–‡ä»¶"></a> ä¸ºè‡ªå®šä¹‰é”®ç›˜é…ç½®Info.plistæ–‡ä»¶</h3><p>è‡ªå®šä¹‰é”®ç›˜çš„Info.plistæ–‡ä»¶å…è®¸é™æ€å®šä¹‰é”®ç›˜çš„ç°å¼ç‰¹å¾ï¼ŒåŒ…æ‹¬ä¸»è¦è¯­è¨€ï¼Œä»¥åŠæ˜¯å¦éœ€è¦open accessæƒé™ã€‚</p><p>æ‰“å¼€Xcodeå¹¶åˆ‡æ¢åˆ°è‡ªå®šä¹‰é”®ç›˜çš„ targetã€‚åœ¨å·¥ç¨‹å¯¼èˆªæ é€‰æ‹©Info.plistæ–‡ä»¶ï¼ŒæŒ‰æ–‡æœ¬æ ¼å¼å‘ˆç°å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>NSExtension<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSExtensionAttributes<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>IsASCIICapable<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>PrefersRightToLeft<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>PrimaryLanguage<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>en-US<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>RequestsOpenAccess<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSExtensionPointIdentifier<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>com.apple.keyboard-service<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSExtensionPrincipalClass<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>KeyboardViewController<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå…³é”®å­—åœ¨App Extension Keysä¸­éƒ½æœ‰è§£é‡Šã€‚å¯ä»¥ä½¿ç”¨å­—å…¸NSExtensionAttributesä¸­çš„å…³é”®å­—æ¥æè¿°ä½ çš„è‡ªå®šä¹‰é”®ç›˜çš„ç‰¹å¾å’Œéœ€æ±‚ï¼Œå¦‚ä¸‹ï¼š</p><p><code>IsASCIICapable</code> - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚ç”¨æˆ·é”®ç›˜æ˜¯å¦å¯ä»¥å‘æ–‡æ¡£ä¸­æ’å…¥ASCIIå­—ä¸²ã€‚å¦‚æœè¦ä¸º<code>UIKeyboardTypeASCIICapable</code>å±æ€§çš„è¾“å…¥å¯¹è±¡å±•ç°å•ç‹¬ç±»å‹çš„é”®ç›˜ï¼Œéœ€è¦å°†è¯¥å€¼ç½®ä¸ºYESã€‚</p><p><code>PrefersRightToLeft</code> - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚æ˜¯å¦ä¸ºä»å³åˆ°å·¦çš„è¯­ç§è®¾è®¡çš„çš„è‡ªå®šä¹‰é”®ç›˜ã€‚</p><p><code>PrimaryLanguage</code> - é»˜è®¤ä¸ºen-USçš„å­—ä¸²ã€‚ä»¥&lt;è¯­ç§&gt;-&lt;åŒºåŸŸ&gt;çš„å½¢å¼æè¿°é”®ç›˜çš„ä¸»è¯­è¨€ã€‚å¯ä»¥åˆ°http://www.opensource.apple.com/source/CF/CF-476.14/CFLocaleIdentifier.cæ‰¾åˆ°å¯¹åº”çš„è¯­ç§å’ŒåŒºåŸŸã€‚</p><p><code>RequestsOpenAccess</code> - é»˜è®¤ä¸ºNOçš„å¸ƒå°”å€¼ã€‚æ˜¯å¦éœ€è¦æ¯”åŸºç¡€é”®ç›˜æ›´å¤§çš„æ²™ç›’èŒƒå›´ã€‚æŠŠè¯¥å€¼ç½®ä¸ºYESå°†éœ€è¦å®Œå…¨è®¿é—®æƒé™ï¼Œä½ çš„é”®ç›˜å°†è·å¾—å¦‚ä¸‹èƒ½åŠ›ï¼Œæ¯ä¸ªèƒ½åŠ›éƒ½ä¼´éšæœ‰ç›¸åº”çš„æƒé™ï¼š</p><ul><li>è®¿é—®å®šä½æœåŠ¡ï¼Œé€šè®¯å½•æ•°æ®åº“ï¼Œç›¸æœºï¼Œæ¯ä¸ªéƒ½éœ€è¦ç”¨æˆ·å…è®¸</li><li>ä¸é”®ç›˜çš„å®¹å™¨appå…±äº«å®¹å™¨æ•°æ®ï¼Œä»¥ä¾¿å®Œæˆæ¯”å¦‚åœ¨å®¹å™¨appä¸­ç®¡ç†ç”¨æˆ·è¯åº“çš„ç•Œé¢çš„åŠŸèƒ½</li><li>é€šè¿‡ç½‘ç»œå‘é€æŒ‰é”®ã€è¾“å…¥äº‹ä»¶ä¹‹ç±»çš„æ•°æ®ä¾›äº‘ç«¯å¤„ç†</li><li>ä½¿ç”¨UIPasteboardç±»</li><li>æ’­æ”¾éŸ³é¢‘ï¼ŒåŒ…æ‹¬ä½¿ç”¨playInputClickæ–¹æ³•æ’­æ”¾æŒ‰é”®éŸ³</li><li>è®¿é—®iCloudï¼Œå¯ä»¥ç”¨æ¥æ ¹æ®ç”¨æˆ·èº«ä»½åŒæ­¥æ¯”å¦‚é”®ç›˜è®¾ç½®ã€è‡ªå®šä¹‰è‡ªåŠ¨çº é”™è¯å…¸</li><li>é€šè¿‡å®¹å™¨appè®¿é—®æ¸¸æˆä¸­å¿ƒå’Œåº”ç”¨å†…è´­ä¹°</li><li>å¦‚æœä½ çš„é”®ç›˜æ”¯æŒç§»åŠ¨è®¾å¤‡ç®¡ç†ï¼ˆMDMï¼‰ï¼Œå¯ä»¥ä¸è¢«ç®¡ç†çš„appæ— ç¼åˆä½œ</li></ul><p>å½“è€ƒè™‘æ˜¯å¦å°†è¿™äº›å…³é”®å­—è®¾ç½®ä¸ºYESä¹‹å‰ï¼Œä¸€å®šè¦å…ˆé˜…è¯»<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/CustomKeyboard.html#//apple_ref/doc/uid/TP40014214-CH16-SW3" target="_blank" rel="noopener">ã€Šç”¨æˆ·ä¿¡ä»»è®¾è®¡ã€‹</a>ï¼Œè¿™é‡Œæè¿°äº†å¦‚ä½•å°Šé‡å’Œä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> AppExtensions </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>runloop å®è·µç›¸å…³</title>
      <link href="/2019/12/29/runloop/runloop-%E5%AE%9E%E8%B7%B5%E7%9B%B8%E5%85%B3/"/>
      <url>/2019/12/29/runloop/runloop-%E5%AE%9E%E8%B7%B5%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>RunLoop æ˜¯ç³»ç»Ÿå±‚çº§ä¸Šçš„è®¾è®¡ï¼Œç”¨æ¥ç»™ç®¡ç†ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—æ´¾å‘ï¼Œé‚£æˆ‘ä»¬éƒ½å¯ä»¥ç”¨ runLoop åšä»€ä¹ˆå‘¢ï¼Ÿ<br>ç®€å•æ¥è¯´ï¼ŒRunLoop æ˜¯ç”¨æ¥ç›‘å¬è¾“å…¥æºï¼Œè¿›è¡Œè°ƒåº¦å¤„ç†çš„ã€‚</p><p>RunLoop è¾“å…¥æºå¯ä»¥æ˜¯ï¼š</p><ul><li>è¾“å…¥è®¾å¤‡</li><li>ç½‘ç»œ</li><li>å‘¨æœŸæ€§æˆ–è€…å»¶è¿Ÿæ—¶é—´</li><li>å¼‚æ­¥å›è°ƒ</li></ul><p><img src="/img/runloop_core.jpeg" alt="runloop activities"></p><p>runloop çš„ observer å¯ä»¥ç›‘å¬çš„ 7ä¸­çŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">  kCFRunLoopEntry ,         <span class="comment">// è¿›å…¥ loop</span></span><br><span class="line">  kCFRunLoopBeforeTimers ,  <span class="comment">// è§¦å‘ Timer ä¹‹å‰</span></span><br><span class="line">  kCFRunLoopBeforeSources , <span class="comment">// è§¦å‘ Source0 ä¹‹å‰</span></span><br><span class="line">  kCFRunLoopBeforeWaiting , <span class="comment">// ç­‰å¾… mach_port æ¶ˆæ¯ï¼ˆç­‰å¾…æºSourceå’Œè®¡æ—¶å™¨Timerä¹‹å‰ï¼Œè¿›å…¥ç¡çœ ï¼‰</span></span><br><span class="line">  <span class="comment">// åœ¨è¿™ä¸¤ä¸ªçŠ¶æ€ä¸­çœŸæ­£å¤„ç†äº‹ä»¶</span></span><br><span class="line">  kCFRunLoopAfterWaiting ), <span class="comment">// æ¥æ”¶ mach_port æ¶ˆæ¯ï¼ˆç­‰å¾…æºSourceå’Œè®¡æ—¶å™¨Timeråï¼ŒåŒæ—¶åœ¨è¢«å”¤é†’ä¹‹å‰ï¼‰</span></span><br><span class="line">  kCFRunLoopExit , <span class="comment">// é€€å‡º loop</span></span><br><span class="line">  kCFRunLoopAllActivities  <span class="comment">// loop æ‰€æœ‰çŠ¶æ€æ”¹å˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ£€æµ‹-ios-app-å¡é¡¿"><a class="markdownIt-Anchor" href="#æ£€æµ‹-ios-app-å¡é¡¿"></a> æ£€æµ‹ iOS App å¡é¡¿</h2><h3 id="æ€è·¯åˆ†æ"><a class="markdownIt-Anchor" href="#æ€è·¯åˆ†æ"></a> æ€è·¯åˆ†æ</h3><h4 id="å¡é¡¿å¦‚ä½•é€ æˆçš„"><a class="markdownIt-Anchor" href="#å¡é¡¿å¦‚ä½•é€ æˆçš„"></a> å¡é¡¿å¦‚ä½•é€ æˆçš„</h4><p>iOSç³»ç»Ÿé¡µé¢åˆ·æ–°é¢‘ç‡ï¼š60 FPSï¼Œ60æ¬¡/s, <code>let refresh_time_per = 1s/60 &lt; 0.02</code><br>å¦‚æœåœ¨ <code>refresh_time_per</code> æ—¶é—´å†…æ²¡æœ‰å®Œæˆå›¾ç‰‡ç»˜åˆ¶ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ï¼<br>è€Œç³»ç»Ÿé¡µé¢åˆ·æ–°äº‹ä»¶å¤„ç†â€¦â€¦ äº‹ä»¶å‡ ä¹éƒ½æ˜¯ç”± runloop è°ƒç”¨æ‰§è¡Œçš„ã€‚<br>é‚£ä¹ˆå¦‚æœ runloop ä¸€æ¬¡å¾ªç¯æ—¶é—´ &gt; <code>refresh_time_per</code> å°±è¯´æ˜å›¾ç‰‡æ²¡æœ‰æ¸²æŸ“å®Œæˆï¼Œå¯¼è‡´å¡é¡¿ã€‚</p><p>é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åˆ¤æ–­ runloop ä¸€æ¬¡å¾ªç¯æ—¶é—´ &gt; <code>refresh_time_per</code> å‘¢ï¼Ÿ</p><p>RunLoop çš„çº¿ç¨‹ï¼Œè¿›å…¥ç¡çœ å‰æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´è¿‡é•¿è€Œå¯¼è‡´æ— æ³•è¿›å…¥ç¡çœ ï¼Œæˆ–è€…çº¿ç¨‹å”¤é†’åæ¥æ”¶æ¶ˆæ¯æ—¶é—´è¿‡é•¿è€Œæ— æ³•è¿›å…¥ä¸‹ä¸€æ­¥çš„è¯ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯çº¿ç¨‹å—é˜»äº†ã€‚å¦‚æœè¿™ä¸ªçº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹çš„è¯ï¼Œè¡¨ç°å‡ºæ¥çš„å°±æ˜¯å‡ºç°äº†å¡é¡¿ã€‚</p><p>æ‰€ä»¥è¦åˆ©ç”¨ RunLoop åŸç†æ¥ç›‘æ§å¡é¡¿çš„è¯ï¼Œå°±æ˜¯è¦å…³æ³¨è¿™ä¸¤ä¸ªé˜¶æ®µã€‚<br>RunLoop çš„ä¸¤ä¸ª loop çŠ¶æ€<br>åœ¨è¿›å…¥ç¡çœ ä¹‹å‰: kCFRunLoopBeforeSources<br>åœ¨è¿›å…¥å”¤é†’ä¹‹å: kCFRunLoopAfterWaiting<br>ä¹Ÿå°±æ˜¯è¦è§¦å‘ Source0 å›è°ƒå’Œæ¥æ”¶ mach_port æ¶ˆæ¯ä¸¤ä¸ªçŠ¶æ€ã€‚</p><details><summary>runloop æ ¸å¿ƒæºç </summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// while</span></span><br><span class="line"><span class="comment">// 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚</span></span><br><span class="line">__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeTimers);</span><br><span class="line"><span class="comment">// 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚</span></span><br><span class="line">__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeSources);</span><br><span class="line"><span class="comment">// æ‰§è¡Œè¢«åŠ å…¥çš„block</span></span><br><span class="line">__CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚</span></span><br><span class="line">sourceHandledThisLoop = __CFRunLoopDoSources0(runloop, currentMode, stopAfterHandle);</span><br><span class="line"><span class="comment">// æ‰§è¡Œè¢«åŠ å…¥çš„block</span></span><br><span class="line">__CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (__Source0DidDispatchPortLastTime) &#123;</span><br><span class="line">  Boolean hasMsg = __CFRunLoopServiceMachPort(dispatchPort, &amp;msg)</span><br><span class="line">  <span class="keyword">if</span> (hasMsg) <span class="keyword">goto</span> handle_msg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (!sourceHandledThisLoop) &#123;</span><br><span class="line">  __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeWaiting);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ã€‚</span></span><br><span class="line"><span class="comment">// â€¢ ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment">// â€¢ ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†</span></span><br><span class="line"><span class="comment">// â€¢ RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†</span></span><br><span class="line"><span class="comment">// â€¢ è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’</span></span><br><span class="line">__CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort) &#123;</span><br><span class="line">  mach_msg(msg, MACH_RCV_MSG, port); <span class="comment">// thread wait for receive msg</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†ã€‚</span></span><br><span class="line">__CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line">handle_msg:</span><br><span class="line">      <span class="comment">// 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒã€‚</span></span><br><span class="line"><span class="keyword">if</span> (msg_is_timer) &#123;</span><br><span class="line">  __CFRunLoopDoTimers(runloop, currentMode, mach_absolute_time())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblockã€‚</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (msg_is_dispatch) &#123;</span><br><span class="line">  __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9.3 å¦‚æœä¸€ä¸ª Source1 (åŸºäºport) å‘å‡ºäº‹ä»¶äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  CFRunLoopSourceRef source1 = __CFRunLoopModeFindSourceForMachPort(runloop, currentMode, livePort);</span><br><span class="line">  sourceHandledThisLoop = __CFRunLoopDoSource1(runloop, currentMode, source1, msg);</span><br><span class="line">  <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">    mach_msg(reply, MACH_SEND_MSG, reply);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  é€€å‡º runloop é€»è¾‘ retVal != 0 exit</span></span><br><span class="line"><span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">  <span class="comment">// è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚</span></span><br><span class="line">  retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">  <span class="comment">// è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº†</span></span><br><span class="line">  retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(runloop)) &#123;</span><br><span class="line">  <span class="comment">// è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº†</span></span><br><span class="line">  retVal = kCFRunLoopRunStopped;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(runloop, currentMode)) &#123;</span><br><span class="line">  <span class="comment">// source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº†</span></span><br><span class="line">  retVal = kCFRunLoopRunFinished;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h3 id="å¡é¡¿ç›‘å¬å®è·µ"><a class="markdownIt-Anchor" href="#å¡é¡¿ç›‘å¬å®è·µ"></a> å¡é¡¿ç›‘å¬å®è·µ</h3><ol><li>åˆ›å»º runloop çš„observerå¯¹è±¡:</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> weakSelf = <span class="type">Unmanaged</span>&lt;<span class="type">Monitor</span>&gt;.passUnretained(<span class="keyword">self</span>).toOpaque()</span><br><span class="line"><span class="keyword">var</span> ctx: <span class="type">CFRunLoopObserverContext</span> = <span class="type">CFRunLoopObserverContext</span>(version: <span class="number">0</span>, weakSelf: info, retain: <span class="literal">nil</span>, release: <span class="literal">nil</span>, copyDescription: <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">self</span>.runLoopObserver = <span class="type">CFRunLoopObserverCreate</span>(kCFAllocatorDefault, <span class="type">CFRunLoopActivity</span>.allActivities.rawValue, <span class="literal">true</span>, <span class="number">0</span>, runLoopCallBack(), &amp;ctx)</span><br></pre></td></tr></table></figure><ol start="2"><li>å°† observer æ·»åŠ åˆ° runloop çš„ commonModes ä¸­</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CFRunLoopAddObserver</span>(<span class="type">CFRunLoopGetCurrent</span>(), <span class="keyword">self</span>.runLoopObserver, <span class="type">CFRunLoopMode</span>.commonModes)</span><br></pre></td></tr></table></figure><ol start="3"><li>åˆ›å»ºå­çº¿ç¨‹ï¼Œç›‘å¬runloopçš„çŠ¶æ€<ul><li>beforeSources: è¿›å…¥ç¡çœ å‰</li><li>afterWaiting: å”¤é†’åçš„çŠ¶æ€</li><li>è®¾ç½®å¡é¡¿é˜€å€¼</li><li>æ‰“å°å †æ ˆä¿¡æ¯</li></ul></li></ol><p>ä¸ºä»€ä¹ˆè¦ç›‘å¬ beforeSources å’Œ afterWaiting è¿™ä¸¤ä¸ªçŠ¶æ€å‘¢ï¼Ÿ<br>å› ä¸ºåªæœ‰è¿™ä¸¤ä¸ªçŠ¶æ€ runloop è§¦å‘äº‹ä»¶å›è°ƒï¼Œå¦‚æœrunloop é•¿æ—¶é—´å¤„äºè¿™ä¸¤ä¸ªçŠ¶æ€ä¸­è¯´æ˜å¡é¡¿ï¼</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DispatchQueue</span>.global().async &#123;</span><br><span class="line">  <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> sem = <span class="keyword">self</span>.dispatchSemaphore?.wait(timeout: <span class="type">DispatchTime</span>.now() + <span class="number">1</span> / <span class="number">50</span>) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">case</span> <span class="type">DispatchTimeoutResult</span>.timedOut = sem &#123;</span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> <span class="number">_</span> = <span class="keyword">self</span>.runLoopObserver <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.dispatchSemaphore = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.runLoopActivity = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">self</span>.runLoopActivity == <span class="type">CFRunLoopActivity</span>.beforeSources || <span class="keyword">self</span>.runLoopActivity == <span class="type">CFRunLoopActivity</span>.afterWaiting) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"symbo: \(Thread.callStackSymbols)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"æ‰“å°å¡é¡¿å †æ ˆ..."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¦‚ä½•è·å–å¡é¡¿çš„æ–¹æ³•å †æ ˆä¿¡æ¯"><a class="markdownIt-Anchor" href="#å¦‚ä½•è·å–å¡é¡¿çš„æ–¹æ³•å †æ ˆä¿¡æ¯"></a> å¦‚ä½•è·å–å¡é¡¿çš„æ–¹æ³•å †æ ˆä¿¡æ¯ï¼Ÿ</h3><h4 id="ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°è·å–"><a class="markdownIt-Anchor" href="#ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°è·å–"></a> ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°è·å–</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> s_fatal_signals[] = &#123;</span><br><span class="line">  SIGABRT,</span><br><span class="line">  SIGBUS,</span><br><span class="line">  SIGFPE,</span><br><span class="line">  SIGILL,</span><br><span class="line">  SIGSEGV,</span><br><span class="line">  SIGTRAP,</span><br><span class="line">  SIGTERM,</span><br><span class="line">  SIGKILL,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> s_fatal_signal_num = <span class="keyword">sizeof</span>(s_fatal_signals) / <span class="keyword">sizeof</span>(s_fatal_signals[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> UncaughtExceptionHandler(<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">  <span class="built_in">NSArray</span> *exceptionArray = [exception callStackSymbols]; <span class="comment">// å¾—åˆ°å½“å‰è°ƒç”¨æ ˆä¿¡æ¯</span></span><br><span class="line">  <span class="built_in">NSString</span> *exceptionReason = [exception reason];     <span class="comment">// éå¸¸é‡è¦ï¼Œå°±æ˜¯å´©æºƒçš„åŸå› </span></span><br><span class="line">  <span class="built_in">NSString</span> *exceptionName = [exception name];       <span class="comment">// å¼‚å¸¸ç±»å‹</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> SignalHandler(<span class="keyword">int</span> code) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"signal handler = %d"</span>,code);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> InitCrashReport() &#123;</span><br><span class="line">  <span class="comment">// ç³»ç»Ÿé”™è¯¯ä¿¡å·æ•è·</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s_fatal_signal_num; ++i) &#123;</span><br><span class="line">    signal(s_fatal_signals[i], SignalHandler);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//oc æœªæ•è·å¼‚å¸¸çš„æ•è·</span></span><br><span class="line">  <span class="built_in">NSSetUncaughtExceptionHandler</span>(&amp;UncaughtExceptionHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    InitCrashReport();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰æ–¹åº“æ¥è·å–å †æ ˆä¿¡æ¯"><a class="markdownIt-Anchor" href="#ç¬¬ä¸‰æ–¹åº“æ¥è·å–å †æ ˆä¿¡æ¯"></a> ç¬¬ä¸‰æ–¹åº“æ¥è·å–å †æ ˆä¿¡æ¯</h4><p><a href="https://opensource.plausible.coop/src/projects/PLCR/repos/plcrashreporter/browse" target="_blank" rel="noopener">PLCrashReporter</a></p><h2 id="åˆ©ç”¨runloopç©ºé—²æ—¶é—´"><a class="markdownIt-Anchor" href="#åˆ©ç”¨runloopç©ºé—²æ—¶é—´"></a> åˆ©ç”¨RunLoopç©ºé—²æ—¶é—´</h2><p>å¡é¡¿æ˜¯å› ä¸º runloop ä¸€æ¬¡æ—¶é—´ &gt; 1/60s<br>é‚£ä¹ˆå¦‚æœ runloop ä¸€æ¬¡è¿è¡Œæ—¶é—´ &lt; 1/60s å‘¢ï¼Ÿ<br>è­¬å¦‚ä½ æŠŠæ‰‹æœºæ”¾åœ¨é‚£çœ‹ç€ appï¼Œrunloop åœ¨é‚£ç¡è§‰(<code>kCFRunLoopBeforeWaiting</code>)</p><p>è¿™ä¸ªæ—¶å€™å¾€ runloop é‡Œé¢æ”¾ä¸ª source or timerï¼Œrunloop å°±ä¼šé†’æ¥ è¿›å…¥ <code>kCFRunLoopAfterWaiting</code> çŠ¶æ€</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">BeforeWaitingDo</span> = () -&gt; ()</span><br><span class="line"><span class="keyword">var</span> tasks: [<span class="type">BeforeWaitingDo</span>] = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">exec</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> t = <span class="keyword">self</span>.tasks.remove(at: <span class="number">0</span>)</span><br><span class="line">  t()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerObserver</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> rl = <span class="type">CFRunLoopGetCurrent</span>()</span><br><span class="line">  <span class="keyword">let</span> observer = <span class="type">CFRunLoopObserverCreateWithHandler</span>(kCFAllocatorDefault, <span class="type">CFRunLoopActivity</span>.beforeWaiting.rawValue, <span class="literal">true</span>, <span class="number">0</span>) &#123;[<span class="keyword">weak</span> <span class="keyword">self</span>] (observer, actives) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span>,</span><br><span class="line">    <span class="keyword">let</span> <span class="number">_</span> = <span class="keyword">self</span>.tasks.first <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª source0 æŠŠ runloop è¢«å«é†’</span></span><br><span class="line">    <span class="keyword">self</span>.perform(#selector(<span class="type">ChatEmojiViewController</span>.exec), on: <span class="type">Thread</span>.current, with: <span class="literal">nil</span>, waitUntilDone: <span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">CFRunLoopAddObserver</span>(rl, observer, <span class="type">CFRunLoopMode</span>.commonModes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Ftime.geekbang.org%2Fcolumn%2Fintro%2F161%3Fcode%3DQjb1JtJcvAPISj9QjxdKrAmeXmURMroQbkOcLNm0jeY%253D%26from%3Dsinglemessage%26isappinstalled%3D0" target="_blank" rel="noopener">ã€ŠiOSå¼€å‘é«˜æ‰‹è¯¾ã€‹</a><br><a href="https://www.jianshu.com/p/632d7a1526e9" target="_blank" rel="noopener">iOS æ€§èƒ½ç›‘æ§ï¼ˆäºŒï¼‰â€”â€” ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§</a><br><a href="https://blog.sunnyxx.com/2015/05/17/cell-height-calculation/" target="_blank" rel="noopener">ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—çš„é‚£äº›äº‹</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> runloop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°ƒè¯•å†…å­˜ä¸è¶³é—®é¢˜ï¼šä½¿ç”¨è¿è¡Œæ—¶é­”æ³•æ•è·å¸ƒå±€åé¦ˆå¾ªç¯</title>
      <link href="/2019/12/01/performance/%E8%B0%83%E8%AF%95%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E9%97%AE%E9%A2%98%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E9%AD%94%E6%B3%95%E6%8D%95%E8%8E%B7%E5%B8%83%E5%B1%80%E5%8F%8D%E9%A6%88%E5%BE%AA%E7%8E%AF/"/>
      <url>/2019/12/01/performance/%E8%B0%83%E8%AF%95%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E9%97%AE%E9%A2%98%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E9%AD%94%E6%B3%95%E6%8D%95%E8%8E%B7%E5%B8%83%E5%B1%80%E5%8F%8D%E9%A6%88%E5%BE%AA%E7%8E%AF/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>ç›®æ ‡ï¼š<br>ä½¿ç”¨ä»£ç æ›¿ä»£ <code>UIViewLayoutFeedbackLoopDebuggingThreshold</code> ç¬¦å·è°ƒè¯•ï¼Œæ¥æ•è· Autolayoutåé¦ˆå¾ªç¯æ‰€å¯¼è‡´çš„å†…å­˜ä¸è¶³é—®é¢˜ã€‚</p><h2 id="å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› "><a class="markdownIt-Anchor" href="#å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› "></a> å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› </h2><p>å¦‚æœ Appï¼Œå¼€å§‹æœ‰å¤§é‡æ—¥æ´»ç”¨æˆ·å¹¶ä¸”å´©æºƒç‡å¾ˆä½ï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´ï¼Œæ€»ä¼šå‡ºç°å´©æºƒé—®é¢˜ï¼Œæ£€æŸ¥ Fabric ä¹Ÿæ²¡å•¥ç”¨ã€‚</p><p>å‡ºç°è¿™ç§æƒ…å†µå¾ˆå¯èƒ½æ˜¯å› ä¸ºï¼Œå†…å­˜ä¸è¶³ï¼Œå¯¼è‡´åº”ç”¨è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</p><p>å¯¼è‡´å†…å­˜ä¸è¶³çš„åŸå› ï¼š</p><ul><li>å¾ªç¯å¼•ç”¨;</li><li>ç«äº‰æ¡ä»¶;</li><li>åºŸå¼ƒçš„çº¿ç¨‹;</li><li>æ­»é”;</li><li>å¸ƒå±€åé¦ˆå¾ªç¯ã€‚</li></ul><p>Apple æä¾›äº†å¾ˆå¤šæ–¹æ³•æ¥è§£å†³è¿™ç±»é—®é¢˜ï¼š</p><ul><li>Instruments é‡Œçš„ Allocations å’Œ Leaks å·¥å…·ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨å’Œ <a href="https://developer.apple.com/videos/play/wwdc2015/230/" target="_blank" rel="noopener">å…¶ä»–ç±»å‹çš„æ³„æ¼</a></li><li>åœ¨ Xcode 8 ä¸­å¼•å…¥çš„ <a href="https://developer.apple.com/videos/play/wwdc2016/410/" target="_blank" rel="noopener">Memory Debugger</a> ä»£æ›¿äº† Allocations å’Œ Leaks çš„ä¸€éƒ¨åˆ†åŠŸèƒ½</li><li><a href="https://developer.apple.com/videos/play/wwdc2016/412/" target="_blank" rel="noopener">Thread Sanitizer</a> å¸®åŠ©ä½ æ‰¾åˆ°ç«äº‰æ¡ä»¶ã€åºŸå¼ƒçš„çº¿ç¨‹æˆ–è€…æ­»é”</li></ul><h2 id="å¸ƒå±€åé¦ˆå¾ªç¯"><a class="markdownIt-Anchor" href="#å¸ƒå±€åé¦ˆå¾ªç¯"></a> å¸ƒå±€åé¦ˆå¾ªç¯</h2><blockquote><p>å½“è§†å›¾æ­£åœ¨è¿è¡Œå®ƒä»¬çš„å¸ƒå±€ä»£ç ï¼Œä½†æŸç§æ–¹æ³•å¯¼è‡´å®ƒä»¬å†ä¸€æ¬¡å¼€å§‹å¸ƒå±€ä¼ é€’ï¼Œæ­¤æ—¶å¸ƒå±€åé¦ˆå¾ªç¯å°±ä¼šå‡ºç°ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºæŸä¸ªè§†å›¾æ­£åœ¨æ”¹å˜æŸä¸ªçˆ¶è§†å›¾çš„å¤§å°ï¼Œæˆ–è€…å› ä¸ºä½ æœ‰ä¸€ä¸ªæ¨¡æ£±ä¸¤å¯çš„å¸ƒå±€ã€‚æ— è®ºå“ªç§åŸå› ï¼Œè¿™ä¸ªé—®é¢˜çš„è¡¨ç°æ˜¯ä½ çš„ CPU ä½¿ç”¨è¢«å æ»¡å’Œ RAM ä½¿ç”¨é‡ç¨³æ­¥ä¸Šå‡ï¼Œå› ä¸ºä½ çš„è§†å›¾æ­£åœ¨ä¸€æ¬¡åˆä¸€æ¬¡åœ°è¿è¡Œå®ƒä»¬çš„å¸ƒå±€ä»£ç ï¼Œå´æ²¡æœ‰è¿”å›ã€‚<br>-æ¥è‡ª<a href="https://www.hackingwithswift.com/articles/59/debugging-auto-layout-feedback-loops" target="_blank" rel="noopener">HackingWithSwift çš„ Paul Hudson</a></p></blockquote><p>åœ¨ WWDC 16 ä¸­ Apple ä»‹ç»äº†â€œå¸ƒå±€åé¦ˆå¾ªç¯è°ƒè¯•å™¨â€ã€‚è¿™ä¸ªè°ƒè¯•å™¨æœ‰åŠ©äºè¯†åˆ«åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¾ªç¯çš„æ—¶é—´ç‚¹ã€‚è¿™å°±æ˜¯ä¸€ä¸ªç¬¦å·æ–­ç‚¹ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼éå¸¸ç®€å•ï¼šå®ƒä¼šè®¡ç®—åœ¨å•ä¸ª run loop è¿­ä»£ä¸­è°ƒç”¨æ¯ä¸ªè§†å›¾ä¸Šçš„ <font color="red">layoutSubviews()</font> æ–¹æ³•çš„æ¬¡æ•°ã€‚ä¸€æ—¦è¿™ä¸ªè®¡æ•°å€¼è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼ï¼ˆæ¯”å¦‚ï¼Œ100ï¼‰ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°†ä¼šåœåœ¨è¿™ä¸ªæ–­ç‚¹å¹¶æ‰“å°å‡ºæ—¥å¿—ã€‚<a href="https://www.hackingwithswift.com/articles/59/debugging-auto-layout-feedback-loops" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> å¿«é€Ÿåœ°ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™ä¸ªè°ƒè¯•å™¨ã€‚</p><p>è¿™ä¸ªæ–¹æ³•åœ¨å¯ä»¥é‡ç°é—®é¢˜çš„æƒ…å†µä¸‹ååˆ†æœ‰æ•ˆã€‚ä½†æ˜¯åœ¨çº¿ä¸Šå‡ºç°å°±ä¸ç”¨å®¹æ˜“è°ƒè¯•ã€‚ä½†æ˜¯ä½ å¯ä»¥å°è¯•æŠŠ <font color="red">UIViewLayoutFeedbackLoopDebuggingThreshold</font> çš„ä»£ç å¤åˆ¶åˆ°ç”Ÿäº§ä»£ç ä¸­ã€‚</p><h3 id="å¦‚ä½•ç”¨ä»£ç å®ç°-uiviewlayoutfeedbackloopdebuggingthreshold-çš„åŠŸèƒ½å‘¢"><a class="markdownIt-Anchor" href="#å¦‚ä½•ç”¨ä»£ç å®ç°-uiviewlayoutfeedbackloopdebuggingthreshold-çš„åŠŸèƒ½å‘¢"></a> å¦‚ä½•ç”¨ä»£ç å®ç° UIViewLayoutFeedbackLoopDebuggingThreshold çš„åŠŸèƒ½å‘¢</h3><p>ç¬¦å·æ–­ç‚¹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šå®ƒä¼šè®¡ç®— layoutSubviews() çš„è°ƒç”¨æ¬¡æ•°å¹¶åœ¨å•ä¸ª run loop è¿­ä»£ä¸­è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼æ—¶å‘é€ä¸€ä¸ªäº‹ä»¶ã€‚å¬èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿ</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrackableView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> counter: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.layoutSubviews()</span><br><span class="line">    counter += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (counter == <span class="number">100</span>) &#123;</span><br><span class="line">      <span class="type">YourAnalyticsFramework</span>.event(name: <span class="string">"loop"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å¯¹äºä¸€ä¸ªè§†å›¾ï¼Œè¿™æ®µä»£ç è¿è¡Œæ­£å¸¸ã€‚</li><li>ä½†æ˜¯ç°åœ¨ä½ æƒ³è¦åœ¨å¦ä¸€ä¸ªè§†å›¾ä¸Šå®ç°å®ƒã€‚å½“ç„¶ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª UIView çš„å­ç±»ï¼Œåœ¨è¿™é‡Œå®ç°å®ƒå¹¶ä½¿ä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰è§†å›¾éƒ½ç»§æ‰¿è¿™ä¸ªå­ç±»ã€‚</li><li>ç„¶åä¸º UITableViewï¼ŒUIScrollViewï¼ŒUIStackView ç­‰åšåŒæ ·çš„äº‹æƒ…ã€‚</li></ol><p>å¦‚æœå°†æ­¤é€»è¾‘æ³¨å…¥ä½ æƒ³è¦çš„ä»»ä½•ç±»ï¼Œè€Œæ— éœ€ç¼–å†™å¤§é‡é‡å¤çš„ä»£ç ã€‚è¿™æ—¶å€™å°±å¯ä»¥ <code>å€ŸåŠ©è¿è¡Œæ—¶ç¼–ç¨‹</code> äº†ã€‚</p><h3 id="ä½¿ç”¨-runtime-å®ç°å­ç±»"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-runtime-å®ç°å­ç±»"></a> ä½¿ç”¨ runtime å®ç°å­ç±»</h3><p>æˆ‘ä»¬ä¼šåšåŒæ ·çš„äº‹æƒ…â€”â€”åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œé‡å†™ layoutSubviews() æ–¹æ³•å¹¶è®¡ç®—å…¶è°ƒç”¨æ¬¡æ•°ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨ runtime å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨é¡¹ç›®ä¸­åˆ›å»ºé‡å¤çš„ç±»ã€‚</p><p><strong>åˆ›å»ºè‡ªå®šä¹‰å­ç±»</strong>ï¼Œå¹¶å°†åŸå§‹è§†å›¾çš„ç±»æ›´æ”¹ä¸ºæ–°çš„å­ç±»ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LayoutLoopHunter</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">RuntimeConstants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Prefix</span> = â€œruntimeâ€</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">setUp</span><span class="params">(<span class="keyword">for</span> view: UIView, threshold: Int = <span class="number">100</span>, onLoop: @escaping <span class="params">()</span></span></span> -&gt; ()) &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§°ã€‚</span></span><br><span class="line">    <span class="keyword">let</span> classFullName = â€œ\(<span class="type">RuntimeConstants</span>.<span class="type">Prefix</span>)<span class="number">_</span>\(<span class="type">String</span>(describing: view.<span class="keyword">self</span>))â€</span><br><span class="line">    <span class="keyword">let</span> originalClass = type(of: view)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = objc_allocateClassPair(originalClass, classFullName, <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±»ã€‚</span></span><br><span class="line">      <span class="comment">// æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶ä¸”ç”¨åŸå§‹è§†å›¾çš„ç±»æ¥å’Œå®ƒäº¤æ¢ã€‚</span></span><br><span class="line">      objc_registerClassPair(trackableClass)</span><br><span class="line">      object_setClass(view, trackableClass)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = <span class="type">NSClassFromString</span>(classFullName) &#123;</span><br><span class="line">      <span class="comment">// æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»ã€‚</span></span><br><span class="line">      <span class="comment">// æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢ã€‚</span></span><br><span class="line">      object_setClass(view, trackableClass)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>objc_allocateClassPair() æ–¹æ³•çš„æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæ–¹æ³•ä½•æ—¶å¤±è´¥ï¼š</li></ol><blockquote><p>æ–°ç±»ï¼Œæˆ–è€…å¦‚æœæ— æ³•åˆ›å»ºç±»ï¼Œåˆ™ä¸º Nil ï¼ˆä¾‹å¦‚ï¼Œæ‰€éœ€åç§°å·²è¢«ä½¿ç”¨ï¼‰ã€‚</p></blockquote><p>è¿™å°±æ„å‘³ç€ä¸èƒ½æ‹¥æœ‰ä¸¤ä¸ªåŒåçš„ç±»ã€‚æˆ‘ä»¬çš„ç­–ç•¥æ˜¯ä¸ºå•ä¸ªè§†å›¾ç±»åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶ç±»ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨åŸå§‹ç±»åå‰åŠ ä¸Šå‰ç¼€æ¥å½¢æˆæ–°ç±»çš„åç§°çš„åŸå› ã€‚</p><ol start="2"><li>ç°åœ¨æ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨åˆ°å­ç±»ä¸­ã€‚ç†è®ºä¸Šï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</li><li>æ·»åŠ ä¸€ä¸ªä¿å­˜è®¡æ•°å™¨çš„å±æ€§ã€‚</li><li>ä¸ºè¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªå…³è”å¯¹è±¡ï¼ˆAssociated objectï¼‰ã€‚</li></ol><p>ä½†æ˜¯ç›®å‰ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•å¥æ•ˆã€‚ä½ å¯ä»¥æƒ³è±¡å±æ€§æ˜¯å­˜å‚¨åœ¨åˆ†é…ç»™ç±»çš„å†…å­˜é‡Œçš„ä¸œè¥¿ï¼Œç„¶è€Œå…³è”å¯¹è±¡åˆ™å‚¨å­˜åœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„åœ°æ–¹ã€‚å› ä¸ºåˆ†é…ç»™å·²å­˜åœ¨å¯¹è±¡çš„å†…å­˜æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬<font color="red">åœ¨è‡ªå®šä¹‰ç±»ä¸Šæ–°æ·»åŠ çš„å±æ€§å°†ä¼šä»å…¶ä»–èµ„æºé‡Œâ€œçªƒå–â€å†…å­˜</font>ã€‚å®ƒå¯èƒ½å¯¼è‡´æ„æ–™ä¹‹å¤–çš„è¡Œä¸ºå’Œéš¾ä»¥è°ƒè¯•çš„ç¨‹åºå´©æºƒï¼ˆç‚¹å‡» <a href="https://stackoverflow.com/questions/3346427/object-setclass-to-bigger-class" target="_blank" rel="noopener">è¿™é‡Œ</a> æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼‰ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨å…³è”å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬å°†ä¼šå­˜å‚¨åœ¨è¿è¡Œæ—¶åˆ›å»ºçš„ä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œï¼Œè¿™æ˜¯å®Œå…¨å®‰å…¨çš„ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">var</span> <span class="type">CounterKey</span> = <span class="string">"_counter"</span></span><br><span class="line">...</span><br><span class="line">objc_setAssociatedObject(trackableClass, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, <span class="number">0</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br></pre></td></tr></table></figure><p>å½“æ–°çš„å­ç±»è¢«åˆ›å»ºæ—¶ï¼Œè®¡æ•°å™¨åˆå€¼è®¾ç½®ä¸º 0ã€‚</p><p><strong>å®ç°è¿™ä¸ªæ–°çš„layoutSubviews() æ–¹æ³•ï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ç±»ä¸­</strong>ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> layoutSubviews: <span class="meta">@convention</span>(block) (<span class="type">Any?</span>) -&gt; () = &#123; nullableSelf <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> _self = nullableSelf <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> counter = objc_getAssociatedObject(_self, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>) <span class="keyword">as</span>? <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> counter == threshold &#123;</span><br><span class="line">      onLoop()</span><br><span class="line">    &#125;</span><br><span class="line">    objc_setAssociatedObject(trackableClass, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, counter+<span class="number">1</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> implementation = imp_implementationWithBlock(layoutSubviews)</span><br><span class="line">class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, <span class="string">"v@:"</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ç†è§£ä¸Šé¢è¿™æ®µä»£ç å®é™…ä¸Šåœ¨å¹²ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥è‡ª &lt;objc/runtime.h&gt; çš„ç»“æ„ä½“ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_method</span> </span>&#123;</span><br><span class="line">  <span class="type">SEL</span> method_name;</span><br><span class="line">  char *method_types;</span><br><span class="line">  <span class="type">IMP</span> method_imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•å®é™…ä¸Šæ˜¯ç”±ä»€ä¹ˆç»„æˆçš„ï¼š</p><ul><li>æ–¹æ³•çš„å®ç° method_impï¼Œè¿™æ˜¯è°ƒç”¨æ–¹æ³•æ—¶è¦æ‰§è¡Œçš„å®é™…å‡½æ•°ã€‚å®ƒçš„å‰ä¸¤ä¸ªå½¢å‚æ€»æ˜¯æ–¹æ³•æ¥æ”¶è€…å’Œæ¶ˆæ¯é€‰æ‹©å™¨ã€‚</li><li>åŒ…å«æ–¹æ³•ç­¾åçš„æ–¹æ³•ç±»å‹å­—ç¬¦ä¸² method_typesã€‚ä½ å¯ä»¥åœ¨ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener">è¿™é‡Œ</a> è¯¦ç»†äº†è§£å…¶æ ¼å¼ã€‚ä½†æ˜¯åœ¨ç°åœ¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ˜ç¡®è¯´æ˜çš„å­—ç¬¦ä¸²æ˜¯ â€œv@:â€ã€‚ä½œä¸ºè¿”å›ç±»å‹ï¼Œv ä»£è¡¨ voidï¼Œè€Œ @ å’Œ : åˆ†åˆ«ä»£è¡¨æ¥æ”¶è€…å’Œæ¶ˆæ¯é€‰æ‹©å™¨ã€‚</li><li>é€‰æ‹©å™¨ method_name ä½œä¸ºé”®ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥æ‰¾æ–¹æ³•çš„å®ç°ã€‚</li></ul><p>ä½ å¯ä»¥æŠŠ Witness Tableï¼ˆåœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®ƒä¹Ÿè¢«ç§°ä½œæ–¹æ³•æ´¾å‘è¡¨ï¼‰æƒ³è±¡æˆä¸€ä¸ªç®€å•çš„å­—å…¸æ•°æ®ç»“æ„ã€‚é‚£ä¹ˆé€‰æ‹©å™¨ä¸ºé”®ï¼Œä¸”å®ç°éƒ¨åˆ†åˆ™ä¸ºå¯¹åº”çš„å€¼ã€‚<br>åœ¨ä¸‹é¢è¿™è¡Œä»£ç ä¸­:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class_addMethod(trackableClass,#selector(originalClass.layoutSubviews), implementation, <span class="string">"v@:"</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰€åšçš„æ˜¯ç»™ layoutSubviews() æ–¹æ³•å¯¹åº”çš„é”®åˆ†é…æ–°å€¼ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ç›´æˆªäº†å½“ã€‚æˆ‘ä»¬è·å¾—è¿™ä¸ªè®¡æ•°å™¨ï¼Œä½¿å®ƒçš„è®¡æ•°å€¼åŠ ä¸€ã€‚å¦‚æœè®¡æ•°å€¼è¶…è¿‡ä¸´ç•Œå€¼ï¼Œæˆ‘ä»¬ä¼šå‘é€åˆ†æäº‹ä»¶ï¼Œå…¶ä¸­åŒ…å«ç±»åå’Œæƒ³è¦çš„ä»»ä½•æ•°æ®ä½“ã€‚</p><p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å¦‚ä½•å¯¹å…³è”å¯¹è±¡å®ç°å’Œä½¿ç”¨é”®ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">var</span> <span class="type">CounterKey</span> = â€œ_counterâ€</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">objc_setAssociatedObject(trackableClass, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, counter+<span class="number">1</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ var æ¥ä¿®é¥°è®¡æ•°å™¨çš„é”®è¿™ä¸ªé™æ€å±æ€§å¹¶åœ¨ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹æ—¶ä½¿ç”¨å¼•ç”¨ï¼Ÿç­”æ¡ˆéšè—åœ¨ Swift è¯­è¨€åŸºç¡€â€”â€”å­—ç¬¦ä¸²ä¹‹ä¸­ã€‚å­—ç¬¦ä¸²åƒå…¶ä»–æ‰€æœ‰çš„å€¼ç±»å‹ä¸€æ ·ï¼Œæ˜¯æŒ‰å€¼ä¼ é€’çš„ã€‚é‚£ä¹ˆï¼Œå½“ä½ æŠŠå®ƒä¼ å…¥è¿™ä¸ªé—­åŒ…æ—¶ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°†ä¼šè¢«å¤åˆ¶åˆ°ä¸€ä¸ªä¸åŒçš„åœ°å€ï¼Œè¿™ä¼šå¯¼è‡´åœ¨å…³è”å¯¹è±¡è¡¨ä¸­äº§ç”Ÿä¸€ä¸ªå®Œå…¨ä¸åŒçš„é”®ã€‚&amp; ç¬¦å·æ€»æ˜¯ä¿è¯å°†ç›¸åŒçš„åœ°å€ä½œä¸ºé”®å‚æ•°çš„å€¼ã€‚ä½ å¯ä»¥å°è¯•ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printAddress</span><span class="params">(<span class="number">_</span> string: UnsafeRawPointer)</span></span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"\(string)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> str = <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line">printAddress(str)</span><br><span class="line">printAddress(str)</span><br><span class="line"><span class="keyword">let</span> closure = &#123;</span><br><span class="line">  printAddress(str)</span><br><span class="line">  printAddress(str)</span><br><span class="line">&#125;</span><br><span class="line">closure()</span><br><span class="line"><span class="comment">// æœ€åä¸¤ä¸ªå‡½æ•°è°ƒç”¨çš„åœ°å€å°†å§‹ç»ˆä¸åŒ</span></span><br></pre></td></tr></table></figure><p>ç”¨å¼•ç”¨çš„æ–¹å¼æ¥ä¼ é€’é”®çš„ä¸»æ„æ€»æ˜¯å¥½çš„ï¼Œå› ä¸ºæœ‰æ—¶ï¼Œå³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨é—­åŒ…ï¼Œå˜é‡çš„åœ°å€ä»å¯èƒ½å› å†…å­˜ç®¡ç†è€Œæ›´æ”¹ã€‚åœ¨æˆ‘ä»¬ä¾‹å­ä¸­ï¼Œå¦‚æœä½ æŠŠä¸Šé¢çš„ä»£ç è¿è¡Œå¤šæ¬¡ï¼Œå³ä½¿æ˜¯å‰ä¸¤ä¸ª printAddress() çš„è°ƒç”¨ä¹Ÿå¯èƒ½ä¼šè¾“å‡ºä¸åŒçš„åœ°å€ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°è¿è¡Œæ—¶çš„é­”æ³•é‡Œæ¥ã€‚åœ¨æ–° layoutSubviews() çš„å®ç°é‡Œï¼Œè¿˜æœ‰ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…æ²¡æœ‰å®Œæˆã€‚è¿™ä»¶äº‹æ˜¯æ¯æ¬¡é‡å†™çˆ¶ç±»çš„æ–¹æ³•æ—¶é€šå¸¸éƒ½ä¼šåšçš„äº‹æƒ…â€”â€”è°ƒç”¨çˆ¶ç±»å®ç°ã€‚layoutSubviews() çš„æ–‡æ¡£é‡Œæåˆ°ï¼š</p><blockquote><p>åœ¨ iOS 5.1 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚è€Œä¹‹åçš„é»˜è®¤å®ç°ä¼šä½¿ç”¨ä½ è®¾ç½®çš„ä»»ä½•çº¦æŸæ¥ç¡®å®šä»»ä½•å­è§†å›¾çš„å¤§å°å’Œä½ç½®ã€‚</p></blockquote><p>ä¸ºäº†é¿å…å‘ç”Ÿä¸€äº›éš¾ä»¥é¢„æ–™çš„å¸ƒå±€è¡Œä¸ºï¼Œæˆ‘ä»¬å¾—è°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œä½†è¿™ä¸åƒå¹³å¸¸é‚£æ ·ç®€å•æ˜äº†ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> selector = #selector(originalClass.layoutSubviews)</span><br><span class="line"><span class="keyword">let</span> originalImpl = class_getMethodImplementation(originalClass, selector)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">// @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</span></span><br><span class="line"><span class="comment">// æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦</span></span><br><span class="line"><span class="keyword">typealias</span> <span class="type">ObjCVoidVoidFn</span> = <span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Any</span>, <span class="type">Selector</span>) -&gt; <span class="type">Void</span></span><br><span class="line"><span class="keyword">let</span> originalLayoutSubviews = <span class="built_in">unsafeBitCast</span>(originalImpl, to: <span class="type">ObjCVoidVoidFn</span>.<span class="keyword">self</span>)</span><br><span class="line">originalLayoutSubviews(view, selector)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®é™…å‘ç”Ÿçš„æ˜¯ï¼šæˆ‘ä»¬æ£€ç´¢æ–¹æ³•æ‰€éœ€çš„å®ç°éƒ¨åˆ†ï¼Œå¹¶ç›´æ¥ä»ä»£ç ä¸­è°ƒç”¨å®ƒï¼Œè€Œä¸æ˜¯ç”¨å¸¸è§çš„æ–¹å¼æ¥è°ƒç”¨æ–¹æ³•ï¼ˆå³æ‰§è¡Œä¸€ä¸ªä¼šåœ¨ Witness Table ä¸­å¯»æ‰¾å¯¹åº”å®ç°çš„é€‰æ‹©å™¨ï¼‰ã€‚</p><p>ç›®å‰ä¸ºæ­¢ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ç°éƒ¨åˆ†ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">setUp</span><span class="params">(<span class="keyword">for</span> view: UIView, threshold: Int = <span class="number">100</span>, onLoop: @escaping <span class="params">()</span></span></span> -&gt; ()) &#123;</span><br><span class="line">  <span class="comment">// æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§°</span></span><br><span class="line">  <span class="keyword">let</span> classFullName = â€œ\(<span class="type">RuntimeConstants</span>.<span class="type">Prefix</span>)<span class="number">_</span>\(<span class="type">String</span>(describing: view.<span class="keyword">self</span>))â€</span><br><span class="line">  <span class="keyword">let</span> originalClass = type(of: view)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = objc_allocateClassPair(originalClass, classFullName, <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±»</span></span><br><span class="line">    <span class="comment">// æ³¨å†Œè¿™ä¸ªç±»å¹¶å°†å…¶ä¸åŸå§‹è§†å›¾çš„ç±»äº¤æ¢</span></span><br><span class="line">    objc_registerClassPair(trackableClass)</span><br><span class="line">    object_setClass(view, trackableClass)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç°åœ¨å¯ä»¥åˆ›å»ºå…³è”å¯¹è±¡</span></span><br><span class="line">    objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, <span class="number">0</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ æˆ‘ä»¬è‡ªå·± layoutSubviews çš„å®ç°</span></span><br><span class="line">    <span class="keyword">let</span> layoutSubviews: <span class="meta">@convention</span>(block) (<span class="type">Any?</span>) -&gt; () = &#123; nullableSelf <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> _self = nullableSelf <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> selector = #selector(originalClass.layoutSubviews)</span><br><span class="line">      <span class="keyword">let</span> originalImpl = class_getMethodImplementation(originalClass, selector)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</span></span><br><span class="line">      <span class="comment">// æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">      <span class="comment">// æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦</span></span><br><span class="line">      <span class="keyword">typealias</span> <span class="type">ObjCVoidVoidFn</span> = <span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Any</span>, <span class="type">Selector</span>) -&gt; <span class="type">Void</span></span><br><span class="line">      <span class="keyword">let</span> originalLayoutSubviews = <span class="built_in">unsafeBitCast</span>(originalImpl, to: <span class="type">ObjCVoidVoidFn</span>.<span class="keyword">self</span>)</span><br><span class="line">      originalLayoutSubviews(view, selector)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> counter = objc_getAssociatedObject(_self, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>) <span class="keyword">as</span>? <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> counter == threshold &#123;</span><br><span class="line">          onLoop()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, counter+<span class="number">1</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> implementation = imp_implementationWithBlock(layoutSubviews)</span><br><span class="line">    class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, â€œv@:â€œ)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = <span class="type">NSClassFromString</span>(classFullName) &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»</span></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢</span></span><br><span class="line">    object_setClass(view, trackableClass)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬ä¸ºè§†å›¾åˆ›å»ºæ¨¡æ‹Ÿå¸ƒå±€å¾ªç¯ï¼Œå¹¶ä¸ºå…¶è®¾ç½®è®¡æ•°å™¨æ¥è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"> </span><br><span class="line">    <span class="type">LayoutLoopHunter</span>.setUp(<span class="keyword">for</span>: view) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Hello, world"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLayoutSubviews</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLayoutSubviews()</span><br><span class="line">    view.setNeedsLayout() <span class="comment">// loop creation</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å¿˜è®°äº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿè®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹ UIViewLayoutFeedbackLoopDebuggingThreshold æ–­ç‚¹çš„å·¥ä½œåŸç†ï¼š</p><blockquote><p>åœ¨ç¡®è®¤ä¸ºåé¦ˆå¾ªç¯ä¹‹å‰ï¼Œå®šä¹‰æŸä¸ªè§†å›¾çš„å­è§†å›¾åœ¨å•ä¸ª run loop é‡Œå¿…é¡»å¸ƒå±€çš„æ¬¡æ•°</p></blockquote><p>æˆ‘ä»¬ä»æœªæŠŠâ€œå•ä¸ª run loop â€è¿™ä¸€æ¡ä»¶è€ƒè™‘è¿›æ¥ã€‚å¦‚æœè§†å›¾åœ¨å±å¹•ä¸Šåœç•™äº†ç›¸å½“é•¿çš„æ—¶é—´ï¼Œå¹¶ç»å¸¸è¢«åå¤å¸ƒå±€ï¼Œè®¡æ•°å™¨è¿Ÿæ—©ä¼šè¶…è¿‡ä¸´ç•Œå€¼ã€‚ä½†è¿™å¯ä¸æ˜¯å› ä¸ºå†…å­˜çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåªéœ€åœ¨æ¯æ¬¡ run loop è¿­ä»£æ—¶é‡ç½®è®¡æ•°å™¨ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <a href="https://www.appcoda.com/grand-central-dispatch/" target="_blank" rel="noopener">DispatchWorkItem</a>ï¼Œå®ƒé‡ç½®è®¡æ•°å™¨ï¼Œå¹¶åœ¨ä¸»é˜Ÿåˆ—ä¸Šå¼‚æ­¥ä¼ é€’å®ƒã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ƒä¼šåœ¨ run loop ä¸‹ä¸€æ¬¡è¿›å…¥ä¸»çº¿ç¨‹æ—¶è¢«è°ƒç”¨ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">var</span> <span class="type">ResetWorkItemKey</span> = â€œ_resetWorkItemâ€</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> previousResetWorkItem = objc_getAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">ResetWorkItemKey</span>) <span class="keyword">as</span>? <span class="type">DispatchWorkItem</span> &#123;</span><br><span class="line">  previousResetWorkItem.cancel()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> currentResetWorkItem = <span class="type">DispatchWorkItem</span> &#123; [<span class="keyword">weak</span> view] <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> strongView = view <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  objc_setAssociatedObject(strongView, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, <span class="number">0</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">DispatchQueue</span>.main.async(execute: currentResetWorkItem)</span><br><span class="line">objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">ResetWorkItemKey</span>, currentResetWorkItem, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„ä»£ç ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LayoutLoopHunter</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">RuntimeConstants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Prefix</span> = â€œruntimeâ€</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Associated objects keys</span></span><br><span class="line">    <span class="comment">// å…³è”å¯¹è±¡é”®</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> <span class="type">CounterKey</span> = â€œ_counterâ€</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> <span class="type">ResetWorkItemKey</span> = â€œ_resetWorkItemâ€</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">setUp</span><span class="params">(<span class="keyword">for</span> view: UIView, threshold: Int = <span class="number">100</span>, onLoop: @escaping <span class="params">()</span></span></span> -&gt; ()) &#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬æ ¹æ®åŠŸèƒ½çš„å‰ç¼€å’ŒåŸå§‹ç±»åä¸ºæ–°ç±»åˆ›å»ºåç§°ã€‚</span></span><br><span class="line">    <span class="keyword">let</span> classFullName = â€œ\(<span class="type">RuntimeConstants</span>.<span class="type">Prefix</span>)<span class="number">_</span>\(<span class="type">String</span>(describing: view.<span class="keyword">self</span>))â€</span><br><span class="line">    <span class="keyword">let</span> originalClass = type(of: view)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = objc_allocateClassPair(originalClass, classFullName, <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// åœ¨å½“å‰è¿è¡Œæ—¶ä¼šè¯æœŸé—´å°šæœªåˆ›å»ºæ­¤ç±»ã€‚</span></span><br><span class="line">      <span class="comment">// æ³¨å†Œè¿™ä¸ªç±»ï¼Œå¹¶ä¸”ç”¨åŸå§‹è§†å›¾çš„ç±»æ¥å’Œå®ƒäº¤æ¢ã€‚</span></span><br><span class="line">      objc_registerClassPair(trackableClass)</span><br><span class="line">      object_setClass(view, trackableClass)</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// ç°åœ¨å¯ä»¥åˆ›å»ºå…³è”å¯¹è±¡</span></span><br><span class="line">      objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, <span class="number">0</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// æ·»åŠ æˆ‘ä»¬è‡ªå·± layoutSubviews çš„å®ç°</span></span><br><span class="line">      <span class="keyword">let</span> layoutSubviews: <span class="meta">@convention</span>(block) (<span class="type">Any?</span>) -&gt; () = &#123; nullableSelf <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> _self = nullableSelf <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">let</span> selector = #selector(originalClass.layoutSubviews)</span><br><span class="line">        <span class="keyword">let</span> originalImpl = class_getMethodImplementation(originalClass, selector)</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// @convention(c) å‘ŠçŸ¥ Swift è¿™æ˜¯ä¸€ä¸ªè£¸å‡½æ•°æŒ‡é’ˆï¼ˆæ²¡æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰</span></span><br><span class="line">        <span class="comment">// æ‰€æœ‰çš„ Obj-C æ–¹æ³•å‡½æ•°æŠŠæ¥æ”¶è€…å’Œæ¶ˆæ¯å½“ä½œå‰ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¿™æ„å‘³ç€ä¸€ä¸ªç±»å‹ä¸º `() -&gt; Void` çš„æ–¹æ³•ï¼Œè¿™ä¸ `layoutSubview` æ–¹æ³•ç›¸ç¬¦</span></span><br><span class="line">        <span class="keyword">typealias</span> <span class="type">ObjCVoidVoidFn</span> = <span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Any</span>, <span class="type">Selector</span>) -&gt; <span class="type">Void</span></span><br><span class="line">        <span class="keyword">let</span> originalLayoutSubviews = <span class="built_in">unsafeBitCast</span>(originalImpl, to: <span class="type">ObjCVoidVoidFn</span>.<span class="keyword">self</span>)</span><br><span class="line">        originalLayoutSubviews(view, selector)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> counter = objc_getAssociatedObject(_self, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>) <span class="keyword">as</span>? <span class="type">Int</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> counter == threshold &#123;</span><br><span class="line">            onLoop()</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, counter+<span class="number">1</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// ä¸ºé‡ç½®è®¡æ•°å™¨ï¼Œåœ¨æ¯ä¸ªæ–°çš„ run loop éå†ä¸­åˆ†å‘ work item</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> previousResetWorkItem = objc_getAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">ResetWorkItemKey</span>) <span class="keyword">as</span>? <span class="type">DispatchWorkItem</span> &#123;</span><br><span class="line">          previousResetWorkItem.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> counterResetWorkItem = <span class="type">DispatchWorkItem</span> &#123; [<span class="keyword">weak</span> view] <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">guard</span> <span class="keyword">let</span> strongView = view <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">          objc_setAssociatedObject(strongView, &amp;<span class="type">RuntimeConstants</span>.<span class="type">CounterKey</span>, <span class="number">0</span>, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async(execute: counterResetWorkItem)</span><br><span class="line">        objc_setAssociatedObject(view, &amp;<span class="type">RuntimeConstants</span>.<span class="type">ResetWorkItemKey</span>, counterResetWorkItem, .<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> implementation = imp_implementationWithBlock(layoutSubviews)</span><br><span class="line">      class_addMethod(trackableClass, #selector(originalClass.layoutSubviews), implementation, â€œv@:â€œ)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> trackableClass = <span class="type">NSClassFromString</span>(classFullName) &#123;</span><br><span class="line">      <span class="comment">// æˆ‘ä»¬ä¹‹å‰åœ¨æ­¤è¿è¡Œæ—¶ä¼šè¯ä¸­åˆ†é…äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»ã€‚</span></span><br><span class="line">      <span class="comment">// æˆ‘ä»¬å¯ä»¥ä»åŸå§‹å­—ç¬¦ä¸²ä¸­è·å–å®ƒï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼ä¸æˆ‘ä»¬çš„è§†å›¾äº¤æ¢ã€‚</span></span><br><span class="line">      object_setClass(view, trackableClass)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><a class="markdownIt-Anchor" href="#ç»“è®º"></a> ç»“è®º</h2><p>æ˜¯çš„ï¼ç°åœ¨ä½ å¯ä»¥ä¸ºæ‰€æœ‰å¯ç–‘çš„è§†å›¾è®¾ç½®åˆ†æäº‹ä»¶äº†ï¼Œå‘å¸ƒåº”ç”¨ç¨‹åºï¼Œå¹¶æ‰¾åˆ°è¿™ä¸ªé—®é¢˜çš„ç¡®åˆ‡å‡ºå¤„ã€‚ä½ å¯ä»¥æŠŠè¿™ä¸ªé—®é¢˜çš„èŒƒå›´ç¼©å°åˆ°æŸä¸ªç‰¹å®šçš„è§†å›¾ï¼Œå¹¶åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å€ŸåŠ©äºä»–ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ€åè¦æåˆ°çš„ä¸€ä»¶äº‹æ˜¯ï¼šèƒ½åŠ›è¶Šå¤§è´£ä»»è¶Šå¤§ã€‚è¿è¡Œæ—¶ç¼–ç¨‹éå¸¸å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤å¾ˆå®¹æ˜“åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä¸ºåº”ç”¨ç¨‹åºå¼•å…¥å¦ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ€»æ˜¯å»ºè®®å°†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å±é™©ä»£ç åŒ…è£…åœ¨æŸç§å¯åœæ­¢å¼€å…³ä¸­ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨å‘ç°ä»£ç å¯¼è‡´é—®é¢˜æ—¶ä»åç«¯è§¦å‘å¼€å…³ç¦ç”¨è¯¥åŠŸèƒ½ã€‚è¿™æœ‰ä¸€ç¯‡ä»‹ç» Firebase çš„ Feature Flags çš„ <a href="https://medium.com/@rwbutler/feature-flags-a-b-testing-mvt-on-ios-718339ac7aa1" target="_blank" rel="noopener">(å¥½æ–‡ç« </a></p><p>å®Œæ•´ä»£ç å¯ä»¥ä»è¿™ä¸ª <a href="https://github.com/rsrbk/LayoutLoopHunter" target="_blank" rel="noopener">GitHub ä»“åº“</a> é‡Œè·å–ï¼Œå¹¶ä¸”ä¹Ÿå°†ä¼šå‘å¸ƒåˆ° CocoPods ä¸Šï¼Œä»¥è·Ÿè¸ªé¡¹ç›®ä¸­çš„å¸ƒå±€å¾ªç¯ã€‚</p><blockquote><p><a href="https://swift.gg/2019/11/11/layout-feedback-loop/" target="_blank" rel="noopener">å¤§é‡å¼•ç”¨</a><br>åŸæ–‡è¯»èµ·æ¥è´¹åŠ²ï¼Œåªæ˜¯æƒ³è®©è‡ªå·±è¯»çš„å®¹æ˜“å†™çš„è¿™ç¯‡æ–‡ç« </p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlamoFire åˆ†æ</title>
      <link href="/2019/08/23/source-code/AlamoFire-%E5%88%86%E6%9E%90/"/>
      <url>/2019/08/23/source-code/AlamoFire-%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>åˆ†ææºç ï¼š</p><ol><li>è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>éœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†</li><li>æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„</li><li>ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„</li><li>æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹</li><li>ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿ</li></ol><p>ä¸ºä»€ä¹ˆè¦åˆ†æ AlamoFire</p><ul><li>åˆ†æå®ƒçš„æ¥å£è®¾è®¡</li><li>åˆ†æä»–æ˜¯å¦‚ä½•å°è£… URL Loading System çš„</li><li>åˆ†æç½‘ç»œå±‚æ¬¡æ€è€ƒæ•°æ®ä¼ è¾“è¿‡ç¨‹</li></ul><p>AlamoFire éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</p><ul><li>Chainable Request / Response Methods</li><li>URL / JSON Parameter Encoding</li><li>Upload File / Data / Stream / MultipartFormData</li><li>Download File using Request or Resume Data</li><li>Authentication with URLCredential</li><li>HTTP Response Validation</li><li>Upload and Download Progress Closures with Progress</li><li>cURL Command Output</li><li>Dynamically Adapt and Retry Requests</li><li>TLS Certificate and Public Key Pinning</li><li>Network Reachability</li></ul><h2 id="foundation-ä¸­æä¾›çš„ç½‘ç»œç›¸å…³æ¥å£"><a class="markdownIt-Anchor" href="#foundation-ä¸­æä¾›çš„ç½‘ç»œç›¸å…³æ¥å£"></a> Foundation ä¸­æä¾›çš„ç½‘ç»œç›¸å…³æ¥å£</h2><p><code>AlamoFire</code> æ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚åº“ï¼Œåº•å±‚å°è£…çš„äº‹ Apple æä¾›çš„ <code>URL Loading System</code></p><h3 id="åå°-sessionä¸‹è½½æµç¨‹æ³¨æ„äº‹é¡¹"><a class="markdownIt-Anchor" href="#åå°-sessionä¸‹è½½æµç¨‹æ³¨æ„äº‹é¡¹"></a> åå° sessionä¸‹è½½æµç¨‹&amp;æ³¨æ„äº‹é¡¹</h3><p>åå° sessionConfiguration ä¸‹è½½æ–‡ä»¶ä¿å­˜ åˆ°æœ¬åœ°æ²™ç›’</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯åå° è¯·æ±‚ task</span></span><br><span class="line"><span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.background(withIdentifier: <span class="string">"com.czw.backgroundDownload"</span>)</span><br><span class="line"><span class="keyword">let</span> session = <span class="type">URLSession</span>.<span class="keyword">init</span>(configuration: configuration, delegate: <span class="keyword">self</span>, delegateQueue: <span class="type">OperationQueue</span>.main)</span><br><span class="line">session.downloadTask(with: <span class="type">URL</span>(string: urlDownloadStr)!).resume()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">URLSessionDownloadDelegate</span> </span>&#123;</span><br><span class="line"><span class="comment">// ä¸‹è½½å®Œæˆåä»£ç†å›è°ƒæ–¹æ³•ï¼Œå°†æ–‡ä»¶ç§»åŠ¨åˆ°æ²™ç›’æŒ‡å®šä½ç½®</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, downloadTask: URLSessionDownloadTask, didFinishDownloadingTo location: URL)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"ä¸‹è½½å®Œæˆ - \(location)"</span>)</span><br><span class="line">    <span class="keyword">let</span> locationPath = location.path</span><br><span class="line">    <span class="keyword">let</span> documnets = <span class="type">NSHomeDirectory</span>() + <span class="string">"/Documents/xxxx"</span> + <span class="string">".zip"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"ç§»åŠ¨åœ°å€:\(documnets)"</span>)</span><br><span class="line">    <span class="keyword">let</span> fileManager = <span class="type">FileManager</span>.<span class="keyword">default</span></span><br><span class="line">    <span class="keyword">try</span>! fileManager.moveItem(atPath: locationPath, toPath: documnets)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// http åˆ†æ®µä¼ è¾“ï¼Œä¼šä¸æ–­è°ƒç”¨è¿™ä¸ªæ–¹æ³•ç›´åˆ°ï¼Œå…¨éƒ¨ä¸‹è½½å®Œæˆ</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, downloadTask: URLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">" bytesWritten \(bytesWritten)\n totalBytesWritten \(totalBytesWritten)\n totalBytesExpectedToWrite \(totalBytesExpectedToWrite)"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"ä¸‹è½½è¿›åº¦: \(Double(totalBytesWritten)/Double(totalBytesExpectedToWrite))\n"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå°è¯·æ±‚ï¼Œéœ€è¦ç”³è¯·åå°æƒé™ï¼Œè¿™æ · app è¿›å…¥ background çš„æ—¶å€™æ‰å¯ä»¥ç»§ç»­ä¸‹è½½</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨äºä¿å­˜åå°ä¸‹è½½çš„completionHandler</span></span><br><span class="line"><span class="keyword">var</span> backgroundSessionCompletionHandler: (() -&gt; <span class="type">Void</span>)? </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, handleEventsForBackgroundURLSession identifier: String, completionHandler: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"background: \(identifier)"</span>)</span><br><span class="line">  <span class="keyword">self</span>.backgroundSessionCompletionHandler = completionHandler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-alamofire"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-alamofire"></a> ä½¿ç”¨ AlamoFire</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(urlString)</span><br><span class="line">  .responseJSON &#123; (data) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿä¸Šé¢å¯¹æ¯”[åŸç”Ÿçš„æ–¹æ³•(#code1), æ€è€ƒ <code>AlamoFire</code> éƒ½å°è£…äº†ä»€ä¹ˆï¼Œå¦‚ä½•å®ç°é“¾å¼è°ƒç”¨çš„ï¼Œå†…éƒ¨å¦‚ä½•ä½¿ç”¨ oopï¼Œpop çš„, æ€è€ƒ <code>AlamoFire</code> æ¥å£è®¾è®¡</p><p>ä¸‹é¢è¿™äº›éƒ½æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</p><ul><li>é“¾å¼è¯­æ³•</li><li>ç›´æ¥ä¼  string</li><li>å°è£…è°ƒç”¨ sessionï¼Œresume</li><li>Response å›è°ƒçš„è¿”å›çš„æ˜¯ json æ•°æ®</li><li><code>Alamofire</code> æ¨¡å—å¯¼å…¥è°ƒç”¨</li></ul><p>è°ƒç”¨çš„ç¬¬ä¸€å±‚ï¼š<br>Alamofire.swift</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Alamofire Model</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">_</span> url: URLConvertible,</span></span></span><br><span class="line"><span class="function"><span class="params">  method: HTTPMethod = .<span class="keyword">get</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  parameters: Parameters? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  encoding: ParameterEncoding = URLEncoding.<span class="keyword">default</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  headers: HTTPHeaders? = <span class="literal">nil</span>)</span></span></span><br><span class="line">  -&gt; <span class="type">DataRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="type">SessionManager</span>.<span class="keyword">default</span>.request(</span><br><span class="line">    url,</span><br><span class="line">    method: method,</span><br><span class="line">    parameters: parameters,</span><br><span class="line">    encoding: encoding,</span><br><span class="line">    headers: headers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SessionManager.swift</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SessionManager</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A default instance of `SessionManager`, used by top-level Alamofire request methods, and suitable for use</span></span><br><span class="line"><span class="comment">/// directly for any ad hoc requests.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> `<span class="keyword">default</span>`: <span class="type">SessionManager</span> = &#123;</span><br><span class="line">  <span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">  configuration.httpAdditionalHeaders = <span class="type">SessionManager</span>.defaultHTTPHeaders </span><br><span class="line">  <span class="keyword">return</span> <span class="type">SessionManager</span>(configuration: configuration)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(</span><br><span class="line">  configuration: <span class="type">URLSessionConfiguration</span> = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span>,</span><br><span class="line">  delegate: <span class="type">SessionDelegate</span> = <span class="type">SessionDelegate</span>(),</span><br><span class="line">  serverTrustPolicyManager: <span class="type">ServerTrustPolicyManager?</span> = <span class="literal">nil</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">self</span>.delegate = delegate</span><br><span class="line">  <span class="keyword">self</span>.session = <span class="type">URLSession</span>(configuration: configuration, delegate: delegate, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">  commonInit(serverTrustPolicyManager: serverTrustPolicyManager)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>?(</span><br><span class="line">  session: <span class="type">URLSession</span>,</span><br><span class="line">  delegate: <span class="type">SessionDelegate</span>,</span><br><span class="line">  serverTrustPolicyManager: <span class="type">ServerTrustPolicyManager?</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">guard</span> delegate === session.delegate <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.delegate = delegate</span><br><span class="line">  <span class="keyword">self</span>.session = session</span><br><span class="line"></span><br><span class="line">  commonInit(serverTrustPolicyManager: serverTrustPolicyManager)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SessionDelegate()</code> ä»£ç†ç§»äº¤ <code>SessionDelegate</code> æ˜¯ä¸ª class, å¤„ç† <code>URLSession</code> çš„äº‹ä»¶å›è°ƒä»£ç†æ–¹æ³•ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionDataDelegate</span> </span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionTaskDelegate</span> </span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionStreamDelegate</span> </span>&#123;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ Manager ä¸å¤„ç† <code>URLSession</code> çš„ä»£ç†å›è°ƒæ–¹æ³•ï¼Œè¦æä¸€ä¸ª <code>SessionDelegate</code> å¤„ç†ï¼Œå› ä¸º Manager æ˜¯ä¸€ä¸ªä¸­ä»‹è€…ï¼Œç”¨äºç®¡ç†å„ä¸ª class ä¹‹é—´çš„è”ç³»ï¼Œå¤„ç†å›è°ƒçš„é‚£äº›æ–¹æ³•åº”è¯¥å½’å±äº xxxClass æ¥å¤„ç†</p><p><img src="/img/AlamoFire-Manager.jpg" alt="AlamoFire åŸºæœ¬æ ¸å¿ƒæ¡†æ¶"></p><p>ä½¿ç”¨ Manager ä¸»è¦ä½œç”¨æ˜¯æŠŠä»£ç æ¨¡å—ä¹‹é—´çš„ é¢‘ç¹è°ƒç”¨å…³ç³»åŒ–ç®€ã€‚åˆ’åˆ†ä¸šåŠ¡å±‚ï¼Œç®¡ç†å±‚<br>Manager ç»Ÿä¸€ç®¡ç†è°ƒåº¦<br>å„ä¸ªæ¨¡å—å¤„ç†å®Œæˆåï¼Œå›è°ƒç»™ Manager</p><h3 id="å¤„ç†åå°ä¸‹è½½"><a class="markdownIt-Anchor" href="#å¤„ç†åå°ä¸‹è½½"></a> å¤„ç†åå°ä¸‹è½½</h3><h2 id="request"><a class="markdownIt-Anchor" href="#request"></a> request</h2><h3 id="ç¼–ç "><a class="markdownIt-Anchor" href="#ç¼–ç "></a> ç¼–ç </h3><p><img src="/img/requst_encode.jpeg" alt="æä¾›çš„3ç§ç¼–ç æ–¹å¼"></p><ul><li>url</li><li>json</li><li>propertyList</li></ul><p>url æ˜¯ASCIIç ç¼–ç çš„ï¼Œä»–ä¸æ˜¯ Unicodeï¼ŒASCII ç ä¸­çš„å¤–æ–‡æ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥è¦ç™¾åˆ†å·ç¼–ç â€”â€”å°† ACSII -&gt; Unicode è¿™æ ·å¯ä»¥è¢«è¯†åˆ«</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">encode</span><span class="params">(<span class="number">_</span> urlRequest: URLRequestConvertible, with parameters: Parameters?)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> urlRequest = <span class="keyword">try</span> urlRequest.asURLRequest()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> parameters = parameters <span class="keyword">else</span> &#123; <span class="keyword">return</span> urlRequest &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// header</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> method = <span class="type">HTTPMethod</span>(rawValue: urlRequest.httpMethod ?? <span class="string">"GET"</span>), encodesParametersInURL(with: method) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> url = urlRequest.url <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="type">AFError</span>.parameterEncodingFailed(reason: .missingURL)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">var</span> urlComponents = <span class="type">URLComponents</span>(url: url, resolvingAgainstBaseURL: <span class="literal">false</span>), !parameters.isEmpty &#123;</span><br><span class="line">      <span class="keyword">let</span> percentEncodedQuery = (urlComponents.percentEncodedQuery.<span class="built_in">map</span> &#123; $<span class="number">0</span> + <span class="string">"&amp;"</span> &#125; ?? <span class="string">""</span>) + query(parameters)</span><br><span class="line">      urlComponents.percentEncodedQuery = percentEncodedQuery</span><br><span class="line">      urlRequest.url = urlComponents.url</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> urlRequest.value(forHTTPHeaderField: <span class="string">"Content-Type"</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">      urlRequest.setValue(<span class="string">"application/x-www-form-urlencoded; charset=utf-8"</span>, forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// body</span></span><br><span class="line">    urlRequest.httpBody = query(parameters).data(using: .utf8, allowLossyConversion: <span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> urlRequest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>p.s. ä¼ è¾“ç»„çš„æ—¶å€™ä¸€å®šè¦ä¼  json å­—ç¬¦ä¸²ï¼</p><p><a href="https://github.com/Alamofire/Alamofire/issues/1920" target="_blank" rel="noopener">iOS 10: Background Session wonâ€™t inform when downloads have failed #1920</a></p><blockquote><p><a href="https://developer.apple.com/documentation/foundation/url_loading_system" target="_blank" rel="noopener">URL Loading System</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> Net </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URL Loading System</title>
      <link href="/2019/08/19/URL-Loading-System/"/>
      <url>/2019/08/19/URL-Loading-System/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h2><ul><li>åœ¨ Foundation æ¡†æ¶ä¸­</li><li>æ”¯æŒåè®®ï¼š<ul><li>FTPåè®®ï¼ˆftp://ï¼‰</li><li>è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆhttp://ï¼‰</li><li>åŠ å¯†è¶…æ–‡æœ¬ä¼ è¾“åè®®(https://)</li><li>æœ¬åœ°èµ„æº(file://)</li><li>æ•°æ®URLs(data://)</li></ul></li><li>å…³é”®ç±»ï¼šURLSessionï¼ŒURLï¼ŒURLRequestï¼ŒTasksï¼ŒData</li><li>æ”¯æŒï¼šAuthorization credentialsï¼Œcache å’Œcookiesï¼Œ é…ç½®ç®¡ç†</li><li>ä½¿ç”¨ closure å’Œ delegate å¤„ç† Response</li></ul><p><img src="/img/url_loading_system.jpg" alt="url_loading_system æ ¸å¿ƒç±» åˆ† 6 ä¸ªéƒ¨åˆ†"></p><h2 id="æ ¸å¿ƒ-urlsession-urlsessiontask"><a class="markdownIt-Anchor" href="#æ ¸å¿ƒ-urlsession-urlsessiontask"></a> æ ¸å¿ƒ URLSession &amp; URLSessionTask</h2><p>ä¸€ä¸ª session è¯·æ±‚ç½‘ç»œæ•°æ®éœ€è¦çš„æ ¸å¿ƒå†…å®¹</p><p><img src="/img/urlsession.jpg" alt="urlsession"></p><h3 id="session-configuration"><a class="markdownIt-Anchor" href="#session-configuration"></a> Session Configuration</h3><p>æ¯ä¸ªé…ç½®å±æ€§éƒ½å€¼å¾—ç ”ç©¶<br><img src="/img/urlsession_configuration.jpg" alt="configuration"><br><a href="https://juejin.im/post/5d5f5bcbe51d4561c02a2547" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« æœ‰å„ä¸ªå‚æ•°ç¿»è¯‘</a></p><p>æ€»å…±æœ‰ä¸‰ç§ configuration</p><ul><li><code>Default</code>: ä½¿ç”¨æœ¬åœ°æ²™ç›’ç¼“å­˜ï¼Œç”¨æˆ·credentialä¿å­˜åœ¨ keychain ä¸­</li><li><code>Ephemeral</code>: ä¸ä½¿ç”¨æ²™ç›’ï¼Œæ‰€æœ‰ç¼“å­˜credential ç­‰æ•°æ®å­˜åœ¨ ä¸ session ç»‘å®šçš„ RAM ä¸­ï¼Œsession å¤±æ•ˆåå†…å­˜è‡ªåŠ¨æ¸…ç†</li><li><code>Background</code>: è·Ÿ default session ç›¸ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯å¦å¤–ä¸€ä¸ª è¿›ç¨‹(process) å¤„ç†æ•°æ®ä¼ è¾“ï¼Œå› ä¸ºæ˜¯è·¨è¿›ç¨‹ï¼Œæ‰€ä»¥ background session æœ‰äº›é™åˆ¶æ“ä½œã€‚ï¼ˆå—¯åå°session ä½¿ç”¨äº†è¿›ç¨‹é—´é€šä¿¡ï¼‰</li></ul><p>ä¸ºä»€ä¹ˆè¦æœ‰ configurationï¼Ÿ<br>session ç›¸å½“ä¸€ä¸ª managerï¼Œç”¨æ¥ç®¡ç†ç»„ç»‡ taskï¼Œç½‘ç»œäº‹ä»¶å¤„ç†çš„æ¢çº½ï¼Œconfigurationæ˜¯è¿™ä¸ªæ¢çº½çš„å‚æ•°ä¿¡æ¯ï¼ç›¸å½“äº ä¸€ä¸ª app ä»–éƒ½æœ‰ è‡ªå·± preference</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.background(withIdentifier: <span class="string">"com.czw.backgroundDownload"</span>)</span><br><span class="line"><span class="keyword">let</span> configuration1 = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span><span class="comment">// å…è®¸ç”¨æˆ·æ‹¥æœ‰æ²™ç›’ç¼“å­˜å™¨ï¼Œå½“session é‡Šæ”¾çš„æ—¶å€™ï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨</span></span><br><span class="line"><span class="keyword">let</span> configuration2 = <span class="type">URLSessionConfiguration</span>.ephemeral<span class="comment">// session æ— æ•ˆæ—¶ï¼Œä¸œè¥¿å°±ä¼šæ¶ˆå¤±</span></span><br><span class="line"></span><br><span class="line"><span class="type">URLSession</span>.<span class="keyword">init</span>(configuration: configuration).dataTask(with: <span class="type">URL</span>(string: urlDownloadStr)!)</span><br><span class="line">  .resume()<span class="comment">// åå° sessionConfiguration ä¸èƒ½è®¾ç½® completeHandlerï¼Œéœ€è¦è‡ªå·±è®¾ç½®ä»£ç†</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"background-å†…å­˜å¤§å°ï¼š\(String(describing: configuration.urlCache.memoryCapacity))"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"background-æ²™ç›’å¤§å°ï¼š\(String(describing: configuration.urlCache.diskCapacity))"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"default-å†…å­˜å¤§å°ï¼š\(String(describing: configuration1.urlCache.memoryCapacity))"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"default-æ²™ç›’å¤§å°ï¼š\(String(describing: configuration1.urlCache.diskCapacity))"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"ephemeral-å†…å­˜å¤§å°ï¼š\(String(describing: configuration2.urlCache.memoryCapacity))"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"ephemeral-æ²™ç›’å¤§å°ï¼š\(String(describing: configuration2.urlCache.diskCapacity))"</span>)</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š<br>background-å†…å­˜å¤§å°ï¼šnil<br>background-æ²™ç›’å¤§å°ï¼šnil<br>default-å†…å­˜å¤§å°ï¼š512000<br>default-æ²™ç›’å¤§å°ï¼š10000000<br>ephemeral-å†…å­˜å¤§å°ï¼š512000<br>ephemeral-æ²™ç›’å¤§å°ï¼š0</p><p>å°±åƒæ–‡æ¡£è¯´çš„ï¼Œå½“session å¤±æ•ˆä»¥å ephemeral çš„ cache ä¼šæ¶ˆå¤±ï¼Œå› ä¸ºä»–æ²¡æœ‰æ²™ç›’ç©ºé—´</p><h3 id="session-ç½‘ç»œè¯·æ±‚"><a class="markdownIt-Anchor" href="#session-ç½‘ç»œè¯·æ±‚"></a> session ç½‘ç»œè¯·æ±‚</h3><p><img src="/img/urlsession_flow.jpg" alt="urlsession request flow"></p><p>æˆ‘ä»¬è¦åšçš„</p><ol><li>é…ç½®éœ€è¦çš„ session configurationï¼Œ</li><li>é…ç½® session<ol><li>ç³»ç»Ÿæä¾›çš„ shared å•ä¾‹ï¼Œç³»ç»Ÿè‡ªå·±é…ç½® configurationï¼ŒsessionDelegateï¼ŒdelegateQueue</li><li>è‡ªå®šä¹‰ sessionï¼Œè‡ªå·±è®¾ç½® configurationï¼ŒsessionDelegateï¼ŒdelegateQueue(æ˜¯ serial queue)</li></ol></li><li>æä¾› request &amp; url ç»™ session</li><li>ç”Ÿæˆ task<ol><li>URLSessionTask<ul><li>URLSessionDataTask</li><li>URLSessionUploadTask</li><li>URLSessionDownloadTask</li><li>URLSessionStreamTask</li><li>URLSessionWebSocketTaskï¼ˆiOS 13.0ï¼‰</li></ul></li></ol></li><li>é…ç½®SessionDelegate, SessionTaskDelegate å¯¹ç½‘ç»œäº‹ä»¶å¤„ç† (URLSessionTaskDelegate: URLSessionDelegate<ul><li>URLSessionDataDelegate</li><li>URLSessionDownloadDelegate</li><li>URLSessionStreamDelegate</li><li>URLSessionWebSocketDelegateï¼ˆiOS 13.0ï¼‰</li></ul></li></ol><p>SessionDelegate åªæœ‰3ä¸ªæ¥å£</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line"><span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span> </span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line"><span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didReceive challenge: URLAuthenticationChallenge, completionHandler: @escaping <span class="params">(URLSession.AuthChallengeDisposition, URLCredential?)</span></span></span> -&gt; <span class="type">Void</span>) </span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line"><span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSessionDidFinishEvents</span><span class="params">(forBackgroundURLSession session: URLSession)</span></span></span><br></pre></td></tr></table></figure><p>è‡³äºå„ä¸ª taskDelegateï¼Œå¯¹åº”ä¸åŒçš„task ç±»å‹æœ‰ä¸ªå­—ä¸åŒåè®®æ¥å£<br>è¿™é‡Œä¸»è¦çœ‹ SessionTaskDelegate</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">URLSessionTaskDelegate</span> : <span class="title">URLSessionDelegate</span> </span>&#123; </span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">11.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, willBeginDelayedRequest request: URLRequest, completionHandler: @escaping <span class="params">(URLSession.DelayedRequestDisposition, URLRequest?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">11.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, taskIsWaitingForConnectivity task: URLSessionTask)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, willPerformHTTPRedirection response: HTTPURLResponse, newRequest request: URLRequest, completionHandler: @escaping <span class="params">(URLRequest?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didReceive challenge: URLAuthenticationChallenge, completionHandler: @escaping <span class="params">(URLSession.AuthChallengeDisposition, URLCredential?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, needNewBodyStream completionHandler: @escaping <span class="params">(InputStream?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didSendBodyData bytesSent: Int64, totalBytesSent: Int64, totalBytesExpectedToSend: Int64)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">10.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didFinishCollecting metrics: URLSessionTaskMetrics)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨çš„æ˜¯ dataTaskï¼ŒdownloadTaskï¼ŒuploadTask</p><h2 id="å®é™…ä½¿ç”¨"><a class="markdownIt-Anchor" href="#å®é™…ä½¿ç”¨"></a> å®é™…ä½¿ç”¨</h2><h3 id="ä»ç½‘ç«™è·å–æ•°æ®åˆ°å†…å­˜"><a class="markdownIt-Anchor" href="#ä»ç½‘ç«™è·å–æ•°æ®åˆ°å†…å­˜"></a> ä»ç½‘ç«™è·å–æ•°æ®åˆ°å†…å­˜</h3><h4 id="ä½¿ç”¨å›è°ƒå¤„ç†æ¥å—ç»“æœä½¿ç”¨closure-å›è°ƒå¾—åˆ°-data"><a class="markdownIt-Anchor" href="#ä½¿ç”¨å›è°ƒå¤„ç†æ¥å—ç»“æœä½¿ç”¨closure-å›è°ƒå¾—åˆ°-data"></a> ä½¿ç”¨å›è°ƒå¤„ç†æ¥å—ç»“æœï¼šä½¿ç”¨closure å›è°ƒå¾—åˆ° data</h4><p><img src="https://docs-assets.developer.apple.com/published/c7124fb5d7/bf4501ff-82b2-4dd4-9ec3-243ef0e70d21.png" alt=""></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task çš„çŠ¶æ€</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">URLSessionTask</span> </span>&#123; </span><br><span class="line">  <span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> : <span class="title">Int</span> </span>&#123; </span><br><span class="line">    <span class="keyword">case</span> running </span><br><span class="line">    <span class="keyword">case</span> suspended <span class="comment">// åˆè¯•çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">case</span> canceling </span><br><span class="line">    <span class="keyword">case</span> completed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://www.example.com/"</span>)!</span><br><span class="line">  <span class="keyword">let</span> task = <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; data, response, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">      <span class="keyword">self</span>.handleClientError(error)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> httpResponse = response <span class="keyword">as</span>? <span class="type">HTTPURLResponse</span>,</span><br><span class="line">      (<span class="number">200</span>...<span class="number">299</span>).<span class="built_in">contains</span>(httpResponse.statusCode) <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">self</span>.handleServerError(response)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> mimeType = httpResponse.mimeType, mimeType == <span class="string">"text/html"</span>,</span><br><span class="line">      <span class="keyword">let</span> data = data,</span><br><span class="line">      <span class="keyword">let</span> string = <span class="type">String</span>(data: data, encoding: .utf8) &#123;</span><br><span class="line">      <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">        <span class="keyword">self</span>.webView.loadHTMLString(string, baseURL: url)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// session create å‡ºæ¥çš„ task æ˜¯ suspend çš„çŠ¶æ€</span></span><br><span class="line">  task.resume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ç‚¹ï¼š</p><ol><li>session create å‡ºæ¥çš„ task åˆå§‹çŠ¶æ€æ˜¯ suspend</li><li>å›è°ƒå¤„ç†æ˜¯åœ¨ serial queue ä»»åŠ¡æ”¾åˆ°å­çº¿ç¨‹å¤„ç†çš„ï¼Œé€šçŸ¥ UI å˜åŒ–åº”åˆ‡æ¢ä¸»çº¿ç¨‹</li></ol><h4 id="æ¥å—è¯·æ±‚è¯¦æƒ…ç»“æœä½¿ç”¨-delegate"><a class="markdownIt-Anchor" href="#æ¥å—è¯·æ±‚è¯¦æƒ…ç»“æœä½¿ç”¨-delegate"></a> æ¥å—è¯·æ±‚è¯¦æƒ…&amp;ç»“æœï¼šä½¿ç”¨ Delegate</h4><p><img src="https://docs-assets.developer.apple.com/published/8b22355c7f/730c8e1b-654f-4eb9-9c63-d439a69ac5d2.png" alt=""></p><p>è¿™ä¸ªæ—¶å€™ session ä¸åº”è¯¥ä½¿ç”¨ <code>shared</code>ï¼Œè€Œæ˜¯è¦è‡ªå·±é…ç½®</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> session: <span class="type">URLSession</span> = &#123;</span><br><span class="line">  <span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">  configuration.waitsForConnectivity = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">return</span> <span class="type">URLSession</span>(configuration: configuration,</span><br><span class="line">                    delegate: <span class="keyword">self</span>,</span><br><span class="line">                    delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> receivedData: <span class="type">Data?</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">  loadButton.isEnabled = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://www.example.com/"</span>)!</span><br><span class="line">  receivedData = <span class="type">Data</span>()</span><br><span class="line">  <span class="keyword">let</span> task = session.dataTask(with: url)</span><br><span class="line">  task.resume()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delegate methods</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">        completionHandler: @escaping <span class="params">(URLSession.ResponseDisposition)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> response = response <span class="keyword">as</span>? <span class="type">HTTPURLResponse</span>,</span><br><span class="line">    (<span class="number">200</span>...<span class="number">299</span>).<span class="built_in">contains</span>(response.statusCode),</span><br><span class="line">    <span class="keyword">let</span> mimeType = response.mimeType,</span><br><span class="line">    mimeType == <span class="string">"text/html"</span> <span class="keyword">else</span> &#123;</span><br><span class="line">    completionHandler(.cancel)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  completionHandler(.allow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;</span><br><span class="line">  <span class="keyword">self</span>.receivedData?.append(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)</span></span> &#123;</span><br><span class="line">  <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">    <span class="keyword">self</span>.loadButton.isEnabled = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">      handleClientError(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> receivedData = <span class="keyword">self</span>.receivedData,</span><br><span class="line">      <span class="keyword">let</span> string = <span class="type">String</span>(data: receivedData, encoding: .utf8) &#123;</span><br><span class="line">      <span class="keyword">self</span>.webView.loadHTMLString(string, baseURL: task.currentRequest?.url)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä»£ç†çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†å¾ˆå¤šç‰¹æ®Šçš„æƒ…å†µï¼š</p><ul><li>authentication challenges</li><li>following redirects</li></ul><blockquote><p><a href="https://developer.apple.com/documentation/foundation/url_loading_system" target="_blank" rel="noopener">URL Loading System</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> Guide </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>loadå’Œinitialize</title>
      <link href="/2019/07/12/load%E5%92%8Cinitialize/"/>
      <url>/2019/07/12/load%E5%92%8Cinitialize/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="load"><a class="markdownIt-Anchor" href="#load"></a> + load</h2><ol><li>load æ˜¯é€šè¿‡ c å‡½æ•°è°ƒç”¨çš„</li><li>load è°ƒç”¨åœ¨ main å‡½æ•°ä¹‹å‰ï¼ŒåŠ¨æ€é“¾æ¥å™¨é€šçŸ¥è°ƒç”¨ load_imagesï¼Œæ‰§è¡Œload æ–¹æ³•</li><li>load åŠ è½½é¡ºåºï¼šçˆ¶ç±»-&gt; ç±»-&gt; åˆ†ç±»</li></ol><h3 id="load-æ–¹æ³•çš„è°ƒç”¨æ ˆ"><a class="markdownIt-Anchor" href="#load-æ–¹æ³•çš„è°ƒç”¨æ ˆ"></a> load æ–¹æ³•çš„è°ƒç”¨æ ˆ</h3><p>åœ¨ <code>+ load</code> æ–¹æ³•å‡ºæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹ load è°ƒç”¨æ ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>  +[XXObject load]</span><br><span class="line"><span class="number">1</span>  call_class_loads()</span><br><span class="line"><span class="number">2</span>  call_load_methods</span><br><span class="line"><span class="number">3</span>  load_images</span><br><span class="line"><span class="number">4</span>  dyld::notifySingle(dyld_image_states, ImageLoader <span class="keyword">const</span>*)</span><br><span class="line"><span class="number">11</span> _dyld_start</span><br></pre></td></tr></table></figure><blockquote><p>dyld(dynamic link editor)ï¼Œå®ƒæ˜¯è‹¹æœçš„åŠ¨æ€é“¾æ¥å™¨ã€‚<br>åœ¨ç³»ç»Ÿå†…æ ¸åšå¥½ç¨‹åºå‡†å¤‡å·¥ä½œä¹‹åï¼Œäº¤ç”± dyld è´Ÿè´£ä½™ä¸‹çš„å·¥ä½œ</p></blockquote><p>åœ¨ runtime æ—¶è°ƒç”¨ <code>load_images</code> æ–¹æ³•,é‚£ä¹ˆå°±çœ‹ä¸‹ä»–çš„æºç (objc4-756.2)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* load_images</span></span><br><span class="line"><span class="comment">* Process +load in the given images which are being mapped in by dyld.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: write-locks runtimeLock and loadMethodLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">hasLoadMethods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load_images</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">recursive_mutex_locker_t</span> lock(loadMethodLock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Discover load methods</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">mutex_locker_t</span> lock2(runtimeLock);</span><br><span class="line">    prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line">  call_load_methods();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> count, i;</span><br><span class="line"></span><br><span class="line">  runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">classref_t</span> *classlist = </span><br><span class="line">    _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">category_t</span> **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">    Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">      _objc_fatal(<span class="string">"Swift class extensions and categories on Swift "</span></span><br><span class="line">            <span class="string">"classes are not allowed to have +load methods"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    realizeClassWithoutSwift(cls);</span><br><span class="line">    assert(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">    add_category_to_loadable_list(cat);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* prepare_load_methods</span></span><br><span class="line"><span class="comment">* Schedule +load for classes in this image, any un-+load-ed </span></span><br><span class="line"><span class="comment">* superclasses in other images, and any categories in this image.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="comment">// Recursively schedule +load for cls and any un-+load-ed superclasses.</span></span><br><span class="line"><span class="comment">// cls must already be connected.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">  assert(cls-&gt;isRealized());  <span class="comment">// _read_images should realize</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure superclass-first ordering</span></span><br><span class="line">  schedule_class_load(cls-&gt;superclass); </span><br><span class="line">  add_class_to_loadable_list(cls);</span><br><span class="line">  cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* add_class_to_loadable_list</span></span><br><span class="line"><span class="comment">* Class cls has just become connected. Schedule it for +load if</span></span><br><span class="line"><span class="comment">* it implements a +load method.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">  IMP method;</span><br><span class="line"></span><br><span class="line">  method = cls-&gt;getLoadMethod();</span><br><span class="line">  <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don't bother if cls has no +load method</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">    loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">    <span class="comment">// åˆ†é…ç±»å¯¹è±¡ç©ºé—´ï¼ŒåŠ è½½ç±»</span></span><br><span class="line">    loadable_classes = (struct loadable_class *)</span><br><span class="line">      <span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">                loadable_classes_allocated *</span><br><span class="line">                <span class="keyword">sizeof</span>(struct loadable_class));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">  loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">  loadable_classes_used++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* call_load_methods</span></span><br><span class="line"><span class="comment">* Call all pending class and category +load methods.</span></span><br><span class="line"><span class="comment">* Class +load methods are called superclass-first. </span></span><br><span class="line"><span class="comment">* Category +load methods are not called until after the parent class's +load.</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* This method must be RE-ENTRANT, because a +load could trigger </span></span><br><span class="line"><span class="comment">* more image mapping. In addition, the superclass-first ordering </span></span><br><span class="line"><span class="comment">* must be preserved in the face of re-entrant calls. Therefore, </span></span><br><span class="line"><span class="comment">* only the OUTERMOST call of this function will do anything, and </span></span><br><span class="line"><span class="comment">* that call will handle all loadable classes, even those generated </span></span><br><span class="line"><span class="comment">* while it was running.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The sequence below preserves +load ordering in the face of </span></span><br><span class="line"><span class="comment">* image loading during a +load, and make sure that no </span></span><br><span class="line"><span class="comment">* +load method is forgotten because it was added during </span></span><br><span class="line"><span class="comment">* a +load call.</span></span><br><span class="line"><span class="comment">* Sequence:</span></span><br><span class="line"><span class="comment">* 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line"><span class="comment">* 2. Call category +loads ONCE.</span></span><br><span class="line"><span class="comment">* 3. Run more +loads if:</span></span><br><span class="line"><span class="comment">*  (a) there are more classes to load, OR</span></span><br><span class="line"><span class="comment">*  (b) there are some potential category +loads that have </span></span><br><span class="line"><span class="comment">*    still never been attempted.</span></span><br><span class="line"><span class="comment">* Category +loads are only run once to ensure "parent class first" </span></span><br><span class="line"><span class="comment">* ordering, even if a category +load triggers a new loadable class </span></span><br><span class="line"><span class="comment">* and a new loadable category attached to that class. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: loadMethodLock must be held by the caller </span></span><br><span class="line"><span class="comment">*   All other locks must not be held.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">  <span class="keyword">bool</span> more_categories; </span><br><span class="line"><span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">  <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">  loading = YES; </span><br><span class="line">  <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">    <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      call_class_loads();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">    more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">  &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories); </span><br><span class="line">  objc_autoreleasePoolPop(pool); </span><br><span class="line">  loading = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initialize"><a class="markdownIt-Anchor" href="#initialize"></a> initialize</h2><ol><li>æƒ°æ€§æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–å®ä¾‹å¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</li><li>æ­£å¸¸æƒ…å†µï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡</li><li>ä¸æ­£å¸¸æƒ…å†µï¼Œè°ƒç”¨å¤šæ¬¡ï¼Œå¤šä¸ªå­ç±»æ²¡æœ‰å®ç° initializeï¼Œé‚£ä¹ˆä¼šå¤šæ¬¡è°ƒç”¨çˆ¶ç±»çš„ initialize</li></ol><h3 id="åˆ†æ-initialize"><a class="markdownIt-Anchor" href="#åˆ†æ-initialize"></a> åˆ†æ initialize</h3><p>è°ƒç”¨æ ˆåˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> +[XXObject initialize]</span><br><span class="line"><span class="number">1</span> _class_initialize</span><br><span class="line"><span class="number">2</span> lookUpImpOrForward</span><br><span class="line"><span class="number">3</span> _class_lookupMethodAndLoadCache3</span><br><span class="line"><span class="number">4</span> objc_msgSend</span><br><span class="line"><span class="number">5</span> main</span><br><span class="line"><span class="number">6</span> start</span><br></pre></td></tr></table></figure><ol><li>ä½¿ç”¨ oc æ¶ˆæ¯æœºåˆ¶å‘é€çš„</li><li></li></ol><blockquote><p><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%20load%20%E6%96%B9%E6%B3%95%E4%B9%88%EF%BC%9F.md" target="_blank" rel="noopener">ä½ çœŸçš„äº†è§£ load æ–¹æ³•ä¹ˆï¼Ÿ</a><br><a href="https://github.com/draveness/analyze/blob/master/contents/objc/%E6%87%92%E6%83%B0%E7%9A%84%20initialize%20%E6%96%B9%E6%B3%95.md" target="_blank" rel="noopener">æ‡’æƒ°çš„ initialize æ–¹æ³•</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯»ä»£ç  Me</title>
      <link href="/2019/05/17/source-code/%E8%AF%BB%E4%BB%A3%E7%A0%81-Me/"/>
      <url>/2019/05/17/source-code/%E8%AF%BB%E4%BB%A3%E7%A0%81-Me/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="ä¸ºä»€ä¹ˆçœ‹"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆçœ‹"></a> ä¸ºä»€ä¹ˆçœ‹</h2><p>æŠ½ç©ºæ™šä¸Šç¡ä¸ç€çœ‹ <a href="https://github.com/vsouza/awesome-ios#gcd" target="_blank" rel="noopener">awesome-ios</a> æä¾›çš„ä¼˜ç§€ä»£ç åº“<br>[Me](<a href="https://github.com/pascalbros/Me" target="_blank" rel="noopener">https://github.com/pascalbros/Me</a> æºç </p><h2 id="ä»–æ˜¯åšä»€ä¹ˆçš„"><a class="markdownIt-Anchor" href="#ä»–æ˜¯åšä»€ä¹ˆçš„"></a> ä»–æ˜¯åšä»€ä¹ˆçš„</h2><p>Me æ˜¯è§£å†³åµŒå¥—å¼‚æ­¥é—®é¢˜çš„ä¸€ä¸ªè½»é‡çº§åº“â€”â€”å°±ä¸€ä¸ªæ–‡ä»¶</p><h2 id="ä½¿ç”¨ä»–ä»¥åçš„æ•ˆæœ"><a class="markdownIt-Anchor" href="#ä½¿ç”¨ä»–ä»¥åçš„æ•ˆæœ"></a> ä½¿ç”¨ä»–ä»¥åçš„æ•ˆæœ</h2><p>before</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyAPI</span>.login &#123;</span><br><span class="line">  <span class="comment">//Do your stuff and then request posts...</span></span><br><span class="line">  <span class="type">MyAPI</span>.posts &#123;</span><br><span class="line">   <span class="comment">//Do your stuff and then request comments...</span></span><br><span class="line">   <span class="type">MyAPI</span>.comments &#123;</span><br><span class="line">    <span class="comment">//Do your stuff and then request likes...</span></span><br><span class="line">    <span class="type">MyAPI</span>.likes &#123;</span><br><span class="line">      <span class="comment">//We are done here</span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>after</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Me</span>.start &#123; (me) <span class="keyword">in</span></span><br><span class="line">  <span class="type">MyAPI</span>.login &#123;</span><br><span class="line">   <span class="comment">//Do your stuff and then request posts...</span></span><br><span class="line">   me.runNext()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.next &#123; (caller, me) <span class="keyword">in</span></span><br><span class="line">  <span class="type">MyAPI</span>.posts &#123;</span><br><span class="line">   <span class="comment">//Do your stuff and then request comments...</span></span><br><span class="line">   me.runNext()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.next &#123; (caller, me) <span class="keyword">in</span></span><br><span class="line">  <span class="type">MyAPI</span>.comments &#123;</span><br><span class="line">   <span class="comment">//Do your stuff and then request likes...</span></span><br><span class="line">   me.runNext()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.next &#123; (caller, me) <span class="keyword">in</span></span><br><span class="line">  <span class="type">MyAPI</span>.likes &#123;</span><br><span class="line">   <span class="comment">//We are done here</span></span><br><span class="line">   me.end()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.run()</span><br></pre></td></tr></table></figure><p>çœ‹æ•ˆæœï¼š</p><ol><li>Me æŠŠå¼‚æ­¥åµŒå¥—ä»£ç â€“&gt; é“¾å¼ä»£ç ï¼ˆæƒ³æƒ³ä»–æ˜¯æ€ä¹ˆåšçš„ï¼Ÿï¼‰</li><li>Me æ˜¯é“¾æ¡å‹çš„ï¼Œstartï¼Œnextï¼Œnext(name:)ï¼Œjump(toName:)ï¼Œend<ol><li>ä»–æ˜¯å¦‚ä½•åšå¼‚æ­¥é€šçŸ¥çš„ï¼Ÿ</li><li>å¦‚ä½•å¼€å§‹ï¼Œå¦‚ä½•ç»“æŸï¼Ÿ</li><li>æ”¯æŒå®ç°å¤šé“¾æ¡å¹¶å‘æ‰§è¡Œå—ï¼Ÿ</li></ol></li><li>ä»æä¾›çš„æ¥å£ä¸Šå¯ä»¥çœ‹å‡º<ol><li>Meå¼€å¯ç»“æŸè¦ç”±ç”¨æˆ·æ§åˆ¶</li><li>èŠ‚ç‚¹é©±åŠ¨éœ€è¦ç”¨æˆ·è§¦å‘</li><li>æ”¯æŒæŒ‡å®šèŠ‚ç‚¹è·³è½¬</li></ol></li></ol><p>ok ä½¿ç”¨demo&amp;åŸºæœ¬ç‰¹æ€§åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥çœ‹æºç </p><hr><h2 id="æºç "><a class="markdownIt-Anchor" href="#æºç "></a> æºç </h2><h3 id="å…ˆçœ‹æ¥å£"><a class="markdownIt-Anchor" href="#å…ˆçœ‹æ¥å£"></a> å…ˆçœ‹æ¥å£</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">MeInitClosure</span> = ((<span class="number">_</span> current: <span class="type">Me</span>) -&gt; ())</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">MeClosure</span> = ((<span class="number">_</span> previous: <span class="type">Me?</span>, <span class="number">_</span> current: <span class="type">Me</span>) -&gt; ())</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> first: <span class="type">Me</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> index: <span class="type">UInt</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">var</span> name: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> parameters: [<span class="type">String</span> : <span class="type">Any</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾å¼èŠ‚ç‚¹å‡½æ•°ï¼Œstatic æ˜¯èµ·ç‚¹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">(name: String = <span class="string">""</span>, this: @escaping MeInitClosure)</span></span> -&gt; <span class="type">Me</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(this: @escaping MeClosure)</span></span> -&gt; <span class="type">Me</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">(name: String = <span class="string">""</span>, next: @escaping MeClosure)</span></span> -&gt; <span class="type">Me</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">end</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">runNext</span><span class="params">(queue: DispatchQueue)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">runNext</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">runNextOnMain</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jump</span><span class="params">(toIndex jump: UInt = <span class="number">0</span>, queue: DispatchQueue)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jump</span><span class="params">(toIndex jump: UInt = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jumpOnMain</span><span class="params">(toIndex jump: UInt = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jump</span><span class="params">(toName jump: String, queue: DispatchQueue)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jump</span><span class="params">(toName jump: String)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jumpOnMain</span><span class="params">(toName jump: String)</span></span></span><br></pre></td></tr></table></figure><ol><li>æä¾› Me èŠ‚ç‚¹ indexï¼Œnameï¼Œä»£ç åº“å†…éƒ¨ç»´æŠ¤</li><li>åªæä¾›å…¶å®èŠ‚ç‚¹ first</li><li>æä¾›çº¿ç¨‹é˜Ÿåˆ—è°ƒåº¦æ¥å£</li><li>parameters æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿåƒæ˜¯ [name: MeClouse] å­—å…¸ï¼Œæ¯ä¸ª me èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªclouse</li></ol><h3 id="çœ‹ä»£ç å®ç°"><a class="markdownIt-Anchor" href="#çœ‹ä»£ç å®ç°"></a> çœ‹ä»£ç å®ç°</h3><ol><li>æ ¸å¿ƒä»£ç ï¼Œè¿™ä¸ªåœ°æ–¹å°è£…äº† GCD</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">runNext</span><span class="params">(queue: DispatchQueue)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> next = <span class="keyword">self</span>.next &#123;</span><br><span class="line">    <span class="comment">//self.nextObj!.parameters = self.parameters //enable to pass parameters to the next object</span></span><br><span class="line">    queue.async &#123;</span><br><span class="line">      next(<span class="keyword">self</span>, <span class="keyword">self</span>.nextObj!)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">jump</span><span class="params">(toIndex jump: UInt = <span class="number">0</span>, queue: DispatchQueue)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> to = me(at: jump) &#123;</span><br><span class="line">    to.this(<span class="keyword">self</span>, to)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸ªé—®é¢˜æ˜¯ï¼š<code>jump</code> çš„queue æ²¡æœ‰ç”¨â€¦â€¦ï¼ˆè¿™ä¸ªåº“çš„ä½¿ç”¨ä»·å€¼ä¸å¤§ï¼‰åªæœ‰ <code>runNext</code> ç›¸å…³æ–¹æ³•å¯ä»¥è°ƒåº¦çº¿ç¨‹<br>parameters: æ˜¯ me èŠ‚ç‚¹ä¿å­˜æ•°æ®ï¼Œç”¨äºç”¨æˆ·è‡ªå·±ä¼ é€’æ•°æ®ä½¿ç”¨</p><ol start="2"><li>å†…éƒ¨æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯é“¾è¡¨</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> nextObj: <span class="type">Me?</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _first: <span class="type">Me?</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è¯»æºç  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift + MVVM:å¦‚ä½•æä¾›ViewModels</title>
      <link href="/2019/04/16/RxSwfit+RAC/RxSwift-MVVM-%E5%A6%82%E4%BD%95%E6%8F%90%E4%BE%9BViewModels/"/>
      <url>/2019/04/16/RxSwfit+RAC/RxSwift-MVVM-%E5%A6%82%E4%BD%95%E6%8F%90%E4%BE%9BViewModels/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="https://medium.com/blablacar-tech/rxswift-mvvm-66827b8b3f10" target="_blank" rel="noopener">åŸæ–‡ï¼šRxSwift + MVVM: how to feed ViewModels</a></p><h2 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h2><p>è‡ªä»æˆ‘ä»¬å¼€å§‹åœ¨BlaBlaCarçš„Model-View-ViewModelï¼ˆMVVMï¼‰æ¶æ„ä¸­ä½¿ç”¨RxSwiftä»¥æ¥ï¼Œå·²ç»å¿«ä¸€å¹´äº†ã€‚æˆ‘ä»¬å¯¹ç»“æœæ„Ÿåˆ°å…´å¥‹ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹æ³•ç¼–å†™çš„ä»£ç æ›´å®¹æ˜“ç†è§£ï¼Œç»´æŠ¤ï¼Œæµ‹è¯•å’Œæ‰©å±•ã€‚ä½†æ˜¯ï¼Œæœ€åˆçš„å‡ å‘¨å¹¶ä¸æ˜¯å°èœä¸€ç¢Ÿã€‚æˆ‘ä»¬å¿…é¡»åœ¨MVVM + RxSwiftæ¶æ„çš„æŸäº›æ–¹é¢è¿›è¡Œè¿­ä»£ï¼Œä»¥ä½¿äº‹æƒ…å˜å¾—æ­£ç¡®ã€‚å…¶ä¸­ä¸€ä¸ªæ–¹å¼â€”â€”ç»™ ViewModels æä¾› Inputsã€‚</p><p>è®©æˆ‘ä»¬é€šè¿‡ä¸¤ç§ä¸åŒæ–¹å¼ç»™ViewModels æä¾› Inputsï¼ˆRx Eventï¼‰</p><p>ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç®€å•è°ˆä¸€ä¸‹ ViewModels</p><h2 id="viewmodels"><a class="markdownIt-Anchor" href="#viewmodels"></a> ViewModels</h2><p>ViewModelçš„èŒè´£ï¼Œä½ å¿…é¡»æ­£ç¡®ç†è§£å®ƒï¼ˆä¸æ­¢ä¸€ä¸ªï¼‰ï¼š</p><ul><li>å®ƒåº”è¯¥æ˜¯å¯ä»¥æ’å…¥åˆ°ä»»ä½•Viewä¸Šçš„ã€‚æ¯”å¦‚ï¼Œä¸æ˜¯å…ˆé€ ä¸€ä¸ªViewå†å»å®šä¹‰ä¸€ä¸ªViewModelã€‚æ³¨æ„ï¼Œæ˜¯Viewæ‹¥æœ‰ViewModelã€‚ViewçŸ¥é“ViewModelï¼Œè€Œä¸æ˜¯åè¿‡æ¥ã€‚</li><li>å®ƒæ˜¯å¯æµ‹è¯•çš„ã€‚æœ€ç»ˆï¼ŒMVVMæ¶æ„æœ€å¤§çš„å¥½å¤„å°±æ˜¯è®©ä¸šåŠ¡é€»è¾‘å¯æµ‹ã€‚</li><li>MVVMä½¿ç”¨ç»‘å®šæœºåˆ¶æ›´åŠ ç‰›é€¼ï¼Œæ‰€ä»¥è®©ä½¿ç”¨ RxSwift æ¥æ›´å¥½åœ°åˆ©ç”¨ ViewModel</li></ul><p>to be continuedâ€¦</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•è¯»ä»£ç å†™ä»£ç </title>
      <link href="/2019/03/03/%E5%A6%82%E4%BD%95%E8%AF%BB%E4%BB%A3%E7%A0%81%E5%86%99%E4%BB%A3%E7%A0%81/"/>
      <url>/2019/03/03/%E5%A6%82%E4%BD%95%E8%AF%BB%E4%BB%A3%E7%A0%81%E5%86%99%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="æ€ä¹ˆè¯»"><a class="markdownIt-Anchor" href="#æ€ä¹ˆè¯»"></a> æ€ä¹ˆè¯»</h2><ol><li>è¿™ä¸ªåº“æ˜¯ç”¨æ¥å¹²å˜›ï¼Ÿ</li><li>çœ‹æ–‡ä»¶ç»“æ„<ol><li>æ€è€ƒä½œè€…åˆ†äº†é‚£äº›æ¨¡å—</li><li>æ¯ä¸ªæ¨¡å—éƒ½æ˜¯å¹²å•¥çš„</li><li>æ¨¡å—è”ç³»å®é™…åœºæ™¯æ˜¯å•¥ï¼Œæ–‡ä»¶ä¸Šç”¨äº†å“ªäº›æ¶æ„orè®¾è®¡æ¨¡å¼ï¼ˆMVCï¼ŒMVVMï¼ŒViewStateModelï¼ŒCoordinateï¼ŒMeditateâ€¦â€¦ï¼‰</li><li>æ¨¡å—é—´æ˜¯å¦‚ä½•è”ç³»çš„â€”â€”æ•°æ®æµ</li><li>äº†è§£å…·ä½“æ¨¡å—ç»†èŠ‚</li></ol></li><li>çœ‹å…·ä½“åè®®&amp;ç±»çš„æ¥å£<ol><li>ä½œè€…æƒ³è¦ç»™ç”¨æˆ·æä¾›ä»€ä¹ˆåŠŸèƒ½</li><li>ç±»çš„æ•°æ®å‡ºå£&amp;å…¥å£æ˜¯ä»€ä¹ˆ</li><li>ç±»ä¹‹é—´å…³ç³»ä½¿ç”¨äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Œå¦‚ä½•æé«˜äº†å¤ç”¨æ€§</li></ol></li><li>çœ‹æ•°æ®æµå‘<ol><li>å¯¹äºæ–‡æ¡£å°‘&amp;æƒ³æ›´æ·±å…¥ç†è§£ä»£ç ï¼Œå€ŸåŠ© IDE è°ƒè¯•ä»£ç ï¼Œè·Ÿè¸ªæ•°æ®è¾“å…¥è¾“å‡ºï¼Œçœ‹å‡½æ•°è°ƒç”¨æ ˆ</li><li>æ ¹æ®æ•°æ®æµå‘å¯ä»¥æ›´æ¸…æ¥šç±»ä¹‹é—´çš„å…³ç³»</li></ol></li><li>çœ‹å…·ä½“å®ç°<ol><li>æƒ³çŸ¥é“å…·ä½“ç»†èŠ‚å¦‚ä½•å®ç°çš„æ—¶å€™ï¼Œçœ‹æ–‡ä»¶ï¼Œå®šä½æºç ä½ç½®</li></ol></li></ol><h2 id="æ€ä¹ˆå†™"><a class="markdownIt-Anchor" href="#æ€ä¹ˆå†™"></a> æ€ä¹ˆå†™</h2><ol><li>ç¡®å®šåŠŸèƒ½</li><li>æ ¹æ®åŠŸèƒ½ç¡®å®šæ¨¡å—</li><li>æ ¹æ®æ¨¡å—åˆ†æ–‡ä»¶å¤¹<ol><li>æ€è€ƒæ¨¡å—ä¹‹é—´å…³ç³»ï¼Œå‡ºå£å…¥å£ï¼Œç›¸äº’ä¾èµ–å…³ç³»</li></ol></li><li>æ¯ä¸ªæ¨¡å—å†™æ¥å£â€”â€”API<ol><li>API å±‚çº§å…³ç³»ï¼ŒæŠ½è±¡å±‚çº§ï¼Œé«˜å±‚åŠå®ç°é€šç”¨åŠŸèƒ½</li><li>æ¥å£å‡ºå£å…¥å£ï¼Œä¾èµ–æ³¨å…¥</li><li>æ¥å£ä¹‹é—´ä¾èµ–å…³ç³»ï¼Œæ€è€ƒä½¿ç”¨ä½•ç§è®¾è®¡æ¨¡å¼</li></ol></li><li>æ ¹æ®æ¨¡å—ï¼Œå®ç°åè®®<ol><li>class å¼€å‘</li><li>class ä¹‹é—´å…³ç³»ï¼Œä½¿ç”¨ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Œæé«˜å¤ç”¨æ•ˆç‡</li><li>class çš„å‡ºå£å…¥å£ï¼Œä¾èµ–æ³¨å…¥</li><li>ç§æœ‰æˆå‘˜å†…éƒ¨é€»è¾‘</li></ol></li></ol><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> æ€è€ƒ </category>
          
          <category> å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹ æ„Ÿæ‚Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é›ªçƒé€Ÿè¯»æ³•--è¿­ä»£æ ‘--æ•´ä½“&amp;ç»†èŠ‚</title>
      <link href="/2019/02/05/%E9%9B%AA%E7%90%83%E9%80%9F%E8%AF%BB%E6%B3%95/"/>
      <url>/2019/02/05/%E9%9B%AA%E7%90%83%E9%80%9F%E8%AF%BB%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="é›ªçƒé€Ÿè¯»æ³•æµ…æ"><a class="markdownIt-Anchor" href="#é›ªçƒé€Ÿè¯»æ³•æµ…æ"></a> é›ªçƒé€Ÿè¯»æ³•â€“æµ…æ</h2><p>ã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹ä¸­è¯´ï¼š</p><blockquote><p>é€Ÿè¯»çš„æ–¹å¼æ˜¯ï¼š<br>é€Ÿåº¦æŠ€å·§ * èµ„æ–™åº“(å¤§å°) = é€Ÿè¯»</p><ul><li>åå¤è¯» n å˜</li><li>æ¯æ¬¡å¿«é€Ÿé˜…è¯»ï¼Œè¦æ±‚1.ä¸æ±‚ç”šè§£ï¼Œ2.è„‘å­é‡Œä¸è¦æœ‰è¯»çš„å£°éŸ³</li></ul><p>å…·ä½“ï¼š</p><ul><li>å…ˆè¯è¯»ç›®å½•ï¼Œå‰è¨€ï¼Œåè®° ç”¨ 15~30ï¼Œæ€è€ƒä¹¦çš„æ•´ä½“ç»“æ„ï¼Œä½œè€…å†™ä½œæ„å›¾</li><li>ä»æ¡†æ¶çš„å¤–å±‚ä¸€å±‚å±‚å‘çŸ¥è¯†ç»†èŠ‚æŒ–ï¼Œæ¯æ¬¡å¤„ç†ä¸€å±‚ï¼Œç†è§£ä¸€å±‚ï¼Œæ„å»ºè‡ªå·±å¯¹è¿™æœ¬ä¹¦çš„èµ„æ–™åº“ï¼ˆæ»šé›ªçƒçš„è¿‡ç¨‹ï¼‰</li></ul></blockquote><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p><ol><li>å¼ºè°ƒå…ˆæŒæ¡çŸ¥è¯†çš„æ¡†æ¶ï¼ä»æ•´ä½“çš„è§’åº¦ä¸€å±‚å±‚å­¦ä¹ çŸ¥è¯†ã€‚</li><li>æœ‰äº†æ¡†æ¶å°±çŸ¥é“æ£®æ—å¤§æ¦‚çš„æ ·å­ï¼</li><li>å¦‚æœå•çº¯çš„æŒ‰ç…§ç›®å½•ä¸€ç‚¹ç‚¹å­¦ä¹ ä¹¦æœ¬ä¸Šçš„çŸ¥è¯†ï¼Œä¼šé™·åœ¨å±€éƒ¨ç»†èŠ‚ä¸­å‡ºä¸æ¥æµªè´¹å¤§é‡æ—¶é—´ï¼Œè¯»ä¹¦æ—¶é—´è¿‡é•¿ï¼Œå‰é¢çš„çŸ¥è¯†ä¼šå¿˜ï¼Œåé¢ä¸ä¸€å®šä¼šè®¤çœŸè¯»å®Œï¼Œæœ€åæ•´æœ¬ä¹¦éƒ½å¾ˆéš¾ç†è§£ã€‚</li><li>ä½œè€…æ˜¯ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼å†™ä¹¦çš„å‘¢ï¼Ÿç±»ä¼¼äºã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹å…ˆæœ‰ä¸­å¿ƒæ€æƒ³ï¼Œç›®å½•ï¼Œæ®µè½ï¼Œç„¶åè½å®åˆ°ç»†èŠ‚ï¼Œã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹å°±æ˜¯æŒ‰ç…§ä½œè€…çš„å†™ä½œçš„æ–¹å¼ç†è§£çŸ¥è¯†çš„è¿‡ç¨‹ã€‚</li><li>é€Ÿè¯»ä¸å‘å‡ºå£°éŸ³ï¼Œæ›´æœ‰åˆ©äºè¯»è€…è·Ÿä½œè€…äº§ç”Ÿå…±é¸£ï¼è¿™ä¸ªä¹Ÿæ˜¯è¯»ä¹¦çš„ä¸€ä¸ªç›®çš„</li></ol><h2 id="ç›®æ ‡-vs-ä»»åŠ¡"><a class="markdownIt-Anchor" href="#ç›®æ ‡-vs-ä»»åŠ¡"></a> ç›®æ ‡ vs ä»»åŠ¡</h2><p>ç›®æ ‡ï¼šä¸€ä¸ªä½ æƒ³è¦çœ‹è§çš„å¥½ç»“æœ<br>ä»»åŠ¡ï¼šä¸ºå®ç°ç›®æ ‡ä½ è¦åšçš„äº‹</p><p>åœ¨ç¼ºå°‘åŠ¨åŠ›çš„æ—¶å€™å¤šæ€è€ƒç›®æ ‡å¸¦æ¥é‚£äº›ç¾å¥½çš„æ„¿æ™¯ï¼Œç”¨ Deadline ç»™è‡ªå·±æ–½åŠ å‹åŠ›ï¼Œå¯¹æ¯”äººçš„æ‰¿è¯ºã€‚</p><p>åœ¨æ‰§è¡Œçš„æ—¶å€™å¤šçœ‹ç»†èŠ‚ï¼Œä»»åŠ¡ï¼Œå› ä¸ºæ€»æ˜¯å…³æ³¨ç›®æ ‡ï¼Œä¼šæ— ä»ä¸‹æ‰‹ï¼Œå¾ˆå¤šç»†èŠ‚ä¸Šçš„å›°éš¾ä¹è§‚å¯¹å¾…ï¼å¯¼è‡´ç›®æ ‡æœ€ç»ˆææµ…ã€‚</p><h2 id="æ ‘çŠ¶ç»“æ„çŸ¥è¯†"><a class="markdownIt-Anchor" href="#æ ‘çŠ¶ç»“æ„çŸ¥è¯†"></a> æ ‘çŠ¶ç»“æ„çŸ¥è¯†</h2><p>æœ‰å…³æ ‘çŠ¶ç»“æ„ï¼ŒçŸ¥è¯†è¿­ä»£è¿‡ç¨‹éƒ½æ˜¯ä¸€å±‚å±‚åŒ…è£¹çš„çŸ¥è¯†ï¼Œæœ‰å†å²æ°”æ¯çš„çŸ¥è¯†éƒ½æ˜¯æ ‘çŠ¶ç»“æ„<br>è¿™æ ·çš„çŸ¥è¯†å¯ä»¥åƒã€Šé›ªçƒé€Ÿè¯»æ³•ã€‹ä¸€æ ·å±‚å±‚å­¦ä¹ </p><h2 id="è®¡ç®—æœºçŸ¥è¯†"><a class="markdownIt-Anchor" href="#è®¡ç®—æœºçŸ¥è¯†"></a> è®¡ç®—æœºçŸ¥è¯†</h2><p>è®¡ç®—æœºçŸ¥è¯†å°±æ˜¯ä¸€ä¸ªå¤§å¤§çš„æ ‘ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¤§æ ‘æï¼Œç„¶åä¸€å±‚å±‚åˆ†è§£è¿™ä¸ªçŸ¥è¯†ç‚¹<br><img src="/img/knowledge_tree.jpg" alt="-"></p><p>ç¨‹åºå¼€å‘çš„æ—¶å€™ä¹Ÿæ˜¯ï¼Œç°æœ‰ç»“æ„ï¼Œç„¶åå†æ˜¯ç»†èŠ‚ï¼</p><p>æœ‰æ—¶é—´è¡¥å……</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> æ€è€ƒ </category>
          
          <category> å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹ æ„Ÿæ‚Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift 5.RxDataSources</title>
      <link href="/2019/01/31/RxSwfit+RAC/RxSwift-RxDataSources/"/>
      <url>/2019/01/31/RxSwfit+RAC/RxSwift-RxDataSources/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="https://github.com/RxSwiftCommunity/RxDataSources/issues?q=is%3Aissue+is%3Aclosed" target="_blank" rel="noopener">åŸæ–‡: RxDataSources</a></p><h2 id="table-å’Œ-collection-view-data-sources"><a class="markdownIt-Anchor" href="#table-å’Œ-collection-view-data-sources"></a> Table å’Œ Collection View data sources</h2><h2 id="ç‰¹æ€§"><a class="markdownIt-Anchor" href="#ç‰¹æ€§"></a> ç‰¹æ€§</h2><ul><li>[x] O(N)è®¡ç®—å·®å¼‚çš„ç®—æ³•<ul><li>è¯¥ç®—æ³•å‡è®¾æ‰€æœ‰ sections å’Œ items éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤æ²¡æœ‰äºŒä¹‰æ€§</li><li>å¦‚æœæœ‰æ­§ä¹‰ï¼Œåœ¨éåŠ¨ç”»åˆ·æ–°æ—¶è‡ªåŠ¨å›é€€</li></ul></li><li>[x] ä»–ä½¿ç”¨å…¶ä»–å¯å‘å¼æ–¹æ³•ä»¥å°†æœ€å°‘æ•°é‡çš„å‘½ä»¤å‘é€åˆ°åˆ†æ®µè§†å›¾<ul><li>å³ä½¿è¿è¡Œæ—¶é—´æ˜¯çº¿æ€§çš„ï¼Œå‘é€å‘½ä»¤çš„é¦–é€‰æ•°é‡é€šå¸¸ä¹Ÿæ¯”çº¿æ€§å°‘</li><li>æœ€å¥½ï¼ˆå¹¶ä¸”æœ‰å¯èƒ½ï¼‰å°†æ›´æ”¹æ•°é‡é™åˆ¶ä¸ºè¾ƒå°çš„æ•°é‡ï¼Œå¹¶ä¸”å¦‚æœæ›´æ”¹æ•°é‡æœçº¿æ€§æ–¹å‘å¢é•¿ï¼Œåˆ™åªéœ€è¿›è¡Œæ­£å¸¸çš„reloadå³å¯</li></ul></li><li>[x] æ”¯æŒæ‰©å±•ä½ çš„ item å’Œ section ç»“æ„<ul><li>åªéœ€ä½¿ç”¨ <code>IdentifiableType</code> å’Œ <code>Equatable</code> æ‰©å±•ä½ çš„ itemï¼Œå¹¶ä½¿ç”¨ <code>AnimatableSectionModelType</code> æ‰©å±• section</li></ul></li><li>[x] æ”¯æŒ section å’Œ item çš„ä¸¤çº§åˆ†å±‚åŠ¨ç”»çš„æ‰€æœ‰ç»„åˆ<ul><li>Section åŠ¨ç”»: Insert, Delete, Mov</li><li>Item åŠ¨ç”»: Insert, Delete, Move, Reload (å¦‚æœæ—§å€¼ä¸ç­‰äºæ–°å€¼)</li></ul></li><li>[x] å¯é…ç½®åŠ¨ç”»ç±»å‹å¯¹äº Insert, Reload and Delete (Automatic, Fade, â€¦)</li><li>[x] ç¤ºä¾‹ app</li><li>[x] éšæœºå‹åŠ›æµ‹è¯•ï¼ˆeg appï¼‰</li><li>[x] æ”¯æŒå¼€ç®±å³ç”¨çš„ç¼–è¾‘ï¼ˆeg appï¼‰</li><li>[x] åŒ UITableView å’Œ UICollectionView ä¸€èµ·å·¥ä½œ</li></ul><h2 id="ä¸ºä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆ"></a> ä¸ºä»€ä¹ˆ</h2><p>ç¼–å†™ table å’Œ collection View æ•°æ®æºå¾ˆç¹çã€‚å¯¹äºæœ€ç®€å•çš„æƒ…å†µï¼Œéœ€è¦å®ç°å¤§é‡çš„å§”æ‰˜æ–¹æ³•ã€‚</p><p>RxSwift é€šè¿‡ç®€å•çš„æ•°æ®ç»‘å®šæœºåˆ¶æœ‰åŠ©äºå‡è½»ä¸€äº›è´Ÿæ‹…ï¼š</p><ol><li>æŠŠä½ çš„æ•°æ®è½¬åŒ–æˆå¯è§å¬åºåˆ— Observable</li><li>ä½¿ç”¨ä¸‹é¢æ–¹æ³•æŠŠæ•°æ®ç»‘å®šåˆ° tableView/collectionView ä¸Š<ul><li>rx.items(dataSource:protocol&lt;RxTableViewDataSourceType, UITableViewDataSource&gt;)</li><li>rx.items(cellIdentifier:String)</li><li>rx.items(cellIdentifier:String:Cell.Type:_: )</li><li>rx.items(<em>:</em>: )</li></ul></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = <span class="type">Observable</span>&lt;[<span class="type">String</span>]&gt;.just([<span class="string">"first element"</span>, <span class="string">"second element"</span>, <span class="string">"third element"</span>])</span><br><span class="line"></span><br><span class="line">data.bind(to: tableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; index, model, cell <span class="keyword">in</span></span><br><span class="line">  cell.textLabel?.text = model</span><br><span class="line">&#125;</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>è¿™é€‚ç”¨äºç®€å•æ•°æ®é›†ï¼Œä½†ä¸é€‚ç”¨äºéœ€è¦å°†å¤æ‚æ•°æ®é›†ä¸å¤šä¸ªsection ç»‘å®šæˆ–åœ¨æ·»åŠ /ä¿®æ”¹/åˆ é™¤item æ—¶éœ€è¦æ‰§è¡ŒåŠ¨ç”»çš„æƒ…å†µã€‚</p><p>è¿™äº›æ­£æ˜¯RxDataSourceså¸®åŠ©è§£å†³çš„ç”¨ä¾‹ã€‚</p><p>ä½¿ç”¨RxDataSourcesï¼Œå†™èµ·æ¥éå¸¸å®¹æ˜“</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataSource = <span class="type">RxTableViewSectionedReloadDataSource</span>&lt;<span class="type">SectionModel</span>&lt;<span class="type">String</span>, <span class="type">Int</span>&gt;&gt;(configureCell: configureCell)</span><br><span class="line"><span class="type">Observable</span>.just([<span class="type">SectionModel</span>(model: <span class="string">"title"</span>, items: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])])</span><br><span class="line">    .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kzaher/rxswiftcontent/rxdatasources/RxDataSources.gif" alt="-"></p><h2 id="æ€ä¹ˆç”¨"><a class="markdownIt-Anchor" href="#æ€ä¹ˆç”¨"></a> æ€ä¹ˆç”¨</h2><p>ç»™å®šä»¥ä¸‹è‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CustomData</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> anInt: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> aString: <span class="type">String</span></span><br><span class="line">  <span class="keyword">var</span> aCGPoint: <span class="type">CGPoint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä½¿ç”¨éµå¾ª SectionModelType åè®®çš„ç»“æ„å®šä¹‰ä½ çš„sectionï¼š<ul><li>å®šä¹‰ item ç±»å‹åˆ«åï¼šç­‰äºè¯¥ section å°†åŒ…å«çš„ item ç±»å‹</li><li>å£°æ˜ä¸€ä¸ª items å±æ€§ï¼šItem ç±»å‹æ•°ç»„</li></ul></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SectionOfCustomData</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> header: <span class="type">String</span>    </span><br><span class="line">  <span class="keyword">var</span> items: [<span class="type">Item</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SectionOfCustomData</span>: <span class="title">SectionModelType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">typealias</span> <span class="type">Item</span> = <span class="type">CustomData</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">init</span>(original: <span class="type">SectionOfCustomData</span>, items: [<span class="type">Item</span>]) &#123;</span><br><span class="line">    <span class="keyword">self</span> = original</span><br><span class="line">    <span class="keyword">self</span>.items = items</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºä¸€ä¸ªdataSourceå¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ SectionOfCustomData ç±»å‹ï¼š</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataSource = <span class="type">RxTableViewSectionedAnimatedDataSource</span>&lt;<span class="type">MySection</span>&gt;(</span><br><span class="line">    configureCell: &#123; ds, tv, <span class="number">_</span>, item <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> cell = tv.dequeueReusableCell(withIdentifier: <span class="string">"Cell"</span>) ?? <span class="type">UITableViewCell</span>(style: .<span class="keyword">default</span>, reuseIdentifier: <span class="string">"Cell"</span>)</span><br><span class="line">        cell.textLabel?.text = <span class="string">"Item \(item)"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;,</span><br><span class="line">    titleForHeaderInSection: &#123; ds, index <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> ds.sectionModels[index].header</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ol start="3"><li>æ ¹æ®éœ€è¦åœ¨dataSourceä¸Šè‡ªå®šä¹‰é—­åŒ…ï¼š<ul><li>titleForHeaderInSection</li><li>titleForFooterInSection</li><li>etc</li></ul></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dataSource.titleForHeaderInSection = &#123; dataSource, index <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">return</span> dataSource.sectionModels[index].header</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dataSource.titleForFooterInSection = &#123; dataSource, indexPath <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">return</span> dataSource.sectionModels[index].footer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dataSource.canEditRowAtIndexPath = &#123; dataSource, indexPath <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dataSource.canMoveRowAtIndexPath = &#123; dataSource, indexPath <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>å°†å®é™…æ•°æ®å®šä¹‰ä¸º CustomData å¯¹è±¡çš„ Observableåºåˆ—ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°tableView</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sections = [</span><br><span class="line">  <span class="type">SectionOfCustomData</span>(header: <span class="string">"First section"</span>, items: [<span class="type">CustomData</span>(anInt: <span class="number">0</span>, aString: <span class="string">"zero"</span>, aCGPoint: <span class="type">CGPoint</span>.zero), <span class="type">CustomData</span>(anInt: <span class="number">1</span>, aString: <span class="string">"one"</span>, aCGPoint: <span class="type">CGPoint</span>(x: <span class="number">1</span>, y: <span class="number">1</span>)) ]),</span><br><span class="line">  <span class="type">SectionOfCustomData</span>(header: <span class="string">"Second section"</span>, items: [<span class="type">CustomData</span>(anInt: <span class="number">2</span>, aString: <span class="string">"two"</span>, aCGPoint: <span class="type">CGPoint</span>(x: <span class="number">2</span>, y: <span class="number">2</span>)), <span class="type">CustomData</span>(anInt: <span class="number">3</span>, aString: <span class="string">"three"</span>, aCGPoint: <span class="type">CGPoint</span>(x: <span class="number">3</span>, y: <span class="number">3</span>)) ])</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="type">Observable</span>.just(sections)</span><br><span class="line">  .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®æºåŠ¨ç”»"><a class="markdownIt-Anchor" href="#æ•°æ®æºåŠ¨ç”»"></a> æ•°æ®æºåŠ¨ç”»</h2><p>RxDataSources æä¾›äº†ä¸¤ç§ç‰¹æ®Šçš„æ•°æ®æºç±»å‹ï¼Œå®ƒä»¬å¯ä»¥è‡ªåŠ¨å¤„ç†ç»‘å®šæ•°æ®æºä¸­çš„åŠ¨ç”»å˜åŒ–ï¼š<code>RxTableViewSectionedAnimatedDataSource</code> å’Œ <code>RxCollectionViewSectionedAnimatedDataSource</code> ã€‚</p><p>è¦ä½¿ç”¨ä¸¤ä¸ªåŠ¨ç”»æ•°æ®æºä¹‹ä¸€ï¼Œä½ å¿…é¡»åœ¨ä¸Šè¿°æ¦‚è¿°çš„åŸºç¡€ä¸Šé‡‡å–ä¸€äº›é¢å¤–çš„æ­¥éª¤ï¼š</p><ul><li>SectionOfCustomDataéœ€è¦éµå®ˆ AnimatableSectionModelType åè®®</li><li>æ•°æ®æ¨¡å‹å¿…é¡»ç¬¦åˆ<ul><li>IdentifiableTypeï¼šIdentifiableType åè®®æä¾›çš„ <code>identity</code> å¿…é¡»æ˜¯è¡¨ç¤ºæ¨¡å‹å®ä¾‹çš„ä¸å¯å˜æ ‡è¯†ç¬¦(identifier)ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Car æ¨¡å‹ï¼Œä½ å¯èƒ½è¦ä½¿ç”¨ Car çš„plateNumber ä½œä¸ºå…¶æ ‡è¯†ã€‚</li><li>Equatableï¼šéµä» Equatable åè®® æœ‰åŠ©äºRxDataSourcesç¡®å®šå“ªäº› cell å·²æ›´æ”¹ï¼Œå› æ­¤å®ƒåªèƒ½ä¸ºè¿™äº›ç‰¹å®š cell è®¾ç½®åŠ¨ç”»ã€‚è¿™æ„å‘³ç€ï¼Œæ›´æ”¹Caræ¨¡å‹çš„ä»»ä½•å±æ€§éƒ½ä¼šè§¦å‘è¯¥ cell çš„åŠ¨ç”»é‡æ–°åŠ è½½ã€‚</li></ul></li></ul><h2 id="éœ€è¦"><a class="markdownIt-Anchor" href="#éœ€è¦"></a> éœ€è¦</h2><p>Xcode 10.2</p><p>Swift 5.0</p><p>For Swift 4.x version please use versions 3.0.0 â€¦ 3.1.0 For Swift 3.x version please use versions 1.0 â€¦ 2.0.2 For Swift 2.3 version please use versions 0.1 â€¦ 0.9</p><h2 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h2><h3 id="cocoapods"><a class="markdownIt-Anchor" href="#cocoapods"></a> CocoaPods</h3><p>Podfile</p><blockquote><p>pod â€˜RxDataSourcesâ€™, â€˜~&gt; 4.0â€™</p></blockquote><h3 id="carthage"><a class="markdownIt-Anchor" href="#carthage"></a> Carthage</h3><p>Cartfile</p><blockquote><p>github â€œRxSwiftCommunity/RxDataSourcesâ€ ~&gt; 4.0</p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GCD åŸç†+API åˆ†æ</title>
      <link href="/2018/12/21/GCD-%E5%8E%9F%E7%90%86-API-%E5%88%86%E6%9E%90/"/>
      <url>/2018/12/21/GCD-%E5%8E%9F%E7%90%86-API-%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p>GCD æ˜¯æ“ä½œç³»ç»Ÿå±‚çº§çš„æ¦‚å¿µï¼Œä»–ç»™ç”¨æˆ·æä¾›äº†æ“ä½œçº¿ç¨‹çš„ API<br>ä»»åŠ¡æ´¾å‘ä¸­å¿ƒï¼Œå†…éƒ¨å®ç°åŸç†æ˜¯æœ‰äº† FIFO åˆ†å‘é˜Ÿåˆ—,<a href="http://libdispatch.macosforge.org/" target="_blank" rel="noopener">GCD æºç </a><br>ä½¿ç”¨ GCD ç”¨æˆ·ä¸éœ€è¦ç›´æ¥æ“ä½œç¹ççš„ threadï¼Œçº¿ç¨‹æ± ç”±ç³»ç»Ÿç®¡ç†ï¼Œç”¨æˆ·åªéœ€è¦ç»´æŠ¤åˆ†å‘é˜Ÿåˆ—ï¼Œå‘åˆ†å‘é˜Ÿåˆ—ä¸­æ”¾ task å°±å¯ä»¥äº†ã€‚<br>ç›´æ¥ä½¿ç”¨çº¿ç¨‹å¯èƒ½ä¼šå¼•å‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœä½ çš„ä»£ç å’Œæ‰€åŸºäºçš„æ¡†æ¶ä»£ç éƒ½åˆ›å»ºè‡ªå·±çš„çº¿ç¨‹æ—¶ï¼Œé‚£ä¹ˆæ´»åŠ¨çš„çº¿ç¨‹æ•°é‡æœ‰å¯èƒ½ä»¥æŒ‡æ•°çº§å¢é•¿ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ¶ˆè€—ä¸€äº›å†…å­˜å’Œå†…æ ¸èµ„æºã€‚</p><h2 id="ä¸»è¦åŸç†"><a class="markdownIt-Anchor" href="#ä¸»è¦åŸç†"></a> ä¸»è¦åŸç†</h2><p>ä¸»è¦ç†è§£ä¸‰ä¸ªæ¦‚å¿µ</p><ol><li>queue: ç®¡ç†ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œç¡®å®šä»»åŠ¡æ´¾å‘æ–¹å¼</li><li>task: ç”¨æˆ·è‡ªå®šä¹‰éœ€è¦æ‰§è¡Œçš„ task (ä»£ç æ®µ)</li><li>thread: GCD æ ¹æ® queue å®šä¹‰çš„æ–¹å¼ï¼Œå°† task æ´¾å‘ç»™çº¿ç¨‹æ± ä¸­çš„æŒ‡å®šçº¿ç¨‹ï¼ˆthread ä¸éœ€è¦è‡ªå·±åˆ›å»ºï¼‰</li></ol><p><img src="/img/GCD-thread-mode.jpg" alt="GCD Queue task thread"></p><ul><li>queue<ul><li>ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒä¸€ä¸ª thread ä¸Šä¸€ä¸ªæ¥ç€ä¸€ä¸ªçš„æ‰§è¡Œ<ul><li>ç‰¹ä¾‹ï¼šä¸»é˜Ÿåˆ— main_queueï¼Œæ‰€æœ‰ task åœ¨ mainThread ä¸­æ‰§è¡Œ</li></ul></li><li>å¹¶å‘é˜Ÿåˆ—ï¼Œä»»åŠ¡å¯ä»¥åœ¨å¤šä¸ª thread ä¸­æ‰§è¡Œæ²¡æœ‰å›ºå®šæ‰§è¡Œé¡ºåº<ul><li>ç‰¹ä¾‹ï¼šglobal é˜Ÿåˆ—</li></ul></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">concurrent</span><br><span class="line">adj. adj. å¹¶å‘çš„ï¼›ä¸€è‡´çš„ï¼›åŒæ—¶å‘ç”Ÿçš„ï¼›å¹¶å­˜çš„</span><br><span class="line">n. [æ•°] å…±ç‚¹ï¼›åŒæ—¶å‘ç”Ÿçš„äº‹ä»¶</span><br><span class="line"></span><br><span class="line">å¯¹äºå¹¶è¡Œè·Ÿå¹¶å‘</span><br><span class="line">å¹¶å‘ï¼šå€¼å¾—æ˜¯ç¨‹åºä¸Šå¤šthreadå¹¶å‘æ‰§è¡Œï¼Œå…¶å®æ˜¯å¤šçº¿ç¨‹æŠ¢å èµ„æº -- cpu æ‰§è¡Œï¼ˆä»»åŠ¡æ˜¯ä»¥åœ¨å•æ ¸ CPU ä¸Šåˆ†æ—¶ï¼ˆæ—¶é—´å…±äº«ï¼‰ï¼‰</span><br><span class="line">å¹¶è¡Œï¼šæ˜¯ç¡¬ä»¶ä¸Šï¼Œå¤šä¸ªthreadåœ¨å¤šä¸ª cpu ä¸ŠåŒäº‹æ‰§è¡Œç€</span><br></pre></td></tr></table></figure><ul><li><p>åŒæ­¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡</p><ul><li>sync æ‰€æœ‰ä»»åŠ¡è¦åœ¨ä¸€ä¸ª thread ä¸­æ‰§è¡Œï¼Œä¸€ä¸ªæ¥ç€ä¸€ä¸ª</li><li>async å…·å¤‡å¼€å¯çº¿ç¨‹çš„èƒ½åŠ›ï¼Œå¯ä»¥åœ¨å¤šä¸ªthread ä¸­å¹¶å‘æ‰§è¡Œä»»åŠ¡</li></ul></li><li><p>thread</p><ul><li>ä½¿ç”¨ GCDï¼Œä¸ç”¨å†ç›´æ¥è·Ÿçº¿ç¨‹æ‰“äº¤é“äº†ï¼Œåªéœ€è¦å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»£ç å—(task)å³å¯ï¼ŒGCD åœ¨åç«¯ç®¡ç†ç€ä¸€ä¸ªçº¿ç¨‹æ± ã€‚</li><li>ä½œä¸ºå¼€å‘è€…å¯ä»¥å°†å·¥ä½œè€ƒè™‘ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ä¸€å †çº¿ç¨‹ï¼Œè¿™ç§å¹¶è¡Œçš„æŠ½è±¡æ¨¡å‹æ›´å®¹æ˜“æŒæ¡å’Œä½¿ç”¨ã€‚</li><li>æ ¹æ®ğŸ‘†å›¾ task çœŸæ­£çš„å¹¶å‘åªæœ‰ å³ä¸‹è§’çš„æ‰èƒ½å‡ºç°ï¼Œå¹¶å‘é˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œä»»åŠ¡<br>P.S.ï¼šasync æ‰§è¡Œ taskçš„æ—¶å€™ thread çš„ä¸ªæ•°è·Ÿ task çš„ä¸ªæ•°æ²¡æœ‰å…³ç³»ï¼ˆç°åœ¨ iOSç³»ç»Ÿæ˜¯å¼€è¾Ÿ 6ä¸ª threadï¼Œä»¥å‰ä½ç‰ˆæœ¬çš„æ˜¯ 3ä¸ªï¼Œthread å¼€è¾Ÿå¤ªå¤šï¼Œä¼šç”¨æ‰å¤§é‡å†…å­˜ï¼‰</li></ul></li></ul><p>æ¥ä¸‹æ¥è¯´ä¸€äº› GCD æ¥å£ï¼Œæ ¹æ®æ¥å£åˆ†æåŸç†</p><h2 id="åˆ†å‘é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#åˆ†å‘é˜Ÿåˆ—"></a> åˆ†å‘é˜Ÿåˆ—</h2><h3 id="é˜Ÿåˆ—çš„åˆ›å»º"><a class="markdownIt-Anchor" href="#é˜Ÿåˆ—çš„åˆ›å»º"></a> é˜Ÿåˆ—çš„åˆ›å»º</h3><ol><li>GCD å…¬å¼€æœ‰ 5 ä¸ªä¸åŒçš„å…¨å±€é˜Ÿåˆ—ï¼š<ul><li>è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ main queueï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰</li><li>global é˜Ÿåˆ—ï¼Œ3 ä¸ªä¸åŒä¼˜å…ˆçº§çš„åå°é˜Ÿåˆ—ï¼ˆå¹¶å‘é˜Ÿåˆ—ï¼‰</li><li>ä»¥åŠä¸€ä¸ªä¼˜å…ˆçº§æ›´ä½çš„åå°é˜Ÿåˆ—ï¼ˆç”¨äº I/Oï¼‰ï¼ˆå¹¶å‘é˜Ÿåˆ—ï¼‰</li></ul></li></ol><p>å¾—åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_main_t mainDispatchQueue = dispatch_get_main_queue();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#define DISPATCH_QUEUE_PRIORITY_HIGH 2</span></span><br><span class="line"><span class="comment">#define DISPATCH_QUEUE_PRIORITY_DEFAULT 0</span></span><br><span class="line"><span class="comment">#define DISPATCH_QUEUE_PRIORITY_LOW (-2)</span></span><br><span class="line"><span class="comment">#define DISPATCH_QUEUE_PRIORITY_BACKGROUND INT16_MIN</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">dispatch_queue_global_t globalDispatchQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>è‡ªå®šä¹‰é˜Ÿåˆ—ï¼šä¸²è¡Œæˆ–è€…å¹¶è¡Œé˜Ÿåˆ—ã€‚è‡ªå®šä¹‰é˜Ÿåˆ—éå¸¸å¼ºå¤§ï¼Œ<strong>åœ¨è‡ªå®šä¹‰é˜Ÿåˆ—ä¸­è¢«è°ƒåº¦çš„æ‰€æœ‰ block æœ€ç»ˆéƒ½å°†è¢«æ”¾å…¥åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—ä¸­å’Œçº¿ç¨‹æ± ä¸­ã€‚</strong></li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue</span><br><span class="line">concurrentQueue = dispatch_queue_create(<span class="string">"concurrent"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"serial"</span>, DISPATCH_QUEUE_SERIAL);</span><br></pre></td></tr></table></figure><p><img src="https://objccn.io/images/issues/issue-2/gcd-queues.png" alt=""></p><h3 id="åˆ›å»ºé˜Ÿåˆ—å¹¶è®¾ç½®ä¼˜å…ˆçº§"><a class="markdownIt-Anchor" href="#åˆ›å»ºé˜Ÿåˆ—å¹¶è®¾ç½®ä¼˜å…ˆçº§"></a> åˆ›å»ºé˜Ÿåˆ—å¹¶è®¾ç½®ä¼˜å…ˆçº§</h3><ol><li>è·å–å…¨å±€ global ç³»ç»Ÿé˜Ÿåˆ—æ—¶ä¼ é€’ä¼˜å…ˆçº§</li><li>dipatch_queue_attr_make_with_qos_class</li><li>dispatch_set_target_queue</li></ol><p>ä½¿ç”¨ <code>dispatch_queue_attr_t</code> å±æ€§è®¾ç½®ä¼˜å…ˆçº§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span>;</span><br><span class="line"><span class="keyword">dispatch_queue_attr_t</span> attr;</span><br><span class="line">attr = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_UTILITY, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">queue</span> = dispatch_queue_create(<span class="string">"com.example.myqueue"</span>, attr);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* The global <span class="built_in">queue</span> priorities <span class="built_in">map</span> to the following QOS classes:</span><br><span class="line">*  - DISPATCH_QUEUE_PRIORITY_HIGH:         QOS_CLASS_USER_INITIATED</span><br><span class="line">*  - DISPATCH_QUEUE_PRIORITY_DEFAULT:      QOS_CLASS_DEFAULT</span><br><span class="line">*  - DISPATCH_QUEUE_PRIORITY_LOW:          QOS_CLASS_UTILITY</span><br><span class="line">*  - DISPATCH_QUEUE_PRIORITY_BACKGROUND:   QOS_CLASS_BACKGROUND</span><br></pre></td></tr></table></figure><p>è®¾ç½®ç›®æ ‡é˜Ÿåˆ—</p><details><summary>dispatch_set_target_queue ç›¸å…³æ³¨é‡Šè¯´æ˜</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* When no quality of service <span class="class"><span class="keyword">class</span> <span class="title">and</span> <span class="title">relative</span> <span class="title">priority</span> <span class="title">is</span> <span class="title">specified</span> <span class="title">for</span> <span class="title">a</span></span></span><br><span class="line"><span class="class">* <span class="title">dispatch</span> <span class="title">queue</span> <span class="title">at</span> <span class="title">the</span> <span class="title">time</span> <span class="title">of</span> <span class="title">creation</span>, <span class="title">a</span> <span class="title">dispatch</span> <span class="title">queue</span>'<span class="title">s</span> <span class="title">quality</span> <span class="title">of</span> <span class="title">service</span></span></span><br><span class="line"><span class="class">* <span class="title">class</span> <span class="title">is</span> <span class="title">inherited</span> <span class="title">from</span> <span class="title">its</span> <span class="title">target</span> <span class="title">queue</span>. <span class="title">The</span> <span class="title">dispatch_get_global_queue</span>()</span></span><br><span class="line"><span class="class">* <span class="title">function</span> <span class="title">may</span> <span class="title">be</span> <span class="title">used</span> <span class="title">to</span> <span class="title">obtain</span> <span class="title">a</span> <span class="title">target</span> <span class="title">queue</span> <span class="title">of</span> <span class="title">a</span> <span class="title">specific</span> <span class="title">quality</span> <span class="title">of</span></span></span><br><span class="line"><span class="class">* <span class="title">service</span> <span class="title">class</span>, <span class="title">however</span> <span class="title">the</span> <span class="title">use</span> <span class="title">of</span> <span class="title">dispatch_queue_attr_make_with_qos_class</span>()</span></span><br><span class="line"><span class="class">* <span class="title">is</span> <span class="title">recommended</span> <span class="title">instead</span>.</span></span><br></pre></td></tr></table></figure></pre><ul><li>QOS_CLASS_USER_INTERACTIVE æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—è´Ÿè´£æ‰§è¡Œä¸ç”¨æˆ·äº¤äº’ç›¸å…³çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ã€äº‹ä»¶å¤„ç†ã€æ›´æ–°UIç­‰ï¼Œæ‰€ä»¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚è¯¥ä¼˜å…ˆçº§çš„é˜Ÿåˆ—åº”è¯¥åªé™äºåšä¸ç”¨æˆ·äº¤äº’ç›¸å…³çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä¼˜å…ˆçº§çš„å®å®šä¹‰ä¸­å¹¶æ²¡æœ‰å°†å…¶æš´éœ²å‡ºæ¥ã€‚</li><li>QOS_CLASS_USER_INITIATED æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨æ¥æ‰§è¡Œé‚£äº›ä¼šé˜»ç¢ç”¨æˆ·ä½¿ç”¨ä½ çš„Appçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§ä¹Ÿå¾ˆé«˜ã€‚</li><li>QOS_CLASS_DEFAULT é»˜è®¤ä¼˜å…ˆçº§ã€‚</li><li>QOS_CLASS_UTILITY æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨äºæ‰§è¡Œé‚£äº›ç”¨æˆ·ä¸éœ€è¦ç«‹å³å¾—åˆ°ç»“æœçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§ç›¸å¯¹è¾ƒä½ã€‚</li><li>QOS_CLASS_BACKGROUND æŒ‡å®šä¸ºè¯¥QOS classçš„é˜Ÿåˆ—ç”¨äºæ‰§è¡Œç»´æŠ¤æˆ–æ¸…ç†ç­‰ä»»åŠ¡ï¼Œç”¨æˆ·ä¸éœ€è¦å…³å¿ƒå…¶ç»“æœã€‚</li></ul></details><ol><li>å°†è‡ªå®šä¹‰ queue ä¸­çš„ task éƒ½å°†è¢«æ”¾å…¥åˆ°ç³»ç»Ÿçš„å…¨å±€é˜Ÿåˆ—å’Œçº¿ç¨‹æ± ä¸­ï¼šé»˜è®¤æƒ…å†µä¸‹ä¼šæŠŠå¼€å‘è€…åˆ›å»ºçš„é˜Ÿåˆ—æ”¾å…¥åˆ°<strong>é»˜è®¤ä¼˜å…ˆçº§</strong>çš„å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ä½†æ˜¯ä¹Ÿå¯ä»¥ç»™è‡ªå®šä¹‰çš„é˜Ÿåˆ—è®¾ç½®ä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—</li><li>æ”¹å˜è‡ªå®šä¹‰ queue çš„ä¼˜å…ˆçº§ï¼šè®©å…¶æ‰§è¡Œä¼˜å…ˆçº§ä¸è¯¥ç›®æ ‡é˜Ÿåˆ—çš„æ‰§è¡Œä¼˜å…ˆçº§ä¸€è‡´ã€‚</li><li>æ”¹å˜ queue ä¸­ task æ‰§è¡Œçš„æ–¹å¼ï¼šä¸ä»…èƒ½æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ˜¯å…¶ç›®æ ‡é˜Ÿåˆ—æ˜¯ä¸²è¡Œçš„ï¼Œé‚£ä¹ˆå®é™…ä¸Šè¿™ä¸ªé˜Ÿåˆ—ä¹Ÿä¼šè½¬æ¢ä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚å†è€…ï¼Œä¸åŒä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œçš„ï¼Œå¦‚æœæŠŠè¿™äº›ä¸²è¡Œé˜Ÿåˆ—çš„ç›®æ ‡é˜Ÿåˆ—éƒ½è®¾ç½®ä¸ºåŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œé‚£è¿™äº›ä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å°†ä¸ä¼šå¹¶è¡Œæ‰§è¡Œã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> * @param object</span><br><span class="line"> * The object to modify.</span><br><span class="line"> * The result of passing <span class="literal">NULL</span> in <span class="keyword">this</span> parameter is undefined.</span><br><span class="line"> *</span><br><span class="line"> * @param <span class="built_in">queue</span></span><br><span class="line"> * The <span class="keyword">new</span> target <span class="built_in">queue</span> <span class="keyword">for</span> the object. The <span class="built_in">queue</span> is retained, <span class="keyword">and</span> the</span><br><span class="line"> * previous target <span class="built_in">queue</span>, <span class="keyword">if</span> any, is released.</span><br><span class="line"> * If <span class="built_in">queue</span> is DISPATCH_TARGET_QUEUE_DEFAULT, <span class="built_in">set</span> the object<span class="number">'</span>s target <span class="built_in">queue</span></span><br><span class="line"> * to the <span class="keyword">default</span> target <span class="built_in">queue</span> <span class="keyword">for</span> the given object type.</span><br><span class="line"> */</span><br><span class="line">DISPATCH_EXPORT DISPATCH_NOTHROW</span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">dispatch_set_target_queue(<span class="keyword">dispatch_object_t</span> object, <span class="keyword">dispatch_queue_t</span> _Nullable <span class="built_in">queue</span>);</span><br></pre></td></tr></table></figure><p>dispatch_set_target_queueï¼šå¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ä»¥è®¾ç½®é˜Ÿåˆ—å±‚çº§ä½“ç³»ï¼Œæ¯”å¦‚è®©å¤šä¸ªä¸²è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—åœ¨ç»Ÿä¸€ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œä¸²è¡Œæ‰§è¡Œ</p><details><summary>dispatch_set_target_queueä½¿ç”¨åçš„æ•ˆæœ</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setTarget</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> serialQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"serialQueue"</span>)</span><br><span class="line">  <span class="keyword">let</span> aQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"concurrent.queue.0"</span>, attributes: .concurrent, target: serialQueue)</span><br><span class="line">  <span class="keyword">let</span> bQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"concurrent.queue.1"</span>, attributes: .concurrent, target: serialQueue)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> alabel = aQueue.label</span><br><span class="line">  <span class="keyword">let</span> blabel = bQueue.label</span><br><span class="line">  aQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(alabel): 1"</span>)</span><br><span class="line">    sleep(<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  bQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(blabel): 2"</span>)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  bQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(blabel): 3"</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">concurrent.queue.0: 1</span></span><br><span class="line"><span class="comment">concurrent.queue.1: 2</span></span><br><span class="line"><span class="comment">concurrent.queue.1: 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nosetTarget</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> aQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"concurrent.queue.0"</span>, attributes: .concurrent)</span><br><span class="line">  <span class="keyword">let</span> bQueue = <span class="type">DispatchQueue</span>(label: <span class="string">"concurrent.queue.1"</span>, attributes: .concurrent)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> alabel = aQueue.label</span><br><span class="line">  <span class="keyword">let</span> blabel = bQueue.label</span><br><span class="line">  aQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(alabel): 1"</span>)</span><br><span class="line">    sleep(<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  bQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(blabel): 2"</span>)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  bQueue.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(blabel): 3"</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">concurrent.queue.0: 1</span></span><br><span class="line"><span class="comment">concurrent.queue.1: 3</span></span><br><span class="line"><span class="comment">concurrent.queue.1: 2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></pre></details><h2 id="gcd-ä»»åŠ¡è°ƒåº¦"><a class="markdownIt-Anchor" href="#gcd-ä»»åŠ¡è°ƒåº¦"></a> GCD ä»»åŠ¡è°ƒåº¦</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">sync</span><span class="params">(execute workItem: DispatchWorkItem)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">async</span><span class="params">(execute workItem: DispatchWorkItem)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">async</span><span class="params">(group: DispatchGroup, execute workItem: DispatchWorkItem)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">async</span><span class="params">(group: DispatchGroup? = <span class="literal">nil</span>, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention<span class="params">(block)</span></span></span> () -&gt; <span class="type">Void</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">sync</span>&lt;T&gt;<span class="params">(execute work: <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">sync</span>&lt;T&gt;<span class="params">(flags: DispatchWorkItemFlags, execute work: <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">asyncAfter</span><span class="params">(deadline: DispatchTime, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention<span class="params">(block)</span></span></span> () -&gt; <span class="type">Void</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">asyncAfter</span><span class="params">(wallDeadline: DispatchWallTime, qos: DispatchQoS = .unspecified, flags: DispatchWorkItemFlags = [], execute work: @escaping @convention<span class="params">(block)</span></span></span> () -&gt; <span class="type">Void</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">asyncAfter</span><span class="params">(deadline: DispatchTime, execute: DispatchWorkItem)</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">asyncAfter</span><span class="params">(wallDeadline: DispatchWallTime, execute: DispatchWorkItem)</span></span></span><br></pre></td></tr></table></figure><h3 id="åªæ‰§è¡Œä¸€æ¬¡-task"><a class="markdownIt-Anchor" href="#åªæ‰§è¡Œä¸€æ¬¡-task"></a> åªæ‰§è¡Œä¸€æ¬¡ task</h3><p>dispatch_once åªæ‰§è¡Œä¸€æ¬¡æŒ‡å®šçš„blockã€‚å®ƒçš„æ€§èƒ½è¦æ¯”@synchronizedè¦å¥½ã€‚@synchronizedæ¯ä¸€æ¬¡éƒ½è¦å…ˆè·å–é”ï¼Œè€Œdispatch_onceä½¿ç”¨ä¸€ä¸ªtokenæ ‡è¯†ä»£ç æ˜¯å¦æ‰§è¡Œè¿‡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åœ¨Swift 3.0ä¸­è¿™ä¸ªå‡½æ•°è¢«åºŸå¼ƒäº†ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨æ‡’åŠ è½½çš„å…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼Œä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> onceTask: <span class="type">String</span> = &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">"onceTask"</span></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ æ …æ å‡½æ•°"><a class="markdownIt-Anchor" href="#æ·»åŠ æ …æ å‡½æ•°"></a> æ·»åŠ æ …æ å‡½æ•°</h3><p><img src="/img/barrier.jpeg" alt=""></p><p>Dispatch Barrierè§£å†³å¤šçº¿ç¨‹å¤šè¯»å•å†™åŒä¸€ä¸ªèµ„æºå‘ç”Ÿæ­»é”é—®é¢˜<br>åŒæ­¥é˜Ÿåˆ—ä¸­ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜<br>åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæ·»åŠ äº† <code>.barrier</code> task é‚£ä¹ˆåœ¨ <code>.barrier</code> task ä¹‹å‰æ·»åŠ çš„ä»»åŠ¡æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œä¹‹å‰éƒ½ä¼šæœ‰ä»»åŠ¡æ‰§è¡Œï¼Œåœ¨å…¨å±€å¹¶å‘é˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ä¸Šï¼Œæ•ˆæœå’Œdispatch_syncä¸€æ ·</p><p><img src="/img/GCD_barrier.jpg" alt="barrier"></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">barrier</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> q = <span class="type">DispatchQueue</span>(label: <span class="string">"barrier"</span>, attributes: .concurrent)</span><br><span class="line">  q.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  q.async(flags: .barrier) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"sleep 2s----"</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  q.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  q.async &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">4</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary>ä¸€ä¸ª barrier åŠŸèƒ½çš„ PhotoManager</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">PhotoManager</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">let</span> concurrentPhotoQueue =</span><br><span class="line">    <span class="type">DispatchQueue</span>(</span><br><span class="line">      label: <span class="string">"com.raywenderlich.GooglyPuff.photoQueue"</span>,</span><br><span class="line">      attributes: .concurrent)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> unsafePhotos: [<span class="type">Photo</span>] = []</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> photos: [<span class="type">Photo</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> photosCopy: [<span class="type">Photo</span>] = []</span><br><span class="line">    concurrentPhotoQueue.sync &#123;</span><br><span class="line">      photosCopy = <span class="keyword">self</span>.unsafePhotos</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> photosCopy</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">addPhoto</span><span class="params">(<span class="number">_</span> photo: Photo)</span></span> &#123;</span><br><span class="line">    concurrentPhotoQueue.async(flags: .barrier) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">self</span>.unsafePhotos.append(photo)</span><br><span class="line">      <span class="type">DispatchQueue</span>.main.async &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>?.postContentAddedNotification()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">downloadPhotos</span><span class="params">(withCompletion completion: BatchPhotoDownloadingCompletionClosure?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> storedError: <span class="type">NSError?</span></span><br><span class="line">    <span class="keyword">for</span> address <span class="keyword">in</span> [<span class="type">PhotoURLString</span>.overlyAttachedGirlfriend,</span><br><span class="line">                    <span class="type">PhotoURLString</span>.successKid,</span><br><span class="line">                    <span class="type">PhotoURLString</span>.lotsOfFaces] &#123;</span><br><span class="line">                      <span class="keyword">let</span> url = <span class="type">URL</span>(string: address)</span><br><span class="line">                      <span class="keyword">let</span> photo = <span class="type">DownloadPhoto</span>(url: url!) &#123; <span class="number">_</span>, error <span class="keyword">in</span></span><br><span class="line">                        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">                          storedError = error</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="type">PhotoManager</span>.shared.addPhoto(photo)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    completion?(storedError)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">postContentAddedNotification</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(name: <span class="type">PhotoManagerNotification</span>.contentAdded, object: <span class="literal">nil</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h3 id="æ·»åŠ -group-é€šçŸ¥"><a class="markdownIt-Anchor" href="#æ·»åŠ -group-é€šçŸ¥"></a> æ·»åŠ  group é€šçŸ¥</h3><p>dispatch groupsæ˜¯ä¸“é—¨ç”¨æ¥ç›‘è§†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚dispatch_group_tå®ä¾‹ç”¨æ¥è¿½è¸ªä¸åŒé˜Ÿåˆ—ä¸­çš„ä¸åŒä»»åŠ¡ã€‚</p><p>å½“groupé‡Œæ‰€æœ‰äº‹ä»¶éƒ½å®ŒæˆGCD APIæœ‰ä¸¤ç§æ–¹å¼å‘é€é€šçŸ¥ï¼Œç¬¬ä¸€ç§æ˜¯dispatch_group_waitï¼Œä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç­‰æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆæˆ–ç­‰å¾…è¶…æ—¶ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨dispatch_group_notifyï¼Œå¼‚æ­¥æ‰§è¡Œé—­åŒ…ï¼Œä¸ä¼šé˜»å¡ã€‚</p><details><summary>ä¸€ä¸ªå¾ˆæ£’çš„ ä½¿ç”¨ group åšåŒæ­¥çš„ä¾‹å­</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">PhotoManager</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">let</span> concurrentPhotoQueue =</span><br><span class="line">    <span class="type">DispatchQueue</span>(</span><br><span class="line">      label: <span class="string">"com.raywenderlich.GooglyPuff.photoQueue"</span>,</span><br><span class="line">      attributes: .concurrent)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> unsafePhotos: [<span class="type">Photo</span>] = []</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> photos: [<span class="type">Photo</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> photosCopy: [<span class="type">Photo</span>]!</span><br><span class="line">    concurrentPhotoQueue.sync &#123;</span><br><span class="line">      photosCopy = <span class="keyword">self</span>.unsafePhotos</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> photosCopy</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">addPhoto</span><span class="params">(<span class="number">_</span> photo: Photo)</span></span> &#123;</span><br><span class="line">    concurrentPhotoQueue.async(flags: .barrier) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">self</span>.unsafePhotos.append(photo)</span><br><span class="line">      <span class="type">DispatchQueue</span>.main.async &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>?.postContentAddedNotification()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">downloadPhotos</span><span class="params">(withCompletion completion: BatchPhotoDownloadingCompletionClosure?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> storedError: <span class="type">NSError?</span></span><br><span class="line">    <span class="keyword">let</span> downloadGroup = <span class="type">DispatchGroup</span>()</span><br><span class="line">    <span class="keyword">var</span> addresses = [<span class="type">PhotoURLString</span>.overlyAttachedGirlfriend,</span><br><span class="line">                     <span class="type">PhotoURLString</span>.successKid,</span><br><span class="line">                     <span class="type">PhotoURLString</span>.lotsOfFaces]</span><br><span class="line">    addresses += addresses + addresses</span><br><span class="line">    <span class="keyword">var</span> blocks: [<span class="type">DispatchWorkItem</span>] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span>..&lt;addresses.<span class="built_in">count</span> &#123;</span><br><span class="line">      downloadGroup.enter()</span><br><span class="line">      <span class="keyword">let</span> block = <span class="type">DispatchWorkItem</span>(flags: .inheritQoS) &#123;</span><br><span class="line">        <span class="keyword">let</span> address = addresses[index]</span><br><span class="line">        <span class="keyword">let</span> url = <span class="type">URL</span>(string: address)</span><br><span class="line">        <span class="keyword">let</span> photo = <span class="type">DownloadPhoto</span>(url: url!) &#123; <span class="number">_</span>, error <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            storedError = error</span><br><span class="line">          &#125;</span><br><span class="line">          downloadGroup.leave()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">PhotoManager</span>.shared.addPhoto(photo)</span><br><span class="line">      &#125;</span><br><span class="line">      blocks.append(block)</span><br><span class="line">      <span class="type">DispatchQueue</span>.main.async(execute: block)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blocks[<span class="number">3</span>..&lt;blocks.<span class="built_in">count</span>] &#123;</span><br><span class="line">      <span class="keyword">let</span> cancel = <span class="type">Bool</span>.random()</span><br><span class="line">      <span class="keyword">if</span> cancel &#123;</span><br><span class="line">        block.cancel()</span><br><span class="line">        downloadGroup.leave()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    downloadGroup.notify(queue: <span class="type">DispatchQueue</span>.main) &#123;</span><br><span class="line">      completion?(storedError)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">postContentAddedNotification</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(name: <span class="type">PhotoManagerNotification</span>.contentAdded, object: <span class="literal">nil</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h3 id="æŒ‚èµ·æ¢å¤é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#æŒ‚èµ·æ¢å¤é˜Ÿåˆ—"></a> æŒ‚èµ·/æ¢å¤é˜Ÿåˆ—</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue.suspend()</span><br><span class="line">queue.resume()</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‚èµ·ä¸ä¼šæš‚åœæ­£åœ¨æ‰§è¡Œçš„block</p><h3 id="dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£"><a class="markdownIt-Anchor" href="#dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£"></a> dispatch_applyè¿›è¡Œå¿«é€Ÿè¿­ä»£</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">apply</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> q = <span class="type">DispatchQueue</span>(label: <span class="string">"apply"</span>, attributes: .concurrent)</span><br><span class="line">  __dispatch_apply(<span class="number">5</span>, q)&#123; idx <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(idx)<span class="comment">// å¼‚æ­¥å¹¶å‘</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"apply end"</span>)<span class="comment">// åŒæ­¥ç­‰å¾…</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">apply end</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>dispatch_apply</p><ul><li>åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­ä½¿ç”¨</li><li>å°† task è¿½åŠ åˆ°é˜Ÿåˆ—ä¸­</li><li>æ‰€æœ‰ task å¹¶å‘æ‰§è¡Œå®Œä»¥ååŒæ­¥æ‰§è¡Œåé¢çš„æ‰“å°</li><li>dispatch_apply æ·»åŠ çš„ task æ˜¯å¼‚æ­¥å¹¶å‘æ‰§è¡Œï¼Œå¤–éƒ¨æ˜¯åŒæ­¥æ‰§è¡Œ</li></ul><p><img src="/img/GCD_apply.jpg" alt="apply"></p><p>ç”¨dispatch_applyæ›¿ä»£å¯¹æ•°ç»„ç­‰çš„forå¾ªç¯ï¼ŒæŠŠè¿™äº›blockæ”¾åˆ°å¹¶è¡Œé˜Ÿåˆ—ä¸­å¯ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p><h3 id="dispatch-semaphore"><a class="markdownIt-Anchor" href="#dispatch-semaphore"></a> Dispatch Semaphore</h3><p>ä½¿ç”¨å˜é‡ç®¡ç†å¤šçº¿ç¨‹çš„åŒæ­¥æ–¹æ³•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_semaphore_t</span> dispatch_semaphore_create(<span class="keyword">long</span> value);</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_semaphore_wait</span><span class="params">(<span class="keyword">dispatch_semaphore_t</span> dsema, <span class="keyword">dispatch_time_t</span> timeout)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_semaphore_signal</span><span class="params">(<span class="keyword">dispatch_semaphore_t</span> dsema)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://objccn.io/issue-2-1/" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ï¼šAPI åŠæŒ‘æˆ˜</a><br><a href="https://github.com/ming1016/study/wiki/%E7%BB%86%E8%AF%B4GCD%EF%BC%88Grand-Central-Dispatch%EF%BC%89%E5%A6%82%E4%BD%95%E7%94%A8" target="_blank" rel="noopener">ç»†è¯´GCDï¼ˆGrand Central Dispatchï¼‰å¦‚ä½•ç”¨</a><br>raywenderlich è¿™ä¸¤ç¯‡å®ä¾‹å¾ˆæ£’ï¼<br><a href="https://www.raywenderlich.com/5370-grand-central-dispatch-tutorial-for-swift-4-part-1-2" target="_blank" rel="noopener">Grand Central Dispatch Tutorial for Swift 4: Part 1/2</a><br><a href="http://www.raywenderlich.com/79150/grand-central-dispatch-tutorial-swift-part-2" target="_blank" rel="noopener">Grand Central Dispatch Tutorial for Swift 4: Part 2/2<br></a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®€åŒ–è®¾è®¡ App çš„è¿‡ç¨‹</title>
      <link href="/2018/12/06/%E7%AE%80%E5%8C%96%E8%AE%BE%E8%AE%A1-App-%E7%9A%84%E8%BF%87%E7%A8%8B/"/>
      <url>/2018/12/06/%E7%AE%80%E5%8C%96%E8%AE%BE%E8%AE%A1-App-%E7%9A%84%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>ä¸€ä¸ª app åŸå‹&amp;éœ€æ±‚æ¥äº†ä»¥åï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ<br>æœ¬æ¥ä¸€ä¸ªå®Œæˆçš„ä¸œè¥¿å¦‚ä½•æŠŠéœ€æ±‚ç¿»è¯‘æˆç¨‹åºå‘¢ï¼Ÿ</p><h2 id="æ­£å¸¸èŠ‚å¥"><a class="markdownIt-Anchor" href="#æ­£å¸¸èŠ‚å¥"></a> æ­£å¸¸èŠ‚å¥ï¼š</h2><ol><li>åˆ†æéœ€æ±‚<ol><li>åŸå‹åˆ†æ</li><li>éœ€æ±‚åˆ†æ</li></ol></li><li>æŠ€æœ¯ç‚¹è°ƒç ”åˆ†æ<ol><li>æ¶æ„æ–¹å¼</li><li>ä½¿ç”¨ä»€ä¹ˆæ¡†æ¶ï¼ˆæ¡†æ¶å¯¹æ¯”ï¼‰</li><li>View å±‚ä½¿ç”¨ä»€ä¹ˆæ¸²æŸ“æ–¹å¼ï¼ŒModelå±‚ä½¿ç”¨ä»€ä¹ˆç»„ä»¶ï¼Œä¸­é—´å±‚ä½¿ç”¨ä»€ä¹ˆå·¥å…·</li></ol></li><li>æ—¶é—´é¢„ä¼°<ol><li>æ–°æŠ€æœ¯å­¦ä¹ æ—¶é—´</li><li>å¼€å‘æ—¶é—´</li><li>è°ƒè¯•æ—¶é—´</li></ol></li></ol><h2 id="é‡åˆ°é—®é¢˜"><a class="markdownIt-Anchor" href="#é‡åˆ°é—®é¢˜"></a> é‡åˆ°é—®é¢˜</h2><ol><li>éœ€æ±‚é‡å¤§ï¼Œå¼ºè°ƒä»£ç çš„å¤ç”¨æ€§ï¼æ€è€ƒæ—¶é—´è¿‡é•¿</li><li>éœ€æ±‚ç†è§£é”™è¯¯ï¼Œç†è§£ä¸æ·±ï¼Œå·®å¼‚æ€§é—®é¢˜æ²¡æœ‰è§£å†³</li><li>æ–°æŠ€æœ¯ï¼Œç†Ÿç»ƒåº¦é—®é¢˜ï¼Œé”™è¯¯ä½¿ç”¨</li><li>æ²Ÿé€šé—®é¢˜ï¼</li></ol><h2 id="ç®€å•æ€è€ƒ"><a class="markdownIt-Anchor" href="#ç®€å•æ€è€ƒ"></a> ç®€å•æ€è€ƒ</h2><ol><li>ç®€åŒ–å¼€å‘æµç¨‹ï¼</li><li>App ç¼–ç è¿‡ç¨‹<ol><li>ç…§ç€ç”» UI</li><li>ç¡®å®šæ•°æ®æ¸²æŸ“æ–¹å¼ï¼</li><li>ç®€åŒ–è®© model å±‚æ•°æ®ä¼ åˆ° UI å±‚æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œè®©æ°´æµé€šï¼ˆæˆ‘å–œæ¬¢çš„æ–¹å¼æ˜¯å‡½æ•°å“åº”å¼ rxï¼‰</li><li>æ•°æ®æµè¿æ¥å®Œæˆä»¥åï¼Œæ·»åŠ å„ç§é€»è¾‘<ol><li>å•é“¾é€»è¾‘</li><li>ä¸€æ¡æ¡åŠ </li><li>å¤ç”¨çš„åœ°æ–¹åœ¨å¤ç”¨</li></ol></li></ol></li><li>ä»£ç ä¸æ˜¯ä¸€ä¸‹å­å®Œç¾çš„ï¼<ol><li>å¼€å§‹çš„æ—¶å€™ä¸è¦å¤ªå¤æ‚</li><li>ä¸è¦ç”¨å¤ªé«˜ç«¯è‡ªå·±åˆä¸ç†Ÿæ‚‰çš„æŠ€å·§</li><li>é‡æ„ä¼˜åŒ–ä½¿ç”¨æ›´å¥½åœ°æŠ€æœ¯æ‰‹æ®µéƒ½æ˜¯è¿­ä»£çš„è¿‡ç¨‹</li></ol></li></ol><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> æ€è€ƒ </category>
          
          <category> å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹ æ„Ÿæ‚Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>viewController transitions</title>
      <link href="/2018/11/06/UI%20%E7%9B%B8%E5%85%B3/viewController-transitions/"/>
      <url>/2018/11/06/UI%20%E7%9B%B8%E5%85%B3/viewController-transitions/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>iOS ç³»ç»Ÿæä¾›äº†åƒ <code>push, pop, cover vertically</code> è¿™æ ·çš„ <code>ViewController</code> è¿‡æ¸¡ï¼Œè¯¥ç¯‡åˆ†æå¦‚ä½•è‡ªå®šä¹‰è‡ªå·±çš„ ViewController transitionsã€‚ä¸ºå•¥è¦å†™è¿™ä¸ªå› ä¸ºâ€œçœ‹ç€å¾ˆéº»çƒ¦â€ï¼Œæ¯”èµ· pushï¼Œpopï¼Œpresent æ¥è¯´â€¦â€¦</p><p>æ€è€ƒï¼š</p><ol><li>ViewController çš„ è¿‡æ¸¡æµç¨‹æ­¥éª¤æ˜¯ä»€ä¹ˆæ ·çš„</li><li>éƒ½æœ‰ä»€ä¹ˆç»„æˆï¼Œä»–ä»¬ä¹‹é—´çš„é€»è¾‘æ˜¯ä»€ä¹ˆæ ·çš„</li><li>ç”¨æˆ·å¦‚ä½•ä½¿ç”¨</li></ol><p>è¿‡æ¸¡çš„è¿‡ç¨‹ï¼Œåº”è¯¥æœ‰ï¼š</p><ol><li>è´Ÿè´£è§¦å‘äº‹ä»¶</li><li>è´Ÿè´£ç®¡ç†è¿‡æ¸¡åŠ¨ç”»</li><li>è´Ÿè´£è¿‡æ¸¡ç›¸å…³çš„ViewControllersï¼ŒViews</li></ol><h2 id="transitions-ç»“æ„"><a class="markdownIt-Anchor" href="#transitions-ç»“æ„"></a> transitions ç»“æ„</h2><p>transitioning API ä¸€ç»„ protocols ç»“åˆï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰åŒ–ï¼Œä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„ transition å¯¹è±¡ or è‡ªå·±å®šä¹‰ä¸€ä¸ªæ–°çš„ã€‚<br><img src="/img/Transition-Frame.jpeg" alt="transitioning API"></p><p>Q: æ¯ä¸ªåè®®çš„è´£ä»»æ˜¯ä»€ä¹ˆï¼Ÿ<br>Q: æ‰§è¡Œæ­¥éª¤æ˜¯ä»€ä¹ˆ</p><h3 id="transitioning-delegate"><a class="markdownIt-Anchor" href="#transitioning-delegate"></a> Transitioning Delegate</h3><p>æ¯ä¸ª ViewController éƒ½æœ‰å¯¹è±¡â€”â€” <code>transitioningDelegate: UIViewControllerTransitioningDelegate</code> ç”¨æ¥å¾—åˆ° Animation controller å¯¹è±¡</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CardViewController</span>: <span class="title">UIViewControllerTransitioningDelegate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">animationController</span><span class="params">(forPresented presented: UIViewController, presenting: UIViewController, source: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning?</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">FlipPresentAnimationController</span>(originFrame: cardView.frame)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä½  present or dismiss <code>ViewController</code> çš„æ—¶å€™ï¼ŒUIKit ä¼šå‘ <code>transitioningDelegate</code> è¦ä½ è‡ªå®šä¹‰çš„ <code>Animation controller</code> æ¥æ›¿ä»£é»˜è®¤åŠ¨ç”»ã€‚ä½ è¦åšçš„æ˜¯å®ç° <code>UIViewControllerTransitioningDelegate</code> ä»£ç†æ–¹æ³•è¿”å› <code>Animation controller</code></p><h3 id="animation-controller"><a class="markdownIt-Anchor" href="#animation-controller"></a> Animation Controller</h3><p>ç”¨æ¥åšè¿‡æ¸¡åŠ¨ç”»ï¼Œä»–å®ç°è‡ª <code>UIViewControllerAnimatedTransitioning</code></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlipPresentAnimationController</span>: <span class="title">NSObject</span>,<span class="title">UIViewControllerAnimatedTransitioning</span> </span>&#123;</span><br><span class="line"><span class="comment">// è®¾ç½®åŠ¨ç”»æ—¶é—´</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">transitionDuration</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning?)</span></span> -&gt; <span class="type">TimeInterval</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.6</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ä»UIViewControllerContextTransitioning ä¸­å¾—åˆ° toVc &amp; fromVcï¼Œå¯¹å…¶åˆ¶ä½œåŠ¨ç”»</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">animateTransition</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning)</span></span> &#123;</span><br><span class="line">    <span class="comment">//1 é€šè¿‡ transitionContext å¾—åˆ° fromVC æ˜¯è§¦å‘ presentçš„VCï¼ŒtoVC æ˜¯è¦è¢«å‘ˆç°çš„ VCï¼ŒsnapShotï¼Œæ˜¯toVC å‘ˆç°ä»¥åçš„view æˆªå›¾ç”¨äºåšåŠ¨ç”»</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> fromVC = transitionContext.viewController(forKey: .from),</span><br><span class="line">      <span class="keyword">let</span> toVC = transitionContext.viewController(forKey: .to),</span><br><span class="line">      <span class="keyword">let</span> snapshot = toVC.view.snapshotView(afterScreenUpdates: <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//containerView æ˜¯è¿‡æ¸¡è¿‡ç¨‹ä¸­çš„å®¹å™¨ view</span></span><br><span class="line">    <span class="keyword">let</span> containerView = transitionContext.containerView</span><br><span class="line">    <span class="keyword">let</span> finalFrame = transitionContext.finalFrame(<span class="keyword">for</span>: toVC)</span><br><span class="line"></span><br><span class="line">    snapshot.frame = originFrame</span><br><span class="line">    snapshot.layer.cornerRadius = <span class="type">CardViewController</span>.cardCornerRadius</span><br><span class="line">    snapshot.layer.masksToBounds = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    containerView.addSubview(toVC.view)</span><br><span class="line">    containerView.addSubview(snapshot)</span><br><span class="line">    toVC.view.isHidden = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="type">AnimationHelper</span>.perspectiveTransform(<span class="keyword">for</span>: containerView)</span><br><span class="line">    snapshot.layer.transform = <span class="type">AnimationHelper</span>.yRotation(.pi / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">let</span> duration = transitionDuration(using: transitionContext)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹ view åšåŠ¨ç”»å¤„ç†</span></span><br><span class="line">    <span class="type">UIView</span>.animateKeyframes(</span><br><span class="line">      withDuration: duration,</span><br><span class="line">      delay: <span class="number">0</span>,</span><br><span class="line">      options: .calculationModeCubic,</span><br><span class="line">      animations: &#123;</span><br><span class="line">        <span class="type">UIView</span>.addKeyframe(withRelativeStartTime: <span class="number">0.0</span>, relativeDuration: <span class="number">1</span>/<span class="number">3</span>) &#123;</span><br><span class="line">          fromVC.view.layer.transform = <span class="type">AnimationHelper</span>.yRotation(-.pi / <span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UIView</span>.addKeyframe(withRelativeStartTime: <span class="number">1</span>/<span class="number">3</span>, relativeDuration: <span class="number">1</span>/<span class="number">3</span>) &#123;</span><br><span class="line">          snapshot.layer.transform = <span class="type">AnimationHelper</span>.yRotation(<span class="number">0.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UIView</span>.addKeyframe(withRelativeStartTime: <span class="number">2</span>/<span class="number">3</span>, relativeDuration: <span class="number">1</span>/<span class="number">3</span>) &#123;</span><br><span class="line">          snapshot.frame = finalFrame</span><br><span class="line">          snapshot.layer.cornerRadius = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">      completion: &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">        toVC.view.isHidden = <span class="literal">false</span></span><br><span class="line">        snapshot.removeFromSuperview()</span><br><span class="line">        fromVC.view.layer.transform = <span class="type">CATransform3DIdentity</span></span><br><span class="line">        transitionContext.completeTransition(!transitionContext.transitionWasCancelled)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç®€è¿°"><a class="markdownIt-Anchor" href="#ç®€è¿°"></a> ç®€è¿°</h2><p>å¯¹äºéœ€è¦è‡ªå®šä¹‰çš„ transitioning çš„ ViewControllerï¼ŒCustomViewController</p><ol><li>CustomViewController: UIViewControllerTransitioningDelegate å®ç°åè®®</li><li>å®ç°åè®®çš„</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">animationController(presented:, presenting:, source:) -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span></span><br><span class="line">animationController(dismiss:) -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span></span><br></pre></td></tr></table></figure><ol start="3"><li>è‡ªå®šä¹‰ Animation Controllerï¼ˆCustomeAnimationController: UIViewControllerAnimatedTransitioning)</li><li>å®ç° UIViewControllerAnimatedTransitioning ä¸­çš„</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">transitionDuration(using transitionContext: <span class="type">UIViewControllerContextTransitioning?</span>) -&gt; <span class="type">TimeInterval</span></span><br><span class="line">animateTransition(transitionContext:)</span><br></pre></td></tr></table></figure><h2 id="ç»™-dismiss-æ·»åŠ æ‰‹åŠ¿äº¤äº’"><a class="markdownIt-Anchor" href="#ç»™-dismiss-æ·»åŠ æ‰‹åŠ¿äº¤äº’"></a> ç»™ dismiss æ·»åŠ æ‰‹åŠ¿äº¤äº’</h2><p><img src="https://koenig-media.raywenderlich.com/uploads/2015/07/settings.gif" alt=""></p><blockquote><p><a href="https://www.raywenderlich.com/322-custom-uiviewcontroller-transitions-getting-started#toc-anchor-011" target="_blank" rel="noopener">Custom UIViewController Transitions: Getting Started</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>App æ¶æ„</title>
      <link href="/2018/09/18/architecture/App-%E6%9E%B6%E6%9E%84/"/>
      <url>/2018/09/18/architecture/App-%E6%9E%B6%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>objc ã€ŠApp æ¶æ„ã€‹ ç¬”è®°</p><h2 id="å¦‚ä½•è®¾è®¡æ¶æ„"><a class="markdownIt-Anchor" href="#å¦‚ä½•è®¾è®¡æ¶æ„"></a> å¦‚ä½•è®¾è®¡æ¶æ„</h2><ol><li>ç¡®å®šæ¨¡å—ï¼ˆModel å±‚ï¼ŒView å±‚ï¼Œåè°ƒå™¨â€¦â€¦ï¼‰<ol><li>å¦‚ä½•ç¡®å®šæ¨¡å—ï¼Ÿè”æƒ³å®é™…åœºæ™¯ï¼Œåˆ†æè´£ä»»ã€è¡Œä¸ºï¼Œç¡®å®šæ¨¡å—ï¼ï¼</li><li>ä¸ºä»€ä¹ˆè¦ç¡®å®šæ¨¡å—ï¼Ÿç¡®å®šæ¨¡å—åï¼Œç¨‹åºä¸ä¼šè¢«åº”ç”¨æ¡†æ¶ä¸­çš„å®ç°ç»†èŠ‚æ‰€æ”¯é…</li></ol></li><li>æ¨¡å—é—´çš„è”ç³»ï¼Œä¾èµ–ï¼Œå˜æ¢ï¼Œé€šçŸ¥è¡Œä¸ºå¦‚ä½•å®šä¹‰ã€‚<ol><li>å°½å¯èƒ½è®©æ•°æ®æµå‘å•å‘æ¸…æ™°</li><li>ç¡®å®šæ•°æ®æµå‘è¡Œä¸ºç»Ÿä¸€ä¸€è‡´ï¼Œç»Ÿä¸€ç¨‹åºå¼€å‘ç»´æŠ¤<ol><li>delegateï¼Œnotificationï¼Œblockï¼Œkvoï¼ŒRxâ€¦â€¦</li></ol></li></ol></li></ol><h2 id="mvc"><a class="markdownIt-Anchor" href="#mvc"></a> MVC</h2><p><img src="/img/MVC.jpeg" alt="mvc"></p><p>Model å±‚åŒ…æ‹¬ï¼Œdata modelå’Œserver model<br>controlerï¼šå¼•ç”¨ server model</p><h2 id="mvvm-c"><a class="markdownIt-Anchor" href="#mvvm-c"></a> MVVM-C</h2><p><img src="/img/mvvm-c.jpeg" alt="mvvm-c"></p><h2 id="ç½‘ç»œ"><a class="markdownIt-Anchor" href="#ç½‘ç»œ"></a> ç½‘ç»œ</h2><h2 id="mvcviewstate"><a class="markdownIt-Anchor" href="#mvcviewstate"></a> MVC+ViewState</h2><p><img src="/img/mvc-viewstate.jpeg" alt="mvc-viewstate"></p><h2 id="model-é€‚é…å™¨-view-ç»‘å®šå™¨"><a class="markdownIt-Anchor" href="#model-é€‚é…å™¨-view-ç»‘å®šå™¨"></a> Model é€‚é…å™¨ + View ç»‘å®šå™¨</h2><h2 id="elm-æ¶æ„"><a class="markdownIt-Anchor" href="#elm-æ¶æ„"></a> Elm æ¶æ„</h2><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ€æƒ³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ€æƒ³ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>â€œTâ€ å­—æ¨¡å‹</title>
      <link href="/2018/08/24/%E5%BC%80%E5%8F%91%E4%B8%8A%E7%9A%84%E6%80%9D%E8%80%83/"/>
      <url>/2018/08/24/%E5%BC%80%E5%8F%91%E4%B8%8A%E7%9A%84%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="æ¶æ„çš„æ—¶å€™å®¹æ˜“ä¹±ä½¿ç”¨-t-å­—æ¨¡å‹æ€è€ƒ"><a class="markdownIt-Anchor" href="#æ¶æ„çš„æ—¶å€™å®¹æ˜“ä¹±ä½¿ç”¨-t-å­—æ¨¡å‹æ€è€ƒ"></a> æ¶æ„çš„æ—¶å€™å®¹æ˜“ä¹±â€”â€”ä½¿ç”¨ â€œTâ€ å­—æ¨¡å‹æ€è€ƒ</h2><p>åŸå› ï¼š<br>æ¶æ„ä»£ç çš„æ—¶å€™ï¼Œæ€»æƒ³æœ‰æ²¡æœ‰æ›´å¥½åœ°è§£å†³æ–¹æ¡ˆï¼Œå¦‚ä½•å°½å¯èƒ½çš„æ¨¡å—è§£è€¦ï¼Œè´£ä»»å•ä¸€â€¦â€¦ï¼Œå¦‚ä½•æŸ¥åˆ†ç±»ï¼Œæ¶æ„ä¸­éœ€è¦æœ‰ä»€ä¹ˆæ¨¡å—ï¼Œéœ€è¦ä½¿ç”¨ä»€ä¹ˆå·¥å…·é“¾â€¦â€¦</p><p>å¯æ˜¯ä¸€ä¸‹å­æŠŠæ‰€æœ‰é—®æ”¾åœ¨ä¸€èµ·ï¼Œæ•´ä¸ªäººå¾ˆå¤šæ—¶å€™ä¼šä¹±ï¼Œè€Œä¸”æƒ³çš„è¶Šå¤šè¶Šä¹±</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>ç®€å•åŒ–æ¨¡å—ï¼Œç°æœ‰æœ€åŸºæœ¬çš„æ¡†æ¶ eg MVVMï¼ŒMVC</li><li>æŠŠæœ€ç®€å•çš„æ¨¡å‹å…ˆæ­å»ºèµ·æ¥ï¼Œç„¶åå®ç°ä¸€ä¸ªä¸»æµç¨‹åŠŸèƒ½</li><li>æ¥ç€åœ¨å®ç°å…¶ä»–ä¸»æµç¨‹åŠŸèƒ½</li><li>æƒ³æƒ³å¯ä»¥æ·»åŠ é‚£äº› æ¨¡å—ç»„ä»¶ è®©è‡ªå·±çš„æ¶æ„æ›´åŠ ä¼˜ç¾</li><li>é‡æ„ï¼Œç„¶åå†å…ˆæœ‰ä¸ªä¸»æµç¨‹çº¿</li></ol><p>æ€»ç»“ï¼š</p><ol><li>ç°æœ‰è¦åšçš„ä¸œè¥¿æœ‰ä¸ª å¤–åœ¨çš„æ•´ä½“è®¤è¯†ï¼Œæƒ³ç»™ç”¨æˆ·æä¾›ä»€ä¹ˆ æ¥å£ï¼</li><li>å…ˆå®ç°ä¸€ä¸ªæ¥å£çš„åŠŸèƒ½ï¼Œç„¶åå†æŠŠæ‰€æœ‰çº¿çš„å®ç°å‡ºæ¥</li><li>é‡æ„</li></ol><p>æ•´ä½“æ€æƒ³æ–¹å¼ æ˜¯ â€œTâ€ å­—æ€è€ƒ</p><h2 id="æ¨¡å—ç»„ä»¶é—´äº¤äº’ç¹æ‚-ä¸ºä»€ä¹ˆæœ‰-ä¸­ä»‹è€…"><a class="markdownIt-Anchor" href="#æ¨¡å—ç»„ä»¶é—´äº¤äº’ç¹æ‚-ä¸ºä»€ä¹ˆæœ‰-ä¸­ä»‹è€…"></a> æ¨¡å—ç»„ä»¶é—´äº¤äº’ç¹æ‚â€”â€” ä¸ºä»€ä¹ˆæœ‰ ä¸­ä»‹è€…</h2><ol><li>ç¨‹åºè°ƒç”¨æµç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ€ç»´æ··ä¹±çš„ç¨‹åºå‘˜å¾ˆå®¹æ˜“æŠŠè¿™æ¡çº¿æçš„æ‚ä¹±æ— ç« ï¼Œè™½ç„¶å¯ä»¥è®©ç¨‹åºè·‘èµ·æ¥ï¼Œå¯æ˜¯ç»´æŠ¤è´¹åŠ²</li><li>ä¸­ä»‹è€…ï¼šæ¨¡å—ä¸­æä¾›ä¸­ä»‹è€…ï¼Œå®šä¹‰ä¸€ç§ç¼–ç¨‹è§„èŒƒï¼Œä½¿ç”¨ ä¸­ä»‹è€… è®©ä»£ç åˆ†ç±»ï¼Œè¿™æ ·æŠŠæ¨¡å—å‡å°‘ï¼Œå‡å°‘æ‚ä¹±çš„çº¿ï¼Œè¿™äº›çº¿æ”¾åœ¨ä¸­ä»‹è€…ä¸­</li></ol><p><img src="/img/meditator_chaos.jpg" alt="chaos"><br><img src="/img/meditator_order.jpg" alt="order"></p><p>ä¸­ä»‹è€…â€”â€” åƒä¸ªç®¡ç†è€…ä¸€æ ·ï¼Œåœ¨å®é™…ä¸­è°ƒåº¦å„ä¸ªéƒ¨é—¨ï¼Œéƒ¨é—¨æœ‰ä»€ä¹ˆé—®é¢˜æƒ³ä¸­ä»‹è€…æ±‡æŠ¥</p><p>å¦‚æœæ²¡æœ‰ä¸­ä»‹è€…â€”â€”ç®¡ç†è€…ï¼Œé‚£ä¹ˆ éƒ¨é—¨ä¹‹é—´é—®é¢˜ç›¸äº’ç©¿æ’ orz</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> æ€è€ƒ </category>
          
          <category> å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹ æ„Ÿæ‚Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift æºç åˆ†æ</title>
      <link href="/2018/08/18/RxSwfit+RAC/RxSwift-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>/2018/08/18/RxSwfit+RAC/RxSwift-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p><img src="/img/RxSwift001.jpg" alt="frame"></p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çˆ¬æ¥¼æ¢¯</title>
      <link href="/2018/07/03/%E7%88%AC%E6%A5%BC%E6%A2%AF/"/>
      <url>/2018/07/03/%E7%88%AC%E6%A5%BC%E6%A2%AF/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p><a href="https://leetcode-cn.com/problems/climbing-stairs" target="_blank" rel="noopener">çˆ¬æ¥¼æ¢¯</a></p><h2 id="é—®é¢˜æè¿°"><a class="markdownIt-Anchor" href="#é—®é¢˜æè¿°"></a> é—®é¢˜æè¿°</h2><p>å‡è®¾ä½ æ­£åœ¨çˆ¬æ¥¼æ¢¯ã€‚éœ€è¦ nÂ é˜¶ä½ æ‰èƒ½åˆ°è¾¾æ¥¼é¡¶ã€‚<br>æ¯æ¬¡ä½ å¯ä»¥çˆ¬ 1 æˆ– 2 ä¸ªå°é˜¶ã€‚ä½ æœ‰å¤šå°‘ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">æ³¨æ„ï¼šç»™å®š n æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚ </span><br><span class="line">ç¤ºä¾‹ <span class="number">1</span>ï¼š </span><br><span class="line">è¾“å…¥ï¼š <span class="number">2</span></span><br><span class="line">è¾“å‡ºï¼š <span class="number">2</span></span><br><span class="line">è§£é‡Šï¼š æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶ã€‚</span><br><span class="line"><span class="number">1.</span>  <span class="number">1</span> é˜¶ + <span class="number">1</span> é˜¶</span><br><span class="line"><span class="number">2.</span>  <span class="number">2</span> é˜¶</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹ <span class="number">2</span>ï¼š </span><br><span class="line">è¾“å…¥ï¼š <span class="number">3</span></span><br><span class="line">è¾“å‡ºï¼š <span class="number">3</span></span><br><span class="line">è§£é‡Šï¼š æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥çˆ¬åˆ°æ¥¼é¡¶ã€‚</span><br><span class="line"><span class="number">1.</span>  <span class="number">1</span> é˜¶ + <span class="number">1</span> é˜¶ + <span class="number">1</span> é˜¶</span><br><span class="line"><span class="number">2.</span>  <span class="number">1</span> é˜¶ + <span class="number">2</span> é˜¶</span><br><span class="line"><span class="number">3.</span>  <span class="number">2</span> é˜¶ + <span class="number">1</span> é˜¶</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2><ol><li>ä½¿ç”¨é€’å½’æš´åŠ›è§£å†³é—®é¢˜</li><li>ä¼˜åŒ–ä½¿ç”¨è®°å¿†åŒ–é€’å½’</li><li>åŠ¨æ€è§„åˆ’</li></ol><p>climbStairs(i,n)=(i+1,n)+climbStairs(i+2,n)</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">climbStairs</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">climbStairs_</span><span class="params">(<span class="number">_</span> i: Int, <span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> i &gt; n &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> i == n &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> climbStairs_(i+<span class="number">1</span>, n) + climbStairs_(i+<span class="number">2</span>, n)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> climbStairs_(<span class="number">0</span>, n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">climbStairs</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> memo: [<span class="type">Int?</span>] = <span class="type">Array</span>(repeating: <span class="literal">nil</span>, <span class="built_in">count</span>: n)</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">climbStairs</span><span class="params">(<span class="number">_</span> n: Int, <span class="number">_</span> memo: <span class="keyword">inout</span> [Int?])</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> n</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> index = n - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> memo[index] != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> memo[index]!</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      memo[index] = climbStairs(n - <span class="number">1</span>, &amp;memo) + climbStairs(n - <span class="number">2</span>, &amp;memo)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> memo[index]!</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> res = climbStairs(n, &amp;memo)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">climbStairs</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> n &gt; <span class="number">1</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> n &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> dp: [<span class="type">Int</span>] = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">3</span></span><br><span class="line">  <span class="keyword">while</span> i &lt;= n &#123;</span><br><span class="line">    dp.append(dp[i-<span class="number">1</span>] + dp[i - <span class="number">2</span>])</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dp[n]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">climbStairs</span><span class="params">(<span class="number">_</span> n: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> n &gt; <span class="number">1</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> n &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> first = <span class="number">1</span></span><br><span class="line">  <span class="keyword">var</span> second = <span class="number">2</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">3</span></span><br><span class="line">  <span class="keyword">while</span> i &lt;= n &#123;</span><br><span class="line">    <span class="keyword">let</span> third = first + second</span><br><span class="line">    first = second</span><br><span class="line">    second = third</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> second</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
          <category> åŠ¨æ€è§„åˆ’ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</title>
      <link href="/2018/07/02/%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E6%9C%89%E5%BA%8F%E6%95%B0%E7%BB%84/"/>
      <url>/2018/07/02/%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E6%9C%89%E5%BA%8F%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p><a href="https://leetcode-cn.com/problems/merge-sorted-array/" target="_blank" rel="noopener">åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</a></p><h2 id="é¢˜ç›®æè¿°"><a class="markdownIt-Anchor" href="#é¢˜ç›®æè¿°"></a> é¢˜ç›®æè¿°</h2><p>ç»™ä½ ä¸¤ä¸ªæœ‰åºæ•´æ•°æ•°ç»„Â nums1 å’Œ nums2ï¼Œè¯·ä½ å°† nums2 åˆå¹¶åˆ°Â nums1Â ä¸­ï¼Œä½¿ nums1 æˆä¸ºä¸€ä¸ªæœ‰åºæ•°ç»„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¯´æ˜:</span><br><span class="line">åˆå§‹åŒ–Â nums1 å’Œ nums2 çš„å…ƒç´ æ•°é‡åˆ†åˆ«ä¸ºÂ m å’Œ n ã€‚</span><br><span class="line">ä½ å¯ä»¥å‡è®¾Â nums1Â æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼ˆç©ºé—´å¤§å°å¤§äºæˆ–ç­‰äºÂ m + nï¼‰æ¥ä¿å­˜ nums2 ä¸­çš„å…ƒç´ ã€‚</span><br><span class="line">Â  </span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">è¾“å…¥:</span><br><span class="line">nums1 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>], m = <span class="number">3</span></span><br><span class="line">nums2 = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>],       n = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">è¾“å‡º:Â [<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2><p>æœ‰åºæ•°ç»„åˆå¹¶ï¼Œç©ºé—´è¶³å¤Ÿï¼Œé‚£ä¹ˆä¸ä½¿ç”¨ç¼“å­˜å¤„ç†</p><p>ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ä¸¤ä¸ªæ•°ç»„çš„æœ€åé¢<br>pt1 = m - 1<br>pt2 = n - 1<br>æ•°ç»„é•¿åº¦<br>len = 3 + 3<br>nums1 å½“å‰æŒ‡é’ˆ curr = len - 1</p><p>å› ä¸º nums1 æ˜¯è¿ç»­çš„ï¼Œnums2 æ”¾åˆ° nums1 é‡Œé¢ï¼Œé‚£ä¹ˆå½“ nums2 éå†å®Œåæ•´ä¸ªéå†å°±ç»“æŸäº†</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(<span class="number">_</span> nums1: <span class="keyword">inout</span> [Int], <span class="number">_</span> m: Int, <span class="number">_</span> nums2: [Int], <span class="number">_</span> n: Int)</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> cur = m + n - <span class="number">1</span></span><br><span class="line">  <span class="keyword">var</span> idx1 = m - <span class="number">1</span></span><br><span class="line">  <span class="keyword">var</span> idx2 = n - <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> idx2 &gt;= <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> idx1 &gt;= <span class="number">0</span> &amp;&amp; nums1[idx1] &gt; nums2[idx2] &#123;</span><br><span class="line">      nums1[cur] = nums1[idx1]</span><br><span class="line">      idx1 -= <span class="number">1</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      nums1[cur] = nums2[idx2]</span><br><span class="line">      idx2 -= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    cur -= <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</title>
      <link href="/2018/07/02/%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2/"/>
      <url>/2018/07/02/%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p><a href="https://leetcode-cn.com/problems/longest-substring-without-repeating-characters/" target="_blank" rel="noopener">æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</a></p><h2 id="é¢˜ç›®æè¿°"><a class="markdownIt-Anchor" href="#é¢˜ç›®æè¿°"></a> é¢˜ç›®æè¿°</h2><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„Â æœ€é•¿å­ä¸²Â çš„é•¿åº¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹Â <span class="number">1</span>:</span><br><span class="line">è¾“å…¥: <span class="string">"abcabcbb"</span></span><br><span class="line">è¾“å‡º: <span class="number">3</span></span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ <span class="string">"abc"</span>ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º <span class="number">3</span>ã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹ <span class="number">2</span>:</span><br><span class="line">è¾“å…¥: <span class="string">"bbbbb"</span></span><br><span class="line">è¾“å‡º: <span class="number">1</span></span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ <span class="string">"b"</span>ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º <span class="number">1</span>ã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹ <span class="number">3</span>:</span><br><span class="line">è¾“å…¥: <span class="string">"pwwkew"</span></span><br><span class="line">è¾“å‡º: <span class="number">3</span></span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯Â <span class="string">"wke"</span>ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º <span class="number">3</span>ã€‚</span><br><span class="line">Â     è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ<span class="string">"pwke"</span>Â æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a class="markdownIt-Anchor" href="#åˆ†æ"></a> åˆ†æ</h2><ol><li>ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•å‘¢ï¼Ÿ<ol><li>æ¯ä¸ªæ˜¯ä¸æ˜¯éƒ½æ˜¯ ascii ç ï¼Ÿå¦‚æœæ˜¯å°±å°è¯•ä½¿ç”¨asciiåšæ˜ å°„åš</li><li>æ»‘åŠ¨çª—å£ï¼Œä»å·¦å‘å³æ»‘åŠ¨</li><li>åŠ¨æ€è§„åˆ’ç¼©å°èŒƒå›´</li></ol></li></ol><p>å…ˆä½¿ç”¨æ»‘åŠ¨çª—å£çš„æ–¹æ³•åš</p><h3 id="æ»‘åŠ¨çª—å£"><a class="markdownIt-Anchor" href="#æ»‘åŠ¨çª—å£"></a> æ»‘åŠ¨çª—å£</h3><ol><li>è¦æœ‰å·¦å³æŒ‡é’ˆæŒ‡æ˜çª—å£ä½ç½®ï¼Œå¤§å°</li><li>å³æŒ‡é’ˆå…ˆè¡Œèµ°åšéå†ï¼Œå·¦æŒ‡é’ˆæ ¹æ®å…·ä½“æ¡ä»¶å‘å³æ»‘åŠ¨</li><li>å½“å³æŒ‡é’ˆèµ°åˆ°å°½å¤´ï¼Œéå†ç»“æŸ</li></ol><p>é¢˜ç›®åˆ†æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">left, right = <span class="number">0</span></span><br><span class="line">right: <span class="number">0</span> -&gt; n</span><br><span class="line">  left å‘å³ç§»åŠ¨æ¡ä»¶ï¼š</span><br><span class="line">   s[right]æ˜¯å¦å­˜åœ¨åœ¨çª—å£å­ä¸²ä¸­</span><br><span class="line">   left ç§»åŠ¨åˆ°çª—å£å­ä¸²ä¸­å­—ç¬¦ s[right] çš„ä¸‹ä¸€ä¸ªä½ç½®</span><br><span class="line">   è®°å½•é•¿åº¦length</span><br><span class="line">è¿”å› <span class="built_in">max</span>(right - left, length)</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(<span class="number">_</span> s: String)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> len = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">left</span> = s.startIndex</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">right</span> = <span class="keyword">left</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> window = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="keyword">right</span> != s.endIndex &#123;</span><br><span class="line">    <span class="keyword">let</span> curChar = s[<span class="keyword">right</span>]</span><br><span class="line">    <span class="keyword">if</span> window.<span class="built_in">contains</span>(curChar) &#123;</span><br><span class="line">      <span class="keyword">let</span> index = window.firstIndex(of: curChar)!</span><br><span class="line">      <span class="keyword">let</span> <span class="built_in">distance</span> = window.<span class="built_in">distance</span>(from: window.startIndex, to: index)</span><br><span class="line">      <span class="keyword">left</span> = s.index(<span class="keyword">left</span>, offsetBy: <span class="built_in">distance</span> + <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">right</span> = s.index(after: <span class="keyword">right</span>)</span><br><span class="line">    window = <span class="type">String</span>(s[<span class="keyword">left</span>..&lt;<span class="keyword">right</span>])</span><br><span class="line">    len = <span class="built_in">max</span>(len, s.<span class="built_in">distance</span>(from: <span class="keyword">left</span>, to: <span class="keyword">right</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> len</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">leetcode ç»“æœ</span><br><span class="line"><span class="number">104</span> ms<span class="number">21.1</span> <span class="type">MB</span><span class="type">Swift</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ hashMap ç¼“å­˜window ä»¥åä¼˜åŒ–æ‰§è¡Œæ—¶é—´</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(<span class="number">_</span> s: String)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> itemMap: [<span class="type">Character</span>: <span class="type">Int</span>] = [:]</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">left</span> = <span class="number">0</span>, <span class="keyword">right</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> len = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> e <span class="keyword">in</span> s &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> idx = itemMap[e] &#123;</span><br><span class="line">      <span class="comment">//1. ä½¿ç”¨max å»æ‰ left ä¹‹å‰çš„å…ƒç´ ï¼Œä¹‹å‰æ˜¯è¿™æ ·ä¼šæœ‰é—®é¢˜left = idx + 1</span></span><br><span class="line">      <span class="keyword">left</span> = <span class="built_in">max</span>(idx + <span class="number">1</span>, <span class="keyword">left</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    itemMap[e] = <span class="keyword">right</span></span><br><span class="line">    len = <span class="built_in">max</span>(len, <span class="keyword">right</span> - <span class="keyword">left</span> + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">right</span> += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> len</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">44</span> ms<span class="number">21.1</span> <span class="type">MB</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šé¢æ³¨é‡Šçš„ 1ï¼Œå¦‚æœä½¿ç”¨ left = idx + 1 çš„è¯ eg â€œabbaâ€<br>å½“ curr æŒ‡é’ˆæŒ‡åˆ°ç¬¬äºŒä¸ª b æ—¶ï¼Œleft = 2<br>å½“ curr æŒ‡é’ˆæŒ‡åˆ°ç¬¬äºŒä¸ª a æ—¶ï¼Œleft = 1<br>æˆ‘ä»¬è¦åšçš„æ˜¯å¦‚ä½•æŠŠ itemMap ä¸­ç¬¬äºŒä¸ª b ä¹‹å‰ä¸åœ¨ window çš„å…ƒç´ æ¸…ç©ºæ‰ï¼Ÿ<br>å› ä¸ºç»“æœæ˜¯ index ç›¸å…³ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ max å°±å¯ä»¥äº† left = max(idx + 1, left)</p><p>P.S: ä½¿ç”¨ maxæ–¹æ³•æˆªæ–­æ•°ç»„</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
          <category> æ»‘åŠ¨çª—å£ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
            <tag> æ»‘åŠ¨çª—å£ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³è”å¯¹è±¡</title>
      <link href="/2018/07/01/deep%20analyse/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/"/>
      <url>/2018/07/01/deep%20analyse/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="å…³è”å¯¹è±¡æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#å…³è”å¯¹è±¡æ˜¯ä»€ä¹ˆ"></a> å…³è”å¯¹è±¡æ˜¯ä»€ä¹ˆ</h2><ul><li>ä»–æ˜¯ objective-c runtime æœºåˆ¶ä¸­æä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œè®©ç”¨æˆ·åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€çš„ç»™ç±»æ·»åŠ å…³è”å±æ€§</li></ul><h2 id="å…³è”å¯¹è±¡çš„ä¸»è¦ä½œç”¨"><a class="markdownIt-Anchor" href="#å…³è”å¯¹è±¡çš„ä¸»è¦ä½œç”¨"></a> å…³è”å¯¹è±¡çš„ä¸»è¦ä½œç”¨</h2><p>å¼€å‘ä¸­å¦‚ä½•ç»™ category æ·»åŠ æˆå‘˜å±æ€§å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œå¦‚ä½•åœ¨è¿è¡Œæ—¶ç»™ class å…³è”æ–°çš„å±æ€§ï¼Ÿ</p><ul><li>ä¸»è¦ä½œç”¨ï¼šç»™category æ·»åŠ æˆå‘˜å˜é‡<ul><li>category åº•å±‚ç»“æ„çš„é™åˆ¶ï¼Œä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡åˆ°åˆ†ç±»ä¸­ã€‚ä½†å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ¥é—´æ¥æ·»åŠ ã€‚</li><li>åˆ†ç±»ä¸­çš„ @property åªèƒ½å£°æ˜å±æ€§ï¼Œä¸æä¾› _name, getName, setName çš„å®ç°</li><li>ç±»ä¸­ @property æä¾› _name, getName, setName çš„å®ç°</li></ul></li></ul><h2 id="å¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢"><a class="markdownIt-Anchor" href="#å¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢"></a> å¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢</h2><h3 id="å…³è”å¯¹è±¡æ¥å£"><a class="markdownIt-Anchor" href="#å…³è”å¯¹è±¡æ¥å£"></a> å…³è”å¯¹è±¡æ¥å£</h3><p><code>&lt;objc/runtime.h&gt;</code> ä¸­å®šä¹‰çš„ä»¥ä¸‹ä¸‰ä¸ªå…è®¸ä½ å°†ä»»ä½•é”®å€¼åœ¨è¿è¡Œæ—¶å…³è”åˆ°å¯¹è±¡ä¸Šçš„å‡½æ•°ï¼š</p><ul><li>objc_setAssociatedObject</li><li>objc_getAssociatedObject</li><li>objc_removeAssociatedObjects</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">object   :è¡¨ç¤ºå…³è”è€…ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå˜é‡åç†æ‰€å½“ç„¶ä¹Ÿæ˜¯object</span></span><br><span class="line"><span class="comment">key      :è·å–è¢«å…³è”è€…çš„ç´¢å¼•key</span></span><br><span class="line"><span class="comment">value    :è¢«å…³è”è€…</span></span><br><span class="line"><span class="comment">policy   :å…³è”æ—¶é‡‡ç”¨çš„åè®®ï¼Œæœ‰assignï¼Œretainï¼Œcopyç­‰åè®®ï¼Œä¸€èˆ¬ä½¿ç”¨OBJC_ASSOCIATION_RETAIN_NONATOMIC </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">id <span class="title">objc_getAssociatedObject</span><span class="params">(id object, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_setAssociatedObject</span><span class="params">(id object, <span class="keyword">const</span> <span class="keyword">void</span> *key, id value, objc_AssociationPolicy policy)</span></span>;</span><br><span class="line"><span class="comment">//ç§»é™¤æŸä¸ªå¯¹è±¡èº«ä¸Šçš„æ‰€æœ‰å…³è”çš„å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_removeAssociatedObjects</span><span class="params">(id object)</span></span></span><br></pre></td></tr></table></figure><h2 id="å®é™…ä½¿ç”¨æ•ˆæœ"><a class="markdownIt-Anchor" href="#å®é™…ä½¿ç”¨æ•ˆæœ"></a> å®é™…ä½¿ç”¨æ•ˆæœ</h2><p>å¯¹æ¯”å­—å…¸å®ç°ç»™åˆ†ç±»æ·»åŠ  property</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Banana</span> (<span class="title">Test</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> weight;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define Key [NSString stringWithFormat:@<span class="meta-string">"%p"</span>, self]</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Banana</span> (<span class="title">Test</span>)</span></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *names_;</span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *weights_;</span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    weights_ = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    names_ = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    names_[Key] = name;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">return</span> names_[Key];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setWeight:(<span class="keyword">int</span>)weight &#123;</span><br><span class="line">    weights_[Key] = @(weight);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">int</span>)weight &#123;</span><br><span class="line">    <span class="keyword">return</span> [weights_[Key] intValue];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä½¿ç”¨å…¨å±€å­—å…¸çš„æ–¹å¼ï¼Œç»™åˆ†ç±»ä¸­çš„æˆå‘˜å˜é‡æ·»åŠ getï¼Œset å®ç°ä½“</p><p>é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡å‘¢ï¼Ÿ</p><ul><li>å…³è”å¯¹è±¡å®ç°åˆ†ç±»æ·»åŠ æˆå‘˜å±æ€§</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Banana</span> (<span class="title">Test</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="comment">// éšå¼å‚æ•°_cmd == @selector(name)</span></span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setWeight:(<span class="keyword">int</span>)weight &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weight), @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">int</span>)weight &#123;</span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) intValue];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="å…³è”å¯¹è±¡æºç åˆ†æ"><a class="markdownIt-Anchor" href="#å…³è”å¯¹è±¡æºç åˆ†æ"></a> å…³è”å¯¹è±¡æºç åˆ†æ</h2><p>å…³è”å¯¹è±¡ä¹Ÿæ˜¯ç”¨å…¨å±€ hash è¡¨æ¥ä¿å­˜çš„ã€‚<br><a href="https://opensource.apple.com/tarballs/objc4/objc4-779.1.tar.gz" target="_blank" rel="noopener">objc4-779.1æºç </a> è¿™ä¸ªæ–‡ä»¶ä¸­ <a href="http://objc-references.mm" target="_blank" rel="noopener">objc-references.mm</a></p><p>å…³è”å¯¹è±¡çš„æ ¸å¿ƒç±»</p><div align="left"><img src="/img/ao.jpeg" style="width:800px;height:370px"></div><ul><li>AssociationsManager</li><li>AssociationsHashMap</li><li>ObjectAssociationMap</li><li>ObjcAssociation</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssociationsManager</span> &#123;</span></span><br><span class="line">  <span class="comment">// associative references: object pointer -&gt; PtrPtrHashMap.</span></span><br><span class="line">  <span class="keyword">static</span> AssociationsHashMap *_map;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssociationsHashMap</span> :</span> <span class="keyword">public</span> <span class="built_in">unordered_map</span>&lt;<span class="keyword">disguised_ptr_t</span>, ObjectAssociationMap *, DisguisedPointerHash, DisguisedPointerEqual, AssociationsHashMapAllocator&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectAssociationMap</span> :</span> <span class="keyword">public</span> <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">void</span> *, ObjcAssociation, ObjectPointerLess, ObjectAssociationMapAllocator&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjcAssociation</span> &#123;</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> _policy;</span><br><span class="line">  id _value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="å…³è”å¯¹è±¡ä½•æ—¶é‡Šæ”¾"><a class="markdownIt-Anchor" href="#å…³è”å¯¹è±¡ä½•æ—¶é‡Šæ”¾"></a> å…³è”å¯¹è±¡ä½•æ—¶é‡Šæ”¾</h3><p>â€¦â€¦ ä¸æƒ³çœ‹äº†ï¼Œæƒ³çœ‹äº†å†è¡¥å……ï¼Œæ€»ä¹‹ä»–åœ¨æ‰€å…³è”çš„å¯¹è±¡é‡Šæ”¾åï¼Œä¼šé‡Šæ”¾çš„</p><h3 id="å…³è”æ—¶é‡‡ç”¨çš„åè®®"><a class="markdownIt-Anchor" href="#å…³è”æ—¶é‡‡ç”¨çš„åè®®"></a> å…³è”æ—¶é‡‡ç”¨çš„åè®®</h3><table><thead><tr><th>Behavior</th><th>@property Equivalent</th><th>Description</th></tr></thead><tbody><tr><td>OBJC_ASSOCIATION_ASSIGN</td><td>@property (assign) æˆ– @property (unsafe_unretained)</td><td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td><td>@property (nonatomic, strong)</td><td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td></tr><tr><td>OBJC_ASSOCIATION_COPY_NONATOMIC</td><td>@property (nonatomic, copy)</td><td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN</td><td>@property (atomic, strong)</td><td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td></tr><tr><td>OBJC_ASSOCIATION_COPY</td><td>@property (atomic, copy)</td><td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td></tr></tbody></table><h2 id="å®é™…ä¸­ä½¿ç”¨å…³è”å¯¹è±¡çš„ä¾‹å­"><a class="markdownIt-Anchor" href="#å®é™…ä¸­ä½¿ç”¨å…³è”å¯¹è±¡çš„ä¾‹å­"></a> å®é™…ä¸­ä½¿ç”¨å…³è”å¯¹è±¡çš„ä¾‹å­</h2><p><a href="https://changzw.github.io/2020/03/08/%E4%BD%BF%E7%94%A8-closures-%E6%B7%BB%E5%8A%A0-Gesture-Recognizers/">ä½¿ç”¨ closures æ·»åŠ  Gesture Recognizers</a></p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>__weak å®ç°åˆ†æ</title>
      <link href="/2018/06/01/weak-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/"/>
      <url>/2018/06/01/weak-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>runtime ç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚<br>weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼š</p><ul><li>keyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€</li><li>valueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡æŒ‡é’ˆçš„åœ°å€ï¼‰æ•°ç»„</li></ul><h2 id="weak-æºç åˆ†æ"><a class="markdownIt-Anchor" href="#weak-æºç åˆ†æ"></a> weak æºç åˆ†æ</h2><p>åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€</p><p>__weakå˜é‡çš„å­˜å‚¨</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç  */</span></span><br><span class="line">id obj1;</span><br><span class="line">objc_initWeak(&amp;obj1, obj);</span><br><span class="line">objc_destroyWeak(&amp;obj1);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Initialize a fresh weak pointer to some object location. </span></span><br><span class="line"><span class="comment"> * It would be used for code like: </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * (The nil case) </span></span><br><span class="line"><span class="comment"> * __weak id weakPtr;</span></span><br><span class="line"><span class="comment"> * (The non-nil case) </span></span><br><span class="line"><span class="comment"> * NSObject *o = ...;</span></span><br><span class="line"><span class="comment"> * __weak id weakPtr = o;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param location Address of __weak ptr. </span></span><br><span class="line"><span class="comment"> * @param newObj Object ptr. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> HaveOld &#123; DontHaveOld = <span class="literal">false</span>, DoHaveOld = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">enum</span> HaveNew &#123; DontHaveNew = <span class="literal">false</span>, DoHaveNew = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="function">id <span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">    *location = nil;</span><br><span class="line">    <span class="keyword">return</span> nil;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">      (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;HaveOld haveOld, HaveNew haveNew,</span><br><span class="line">      CrashIfDeallocating crashIfDeallocating&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> id <span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> </span>&#123;</span><br><span class="line">  Class previouslyInitializedClass = nil;</span><br><span class="line">  id oldObj;</span><br><span class="line">  SideTable *oldTable;</span><br><span class="line">  SideTable *newTable;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Acquire locks for old and new values.</span></span><br><span class="line">  <span class="comment">// Order by lock address to prevent lock ordering problems. </span></span><br><span class="line">  <span class="comment">// Retry if the old value changes underneath us.</span></span><br><span class="line"> retry:</span><br><span class="line">  <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">    oldObj = *location;</span><br><span class="line">    oldTable = &amp;SideTables()[oldObj];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    oldTable = nil;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">    newTable = &amp;SideTables()[newObj];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    newTable = nil;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (haveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">    SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent a deadlock between the weak reference machinery</span></span><br><span class="line">  <span class="comment">// and the +initialize machinery by ensuring that no </span></span><br><span class="line">  <span class="comment">// weakly-referenced object has an un-+initialized isa.</span></span><br><span class="line">  <span class="keyword">if</span> (haveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">    Class cls = newObj-&gt;getIsa();</span><br><span class="line">    <span class="keyword">if</span> (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) &#123;</span><br><span class="line">      SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">      class_initialize(cls, (id)newObj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this class is finished with +initialize then we're good.</span></span><br><span class="line">      <span class="comment">// If this class is still running +initialize on this thread </span></span><br><span class="line">      <span class="comment">// (i.e. +initialize called storeWeak on an instance of itself)</span></span><br><span class="line">      <span class="comment">// then we may proceed but it will appear initializing and </span></span><br><span class="line">      <span class="comment">// not yet initialized to the check above.</span></span><br><span class="line">      <span class="comment">// Instead set previouslyInitializedClass to recognize it on retry.</span></span><br><span class="line">      previouslyInitializedClass = cls; </span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up old value, if any.</span></span><br><span class="line">  <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">    weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assign new value, if any.</span></span><br><span class="line">  <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">    newObj = (objc_object *)</span><br><span class="line">      weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, </span><br><span class="line">                  crashIfDeallocating);</span><br><span class="line">    <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">    <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">      newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">    *location = (id)newObj;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No new value. The storage is not changed.</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (id)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sidetable"><a class="markdownIt-Anchor" href="#sidetable"></a> SideTable</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></span><br><span class="line">  <span class="comment">// è‡ªæ—‹é”ï¼Œç”¨äºå¯¹SideTableæ“ä½œæ—¶è¿›è¡ŒåŠ é”</span></span><br><span class="line">  <span class="keyword">spinlock_t</span> slock;</span><br><span class="line">  <span class="comment">// å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">  RefcountMap refcnts;</span><br><span class="line">  <span class="comment">// å­˜å‚¨å¯¹è±¡çš„å¼±å¼•ç”¨</span></span><br><span class="line">  <span class="keyword">weak_table_t</span> weak_table; </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» SideTables æ˜¯ä¸€ä¸ª StripedMap<sidetable></sidetable></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> StripedMap&lt;SideTable&gt;&amp; SideTables() &#123;</span><br><span class="line">  <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StripedMap</span> &#123;</span></span><br><span class="line">  <span class="comment">// å®šä¹‰æ•£åˆ—è¡¨çš„å¤§å°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">  <span class="keyword">enum</span> &#123; StripeCount = <span class="number">8</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">enum</span> &#123; StripeCount = <span class="number">64</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">PaddedT</span> &#123;</span></span><br><span class="line">    <span class="function">T value <span class="title">alignas</span><span class="params">(CacheLineSize)</span></span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  PaddedT <span class="built_in">array</span>[StripeCount];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ•£åˆ—å‡½æ•°ï¼šé€šè¿‡æŒ‡é’ˆåœ°å€è®¡ç®—å‡ºindex</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uintptr_t</span> addr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(p);</span><br><span class="line">    <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‘ç”Ÿæ•£åˆ—å†²çªçš„æ—¶å€™ï¼Œå¤šä¸ªå¯¹è±¡ä¼šå…±ç”¨ä¸€ä¸ªSideTableï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå¯¹è±¡ä¼šå…±ç”¨ä¸€ä¸ªrefcntså’Œweak_tableã€‚</p><p>weak_table_t</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_table_t</span> &#123;</span></span><br><span class="line">  <span class="comment">// å­˜å‚¨weak_entry_t</span></span><br><span class="line">  <span class="keyword">weak_entry_t</span> *weak_entries;</span><br><span class="line">  <span class="comment">// å½“å‰weak_entry_tçš„ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">size_t</span>    num_entries;</span><br><span class="line">  <span class="comment">// å½“å‰æ•°ç»„èƒ½å¤Ÿå®¹çº³çš„æœ€å¤§ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> mask;</span><br><span class="line">  <span class="comment">// å‘ç”Ÿæ•£åˆ—å†²çªæ—¶ï¼Œèƒ½å¤Ÿéå†çš„å…ƒç´ çš„æœ€å¤§ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>autoreleasepool å®ç°åˆ†æ</title>
      <link href="/2018/05/31/autoreleasepool-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/"/>
      <url>/2018/05/31/autoreleasepool-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="autorelease-å†…éƒ¨ç»“æ„"><a class="markdownIt-Anchor" href="#autorelease-å†…éƒ¨ç»“æ„"></a> AutoRelease å†…éƒ¨ç»“æ„</h2><p>AutoReleasePool æ˜¯åˆ©ç”¨è¯­è¨€ä¸Šçš„ç‰¹æ€§ï¼Œç¨‹åºå†…å­˜è‡ªåŠ¨å›æ”¶é—®é¢˜çš„</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@autoreleasepool æ˜¯ä»€ä¹ˆï¼Ÿåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ clang -rewrite-objc main.m è®©ç¼–è¯‘å™¨é‡æ–°æ”¹å†™è¿™ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">AtAutoreleasePool</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> * atautoreleasepoolobj;</span><br><span class="line">  __AtAutoreleasePool() &#123; <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">     atautoreleasepoolobj = objc_autoreleasePoolPush();</span><br><span class="line">  &#125;</span><br><span class="line">  ~__AtAutoreleasePool() &#123;<span class="comment">// ææ„å‡½æ•°</span></span><br><span class="line">     objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">void</span> * atautoreleasepoolobj = objc_autoreleasePoolPush(); </span><br><span class="line">    <span class="comment">// do whatever you want</span></span><br><span class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ AutoreleasePool ç›¸å…³çš„ç±»ï¼Œè€Œåœ¨ objc æºç ä¸­æœ <code>objc_autoreleasePoolPush</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> AutoreleasePoolPage::push();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="keyword">void</span> *ctxt)</span> </span>&#123;</span><br><span class="line">  AutoreleasePoolPage::pop(ctxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="autoreleasepage-ç»“æ„"><a class="markdownIt-Anchor" href="#autoreleasepage-ç»“æ„"></a> AutoreleasePage ç»“æ„</h3><p><code>AutoreleasePage</code> æ˜¯å®ç° AutoreleasePool çš„ä¸»è¦ç±»</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span> &#123;</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">pthread_key_t</span> <span class="keyword">const</span> key = AUTORELEASE_POOL_KEY;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="keyword">const</span> SCRIBBLE = <span class="number">0xA3</span>;  <span class="comment">// 0xA3A3A3A3 after releasing</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> SIZE =</span><br><span class="line">#<span class="keyword">if</span> PROTECT_AUTORELEASEPOOL</span><br><span class="line">        PAGE_MAX_SIZE;  <span class="comment">// must be multiple of vm page size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        PAGE_MAX_SIZE;  <span class="comment">// size and alignment, power of 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> COUNT = SIZE / <span class="keyword">sizeof</span>(id);<span class="comment">//ä¸€ä¸ªpageé‡Œè¦ç®¡ç†é‡Šæ”¾å¯¹è±¡çš„ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EMPTY_POOL_PLACEHOLDER ((id*)1)    <span class="comment">// ç©ºæ± å ä½ </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POOL_BOUNDARY nil <span class="comment">// é‡Šæ”¾æ± è¾¹ç•Œ</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">magic_t</span> <span class="keyword">const</span> magic;  <span class="comment">// ç”¨æ¥æ ¡éªŒ AutoreleasePoolPage çš„ç»“æ„æ˜¯å¦å®Œæ•´</span></span><br><span class="line">  id *next;             <span class="comment">// å­˜å‚¨è¦ç”¨ AutoRelease é‡Šæ”¾çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘ begin()</span></span><br><span class="line">  <span class="keyword">pthread_t</span> <span class="keyword">const</span> thread; <span class="comment">// æ‰€å± thread</span></span><br><span class="line">  AutoreleasePoolPage * <span class="keyword">const</span> parent; <span class="comment">// æŒ‡å‘çˆ¶ç»“ç‚¹ï¼Œç¬¬ä¸€ä¸ªç»“ç‚¹çš„ parent å€¼ä¸º nil</span></span><br><span class="line">  AutoreleasePoolPage *child;         <span class="comment">// æŒ‡å‘å­ç»“ç‚¹ï¼Œæœ€åä¸€ä¸ªç»“ç‚¹çš„ child å€¼ä¸º nil</span></span><br><span class="line">  <span class="keyword">uint32_t</span> <span class="keyword">const</span> depth; <span class="comment">// ä»£è¡¨æ·±åº¦ï¼Œä» 0 å¼€å§‹ï¼Œå¾€åé€’å¢ 1</span></span><br><span class="line">  <span class="keyword">uint32_t</span> hiwat;       <span class="comment">// (high water mark)æ•°æ®å®¹çº³çš„ä¸€ä¸ªä¸Šé™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POOL_BOUNDARY æ˜¯ä¸€ä¸ªè¾¹ç•Œå¯¹è±¡ nil,ä¹‹å‰çš„æºä»£ç å˜é‡åæ˜¯ POOL_SENTINELå“¨å…µå¯¹è±¡,ç”¨æ¥åŒºåˆ«æ¯ä¸ªpageå³æ¯ä¸ª AutoreleasePoolPage è¾¹ç•Œ</p><h3 id="autoreleasepage-åŸç†åˆ†æ"><a class="markdownIt-Anchor" href="#autoreleasepage-åŸç†åˆ†æ"></a> AutoreleasePage åŸç†åˆ†æ</h3><p>ä»¥ä¸ŠçŸ¥é“ AutoreleasePage çš„ç»“æ„ï¼Œæ ¹æ®åˆ†æè¿‡ç¨‹ï¼Œæ€è€ƒä¸ºä½•å¦‚æ­¤è®¾è®¡</p><h4 id="pagepush"><a class="markdownIt-Anchor" href="#pagepush"></a> Page::push</h4><p>ä¸€å¼€å§‹è°ƒç”¨çš„å°±æ˜¯ <code>AutoreleasePage::push()</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  id *dest;</span><br><span class="line">  dest = autoreleaseFast(POOL_BOUNDARY); <span class="comment">// POOL_BOUNDARY æ˜¯ nilçš„å®å®šä¹‰</span></span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> id *<span class="title">autoreleaseFast</span><span class="params">(id obj)</span></span>&#123;</span><br><span class="line">  AutoreleasePoolPage *page = hotPage();</span><br><span class="line">  <span class="keyword">if</span> (page &amp;&amp; !page-&gt;full()) &#123;</span><br><span class="line">      <span class="keyword">return</span> page-&gt;add(obj);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">      <span class="keyword">return</span> autoreleaseFullPage(obj, page);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> autoreleaseNoPage(obj);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>autoreleaseFast</code> æ’å…¥æ–° oc å¯¹è±¡å…ƒç´ çš„æ—¶å€™åˆ†ä¸‰ç§æƒ…å†µéœ€è¦å¤„ç†ï¼š</p><ul><li>pageæœªæ»¡ï¼Œç›´æ¥æ’å…¥åˆ°å½“å‰page</li><li>pageå·²æ»¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°pageå¹¶æ’å…¥</li><li>pageä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°pageå¹¶æ’å…¥</li></ul><p>æœ€ç»ˆéƒ½ä¼šé€šè¿‡ <code>add</code> æ–¹æ³•æŠŠå½“å‰éœ€è¦èƒŒ AutoRelease çš„å¯¹è±¡æ”¾åˆ° page ä¸­ï¼Œnext++</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">id *<span class="title">add</span><span class="params">(id obj)</span></span>&#123;</span><br><span class="line">  assert(!full());</span><br><span class="line">  unprotect();</span><br><span class="line">  id *ret = next;</span><br><span class="line">  *next++ = obj;</span><br><span class="line">  protect();</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/runtime-autorelease-push.jpg" alt="push çš„è¿‡ç¨‹"></p><p>hotPage æ˜¯å½“å‰ä½¿ç”¨çš„é¡µ<br>å¯¹äºautoreleasePool å¤šå±‚åµŒå¥—é—®é¢˜ï¼Œæ¯ä¸€æ¬¡push é¦–å…ˆæ’å…¥ POOL_BOUNDARY ä½œä¸ºå“¨å…µï¼Œç„¶åæ¥ç€ hotPage ä¸­çš„ next æŒ‡é’ˆä¸€ä¸ªä¸ªæ·»åŠ å¯¹è±¡</p><h4 id="pagepopctxt"><a class="markdownIt-Anchor" href="#pagepopctxt"></a> Page::pop(ctxt)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">void</span> *token)</span> </span>&#123;</span><br><span class="line">  AutoreleasePoolPage *page;</span><br><span class="line">  id *<span class="built_in">stop</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (token == (<span class="keyword">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hotPage()) &#123;</span><br><span class="line">      pop(coldPage()-&gt;<span class="built_in">begin</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setHotPage(nil);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  page = pageForPointer(token);</span><br><span class="line">  <span class="built_in">stop</span> = (id *)token;</span><br><span class="line"></span><br><span class="line">  page-&gt;releaseUntil(<span class="built_in">stop</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// memory: delete empty children</span></span><br><span class="line">  <span class="keyword">if</span> (page-&gt;lessThanHalfFull()) &#123;</span><br><span class="line">     page-&gt;child-&gt;kill();</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child-&gt;child) &#123;</span><br><span class="line">     page-&gt;child-&gt;child-&gt;kill();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>token : popåˆ°å‚æ•°å…ƒç´ æ‰€åœ¨çš„åœ°å€,æ•´ä½“è¿‡ç¨‹</p><ol><li>åˆ¤æ–­æ˜¯ä¸æ˜¯EMPTY_POOL_PLACEHOLDERï¼ˆ<code>EMPTY_POOL_PLACEHOLDERæ˜¯å­˜å‚¨åœ¨TLSä¸­çš„ç”¨æ¥è¡¨ç¤ºé“¾è¡¨æœ€ä¸Šå±‚æ²¡æœ‰å…ƒç´ çš„pool,è¿™æ ·å°±ä¸ç”¨åˆ›å»ºpoolå¯ä»¥èŠ‚çº¦å†…å­˜ã€‚TLSæ˜¯ä»€ä¹ˆä»¥åŠå…·ä½“å®ç°è¿™ç¯‡[æ–‡ç« ](https://blog.csdn.net/cywosp/article/details/26469435)ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†</code>ï¼‰<ol><li>å¦‚æœå½“å‰ poolé‡Œé¢æœ‰æ•°æ®ï¼Œå°±æŠŠé‡Œé¢çš„æ•°æ®æ¸…ç©ºï¼›å¦è€…å°±æŠŠhotPageè®¾ç½®ä¸ºnilã€‚</li><li>æ¥ç€è°ƒç”¨page-&gt;releaseUntil(stop)ç»™æ­¤å‚æ•°ä¹‹å‰çš„æ‰€æœ‰å¯¹è±¡å‘é€releaseé‡Šæ”¾å†…å­˜ï¼Œå¯¹è±¡å†…å­˜é‡Šæ”¾ä¹‹åç»ˆç‚¹pageä¹‹å‰çš„pageéƒ½ä¼šå˜æˆç©ºçš„</li><li>æœ€åè°ƒç”¨page-&gt;child-&gt;kill()å›æ”¶è¿™äº›ç©ºpageèµ„æºã€‚</li></ol></li></ol><p><img src="/img/runtime-autorelease-pop.jpg" alt="pop çš„è¿‡ç¨‹"></p><h2 id="å¦‚ä½•ä½¿ç”¨-autoreleasepoolå‘¢"><a class="markdownIt-Anchor" href="#å¦‚ä½•ä½¿ç”¨-autoreleasepoolå‘¢"></a> å¦‚ä½•ä½¿ç”¨ AutoReleasePoolå‘¢</h2><p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a></p><ol><li>ä½¿ç”¨ Cocoa æ¡†æ¶ åˆ›å»ºçš„ thread éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„ autorelease pool. å¦‚æœä½ ç”¨å…¶ä»–æ–¹å¼è‡ªå·±åˆ›å»ºçš„ thread éœ€è¦æ·»åŠ  autorelease pool.</li><li>å¦‚æœä½ çš„ thread å¸¸é©»çš„ï¼Œä¼šäº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œé‚£å°±éœ€è¦ä½¿ç”¨ autorelease pool (like AppKit and UIKit do on the main thread)</li></ol><p>ä½¿ç”¨å®¹å™¨çš„blockç‰ˆæœ¬çš„æšä¸¾å™¨æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªAutoreleasePoolï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[array enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåœ¨æ™®é€šforå¾ªç¯å’Œfor inå¾ªç¯ä¸­æ²¡æœ‰ï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯æ–°ç‰ˆçš„blockç‰ˆæœ¬æšä¸¾å™¨æ›´åŠ æ–¹ä¾¿ã€‚forå¾ªç¯ä¸­éå†äº§ç”Ÿå¤§é‡autoreleaseå˜é‡æ—¶ï¼Œå°±éœ€è¦æ‰‹åŠ å±€éƒ¨AutoreleasePoolå’¯ã€‚</p><blockquote><p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener">é»‘å¹•èƒŒåçš„Autorelease</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> obj </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>swift åºåˆ—åŒ–Codable</title>
      <link href="/2018/05/10/swift%20%E8%AF%AD%E6%B3%95/swift-%E5%BA%8F%E5%88%97%E5%8C%96Codable/"/>
      <url>/2018/05/10/swift%20%E8%AF%AD%E6%B3%95/swift-%E5%BA%8F%E5%88%97%E5%8C%96Codable/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>åºåˆ—åŒ–æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯è½¬æ¢ä¸ºå¯ä»¥å­˜å‚¨æˆ–ä¼ è¾“çš„å½¢å¼çš„è¿‡ç¨‹(å¯¹è±¡&lt;â€“&gt;I/Oæµ)ã€‚<br>å¯¹è±¡ä¿¡æ¯åºåˆ—åŒ–ä»¥åå˜æˆ I/O æµï¼š</p><ol><li>å¯ä»¥æœ¬åœ°åŒ–å­˜å‚¨ï¼ˆæŒä¹…åŒ–å¯¹è±¡ï¼‰</li><li>ç½‘ç»œé€šè®¯ï¼ˆç½‘ç»œä¼ è¾“å¯¹è±¡ï¼‰</li><li>å®šåˆ¶åè®®ï¼Œè·¨å¹³å°ã€è·¨è¯­è¨€é€šè®¯</li></ol><h2 id="swift-ä¸­çš„åºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#swift-ä¸­çš„åºåˆ—åŒ–"></a> Swift ä¸­çš„åºåˆ—åŒ–</h2><ol><li>Swift 4.0 ä¹‹å‰ä»éœ€è¦æ‰‹åŠ¨è§£æ</li><li>Swift 4.0 ä»¥åï¼Œæä¾› Codable åè®®</li><li>ä»ç„¶å­˜åœ¨é—®é¢˜</li></ol><h3 id="æ²¡æœ‰encoderå’Œdecoder"><a class="markdownIt-Anchor" href="#æ²¡æœ‰encoderå’Œdecoder"></a> æ²¡æœ‰Encoderå’ŒDecoder</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> json: [<span class="type">String</span> : <span class="type">Any</span>] = [</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"cap"</span>,</span><br><span class="line">  <span class="string">"points"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"this is a cat"</span>,</span><br><span class="line">]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">  <span class="keyword">var</span> points: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> description: <span class="type">String?</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// éœ€è¦æ‰‹åŠ¨è§£æ</span></span><br><span class="line">  <span class="keyword">init</span>?(json: [<span class="type">String</span>: <span class="type">Any</span>]) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> name = json[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span>,</span><br><span class="line">      <span class="keyword">let</span> points = json[<span class="string">"points"</span>] <span class="keyword">as</span>? <span class="type">Int</span>,</span><br><span class="line">      <span class="keyword">let</span> description = json[<span class="string">"description"</span>] <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    <span class="keyword">self</span>.name = name</span><br><span class="line">    <span class="keyword">self</span>.points = points</span><br><span class="line">    <span class="keyword">self</span>.description = description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> p = <span class="type">Product</span>(json: json) &#123;</span><br><span class="line">  <span class="built_in">print</span>(p.name + <span class="string">" \(p.points) "</span> + p.description!)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç¼–ç å™¨ç±»å‹éµå¾ª-codableencodable-decodable-åè®®"><a class="markdownIt-Anchor" href="#ä½¿ç”¨ç¼–ç å™¨ç±»å‹éµå¾ª-codableencodable-decodable-åè®®"></a> ä½¿ç”¨ç¼–ç å™¨ï¼Œç±»å‹éµå¾ª Codable(Encodable &amp; Decodable) åè®®</h3><ol><li>ç±»å‹éµå¾ªCodable</li><li>Encode</li><li>Decode</li></ol><p>2017å¹´6æœˆå‘å¸ƒçš„ Swift4.0 ä¸­çš„ Codable(Encodable &amp; Decodable) åè®®ï¼Œè¡¨æ˜è¯¥åè®®å…·æœ‰è¢«åºåˆ—åŒ–å’Œ/æˆ–ååºåˆ—åŒ–çš„èƒ½â¼’ã€‚<br>Swift æ ‡å‡†åº“ä¸­çš„æ‰€æœ‰åŸºæœ¬ç±»å‹éƒ½éµå¾ª <code>Codable</code> åè®®ï¼Œ<code>Dataï¼ŒDateï¼Œ URLï¼ŒCGPoint å’Œ CGRect</code> åœ¨å†…çš„è®¸å¤š Apple æ¡†æ¶ä¸­çš„å¸¸â½¤æ•°æ®ç±»å‹ï¼Œä¹Ÿå·²ç»é€‚é…äº† Codableã€‚<br>è‡ªå®šä¹‰ç±»å‹éœ€è¦ç”¨æˆ·éµå¾ª Codableåè®®ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Codable</span> = <span class="type">Decodable</span> &amp; <span class="type">Encodable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// æŸä¸ªç±»å‹å¯ä»¥å°†â¾ƒèº«ç¼–ç ä¸ºâ¼€ç§å¤–éƒ¨è¡¨ç¤º</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Encodable</span> </span>&#123; <span class="comment">/// å°†å€¼ç¼–ç åˆ°ç»™å®šçš„ encoder ä¸­</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">encode</span><span class="params">(to encoder: Encoder)</span></span> <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// æŸä¸ªç±»å‹å¯ä»¥ä»å¤–éƒ¨è¡¨ç¤ºä¸­è§£ç å¾—åˆ°â¾ƒèº«</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Decodable</span> </span>&#123; <span class="comment">/// é€šè¿‡ä»ç»™å®šçš„ decoder ä¸­è§£ç æ¥åˆ›å»ºæ–°çš„å®ä¾‹</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(from decoder: <span class="type">Decoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â¼€æ—¦ä½ æ‹¥æœ‰ codable ç±»å‹çš„å€¼ï¼Œä½ å¯ä»¥åˆ›å»ºâ¼€ä¸ªç¼–ç å™¨ï¼Œå¹¶è®©å®ƒå°†è¿™ä¸ªå€¼è½¬æ¢åˆ°åƒæ˜¯ JSON è¿™æ ·çš„åºåˆ—åŒ–æ ¼å¼ã€‚åè¿‡æ¥ï¼Œâ¼€ä¸ªè§£ç å™¨å¯ä»¥å°†åºåˆ—åŒ–åçš„æ•°æ®è½¬å›ä¸ºå®ƒåŸæ¥ç±»å‹çš„â¼€ä¸ªå®ä¾‹ã€‚</p><p>Swift â¾ƒå¸¦ä¸¤å¥—ç¼–ç è§£ç å™¨ï¼Œ<code>JSONEncoder/JSONDecoder</code> å’Œ <code>PropertyListEncoder/PropertyListDecoder</code>ï¼Œå®ƒä»¬å­˜åœ¨äº Foundation ä¸­ã€‚</p><h2 id="jsonencoderjsondecoder"><a class="markdownIt-Anchor" href="#jsonencoderjsondecoder"></a> JSONEncoder/JSONDecoder</h2><h3 id="ä¸éœ€è¦æ‰‹åŠ¨è§£ç "><a class="markdownIt-Anchor" href="#ä¸éœ€è¦æ‰‹åŠ¨è§£ç "></a> ä¸éœ€è¦æ‰‹åŠ¨è§£ç </h3><p>å±æ€§å = keyï¼Œå±æ€§ç±»å‹ = value ç±»å‹ä¸€è‡´ï¼Œä½¿ç”¨ decoder å¯¹jsonè§£ç ï¼Œä¸éœ€è¦æ‰‹åŠ¨è§£ç äº†</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> json = <span class="string">"""</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "name": "Banana",</span></span><br><span class="line"><span class="string">        "points": 200,</span></span><br><span class="line"><span class="string">        "description": "A banana grown in Ecuador."</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "name": "Orange",</span></span><br><span class="line"><span class="string">        "points": 100</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">"""</span>.data(using: .utf8)!</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GroceryProduct</span>: <span class="title">Codable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">  <span class="keyword">var</span> points: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> description: <span class="type">String?</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£ç </span></span><br><span class="line"><span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</span><br><span class="line"><span class="keyword">let</span> products = <span class="keyword">try</span> decoder.decode([<span class="type">GroceryProduct</span>].<span class="keyword">self</span>, from: json)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"The following products are available:"</span>)</span><br><span class="line"><span class="keyword">for</span> product <span class="keyword">in</span> products &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"\t\(product.name) (\(product.points) points)"</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> description = product.description &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\t\t\(description)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ä¸Šæ–‡æ— å…³ï¼Œåªæè¿°ä¸‹ç¼–ç è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">let</span> jsonEncoder = <span class="type">JSONEncoder</span>()</span><br><span class="line"><span class="keyword">let</span> jsonData = <span class="keyword">try</span>? jsonEncoder.encode(products)</span><br><span class="line"><span class="keyword">let</span> str = <span class="type">String</span>(decoding: jsonData!, <span class="keyword">as</span>: <span class="type">UTF8</span>.<span class="keyword">self</span>)</span><br><span class="line"><span class="built_in">print</span>(str)</span><br><span class="line"><span class="keyword">let</span> jsonObject = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.jsonObject(with: jsonData!, options: .allowFragments)</span><br><span class="line"><span class="built_in">print</span>(jsonObject)</span><br></pre></td></tr></table></figure><p>GroceryProduct ç±»ä¸­å±æ€§éƒ½éµå¾ª <code>Codable</code> åè®®ï¼ŒArrayä¹Ÿæ˜¯ï¼Œæ‰€ä»¥ä¸éœ€è¦å®ç° <code>encode(to encoder: Encoder)</code> å’Œ <code>init(from decoder: Decoder)</code> æ–¹æ³•</p><h3 id="éœ€è¦æ‰‹åŠ¨è§£ç "><a class="markdownIt-Anchor" href="#éœ€è¦æ‰‹åŠ¨è§£ç "></a> éœ€è¦æ‰‹åŠ¨è§£ç </h3><h4 id="jsonä¸­çš„keyå€¼ä¸å±æ€§åç§°ä¸ä¸€è‡´"><a class="markdownIt-Anchor" href="#jsonä¸­çš„keyå€¼ä¸å±æ€§åç§°ä¸ä¸€è‡´"></a> jsonä¸­çš„keyå€¼ä¸å±æ€§åç§°ä¸ä¸€è‡´</h4><p>ä½†æ˜¯è¿™ä¸ªç±»å‹å®é™…ä¸Šå¹¶ä¸â¼€å®šéœ€è¦æ˜¯æš ä¸¾)ã€‚æä¾›â¾ƒå®šä¹‰çš„ç¼–ç é”®æ˜¯â¼€ç§å¾ˆç®€å•ï¼Œâ½½ä¸”æ˜¯å£°æ˜å¼çš„æ”¹å˜ç±»å‹ç¼–ç çš„â½…å¼ã€‚åœ¨æšä¸¾ä¸­ï¼Œæˆ‘ ä»¬å¯ä»¥ï¼š</p><p>â†’ ä½¿â½¤æ˜ç¡®ç»™å®šçš„å­—ç¬¦ä¸²å€¼ï¼Œåœ¨ç¼–ç åçš„è¾“å‡ºä¸­é‡å‘½åå­—æ®µï¼Œæˆ–è€…</p><p>â†’ å°†æŸä¸ªé”®ä»æšä¸¾ä¸­ç§»é™¤ï¼Œä»¥æ­¤å®Œå…¨è·³è¿‡å­—æ®µã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> json = <span class="string">"""</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "product_name": "Bananas",</span></span><br><span class="line"><span class="string">        "product_cost": 200,</span></span><br><span class="line"><span class="string">        "description": "A banana grown in Ecuador."</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "product_name": "Oranges",</span></span><br><span class="line"><span class="string">        "product_cost": 100,</span></span><br><span class="line"><span class="string">        "description": "A juicy orange."</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">"""</span>.data(using: .utf8)!</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GroceryProduct</span>: <span class="title">Codable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">  <span class="keyword">var</span> points: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> description: <span class="type">String?</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">enum</span> <span class="title">CodingKeys</span>: <span class="title">String</span>, <span class="title">CodingKey</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> name = <span class="string">"product_name"</span></span><br><span class="line">    <span class="keyword">case</span> points = <span class="string">"product_cost"</span></span><br><span class="line">    <span class="keyword">case</span> description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</span><br><span class="line"><span class="keyword">let</span> products = <span class="keyword">try</span> decoder.decode([<span class="type">GroceryProduct</span>].<span class="keyword">self</span>, from: json)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"The following products are available:"</span>)</span><br><span class="line"><span class="keyword">for</span> product <span class="keyword">in</span> products &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"\t\(product.name) (\(product.points) points)"</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> description = product.description &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\t\t\(description)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç±»å‹åµŒå¥—"><a class="markdownIt-Anchor" href="#ç±»å‹åµŒå¥—"></a> ç±»å‹åµŒå¥—</h3><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> å¼€å‘è¯­è¨€ </category>
          
          <category> swift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Texture å¸ƒå±€</title>
      <link href="/2018/04/11/Texture-%E5%B8%83%E5%B1%80/"/>
      <url>/2018/04/11/Texture-%E5%B8%83%E5%B1%80/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="texture-ç›®æ ‡ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#texture-ç›®æ ‡ä¼˜ç‚¹"></a> Texture ç›®æ ‡&amp;ä¼˜ç‚¹</h2><p>Texture çš„ Layout APIæ˜¯ UIKit AutoLayout çš„é«˜æ•ˆæ›¿ä»£å“</p><ul><li>Fastï¼šè‡ªåŠ¨å¸ƒå±€æ¯” AutoLayout å¿«çš„å¤š</li><li>Asynchronous &amp; Concurrent: Layout åœ¨åå°è®¡ç®—ï¼Œæ‰€ä»¥ç”¨æˆ·äº¤äº’ä¸ä¼šè¢«ç»ˆç«¯</li><li>Declarativeï¼šå¸ƒå±€ç”¨ä¸å¯å˜çš„æ•°æ®ç»“æ„å£°æ˜ã€‚è¿™ä½¿å¸ƒå±€ä»£ç æ›´æ˜“äºå¼€å‘ï¼Œæ–‡æ¡£ç¼–åˆ¶ï¼Œä»£ç å®¡æŸ¥ï¼Œæµ‹è¯•ï¼Œè°ƒè¯•ï¼Œé…ç½®æ–‡ä»¶å’Œç»´æŠ¤ã€‚</li><li>Cacheableï¼šå¸ƒå±€ç»“æœæ˜¯ä¸å¯å˜çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤å¯ä»¥åœ¨åå°å¯¹å…¶è¿›è¡Œé¢„å…ˆè®¡ç®—å¹¶è¿›è¡Œç¼“å­˜ä»¥æé«˜ç”¨æˆ·çš„æ„ŸçŸ¥æ€§èƒ½ã€‚</li><li>Extensibleï¼šæ˜“äºåœ¨ç±»ä¹‹é—´å…±äº«ä»£ç ã€‚</li></ul><p>å— CSS Flexbox æ¨¡å‹å¯å‘<a href="https://changzw.github.io/2017/12/09/flexbox-model/">flexbox model</a></p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#åŸºæœ¬æ¦‚å¿µ"></a> åŸºæœ¬æ¦‚å¿µ</h2><p>Texture å¸ƒå±€ç³»ç»Ÿçš„ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p><ol><li>Layout Specs</li><li>Layout Elements</li></ol><h3 id="layout-specs"><a class="markdownIt-Anchor" href="#layout-specs"></a> Layout Specs</h3><p>class <code>ASLayoutSpec</code><br>å¸ƒå±€è§„èŒƒï¼ˆlayout specificationï¼‰é€šè¿‡äº†è§£è¿™äº›å­å¸ƒå±€å…ƒç´ ä¹‹é—´çš„ç›¸äº’å…³ç³»å¸ƒå±€å…ƒç´ ï¼Œæ˜¯å¸ƒå±€å…ƒç´ çš„å®¹å™¨ã€‚</p><h3 id="layout-elements"><a class="markdownIt-Anchor" href="#layout-elements"></a> Layout Elements</h3><p>protocol <code>&lt;ASLayoutElement&gt;</code><br>Layout Specs åŒ…å«å¹¶æ’åˆ— Layout Elements<br>æ‰€æœ‰ <code>ASDisplayNodes</code> &amp; <code>ASLayoutSpecs</code> éƒ½éµå¾ª<aslayoutelement>åè®®</aslayoutelement></p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-----------------------ASStackLayoutSpec----------------------</span><br><span class="line">|  -----ASStackLayoutSpec-----  -----ASStackLayoutSpec-----  |</span><br><span class="line">|  |       ASImageNode       |  |       ASImageNode       |  |</span><br><span class="line">|  |       ASImageNode       |  |       ASImageNode       |  |</span><br><span class="line">|  ---------------------------  ---------------------------  |</span><br><span class="line">--------------------------------------------------------------</span><br></pre></td></tr></table></figure><h2 id="layout-specs-å­ç±»"><a class="markdownIt-Anchor" href="#layout-specs-å­ç±»"></a> Layout Specs å­ç±»</h2><ul><li>ASWrapperLayoutSpec</li><li>ASStackLayoutSpec</li><li>ASInsetLayoutSpec</li><li>ASOverlayLayoutSpec</li><li>ASBackgroundLayoutSpec</li><li>ASCenterLayoutSpec</li><li>ASRatioLayoutSpec</li><li>ASRelativeLayoutSpec</li><li>ASAbsoluteLayoutSpec</li><li>ASCornerLayoutSpec</li></ul><h3 id="aswrapperlayoutspec"><a class="markdownIt-Anchor" href="#aswrapperlayoutspec"></a> ASWrapperLayoutSpec</h3><p>å®ƒå¯ä»¥åŒ…è£¹ä¸€ä¸ª <code>ASLayoutElement</code> ï¼Œé€šè¿‡è¿™ä¸ª element çš„siez set è®¡ç®—è¿™ä¸ª element çš„layoutã€‚</p><p>ç”¨äºï¼š<br><code>ASWrapperLayoutSpec</code> å¯¹äºåœ¨ <code>-layoutSpecThatFits:</code> ä¸­åŒ…è£¹å•ä¸ª nodeï¼Œè¿”å›spec.</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// return a single subnode from layoutSpecThatFits:</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">ASWrapperLayoutSpec</span>(layoutElement: _subnode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set a size (but not position)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  _subnode.style.preferredSize = <span class="type">CGSize</span>(width: constrainedSize.<span class="built_in">max</span>.width,</span><br><span class="line">                                        height: constrainedSize.<span class="built_in">max</span>.height / <span class="number">2.0</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="type">ASWrapperLayoutSpec</span>(layoutElement: _subnode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asinsetlayoutspec"><a class="markdownIt-Anchor" href="#asinsetlayoutspec"></a> ASInsetLayoutSpec</h3><p>ç»™ element æ·»åŠ  inset marginã€‚element å¿…é¡»æœ‰ instrinsic size or æ˜¾ç¤ºè®¾ç½®çš„size</p><div align="left"><img src="/img/texture-insetlayout.jpeg" alt="runloop" style="width:150px;height:96px"></div><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">let</span> insets = <span class="type">UIEdgeInsets</span>(top: <span class="number">10.0</span>, <span class="keyword">left</span>: <span class="number">10.0</span>, bottom: <span class="number">10.0</span>, <span class="keyword">right</span>: <span class="number">10.0</span>)</span><br><span class="line">  <span class="keyword">let</span> headerWithInset = <span class="type">ASInsetLayoutSpec</span>(insets: insets, child: textNode)</span><br><span class="line">  <span class="keyword">return</span> headerWithInset</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asoverlaylayoutspec"><a class="markdownIt-Anchor" href="#asoverlaylayoutspec"></a> ASOverlayLayoutSpec</h3><p>é‡å å¸ƒå±€è§„èŒƒå°ºå¯¸æ˜¯æ ¹æ® element çš„å°ºå¯¸è®¡ç®—å¾—å‡ºçš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œelement æ˜¯è“è‰²å±‚<br>é‡å å¸ƒå±€è§„èŒƒå°ºå¯¸æ˜¯æ ¹æ®åŒ…è£¹ element çš„å°ºå¯¸è®¡ç®—å‡ºæ¥çš„ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œå­å…ƒç´ æ˜¯è“è‰²å›¾å±‚ã€‚è“è‰² element ä¼šæŠŠä»–çš„ size ä½œä¸º <code>constrainedSize</code> ä¼ ç»™é‡å å¸ƒå±€å…ƒç´ ï¼ˆçº¢è‰²å›¾å±‚ï¼‰ã€‚æ‰€ä»¥ element ï¼ˆè“è‰²layerï¼‰å¿…é¡»è¦æœ‰è‡ªå·±çš„ intrinsic size æˆ–è€… å·²ç»è®¾ç½® sizeäº†ã€‚</p><div align="left"><img src="/img/texture-OverlayLayout.jpeg" alt="OverlayLayout" style="width:150px;height:96px"></div><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> backgroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.blue)</span><br><span class="line">  <span class="keyword">let</span> foregroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.red)</span><br><span class="line">  <span class="keyword">return</span> <span class="type">ASOverlayLayoutSpec</span>(child: backgroundNode, overlay: foregroundNode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asbackgroundlayoutspec"><a class="markdownIt-Anchor" href="#asbackgroundlayoutspec"></a> ASBackgroundLayoutSpec</h3><p>ASBackgroundLayoutSpec å¸ƒå±€ä¸€ä¸ªç»„ä»¶ï¼ˆè“è‰²ï¼‰ï¼Œå¹¶æ‹‰ä¼¸å…¶åçš„å¦ä¸€ä¸ªç»„ä»¶ä½œä¸ºèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰ã€‚</p><p>background è§„èŒƒ sizeæ ¹æ® child çš„å°ºå¯¸è®¡ç®—ã€‚ä¸‹å›¾ä¸­ï¼Œè“è‰²æ˜¯childã€‚å°† blue child çš„size å½“åš <code>constrainedSize</code> ä¼ ç»™ background layout element (red layer). so child(blue layer) ä¸€å®šè¦æœ‰è‡ªå·±çš„intrinsic size æˆ–è€… å·²ç»è®¾ç½® sizeäº†ã€‚</p><div align="left"><img src="/img/Texture-BackgroundLayout.jpeg" alt="Texture-BackgroundLayout" style="width:150px;height:110px"></div><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> backgroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.red)</span><br><span class="line">  <span class="keyword">let</span> foregroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.blue)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="type">ASBackgroundLayoutSpec</span>(child: foregroundNode, background: backgroundNode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ascenterlayoutspec"><a class="markdownIt-Anchor" href="#ascenterlayoutspec"></a> ASCenterLayoutSpec</h3><p>ASCenterLayoutSpec åœ¨æœ€å¤§ <code>constrainedSize</code> å°†æ”¾åœ¨ child ä¸­å¿ƒä½ç½®ã€‚<br>å¦‚æœcenter specâ€™s width å’Œ height æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆ ASCenterLayoutSpec ç¼©åˆ° child çš„sizeå¤§å°ã€‚</p><p><code>ASCenterLayoutSpec</code> ä¸¤ä¸ªå±æ€§:</p><ul><li>centeringOptions. ç¡®å®š child å¦‚ä½•åœ¨ä¸­å¿ƒè§„æ ¼å†…å±…ä¸­ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šNone, X, Y, XY.</li><li>sizingOptions. ç¡®å®šä¸­å¿ƒè§„æ ¼å°†å ç”¨å¤šå°‘ç©ºé—´ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šDefault, minimum X, minimum Y, minimum XY.</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> subnode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.green, <span class="type">CGSize</span>(width: <span class="number">60.0</span>, height: <span class="number">100.0</span>))</span><br><span class="line">  <span class="keyword">let</span> centerSpec = <span class="type">ASCenterLayoutSpec</span>(centeringOptions: .<span class="type">XY</span>, sizingOptions: [], child: subnode)</span><br><span class="line">  <span class="keyword">return</span> centerSpec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asratiolayoutspec"><a class="markdownIt-Anchor" href="#asratiolayoutspec"></a> ASRatioLayoutSpec</h3><p>ASRatioLayoutSpec ä½¿ç”¨å›ºå®šå®½é«˜æ¯”æ¥å¸ƒå±€ç»„ä»¶ã€‚ASRatioLayoutSpec ä»–çš„ <code>constrainedSize</code> å¿…é¡»è¦é…ç½® width or heightã€‚è¿™æ ·æ‰èƒ½å¤Ÿä½¿ç”¨ scale</p><p>ASRatioLayoutSpec ç»å¸¸ç”¨äºé‚£äº›æ²¡æœ‰ intrinsic size çš„nodeï¼ˆASNetworkImageNode or ASVideoNodeï¼‰ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="comment">// Half Ratio</span></span><br><span class="line">  <span class="keyword">let</span> subnode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.green, <span class="type">CGSize</span>(width: <span class="number">100</span>, height: <span class="number">100.0</span>))</span><br><span class="line">  <span class="keyword">let</span> ratioSpec = <span class="type">ASRatioLayoutSpec</span>(ratio: <span class="number">0.5</span>, child: subnode)</span><br><span class="line">  <span class="keyword">return</span> ratioSpec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asrelativelayoutspec"><a class="markdownIt-Anchor" href="#asrelativelayoutspec"></a> ASRelativeLayoutSpec</h3><p>å¹¶æ ¹æ®å‚ç›´å’Œæ°´å¹³ä½ç½®è¯´æ˜ç¬¦å¯¹ç»„ä»¶è¿›è¡Œå¸ƒå±€.<br>ä¸â€œ 9éƒ¨åˆ†â€å›¾åƒåŒºåŸŸç›¸ä¼¼ï¼Œå¯ä»¥å°†å­©å­æ”¾ç½®åœ¨4ä¸ªè§’çš„ä»»æ„ä¸€ä¸ªæˆ–4ä¸ªè¾¹ç¼˜ä¸­çš„ä»»æ„ä¸€ä¸ªçš„ä¸­é—´ä»¥åŠä¸­å¿ƒã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">let</span> backgroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.blue)</span><br><span class="line">  <span class="keyword">let</span> foregroundNode = <span class="type">ASDisplayNodeWithBackgroundColor</span>(<span class="type">UIColor</span>.red, <span class="type">CGSize</span>(width: <span class="number">70.0</span>, height: <span class="number">100.0</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> relativeSpec = <span class="type">ASRelativeLayoutSpec</span>(horizontalPosition: .start,</span><br><span class="line">                                          verticalPosition: .start,</span><br><span class="line">                                          sizingOption: [],</span><br><span class="line">                                          child: foregroundNode)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> backgroundSpec = <span class="type">ASBackgroundLayoutSpec</span>(child: relativeSpec, background: backgroundNode)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asabsolutelayoutspec"><a class="markdownIt-Anchor" href="#asabsolutelayoutspec"></a> ASAbsoluteLayoutSpec</h3><p>é€šè¿‡è®¾ç½®å…¶å­èŠ‚ç‚¹çš„layoutPositionå±æ€§æ¥æŒ‡å®šå…¶å­èŠ‚ç‚¹çš„ç¡®åˆ‡ä½ç½®ï¼ˆx / yåæ ‡ï¼‰ã€‚<br>ç»å¯¹å¸ƒå±€æ¯”å…¶ä»–ç±»å‹çš„å¸ƒå±€æ›´ä¸çµæ´»ä¸”éš¾ä»¥ç»´æŠ¤ã€‚</p><p>å”¯ä¸€å±æ€§sizing: ç¡®å®š ASAbsoluteLayoutSpec å ç”¨å¤šå°‘ç©ºé—´ã€‚é€‰é¡¹åŒ…æ‹¬ï¼šDefault å’Œ Size to Fitã€‚è¯·æ³¨æ„ï¼ŒSize to Fit é€‰é¡¹å°†å¤åˆ¶æ—§çš„ASStaticLayoutSpecçš„è¡Œä¸º</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> maxConstrainedSize = constrainedSize.<span class="built_in">max</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Layout all nodes absolute in a static layout spec</span></span><br><span class="line">  guitarVideoNode.style.layoutPosition = <span class="type">CGPoint</span>.zero</span><br><span class="line">  guitarVideoNode.style.preferredSize = <span class="type">CGSize</span>(width: maxConstrainedSize.width, height: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line">  nicCageVideoNode.style.layoutPosition = <span class="type">CGPoint</span>(x: maxConstrainedSize.width / <span class="number">2.0</span>, y: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line">  nicCageVideoNode.style.preferredSize = <span class="type">CGSize</span>(width: maxConstrainedSize.width / <span class="number">2.0</span>, height: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line">  simonVideoNode.style.layoutPosition = <span class="type">CGPoint</span>(x: <span class="number">0.0</span>, y: maxConstrainedSize.height - (maxConstrainedSize.height / <span class="number">3.0</span>))</span><br><span class="line">  simonVideoNode.style.preferredSize = <span class="type">CGSize</span>(width: maxConstrainedSize.width / <span class="number">2.0</span>, height: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line">  hlsVideoNode.style.layoutPosition = <span class="type">CGPoint</span>(x: <span class="number">0.0</span>, y: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line">  hlsVideoNode.style.preferredSize = <span class="type">CGSize</span>(width: maxConstrainedSize.width / <span class="number">2.0</span>, height: maxConstrainedSize.height / <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="type">ASAbsoluteLayoutSpec</span>(children: [guitarVideoNode, nicCageVideoNode, simonVideoNode, hlsVideoNode])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ascornerlayoutspec"><a class="markdownIt-Anchor" href="#ascornerlayoutspec"></a> ASCornerLayoutSpec</h3><p>ASCornerLayoutSpec æä¾›ä¸€ä¸ªç®€å•æ–¹æ³•ï¼ŒæŠŠ element æ”¾åœ¨è§’è½ã€‚</p><div align="left"><img src="/img/texture-CornerLayout.jpeg" alt="Texture-BackgroundLayout" style="width:80px;height:80px"></div><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Layout the center of badge to the top right corner of avatar.</span></span><br><span class="line">  <span class="keyword">let</span> cornerSpec = <span class="type">ASCornerLayoutSpec</span>(child: avatarNode, corner: badgeNode, location: .topRight)</span><br><span class="line">  <span class="comment">// Slightly shift center of badge inside of avatar.</span></span><br><span class="line">  cornerSpec.offset = <span class="type">CGPoint</span>(x: -<span class="number">3</span>, y: <span class="number">3</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="aslayoutspec"><a class="markdownIt-Anchor" href="#aslayoutspec"></a> ASLayoutSpec</h3><ol><li>æ‰€æœ‰ layout spec éƒ½ç»§æ‰¿è‡ªå®ƒ</li><li>ä¸»è¦ä»»åŠ¡ï¼šå¤„ç† children å¸ƒå±€ç®¡ç†ï¼Œç”¨æˆ·å¯ä»¥ å­ç±»åŒ–å®ƒå®ç°è‡ªå·±è‡ªå®šä¹‰ layout specã€‚</li><li>ä½œä¸ºé—´éš”åŒºï¼šå……å½“ <code>ASStackLayoutSpec</code> çš„spacerï¼Œå½“ä½¿ç”¨ <code>.flexGrow</code> and/or <code>.flexShrink</code> æ—¶å€™</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">let</span> spacer = <span class="type">ASLayoutSpec</span>()</span><br><span class="line">  spacer.style.flexGrow = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">  stack.children = [imageNode, spacer, textNode]</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="asstacklayoutspecflexbox-container"><a class="markdownIt-Anchor" href="#asstacklayoutspecflexbox-container"></a> ASStackLayoutSpec(Flexbox Container)</h3><p>ç›¸å…³å±æ€§å¯¹ç…§<a href="https://changzw.github.io/2017/12/09/flexbox-model/">flexbox-model</a></p><p>æœ‰ 7 ä¸ªå±æ€§ï¼š</p><ul><li>direction. ç¡®å®š stack æ–¹å‘ã€‚å¦‚æœå·²ç»è®¾ç½®äº† horizontalAlignment and verticalAlignment, ä»–ä»¬ä¼šè¢«é‡æ–°è§£æä¸€éã€‚å¯¼è‡´ justifyContent and alignItemsä¹Ÿä¼šç›¸åº”çš„å˜åŒ–ã€‚</li><li>spacing. æ¯ä¸ª child element ä¹‹é—´çš„è·ç¦».</li><li>horizontalAlignment. æŒ‡å®š children æ˜¯å¦‚ä½•æ°´å¹³å¯¹é½çš„ã€‚æ ¹æ®stack directionæ–¹å‘ã€‚è®¾ç½®å¯¹é½æ–¹å¼ ä¼šå¯¼è‡´ justifyContent or alignItems æ›´æ–°ã€‚</li><li>verticalAlignment. æŒ‡å®š children æ˜¯å¦‚ä½•å‚ç›´å¯¹é½çš„ã€‚æ ¹æ®stack directionæ–¹å‘ã€‚è®¾ç½®å¯¹é½æ–¹å¼ ä¼šå¯¼è‡´ justifyContent or alignItems æ›´æ–°ã€‚</li><li>justifyContent. æ²¿ä¸»è½´çš„å¯¹é½æ–¹å¼.</li><li>alignItems. æ²¿äº¤å‰è½´çš„æ–¹å‘å¸ƒå±€.</li><li>flexWrap. element å †å æˆå•è¡Œè¿˜æ˜¯å¤šè¡Œã€‚é»˜è®¤ä¸ºå•è¡Œã€‚</li><li>alignContent. å…ƒç´ ç»„æˆæœ‰å¤šè¡Œï¼Œcross-axisæ–¹å‘ç©ºé—´å……è¶³ï¼Œå†…å®¹è¡Œçš„å¯¹é½æ–¹å¼ã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> mainStack = <span class="type">ASStackLayoutSpec</span>(direction: .horizontal,</span><br><span class="line">                                    spacing: <span class="number">6.0</span>,</span><br><span class="line">                                    justifyContent: .start,</span><br><span class="line">                                    alignItems: .center,</span><br><span class="line">                                    children: [titleNode, subtitleNode])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set some constrained size to the stack</span></span><br><span class="line">  mainStack.style.minWidth = <span class="type">ASDimensionMakeWithPoints</span>(<span class="number">60.0</span>)</span><br><span class="line">  mainStack.style.maxHeight = <span class="type">ASDimensionMakeWithPoints</span>(<span class="number">40.0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mainStack</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="layout-element-å±æ€§"><a class="markdownIt-Anchor" href="#layout-element-å±æ€§"></a> Layout Element å±æ€§</h2><ul><li>ASStackLayoutElement Propertiesï¼šåªä¼šåœ¨ StackLayoutSpec ä¸­çš„å…ƒç´ (node or layout spec)ç”Ÿæ•ˆ</li><li>ASAbsoluteLayoutElement Propertiesï¼šåªä¼šåœ¨AbsoluateLayoutSpecä¸­çš„å…ƒç´ ï¼ˆ subnode æˆ– layoutSpecï¼‰ç”Ÿæ•ˆï¼›</li><li>ASLayoutElement Propertiesï¼šé€‚ç”¨äºæ‰€æœ‰ Node å’Œ layoutSpecï¼›</li></ul><h3 id="asstacklayoutelementflex-itemå±æ€§"><a class="markdownIt-Anchor" href="#asstacklayoutelementflex-itemå±æ€§"></a> ASStackLayoutElement(flex-item)å±æ€§</h3><p>ç›¸å…³å±æ€§å¯¹ç…§<a href="https://changzw.github.io/2017/12/09/flexbox-model/">flexbox-model</a></p><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>.style.spacingBefore</td><td>CGFloat</td><td>direction ä¸Šä¸å‰ä¸€ä¸ª node çš„é—´éš”</td></tr><tr><td>.style.spacingAfter</td><td>CGFloat</td><td>direction ä¸Šä¸åä¸€ä¸ª node çš„é—´éš”</td></tr><tr><td>.style.flexGrow</td><td>Bool</td><td>å­èŠ‚ç‚¹å°ºå¯¸æ€»å’Œå°äº minimumå³å­˜åœ¨å‰©ä½™ç©ºé—´æ—¶ï¼Œæ˜¯å¦æ”¾å¤§</td></tr><tr><td>.style.flexShrink</td><td>Bool</td><td>å­èŠ‚ç‚¹æ€»å’Œå¤§äº maximumï¼Œå³ç©ºé—´ä¸è¶³æ—¶ï¼Œæ˜¯å¦ç¼©å°</td></tr><tr><td>.style.flexBasis</td><td>ASDimension</td><td>åœ¨ä½¿ç”¨flexGrow æˆ– flexShrink å±æ€§ä¹‹å‰ï¼Œå¹¶ä¸”å‰©ä½™ç©ºé—´è¢«å‡åˆ†ä¹‹å‰ï¼ŒæŒ‡å®šitemçš„åˆå§‹size</td></tr><tr><td>.style.alignSelf</td><td>ASStackLayoutAlignSelf</td><td>item åœ¨cross-axisæ–¹å‘å¸ƒå±€æ–¹å¼ï¼Œæ­¤å±æ€§ä¼šè¦†ç›– layoutSpec(flex-container) å±æ€§alignItemsï¼Œå¯é€‰å€¼æœ‰ï¼šAutoã€Startã€Endã€Centerã€Stretch</td></tr><tr><td>.style.ascender</td><td>CGFloat</td><td>ç”¨äºåŸºçº¿å¯¹é½ï¼Œæè¿°å¯¹è±¡ä»é¡¶éƒ¨åˆ°å…¶åŸºçº¿çš„è·ç¦»</td></tr><tr><td>.style.descender</td><td>CGFloat</td><td>ç”¨äºåŸºçº¿å¯¹é½ï¼Œæè¿°å¯¹è±¡ä»åŸºçº¿åˆ°å…¶åº•éƒ¨çš„è·ç¦»</td></tr></tbody></table><h3 id="asabsolutelayoutelement-å±æ€§"><a class="markdownIt-Anchor" href="#asabsolutelayoutelement-å±æ€§"></a> ASAbsoluteLayoutElement å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>.style.layoutPosition</td><td>CGPoint</td><td>è¯¥å¯¹è±¡åœ¨ ASAbsoluteLayoutSpec ä¸­çš„ä½ç½®</td></tr></tbody></table><h3 id="aslayoutelement-å±æ€§"><a class="markdownIt-Anchor" href="#aslayoutelement-å±æ€§"></a> ASLayoutElement å±æ€§</h3><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>.style.width</td><td>ASDimension</td><td>æŒ‡å®š ASLayoutElement å†…å®¹åŒºåŸŸçš„å®½åº¦ã€‚minWidth å’Œ maxWidth å±æ€§ä¼šè¦†ç›– widthï¼Œé»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.height</td><td>ASDimension</td><td>æŒ‡å®šASLayoutElement å†…å®¹åŒºåŸŸçš„é«˜åº¦ã€‚minHeight å’Œ maxHeight å±æ€§ä¼šè¦†ç›– heightï¼Œé»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.minWidth</td><td>ASDimension</td><td>minWidth å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å°å®½åº¦.å®ƒå¯ä»¥é˜²æ­¢ width å±æ€§å€¼å°äº minWidth æŒ‡å®šçš„å€¼ï¼ŒminWidth çš„å€¼ä¼šè¦†ç›– maxWidth å’Œ width. é»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.maxWidth</td><td>ASDimension</td><td>maxWidth å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å¤§å®½åº¦.å®ƒå¯ä»¥é˜²æ­¢ width å±æ€§å€¼å¤§äº maxWidth æŒ‡å®šçš„å€¼. maxWidth çš„å€¼ä¼šè¦†ç›– widthï¼ŒminWidth ä¼šè¦†ç›– maxWidth. é»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.minHeight</td><td>ASDimension</td><td>minHeight å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å°é«˜åº¦.å®ƒå¯ä»¥é˜²æ­¢ height å±æ€§å€¼å°äº minHeight æŒ‡å®šçš„å€¼.minHeight çš„å€¼ä¼šè¦†ç›– maxHeight å’Œ height. é»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.maxHeight</td><td>ASDimension</td><td>maxHeight å±æ€§ç”¨äºè®¾ç½®ä¸€ä¸ªç‰¹å®šå¸ƒå±€å…ƒç´ çš„æœ€å¤§é«˜åº¦ï¼Œå®ƒå¯ä»¥é˜²æ­¢ height å±æ€§å€¼å¤§äº maxHeight æŒ‡å®šçš„å€¼.maxHeight çš„å€¼ä¼šè¦†ç›– heightï¼ŒminHeight ä¼šè¦†ç›– maxHeight.é»˜è®¤å€¼ä¸º ASDimensionAuto</td></tr><tr><td>.style.preferredSize</td><td>CGSize</td><td>æä¾›å¸ƒå±€å…ƒç´ çš„å»ºè®® size.å¦‚æœæä¾›äº† minSize æˆ– maxSizeï¼Œå¹¶ä¸” preferredSize è¶…è¿‡äº†è¿™äº›å€¼ï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨ minSize æˆ– maxSize.å¦‚æœæœªæä¾› preferredSizeï¼Œåˆ™å¸ƒå±€å…ƒç´ çš„ size é»˜è®¤ä¸º calculateSizeThatFits: æ–¹æ³•æä¾›çš„å›ºæœ‰å¤§å°.æ­¤æ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯å¯¹äºæ²¡æœ‰å›ºæœ‰å¤§å°æˆ–éœ€è¦ç”¨ä¸å›ºæœ‰å¤§å°ä¸åŒçš„çš„ size è¿›è¡Œå¸ƒå±€çš„èŠ‚ç‚¹ï¼Œåˆ™å¿…é¡»æŒ‡å®š preferredSize æˆ– preferredLayoutSize ä¸­çš„ä¸€ä¸ªï¼Œæ¯”å¦‚æ²¡è¿™ä¸ªå±æ€§å¯ä»¥åœ¨ ASImageNode ä¸Šè®¾ç½®ï¼Œä½¿è¿™ä¸ªèŠ‚ç‚¹çš„ size å’Œå›¾ç‰‡ size ä¸åŒ, è­¦å‘Šï¼šå½“ size çš„å®½åº¦æˆ–é«˜åº¦æ˜¯ç›¸å¯¹å€¼æ—¶è°ƒç”¨ getter å°†è¿›è¡Œæ–­è¨€</td></tr><tr><td>.style.minSize</td><td>CGSize</td><td>å¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å°å°ºå¯¸ï¼Œå¦‚æœæä¾›ï¼ŒminSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ minSize å°äºå…¶å­çº§çš„ minSizeï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨å­çº§çš„ minSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤–,ä¾‹å¦‚ï¼Œå¦‚æœç»™å…¨å±å®¹å™¨ä¸­çš„æŸä¸ªå…ƒç´ è®¾ç½® 50ï¼… çš„ preferredSize ç›¸å¯¹å®½åº¦ï¼Œå’Œ 200pt çš„ minSize å®½åº¦ï¼ŒpreferredSize ä¼šåœ¨ iPhone å±å¹•ä¸Šäº§ç”Ÿ 160pt çš„å®½åº¦ï¼Œä½†ç”±äº 160pt ä½äº 200pt çš„ minSize å®½åº¦ï¼Œå› æ­¤æœ€ç»ˆè¯¥å…ƒç´ çš„å®½åº¦ä¼šæ˜¯ 200pt</td></tr><tr><td>.style.maxSize</td><td>CGSize</td><td>å¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å¤§å°ºå¯¸ï¼Œå¦‚æœæä¾›ï¼ŒmaxSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨</td></tr><tr><td>.style.preferredLayoutSize</td><td>ASLayoutSize</td><td>ä¸ºå¸ƒå±€å…ƒç´ æä¾›å»ºè®®çš„ç›¸å¯¹ size.ASLayoutSize ä½¿ç”¨ç™¾åˆ†æ¯”è€Œä¸æ˜¯ç‚¹æ¥æŒ‡å®šå¸ƒå±€.ä¾‹å¦‚ï¼Œå­å¸ƒå±€å…ƒç´ çš„å®½åº¦åº”è¯¥æ˜¯çˆ¶å®½åº¦çš„ 50ï¼….å¦‚æœæä¾›äº†å¯é€‰çš„ minLayoutSize æˆ– maxLayoutSizeï¼Œå¹¶ä¸” preferredLayoutSize è¶…è¿‡äº†è¿™äº›å€¼ï¼Œåˆ™å°†ä½¿ç”¨ minLayoutSize æˆ– maxLayoutSize</td></tr><tr><td>.style.minLayoutSize</td><td>ASLayoutSize</td><td>å¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å°çš„ç›¸å¯¹å°ºå¯¸ï¼Œ å¦‚æœæä¾›ï¼ŒminLayoutSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ minLayoutSize å°äºå…¶å­çº§çš„ minLayoutSizeï¼Œåˆ™ä¼šå¼ºåˆ¶ä½¿ç”¨å­çº§çš„ minLayoutSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤–</td></tr><tr><td>.style.maxLayoutSize</td><td>ASLayoutSize</td><td>å¯é€‰å±æ€§ï¼Œä¸ºå¸ƒå±€å…ƒç´ æä¾›æœ€å¤§çš„ç›¸å¯¹å°ºå¯¸.å¦‚æœæä¾›ï¼ŒmaxLayoutSize å°†ä¼šå¼ºåˆ¶ä½¿ç”¨.å¦‚æœçˆ¶çº§å¸ƒå±€å…ƒç´ çš„ maxLayoutSize å°äºå…¶å­çº§çš„ maxLayoutSizeï¼Œé‚£ä¹ˆå°†å¼ºåˆ¶ä½¿ç”¨å­çº§çš„ maxLayoutSizeï¼Œå¹¶ä¸”å…¶å¤§å°å°†æ‰©å±•åˆ°å¸ƒå±€è§„åˆ™ä¹‹å¤–</td></tr></tbody></table><h2 id="layout-api-sizing"><a class="markdownIt-Anchor" href="#layout-api-sizing"></a> Layout API Sizing</h2><p>åœ¨Layout APIä¸­ï¼Œç†è§£å¤åˆå°ºå¯¸ç±»å‹çš„æœ€ç®€å•æ–¹æ³•æ˜¯æŸ¥çœ‹æ‰€æœ‰çš„ unit ä¹‹é—´çš„å…³ç³»ã€‚</p><div align="left"><img src="/img/texture-sizing.jpeg" alt="texture-sizing" style="width:400px;height:100px"></div><h3 id="values-cgfloat-asdimension"><a class="markdownIt-Anchor" href="#values-cgfloat-asdimension"></a> Values (CGFloat, ASDimension)</h3><p>ASDimensionæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ™®é€šçš„CGFloatï¼Œæ”¯æŒè¡¨ç¤ºç‚¹å€¼ï¼Œç›¸å¯¹ç™¾åˆ†æ¯”å€¼æˆ–è‡ªåŠ¨å€¼ã€‚</p><p>unit å…è®¸ç›¸åŒçš„APIæ¥å—å›ºå®šå€¼å’Œç›¸å¯¹å€¼ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dimension returned is relative (%)</span></span><br><span class="line"><span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line"><span class="type">ASDimensionMakeWithFraction</span>(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// dimension returned in points</span></span><br><span class="line"><span class="type">ASDimensionMake</span>(<span class="string">"70pt"</span>)</span><br><span class="line"><span class="type">ASDimensionMake</span>(<span class="number">70</span>)</span><br><span class="line"><span class="type">ASDimensionMakeWithPoints</span>(<span class="number">70</span>)</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-asdimension-çš„ä¾‹å­"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-asdimension-çš„ä¾‹å­"></a> ä½¿ç”¨ ASDimension çš„ä¾‹å­</h3><p>ASDimension ç”¨äºè®¾ç½® <code>ASStackLayoutSpec</code> ä¸­element çš„ <code>flexBasis</code>. <code>flexBasis</code> å±æ€§åœ¨ stack layout ä¸­æŒ‡å®šå¯¹è±¡çš„åˆå§‹å¤§å°ï¼Œ</p><p>åœ¨ä¸‹é¢çš„è§†å›¾ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å·¦ä¾§å †æ ˆå æ®æ°´å¹³å®½åº¦çš„40ï¼…ï¼Œå³ä¾§å †æ ˆå æ®å®½åº¦çš„60ï¼…ã€‚</p><div align="left"><img src="/img/flexbasis.jpeg" alt="flexbasis" style="width:300px;height:450px"></div><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨æ°´å¹³å †æ ˆçš„ä¸¤ä¸ªå­çº§ä¸Šè®¾ç½®.flexBasiså±æ€§ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.leftStack.style.flexBasis = <span class="type">ASDimensionMake</span>(<span class="string">"40%"</span>)</span><br><span class="line"><span class="keyword">self</span>.rightStack.style.flexBasis = <span class="type">ASDimensionMake</span>(<span class="string">"60%"</span>)</span><br><span class="line"></span><br><span class="line">horizontalStack.children = [<span class="keyword">self</span>.leftStack, <span class="keyword">self</span>.rightStack]</span><br></pre></td></tr></table></figure><h3 id="sizes-cgsize-aslayoutsize"><a class="markdownIt-Anchor" href="#sizes-cgsize-aslayoutsize"></a> Sizes (CGSize, ASLayoutSize)</h3><p>ASLayoutSizeä¸CGSizeç›¸ä¼¼ï¼Œä½†æ˜¯å…¶å®½åº¦å’Œé«˜åº¦å€¼å¯ä»¥è¡¨ç¤ºç‚¹æˆ–ç™¾åˆ†æ¯”å€¼ã€‚å®½åº¦å’Œé«˜åº¦çš„ç±»å‹æ˜¯ç‹¬ç«‹çš„ï¼›ä¸€ä¸ªå¯ä»¥æ˜¯ç‚¹æˆ–ç™¾åˆ†æ¯”å€¼ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ASLayoutSizeMake</span>(<span class="type">ASDimension</span> width, <span class="type">ASDimension</span> height);</span><br></pre></td></tr></table></figure><p>ASLayoutSizeç”¨äºè®¾ç½®å¸ƒå±€å…ƒç´ çš„ <code>.preferredLayoutSize</code> , <code>.minLayoutSize</code> å’Œ <code>.maxLayoutSize</code> å±æ€§ã€‚å®ƒå…è®¸ç›¸åŒçš„APIæ¥å—å›ºå®šå¤§å°ä»¥åŠç›¸å¯¹å¤§å°ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dimension type "Auto" indicates that the layout element may </span></span><br><span class="line"><span class="comment">// be resolved in whatever way makes most sense given the circumstances</span></span><br><span class="line"><span class="keyword">let</span> width = <span class="type">ASDimensionMake</span>(.auto, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">let</span> height = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line">layoutElement.style.preferredLayoutSize = <span class="type">ASLayoutSizeMake</span>(width, height)</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸éœ€è¦ç›¸å¯¹å€¼ï¼Œåˆ™å¯ä»¥è®¾ç½®å¸ƒå±€å…ƒç´ çš„.preferredSizeï¼Œ.minSizeå’Œ.maxSizeå±æ€§ã€‚è¿™äº›å±æ€§é‡‡ç”¨å¸¸è§„CGSizeå€¼ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layoutElement.style.preferredSize = <span class="type">CGSize</span>(width: <span class="number">30</span>, height: <span class="number">60</span>)</span><br></pre></td></tr></table></figure><p>å¤§å¤šæ•°æ—¶å€™ï¼Œéƒ½ä¸æƒ³åŒæ—¶é™åˆ¶å®½åº¦å’Œé«˜åº¦ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ASDimensionå€¼åˆ†åˆ«è®¾ç½®å¸ƒå±€å…ƒç´ çš„å°ºå¯¸å±æ€§ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">layoutElement.style.width     = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line">layoutElement.style.minWidth  = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line">layoutElement.style.maxWidth  = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line"></span><br><span class="line">layoutElement.style.height    = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line">layoutElement.style.minHeight = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br><span class="line">layoutElement.style.maxHeight = <span class="type">ASDimensionMake</span>(<span class="string">"50%"</span>)</span><br></pre></td></tr></table></figure><h3 id="size-range-assizerange"><a class="markdownIt-Anchor" href="#size-range-assizerange"></a> Size Range (ASSizeRange)</h3><p>UIKitæ²¡æœ‰æä¾›ç»„åˆæœ€å°å’Œæœ€å¤§CGSizeçš„ structã€‚å› æ­¤ï¼Œåˆ›å»ºäº†ASSizeRangeä»¥æ”¯æŒæœ€å°å’Œæœ€å¤§CGSizeå¯¹ã€‚</p><p>ASSizeRangeé€šå¸¸ç”¨äºå¸ƒå±€APIçš„å†…éƒ¨ã€‚ä½†æ˜¯ï¼Œä½œä¸ºè¾“å…¥ä¼ é€’ç»™layoutSpecThatFitsï¼šçš„constrainedSizeå€¼æ˜¯ASSizeRangeã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">layoutSpecThatFits</span><span class="params">(<span class="number">_</span> constrainedSize: ASSizeRange)</span></span> -&gt; <span class="type">ASLayoutSpec</span></span><br></pre></td></tr></table></figure><p>ä¼ é€’ç»™ASDisplayNodeå­ç±»çš„layoutSpecThatFitsï¼šæ–¹æ³•çš„constrainedSizeæ˜¯èŠ‚ç‚¹åº”é€‚åˆçš„æœ€å°å’Œæœ€å¤§å¤§å°ã€‚constrainedSizeä¸­åŒ…å«çš„æœ€å°CGSizeå’Œæœ€å¤§CGSizeå¯ç”¨äºè°ƒæ•´èŠ‚ç‚¹çš„å¸ƒå±€å…ƒç´ çš„å¤§å°ã€‚</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> UI å¸ƒå±€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
            <tag> Texture </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>deallocçš„è°ƒç”¨æ—¶æœº</title>
      <link href="/2018/04/02/dealloc%E7%9A%84%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA/"/>
      <url>/2018/04/02/dealloc%E7%9A%84%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p>ä¸€èˆ¬æƒ³æ³• delloc ä¼šåœ¨å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™è°ƒç”¨ã€‚ç”¨æˆ·é‡è½½è¯¥æ–¹æ³•é‡Šæ”¾è‡ªå·±åˆ†é…çš„å †æ§ä»¶ï¼Œç§»é™¤è®¢é˜…â€¦â€¦</p><p>åœ¨ MRC ä¸­</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">  <span class="keyword">self</span>.array = <span class="literal">nil</span>;</span><br><span class="line">  <span class="keyword">self</span>.string = <span class="literal">nil</span>;</span><br><span class="line">  <span class="comment">// ... //</span></span><br><span class="line">  <span class="comment">// éObjcå¯¹è±¡å†…å­˜çš„é‡Šæ”¾ï¼Œå¦‚CFRelease(...)</span></span><br><span class="line">  <span class="comment">// ... //</span></span><br><span class="line">  [<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ARC ä¸­</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">  <span class="comment">// ... //</span></span><br><span class="line">  <span class="comment">// éObjcå¯¹è±¡å†…å­˜çš„é‡Šæ”¾ï¼Œå¦‚CFRelease(...)</span></span><br><span class="line">  <span class="comment">// ... //</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”ä¸¤ç«¯ä»£ç ï¼š</p><ol><li>è¿™ä¸ªå¯¹è±¡å®ä¾‹å˜é‡ï¼ˆIvarsï¼‰çš„é‡Šæ”¾å»å“ªå„¿äº†ï¼Ÿ</li><li>æ²¡æœ‰æ˜¾ç¤ºçš„è°ƒç”¨[super dealloc]ï¼Œä¸Šå±‚çš„ææ„å»å“ªå„¿äº†ï¼Ÿ</li></ol><h2 id="arcæ–‡æ¡£"><a class="markdownIt-Anchor" href="#arcæ–‡æ¡£"></a> <a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html#dealloc" target="_blank" rel="noopener">ARCæ–‡æ¡£</a>ä¸­å¯¹deallocè¿‡ç¨‹çš„è§£é‡Š</h2><blockquote><p>A class may provide a method definition for an instance method named dealloc. This method will be called after the final release of the object but before it is deallocated or any of its instance variables are destroyed. The superclassâ€™s implementation of dealloc will be called automatically when the method returns.</p></blockquote><p>å¤§æ¦‚æ„æ€æ˜¯ï¼šdeallocæ–¹æ³•åœ¨æœ€åä¸€æ¬¡releaseåè¢«è°ƒç”¨ï¼Œä½†<strong>æ­¤æ—¶å®ä¾‹å˜é‡ï¼ˆIvarsï¼‰å¹¶æœªé‡Šæ”¾</strong>ï¼Œ<strong>çˆ¶ç±»çš„deallocçš„æ–¹æ³•å°†åœ¨å­ç±»deallocæ–¹æ³•è¿”å›åè‡ªåŠ¨è°ƒç”¨</strong></p><blockquote><p>The instance variables for an ARC-compiled class will be destroyed at some point after control enters the dealloc method for the root class of the class. The ordering of the destruction of instance variables is unspecified, both within a single class and between subclasses and superclasses.</p></blockquote><p>ç†è§£ï¼š<strong>ARCä¸‹å¯¹è±¡çš„<code>Ivars</code>åœ¨æ ¹ç±»[NSObject dealloc]ä¸­é‡Šæ”¾</strong>ï¼ˆé€šå¸¸root classéƒ½æ˜¯NSObjectï¼‰ï¼Œå˜é‡é‡Šæ”¾é¡ºåºå„ç§ä¸ç¡®å®šï¼ˆä¸€ä¸ªç±»å†…çš„ä¸ç¡®å®šï¼Œå­ç±»å’Œçˆ¶ç±»é—´ä¹Ÿä¸ç¡®å®šï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç”¨careé‡Šæ”¾é¡ºåºï¼‰</p><p>é—®é¢˜ï¼š</p><ol><li>[super delloc] ä¸ºä»€ä¹ˆå¯ä»¥åœ¨å­ç±»çš„ delloc è¿”å›åè‡ªåŠ¨è°ƒç”¨</li><li>å¯¹è±¡çš„ <code>Ivars</code> ä¸ºä»€ä¹ˆä¼šåœ¨æ ¹ç±»çš„ delloc ä¸­é‡Šæ”¾</li></ol><h2 id="delloc-è°ƒç”¨æ ˆåˆ†æ"><a class="markdownIt-Anchor" href="#delloc-è°ƒç”¨æ ˆåˆ†æ"></a> delloc è°ƒç”¨æ ˆåˆ†æ</h2><p>è°ƒç”¨è¿‡ç¨‹</p><p><code>dealloc -&gt; _objc_rootDealloc -&gt; object_dispose -&gt; objc_destructInstance</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123; _objc_rootDealloc(self); &#125; </span><br><span class="line"><span class="keyword">void</span> _objc_rootDealloc(id obj) &#123; obj-&gt;rootDealloc(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> objc_object::rootDealloc() &#123;</span><br><span class="line">  <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span>;  <span class="comment">// fixme necessary? </span></span><br><span class="line">  <span class="keyword">if</span> (fastpath(isa.nonpointer  &amp;&amp;  </span><br><span class="line">         !isa.weakly_referenced  &amp;&amp; <span class="comment">// å¼±å¼•ç”¨</span></span><br><span class="line">         !isa.has_assoc  &amp;&amp;         <span class="comment">// å…³è”å¯¹è±¡</span></span><br><span class="line">         !isa.has_cxx_dtor  &amp;&amp;      <span class="comment">// ææ„å™¨</span></span><br><span class="line">         !isa.has_sidetable_rc)) &#123;  <span class="comment">// æ•£åˆ—è¡¨</span></span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">    <span class="built_in">free</span>(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    object_dispose((id)<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">object_dispose</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">  objc_destructInstance(obj);</span><br><span class="line">  <span class="built_in">free</span>(obj);</span><br><span class="line">  <span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* objc_destructInstance</span></span><br><span class="line"><span class="comment">* Destroys an instance without freeing memory.</span></span><br><span class="line"><span class="comment">* Calls C++ destructors.</span></span><br><span class="line"><span class="comment">* Calls ARC ivar cleanup.</span></span><br><span class="line"><span class="comment">* Removes associative references.</span></span><br><span class="line"><span class="comment">* Returns `obj`. Does nothing if `obj` is nil.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">objc_destructInstance</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">    <span class="comment">// Read all of the flags at once for performance.</span></span><br><span class="line">    <span class="keyword">bool</span> cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">    <span class="keyword">bool</span> assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This order is important.</span></span><br><span class="line">    <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);</span><br><span class="line">    <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);<span class="comment">// æ¸…ç†å…³è”å¯¹è±¡</span></span><br><span class="line">    obj-&gt;clearDeallocating();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è¿™ä¸ªæ–¹æ³•<code>objc_destructInstance</code>ï¼Œæ ¹æ®ä»–çš„æ³¨é‡Š</p><ol><li>é”€æ¯å®ä¾‹å¯¹è±¡ï¼Œä½†æ²¡æœ‰é‡Šæ”¾å†…å­˜</li><li>è°ƒç”¨ C++ çš„ destructor</li><li>æ‰ç”¨ ARC å°† ivar æ¸…ç†</li><li>æ¸…ç†å…³è”å¯¹è±¡</li></ol><p>object_cxxDestruct åšäº†ä»€ä¹ˆï¼Ÿ<br>clearDeallocating åšäº†ä»€ä¹ˆï¼Ÿ</p><h3 id="cleardeallocating-æ¸…ç©ºå¼±å¼•ç”¨"><a class="markdownIt-Anchor" href="#cleardeallocating-æ¸…ç©ºå¼±å¼•ç”¨"></a> clearDeallocating æ¸…ç©ºå¼±å¼•ç”¨</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> objc_object::clearDeallocating() &#123;</span><br><span class="line">  <span class="keyword">if</span> (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">    <span class="comment">// Slow path for raw pointer isa.</span></span><br><span class="line">    sidetable_clearDeallocating();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">    <span class="comment">// Slow path for non-pointer isa with weak refs and/or side table data.</span></span><br><span class="line">    clearDeallocating_slow();</span><br><span class="line">  &#125; </span><br><span class="line">  assert(!sidetable_present());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ok clearDeallocating ç”¨äºæ¸…ç©ºå¼•ç”¨è®¡æ•°è¡¨å¹¶æ¸…é™¤å¼±å¼•ç”¨è¡¨ï¼Œå°†æ‰€æœ‰weakå¼•ç”¨æŒ‡nil</p><h3 id="object_cxxdestruct"><a class="markdownIt-Anchor" href="#object_cxxdestruct"></a> object_cxxDestruct</h3><p>ä»<a href="http://my.safaribooksonline.com/book/programming/objective-c/9780132908641/3dot-memory-management/ch03" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ä¸­ï¼š</p><blockquote><p>ARC actually creates a -.cxx_destruct method to handle freeing instance variables. This method was originally created for calling C++ destructors automatically when an object was destroyed.</p></blockquote><p><code>object_cxxDestruct</code> æ–¹æ³•ç”¨äºé‡Šæ”¾å®ä¾‹çš„ ivars</p><p>å’Œã€ŠEffective Objective-C 2.0ã€‹ä¸­æåˆ°çš„ï¼š</p><blockquote><p>When the compiler saw that an object contained C++ objects, it would generate a method called .cxx_destruct. ARC piggybacks on this method and emits the required cleanup code within it.</p></blockquote><p>å¯ä»¥äº†è§£åˆ°ï¼Œ.cxx_destructæ–¹æ³•åŸæœ¬æ˜¯ä¸ºäº†C++å¯¹è±¡ææ„çš„ï¼ŒARCå€Ÿç”¨äº†è¿™ä¸ªæ–¹æ³•æ’å…¥ä»£ç å®ç°äº†è‡ªåŠ¨å†…å­˜é‡Šæ”¾çš„å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">object_cxxDestruct</span><span class="params">(id obj)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!obj) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line">  object_cxxDestructFromClass(obj, obj-&gt;ISA());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* object_cxxDestructFromClass.</span></span><br><span class="line"><span class="comment">* Call C++ destructors on obj, starting with cls's </span></span><br><span class="line"><span class="comment">*   dtor method (if any) followed by superclasses' dtors (if any), </span></span><br><span class="line"><span class="comment">*   stopping at cls's dtor (if any).</span></span><br><span class="line"><span class="comment">* Uses methodListLock and cacheUpdateLock. The caller must hold neither.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">object_cxxDestructFromClass</span><span class="params">(id obj, Class cls)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> (*dtor)(id); </span><br><span class="line">  <span class="comment">// Call cls's dtor first, then superclasses's dtors. </span></span><br><span class="line">  <span class="keyword">for</span> ( ; cls; cls = cls-&gt;superclass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls-&gt;hasCxxDtor()) <span class="keyword">return</span>; </span><br><span class="line">    dtor = (<span class="keyword">void</span>(*)(id))</span><br><span class="line">      lookupMethodInClassAndLoadCache(cls, SEL_cxx_destruct);</span><br><span class="line">    <span class="keyword">if</span> (dtor != (<span class="keyword">void</span>(*)(id))_objc_msgForward_impcache) &#123;</span><br><span class="line">      <span class="keyword">if</span> (PrintCxxCtors) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"CXX: calling C++ destructors for class %s"</span>, </span><br><span class="line">               cls-&gt;nameForLogging());</span><br><span class="line">      &#125;</span><br><span class="line">      (*dtor)(obj);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åœ¨å®ä¾‹å¯¹è±¡çš„æœ€åä¸€ä¸ª release æ–¹æ³•è°ƒç”¨ï¼Œå¼•ç”¨è®¡æ•° = 0 è°ƒç”¨dealloc</li><li>å®ä¾‹å¯¹è±¡æ˜¯å¦æ˜¯ isTaggedPointer</li><li>é€šè¿‡ C++ çš„ææ„å™¨é‡Šæ”¾ ivars æˆå‘˜å˜é‡å†…å­˜</li><li>ç§»é™¤å…³è”å¯¹è±¡</li><li>ç§»é™¤ weak å¼•ç”¨ç›¸å…³æ•°æ®ï¼Œweak å˜é‡ç½®ä¸º nil</li></ol><blockquote><p><a href="http://blog.sunnyxx.com/2014/04/02/objc_dig_arc_dealloc/" target="_blank" rel="noopener">ARCä¸‹deallocè¿‡ç¨‹åŠ.cxx_destructçš„æ¢ç©¶</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠŸèƒ½ç»†èŠ‚è®°å½•</title>
      <link href="/2018/03/24/%E5%8A%9F%E8%83%BD%E7%BB%86%E8%8A%82%E8%AE%B0%E5%BD%95/"/>
      <url>/2018/03/24/%E5%8A%9F%E8%83%BD%E7%BB%86%E8%8A%82%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="ä½¿å¾—ç³»ç»Ÿsettingé¡µé¢ä¸­æœ‰è‡ªå·±app-çš„è®¾ç½®"><a class="markdownIt-Anchor" href="#ä½¿å¾—ç³»ç»Ÿsettingé¡µé¢ä¸­æœ‰è‡ªå·±app-çš„è®¾ç½®"></a> ä½¿å¾—ç³»ç»Ÿsettingé¡µé¢ä¸­æœ‰è‡ªå·±app çš„è®¾ç½®</h2><p><a href="https://www.jianshu.com/p/27fe365202b4" target="_blank" rel="noopener">iOSå¼€å‘ä¹‹Settings Bundleçš„ä½¿ç”¨</a></p><h2 id="app-å’Œ-app-extension-å…±äº«æ•°æ®"><a class="markdownIt-Anchor" href="#app-å’Œ-app-extension-å…±äº«æ•°æ®"></a> app å’Œ app Extension å…±äº«æ•°æ®</h2><ol><li>UserDefault ä½¿ç”¨ groupName åˆå§‹åŒ–å°±å¯ä»¥äº†</li><li>FileManager æ•°æ®è·å–ä¸€å®šä½¿ç”¨ URL æ ¼å¼æ‹¼æ¥ groupï¼Œå¦‚æœä½¿ç”¨ String ä¼šè¯»ä¸åˆ°æ•°æ®</li></ol><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>22-æ¯”è¾ƒçº§å€’è£…</title>
      <link href="/2018/03/15/English/22-%E5%80%92%E8%A3%85%E5%8F%A5/"/>
      <url>/2018/03/15/English/22-%E5%80%92%E8%A3%85%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><h2 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h2><p>å€’è£…å¥æ˜¯â¼€ç§æŠŠåŠ¨è¯ï¼ˆæˆ–åŠ©åŠ¨è¯ï¼‰ç§»åˆ°ä¸»è¯­å‰â¾¯çš„å¥å‹ã€‚ä»¥è¿™ä¸ªå®šä¹‰æ¥çœ‹ï¼Œâ¼€èˆ¬ çš„ç–‘é—®å¥éƒ½å¯ä»¥ç®—æ˜¯å€’è£…å¥ã€‚</p><p>æ’‡å¼€ç–‘é—®å¥è¿™ç§åªå…·æœ‰è¯­æ³•åŠŸèƒ½çš„å€’è£…å¥ä¸è°ˆï¼Œâ½è¾ƒå€¼å¾—ç ”ç©¶çš„æ˜¯å…·æœ‰ä¿®è¾åŠŸèƒ½çš„å€’è£…å¥ã€‚æ°å½“åœ°è¿â½¤å€’è£…å¥ï¼Œå¯ä»¥å¼ºè°ƒè¯­â½“ã€å¢å¼ºæ¸…æ¥šæ€§ä¸ç®€æ´æ€§ï¼Œä»¥åŠ æ›´æµç•…åœ°è¡”æ¥å‰åçš„å¥â¼¦ã€‚ä»¥ä¸‹åˆ†åˆ«å°±â¼ç§é‡è¦çš„å€’è£…å¥æ¥çœ‹çœ‹å®ƒå€’è£…çš„æ¡ä»¶ï¼Œ ä»¥åŠå¯è¾¾åˆ°çš„ä¿®è¾æ•ˆæœã€‚</p><p><img src="/img/english/daozhuang.jpeg" alt="frame"></p><h2 id="æ¯”è¾ƒçº§çš„å€’è£…"><a class="markdownIt-Anchor" href="#æ¯”è¾ƒçº§çš„å€’è£…"></a> æ¯”è¾ƒçº§çš„å€’è£…</h2><ol><li>Girls like cats more than boys.(ä¸æ¸…æ¥šï¼‰ è¿™ä¸ªå¥â¼¦å¯èƒ½æœ‰ä¸¤ç§æ„æ€ï¼š</li><li>Girls like cats more than boys do. (â¼¥å­©æ¯”ç”·å­©æ›´å–œæ¬¢çŒ«ã€‚ï¼‰</li><li>Girls like cats more than they like boys. (â¼¥å­©æ¯”è¾ƒå–œæ¬¢çŒ«ï¼Œæ¯”è¾ƒä¸å–œæ¬¢ç”·å­©ã€‚ï¼‰</li></ol><p>â½è¾ƒçº§çš„å¥å‹é€šå¸¸ä¼šç‰µæ¶‰åˆ°ä¸¤ä¸ªä»å¥äº’ç›¸â½è¾ƒã€‚è¿™ä¸¤ä¸ªä»å¥é—´åº”æœ‰é‡å¤çš„éƒ¨ åˆ†æ‰èƒ½â½è¾ƒã€‚â¼€æ—¦æœ‰é‡å¤ï¼Œå°±æœ‰çœç•¥çš„ç©ºé—´ã€‚ä½†æ˜¯å¦‚æœçœç•¥ä¸å½“ï¼Œå°±ä¼šä¼¤å®³å¥â¼¦ çš„æ¸…æ¥šæ€§ã€‚</p><h2 id="å…³ç³»ä»å¥çš„å€’è£…"><a class="markdownIt-Anchor" href="#å…³ç³»ä»å¥çš„å€’è£…"></a> å…³ç³»ä»å¥çš„å€’è£…</h2><h2 id="å‡è®¾è¯­æ°”çš„å€’è£…"><a class="markdownIt-Anchor" href="#å‡è®¾è¯­æ°”çš„å€’è£…"></a> å‡è®¾è¯­æ°”çš„å€’è£…</h2><h2 id="å¼•ç”¨å¥çš„å€’è£…"><a class="markdownIt-Anchor" href="#å¼•ç”¨å¥çš„å€’è£…"></a> å¼•ç”¨å¥çš„å€’è£…</h2><h2 id="ç±»ä¼¼-there-isare-çš„å€’è£…"><a class="markdownIt-Anchor" href="#ç±»ä¼¼-there-isare-çš„å€’è£…"></a> ç±»ä¼¼ there is/are çš„å€’è£…</h2><h2 id="å¦å®šå‰¯è¯å¼€å¤´çš„å€’è£…"><a class="markdownIt-Anchor" href="#å¦å®šå‰¯è¯å¼€å¤´çš„å€’è£…"></a> å¦å®šå‰¯è¯å¼€å¤´çš„å€’è£…</h2><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è‹±è¯­å­¦ä¹  </category>
          
          <category> è¯­æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¯­æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‹±è¯­è¯­æ³•å­¦ä¹ </title>
      <link href="/2018/03/15/English/%E8%8B%B1%E8%AF%AD%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/"/>
      <url>/2018/03/15/English/%E8%8B%B1%E8%AF%AD%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p>ä½¿ç”¨æ•°æ®ï¼š<a href="https://pan.baidu.com/s/1eza61t93vBhh2-cPejuPuw" target="_blank" rel="noopener">è‹±è¯­é­”æ³•å¸ˆä¹‹è¯­æ³•ä¿±ä¹éƒ¨</a></p><p><img src="/img/english/english_grammer.jpeg" alt="english_grammer"></p><p>è®°å½•è‡ªå·±å­¦ä¹ è‹±è¯­çš„è¿‡ç¨‹</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è‹±è¯­å­¦ä¹  </category>
          
          <category> è¯­æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> English </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ç»™è‡ªå·±çš„åº“æ·»åŠ å‰ç¼€</title>
      <link href="/2018/03/12/%E5%A6%82%E4%BD%95%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E5%BA%93%E6%B7%BB%E5%8A%A0%E5%89%8D%E7%BC%80/"/>
      <url>/2018/03/12/%E5%A6%82%E4%BD%95%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E5%BA%93%E6%B7%BB%E5%8A%A0%E5%89%8D%E7%BC%80/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="åœ¨-rxswiftä¸­"><a class="markdownIt-Anchor" href="#åœ¨-rxswiftä¸­"></a> åœ¨ Rxswiftä¸­</h2><ul><li>rx_tap : åŸå§‹è¯­æ³•The original syntax</li><li>rxTap : åŒä¸Šï¼Œä½†æ˜¯è¯­ä¹‰æœ‰æ­§ä¹‰ï¼Œå¦‚æœä¸æ˜¯ Rxswiftåº“ä¸­å´æ˜¯ç”¨ rxABC è¿™æ ·çš„</li><li>reactiveTap : è¯­ä¹‰å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å¤ªé•¿äº†</li><li>rx.tap : âœ¨ğŸ˜²âœ¨ è¿™æ ·å°±å¾ˆå¥½äº†ï¼Œä¸€ä¸ªæ¼‚äº®çš„å‘½åç©ºé—´.</li></ul><h2 id="æƒ³æ³•æ¥æº"><a class="markdownIt-Anchor" href="#æƒ³æ³•æ¥æº"></a> æƒ³æ³•æ¥æº</h2><p><a href="https://github.com/apple/swift/blob/master/stdlib/public/core/LazySequence.swift" target="_blank" rel="noopener">LazySequence</a></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myArray.<span class="built_in">map</span> &#123; ... &#125;</span><br><span class="line">myArray.<span class="built_in">lazy</span>.<span class="built_in">map</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ RxCocoa ä¸­æœ‰åŒæ ·çš„è¯­æ³•:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> myButton.enabled &#123; ... &#125;</span><br><span class="line">myButton.rx.enabled.subscribeNext &#123; ... &#125;</span><br></pre></td></tr></table></figure><h2 id="å®ç°ç»†èŠ‚"><a class="markdownIt-Anchor" href="#å®ç°ç»†èŠ‚"></a> å®ç°ç»†èŠ‚</h2><h3 id="å…±äº«çš„ä»£ç "><a class="markdownIt-Anchor" href="#å…±äº«çš„ä»£ç "></a> å…±äº«çš„ä»£ç </h3><p>æˆ‘æƒ³æˆ‘ä»¬å¯ä»¥æŠŠ <code>Reactive</code> protocol è½¬æ¢æˆä¸€ä¸ªæ³›å‹ struct :</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Reactive</span>&lt;<span class="title">Base</span>: <span class="title">AnyObject</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">let</span> base: <span class="type">Base</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.base = base</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬æ‰©å±• <code>NSObjectProtocol</code> åè®®æ¥åˆ›å»º <code>rx</code> ä»£ç† :</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> rx: <span class="type">Reactive</span>&lt;<span class="type">Self</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Reactive</span>(<span class="keyword">self</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><details><summary>RxSwift ä¸­çš„å®ç°</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Reactive</span>&lt;<span class="title">Base</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/// Base object to extend.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">let</span> base: <span class="type">Base</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.base = base</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A type that has reactive extensions.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">ReactiveCompatible</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Extended type</span></span><br><span class="line">  <span class="keyword">associatedtype</span> <span class="type">ReactiveBase</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@available</span>(*, deprecated, message: <span class="string">"Use `ReactiveBase` instead."</span>)</span><br><span class="line">  <span class="keyword">typealias</span> <span class="type">CompatibleType</span> = <span class="type">ReactiveBase</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Reactive extensions.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">var</span> rx: <span class="type">Reactive</span>&lt;<span class="type">ReactiveBase</span>&gt;.<span class="type">Type</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Reactive extensions.</span></span><br><span class="line">  <span class="keyword">var</span> rx: <span class="type">Reactive</span>&lt;<span class="type">ReactiveBase</span>&gt; &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ReactiveCompatible</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// Reactive extensions.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> rx: <span class="type">Reactive</span>&lt;<span class="type">Self</span>&gt;.<span class="type">Type</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Reactive</span>&lt;<span class="type">Self</span>&gt;.<span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      <span class="comment">// this enables using Reactive to "mutate" base type</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Reactive extensions.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> rx: <span class="type">Reactive</span>&lt;<span class="type">Self</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Reactive</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      <span class="comment">// this enables using Reactive to "mutate" base object</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> class Foundation.NSObject</span><br><span class="line"><span class="comment">/// Extend NSObject with `rx` proxy.</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSObject</span>: <span class="title">ReactiveCompatible</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></pre></details><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨Selfï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰©å±•åè®®è€Œä¸æ˜¯å…·ä½“ç±»å‹ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘å»ºè®®ä½¿ç”¨NSObjectProtocolï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´æœ‰æ„ä¹‰çš„åè®®ï¼Œä¾‹å¦‚ReactiveCompatibleæˆ–ç±»ä¼¼çš„åè®®ã€‚</p><details><summary>è‡ªå·±å®ç°ä¸€ä¸ªå°çš„æ‰©å±•</summary><p>ä½¿ç”¨ æ³›å‹ï¼ˆæ¨¡æ¿ï¼‰åˆ›å»ºè‡ªå·±çš„ç±»å‹</p><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">Czw</span>&lt;<span class="title">Base</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">let</span> base: <span class="type">Base</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> base: <span class="type">Base</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.base = base</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">CzwCompatible</span> </span>&#123;</span><br><span class="line">  <span class="keyword">associatedtype</span> <span class="type">CzwBase</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">var</span> czw: <span class="type">Czw</span>&lt;<span class="type">CzwBase</span>&gt;.<span class="type">Type</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> czw: <span class="type">Czw</span>&lt;<span class="type">CzwBase</span>&gt; &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CzwCompatible</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> czw: <span class="type">Czw</span>&lt;<span class="type">Self</span>&gt;.<span class="type">Type</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Czw</span>&lt;<span class="type">Self</span>&gt;.<span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      <span class="comment">// this enables using Czw to "mutate" base type</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/// Czw extensions.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> czw: <span class="type">Czw</span>&lt;<span class="type">Self</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Czw</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      <span class="comment">// this enables using Czw to "mutate" base object</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> class Foundation.NSObject</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSObject</span>: <span class="title">CzwCompatible</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">String</span>: <span class="title">CzwCompatible</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Czw</span> <span class="title">where</span> <span class="title">Base</span> == <span class="title">String</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x: <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="string">"233"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="string">"1"</span></span><br><span class="line"><span class="keyword">let</span> b = a.czw.x</span><br></pre></td></tr></table></figure></pre></details><h3 id="å…·ä½“æ‰©å±•"><a class="markdownIt-Anchor" href="#å…·ä½“æ‰©å±•"></a> å…·ä½“æ‰©å±•</h3><p>ç°åœ¨è¦å°† reactive extensions æ·»åŠ åˆ°ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é€šç”¨çº¦æŸæ¥æ‰©å±•Reactiveï¼Œè€Œä¸æ˜¯æ‰©å±•ç›®æ ‡ç±»å‹æœ¬èº«ã€‚</p><p>å› æ­¤å¯¹äºä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> rx_tap: <span class="type">ControlEvent</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> rx_controlEvent(.touchUpInside)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåš</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> tap: <span class="type">ControlEvent</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> controlEvent(.touchUpInside)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…å­˜ç®¡ç†æ³¨æ„äº‹é¡¹"><a class="markdownIt-Anchor" href="#å†…å­˜ç®¡ç†æ³¨æ„äº‹é¡¹"></a> å†…å­˜ç®¡ç†æ³¨æ„äº‹é¡¹</h3><p>æˆ‘çœ‹åˆ°çš„è¿™ç§æ–°è¯­æ³•çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå®ƒå¯èƒ½å¯¼è‡´é—­åŒ…å†…éƒ¨ä¸å¤ªç›´è§‚çš„å†…å­˜ç®¡ç†ã€‚<br>å®é™…ä¸Šï¼Œç°åœ¨ï¼Œå“åº”å¼æ‰©å±•å±äºReactiveç±»å‹ï¼ˆä»£ç†ï¼‰ã€‚å› æ­¤ï¼Œæ— è®ºåœ¨æ–¹æ³•å®ç°ä¸­ä½¿ç”¨ <code>self</code> çš„ä»€ä¹ˆåœ°æ–¹ï¼Œå®ƒéƒ½å¼•ç”¨ä»£ç†è€Œä¸æ˜¯ <code>base</code>ã€‚<br>ä½†æ˜¯ç”±äºè¿™ä¸ª proxy æ˜¯ä¸€ç§å€¼ç±»å‹ï¼Œæ— æ³•å¼±åŒ–(weakify)å®ƒï¼Œå¹¶ä¸”æ¯æ¬¡åœ¨é—­åŒ…å†…ä½¿ç”¨ <code>self</code> æ—¶ï¼Œå®ƒå®é™…ä¸Šéƒ½ä¼š strongifyï¼ˆretainï¼‰å…¶æ‰€æœ‰å¼•ç”¨ç±»å‹æˆå‘˜ï¼ˆå³ <code>base</code> ï¼‰ã€‚<br>å› æ­¤ï¼Œåœ¨å®ç°æ‰©å±•æ—¶éœ€è¦æ ¼å¤–å°å¿ƒã€‚ è®©æˆ‘ä»¬ä»¥UISearchBarä¸ºä¾‹ã€‚</p><p>Sample 1 : å½“å‰çš„å®ç°</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UISearchBar</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> rx_delegate: <span class="type">DelegateProxy</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">RxSearchBarDelegateProxy</span>.proxyForObject(<span class="keyword">self</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> rx_text: <span class="type">ControlProperty</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; = <span class="type">Observable</span>.deferred &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] () -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> text = <span class="keyword">self</span>?.text ?? <span class="string">""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>?.rx_delegate.observe(#selector(<span class="type">UISearchBarDelegate</span>.searchBar(<span class="number">_</span>:textDidChange:))) ?? <span class="type">Observable</span>.empty())</span><br><span class="line">    .<span class="built_in">map</span> &#123; a <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">return</span> a[<span class="number">1</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    .startWith(text)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> bindingObserver = <span class="type">UIBindingObserver</span>(<span class="type">UIElement</span>: <span class="keyword">self</span>) &#123; (searchBar, text: <span class="type">String</span>) <span class="keyword">in</span></span><br><span class="line">    searchBar.text = text</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="type">ControlProperty</span>(values: source, valueSink: bindingObserver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sample 2 : é”™è¯¯å†…å­˜ç®¡ç†çš„æ–°å®ç°</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UISearchBar</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> delegate: <span class="type">DelegateProxy</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">RxSearchBarDelegateProxy</span>.proxyForObject(<span class="keyword">self</span>.base)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> text: <span class="type">ControlProperty</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; = <span class="type">Observable</span>.deferred &#123; [<span class="keyword">weak</span> searchBar = <span class="keyword">self</span>.base] () -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> text = searchBar?.text ?? <span class="string">""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.delegate.observe(#selector(<span class="type">UISearchBarDelegate</span>.searchBar(<span class="number">_</span>:textDidChange:)))</span><br><span class="line">    .<span class="built_in">map</span> &#123; a <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">return</span> a[<span class="number">1</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    .startWith(text)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> bindingObserver = <span class="type">UIBindingObserver</span>(<span class="type">UIElement</span>: <span class="keyword">self</span>.base) &#123; (searchBar, text: <span class="type">String</span>) <span class="keyword">in</span></span><br><span class="line">    searchBar.text = text</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="type">ControlProperty</span>(values: source, valueSink: bindingObserver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sample 3 : å…·æœ‰è‰¯å¥½å†…å­˜ç®¡ç†çš„æ–°å®ç°</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UISearchBar</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> delegate: <span class="type">DelegateProxy</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">RxSearchBarDelegateProxy</span>.proxyForObject(<span class="keyword">self</span>.base)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> text: <span class="type">ControlProperty</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; = <span class="type">Observable</span>.deferred &#123; [<span class="keyword">weak</span> searchBar = <span class="keyword">self</span>.base] () -&gt; <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> text = searchBar?.text ?? <span class="string">""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (searchBar?.rx.delegate.observe(#selector(<span class="type">UISearchBarDelegate</span>.searchBar(<span class="number">_</span>:textDidChange:))) ?? <span class="type">Observable</span>.empty())</span><br><span class="line">    .<span class="built_in">map</span> &#123; a <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">return</span> a[<span class="number">1</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    .startWith(text)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> bindingObserver = <span class="type">UIBindingObserver</span>(<span class="type">UIElement</span>: <span class="keyword">self</span>.base) &#123; (searchBar, text: <span class="type">String</span>) <span class="keyword">in</span></span><br><span class="line">    searchBar.text = text</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="type">ControlProperty</span>(values: source, valueSink: bindingObserver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®éƒ¨åˆ†æ˜¯åœ¨æ¯ä¸ª sample ä»£ç çš„ç¬¬ 10è¡Œ<br>sample2 å¾ˆå®¹æ˜“é€šè¿‡ self è®¿é—® <code>delegate</code> è§‚å¯Ÿè€…ï¼Œå› ä¸º <code>delegate</code> æ˜¯åœ¨åŒä¸€ <code>proxy</code> æ‰©å±•ä¸Šå®šä¹‰çš„ã€‚ä½†æ˜¯è¿™æ ·åšï¼Œé—­åŒ…æ•è·äº† <code>self</code> å¹¶ä¿ç•™äº†å…¶æ‰€æœ‰å¼•ç”¨æˆå‘˜ã€‚å› æ­¤ï¼Œå®ƒå–æ¶ˆäº† <code>[weak searchBar = self.base]</code> æ•è·åˆ—è¡¨</p><p>é¿å…è¿™ç§æƒ…å†µçš„æ­£ç¡®æ–¹æ³•æ˜¯ï¼Œæ€»æ˜¯åœ¨æ—§çš„å®ç°ä¸­ç”¨ <code>base</code> æ›¿æ¢ <code>self</code> ï¼Œå¹¶ä¸”æ¯å½“æœ‰rx_å‰ç¼€æ—¶ï¼Œéƒ½åº”è¯¥ç”¨ rx. ä»£ç†æ›¿æ¢å®ƒã€‚</p><blockquote><p><a href="https://github.com/ReactiveX/RxSwift/issues/826#issue-169876139" target="_blank" rel="noopener">Move from <code>rx_</code> prefix to a <code>rx.</code> proxy (for swift3 update ?)</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> è®¾è®¡æ€æƒ³ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rx+MVVM å®é™…åº”ç”¨</title>
      <link href="/2018/03/04/RxSwfit+RAC/Rx-MVVM-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/"/>
      <url>/2018/03/04/RxSwfit+RAC/Rx-MVVM-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p>åœ¨çœ‹æ–‡ RxSwift ç›¸å…³å®˜æ–¹æ–‡æ¡£ä»¥åï¼ŒçŸ¥é“ RxSwift æä¾›çš„å¤šç§åŠŸèƒ½ä»¥åï¼Œåœ¨å®é™…åœºæ™¯ä¸­æˆ‘ä»¬è¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ</p><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>æœ¬ç¯‡æ–‡ç« åªè°ˆ rx åœ¨ MVVM ä¸­å¦‚ä½•ä½¿ç”¨ã€‚<br>RxSwift çš„åŠŸèƒ½å¼ºå¤§ï¼ŒåŠ ä¸Š Apple æä¾›çš„frameworkä¹Ÿæä¾›äº†å¾ˆå¤šæ–¹å¼ï¼Œæ¥å¤„ç† MVVM ä¸­äº‹ä»¶ç›‘å¬å›è°ƒâ€¦â€¦<br>ä½¿ç”¨ RxSwift çš„ä¼˜ç¼ºç‚¹ä¸è°ˆï¼Œå•å•è¯´ RxSwift ä»£ç é›¶æ•£åœ¨ Viewå±‚ï¼ŒViewModelå±‚å°±è®©äººå›°æ‰°ï¼Œåˆ°åº•ä»€ä¹ˆæ ·çš„äº‹ä»¶æµæ‰æ˜¯æœ€åˆé€‚çš„ï¼Œè¿™ä¸ªå› äººè€Œå¼‚ï¼Œä¸è¿‡åœ¨å›¢é˜Ÿå¼€å‘ä¸­æ¡†æ¶ä½¿ç”¨çš„æ–¹å¼è¦ç»Ÿä¸€ï¼<br>è¿™æ ·å¯ä»¥å¤§å¤§æé«˜å¼€å‘æ•ˆç‡â€¦â€¦</p><p>MVVM å¤åˆæ¨¡å¼çš„æ ·å­</p><p><img src="/img/mvvm.jpeg" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ViewController</span><br><span class="line">    * ç®¡ç†è§†å›¾å¸ƒå±€æ¸²æŸ“</span><br><span class="line">    * æ§åˆ¶å™¨ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">    * æ¥å—è§†å›¾ actionsï¼Œå¹¶ä½œå‡ºç›¸åº”</span><br><span class="line">    * æ§åˆ¶å™¨è·³è½¬</span><br><span class="line">    * ....</span><br><span class="line"></span><br><span class="line">ViewModel</span><br><span class="line">    * å„ç§ <span class="built_in">Server</span> çš„ä¸­ä»‹å™¨</span><br><span class="line">    * netServerï¼ŒDBServerï¼ŒOtherManagerâ€¦â€¦</span><br><span class="line">    * ....</span><br></pre></td></tr></table></figure><h2 id="ä¸ºä»€ä¹ˆè¦åœ¨-mvvm-ä¸­ä½¿ç”¨-rx"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆè¦åœ¨-mvvm-ä¸­ä½¿ç”¨-rx"></a> ä¸ºä»€ä¹ˆè¦åœ¨ MVVM ä¸­ä½¿ç”¨ Rx</h2><p>æŠ›å»ä¸Šæ®µè¡¥å……ä¿¡æ¯ï¼Œåªå…³æ³¨<font color="red">event/data</font>çš„æµåŠ¨æ–¹å‘ï¼Œå¾—å‡ºä¸‹å›¾</p><p><img src="/img/mvvm_1.jpeg" alt=""></p><p>é‚£ä¹ˆå¯ä¸å¯ä»¥æŠŠ input/output å½“åšæ§½å£</p><p><img src="/img/mvvm_2.jpeg" alt=""></p><p><strong>æ§½å£ï¼</strong>ï¼Œå¦‚æœçœ‹ RxSwift æºç å¯ä»¥çœ‹åˆ°å¤§é‡çš„ sink(æ°´æ§½) ç±»ï¼Œsink æ˜¯è¿æ¥å„ç§ Observable å’Œ Observer çš„ç®¡é“:</p><p>Observable æµè¿›æ°´æ§½çš„æ§½å£ï¼Œæµå‡ºï¼ˆevent(data?)ï¼‰<br>Observer æµå‡ºæ°´æ§½çš„æ§½å£ï¼Œæ¥å—ï¼ˆevent(data?)ï¼‰<br>æ‰€ä»¥ï¼Œä½¿ç”¨ RxSwift æ¥åˆ¶ä½œ Viewå±‚å’ŒViewModel å±‚çš„æ§½å£ï¼ŒRxSwift vs äº‹ä»¶/æ•°æ®çš„æµç¨‹ vs App æµç¨‹</p><p><img src="/img/mvvm_3.jpeg" alt=""></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ViewModelType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">associatedtype</span> <span class="type">Input</span></span><br><span class="line">  <span class="keyword">associatedtype</span> <span class="type">Output</span></span><br><span class="line">  <span class="keyword">var</span> input: <span class="type">Input</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> output: <span class="type">Output</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªè¯¦ç»†çš„ demo</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SayHelloViewModel</span>: <span class="title">ViewModelType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> input: <span class="type">Input</span></span><br><span class="line">  <span class="keyword">let</span> output: <span class="type">Output</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Input</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">AnyObserver</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> validate: <span class="type">AnyObserver</span>&lt;<span class="type">Void</span>&gt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Output</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> greeting: <span class="type">Driver</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">let</span> nameSubject = <span class="type">ReplaySubject</span>&lt;<span class="type">String</span>&gt;.create(bufferSize: <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">let</span> validateSubject = <span class="type">PublishSubject</span>&lt;<span class="type">Void</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">init</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> greeting = validateSubject</span><br><span class="line">      .withLatestFrom(nameSubject)</span><br><span class="line">      .<span class="built_in">map</span> &#123; name <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello \(name)!"</span></span><br><span class="line">      &#125;</span><br><span class="line">      .asDriver(onErrorJustReturn: <span class="string">":-("</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.output = <span class="type">Output</span>(greeting: greeting)</span><br><span class="line">    <span class="keyword">self</span>.input = <span class="type">Input</span>(name: nameSubject.asObserver(), validate: validateSubject.asObserver())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Subjectæ˜¯ç§æœ‰çš„ã€‚æ²¡æœ‰éæ³•ä¾µå…¥ViewModelçš„æ–¹å¼ï¼Œåªèƒ½é€šè¿‡å…¬å…±çš„Inputå’Œoutputå±æ€§ã€‚</p><p>ViewModel å¯ä»¥æ’å…¥åˆ°ä»»ä½•viewï¼Œå®¹æ˜“å•å…ƒæµ‹è¯•å’ŒRxç»‘å®šã€‚<br><a href="https://gist.github.com/MartinMoizard/449be0d30920010210988f1773a2ca90" target="_blank" rel="noopener">view ä½¿ç”¨è¿™ç§æ–¹å¼ç»‘å®šçš„ demo</a></p><h2 id="cell-ç›‘å¬å¤ç”¨é—®é¢˜"><a class="markdownIt-Anchor" href="#cell-ç›‘å¬å¤ç”¨é—®é¢˜"></a> cell ç›‘å¬å¤ç”¨é—®é¢˜</h2><p>cell å¼•ç”¨çš„ Observable <code>tableView:cellForRowAtIndexPath:</code> ä¸­è¢«è®¢é˜…ï¼Œè¯¥æ–¹æ³•åå¤è°ƒç”¨çš„è¿‡ç¨‹ cell ä¸ä¼šè¢«é‡Šæ”¾ï¼Œåªæ˜¯è¢«å¤ç”¨ï¼Œæ‰€ä»¥æ¯æ¬¡ cell åœ¨è¯¥æ–¹æ³•ä¸­è®¢é˜…çš„æ—¶å€™éƒ½åº”è¯¥å…ˆè§£é™¤ä¸Šä¸€æ¬¡çš„è®¢é˜…ã€‚å¦‚æœä¸è§£é™¤ï¼Œè¿™ä¸ª Observable ä¼šæœ‰å¤šä¸ªè®¢é˜…è€…</p><p>é‚£ä¹ˆå¦‚ä½•æœ‰æ•ˆçš„è§£é™¤ä¸Šæ¬¡ cell å¤ç”¨äº§ç”Ÿçš„è®¢é˜…å‘¢ï¼Ÿ</p><p>æ€è·¯ä¸€ï¼šæœ‰ä¸‰ç§å®ç°æ–¹å¼</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepareForReuse</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.prepareForReuse()</span><br><span class="line"><span class="comment">// Clean Rx subscriptions</span></span><br><span class="line">  disposeBag = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bind</span><span class="params">(to viewModel: ViewModel)</span></span> &#123;</span><br><span class="line">  <span class="keyword">let</span> bag = <span class="type">DisposeBag</span>()</span><br><span class="line">  nameTextField.rx</span><br><span class="line">      .text</span><br><span class="line">      .orEmpty</span><br><span class="line">      .bind(to: viewModel.input.name)</span><br><span class="line">      .disposed(by: bag)</span><br><span class="line">  disposeBag = bag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepareForReuse</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.prepareForReuse()</span><br><span class="line"><span class="comment">// Clean Rx subscriptions</span></span><br><span class="line">  disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰é‚£ç§ ä½¿ç”¨ swizzle <a href="https://github.com/bmoliveira/Cell-Rx" target="_blank" rel="noopener">cell-rx</a></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UITableViewCell</span>: <span class="title">SelfAware</span> </span>&#123;</span><br><span class="line">  <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">rx_prepareForReuse</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.rx_prepareForReuse()</span><br><span class="line">    rx_reusableDisposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">swizzle</span>() </span>&#123;</span><br><span class="line">    <span class="comment">// make sure this isn't a subclass</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">self</span> === <span class="type">UITableViewCell</span>.<span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">self</span>.swizzleMethodForSelector(#selector(<span class="keyword">self</span>.prepareForReuse), withMethodForSelector: #selector(<span class="keyword">self</span>.rx_prepareForReuse))</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">awake</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">UITableViewCell</span>.swizzle()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>or è‡ªå®šä¹‰ Rx extensionï¼Œä½¿ç”¨ takeUntil(rx.prepareReuse)</p><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="https://medium.com/blablacar-tech/rxswift-mvvm-66827b8b3f10" target="_blank" rel="noopener">RxSwift + MVVM: how to feed ViewModels</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>swift è¯­æ³•å°è®°</title>
      <link href="/2018/02/09/swift%20%E8%AF%AD%E6%B3%95/swift-%E8%AF%AD%E6%B3%95%E5%B0%8F%E8%AE%B0/"/>
      <url>/2018/02/09/swift%20%E8%AF%AD%E6%B3%95/swift-%E8%AF%AD%E6%B3%95%E5%B0%8F%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="swift-è¯­æ³•"><a class="markdownIt-Anchor" href="#swift-è¯­æ³•"></a> Swift è¯­æ³•</h2><h3 id="swift-ä¸­ä½ç§»æšä¸¾å¦‚ä½•è¡¨ç¤º"><a class="markdownIt-Anchor" href="#swift-ä¸­ä½ç§»æšä¸¾å¦‚ä½•è¡¨ç¤º"></a> Swift ä¸­ä½ç§»æšä¸¾å¦‚ä½•è¡¨ç¤º</h3><p>OC ä¸­ä½ç§»æšä¸¾</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½ç§»æšä¸¾</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, Direction) &#123;</span><br><span class="line">    Top       = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,   <span class="comment">// 0000 0001,</span></span><br><span class="line">    Bottom    = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,   <span class="comment">// 0000 0010,</span></span><br><span class="line">    Left      = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,   <span class="comment">// 0000 0100,</span></span><br><span class="line">    Right     = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,   <span class="comment">// 0000 1000,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Swiftä¸­ä½ç§»æšä¸¾,æ›¿æ¢æ–¹æ¡ˆæ˜¯é€‰é¡¹é›†åˆ(OptionSet)</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Direction</span>: <span class="title">OptionSet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> rawValue: <span class="type">UInt</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> top = <span class="type">Direction</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> bottom = <span class="type">Direction</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> <span class="keyword">left</span> = <span class="type">Direction</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> <span class="keyword">right</span> = <span class="type">Direction</span>(rawValue: <span class="number">1</span> &lt;&lt; <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åœ¨<span class="type">Swift</span>å°±ä¸å†ä½¿ç”¨ &amp;, | è¿ç®—äº†ï¼Œ å¦‚æœæƒ³ä½¿ç”¨å¤šé€‰ï¼Œéœ€è¦ç”¨æ•°ç»„ä»£æ›¿ï¼Œä¾‹å¦‚</span><br><span class="line"></span><br><span class="line">```swift</span><br><span class="line"><span class="keyword">let</span> options: <span class="type">Direction</span> = [.top, .bottom]  <span class="comment">// ä¸OCä¸­ Top | Bottom ç›¸åŒçš„ä½œç”¨</span></span><br><span class="line">options.<span class="built_in">contains</span>(.top)</span><br><span class="line">options.<span class="built_in">contains</span>(.<span class="keyword">left</span>)</span><br></pre></td></tr></table></figure><h3 id="counter-loop"><a class="markdownIt-Anchor" href="#counter-loop"></a> Counter loop</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="number">10</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = (<span class="number">0</span>..&lt;<span class="number">10</span>).generate()</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> i = g.next() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// iterate over every other integer</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>.<span class="built_in">stride</span>(to: <span class="number">10</span>, by: <span class="number">2</span>) &#123; <span class="built_in">print</span>(i) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip a specific number</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (<span class="number">0</span>..&lt;<span class="number">10</span>).<span class="built_in">filter</span>(&#123; $<span class="number">0</span> != <span class="number">5</span> &#125;) &#123; <span class="built_in">print</span>(i) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = [<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>,<span class="string">"four"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok so this oneâ€™s a bit convoluted...</span></span><br><span class="line"><span class="keyword">let</span> everyOther = a.<span class="built_in">enumerate</span>().<span class="built_in">filter</span> &#123; $<span class="number">0.0</span> % <span class="number">2</span> == <span class="number">0</span> &#125;.<span class="built_in">map</span> &#123; $<span class="number">0.1</span> &#125;.<span class="built_in">lazy</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> everyOther &#123;</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘ç¬¦"><a class="markdownIt-Anchor" href="#ç¼–è¯‘ç¬¦"></a> ç¼–è¯‘ç¬¦</h3><p>@discardableResult</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a: Int, b: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line">sum(a: <span class="number">1</span>, b: <span class="number">2</span>) <span class="comment">// Result of call to 'sum(a:b:)' is unused</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¡¨ç¤ºå–æ¶ˆä¸ä½¿ç”¨è¿”å›å€¼çš„è­¦å‘Š</span></span><br><span class="line"><span class="meta">@discardableResult</span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a: Int, b: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line">sum(a: <span class="number">1</span>, b: <span class="number">2</span>) <span class="comment">// No longer produce the warning</span></span><br></pre></td></tr></table></figure><p>åœ¨ Objective-cä¸­</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)greeting __attribute__((warn_unused_result));</span><br></pre></td></tr></table></figure><h3 id="string"><a class="markdownIt-Anchor" href="#string"></a> String</h3><p>ä½¿ç”¨ String(describing: Class.self) æ–¹æ³• ä»£æ›¿ NSStringFromClass å¾—åˆ° ç±»çš„å­—ç¬¦ä¸²</p><h3 id="gcd"><a class="markdownIt-Anchor" href="#gcd"></a> GCD</h3><h4 id="once"><a class="markdownIt-Anchor" href="#once"></a> once</h4><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> å¼€å‘è¯­è¨€ </category>
          
          <category> swift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Texture æµ…æ</title>
      <link href="/2018/02/09/Texture-%E6%B5%85%E6%9E%90/"/>
      <url>/2018/02/09/Texture-%E6%B5%85%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><h2 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h2><p><code>ASDisplayNode</code> æ˜¯ <code>UIView</code> çš„æŠ½è±¡å±‚, å°±åƒ <code>UIView</code> æ˜¯ <code>CALayer</code> çš„æŠ½è±¡å±‚ä¸€æ ·. ä¸åŒçš„æ˜¯ UIKit åªèƒ½è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œnodes æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨åå°çº¿ç¨‹ä¸Šå¹¶è¡Œå®ä¾‹åŒ–å’Œé…ç½®å®ƒä»¬çš„æ•´ä¸ªå±‚æ¬¡ç»“æ„ã€‚</p><p><img src="/img/Texture.jpg" alt="texture_node"></p><h2 id="å­ç±»åŒ–"><a class="markdownIt-Anchor" href="#å­ç±»åŒ–"></a> å­ç±»åŒ–</h2><h3 id="è‡ªå®šä¹‰-asdisplaynode-å­ç±»"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰-asdisplaynode-å­ç±»"></a> è‡ªå®šä¹‰ ASDisplayNode å­ç±»</h3><p>å¦‚æœæƒ³ä½¿ç”¨ Textureï¼Œéœ€è¦è‡ªå®šä¹‰ç±»ç»§æ‰¿è‡ª <code>ASDisplayNode</code> éœ€è¦æ³¨æ„æ–¹æ³•ï¼š</p><p>æ³¨æ„ï¼šUIKit ç›¸å…³å±æ€§æ–¹æ³•åªèƒ½åœ¨ main thread ä¸­ä½¿ç”¨ï¼Œæ³¨æ„ <code>ASDisplayNode</code> æ–¹æ³•åœ¨ main/background thread ä¸­å®ç°å¾ˆé‡è¦</p><table><thead><tr><th>ASDisplayNodeæ–¹æ³•</th><th>çº¿ç¨‹</th><th>åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td>init</td><td>background</td><td>è¿™ä¸ªæ–¹æ³•å¾ˆå°‘ç”¨ï¼ˆå› ä¸ºbackgroundï¼‰ï¼Œä½¿ç”¨ nodeBlocks çš„æ—¶è°ƒç”¨ï¼Œåˆå§‹åŒ–æ–¹æ³•è°ƒç”¨æ‰å¯ä»¥è°ƒç”¨å…¶ä»–æ–¹æ³•</td></tr><tr><td>didLoad</td><td>main</td><td>ç±»ä¼¼ viewDidLoadï¼Œæ·»åŠ  UIKit objectsåˆå§‹åŒ–ï¼Œé…ç½®objects å±æ€§ï¼Œäº‹ä»¶â€¦â€¦</td></tr><tr><td>layoutSpecThatFits</td><td>background</td><td>å¸ƒå±€ä»£ç (è¿”å› layout spec objectå¸ƒå±€nodes)ï¼Œlayout spec object å¯¹è±¡ä¸ä¼šcacheï¼Œè€Œæ˜¯åœ¨åˆé€‚(å•¥æ—¶å€™ï¼Ÿ)çš„æ—¶å€™è°ƒç”¨é‡æ–°åˆ›å»º</td></tr><tr><td>layout</td><td>main</td><td>è°ƒç”¨ super.layout æ–¹æ³•ä¼šè°ƒç”¨layoutSpecThatFitsï¼Œè¿™æ ·æ‰€æœ‰çš„ nodes éƒ½ä¼šå¸ƒå±€å®Œæˆï¼Œç±»ä¼¼ viewWillLayoutSubviews æ–¹æ³•ï¼Œå¾ˆå°‘ä½¿ç”¨ï¼Œå¦‚æœæƒ³è¿™æ ·subnode.frame = self.bounds é‚£å°±ç”¨å§</td></tr></tbody></table><h3 id="è‡ªå®šä¹‰-asviewcontroller-å­ç±»"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰-asviewcontroller-å­ç±»"></a> è‡ªå®šä¹‰ ASViewController å­ç±»</h3><p><code>ASViewController</code> æ˜¯ <code>UIViewController</code> çš„å­ç±»ï¼Œæ‰€ä»¥ <code>ASViewController</code> éœ€è¦åœ¨ main thread ä¸­ä½¿ç”¨ã€‚</p><p><code>ASViewController</code> ç®¡ç† node å°±åƒ <code>UIViewController</code> ç®¡ç† view ä¸€æ ·<br>ä½†æ˜¯ <code>ASViewController</code> çš„æŒ‡æ´¾æ„é€ å‡½æ•°ä¸ UIViewController ä¸åŒ</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span>() &#123;</span><br><span class="line">  <span class="keyword">let</span> pagerNode = <span class="type">ASPagerNode</span>()</span><br><span class="line">  <span class="keyword">super</span>.<span class="keyword">init</span>(node: pagerNode)</span><br><span class="line"></span><br><span class="line">  pagerNode.setDataSource(<span class="keyword">self</span>)</span><br><span class="line">  pagerNode.setDelegate(<span class="keyword">self</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>-loadView</strong><br>åœ¨ loadView å¦‚æœä½ ä¸æ”¹å˜ <code>self.view</code> çš„å€¼ï¼Œå°±å¯ä»¥ï¼Œä¸è¿‡å»ºè®®ä½ ä½¿ç”¨ <code>viewDidLoad</code> æ–¹æ³•. è°ƒç”¨ [super loadView] ä¼šè®¾ç½® <code>node.view</code> .</p><p><strong>-viewDidLoad</strong><br>åœ¨ <code>ASViewController</code> çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä¸ªæ–¹æ³•åªä¼šï¼Œåœ¨ <code>loadView</code> è°ƒç”¨ä»¥åç«‹å³è°ƒç”¨ä¸€æ¬¡ã€‚é‚£äº›åªä¼šè°ƒç”¨ä¸€æ¬¡çš„é…ç½®æ”¾åœ¨è¿™é‡Œæœ€å¥½ã€‚</p><p>å¸ƒå±€ä»£ç ä¸åº”è¯¥æ”¾åœ¨è¿™é‡Œï¼Œå› ä¸ºå‡ ä½•å…ƒç´ æ”¹å˜è¿™ä¸ªæ–¹æ³•ä¸ä¼šè°ƒç”¨ï¼ˆå½“ç„¶å¯ä»¥åœ¨viewDidLoadä¸­é…ç½®ç›‘å¬è€…æ¨¡å¼ç›‘å¬ï¼‰</p><p><strong>-viewWillLayoutSubviews</strong><br>è¯¥æ–¹æ³•ä¸ <code>node</code> çš„ <code>-layout</code> æ–¹æ³•åœ¨åŒä¸€æ—¶é—´è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨ASViewControllerçš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ã€‚<br>åªè¦ ASViewController çš„ node çš„ bounds æ”¹å˜ï¼ˆåŒ…æ‹¬æ—‹è½¬ï¼Œåˆ†å±ï¼Œé”®ç›˜æ˜¾ç¤ºï¼‰ï¼Œä»¥åŠå±‚æ¬¡ç»“æ„å‘ç”Ÿäº†æ›´æ”¹ï¼ˆæ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹äº† childrenï¼‰ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨<br>ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œæœ€ä½³åšæ³•æ˜¯å°†æ‰€æœ‰å¸ƒå±€ä»£ç æ”¾å…¥æ­¤æ–¹æ³•ä¸­ã€‚å› ä¸ºå®ƒçš„è°ƒç”¨é¢‘ç‡ä¸é«˜ï¼Œæ‰€ä»¥ä¸ç›´æ¥ä¾èµ–äºå¤§å°çš„ä»£ç ä¹Ÿå±äºæ­¤å¤„ã€‚</p><p><strong>-viewWillAppear: / -viewDidDisappear:</strong><br>è¿™äº›æ–¹æ³•åœ¨ASViewControllerçš„nodeå‡ºç°åœ¨å±å¹•ä¸Šä¹‹å‰ï¼ˆæœ€æ—©å¯è§ï¼‰å’Œåˆšä»è§†å›¾å±‚æ¬¡ç»“æ„ä¸­åˆ é™¤ä¹‹åï¼ˆä¸å†å¯è§çš„æœ€æ—©æ—¶é—´ï¼‰è¢«è°ƒç”¨ã€‚è¿™äº›æ–¹æ³•æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šæ¥å¯åŠ¨æˆ–åœæ­¢ä¸æ§åˆ¶å™¨çš„æ¼”ç¤ºæˆ–è§£é›‡æœ‰å…³çš„åŠ¨ç”»ã€‚è¿™ä¹Ÿæ˜¯è®°å½•ç”¨æˆ·æ“ä½œçš„å¥½åœ°æ–¹ã€‚</p><p>å°½ç®¡å¯ä»¥å¤šæ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•å¹¶ä¸”å¯ä»¥è·å–å‡ ä½•å›¾å½¢ä¿¡æ¯ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¸ºæ‰€æœ‰å‡ ä½•å›¾å½¢æ›´æ”¹è°ƒç”¨å®ƒä»¬ï¼Œå› æ­¤ï¼Œä¸åº”å°†å®ƒä»¬ç”¨äºæ ¸å¿ƒå¸ƒå±€ä»£ç ï¼ˆè¶…å‡ºç‰¹å®šåŠ¨ç”»æ‰€éœ€çš„è®¾ç½®ï¼‰ã€‚</p><h2 id="å¸ƒå±€"><a class="markdownIt-Anchor" href="#å¸ƒå±€"></a> å¸ƒå±€</h2><h2 id="node-æ˜¯å¦‚ä½•ç»˜åˆ¶çš„"><a class="markdownIt-Anchor" href="#node-æ˜¯å¦‚ä½•ç»˜åˆ¶çš„"></a> Node æ˜¯å¦‚ä½•ç»˜åˆ¶çš„</h2><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="http://texturegroup.org/" target="_blank" rel="noopener">Texture</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> UI å¸ƒå±€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swift </tag>
            
            <tag> Texture </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift å­¦ä¹ ç¬”è®°</title>
      <link href="/2018/02/06/RxSwfit+RAC/RxSwift-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/02/06/RxSwfit+RAC/RxSwift-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="å­¦ä¹ ç›®çš„"><a class="markdownIt-Anchor" href="#å­¦ä¹ ç›®çš„"></a> å­¦ä¹ ç›®çš„</h2><ol><li>çŸ¥é“ rxswift éƒ½æœ‰ä»€ä¹ˆ</li><li>çŸ¥é“ä»–ä»¬éƒ½æ€ä¹ˆç”¨</li><li>çŸ¥é“ä¸ºä»€ä¹ˆæœ‰è¿™äº›ä¸œè¥¿</li><li>æ ¹ç±»å½’çº³æ•´ç†</li><li>å¦‚ä½•è‡ªå·±æ‰©å±•</li><li>é€‚å½“åˆ†ææºç </li></ol><h2 id="ä¸»è¦æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#ä¸»è¦æ¦‚å¿µ"></a> ä¸»è¦æ¦‚å¿µ</h2><ol><li>å¯ç›‘å¬åºåˆ—(ä¿¡å·)</li><li>operator(ä¿¡å·å˜æ¢&amp;ç»„åˆ)</li><li>observer(è§‚å¯Ÿè€…)</li><li>è®¢é˜…ï¼ˆç»‘å®šï¼‰</li><li>Disposableå–æ¶ˆè®¢é˜…</li></ol><h2 id="å¦‚ä½•åˆ›å»ºä¿¡å·"><a class="markdownIt-Anchor" href="#å¦‚ä½•åˆ›å»ºä¿¡å·"></a> å¦‚ä½•åˆ›å»ºä¿¡å·</h2><h3 id="å¯ç›‘å¬åºåˆ—"><a class="markdownIt-Anchor" href="#å¯ç›‘å¬åºåˆ—"></a> å¯ç›‘å¬åºåˆ—</h3><p>event</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">case</span> next(<span class="type">Element</span>) </span><br><span class="line">  <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>) </span><br><span class="line">  <span class="keyword">case</span> completed </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> numbers: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = <span class="type">Observable</span>.create &#123; observer -&gt; <span class="type">Disposable</span> <span class="keyword">in</span></span><br><span class="line">  observer.onNext(<span class="number">0</span>)</span><br><span class="line">  observer.onNext(<span class="number">1</span>)</span><br><span class="line">  observer.onCompleted()</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;.just(one)</span><br><span class="line"><span class="type">Observable</span>.of(one, two, three)</span><br><span class="line"><span class="type">Observable</span>.from([one, two, three])</span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">Void</span>&gt;.empty()</span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">Any</span>&gt;.never()</span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">Int</span>&gt;.range(start: <span class="number">1</span>, <span class="built_in">count</span>: <span class="number">10</span>)</span><br><span class="line"><span class="type">Observable</span>&lt;<span class="type">String</span>&gt;.create</span><br></pre></td></tr></table></figure><h3 id="ç‰¹å¾åºåˆ—"><a class="markdownIt-Anchor" href="#ç‰¹å¾åºåˆ—"></a> ç‰¹å¾åºåˆ—</h3><h4 id="single"><a class="markdownIt-Anchor" href="#single"></a> Single</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingleEvent</span>&lt;<span class="title">Element</span>&gt; </span>&#123; </span><br><span class="line">  <span class="keyword">case</span> success(<span class="type">Element</span>) </span><br><span class="line">  <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œæˆ–â¼€ä¸ªerror äº‹ä»¶</li><li>ä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤</li></ul><p>â¼€ä¸ªâ½è¾ƒå¸¸â»…çš„ä¾‹â¼¦å°±æ˜¯æ‰§â¾ HTTP è¯·æ±‚ï¼Œç„¶åè¿”å›â¼€ä¸ªåº”ç­”æˆ–é”™è¯¯ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥â½¤ Single æ¥æè¿°ä»»ä½•åªæœ‰â¼€ä¸ªå…ƒç´ çš„åºåˆ—ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRepo</span><span class="params">(<span class="number">_</span> repo: String)</span></span> -&gt; <span class="type">Single</span>&lt;[<span class="type">String</span>: <span class="type">Any</span>]&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Single</span>&lt;[<span class="type">String</span>: <span class="type">Any</span>]&gt;.create &#123; single <span class="keyword">in</span> </span><br><span class="line">    <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://api.github.com/repos/\(repo)"</span>)! </span><br><span class="line">    <span class="keyword">let</span> task = <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; data, <span class="number">_</span>, error <span class="keyword">in</span> </span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123; </span><br><span class="line">        single(.error(error)) </span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> data = data, </span><br><span class="line">            <span class="keyword">let</span> json = <span class="keyword">try</span>? <span class="type">JSONSerialization</span>.jsonObject(with: data, options: .mutableLeaves), </span><br><span class="line">            <span class="keyword">let</span> result = json <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">else</span> &#123; </span><br><span class="line">        single(.error(<span class="type">DataError</span>.cantParseJSON)) </span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">      &#125;</span><br><span class="line">      single(.success(result)) </span><br><span class="line">    &#125; </span><br><span class="line">    task.resume() </span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123; task.cancel() &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¯¹ Observable è°ƒâ½¤ .asSingle() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Singleã€‚</p><h4 id="completable"><a class="markdownIt-Anchor" href="#completable"></a> Completable</h4><ul><li>æ²¡æœ‰ next æ—¶é—´</li><li>å‘å‡º completed æˆ–error äº‹ä»¶</li><li>ä¸ä¼šå…±äº«é™„åŠ ä½œ</li></ul><p>Completable é€‚â½¤äºé‚£ç§ä½ åªå…³â¼¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œâ½½ä¸éœ€è¦åœ¨æ„ä»»åŠ¡è¿”å›å€¼çš„æƒ…å†µã€‚å®ƒå’Œ Observable<void>æœ‰ç‚¹ç›¸ä¼¼ã€‚</void></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cacheLocally</span><span class="params">()</span></span> -&gt; <span class="type">Completable</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Completable</span>.create &#123; completable <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// Store some data locally</span></span><br><span class="line">    ... </span><br><span class="line">    ... </span><br><span class="line">    <span class="keyword">guard</span> success <span class="keyword">else</span> &#123;</span><br><span class="line">      completable(.error(<span class="type">CacheError</span>.failedCaching))</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    completable(.completed)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="maybe"><a class="markdownIt-Anchor" href="#maybe"></a> Maybe</h4><ul><li>å‘å‡ºâ¼€ä¸ªnextï¼Œcompletedæˆ–error äº‹ä»¶</li><li>ä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤</li></ul><p>å¦‚æœä½ é‡åˆ°é‚£ç§å¯èƒ½éœ€è¦å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œâ¼œå¯èƒ½ä¸éœ€è¦å‘å‡ºæ—¶ï¼Œå°±å¯ä»¥ä½¿â½¤ Maybeã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateString</span><span class="params">()</span></span> -&gt; <span class="type">Maybe</span>&lt;<span class="type">String</span>&gt; &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="type">Maybe</span>&lt;<span class="type">String</span>&gt;.create &#123; maybe <span class="keyword">in</span> </span><br><span class="line">    maybe(.success(<span class="string">"RxSwift"</span>)) </span><br><span class="line">    <span class="comment">// OR </span></span><br><span class="line">    maybe(.completed) </span><br><span class="line">    <span class="comment">// OR </span></span><br><span class="line">    maybe(.error(error)) </span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;&#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥å¯¹ Observable è°ƒâ½¤ .asMaybe() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Maybeã€‚</p><h4 id="driver"><a class="markdownIt-Anchor" href="#driver"></a> Driver</h4><p>ä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ– UI å±‚çš„ä»£ç </p><ul><li>ä¸ä¼šäº§â½£ error äº‹ä»¶</li><li>â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰</li><li>å…±äº«é™„åŠ ä½œâ½¤</li></ul><p>ä½¿ç”¨ driver çš„åŸå› </p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> results = query.rx.text </span><br><span class="line">  .throttle(<span class="number">0.3</span>, scheduler: <span class="type">MainScheduler</span>.instance) </span><br><span class="line">  .flatMapLatest &#123; query <span class="keyword">in</span> </span><br><span class="line">  fetchAutoCompleteItems(query) </span><br><span class="line">    .observeOn(<span class="type">MainScheduler</span>.instance) <span class="comment">// ç»“æœåœ¨ä¸»çº¿ç¨‹è¿”å› </span></span><br><span class="line">    .catchErrorJustReturn([]) <span class="comment">// é”™è¯¯è¢«å¤„ç†äº†ï¼Œè¿™æ ·â¾„å°‘ä¸ä¼šç»ˆâ½Œæ•´ä¸ªåºåˆ— </span></span><br><span class="line">  &#125; </span><br><span class="line">  .share(replay: <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP è¯·æ±‚æ˜¯è¢«å…±äº«çš„</span></span><br><span class="line">results</span><br><span class="line">  .<span class="built_in">map</span> &#123; <span class="string">"\($0.count)"</span> &#125;</span><br><span class="line">  .bind(to: resultCount.rx.text)</span><br><span class="line">  .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">  .bind(to: resultsTableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; (<span class="number">_</span>, result, cell) <span class="keyword">in</span> </span><br><span class="line">    cell.textLabel?.text = <span class="string">"\(result)"</span></span><br><span class="line">  &#125;</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ drive</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> results = query.rx.text.asDriver() <span class="comment">// å°†ControlProperty è½¬æ¢ä¸º Driver</span></span><br><span class="line">  .throttle(<span class="number">0.3</span>, scheduler: <span class="type">MainScheduler</span>.instance) </span><br><span class="line">  .flatMapLatest &#123; query <span class="keyword">in</span> </span><br><span class="line">    fetchAutoCompleteItems(query) </span><br><span class="line">    .asDriver(onErrorJustReturn: []) <span class="comment">// ä»…ä»…æä¾›å‘â½£é”™è¯¯æ—¶çš„å¤‡é€‰è¿”å›å€¼ </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">results </span><br><span class="line">  .<span class="built_in">map</span> &#123; <span class="string">"\($0.count)"</span> &#125; </span><br><span class="line">  .drive(resultCount.rx.text) <span class="comment">// è¿™â¾¥æ”¹â½¤ `drive` â½½ä¸æ˜¯ `bindTo`</span></span><br><span class="line">  .disposed(by: disposeBag) <span class="comment">// è¿™æ ·å¯ä»¥ç¡®ä¿å¿…å¤‡æ¡ä»¶éƒ½å·²ç»æ»¡â¾œäº†</span></span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">  .drive(resultsTableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; (<span class="number">_</span>, result, cell) <span class="keyword">in</span> </span><br><span class="line">    cell.textLabel?.text = <span class="string">"\(result)"</span> </span><br><span class="line">  &#125;</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><h4 id="signal"><a class="markdownIt-Anchor" href="#signal"></a> Signal</h4><p>Signal å’Œ Driver ç›¸ä¼¼ï¼Œå”¯â¼€çš„åŒºåˆ«æ˜¯ï¼ŒDriver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ï¼ˆé‡æ–°å‘é€ï¼‰ä¸Šâ¼€ä¸ªå…ƒç´ ï¼Œâ½½ Signal ä¸ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ã€‚</p><ul><li>ä¸ä¼šäº§â½£ error äº‹ä»¶</li><li>â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰</li><li>å…±äº«é™„åŠ ä½œâ½¤</li></ul><p>â¼€èˆ¬æƒ…å†µä¸‹çŠ¶æ€åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Driver è¿™ä¸ªç±»å‹ï¼Œäº‹ä»¶åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Signal è¿™ä¸ªç±»å‹ã€‚</p><h4 id="controlevent"><a class="markdownIt-Anchor" href="#controlevent"></a> ControlEvent</h4><p>ControlEvent ä¸“â»”â½¤äºæè¿° UI æ§ä»¶æ‰€äº§â½£çš„äº‹ä»¶ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><ul><li>ä¸ä¼šäº§â½£ error äº‹ä»¶</li><li>â¼€å®šåœ¨ MainScheduler</li><li>â¼€å®šåœ¨ MainScheduler è®¢é˜…ï¼ˆä¸»çº¿ç¨‹è®¢é˜…ï¼‰ ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰</li><li>å…±äº«é™„åŠ ä½œâ½¤</li></ul><h3 id="è§‚å¯Ÿè€…-anyobserver"><a class="markdownIt-Anchor" href="#è§‚å¯Ÿè€…-anyobserver"></a> è§‚å¯Ÿè€… AnyObserver</h3><h4 id="ç‰¹å¾è§‚å¯Ÿè€…-binder"><a class="markdownIt-Anchor" href="#ç‰¹å¾è§‚å¯Ÿè€…-binder"></a> ç‰¹å¾è§‚å¯Ÿè€… Binder</h4><ul><li>ä¸ä¼šå¤„ç†é”™è¯¯äº‹ä»¶</li><li>ç¡®ä¿ç»‘å®šéƒ½æ˜¯åœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼ˆé»˜è®¤ MainSchedulerï¼‰</li><li>åªå¤„ç† next äº‹ä»¶</li></ul><p>åœ¨ä»‹ç» AnyObserver æ—¶ï¼Œæˆ‘ä»¬ä¸¾äº†è¿™æ ·â¼€ä¸ªä¾‹â¼¦ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer: <span class="type">AnyObserver</span>&lt;<span class="type">Bool</span>&gt; = <span class="type">AnyObserver</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (event) <span class="keyword">in</span> </span><br><span class="line">  <span class="keyword">switch</span> event &#123; </span><br><span class="line">    <span class="keyword">case</span> .next(<span class="keyword">let</span> isHidden): </span><br><span class="line">      <span class="keyword">self</span>?.usernameValidOutlet.isHidden = isHidden </span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">      <span class="keyword">break</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">usernameValid </span><br><span class="line">  .bind(to: observer) </span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªè§‚å¯Ÿè€…æ˜¯â¼€ä¸ª UI è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥å®ƒåœ¨å“åº”äº‹ä»¶æ—¶ï¼Œåªä¼šå¤„ç† next äº‹ä»¶ï¼Œå¹¶ä¸”æ›´æ–° UI çš„æ“ä½œéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§â¾ã€‚<br>å› æ­¤â¼€ä¸ªæ›´å¥½çš„â½…æ¡ˆå°±æ˜¯ä½¿â½¤ Binderï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer: <span class="type">Binder</span>&lt;<span class="type">Bool</span>&gt; = <span class="type">Binder</span>(usernameValidOutlet) &#123; (view, isHidden) <span class="keyword">in</span></span><br><span class="line">  view.isHidden = isHidden </span><br><span class="line">&#125; </span><br><span class="line">usernameValid </span><br><span class="line">  .bind(to: observer) </span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>Binder å¯ä»¥åªå¤„ç† next äº‹ä»¶ï¼Œå¹¶ä¸”ä¿è¯å“åº” next äº‹ä»¶çš„ä»£ç ä¸€å®šä¼šåœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼Œè¿™â¾¥é‡‡â½¤é»˜è®¤çš„ MainSchedulerã€‚</p><ul><li>å¤ç”¨</li></ul><p>ç”±äºâ»šâ¾¯æ˜¯å¦éšè—æ˜¯â¼€ä¸ªå¸¸â½¤çš„è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥åº”è¯¥è®©æ‰€æœ‰çš„ UIView éƒ½æä¾›è¿™ç§è§‚å¯Ÿè€…ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UIView</span> </span>&#123; </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">var</span> isHidden: <span class="type">Binder</span>&lt;<span class="type">Bool</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="type">Binder</span>(<span class="keyword">self</span>.base) &#123; view, hidden <span class="keyword">in</span> </span><br><span class="line">      view.isHidden = hidden </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----</span></span><br><span class="line">usernameValid </span><br><span class="line">  .bind(to: usernameValidOutlet.rx.isHidden) </span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><h3 id="å³ä½¿è§‚å¯Ÿåºåˆ—åˆæ˜¯è§‚å¯Ÿè€…"><a class="markdownIt-Anchor" href="#å³ä½¿è§‚å¯Ÿåºåˆ—åˆæ˜¯è§‚å¯Ÿè€…"></a> å³ä½¿è§‚å¯Ÿåºåˆ—åˆæ˜¯è§‚å¯Ÿè€…</h3><h4 id="asyncsubject"><a class="markdownIt-Anchor" href="#asyncsubject"></a> AsyncSubject</h4><h4 id="publishsubject"><a class="markdownIt-Anchor" href="#publishsubject"></a> PublishSubject</h4><h4 id="replaysubject"><a class="markdownIt-Anchor" href="#replaysubject"></a> ReplaySubject</h4><h4 id="behaviorsubject"><a class="markdownIt-Anchor" href="#behaviorsubject"></a> BehaviorSubject</h4><h4 id="controlproperty"><a class="markdownIt-Anchor" href="#controlproperty"></a> ControlProperty</h4><h4 id="rxrelay"><a class="markdownIt-Anchor" href="#rxrelay"></a> RxRelay</h4><h4 id="publishrelay"><a class="markdownIt-Anchor" href="#publishrelay"></a> PublishRelay</h4><p>PublishRelay å°±æ˜¯ PublishSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError æˆ– onCompleted ã€‚</p><h4 id="behaviorrelay"><a class="markdownIt-Anchor" href="#behaviorrelay"></a> BehaviorRelay</h4><p>BehaviorRelay å°±æ˜¯ BehaviorSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ æ¼”ç¤º onError æˆ– onCompleted ã€‚</p><h3 id="å¦‚ä½•é€‰æ‹©operator"><a class="markdownIt-Anchor" href="#å¦‚ä½•é€‰æ‹©operator"></a> å¦‚ä½•é€‰æ‹©operator</h3><p><strong>Observable åˆ›å»º</strong></p><ul><li>äº§â½£ç‰¹å®šçš„â¼€ä¸ªå…ƒç´ ï¼šjust<ul><li>ç»è¿‡â¼€æ®µå»¶æ—¶ï¼štimer</li></ul></li><li>ä»â¼€ä¸ªåºåˆ—æ‹‰å–å…ƒç´ ï¼šfrom</li><li>é‡å¤çš„äº§â½£æŸâ¼€ä¸ªå…ƒç´ ï¼šrepeatElement</li><li>å­˜åœ¨â¾ƒå®šä¹‰é€»è¾‘ï¼šcreate</li><li>æ¯æ¬¡è®¢é˜…æ—¶äº§â½£ï¼šdeferred</li><li>æ¯éš”â¼€æ®µæ—¶é—´ï¼Œå‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼šinterval<ul><li>åœ¨â¼€æ®µå»¶æ—¶åï¼štimer</li></ul></li><li>â¼€ä¸ªç©ºåºåˆ—ï¼Œåªæœ‰â¼€ä¸ªå®Œæˆäº‹ä»¶ï¼šempty</li><li>â¼€ä¸ªä»»ä½•äº‹ä»¶éƒ½æ²¡æœ‰äº§â½£çš„åºåˆ—ï¼šnever</li></ul><p><strong>Observableç»„åˆ</strong></p><ul><li>ä»»æ„â¼€ä¸ª Observable äº§â½£äº†å…ƒç´ ï¼Œå°±å‘å‡ºè¿™ä¸ªå…ƒç´ ï¼šmerge</li><li>å½“ä¸Šâ¼€ä¸ª Observable æ‰èƒ½å¼€å§‹å‘å‡ºå…ƒç´ ï¼šconcat</li><li>ç»„åˆå¤šä¸ª Observables çš„å…ƒç´ <ul><li>å½“æ¯â¼€ä¸ª Observable éƒ½å‘å‡ºâ¼€ä¸ªæ–°çš„å…ƒç´ ï¼šzip</li><li>å½“ä»»æ„â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªæ–°çš„å…ƒç´ ï¼šcombineLatest</li></ul></li></ul><p><strong>Observableè½¬æ¢</strong></p><ul><li>å¯¹æ¯ä¸ªå…ƒç´ ç›´æ¥è½¬æ¢ï¼šmap</li><li>è½¬æ¢åˆ°å¦â¼€ä¸ª Observable ï¼šflatMap<ul><li>åªæ¥æ”¶æœ€æ–°çš„å…ƒç´ è½¬æ¢çš„ Observable æ‰€äº§â½£çš„å…ƒç´ ï¼šflatMapLatest</li><li>æ¯â¼€ä¸ªå…ƒç´ è½¬æ¢çš„ Observable æŒ‰é¡ºåºäº§â½£å…ƒç´ ï¼šconcatMap</li></ul></li><li>åŸºäºæ‰€æœ‰éå†è¿‡çš„å…ƒç´ ï¼šscan</li></ul><p><strong>åŸºäºæ—¶é—´åº</strong></p><ul><li>æ‹–å»¶â¼€æ®µæ—¶é—´åå†å‘å‡ºï¼šdelay</li></ul><p><strong>æƒ³è¦å°†äº§â½£çš„äº‹ä»¶å°è£…æˆå…ƒç´ å‘é€å‡ºæ¥</strong></p><ul><li>å°†ä»–ä»¬å°è£…æˆ Event<element>ï¼šmaterialize</element></li><li>ç„¶åè§£å°å‡ºæ¥ï¼šdematerialize</li></ul><p><strong>åŸºäºæ•°é‡çš„æ“ä½œ</strong></p><ul><li><p>å¿½ç•¥æ‰æ‰€æœ‰çš„ next äº‹ä»¶ï¼Œåªæ¥æ”¶ completed å’Œ error äº‹ä»¶ï¼šignoreElements</p></li><li><p>åˆ›å»ºâ¼€ä¸ªæ–°çš„ Observable åœ¨åŸæœ‰çš„åºåˆ—å‰â¾¯åŠ â¼Šâ¼€äº›å…ƒç´ ï¼šstartWith</p></li><li><p>æˆ‘æƒ³ä» Observable ä¸­æ”¶é›†å…ƒç´ ï¼Œç¼“å­˜è¿™äº›å…ƒç´ ä¹‹ååœ¨å‘å‡ºï¼šbuffer</p></li><li><p>æˆ‘æƒ³å°† Observable æ‹†åˆ†æˆå¤šä¸ª Observables ï¼šwindow</p><ul><li>åŸºäºå…ƒç´ çš„å…±åŒç‰¹å¾ï¼šgroupBy</li></ul></li><li><p>æˆ‘æƒ³åªæ¥æ”¶ Observable ä¸­ç‰¹å®šçš„å…ƒç´ </p><ul><li>å‘å‡ºå”¯â¼€çš„å…ƒç´ ï¼šsingle</li></ul></li><li><p>æˆ‘æƒ³é‡æ–°ä» Observable ä¸­å‘å‡ºæŸäº›å…ƒç´ </p><ul><li>é€šè¿‡åˆ¤å®šæ¡ä»¶è¿‡æ»¤å‡ºâ¼€äº›å…ƒç´ ï¼šfilter</li><li>ä»…å‘å‡ºå¤´â¼ä¸ªå…ƒç´ ï¼štake</li><li>ä»…å‘å‡ºå°¾éƒ¨çš„â¼ä¸ªå…ƒç´ ï¼štakeLast</li><li>ä»…ä»…å‘å‡ºç¬¬ n ä¸ªå…ƒç´ ï¼šelementAt</li></ul></li><li><p>è·³è¿‡å¤´â¼ä¸ªå…ƒç´ </p><ul><li>è·³è¿‡å¤´ n ä¸ªå…ƒç´ ï¼šskip</li><li>è·³è¿‡å¤´â¼ä¸ªæ»¡â¾œåˆ¤å®šçš„å…ƒç´ ï¼šskipWhileï¼ŒskipWhileWithIndex</li><li>è·³è¿‡æŸæ®µæ—¶é—´å†…äº§â½£çš„å¤´â¼ä¸ªå…ƒç´ ï¼šskip</li><li>è·³è¿‡å¤´â¼ä¸ªå…ƒç´ ç›´åˆ°å¦â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼šskipUntil</li></ul></li><li><p>åªå–å¤´â¼ä¸ªå…ƒç´ </p><ul><li>åªå–å¤´â¼ä¸ªæ»¡â¾œåˆ¤å®šçš„å…ƒç´ ï¼štakeWhileï¼ŒtakeWhileWithIndex</li><li>åªå–æŸæ®µæ—¶é—´å†…äº§â½£çš„å¤´â¼ä¸ªå…ƒç´ ï¼štake</li><li>åªå–å¤´â¼ä¸ªå…ƒç´ ç›´åˆ°å¦â¼€ä¸ª Observable å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼štakeUntil</li></ul></li><li><p>å‘¨æœŸæ€§çš„å¯¹ Observable æŠ½æ ·ï¼šsample</p></li><li><p>å‘å‡ºé‚£äº›å…ƒç´ ï¼Œè¿™äº›å…ƒç´ äº§â½£åçš„ç‰¹å®šçš„æ—¶é—´å†…ï¼Œæ²¡æœ‰æ–°çš„å…ƒç´ äº§â½£ï¼šdebounce</p></li><li><p>ç›´åˆ°å…ƒç´ çš„å€¼å‘â½£å˜åŒ–ï¼Œæ‰å‘å‡ºæ–°çš„å…ƒç´ ï¼šdistinctUntilChanged</p><ul><li>å¹¶æä¾›å…ƒç´ æ˜¯å¦ç›¸ç­‰çš„åˆ¤å®šå‡½æ•°ï¼šdistinctUntilChanged</li></ul></li><li><p>åœ¨å¼€å§‹å‘å‡ºå…ƒç´ æ—¶ï¼Œå»¶æ—¶åè¿›â¾è®¢é˜…ï¼šdelaySubscription</p></li><li><p>æˆ‘æƒ³è¦ä»â¼€äº› Observables ä¸­ï¼Œåªå–ç¬¬â¼€ä¸ªäº§â½£å…ƒç´ çš„ Observable ï¼šamb</p></li><li><p>æˆ‘æƒ³è¯„ä¼° Observable çš„å…¨éƒ¨å…ƒç´ </p><ul><li>å¹¶ä¸”å¯¹æ¯ä¸ªå…ƒç´ åº”â½¤èšåˆâ½…æ³•ï¼Œå¾…æ‰€æœ‰å…ƒç´ éƒ½åº”â½¤èšåˆâ½…æ³•åï¼Œå‘å‡ºç»“æœï¼šreduce</li><li>å¹¶ä¸”å¯¹æ¯ä¸ªå…ƒç´ åº”â½¤èšåˆâ½…æ³•ï¼Œæ¯æ¬¡åº”â½¤èšåˆâ½…æ³•åï¼Œå‘å‡ºç»“æœï¼šscan</li></ul></li><li><p>æˆ‘æƒ³åœ¨æŸä¸ª Scheduler åº”â½¤æ“ä½œç¬¦ï¼šsubscribeOn</p><ul><li>åœ¨æŸä¸ª Scheduler ç›‘å¬ï¼šobserveOn</li></ul></li><li><p>æˆ‘æƒ³è¦ Observable å‘â½£æŸä¸ªäº‹ä»¶æ—¶, é‡‡å–æŸä¸ªâ¾åŠ¨ï¼šdo</p></li><li><p>æˆ‘æƒ³è¦ Observable å‘å‡ºâ¼€ä¸ª error äº‹ä»¶ï¼šerror</p></li><li><p>å¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰äº§â½£å…ƒç´ ï¼štimeout</p></li><li><p>æˆ‘æƒ³è¦ Observable å‘â½£é”™è¯¯æ—¶ï¼Œä¼˜é›…çš„æ¢å¤</p><ul><li>å¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰äº§â½£å…ƒç´ ï¼Œå°±åˆ‡æ¢åˆ°å¤‡é€‰ Observable ï¼štimeout</li><li>å¦‚æœäº§â½£é”™è¯¯ï¼Œå°†é”™è¯¯æ›¿æ¢æˆæŸä¸ªå…ƒç´  ï¼šcatchErrorJustReturn</li><li>å¦‚æœäº§â½£é”™è¯¯ï¼Œå°±åˆ‡æ¢åˆ°å¤‡é€‰ Observable ï¼šcatchError</li><li>å¦‚æœäº§â½£é”™è¯¯ï¼Œå°±é‡è¯• ï¼šretry</li></ul></li><li><p>æˆ‘åˆ›å»ºâ¼€ä¸ª Disposable èµ„æºï¼Œä½¿å®ƒä¸ Observable å…·æœ‰ç›¸åŒçš„å¯¿å‘½ï¼šusing</p></li><li><p>æˆ‘åˆ›å»ºâ¼€ä¸ª Observable ï¼Œç›´åˆ°æˆ‘é€šçŸ¥å®ƒå¯ä»¥äº§â½£å…ƒç´ åï¼Œæ‰èƒ½äº§â½£å…ƒç´ ï¼špublish</p><ul><li>å¹¶ä¸”ï¼Œå°±ç®—æ˜¯åœ¨äº§â½£å…ƒç´ åè®¢é˜…ï¼Œä¹Ÿè¦å‘å‡ºå…¨éƒ¨å…ƒç´ ï¼šreplay</li><li>å¹¶ä¸”ï¼Œâ¼€æ—¦æ‰€æœ‰è§‚å¯Ÿè€…å–æ¶ˆè§‚å¯Ÿï¼Œä»–å°±è¢«é‡Šæ”¾æ‰ï¼šrefCount</li><li>é€šçŸ¥å®ƒå¯ä»¥äº§â½£å…ƒç´ äº†ï¼šconnect</li></ul></li></ul><h3 id="åŠ¨æ€ä¿¡å·"><a class="markdownIt-Anchor" href="#åŠ¨æ€ä¿¡å·"></a> åŠ¨æ€ä¿¡å·</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *s = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">  [subscriber sendCompleted];</span><br><span class="line">  <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line"></span><br><span class="line">  &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="cocoa-æ¡¥æ¥"><a class="markdownIt-Anchor" href="#cocoa-æ¡¥æ¥"></a> Cocoa æ¡¥æ¥</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) bridge &#123;</span><br><span class="line">  RACSignal *sO = RACObserver(<span class="keyword">self</span>, button);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.sigSetFrame = [<span class="keyword">self</span>.button rac_signalForSelector:<span class="keyword">@selector</span>(setFrame:)];</span><br><span class="line">  [_sigSetFrame</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"setFrame:%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">self</span>.sigClick = [<span class="keyword">self</span>.button rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">  [_sigClick</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"event: %@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line"></span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignals:_sigClick, <span class="literal">nil</span>]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalsFromArray:@[[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">  &#125;]]]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@<span class="number">1</span>)]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>) lift:(<span class="keyword">id</span>)value&#123;</span><br><span class="line">  printf(<span class="string">"lift: %s"</span>, __func__);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·å˜åŒ–å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„"><a class="markdownIt-Anchor" href="#ä¿¡å·å˜åŒ–å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„"></a> ä¿¡å·å˜åŒ–(å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„)</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">  <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—è½¬æ¢"><a class="markdownIt-Anchor" href="#åºåˆ—è½¬æ¢"></a> åºåˆ—è½¬æ¢</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.sigSequence = [[RACSequence <span class="keyword">return</span>:@<span class="number">3</span>] concat:[RACSequence <span class="keyword">return</span>:@<span class="number">4</span>]].signal;</span><br></pre></td></tr></table></figure><h2 id="è®¢é˜…ç»‘å®šä¿¡å·çš„æ–¹å¼"><a class="markdownIt-Anchor" href="#è®¢é˜…ç»‘å®šä¿¡å·çš„æ–¹å¼"></a> è®¢é˜…ï¼ˆç»‘å®šï¼‰ä¿¡å·çš„æ–¹å¼</h2><h3 id="ç›´æ¥è®¢é˜…æ–¹æ³•"><a class="markdownIt-Anchor" href="#ç›´æ¥è®¢é˜…æ–¹æ³•"></a> ç›´æ¥è®¢é˜…æ–¹æ³•</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.sigSample</span><br><span class="line"> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"sample: %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="ç»‘å®š"><a class="markdownIt-Anchor" href="#ç»‘å®š"></a> ç»‘å®š</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAC(<span class="keyword">self</span>, a) = Signal;</span><br></pre></td></tr></table></figure><h3 id="cocoa-æ¡¥æ¥-2"><a class="markdownIt-Anchor" href="#cocoa-æ¡¥æ¥-2"></a> Cocoa æ¡¥æ¥</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)signal &#123;</span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignals:_sigClick, <span class="literal">nil</span>]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalsFromArray:@[[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">  &#125;]]]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@<span class="number">1</span>)]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>) lift:(<span class="keyword">id</span>)value&#123;</span><br><span class="line">  printf(<span class="string">"lift: %s"</span>, __func__);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¿¡å·å˜åŒ–ç»„åˆ"><a class="markdownIt-Anchor" href="#ä¿¡å·å˜åŒ–ç»„åˆ"></a> ä¿¡å·å˜åŒ–&amp;ç»„åˆ</h2><ol><li>å•ä¸ªä¿¡å·çš„å˜åŒ–</li><li>å¤šä¸ªä¿¡å·çš„ç»„åˆ</li><li>é«˜é˜¶æ“ä½œ</li></ol><p><img src="/img/signal_transform.jpeg" alt="signal å˜åŒ–"></p><h3 id="å€¼æ“ä½œ"><a class="markdownIt-Anchor" href="#å€¼æ“ä½œ"></a> å€¼æ“ä½œ</h3><p>é—®é¢˜ï¼š</p><ul><li>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„å€¼æ“ä½œæ–¹æ³•ï¼Ÿ</li><li>è‡ªå·±å¦‚ä½•æ‰©å±•æ–°çš„å€¼æ–¹æ³•</li></ul><hr><ul><li>transform è¿™äº›ç”¨çš„æ¯”è¾ƒå¤š<ol><li>map</li><li>MapReplace</li><li>ReduceEach tuple(a, b) -&gt; c</li></ol></li><li>å€¼åˆ¤æ–­é€»è¾‘å˜æ¢<ol><li>not</li><li>and</li><li>or</li></ol></li><li>ç”¨çš„æ¯”è¾ƒå°‘<ol><li>reduceApply è¿™ä¸ªä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œç”¨combineLatest: reduceEach: å°±å¯ä»¥åšäº†ï¼Œè€Œä¸”ä»£ç çœ‹èµ·æ¥æ›´å¥½ã€‚</li><li>materialize</li><li>dematerialize</li></ol></li></ul><h3 id="æ•°é‡æ“ä½œ"><a class="markdownIt-Anchor" href="#æ•°é‡æ“ä½œ"></a> æ•°é‡æ“ä½œ</h3><ol><li>repeat ä¸€ç›´ä¼šæœ‰å€¼</li></ol><ul><li><p>æ¡ä»¶è¿‡æ»¤1</p><ol><li>ignore</li><li>ignoreValues</li><li>distinctUntilChanged</li></ol></li><li><p>æ¡ä»¶è¿‡æ»¤2</p><ol><li>takeUntilBlock:(BOOL (^)(id x))predicate</li><li>takeWhileBlock:(BOOL (^)(id x))predicate;</li><li>skipUntilBlock:(BOOL (^)(id x))predicate;</li><li>skipWhileBlock:(BOOL (^)(id x))predicate;</li></ol></li><li><p>æ•°é‡åˆ¤æ–­ï¼Œå¦‚æœæœ‰å€¼å°±å‘é€</p><ol><li>any;</li><li>any:(BOOL (^)(id object))predicateBlock;</li><li>all:(BOOL (^)(id object))predicateBlock;</li></ol></li><li><p>é‡è¯•</p><ol><li>retry</li><li>retry: Count</li><li>collect <code>æ±‡èš</code> ä¿¡å·å¿…é¡»æœ‰è¿”å›å€¼</li></ol></li></ul><p>å‰¯ä½œç”¨ï¼š<br>â€“ å¯¹äºä¿¡å·å€¼å˜åŒ–ä»¥å¤–çš„ä¸€äº›æ“ä½œ</p><ul><li>doNext</li><li>doCompleted</li><li>doError</li></ul><p><code>æŠ˜å å‡½æ•°</code></p><p>ä¸å¬å¯¹ä¸€ä¸ªvalue æ“ä½œï¼Œä½¿ç”¨æŠ˜å å‡½æ•°è§£å†³è¿™ä¸ªé—®é¢˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sig10 aggregateWithStart:@<span class="number">0</span> reduce:^<span class="keyword">id</span>(<span class="keyword">id</span> running, <span class="keyword">id</span> next) &#123;</span><br><span class="line">  <span class="keyword">return</span> @([running intValue] + [next intValue]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><ol><li>(RACSignal *)aggregateWithStart:(id)start reduce:(id (^)(id running, id next))reduceBlock;</li><li>(RACSignal *)aggregateWithStart:(id)start reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;</li><li>(RACSignal *)aggregateWithStartFactory:(id (^)(void))startFactory reduce:(id (^)(id running, id next))reduceBlock;</li><li>(instancetype)scanWithStart:(id)startingValue reduce:(id (^)(id running, id next))reduceBlock;</li><li>(instancetype)scanWithStart:(id)startingValue reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;</li></ol><h3 id="æ—¶é—´æ“ä½œ"><a class="markdownIt-Anchor" href="#æ—¶é—´æ“ä½œ"></a> æ—¶é—´æ“ä½œ</h3><ol><li>+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler;</li><li>+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler withLeeway:(NSTimeInterval)leeway;</li><li>delay</li><li>throttle é˜€é—¨ï¼Œåœ¨å›ºå®šæ—¶é—´å†…æ²¡æœ‰æ–°å€¼å‘é€çš„æ—¶å€™ï¼Œä¼šå‘é€æœ€åçš„å€¼</li></ol><h3 id="å¤šä¸ªä¿¡å·ç»„åˆ"><a class="markdownIt-Anchor" href="#å¤šä¸ªä¿¡å·ç»„åˆ"></a> å¤šä¸ªä¿¡å·ç»„åˆ</h3><p>é—®é¢˜ï¼š</p><ol><li>å—å“ªä¸ªä¿¡å·ç»ˆæ­¢è€Œç»ˆæ­¢ï¼Ÿ</li><li>é”™è¯¯ä¼ é€’ï¼Ÿ</li><li>å„ä¸ªä¿¡å·ä½•æ—¶å¼€å§‹å¼€å§‹è®¢é˜…ï¼Ÿ</li><li>åœ¨å“ªä¸ªçº¿ç¨‹å‘å‡ºï¼Ÿ</li></ol><ul><li>concat<ul><li>ç¬¬ä¸€ä¸ªç»“æŸåï¼Œè®¢é˜…ç¬¬äºŒä¸ª</li><li>ç¬¬ä¸€ä¸ªerror åï¼Œå°±ç›´æ¥ error</li></ul></li><li>merge</li><li>zip</li><li>combineLatest</li><li>sample</li><li>takeUntil</li><li>takeUntilReplacement, å½“ B æ¥äº†ç›´æ¥æ›¿æ¢ Aï¼Œå¼€å§‹è®¢é˜… B</li></ul><h3 id="ä¿¡å·çš„é«˜é˜¶æ“ä½œå‡é˜¶é™é˜¶"><a class="markdownIt-Anchor" href="#ä¿¡å·çš„é«˜é˜¶æ“ä½œå‡é˜¶é™é˜¶"></a> ä¿¡å·çš„é«˜é˜¶æ“ä½œï¼ˆå‡é˜¶é™é˜¶ï¼‰</h3><ol><li>å‡é˜¶ S(v) -&gt; S(s(v))</li><li>é™é˜¶ S(s(v)) -&gt; S(v)</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, @<span class="number">4</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signalB = [[signal map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">  <span class="keyword">return</span> [[RACSignal <span class="keyword">return</span>:value] delay:<span class="number">1</span>];</span><br><span class="line">&#125;] concat];</span><br></pre></td></tr></table></figure><ul><li><p>é™é˜¶æ“ä½œ</p></li><li><p>switchToLatests</p></li></ul><p><img src="/img/switchToLatests.jpeg" alt="switchToLatests"></p><ul><li><p>if/then/else<br><img src="/img/if-then-else.jpeg" alt="if/then/else"></p></li><li><p>switch/cases/default</p></li><li><p>flatten</p></li></ul><p><img src="/img/flatten.jpeg" alt="flatten"></p><p>flatten ç±»ä¼¼ merge åªä¸è¿‡ä¸€ä¸ªæ˜¯æ¥æ”¶çš„ valueæ˜¯ signalï¼Œå¦ä¸€ä¸ªæ¥æ”¶çš„å°±æ˜¯ value</p><ul><li>flatten:count æŒ‰ä¸ªæ•°å±•å¼€ä¿¡å·ï¼Œå½“ä¿¡å·ä¸ªæ•° &gt; count ä»¥åç­‰å¾…ï¼Œå¦‚æœæœ‰ sig completedï¼Œé‚£ä¹ˆæŠŠç­‰å¾…ä¸­çš„sig æ”¾å…¥å±•å¼€æ•°ç»„é‡Œé¢</li></ul><p><img src="/img/flatten-count.jpeg" alt="flatten-count"></p><p>flatten:1 == concat</p><ul><li>flattenMap</li></ul><p>æ»¡è¶³ monad çš„éƒ¨åˆ†å®šä¹‰ï¼Œç»å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ flattenMap å®ç°</p><ul><li>bind</li></ul><p>å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ bind å®ç°</p><h2 id="å†·ä¿¡å·çƒ­ä¿¡å·"><a class="markdownIt-Anchor" href="#å†·ä¿¡å·çƒ­ä¿¡å·"></a> å†·ä¿¡å·&amp;çƒ­ä¿¡å·</h2><h2 id="ä¸€äº›ä¹ é¢˜"><a class="markdownIt-Anchor" href="#ä¸€äº›ä¹ é¢˜"></a> ä¸€äº›ä¹ é¢˜</h2><ol><li>å¦‚ä½•è·å¾—æ— é™é€’å¢çš„ä¿¡å·</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *increment(<span class="keyword">int</span> inc) &#123;</span><br><span class="line">  RACSignal *repeat = [[RACSignal <span class="keyword">return</span>:@(inc)] repeat];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [[repeat scanWithStart:<span class="number">0</span> reduce:^<span class="keyword">id</span>(<span class="keyword">id</span> running, <span class="keyword">id</span> next) &#123;</span><br><span class="line">    <span class="keyword">return</span> @([running intValue] + [next intValue]);</span><br><span class="line">  &#125;]</span><br><span class="line">  delay:<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>fibonacci</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *fibonacci() &#123;</span><br><span class="line">  RACSignal *repeat = [[RACSignal <span class="keyword">return</span>:<span class="literal">nil</span>] repeat];</span><br><span class="line">  <span class="keyword">return</span> [repeat scanWithStart:RACTuplePack(@<span class="number">1</span>, @<span class="number">1</span>) reduce:^<span class="keyword">id</span>(RACTuple *running, <span class="keyword">id</span> _) &#123;</span><br><span class="line">    <span class="keyword">int</span> next = [running.first intValue] + [running.second intValue];</span><br><span class="line">    <span class="keyword">return</span> RACTuplePack(running.second, @(next));</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift 4.Action</title>
      <link href="/2018/02/03/RxSwfit+RAC/RxSwift-Action/"/>
      <url>/2018/02/03/RxSwfit+RAC/RxSwift-Action/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="https://github.com/RxSwiftCommunity/Action" target="_blank" rel="noopener">åŸæ–‡ï¼šAction</a></p><p>è¯¥åº“ä¸RxSwiftä¸€èµ·ä½¿ç”¨ï¼Œä»¥åœ¨å¯è§‚å¯Ÿå¯¹è±¡ä¹‹ä¸Šæä¾›æŠ½è±¡ï¼šActionã€‚</p><p><code>Action</code> æ˜¯è¯´â€œå˜¿ï¼Œç¨åæˆ‘éœ€è¦ä½ è®¢é˜…æ­¤å†…å®¹â€çš„ä¸€ç§æ–¹å¼ã€‚å®é™…ä¸Šï¼Œå®ƒæ¶‰åŠçš„æ›´å¤šã€‚</p><p><code>Action</code> åˆå§‹åŒ–æ—¶éœ€è¦ <code>workFactory:</code> ä¸€ä¸ªéœ€è¦ä¸€äº›è¾“å…¥å¹¶äº§ç”Ÿå¯è§‚å¯Ÿå€¼çš„é—­åŒ…ã€‚è°ƒç”¨ <code>execute()</code> æ—¶ï¼Œå®ƒå°†å‚æ•°ä¼ é€’ç»™æ­¤é—­åŒ…å¹¶è®¢é˜…å·¥ä½œã€‚</p><ul><li>åªæœ‰åœ¨â€œenabledâ€æ—¶æ‰å¯ä»¥æ‰§è¡Œï¼ˆå¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä¸ºtrueï¼‰</li><li>ä¸€æ¬¡åªæ‰§è¡Œä¸€ä»¶äº‹ã€‚</li><li>æ±‡æ€»å„ä¸ªæ‰§è¡Œä¸­çš„ next/error äº‹ä»¶</li></ul><p>Action å’Œ UIButton é…åˆä½¿ç”¨ã€‚å®ƒç®¡ç†æŒ‰é’®çš„ enable çŠ¶æ€ï¼Œç¡®ä¿åœ¨å·¥ä½œå®Œæˆæ—¶ç¦ç”¨æŒ‰é’®</p><h2 id="å¦‚ä½•ä½¿ç”¨"><a class="markdownIt-Anchor" href="#å¦‚ä½•ä½¿ç”¨"></a> å¦‚ä½•ä½¿ç”¨</h2><ul><li>å¿…é¡»ä¼ é€’ä¸€ä¸ª <code>workFactory</code> ï¼Œè¯¥å·¥å‚æ¥å—è¾“å…¥å¹¶è¿”å›ä¸€ä¸ª <code>Observable</code></li><li>æ¯å½“ä½ è°ƒç”¨ <code>execute(input)</code>ï¼Œä½ ä¼ å…¥çš„ input ä¼ å…¥åˆ° <code>workFactory</code> æ‰§è¡Œ</li><li>è¯¥ <code>Action</code> è®¢é˜… <code>Observable</code> å¯¹è±¡ï¼Œç„¶ååœ¨ <code>Action</code> çš„ <code>elements</code> å±æ€§ä¸Šå‘ <code>Observable</code> çš„ Nextäº‹ä»¶</li><li>å¦‚æœ <code>Observable</code> å‘å‡º event äº‹ä»¶ï¼Œè¿™ä¸ª error ä¼šä»¥ next äº‹ä»¶åœ¨ <code>Action</code> çš„ <code>errors</code> å±æ€§ä¸­ä»¥ next äº‹ä»¶å‘å‡º</li></ul><p>Actions æ¯æ¬¡åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœä½ å°è¯•æ‰§è¡Œä¸€ä¸ªæ­£åœ¨ executing çš„ actionï¼Œä¼šå¾—åˆ°ä¸€ä¸ª errorã€‚<code>Action</code> çš„ <code>executing</code> å±æ€§ä¼šå‘é€ next äº‹ä»¶ï¼Œå…³è”å€¼æ˜¯ ture or false</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">action: <span class="type">Action</span>&lt;<span class="type">String</span>, <span class="type">Bool</span>&gt; = <span class="type">Action</span>(workFactory: &#123; input <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> networkLibrary.checkEmailExists(input)</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line">action.execute(<span class="string">"ash@ashfurrow.com"</span>)</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªæ³›å‹å‚æ•°æ˜¯ input çš„ç±»å‹ã€‚</li><li>ç¬¬äºŒä¸ªæ³›å‹æ˜¯ workFactory é—­åŒ…åˆ›å»ºçš„ Observable å‘é€ next äº‹ä»¶çš„æ•°æ®ç±»å‹ï¼ˆä½ å¯ä»¥æŠŠå®ƒçœ‹åš Action çš„Outputï¼‰</li></ul><p>è¿˜å¯ä»¥ä¸º Action åˆå§‹åŒ–ç¨‹åºæŒ‡å®š enabledIf å‚æ•°ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> validEmailAddress = emailTextField.rx.text.<span class="built_in">map</span>(isValidEmail)</span><br><span class="line">action: <span class="type">Action</span>&lt;<span class="type">String</span>, <span class="type">Bool</span>&gt; = <span class="type">Action</span>(enabledIf: validEmailAddress, workFactory: &#123; input <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> networkLibrary.checkEmailExists(input)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ <code>execute()</code> åªæœ‰å½“ email address åˆæ³•æ‰ä¼šæ‰§è¡Œ.</p><p>æ³¨æ„ï¼Œ <code>enabledIf</code> ä¸ <code>enabled</code> å±æ€§ä¸åŒã€‚</p><p>UIButton æ‰©å±•ï¼šå®ƒæ¥å—CocoaActionï¼Œå®ƒçš„ç±»å‹æ˜¯ <code>Action &lt;Voidï¼ŒVoid&gt;</code>ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">button.rx.action = action</span><br></pre></td></tr></table></figure><p>å½“æŒ‰ä¸‹æŒ‰é’®æ—¶ï¼Œaction æ‰§è¡Œæ“ä½œã€‚button çš„ enable å±æ€§å’Œ action çš„ <code>enabled</code> å±æ€§ç»‘å®šã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†è¡¨å•éªŒè¯é€»è¾‘ä½œä¸ºä¿¡å·è¾“å…¥åˆ° action ä¸­ï¼Œå¹¶ä¸ºä½ å¤„ç†æŒ‰é’®çš„å¯ç”¨çŠ¶æ€ã€‚åŒæ ·ï¼Œç”¨æˆ·ä¸èƒ½åœ¨åŠ¨ä½œå®Œæˆæ‰§è¡Œä¹‹å‰å†æ¬¡æŒ‰ä¸‹æŒ‰é’®ï¼Œå› ä¸ºå®ƒä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä»¶äº‹ã€‚çœ‹çœ‹è¿™ä¸ªå®é™…çš„CocoaActionä»£ç ç¤ºä¾‹ã€‚</p><p>å¦‚æœä½ æƒ³ä½¿ç”¨ <code>Action</code> è¿›è¡Œå¤æ‚çš„æ“ä½œï¼Œä¾‹å¦‚ä½¿ç”¨ä¸‹è½½è¿›åº¦æŠ¥å‘Šä¸‹è½½æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°UIä¸­çš„è¿›åº¦æ¡ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ <code>Action&lt;Voidï¼ŒInt&gt;</code> ä»£æ›¿CocoaActionã€‚å¼€ç®±å³ç”¨çš„CocoaActionæ— æ³•å‘å‡ºè¿›åº¦å€¼ï¼Œä½ è‡ªå·±çš„ <code>Action&lt;Voidï¼ŒInt&gt;</code> å°†åšåˆ°è¿™ä¸€ç‚¹ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="http://www.sm-cloud.com/rxswift-action/" target="_blank" rel="noopener">æœ¬æ–‡</a>ã€‚</p><p>å¦‚æœä½ çš„æ–¹æ¡ˆæ¶‰åŠè®¸å¤šéœ€è¦è§¦å‘åŒä¸€æ“ä½œä»¥æä¾›ä¸åŒè¾“å…¥çš„æŒ‰é’®ï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªUIButtonä¸Šä½¿ç”¨bindToï¼Œå¹¶ä½¿ç”¨é—­åŒ…è¿”å›æ­£ç¡®çš„è¾“å…¥ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> button1 = <span class="type">UIButton</span>()</span><br><span class="line"><span class="keyword">let</span> button2 = <span class="type">UIButton</span>()</span><br><span class="line"><span class="keyword">let</span> action = <span class="type">Action</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; &#123; input <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(input)</span><br><span class="line">    <span class="keyword">return</span> .just(input)</span><br><span class="line">&#125;</span><br><span class="line">button1.rx.bindTo(action) &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="keyword">return</span> <span class="string">"Hello"</span>&#125;</span><br><span class="line">button2.rx.bindTo(action) &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="keyword">return</span> <span class="string">"Goodbye"</span>&#125;</span><br></pre></td></tr></table></figure><p>button1å’Œbutton2å…±äº«ç›¸åŒçš„Actionï¼Œä½†æ˜¯å®ƒä»¬ä½¿ç”¨ä¸åŒçš„è¾“å…¥ï¼ˆç›¸åº”çš„è¾“å‡ºHelloå’ŒGoodbyeï¼‰</p><p>æ›´å¤æ‚çš„ç”¨ä¾‹å¯ä»¥æ˜¯ä¸UIViewControllerç›¸å…³çš„å•ä¸ªæ“ä½œï¼Œè¯¥æ“ä½œç®¡ç†ä½ çš„å¯¼èˆªï¼Œé”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‹¥æœ‰ä»»æ„æ•°é‡çš„ UIButtonï¼ˆæˆ–UIBarButtonItemsï¼‰ï¼Œåœ¨ä¸€ä¸ªå…¬å…±ä½ç½®ä¸€æ¬¡æ€§è®¢é˜… <code>executing</code> ï¼Œ<code>errors</code> å’Œ <code>elements</code>ã€‚</p><p>UIAlertController è¿˜ä½¿ç”¨äº†ä¸€ä¸ªéå¸¸é…·çš„ <code>UIAlertAction</code> æ‰©å±•ã€‚ä¸€æ‹›ï¼šç”±äºè¯¥ç±»çš„é™åˆ¶ï¼Œä½ æ— æ³•ä½¿ç”¨å¸¸è§„çš„åˆå§‹åŒ–ç¨‹åºå®ä¾‹åŒ–å®ƒã€‚ç›¸åï¼Œè¯·è°ƒç”¨æ­¤ç±»æ–¹æ³•ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> action = <span class="type">UIAlertAction</span>.<span class="type">Action</span>(<span class="string">"Hi"</span>, style: .<span class="keyword">default</span>)</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift 3.Subject(Observable &amp; Observer)</title>
      <link href="/2018/02/02/RxSwfit+RAC/RxSwift-3-Subject(Observable&amp;Observer)/"/>
      <url>/2018/02/02/RxSwfit+RAC/RxSwift-3-Subject(Observable&amp;Observer)/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><div align="center"><img src="/img/subject.jpeg" alt="subject" style="width:180px;height:150px"></div><p>é¦–å…ˆåœ¨å¼€å‘çš„æ—¶å€™æ€è€ƒï¼Œä»–æ˜¯ä¸€ä¸ª Observable</p><h2 id="asyncsubject"><a class="markdownIt-Anchor" href="#asyncsubject"></a> AsyncSubject</h2><ol><li>ç‰¹ç‚¹ï¼š<ul><li>å½“ Observable Sequence å‘é€ complete äº‹ä»¶ï¼Œ<code>AsyncSubject</code> æ‰ä¼šå‘é€æœ€åä¸€ä¸ª next äº‹ä»¶å’Œ complete</li><li>å½“ Observable Sequence å‘é€ error äº‹ä»¶ï¼Œ<code>AsyncSubject</code> åªå‘é€ error äº‹ä»¶ï¼Œä¸ä¼šå‘é€æœ€åä¸€ä¸ª next</li></ul></li></ol><details><summary>2. æ¼”ç¤º</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>() </span><br><span class="line"><span class="keyword">let</span> subject = <span class="type">AsyncSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 1 Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject.onCompleted()</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Subscription: <span class="number">1</span> Event: next(Î¯ )</span><br><span class="line">Subscription: <span class="number">1</span> Event: completed</span><br></pre></td></tr></table></figure></pre></details><h2 id="publishsubject"><a class="markdownIt-Anchor" href="#publishsubject"></a> PublishSubject</h2><ol><li>ç‰¹ç‚¹ï¼š<ul><li><code>PublishSubject</code> å‘é€è®¢é˜…åäº§â½£çš„å…ƒç´ .</li><li><code>PublishSubject</code> ä¸å‘é€è®¢é˜…å‰äº§â½£çš„å…ƒç´ .</li></ul></li></ol><div align="left"><img src="/img/publicSubject.jpeg" alt="publicSubject" style="width:300px;height:200px"></div><details><summary>2. æ¼”ç¤º</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="keyword">let</span> subject = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 1 Event:"</span>, $<span class="number">0</span>) &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 2 Event:"</span>, $<span class="number">0</span>) &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject.onNext(<span class="string">"A "</span>)</span><br><span class="line">subject.onNext(<span class="string">"B "</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(B )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(B )</span><br></pre></td></tr></table></figure></pre></details><h2 id="replaysubject"><a class="markdownIt-Anchor" href="#replaysubject"></a> ReplaySubject</h2><ol><li>ç‰¹ç‚¹ï¼š<ul><li><code>ReplaySubject</code> å°†å¯¹è§‚å¯Ÿè€…å‘é€å…¨éƒ¨çš„å…ƒç´ ï¼Œâ½†è®ºè§‚å¯Ÿè€…æ˜¯ä½•æ—¶è¿›â¾è®¢é˜…çš„ã€‚</li></ul></li></ol><div align="left"><img src="/img/replaySubject.jpeg" alt="replaySubject" style="width:300px;height:200px"></div><details><summary>2. æ¼”ç¤º</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="keyword">let</span> subject = <span class="type">ReplaySubject</span>&lt;<span class="type">String</span>&gt;.create(bufferSize: <span class="number">1</span>)</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 1 Event:"</span>, $<span class="number">0</span>) &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 2 Event:"</span>, $<span class="number">0</span>) &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject.onNext(<span class="string">"A "</span>)</span><br><span class="line">subject.onNext(<span class="string">"B "</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Subscription: <span class="number">1</span> Event: next(  ) </span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  ) </span><br><span class="line">Subscription: <span class="number">2</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(B )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(B )</span><br></pre></td></tr></table></figure></pre></details><h2 id="behaviorsubject"><a class="markdownIt-Anchor" href="#behaviorsubject"></a> BehaviorSubject</h2><ol><li>ç‰¹ç‚¹ï¼š<ol><li>å…·æœ‰é»˜è®¤å€¼</li><li>å½“è®¢é˜… BehaviorSubject æ—¶ï¼Œå®ƒä¼šå°†æº Observable ä¸­æœ€æ–°çš„å…ƒç´ å‘é€å‡ºæ¥ï¼ˆå¦‚æœä¸å­˜åœ¨æœ€æ–°çš„å…ƒç´ ï¼Œå°±å‘å‡ºé»˜è®¤å…ƒç´ ï¼‰ã€‚ç„¶åå°†éšåäº§â½£çš„å…ƒç´ å‘é€å‡ºæ¥ã€‚</li><li>å¦‚æœ Observable å‘ error äº‹ä»¶ï¼Œé‚£ä¹ˆBehaviorSubjectä¸ä¼šå†å‘é€ next äº‹ä»¶ï¼Œè€Œåªæ˜¯ä¼ é€’æ¥è‡ªæº Observable çš„ error äº‹ä»¶ã€‚</li></ol></li></ol><p>normal</p><div align="left"><img src="/img/behaviorSubject1.jpeg" alt="behaviorSubject1" style="width:300px;height:200px"></div><p>error</p><div align="left"><img src="/img/behaviorSubject2.jpeg" alt="behaviorSubject2" style="width:300px;height:200px"></div><details><summary>2. æ¼”ç¤º</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line"><span class="keyword">let</span> subject = <span class="type">BehaviorSubject</span>(value: <span class="string">"  "</span>)</span><br><span class="line">subject</span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 1 Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"  "</span>) </span><br><span class="line">subject.onNext(<span class="string">"  "</span>) </span><br><span class="line">subject </span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 2 Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"A "</span>) </span><br><span class="line">subject.onNext(<span class="string">"B "</span>) </span><br><span class="line">subject </span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Subscription: 3 Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag) </span><br><span class="line">subject.onNext(<span class="string">"  "</span>) </span><br><span class="line">subject.onNext(<span class="string">"  "</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(A )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(B )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(B )</span><br><span class="line">Subscription: <span class="number">3</span> Event: next(B )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">3</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">1</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">2</span> Event: next(  )</span><br><span class="line">Subscription: <span class="number">3</span> Event: next(  )</span><br></pre></td></tr></table></figure></pre></details><h2 id="variableå¼ƒç”¨"><a class="markdownIt-Anchor" href="#variableå¼ƒç”¨"></a> Variableï¼ˆå¼ƒç”¨ï¼‰</h2><p>åœ¨ RxSwift 5.x ä¸­ï¼Œä»–è¢«å®˜â½…çš„æ­£å¼çš„å¼ƒâ½¤äº†ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶ï¼Œæ¨èä½¿â½¤ BehaviorRelay æˆ–è€… BehaviorSubjectã€‚</p><h2 id="relay"><a class="markdownIt-Anchor" href="#relay"></a> Relay</h2><div align="left"><img src="/img/RxRelay.jpeg" alt="RxRelay" style="width:450px;height:175px"></div><br><p>RxRelayæä¾›ä¸¤ç§ä¸­ç»§ï¼šPublishRelay å’Œ BehaviorRelayã€‚å®ƒä»¬çš„è¡Œä¸ºä¸å¯¹åº”çš„ Subjects å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸¤ä¸ªå˜åŒ–ï¼š</p><ul><li>Relays never complete.</li><li>Relays never emit errors.</li></ul><p>æœ¬è´¨ä¸Šï¼Œä¸­ç»§ä»…å‘å‡º.nextäº‹ä»¶ï¼Œå¹¶ä¸”æ°¸ä¸ç»ˆæ­¢ï¼Œæœ‰äº†ä»–ï¼Œæˆ‘ä»¬å°† API è½¬åŒ–ä¸º Rx æ ·å¼æ—¶ï¼Œå°±ä¸å¿…æ‹…â¼¼â¼€ä¸ªæ„å¤–çš„ç»ˆâ½Œäº‹ä»¶ï¼Œå¯¼è‡´åç»­äº‹ä»¶è½¬å‘å¤±æ•ˆã€‚</p><h3 id="publishrelay"><a class="markdownIt-Anchor" href="#publishrelay"></a> PublishRelay</h3><p>PublishRelay å°±æ˜¯ PublishSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError å’Œ onCompletedã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>() </span><br><span class="line"><span class="keyword">let</span> relay = <span class="type">PublishRelay</span>&lt;<span class="type">String</span>&gt;() </span><br><span class="line">relay </span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">relay.accept(<span class="string">"  "</span>)</span><br><span class="line">relay.accept(<span class="string">"  "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="type">Event</span>: next( )</span><br><span class="line"><span class="type">Event</span>: next( )</span><br></pre></td></tr></table></figure><h3 id="behaviorrelay"><a class="markdownIt-Anchor" href="#behaviorrelay"></a> BehaviorRelay</h3><p>BehaviorRelay å°±æ˜¯ BehaviorSubject å»æ‰ç»ˆâ½Œäº‹ä»¶ onError å’Œ onCompletedã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>() </span><br><span class="line"><span class="keyword">let</span> relay = <span class="type">BehaviorRelay</span>(value: <span class="string">"  "</span>)</span><br><span class="line">relay </span><br><span class="line">    .subscribe &#123; <span class="built_in">print</span>(<span class="string">"Event:"</span>, $<span class="number">0</span>) &#125; </span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">relay.accept(<span class="string">"  "</span>)</span><br><span class="line">relay.accept(<span class="string">"  "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="type">Event</span>: next( )</span><br><span class="line"><span class="type">Event</span>: next( )</span><br><span class="line"><span class="type">Event</span>: next( )</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift 2.Observer</title>
      <link href="/2018/02/02/RxSwfit+RAC/RxSwift-Observer/"/>
      <url>/2018/02/02/RxSwfit+RAC/RxSwift-Observer/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>Observer: ç›‘å¬ Observable Sequenceï¼Œæ¥å—å®ƒä¼ æ¥çš„ events</p><div align="center"><img src="/img/observer.jpeg" alt="observer" style="width:200px;height:100px"></div><h2 id="å¦‚ä½•åˆ›å»º-observer"><a class="markdownIt-Anchor" href="#å¦‚ä½•åˆ›å»º-observer"></a> å¦‚ä½•åˆ›å»º Observer</h2><h3 id="observable-çš„-subscribe-æ–¹æ³•"><a class="markdownIt-Anchor" href="#observable-çš„-subscribe-æ–¹æ³•"></a> Observable çš„ subscribe æ–¹æ³•</h3><p>åˆ›å»ºè§‚å¯Ÿè€…æœ€ç›´æ¥çš„â½…æ³•å°±æ˜¯åœ¨ Observable çš„ subscribe â½…æ³•åâ¾¯æè¿°ï¼Œäº‹ä»¶å‘â½£æ—¶ï¼Œéœ€è¦å¦‚ ä½•åšå‡ºå“åº”ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tap.subscribe(onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>?.showAlert()</span><br><span class="line">    &#125;, onError: &#123; error <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"å‘â½£é”™è¯¯ï¼š \(error.localizedDescription)"</span>)</span><br><span class="line">    &#125;, onCompleted: &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"ä»»åŠ¡å®Œæˆ"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>subscribe æ–¹æ³•å†…éƒ¨ä¼šäº§ç”Ÿ <code>AnonymousObserver</code> å¯¹è±¡ï¼ˆRxSwift åº“ç§æœ‰çš„ï¼‰</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">subscribe</span><span class="params">(<span class="number">_</span> on: @escaping <span class="params">(Event&lt;Element&gt;)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">    -&gt; <span class="type">Disposable</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> observer = <span class="type">AnonymousObserver</span> &#123; e <span class="keyword">in</span></span><br><span class="line">            on(e)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.asObservable().subscribe(observer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="anyobserver-ä»»æ„è§‚å¯Ÿè€…"><a class="markdownIt-Anchor" href="#anyobserver-ä»»æ„è§‚å¯Ÿè€…"></a> AnyObserver-- ä»»æ„è§‚å¯Ÿè€…</h3><p>ç±»æ³¨é‡Šï¼š</p><blockquote><p>A type-erased <code>ObserverType</code>.<br>å°†æ“ä½œè½¬å‘åˆ°å…·æœ‰ç›¸åŒ <code>Element</code> ç±»å‹çš„ä»»æ„åŸºç¡€è§‚å¯Ÿè€…ï¼Œéšè—åŸºç¡€è§‚å¯Ÿè€…ç±»å‹çš„ç»†èŠ‚ã€‚</p></blockquote><p>AnyObserver å¯ä»¥â½¤æ¥æå™ä»»æ„â¼€ç§è§‚å¯Ÿè€…ã€‚<br>eg: æ‰“å°â½¹ç»œè¯·æ±‚ç»“æœï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">URLSession</span>.shared.rx.data(request: <span class="type">URLRequest</span>(url: url)) </span><br><span class="line">    .subscribe(onNext: &#123; data <span class="keyword">in</span> </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Data Task Success with count: \(data.count)"</span>) </span><br><span class="line">    &#125;, onError: &#123; error <span class="keyword">in</span> </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Data Task Error: \(error)"</span>) </span><br><span class="line">&#125;) </span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ä½œæ˜¯ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer: <span class="type">AnyObserver</span>&lt;<span class="type">Data</span>&gt; = <span class="type">AnyObserver</span> &#123; (event) <span class="keyword">in</span> </span><br><span class="line">    <span class="keyword">switch</span> event &#123; </span><br><span class="line">        <span class="keyword">case</span> .next(<span class="keyword">let</span> data): </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Data Task Success with count: \(data.count)"</span>) </span><br><span class="line">        <span class="keyword">case</span> .error(<span class="keyword">let</span> error): </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Data Task Error: \(error)"</span>) </span><br><span class="line">        <span class="keyword">default</span>: </span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">URLSession</span>.shared.rx.data(request: <span class="type">URLRequest</span>(url: url)) </span><br><span class="line">    .subscribe(observer) </span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>â½¤æˆ·åæç¤ºè¯­æ˜¯å¦éšè—ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">usernameValid </span><br><span class="line">    .bind(to: usernameValidOutlet.rx.isHidden) </span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ä½œæ˜¯ï¼š<span id="anchor"></span></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer: <span class="type">AnyObserver</span>&lt;<span class="type">Bool</span>&gt; = <span class="type">AnyObserver</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (event) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">switch</span> event &#123; </span><br><span class="line">        <span class="keyword">case</span> .next(<span class="keyword">let</span> isHidden): </span><br><span class="line">            <span class="keyword">self</span>?.usernameValidOutlet.isHidden = isHidden </span><br><span class="line">        <span class="keyword">default</span>: </span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">usernameValid </span><br><span class="line">    .bind(to: observer) </span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><h3 id="binderui-è§‚å¯Ÿè€…"><a class="markdownIt-Anchor" href="#binderui-è§‚å¯Ÿè€…"></a> Binderâ€“UI è§‚å¯Ÿè€…</h3><p>ç±»æ³¨é‡Šï¼š</p><blockquote><p>å¼ºåˆ¶æ‰§è¡Œæ¥å£ç»‘å®šè§„åˆ™çš„è§‚å¯Ÿè€…:</p><ul><li>æ— æ³•ç»‘å®šé”™è¯¯ï¼ˆåœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ï¼Œé”™è¯¯çš„ç»‘å®šä¼šå¯¼è‡´è‡´å‘½é”™è¯¯ï¼Œåœ¨å‘å¸ƒç‰ˆæœ¬ä¸­çš„é”™è¯¯ä¼šè¢«è®°å½•ï¼‰</li><li>ç¡®ä¿åœ¨ç‰¹å®šçš„è°ƒåº¦ç¨‹åºä¸Šæ‰§è¡Œç»‘å®š</li></ul><p><code>Binder</code> ä¸ä¼šä¿ç•™ç›®æ ‡ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾ç›®æ ‡çš„æƒ…å†µä¸‹ï¼Œå…ƒç´ ä¹Ÿä¸ä¼šç»‘å®šã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒç»‘å®šä¸»è°ƒåº¦ç¨‹åºä¸Šçš„å…ƒç´ </p></blockquote><ol><li>Binder ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</li></ol><ul><li>å¤„ç† next äº‹ä»¶</li><li>ä¸å¤„ç†é”™è¯¯äº‹ä»¶</li><li>ç¡®ä¿ç»‘å®šéƒ½æ˜¯åœ¨ç»™å®š Scheduler ä¸Šæ‰§â¾ï¼ˆé»˜è®¤ MainSchedulerï¼‰</li></ul><p>â¼€æ—¦äº§â½£é”™è¯¯äº‹ä»¶ï¼Œåœ¨è°ƒè¯•ç¯å¢ƒä¸‹å°†æ‰§â¾ fatalErrorï¼Œåœ¨å‘å¸ƒç¯å¢ƒä¸‹å°†æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚</p><ol start="2"><li>ç¤ºä¾‹ï¼Œå¯¹æ¯”ä¸Šé¢çš„ <a href="#anchor">AnyObserverç¤ºä¾‹</a></li></ol><p>ç”±äºè¿™ä¸ªè§‚å¯Ÿè€…æ˜¯â¼€ä¸ª UI è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥å®ƒåœ¨å“åº”äº‹ä»¶æ—¶ï¼Œåªä¼šå¤„ç† next äº‹ä»¶ å¹¶ä¸”æ›´æ–° UI çš„æ“ä½œéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§â¾ã€‚ å› æ­¤â¼€ä¸ªæ›´å¥½çš„â½…æ¡ˆå°±æ˜¯ä½¿â½¤ Binderï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer: <span class="type">Binder</span>&lt;<span class="type">Bool</span>&gt; = <span class="type">Binder</span>(usernameValidOutlet) &#123; (view, isHidden) <span class="keyword">in</span> </span><br><span class="line">    view.isHidden = isHidden </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">usernameValid </span><br><span class="line">    .bind(to: observer) </span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><ol start="3"><li>RxCocoa ä¸­çš„ rx æ‰©å±•å¯¹äº Binder çš„ä½¿ç”¨ï¼š</li></ol><p>ä½ ä¹Ÿå¯ä»¥â½¤è¿™ç§â½…å¼æ¥åˆ›å»ºâ¾ƒå®šä¹‰çš„ UI è§‚å¯Ÿè€…ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> isHidden: <span class="type">Binder</span>&lt;<span class="type">Bool</span>&gt; &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="type">Binder</span>(<span class="keyword">self</span>.base) &#123; view, hidden <span class="keyword">in</span> </span><br><span class="line">            view.isHidden = hidden </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UILabel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> text: <span class="type">Binder</span>&lt;<span class="type">String?</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Binder</span>(<span class="keyword">self</span>.base) &#123; label, text <span class="keyword">in</span></span><br><span class="line">            label.text = text </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="https://beeth0ven.github.io/RxSwift-Chinese-Documentation/content/rxswift_core/observer.html" target="_blank" rel="noopener">Observer - è§‚å¯Ÿè€…</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hot å’Œ Cold Observables</title>
      <link href="/2018/02/02/RxSwfit+RAC/Hot-%E5%92%8C-Cold-Observables/"/>
      <url>/2018/02/02/RxSwfit+RAC/Hot-%E5%92%8C-Cold-Observables/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/HotAndColdObservables.md" target="_blank" rel="noopener">åŸæ–‡: Hot and Cold Observables</a></p><p>æ•æˆ‘ç›´è¨€ï¼Œæˆ‘å»ºè®®æ›´å¤šåœ°å°†å…¶è§†ä¸ºåºåˆ—çš„å±æ€§ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬ç”±å®Œå…¨é€‚åˆå®ƒä»¬çš„ç›¸åŒæŠ½è±¡è¡¨ç¤ºï¼Œå³å¯è§‚å¯Ÿåºåˆ—ã€‚</p><p>è¿™æ˜¯ReactiveX.ioçš„å®šä¹‰:</p><blockquote><p>Observableä½•æ—¶å¼€å§‹å‘å‡ºå…¶é¡¹ç›®åºåˆ—ï¼Ÿè¿™å–å†³äº Observable.<br>â€œhotâ€ Observable å¯¹è±¡å¯èƒ½ä¼šåœ¨åˆ›å»ºåç«‹å³å¼€å§‹å‘å°„é¡¹ç›®ï¼Œå› æ­¤ä»¥åè®¢é˜…è¯¥ Observable å¯¹è±¡çš„ä»»ä½•è§‚å¯Ÿè€…éƒ½å¯ä»¥å¼€å§‹è§‚å¯Ÿä¸­é—´ä½ç½®çš„åºåˆ—ã€‚<br>â€œcoldâ€Observableå¯¹è±¡è¦ç­‰åˆ°è§‚å¯Ÿè€…è®¢é˜…å®ƒï¼Œç„¶åæ‰èƒ½å¼€å§‹å‘å°„é¡¹ç›®ï¼Œå› æ­¤å¯ä»¥ä¿è¯è¿™æ ·çš„è§‚å¯Ÿè€…ä»ä¸€å¼€å§‹å°±å¯ä»¥çœ‹åˆ°æ•´ä¸ªåºåˆ—ã€‚</p></blockquote><table><thead><tr><th>Hot Observables</th><th>Cold observables</th></tr></thead><tbody><tr><td>â€¦ are sequences</td><td>â€¦ are sequences</td></tr><tr><td>Use resources (â€œproduce heatâ€) no matter if there is any observer subscribed.</td><td>Donâ€™t use resources (donâ€™t produce heat) until observer subscribes.</td></tr><tr><td>Variables / properties / constants, tap coordinates, mouse coordinates, UI control values, current time</td><td>Async operations, HTTP Connections, TCP connections, streams</td></tr><tr><td>Usually contains ~ N elements</td><td>Usually contains ~ 1 element</td></tr><tr><td>Sequence elements are produced no matter if there is any observer subscribed.</td><td>Sequence elements are produced only if there is a subscribed observer.</td></tr><tr><td>Observable Sequence è¢«å¤šä¸ªè®¢é˜…å®ƒçš„ observers å…±äº«</td><td>æ¯ä¸ªè®¢é˜…çš„ observer éƒ½ä¼šæœ‰ä¸€ä¸ª Observable Sequence</td></tr><tr><td>Usually stateful</td><td>Usually stateless</td></tr></tbody></table><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxSwift 1.ç‰¹å¾</title>
      <link href="/2018/01/31/RxSwfit+RAC/RxSwift-%E7%89%B9%E5%BE%81/"/>
      <url>/2018/01/31/RxSwfit+RAC/RxSwift-%E7%89%B9%E5%BE%81/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>ç‰¹æ€§å®Œå…¨æ˜¯å¯é€‰çš„ã€‚ä½ å¯ä»¥è‡ªç”±åœ°åœ¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨åŸå§‹çš„Observableåºåˆ—ï¼Œå› ä¸ºæ‰€æœ‰æ ¸å¿ƒRxSwift / RxCocoa APIéƒ½æ”¯æŒå®ƒä»¬ã€‚</p><div align="center"><img src="/img/Traits.jpeg" alt="Traits" style="width:300px;height:240px"></div><h2 id="ç‰¹å¾æ˜¯å¦‚ä½•å·¥ä½œçš„"><a class="markdownIt-Anchor" href="#ç‰¹å¾æ˜¯å¦‚ä½•å·¥ä½œçš„"></a> ç‰¹å¾æ˜¯å¦‚ä½•å·¥ä½œçš„</h2><p>ç‰¹æ€§åªæ˜¯ Observable sequence çš„åŒ…è£…å™¨ç»“æ„ã€‚</p><p>ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºå¯è§‚å¯Ÿåºåˆ—çš„ä¸€ç§æ„å»ºå™¨æ¨¡å¼å®ç°ã€‚æ„å»ºç‰¹è´¨åï¼Œè°ƒç”¨.asObservable() ä¼šå°†å…¶è½¬æ¢å›åŸå§‹çš„å¯è§‚å¯Ÿåºåˆ—ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Single</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Driver</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯è§‚å¯Ÿåºåˆ—"><a class="markdownIt-Anchor" href="#å¯è§‚å¯Ÿåºåˆ—"></a> å¯è§‚å¯Ÿåºåˆ—</h2><p>Observable Sequence: å®ƒæ˜¯ä¿¡å·æºï¼Œäº§ç”Ÿäº‹ä»¶ï¼ŒRxSwift é‡è§† <code>Observable&lt;T&gt;</code> ç±»ã€‚</p><p>ä¸‹é¢ä»‹ç»çš„å‡ ä¸ªç±»å‹éƒ½æ˜¯åœ¨ <code>Observable&lt;T&gt;</code> ç±»çš„åŸºç¡€ä¸Šå®šåˆ¶åŒ–å‡ºæ¥çš„ç‰¹å¾åºåˆ—ã€‚</p><p><code>Observable&lt;T&gt;</code> å¯å‘é€å‡ºæ¥çš„äº‹ä»¶ç±»å‹</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span>&lt;<span class="title">Element</span>&gt; </span>&#123; </span><br><span class="line">    <span class="keyword">case</span> next(<span class="type">Element</span>) </span><br><span class="line">    <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>) </span><br><span class="line">    <span class="keyword">case</span> completed </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="rxswift-ç‰¹å¾-singlecompletablemaybe"><a class="markdownIt-Anchor" href="#rxswift-ç‰¹å¾-singlecompletablemaybe"></a> RxSwift ç‰¹å¾ Single/Completable/Maybe</h3><h4 id="single"><a class="markdownIt-Anchor" href="#single"></a> Single</h4><ol><li>Single åªèƒ½å‘é€ä¸¤ä¸ªäº‹ä»¶</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingleEvent</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/// One and only sequence element is produced. (underlying observable sequence emits: `.next(Element)`, `.completed`)</span></span><br><span class="line">  <span class="keyword">case</span> success(<span class="type">Element</span>)</span><br><span class="line">  <span class="comment">/// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`)</span></span><br><span class="line">  <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>åœ¨ Single çš„åˆå§‹åŒ–ä¸­å¯ä»¥çœ‹åˆ°åšäº† SingleEvent -&gt; Event çš„å¤„ç†</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(subscribe: @escaping <span class="params">(@escaping SingleObserver)</span></span></span> -&gt; <span class="type">Disposable</span>) -&gt; <span class="type">Single</span>&lt;<span class="type">Element</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> source = <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;.create &#123; observer <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">switch</span> event &#123;</span><br><span class="line">        <span class="keyword">case</span> .success(<span class="keyword">let</span> element):</span><br><span class="line">          observer.on(.next(element))</span><br><span class="line">          observer.on(.completed)</span><br><span class="line">        <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">          observer.on(.error(error))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">PrimitiveSequence</span>(raw: source)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>åœ¨ <code>.success</code> äº‹ä»¶ä¸­ï¼Œ<code>Single</code> å‘é€äº†ä¸€ä¸ª .next åç´§è·Ÿç€åˆå‘é€äº† .completed äº‹ä»¶ï¼Œæ‰€ä»¥:</li></ol><ul><li>success - äº§â½£â¼€ä¸ªå•ç‹¬çš„å…ƒç´ </li><li>error - äº§â½£â¼€ä¸ªé”™è¯¯</li><li>ä¸ä¼šå…±äº«é™„åŠ ä½œç”¨</li></ul><ol start="4"><li><code>Single</code> å®é™…åœºæ™¯ï¼š</li></ol><p><code>Single</code> çš„ä¾‹â¼¦å°±æ˜¯æ‰§â¾ HTTP è¯·æ±‚ï¼Œç„¶åè¿”å›â¼€ä¸ªåº”ç­”æˆ–é”™è¯¯ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥â½¤ Single æ¥æè¿° ä»»ä½•åªæœ‰â¼€ä¸ªå…ƒç´ çš„åºåˆ—ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRepo</span><span class="params">(<span class="number">_</span> repo: String)</span></span> -&gt; <span class="type">Single</span>&lt;[<span class="type">String</span>: <span class="type">Any</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Single</span>&lt;[<span class="type">String</span>: <span class="type">Any</span>]&gt;.create &#123; single <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> task = <span class="type">URLSession</span>.shared.dataTask(with: <span class="type">URL</span>(string: <span class="string">"https://api.github.com/repos/\(repo)"</span>)!) &#123; data, <span class="number">_</span>, error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">                single(.error(error))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> data = data,</span><br><span class="line">                  <span class="keyword">let</span> json = <span class="keyword">try</span>? <span class="type">JSONSerialization</span>.jsonObject(with: data, options: .mutableLeaves),</span><br><span class="line">                  <span class="keyword">let</span> result = json <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">else</span> &#123;</span><br><span class="line">                single(.error(<span class="type">DataError</span>.cantParseJSON))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            single(.success(result))</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume() </span><br><span class="line">        <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123; task.cancel() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¢é˜…ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getRepo(<span class="string">"ReactiveX/RxSwift"</span>)</span><br><span class="line">    .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">switch</span> event &#123;</span><br><span class="line">            <span class="keyword">case</span> .success(<span class="keyword">let</span> json):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"JSON: "</span>, json)</span><br><span class="line">            <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Error: "</span>, error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getRepo(<span class="string">"ReactiveX/RxSwift"</span>)</span><br><span class="line">    .subscribe(onSuccess: &#123; json <span class="keyword">in</span></span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">"JSON: "</span>, json)</span><br><span class="line">               &#125;,</span><br><span class="line">               onError: &#123; error <span class="keyword">in</span></span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">"Error: "</span>, error)</span><br><span class="line">               &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><ol start="4"><li>å¯ä»¥å¯¹ Observable è°ƒâ½¤ .asSingle() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Singleã€‚</li></ol><h4 id="completable"><a class="markdownIt-Anchor" href="#completable"></a> Completable</h4><ol><li>Completable ä¹Ÿåªèƒ½å‘é€ä¸¤ä¸ªäº‹ä»¶ï¼Œä»–æ²¡æœ‰ .next äº‹ä»¶ï¼Œæ‰€ä»¥ä»–ä»¬æœ‰æ¥å—æ•°æ®å€¼ç›¸å…³çš„äº‹ä»¶ï¼</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CompletableEvent</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`)</span></span><br><span class="line">    <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>)</span><br><span class="line">    <span class="comment">/// Sequence completed successfully.</span></span><br><span class="line">    <span class="keyword">case</span> completed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>Completable åˆ›å»ºæ–¹æ³•åŒ Singleï¼Œä¹Ÿæ˜¯åšäº† CompletableEvent -&gt; Event çš„å¤„ç†</li></ol><ul><li>æ²¡æœ‰ next äº‹ä»¶ï¼Œä¸ä¼šå‘å‡ºå…ƒç´ </li><li>åªå‘é€ completed æˆ–è€… error</li><li>ä¸ä¼šå…±äº«é™„åŠ ä½œâ½¤</li></ul><ol start="3"><li><code>Completable</code> å®é™…åœºæ™¯ï¼š</li></ol><p><code>Completable</code> é€‚â½¤äºé‚£ç§ä½ åªå…³â¼¼ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œâ½½ä¸éœ€è¦åœ¨æ„ä»»åŠ¡è¿”å›å€¼çš„æƒ…å†µã€‚å®ƒå’Œ Observable<void>æœ‰ç‚¹ç›¸ä¼¼ã€‚</void></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cacheLocally</span><span class="params">()</span></span> -&gt; <span class="type">Completable</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Completable</span>.create &#123; completable <span class="keyword">in</span></span><br><span class="line">       <span class="comment">// Store some data locally</span></span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">guard</span> success <span class="keyword">else</span> &#123;</span><br><span class="line">           completable(.error(<span class="type">CacheError</span>.failedCaching))</span><br><span class="line">           <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;&#125;</span><br><span class="line">       &#125;</span><br><span class="line">       completable(.completed)</span><br><span class="line">       <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¢é˜…</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cacheLocally()</span><br><span class="line">    .subscribe &#123; completable <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">switch</span> completable &#123;</span><br><span class="line">            <span class="keyword">case</span> .completed:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Completed with no error"</span>)</span><br><span class="line">            <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Completed with an error: \(error.localizedDescription)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cacheLocally()</span><br><span class="line">    .subscribe(onCompleted: &#123;</span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">"Completed with no error"</span>)</span><br><span class="line">               &#125;,</span><br><span class="line">               onError: &#123; error <span class="keyword">in</span></span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">"Completed with an error: \(error.localizedDescription)"</span>)</span><br><span class="line">               &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><h4 id="maybe"><a class="markdownIt-Anchor" href="#maybe"></a> Maybe</h4><ol><li>å®ƒä»‹äº Single å’Œ Completable ä¹‹é—´ï¼Œå®ƒè¦ä¹ˆåªèƒ½å‘å‡ºâ¼€ä¸ªå…ƒç´ ï¼Œè¦ä¹ˆäº§â½£â¼€ä¸ª completed äº‹ä»¶ï¼Œè¦ä¹ˆäº§â½£â¼€ä¸ª error äº‹ä»¶ã€‚</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">MaybeEvent</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/// One and only sequence element is produced. (underlying observable sequence emits: `.next(Element)`, `.completed`)</span></span><br><span class="line">    <span class="keyword">case</span> success(<span class="type">Element</span>) </span><br><span class="line">    <span class="comment">/// Sequence terminated with an error. (underlying observable sequence emits: `.error(Error)`)</span></span><br><span class="line">    <span class="keyword">case</span> error(<span class="type">Swift</span>.<span class="type">Error</span>)</span><br><span class="line">    <span class="comment">/// Sequence completed successfully.</span></span><br><span class="line">    <span class="keyword">case</span> completed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>Maybe åˆå§‹åŒ–æ–¹æ³•ï¼Œåšäº† MaybeEvent -&gt; Event çš„å¤„ç†</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(subscribe: @escaping <span class="params">(@escaping MaybeObserver)</span></span></span> -&gt; <span class="type">Disposable</span>) -&gt; <span class="type">PrimitiveSequence</span>&lt;<span class="type">Trait</span>, <span class="type">Element</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> source = <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;.create &#123; observer <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> event &#123;</span><br><span class="line">            <span class="keyword">case</span> .success(<span class="keyword">let</span> element):</span><br><span class="line">                observer.on(.next(element))</span><br><span class="line">                observer.on(.completed)</span><br><span class="line">            <span class="keyword">case</span> .error(<span class="keyword">let</span> error):</span><br><span class="line">                observer.on(.error(error))</span><br><span class="line">            <span class="keyword">case</span> .completed:</span><br><span class="line">                observer.on(.completed)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">PrimitiveSequence</span>(raw: source)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>ä½¿ç”¨åœºæ™¯</p></li><li><p>Observable è°ƒâ½¤ .asMaybe() â½…æ³•ï¼Œå°†å®ƒè½¬æ¢ä¸º Maybeã€‚</p></li></ol><h3 id="rxcocoa-ç‰¹å¾-driversignalcontrolevent"><a class="markdownIt-Anchor" href="#rxcocoa-ç‰¹å¾-driversignalcontrolevent"></a> RxCocoa ç‰¹å¾ Driver/Signal/ControlEvent</h3><h4 id="driver"><a class="markdownIt-Anchor" href="#driver"></a> Driver</h4><ol><li>ä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ– UI å±‚çš„ä»£ç ã€‚ä¸è¿‡å¦‚æœä½ é‡åˆ°çš„åº åˆ—å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿â½¤å®ƒï¼š</li></ol><ul><li>ä¸ä¼šäº§â½£ error äº‹ä»¶</li><li>â¼€å®šåœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰</li><li>å…±äº«é™„åŠ ä½œâ½¤</li></ul><ol start="2"><li>ä¸ºä»€ä¹ˆè¦å« Driver å‘¢ï¼Ÿ</li></ol><p>å®ƒçš„ç›®çš„æ˜¯è®© model æ•°æ®å±‚é©±åŠ¨ UI å˜åŒ–ã€‚</p><p>E.g.</p><ul><li>Drive UI from CoreData model.</li><li>Drive UI using values from other UI elements (bindings). â€¦</li></ul><p>åˆå­¦è€…ä¼šä½¿ç”¨è¿™æ ·çš„ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> results = query.rx.text</span><br><span class="line">    .throttle(.milliseconds(<span class="number">300</span>), scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .flatMapLatest &#123; query <span class="keyword">in</span></span><br><span class="line">        fetchAutoCompleteItems(query)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">    .<span class="built_in">map</span> &#123; <span class="string">"\($0.count)"</span> &#125;</span><br><span class="line">    .bind(to: resultCount.rx.text)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">    .bind(to: resultsTableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; (<span class="number">_</span>, result, cell) <span class="keyword">in</span></span><br><span class="line">        cell.textLabel?.text = <span class="string">"\(result)"</span></span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><ul><li>å¦‚æœ fetchAutoCompleteItems observable sequence å‘å‡º error (egè¿æ¥å¤±è´¥ï¼Œè§£æé”™è¯¯), è¿™æ ·çš„é”™è¯¯ä¸ä¼šè§£ç»‘è®¢é˜…ï¼ŒUIå†ä¹Ÿä¸ä¼šå“åº”æ–°çš„æŸ¥è¯¢</li><li>å¦‚æœ fetchAutoCompleteItems è¿”å›çš„ç»“æœåœ¨æŸä¸ªåå°çº¿ç¨‹ï¼Œåå°çº¿ç¨‹è¿”å›çš„ç»“æœä¼šç»‘å®šåˆ° UIå…ƒç´ ï¼Œå¯¼è‡´ç¡®å®šæ€§çš„ crashs</li><li>ç»“æœç»‘å®šåˆ°ä¸¤ä¸ª UI å…ƒç´ ä¸Šï¼Œæ„å‘³ç€æ¯æ¬¡ç”¨æˆ·æŸ¥è¯¢éƒ½ä¼šå‘é€ 2æ¬¡ HTTP è¯·æ±‚ï¼Œè¿™ä¸æ˜¯å¼€å‘è€…çš„æœ¬æ„</li></ul><p>è¯¥ä»£ç çš„æ›´åˆé€‚ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> results = query.rx.text</span><br><span class="line">    .throttle(.milliseconds(<span class="number">300</span>), scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .flatMapLatest &#123; query <span class="keyword">in</span></span><br><span class="line">        fetchAutoCompleteItems(query)</span><br><span class="line">            .observeOn(<span class="type">MainScheduler</span>.instance)</span><br><span class="line">            <span class="comment">// results are returned on MainScheduler</span></span><br><span class="line">            .catchErrorJustReturn([])</span><br><span class="line">            <span class="comment">// in the worst case, errors are handled</span></span><br><span class="line">    &#125;</span><br><span class="line">    .share(replay: <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// HTTP requests are shared and results replayed</span></span><br><span class="line">    <span class="comment">// to all UI elements</span></span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">    .<span class="built_in">map</span> &#123; <span class="string">"\($0.count)"</span> &#125;</span><br><span class="line">    .bind(to: resultCount.rx.text)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">    .bind(to: resultsTableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; (<span class="number">_</span>, result, cell) <span class="keyword">in</span></span><br><span class="line">        cell.textLabel?.text = <span class="string">"\(result)"</span></span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>ç¡®ä¿åœ¨å¤§å‹ç³»ç»Ÿä¸­æ­£ç¡®å¤„ç†æ‰€æœ‰éœ€æ±‚å¾ˆå…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†æ˜¯æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•ï¼Œä½¿ç”¨ç¼–è¯‘å™¨å’Œç‰¹å¾æ¥è¯æ˜æ»¡è¶³è¿™äº›è¦æ±‚ã€‚</p><p>ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> results = query.rx.text.asDriver()</span><br><span class="line"><span class="comment">// This converts a normal sequence into a `Driver` sequence.</span></span><br><span class="line">    .throttle(.milliseconds(<span class="number">300</span>), scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .flatMapLatest &#123; query <span class="keyword">in</span></span><br><span class="line">        fetchAutoCompleteItems(query)</span><br><span class="line">            .asDriver(onErrorJustReturn: [])  </span><br><span class="line">            <span class="comment">// Builder just needs info about what to return in case of error.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">results</span><br><span class="line">    .<span class="built_in">map</span> &#123; <span class="string">"\($0.count)"</span> &#125;</span><br><span class="line">    <span class="comment">//Driver çš„è®¢é˜…è¦ä½¿ç”¨ driveæ¥åš</span></span><br><span class="line">    .drive(resultCount.rx.text)</span><br><span class="line">    <span class="comment">// If there is a `drive` method available instead of `bind(to:)`,</span></span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">    <span class="comment">// that means that the compiler has proven that all properties</span></span><br><span class="line">    <span class="comment">// are satisfied.</span></span><br><span class="line">results</span><br><span class="line">    .drive(resultsTableView.rx.items(cellIdentifier: <span class="string">"Cell"</span>)) &#123; (<span class="number">_</span>, result, cell) <span class="keyword">in</span></span><br><span class="line">        cell.textLabel?.text = <span class="string">"\(result)"</span></span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸Šé¢ä»£ç å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><ol><li>asDriveræ–¹æ³•å°†ControlPropertyç‰¹æ€§è½¬æ¢ä¸ºDriverç‰¹æ€§ã€‚</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.rx.text.asDriver()</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…è¦åšã€‚<br>Driver å…·æœ‰ ControlProperty ç‰¹æ€§çš„æ‰€æœ‰å±æ€§ï¼Œä»¥åŠå…¶ä»–ä¸€äº›å±æ€§ã€‚åº•å±‚çš„ observable sequence åªæ˜¯åŒ…è£…ä¸ºDriver traitï¼Œä»…æ­¤è€Œå·²ã€‚</p><ol start="2"><li>observable sequence è½¬åŒ–ä¸º Driver</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.asDriver(onErrorJustReturn: [])</span><br></pre></td></tr></table></figure><p>P.S. ä»»ä½• observable sequence è½¬åŒ–ä¸º Driver éƒ½å¿…é¡»æ»¡è¶³ä¸‹é¢ä¸‰ç‚¹</p><ul><li>Canâ€™t error out.</li><li>Observe on main scheduler.</li><li>Sharing side effects (share(replay: 1, scope: .whileConnected)).</li></ul><p>é‚£ä¹ˆï¼Œå¦‚ä½•ç¡®ä¿æ»¡è¶³è¿™äº›å‘¢ï¼Ÿåªéœ€ä½¿ç”¨æ™®é€šçš„Rxè¿ç®—ç¬¦å³å¯ã€‚asDriver(onErrorJustReturn:[])ç­‰æ•ˆäºä»¥ä¸‹ä»£ç ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> safeSequence = xs</span><br><span class="line">  .observeOn(<span class="type">MainScheduler</span>.instance)        <span class="comment">// observe events on main scheduler</span></span><br><span class="line">  .catchErrorJustReturn(onErrorJustReturn)  <span class="comment">// can't error out</span></span><br><span class="line">  .share(replay: <span class="number">1</span>, scope: .whileConnected) <span class="comment">// side effects sharing</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="type">Driver</span>(raw: safeSequence)            <span class="comment">// wrap it up</span></span><br></pre></td></tr></table></figure><p>æœ€åä¸€æ­¥æ˜¯ä½¿ç”¨ <code>drive</code> ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>bind(to:)</code>ã€‚</p><h4 id="signal"><a class="markdownIt-Anchor" href="#signal"></a> Signal</h4><ol><li>Signal å’Œ Driver ç›¸ä¼¼ï¼Œå”¯â¼€çš„åŒºåˆ«æ˜¯ï¼ŒDriver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ï¼ˆé‡æ–°å‘é€ï¼‰ä¸Šâ¼€ä¸ªå…ƒç´ ï¼Œâ½½ Signal ä¸ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ã€‚</li></ol><ul><li>ä¸ä¼šäº§â½£ error äº‹ä»¶</li><li>åœ¨ MainScheduler ç›‘å¬ï¼ˆä¸»çº¿ç¨‹ç›‘å¬ï¼‰</li><li>å…±äº«é™„åŠ ä½œâ½¤</li></ul><ol start="2"><li>Signal å’Œ Driver çš„åŒºåˆ«ç¤ºä¾‹</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> textField: <span class="type">UITextField</span> = ... </span><br><span class="line"><span class="keyword">let</span> nameLabel: <span class="type">UILabel</span> = ... </span><br><span class="line"><span class="keyword">let</span> nameSizeLabel: <span class="type">UILabel</span> = ... </span><br><span class="line"><span class="keyword">let</span> state: <span class="type">Driver</span>&lt;<span class="type">String?</span>&gt; = textField.rx.text.asDriver() </span><br><span class="line"><span class="keyword">let</span> observer = nameLabel.rx.text </span><br><span class="line">state.drive(observer) </span><br><span class="line"><span class="comment">// ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·è¾“â¼Šå§“ååè¿â¾ </span></span><br><span class="line"><span class="keyword">let</span> newObserver = nameSizeLabel.rx.text </span><br><span class="line">state.<span class="built_in">map</span> &#123; $<span class="number">0</span>?.<span class="built_in">count</span>.description &#125;.drive(newObserver)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹â¼¦æ˜¯å°†â½¤æˆ·è¾“â¼Šçš„å§“åç»‘å®šåˆ°å¯¹åº”çš„æ ‡ç­¾ä¸Šã€‚å½“â½¤æˆ·è¾“â¼Šå§“ååï¼Œæˆ‘ä»¬åˆ›å»ºäº†â¼€ä¸ªæ–°çš„è§‚å¯Ÿè€…ï¼Œâ½¤äºè®¢é˜…å§“åçš„å­—æ•°ã€‚<br>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè®¢é˜…æ—¶ï¼Œå±•ç¤ºå­—æ•°çš„æ ‡ç­¾ä¼šâ½´å³æ›´æ–°å—ï¼Ÿ å› ä¸º Driver ä¼šå¯¹æ–°è§‚å¯Ÿè€…å›æ”¾ä¸Šâ¼€ä¸ªå…ƒç´ ï¼ˆå½“å‰å§“åï¼‰ï¼Œæ‰€ä»¥è¿™â¾¥æ˜¯ä¼šæ›´æ–°çš„ã€‚åœ¨å¯¹ä»–è¿›â¾è®¢é˜…æ—¶ï¼Œæ ‡ç­¾çš„é»˜è®¤â½‚æœ¬ä¼šè¢«åˆ·æ–°ã€‚è¿™æ˜¯åˆç†çš„ã€‚</p><p>é‚£å¦‚æœæˆ‘ä»¬â½¤ Driver æ¥æè¿°ç‚¹å‡»äº‹ä»¶å‘¢ï¼Œè¿™æ ·åˆç†å—ï¼Ÿ</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> button: <span class="type">UIButton</span> = ... </span><br><span class="line"><span class="keyword">let</span> showAlert: (<span class="type">String</span>) -&gt; <span class="type">Void</span> = ... </span><br><span class="line"><span class="keyword">let</span> event: <span class="type">Driver</span>&lt;<span class="type">Void</span>&gt; = button.rx.tap.asDriver() </span><br><span class="line"><span class="keyword">let</span> observer: () -&gt; <span class="type">Void</span> = &#123; showAlert(<span class="string">"å¼¹å‡ºæç¤ºæ¡†1"</span>) &#125; </span><br><span class="line">event.drive(onNext: observer) </span><br><span class="line"><span class="comment">// ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·ç‚¹å‡» button åè¿â¾ </span></span><br><span class="line"><span class="keyword">let</span> newObserver: () -&gt; <span class="type">Void</span> = &#123; showAlert(<span class="string">"å¼¹å‡ºæç¤ºæ¡†2"</span>) &#125; </span><br><span class="line">event.drive(onNext: newObserver)</span><br></pre></td></tr></table></figure><p>å½“â½¤æˆ·ç‚¹å‡»â¼€ä¸ªæŒ‰é’®åï¼Œåˆ›å»ºâ¼€ä¸ªæ–°çš„è§‚å¯Ÿè€…ï¼Œæ¥å“åº”ç‚¹å‡»äº‹ä»¶ã€‚æ­¤æ—¶ä¼šå‘â½£ä»€ä¹ˆï¼Ÿ<br>Driver ä¼šæŠŠä¸Šâ¼€æ¬¡çš„ç‚¹å‡»äº‹ä»¶å›æ”¾ç»™æ–°è§‚å¯Ÿè€…ã€‚æ‰€ä»¥ï¼Œè¿™â¾¥çš„ newObserver åœ¨è®¢é˜…æ—¶ï¼Œå°±ä¼šæ¥å—åˆ°ä¸Šæ¬¡çš„ç‚¹å‡»äº‹ä»¶ï¼Œç„¶åå¼¹å‡ºæç¤ºæ¡†ã€‚è¿™ä¼¼ä¹ä¸å¤ªåˆç†ã€‚</p><p>äºæ˜¯æˆ‘ä»¬å°±å¼•â¼Šäº† Signal:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> event: <span class="type">Signal</span>&lt;<span class="type">Void</span>&gt; = button.rx.tap.asSignal()</span><br><span class="line"><span class="keyword">let</span> observer: () -&gt; <span class="type">Void</span> = &#123; showAlert(<span class="string">"å¼¹å‡ºæç¤ºæ¡†1"</span>) &#125; </span><br><span class="line">event.emit(onNext: observer) </span><br><span class="line"><span class="comment">// ... å‡è®¾ä»¥ä¸‹ä»£ç æ˜¯åœ¨â½¤æˆ·ç‚¹å‡» button åè¿â¾ </span></span><br><span class="line"><span class="keyword">let</span> newObserver: () -&gt; <span class="type">Void</span> = &#123; showAlert(<span class="string">"å¼¹å‡ºæç¤ºæ¡†2"</span>) &#125; </span><br><span class="line">event.emit(onNext: newObserver)</span><br></pre></td></tr></table></figure><p>åœ¨åŒæ ·çš„åœºæ™¯ä¸­ï¼ŒSignal ä¸ä¼šæŠŠä¸Šâ¼€æ¬¡çš„ç‚¹å‡»äº‹ä»¶å›æ”¾ç»™æ–°è§‚å¯Ÿè€…ï¼Œâ½½åªä¼šå°†è®¢é˜…åäº§â½£çš„ç‚¹å‡»äº‹ä»¶ï¼Œå‘å¸ƒç»™æ–°è§‚å¯Ÿè€…ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚</p><ol start="3"><li>ç»“è®º: â¼€èˆ¬æƒ…å†µä¸‹çŠ¶æ€åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Driver è¿™ä¸ªç±»å‹ï¼Œäº‹ä»¶åºåˆ—æˆ‘ä»¬ä¼šé€‰â½¤ Signal è¿™ä¸ªç±»å‹ã€‚</li></ol><h4 id="controlproperty"><a class="markdownIt-Anchor" href="#controlproperty"></a> ControlProperty</h4><ol><li>å®ƒæ˜¯ Observable / ObservableType ç‰¹æ€§ï¼Œè¡¨ç¤ºUIå…ƒç´ çš„å±æ€§ã€‚</li></ol><p>å€¼åºåˆ—ä»…è¡¨ç¤ºåˆå§‹æ§åˆ¶å€¼å’Œç”¨æˆ·å¯åŠ¨çš„å€¼æ›´æ”¹ã€‚ç¨‹åºåŒ–ä»·å€¼çš„å˜åŒ–å°†ä¸ä¼šæŠ¥å‘Šã€‚</p><ol start="2"><li><p>å®ƒçš„ç‰¹ç‚¹ï¼š</p><ul><li>æ°¸è¿œä¸ä¼šå¤±è´¥</li><li>share(replay: 1)å…±äº«æœ€æ–°å€¼<ul><li>å®ƒæ˜¯æœ‰çŠ¶æ€çš„ï¼Œä¸€æ—¦è®¢é˜…å¦‚æœæœ‰äº§ç”Ÿè¿‡å€¼ï¼Œé‚£ä¹ˆæœ€æ–°çš„å€¼ä¼šç«‹å³é‡æ’­</li></ul></li><li>å½“æ§ä»¶é”€æ¯çš„æ—¶å€™å‘é€ complete äº‹ä»¶</li><li>ä¸å‘é€ error äº‹ä»¶</li><li>åœ¨ä¸»çº¿ç¨‹ä¸Šä¼ æ’­ events</li></ul></li><li><p>å®é™…ä½¿ç”¨æ¡ˆä¾‹</p></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UISearchBar</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Reactive wrapper for `text` property.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">ControlProperty</span>&lt;<span class="type">String?</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> source: <span class="type">Observable</span>&lt;<span class="type">String?</span>&gt; = <span class="type">Observable</span>.deferred &#123; [<span class="keyword">weak</span> searchBar = <span class="keyword">self</span>.base <span class="keyword">as</span> <span class="type">UISearchBar</span>] () -&gt; <span class="type">Observable</span>&lt;<span class="type">String?</span>&gt; <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> text = searchBar?.text</span><br><span class="line">            <span class="keyword">return</span> (searchBar?.rx.delegate.methodInvoked(#selector(<span class="type">UISearchBarDelegate</span>.searchBar(<span class="number">_</span>:textDidChange:))) ?? <span class="type">Observable</span>.empty())</span><br><span class="line">                    .<span class="built_in">map</span> &#123; a <span class="keyword">in</span></span><br><span class="line">                        <span class="keyword">return</span> a[<span class="number">1</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    .startWith(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> bindingObserver = <span class="type">Binder</span>(<span class="keyword">self</span>.base) &#123; (searchBar, text: <span class="type">String?</span>) <span class="keyword">in</span></span><br><span class="line">            searchBar.text = text</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ControlProperty</span>(values: source, valueSink: bindingObserver)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UISegmentedControl</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Reactive wrapper for `selectedSegmentIndex` property.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> selectedSegmentIndex: <span class="type">ControlProperty</span>&lt;<span class="type">Int</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Reactive wrapper for `selectedSegmentIndex` property.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> value: <span class="type">ControlProperty</span>&lt;<span class="type">Int</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIControl</span>.rx.value(</span><br><span class="line">            <span class="keyword">self</span>.base,</span><br><span class="line">            getter: &#123; segmentedControl <span class="keyword">in</span></span><br><span class="line">                segmentedControl.selectedSegmentIndex</span><br><span class="line">            &#125;, setter: &#123; segmentedControl, value <span class="keyword">in</span></span><br><span class="line">                segmentedControl.selectedSegmentIndex = value</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="controlevent"><a class="markdownIt-Anchor" href="#controlevent"></a> ControlEvent</h4><ol><li><p>å®ƒæ˜¯ Observable / ObservableType ç‰¹æ€§ï¼Œè¡¨ç¤ºUIå…ƒç´ çš„äº‹ä»¶ã€‚</p></li><li><p>ç‰¹ç‚¹ï¼š</p><ul><li>æ°¸ä¸å¤±è´¥</li><li>è®¢é˜…çš„æ—¶å€™ä¸ä¼šå‘é€åˆè¯•å€¼</li><li>å½“æ§ä»¶é”€æ¯æ—¶ï¼Œå‘é€ complete</li><li>ä¸å‘é€ errors äº‹ä»¶</li><li>åœ¨ä¸»çº¿ç¨‹å‘é€ events</li></ul></li><li><p>å®é™…ä½¿ç”¨æ¡ˆä¾‹</p></li></ol><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ç¤ºä¾‹ï¼Œä½ å¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨å®ƒï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Reactive wrapper for `viewDidLoad` message `UIViewController:viewDidLoad:`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> viewDidLoad: <span class="type">ControlEvent</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> source = <span class="keyword">self</span>.methodInvoked(#selector(<span class="type">Base</span>.viewDidLoad)).<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ControlEvent</span>(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨UICollectionView + Rxä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°å®ƒï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UICollectionView</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Reactive wrapper for `delegate` message `collectionView:didSelectItemAtIndexPath:`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> itemSelected: <span class="type">ControlEvent</span>&lt;<span class="type">IndexPath</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> source = delegate.methodInvoked(#selector(<span class="type">UICollectionViewDelegate</span>.collectionView(<span class="number">_</span>:didSelectItemAt:)))</span><br><span class="line">            .<span class="built_in">map</span> &#123; a <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">return</span> a[<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">IndexPath</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ControlEvent</span>(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/Traits.md" target="_blank" rel="noopener">Traits</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åè°ƒå™¨ Redux</title>
      <link href="/2018/01/24/architecture/%E5%8D%8F%E8%B0%83%E5%99%A8-Redux/"/>
      <url>/2018/01/24/architecture/%E5%8D%8F%E8%B0%83%E5%99%A8-Redux/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="http://khanlou.com/2015/10/coordinators-redux/" target="_blank" rel="noopener">åŸæ–‡ï¼šCoordinators Redux</a></p><p>ä»Šå¹´å¹´åˆæˆ‘å†™è¿‡å…³äº <a href="http://khanlou.com/2015/01/the-coordinator/" target="_blank" rel="noopener">åè°ƒå™¨</a>çš„æ–‡ç« , ä½†æ˜¯è‡ªä»é‚£ä»¥åå¯¹äºåè°ƒå™¨çš„æ€è€ƒå·²ç»æˆç†Ÿäº†å¾ˆå¤šï¼Œæˆ‘æƒ³é€šè¿‡è¿™å‡ ä¸ªæœˆæ‰€å­¦çš„ä¸œè¥¿æ¥æ¥é‡æ–°ä»‹ç»è¿™ä¸ªè¯é¢˜ã€‚</p><p>è¿™æ˜¯æ ¹æ®æˆ‘<a href="http://nsspain.com/2015/" target="_blank" rel="noopener">ä»Šå¹´åœ¨NSSpain</a>çš„ä¸€æ¬¡æ¼”è®²æ”¹ç¼–è€Œæˆã€‚<a href="https://www.slideshare.net/secret/3jJlEE1weo0RRl" target="_blank" rel="noopener">æ­¤å¤„</a>æ‰¾åˆ°å¹»ç¯ç‰‡ã€‚åœ¨<a href="https://vimeo.com/144116310" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‰¾åˆ°è§†é¢‘ã€‚</p><h2 id="ä¸‰ä¸ªé—®é¢˜"><a class="markdownIt-Anchor" href="#ä¸‰ä¸ªé—®é¢˜"></a> ä¸‰ä¸ªé—®é¢˜</h2><h3 id="1-app-delegates-ä¸­æ”¾çš„ä¸œè¥¿å¤ªå¤šäº†"><a class="markdownIt-Anchor" href="#1-app-delegates-ä¸­æ”¾çš„ä¸œè¥¿å¤ªå¤šäº†"></a> 1. App Delegates ä¸­æ”¾çš„ä¸œè¥¿å¤ªå¤šäº†</h3><p>è‹¹æœå…¬å¸åœ¨æŒ‡å¯¼æˆ‘ä»¬å°†ä»£ç æ”¾åœ¨åˆé€‚çš„åœ°æ–¹æ–¹é¢åšå¾—éå¸¸ç³Ÿç³•ã€‚å¼„æ¸…å¦‚ä½•æ„å»º App å®Œå…¨ç”±æˆ‘ä»¬è‡ªå·±å†³å®šã€‚æœ€å¼€å§‹å†™ä»£ç çš„åœ°æ–¹æ˜¾è€Œæ˜“è§æ˜¯ appâ€™s delegate.</p><p>app delegate æ˜¯æ¯ä¸ª App çš„å…¥å£ã€‚å®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»æ“ä½œç³»ç»Ÿåˆ°åº”ç”¨ç¨‹åºçš„å­ç³»ç»Ÿæ¥å›ä¼ é€’æ¶ˆæ¯ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºå®ƒä½äºæ‰€æœ‰äº‹ç‰©çš„ä¸­å¿ƒï¼Œå› æ­¤å¾ˆå®¹æ˜“åœ¨ä¸œè¥¿æ”¾åœ¨è¿™ã€‚è¿™æ ·è®¾è®¡æ–¹å¼ä¸­çš„ä¸€ä¸ªå—å®³è€…å°±æ˜¯ rootViewController çš„é…ç½®ã€‚å¦‚æœä½ çš„ä½¿ç”¨ tabbarController ä½œä¸º rootï¼Œé‚£ä¹ˆä½ å¿…é¡»è¦åœ¨æŸä¸ªé…ç½®æ‰€æœ‰çš„ tabbarController çš„ childrenï¼Œå¹¶ä¸” App delegate å°±æ˜¯ä¸ªå¾ˆå¥½çš„åœºæ‰€ã€‚</p><p>æˆ‘å†™çš„ç¬¬ä¸€ä¸ª Appï¼ˆå¯¹äºå¤§å¤šæ•°è¯»è€…æˆ‘çŒœæµ‹ï¼Œè¿™æ˜¯çœŸçš„ï¼‰ï¼Œæˆ‘åœ¨æˆ‘çš„AppDelegateä¸­ï¼Œä¸º rootviewcontroller é…ç½®äº†æ‰€æœ‰é…ç½®ã€‚é‚£äº›ä»£ç çœŸçš„ä¸å±äºè¿™é‡Œï¼Œå†™åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿ã€‚</p><p>åœ¨æˆ‘å†™å®Œæˆ‘ç¬¬ä¸€ä¸ª app ä»¥åæˆ‘æ„è¯†åˆ°äº†è¿™ä¸ªï¼Œç„¶åæˆ‘å˜å¾—èªæ˜äº†ï¼Œæˆ‘æ˜¯ç”¨äº†è¿™æ ·çš„æŠ€å·§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SKTabBarController</span> : <span class="title">UITabBarController</span></span></span><br></pre></td></tr></table></figure><p>æˆ‘ä¼šåˆ›å»ºä¸€ä¸ªæˆ‘æƒ³è¦ä½¿ç”¨çš„ rootViewController å­ç±»ï¼Œç„¶åæˆ‘ä¼šæŠŠä»£ç æŒªåˆ°è¿™é‡Œã€‚è¿™åªæ˜¯å…³äºè¿™ä¸ªé—®é¢˜çš„ä¸´æ—¶è¡¥ä¸ï¼Œæœ€åå‘ç°è¿™ä¹Ÿä¸æ˜¯æ­¤ä»£ç è¯¥æ”¾çš„åœ°æ–¹ã€‚æˆ‘å»ºè®®æˆ‘ä»¬ç ”ç©¶è¿™ä¸ªå¯¹è±¡â€”â€”rootViewControllerï¼Œä»è´£ä»»çš„è§’åº¦ã€‚ç®¡ç†å­è§†å›¾æ§åˆ¶å™¨å±äºè¿™äº›èŒè´£ï¼Œä½†åˆ†é…å’Œé…ç½®å®ƒä»¬çš„èŒè´£ä¸å¤šã€‚æˆ‘ä»¬æ­£åœ¨å¯¹ä¸€ä¸ªä»æœªæ‰“ç®—è¿›è¡Œå­ç±»åŒ–çš„ä¸œè¥¿è¿›è¡Œå­ç±»åŒ–ï¼Œåªæ˜¯ä¸ºäº†æˆ‘ä»¬å¯ä»¥éšè—ä¸€äº›æ— å®¶å¯å½’çš„ä»£ç ã€‚</p><p>å¯¹äºæ­¤åº”ç”¨ç¨‹åºé…ç½®é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¥½çš„å®¶ã€‚</p><h3 id="2å¤ªå¤šè´£ä»»"><a class="markdownIt-Anchor" href="#2å¤ªå¤šè´£ä»»"></a> 2.å¤ªå¤šè´£ä»»</h3><p>è¿™é‡Œæœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ã€‚å•ä¸ªViewControllerä¹Ÿé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼ŒæŠŠå¤§é‡çš„è´£ä»»æ”¾å€¾å€’App delegateé‡Œé¢ã€‚</p><p>ViewController ä¸­è´Ÿè´£çš„ä¸€äº›äº‹æƒ…ï¼š</p><ol><li>æ¨¡å‹è§†å›¾ç»‘å®š</li><li>å­è§†å›¾åˆ†é…å†…å­˜</li><li>è·å–æ•°æ®</li><li>å¸ƒå±€</li><li>æ•°æ®è½¬æ¢</li><li>å¯¼èˆªæµç¨‹</li><li>ç”¨æˆ·è¾“å…¥</li><li>æ¨¡å‹å˜åŒ–</li><li>è¿˜æœ‰æ›´å¤š</li></ol><p>æˆ‘æè¿‡ä¸€äº›æ–¹æ³•å°†è¿™äº›è´£ä»»è—åˆ° ViewController çš„ childrenä¸­ï¼Œæ–¹æ³•åœ¨<a href="http://khanlou.com/2014/09/8-patterns-to-help-you-destroy-massive-view-controller/" target="_blank" rel="noopener">8 Patterns to Help You Destroy Massive View Controller</a>ä¸­. æ‰€æœ‰è´£ä»»ä¸èƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™æ · ViewController ä¸­çš„ä»£ç å°±ä¼šå°‘äº 3000è¡Œäº†ã€‚</p><p>å“ªäº›ä¸œè¥¿åº”è¯¥åœ¨è¿™ä¸ªç±»ï¼Ÿå“ªäº›åº”è¯¥åœ¨åˆ«çš„åœ°æ–¹ï¼ŸViewControllerçš„å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿè¿™äº›é—®é¢˜è¿˜æ²¡æœ‰ç†æ¸…æ¥šã€‚</p><p>å¼•ç”¨ Graham Lee è¯´çš„ä¸€å¥è¯ï¼Œæˆ‘å¾ˆå–œæ¬¢ã€‚</p><blockquote><p>When you get overly attached to MVC, then you look at every class you create and ask the question â€œis this a model, a view, or a controller?â€. Because this question makes no sense, the answer doesnâ€™t either: anything that isnâ€™t evidently data or evidently graphics gets put into the amorphous â€œcontrollerâ€ collection, which eventually sucks your entire codebase into its innards like a black hole collapsing under its own weight.</p></blockquote><p>ä»€ä¹ˆæ˜¯ViewControllerï¼ŸSmalltalkianæ„ä¹‰ä¸Šçš„æ§åˆ¶å™¨<a href="http://khanlou.com/2014/03/model-view-whatever/" target="_blank" rel="noopener">æœ€åˆä¸¥æ ¼æ˜¯ä¸ºç”¨æˆ·è¾“å…¥è€Œè®¾è®¡</a>çš„ã€‚ç”šè‡³â€œæ§åˆ¶â€ä¸€è¯ä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†éº»çƒ¦ã€‚å¦‚æˆ‘<a href="http://khanlou.com/2014/11/a-controller-by-any-other-name/" target="_blank" rel="noopener">ä¹‹å‰æ‰€å†™</a>ï¼š</p><blockquote><p>When you call something a Controller, it absolves you of the need to separate your concerns. Nothing is out of scope, since its purpose is to control things. Your code quickly devolves into a procedure, reaching deep into other objects to query their state and manipulate them from afar. Boundless, it begins absorbing responsibilities.</p></blockquote><h3 id="å¹³ç¼“çš„-flow"><a class="markdownIt-Anchor" href="#å¹³ç¼“çš„-flow"></a> å¹³ç¼“çš„ Flow</h3><p>æœ€åä¸€ä¸ªæˆ‘æƒ³è¦è®¨è®ºçš„é—®é¢˜æ˜¯ï¼šnavigation flow</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView didSelectRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;  </span><br><span class="line">  <span class="keyword">id</span> object = [<span class="keyword">self</span>.dataSource objectAtIndexPath:indexPath];  </span><br><span class="line">  <span class="built_in">SKDetailViewController</span> *detailViewController = [[<span class="built_in">SKDetailViewController</span> alloc] initWithDetailObject:object];  </span><br><span class="line">  [<span class="keyword">self</span>.navigationController pushViewController:detailViewController animated:<span class="literal">YES</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº‹ä¸€æ®µå¾ˆå¸¸è§çš„ä»£ç ï¼Œä¸å¹¸çš„æ˜¯ï¼Œä»–æ˜¯åƒåœ¾ä»£ç ã€‚è®©æˆ‘ä»¬ä¸€è¡Œè¡Œçœ‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> object = [<span class="keyword">self</span>.dataSource objectAtIndexPath:indexPath];</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„ <code>dataSource</code> æ˜¯ ViewController é€»è¾‘ä¸Šçš„ childï¼Œç„¶åæˆ‘ä»¬æ­£åœ¨è·Ÿä»–è¦æˆ‘ä»¬éœ€è¦å¼•ç”¨çš„çš„å¯¹è±¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SKDetailViewController</span> *detailViewController = [[<span class="built_in">SKDetailViewController</span> alloc] initWithDetailObject:object];</span><br></pre></td></tr></table></figure><p>è¿™é‡Œäº‹æƒ…å¼€å§‹å˜å¾—éº»çƒ¦ã€‚ViewController æ­£åœ¨å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ ViewControllerï¼Œç„¶åé…ç½®å®ƒã€‚è¿™ä¸ª ViewController â€çŸ¥é“â€œ åœ¨ flow ä¸­æ¥ä¸‹æ¥ä¼šæµå‡ºä»€ä¹ˆã€‚ä»–çŸ¥é“æ–°çš„ ViewController æ˜¯æ€ä¹ˆé…ç½®çš„ã€‚æ­£åœ¨æ‰§è¡Œ Presenting çš„ ViewController çŸ¥é“ä»–æ‰€åœ¨ App ä½ç½®ä¸­çš„å¤§é‡ç»†èŠ‚ï¼ˆæ–° ViewControllerçš„é…ç½®ç»†èŠ‚ï¼‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.navigationController pushViewController:detailViewController animated:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰è¡Œæ˜¯å®ƒå®Œå…¨åç¦»è½¨é“çš„åœ°æ–¹ã€‚è¿™ä¸ª ViewController çŸ¥é“äº†ä»–çš„çˆ¶çº§ ViewControllerï¼Œå› ä¸ºè¯·è®°ä½ï¼Œè¿™äº›è§†å›¾æ§åˆ¶å™¨åœ¨åŒä¸€å±‚æ¬¡ç»“æ„ä¸­ï¼Œå­ ViewController ä¼šå‘çˆ¶ ViewController å‘é€æ¶ˆæ¯ï¼Œå‘Šè¯‰ä»–è¦åšä»€ä¹ˆã€‚å­ ViewController æ­£åœ¨æŒ‡æŒ¥ä»–çš„çˆ¶äº²ã€‚åœ¨ç°å®ä¸–ç•Œé‡Œï¼Œå­©å­ä¸åº”è¯¥åˆ°å¤„æŒ‡æŒ¥è‡ªå·±çš„çˆ¶äº²ã€‚<strong>åœ¨ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä¼šè¯´å­©å­ç”šè‡³ä¸åº”è¯¥çŸ¥é“ä»–ä»¬çš„çˆ¶äº²æ˜¯è°ï¼</strong></p><p>åœ¨<a href="http://khanlou.com/2014/09/8-patterns-to-help-you-destroy-massive-view-controller/" target="_blank" rel="noopener">8ç§æ¨¡å¼å¸®åŠ©ä½ å¹²æ‰å¤§é‡çš„ViewController</a>, æˆ‘å»ºè®®ä½¿ç”¨ä¸€ä¸ª <code>Navigator</code> ç±»å‹ï¼Œå®ƒå¯ä»¥æ³¨å…¥åˆ°é‚£äº›åŒ…å«å¯¼èˆªé€»è¾‘çš„ ViewControllers ä¸­ã€‚å¦‚æœä½ æƒ³è¦æŠŠå¯¼èˆªé€»è¾‘æ”¾åˆ°åŒä¸€ä¸ªåœ°æ–¹ï¼Œ <code>Navigators</code> æ˜¯ä¸€ä¸ªä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå¿«é‡åˆ°ä¸€ä¸ªå¯¼èˆªå™¨æ²¡åŠæ³•å¸®æˆ‘ä»¬è§£å†³çš„é—®é¢˜ã€‚</p><p>åœ¨è¿™ä¸‰è¡Œä»£ç ä¸­æœ‰å¾ˆå¤šé€»è¾‘ï¼Œä½†æ˜¯ ViewController ä¸æ˜¯è¿™äº›é€»è¾‘å‘ç”Ÿçš„åœ°æ–¹ã€‚æƒ³è±¡ä½ æœ‰ä¸ªç¼–è¾‘å›¾åƒçš„ app</p><p>ä½ çš„ <code>PhotoSelectionViewController</code> presents <code>StraighteningViewController</code> presents <code>FilteringViewController</code> presents <code>CaptioningViewController</code>ã€‚ä½ çš„å¯¼èˆª flow ç°åœ¨åˆ†å¸ƒåœ¨ä¸‰ä¸ªä¸åŒçš„å¯¹è±¡ä¹‹é—´ã€‚è¿›ä¸€æ­¥è¯´ï¼ŒæŸä¸ª ViewController presenting <code>PhotoSelectionViewController</code> ï¼Œä½†æ˜¯ dismissal é€»è¾‘å¿…é¡»è¦åœ¨ <code>CaptioningViewController</code> ä¸­å¤„ç†ã€‚</p><p>ä¼ é€’ <code>Navigator</code> ä½¿è¿™äº› ViewControllers ä¿æŒé“¾çŠ¶è¿æ¥åœ¨ä¸€èµ·ï¼Œå¹¶ä¸èƒ½çœŸæ­£è§£å†³æ¯ä¸ª ViewController çŸ¥é“é“¾ä¸­ä¸‹ä¸€ä¸ªçš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬ä¹Ÿéœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="libraries-vs-frameworks"><a class="markdownIt-Anchor" href="#libraries-vs-frameworks"></a> Libraries vs Frameworks</h3><p>æˆ‘è®¤ä¸ºApple å¸Œæœ›æˆ‘ä»¬ä»¥æ‰€æœ‰è¿™äº›æ–¹å¼ç¼–å†™ä»£ç ã€‚ä»–ä»¬å¸Œæœ›æˆ‘ä»¬ä½¿ç”¨ ViewController æˆä¸ºä¸–ç•Œä¸­å¿ƒï¼Œå› ä¸ºæ‰€æœ‰ä»¥ç›¸åŒæ ·å¼ç¼–å†™çš„ app éƒ½å¯ä»¥é€šè¿‡æ›´æ”¹SDKå‘æŒ¥æœ€å¤§çš„å½±å“åŠ›ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºå¼€å‘è€…ï¼Œè¿™å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„ä¸¾åŠ¨ã€‚æˆ‘ä»¬æ˜¯è´Ÿè´£å°†æ¥ç»´æŠ¤ app çš„äººï¼Œå¯é çš„è®¾è®¡å’Œä»£ç å¯æ‰©å±•æ€§æ˜¯æˆ‘ä»¬æœ€çœ‹é‡çš„ã€‚</p><p>ä»–ä»¬è¯´libraries å’Œ frameworks çš„åŒºåˆ«æ˜¯ï¼Œä½ è°ƒç”¨ librariesï¼Œframeworks è°ƒç”¨ä½ ã€‚æˆ‘æƒ³å°½å¯èƒ½åƒä¾èµ– libraries çš„æ–¹å¼ï¼Œå¯¹å¾… 3rd-party ä¾èµ–ã€‚</p><p>å½“ä½¿ç”¨ <code>UIKit</code> ï¼Œä½ ä¸éœ€è¦è´Ÿè´£ä»€ä¹ˆã€‚è°ƒç”¨ <code>-pushViewController:animated:</code> ç„¶åå®ƒåšä¸€äº›å·¥ä½œã€‚å¹¶ä¸”åœ¨å°†æ¥çš„æŸä¸ªä¸ç¡®å®šçš„æ—¶é—´ï¼Œä¸‹ä¸€ä¸ªViewControllerå‡ºç°ä»–ä¼šè°ƒç”¨ <code>viewDidLoad:</code> åœ¨è¿™é‡Œé¢ä½ å¯åšæ›´å¤šäº‹ã€‚ä½ ä¸åº”è¯¥è®© <code>UIKit</code> å†³å®šä½•æ—¶è¿è¡Œä»£ç ï¼Œè€Œæ˜¯åº”å°½å¿«é€€å‡º <code>UIKit</code> -land, ä»¥ä¾¿ä½ å¯ä»¥å®Œå…¨æ§åˆ¶ä»£ç çš„æµå‘ã€‚</p><p>æˆ‘æ›¾ç»å°†ViewControllerä¸º app ä¸­æœ€é«˜ç­‰çº§çš„ä¸œè¥¿ï¼Œè¿™äº›ä¸œè¥¿çŸ¥é“å¦‚ä½•è¿è¡Œæ•´ä¸ªappã€‚ä½†æ˜¯æˆ‘å¼€å§‹æƒ³é¢ è¦†è¿™ä¸ªæƒ³æ³•åä»–ä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚view å¯¹å…¶ ViewControlleræ˜¯é€æ˜çš„ã€‚view ç”± ViewController æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬ä»¥ç›¸åŒçš„æ–¹å¼ä½¿è§†å›¾æ§åˆ¶å™¨åªæ˜¯å¦ä¸€é€æ˜çš„ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿ</p><h2 id="coordinators"><a class="markdownIt-Anchor" href="#coordinators"></a> Coordinators</h2><p><strong>ä»€ä¹ˆæ˜¯ Coordinators ï¼Ÿ</strong></p><p>Coordinator æ˜¯ç”¨äºç®¡ç†ä¸€ä¸ªor å¤šä¸ªViewControllerçš„å¯¹è±¡ã€‚å°†æ‰€æœ‰é©±åŠ¨é€»è¾‘ä» ViewControllerä¸­ç§»é™¤ï¼Œå¹¶å°†è¿™äº›å†…å®¹å‘ä¸Šç§»åŠ¨ä¸€å±‚ï¼Œè¿™ä¼šä½¿ä½ çš„ç”Ÿæ´»å˜å¾—æ›´åŠ ç¾å¥½ã€‚</p><p>è¿™ä¸€åˆ‡éƒ½ä» app Coordinator å¼€å§‹ã€‚Coordinatorè§£å†³ app delegate ä¸­å†…å®¹è¿‡å¤šçš„é—®é¢˜ã€‚app delegate å¯ä»¥ä¿ç•™app Coordinatorå¹¶å¯åŠ¨å®ƒã€‚app Coordinator å°†ä¸ºapp è®¾ç½®ä¸»è§†å›¾æ§åˆ¶å™¨ã€‚å¯ä»¥åœ¨æ–‡çŒ®ä¸­æ‰¾åˆ°è¿™ç§æ¨¡å¼ï¼Œä¾‹å¦‚<a href="https://www.amazon.com/Patterns-Enterprise-Application-Architecture-Martin/dp/0321127420" target="_blank" rel="noopener">ä¼ä¸šåº”ç”¨ç¨‹åºä½“ç³»ç»“æ„æ¨¡å¼</a>ä¹‹ç±»çš„ä¹¦ã€‚ä»–ä»¬æŠŠ Coordinator å«åš <a href="http://martinfowler.com/eaaCatalog/applicationController.html" target="_blank" rel="noopener">Application Controller</a>. app coordinator æ˜¯ Application Controller çš„ç‰¹åˆ«ç‰ˆï¼Œå°¤å…¶å¯¹äº iOSã€‚app coordinator å¯ä»¥åˆ›å»ºå¹¶é…ç½® ViewControllerï¼Œæˆ–è€…å®ƒå¯ä»¥é•¿ç”Ÿæ–°çš„å­ Coordinatoræ¥æ‰§è¡Œå­ä»»åŠ¡ã€‚</p><p>coordinators å¯ä»¥æ¥ç®¡ ViewControllerçš„å“ªäº›ä»»åŠ¡ï¼Ÿä¸»è¦æ˜¯ navigation å’Œ model å˜åŒ–.(æˆ‘çš„æ„æ€æ˜¯é€šè¿‡æ¨¡å‹å˜åŒ–å°†ç”¨æˆ·çš„æ›´æ”¹ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œæˆ–è€…å¯¹ API è¿›è¡Œ <code>PUT</code> or <code>POST</code> è¯·æ±‚ï¼Œè¿™äº›éƒ½ä¼šç ´åæ€§åœ°ä¿®æ”¹ç”¨æˆ·çš„æ•°æ®ã€‚)</p><p>å½“ä½ æŠŠè¿™äº›ä»»åŠ¡ä»ViewControllerä¸­æ‹¿èµ°ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†ä¸€ä¸ªæƒ°æ€§çš„ ViewControllerã€‚å®ƒå¯ä»¥å‘ˆç°ï¼Œå¯ä»¥è·å–æ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œè½¬æ¢ä»¥è¿›è¡Œå‘ˆç°ã€æ˜¾ç¤ºï¼Œä½†è‡³å…³é‡è¦çš„æ˜¯æ— æ³•å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œæ¯å½“å±•ç¤º ViewController æ—¶ï¼Œéƒ½ä¸ä¼šè®©ä»–è‡ªå·±æ§åˆ¶ã€‚æ¯å½“éœ€è¦è®©æˆ‘ä»¬çŸ¥é“äº‹ä»¶æˆ–ç”¨æˆ·è¾“å…¥æ—¶ï¼Œå®ƒéƒ½ä¼šä½¿ç”¨å§”æ‰˜æ–¹æ³•ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä»£ç ç¤ºä¾‹ã€‚</p><h3 id="ä»£ç ç¤ºä¾‹"><a class="markdownIt-Anchor" href="#ä»£ç ç¤ºä¾‹"></a> ä»£ç ç¤ºä¾‹</h3><p>è®©æˆ‘ä»¬ä» App delegateå¼€å§‹</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;  </span><br><span class="line">  <span class="keyword">self</span>.window = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:[<span class="built_in">UIScreen</span> mainScreen].bounds];  </span><br><span class="line">  <span class="keyword">self</span>.rootViewController = [[<span class="built_in">UINavigationController</span> alloc] init];</span><br><span class="line">  <span class="keyword">self</span>.appCoordinator = [[<span class="built_in">SKAppCoordinator</span> alloc] initWithNavigationController:<span class="keyword">self</span>.rootViewController];  </span><br><span class="line">  [<span class="keyword">self</span>.appCoordinator start]; </span><br><span class="line">  [<span class="keyword">self</span>.window makeKeyAndVisible];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>app delegate æ„å»º app çš„window å’Œ root ViewControllerï¼Œç„¶åå¼€å¯ app Coordinatorã€‚Coordinatorçš„åˆå§‹åŒ–ä¸å¼€å§‹å·¥ä½œæ˜¯åˆ†å¼€çš„ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŒ‰è‡ªå·±çš„æ„æ„¿ï¼ˆæ‡’æƒ°ï¼Œè´ªå©ªç­‰ï¼‰åˆ›å»ºå®ƒï¼Œå¹¶ä¸”åªæœ‰åœ¨å‡†å¤‡å¥½åæ‰èƒ½å¯åŠ¨å®ƒã€‚</p><p>Coordinator å°±æ˜¯ä¸€ä¸ª NSObject:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SKAppCoordinator</span> : <span class="title">NSObject</span></span></span><br></pre></td></tr></table></figure><p>è¿™å¾ˆæ£’ï¼Œè¿™é‡Œæ²¡æœ‰ç§˜å¯†ï¼Œ<code>UIViewController</code> æœ‰ä¸Šåƒè¡Œä»£ç ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å½“æˆ‘ä»¬è°ƒç”¨ä»–çš„æ–¹æ³•æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºä»–æ˜¯é—­æºçš„ã€‚ç®€å•çš„ <code>NSObject</code> ç±»å‹å¯¹è±¡è¿è¡Œappï¼Œå¯ä½¿ä¸€åˆ‡å˜å¾—æ›´åŠ ç®€å•ã€‚</p><p>app coordinator ä½¿ç”¨ä»–éœ€è¦çš„æ•°æ®åˆå§‹åŒ–ï¼Œè¿™äº›æ•°æ®åŒ…æ‹¬ root ViewController</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithNavigationController:(<span class="built_in">UINavigationController</span> *)navigationController &#123;  </span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];  </span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>; </span><br><span class="line">  _navigationController = navigationController; </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨ <code>-start</code> æ–¹æ³•ï¼Œcoordinatorå°±ä¼šå¼€å§‹å·¥ä½œ</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)start &#123;  </span><br><span class="line">  <span class="keyword">if</span> ([<span class="keyword">self</span> isLoggedIn]) &#123;  </span><br><span class="line">    [<span class="keyword">self</span> showContent];  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    [<span class="keyword">self</span> showAuthentication];  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸€å¼€å§‹ Coordinator å°±åšå†³å®šï¼ä»¥å‰åƒè¿™æ ·çš„é€»è¾‘æ²¡æœ‰å›ºå®šä½ç½®ï¼Œä½ å¯ä»¥æŠŠä»–æ”¾åœ¨ appdelegateä¸­æˆ–è€… ViewControllerä¸­ï¼Œä½†æ˜¯æ”¾è¿™ä¸¤ä¸ªåœ°æ–¹éƒ½æœ‰å„è‡ªçš„ç¼ºé™·ã€‚åœ¨ ViewControllerä¸­ï¼Œä½ æœ‰ä¸€ä¸ª ViewControlleråšè¶…å‡ºå®ƒæœ¬èº«è´£ä»»çš„äº‹æƒ…ã€‚åœ¨ appdelegateä¸­ï¼Œä½ ä¼šæ”¾å…¥ä¸€äº›ä¸ä»–ä¸ç›¸å…³çš„ä»£ç æ±¡æŸ“ä»–ã€‚</p><p>è®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹ <code>-showAuthentication</code> æ–¹æ³•ã€‚åœ¨è¿™é‡Œï¼Œbase Coordinator ç”Ÿæˆ å­ Coordinatorï¼Œå¹¶è®©å…¶æ‰§è¡Œå­ä»»åŠ¡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)showAuthentication &#123;  </span><br><span class="line">  <span class="built_in">SKAuthenticationCoordinator</span> *authCoordinator = [[<span class="built_in">SKKAuthenticationCoordinator</span> alloc] initWithNavigationViewController:<span class="keyword">self</span>.navigationController];  </span><br><span class="line">  authCoordinator.delegate = <span class="keyword">self</span>;  </span><br><span class="line">  [authCoordinator start];  </span><br><span class="line">  [<span class="keyword">self</span>.childCoordinators addObject:authCoordinator];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>childCoordinators</code> æ•°ç»„å¼•ç”¨ Coordinatorsï¼Œé˜²æ­¢å…¶è¢«é”€æ¯ã€‚</p><p>ViewControllerå­˜åœ¨ä¸€æ£µæ ‘ä¸­ï¼Œå¹¶ä¸”æ¯ä¸ª ViewControlleréƒ½åŒ…å«ä¸€ä¸ª viewã€‚ viewå­˜åœ¨äº subViews æ ‘ä¸­ï¼Œè€Œä¸”æ¯ä¸ª subview æœ‰ä¸€ä¸ª layerã€‚layersä¹Ÿå­˜åœ¨äºä¸€æ£µæ ‘ä¸­ã€‚å› ä¸º <code>childCoordinators</code> ï¼Œä½ ä¹Ÿä¼šå¾—åˆ°ä¸€æ£µ Coordinators æ ‘ã€‚</p><p>å­ Coordinator ä¼šåˆ›å»ºä¸€äº› ViewControllersï¼Œç­‰å¾…ä»–ä»¬å·¥ä½œï¼Œviewcontroller å·¥ä½œå®Œå Coordinatorä¼šé€šçŸ¥æˆ‘ä»¬ã€‚å½“ Coordinator å‘é€ä¿¡å·å‘ŠçŸ¥ViewControllerå·¥ä½œå®Œæ—¶ï¼Œå®ƒä¼šæ¸…ç†è‡ªå·±ï¼Œå¼¹å‡ºä»–æ·»åŠ çš„æ‰€æœ‰ ViewControllerï¼Œç„¶åä½¿ç”¨å§”æ‰˜å°†æ¶ˆæ¯å‘é€åˆ°çˆ¶çº§ã€‚</p><p>ä¸€æ—¦æˆ‘ä»¬å·²è®¤è¯ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª delegate æ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬å…è®¸å­ Coordinator é”€æ¯ï¼Œç„¶åæˆ‘ä»¬è¿”å›å¹³å¸¸çš„ç¨‹åºä¸­ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)coordinatorDidAuthenticate:(<span class="built_in">SKAuthenticationCoordinator</span> *)coordinator &#123;  </span><br><span class="line">  [<span class="keyword">self</span>.childCoordinators removeObject:coordinator];  </span><br><span class="line">  [<span class="keyword">self</span> showContent];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨èº«ä»½éªŒè¯ Coordinator å†…éƒ¨ï¼Œå®ƒåˆ›å»ºæ‰€éœ€çš„ä»»ä½•Viewcontrollerï¼Œå¹¶å°†å…¶æ¨å…¥å¯¼èˆªæ§åˆ¶å™¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AuthCoordinator</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithNavigationController:(<span class="built_in">UINavigationController</span> *)navigationController &#123;  </span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];  </span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  </span><br><span class="line">  _navigationController = navigationController;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–ç±»ä¼¼äºapp coordinator.</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)start &#123;  </span><br><span class="line">  <span class="built_in">SKFirstRunViewController</span> *firstRunViewcontroller = [<span class="built_in">SKFirstRunViewController</span> new];  </span><br><span class="line">  firstRunViewcontroller.delegate = <span class="keyword">self</span>;  </span><br><span class="line">  [<span class="keyword">self</span>.navigationController pushViewController:firstRunViewcontroller animated:<span class="literal">NO</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èº«ä»½éªŒè¯éœ€è¦ä»â€œé¦–æ¬¡è¿è¡Œ viewcontrollerâ€å¼€å§‹ã€‚è¯¥viewcontrollerå…·æœ‰ç”¨äºæ³¨å†Œå’Œç™»å½•çš„æŒ‰é’®ï¼Œè¿˜å¯èƒ½åŒ…å«ä¸€äº›å¹»ç¯ç‰‡ï¼Œè§£é‡Šäº†appã€‚è®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨è¯¥Viewcontroller å¹¶æˆä¸ºå…¶ä»£è¡¨ã€‚</p><p>è¯¥ViewController æœ‰ä¸€ä¸ª delegateï¼Œå› æ­¤å½“ç”¨æˆ·ç‚¹å‡»â€œæ³¨å†Œâ€æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°é€šçŸ¥ã€‚Coordinator å°†å¤„ç†è¯¥æ“ä½œï¼Œè€Œä¸æ˜¯ViewControlleréœ€è¦çŸ¥é“è¦åˆ›å»ºå’Œå‘ˆç°çš„æ³¨å†ŒViewControllerã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)firstRunViewControllerDidTapSignup:(<span class="built_in">SKFirstRunViewController</span> *)firstRunViewController &#123;  </span><br><span class="line">  <span class="built_in">SKSignUpViewController</span> *signUpViewController = [[<span class="built_in">SKSignUpViewController</span> alloc] init];  </span><br><span class="line">  signupViewController.delegate = <span class="keyword">self</span>;  </span><br><span class="line">  [<span class="keyword">self</span>.navigationController pushViewController:signupViewController animated:<span class="literal">YES</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Coordinator æˆä¸ºè¿™ä¸ªæ³¨å†Œè¿‡çš„ ViewControllerçš„ä»£ç†ï¼Œä¸ºäº†å®ƒå¯ä»¥åœ¨æŒ‰ä¸‹æŒ‰é’®æ—¶é€šçŸ¥æˆ‘ä»¬ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)signUpViewController:(<span class="built_in">SKSignUpViewController</span> *)signupViewController didTapSignupWithEmail:(<span class="built_in">NSString</span> *)email password:(<span class="built_in">NSString</span> *)password &#123;  </span><br><span class="line">  <span class="comment">//...  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¸å¦‚æ­¤ç±»ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®é™…ä¸Šæ‰§è¡Œäº†æ³¨å†ŒAPIè¯·æ±‚å¹¶ä¿å­˜äº†èº«ä»½éªŒè¯ tokenï¼Œç„¶åé€šçŸ¥äº†çˆ¶coordinatorã€‚</p><p>æ¯å½“ViewControllerå‘ç”Ÿä»»ä½•äº‹æƒ…ï¼ˆä¾‹å¦‚ç”¨æˆ·è¾“å…¥ï¼‰æ—¶ï¼ŒViewControlleréƒ½ä¼šå‘Šè¯‰å…¶delegateï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºCoordinatorï¼‰ï¼Œå¹¶ä¸”Coordinatorå°†æ‰§è¡Œç”¨æˆ·æƒ³è¦çš„å®é™…ä»»åŠ¡ã€‚è®©Coordinatoræ¥å®Œæˆè¿™é¡¹å·¥ä½œå¾ˆé‡è¦ï¼Œä»¥ä¾¿ ViewController ä¿æŒæƒ°æ€§ã€‚</p><h3 id="ä¸ºä»€ä¹ˆ-coordinators-å¾ˆå¥½ç”¨"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆ-coordinators-å¾ˆå¥½ç”¨"></a> ä¸ºä»€ä¹ˆ Coordinators å¾ˆå¥½ç”¨</h3><h4 id="1æ¯ä¸ª-viewcontroller-ç°åœ¨æ˜¯å­¤ç«‹çš„"><a class="markdownIt-Anchor" href="#1æ¯ä¸ª-viewcontroller-ç°åœ¨æ˜¯å­¤ç«‹çš„"></a> 1.æ¯ä¸ª ViewController ç°åœ¨æ˜¯å­¤ç«‹çš„</h4><p>é™¤äº†çŸ¥é“å¦‚ä½•å‘ˆç°æ•°æ®ï¼ŒViewController å•¥éƒ½ä¸çŸ¥é“ã€‚æ¯å½“æœ‰ä»€ä¹ˆäº‹å‘ç”Ÿæ—¶ï¼Œå®ƒéƒ½ä¼šé€šçŸ¥ delegateï¼Œä½†æ˜¯å½“ç„¶å®ƒä¸çŸ¥é“å…¶ delegate æ˜¯è°ã€‚</p><p>ä»¥å‰ï¼Œå½“åˆ†æ”¯æ—¶ï¼ŒViewController éœ€è¦é—®â€œå¥½å§ï¼Œæˆ‘åœ¨iPadè¿˜æ˜¯iPhoneä¸Šï¼Ÿâ€ã€‚â€œç”¨æˆ·æ˜¯å¦æ­£åœ¨æ¥å—A / Bæµ‹è¯•ï¼Ÿâ€ ä»–ä»¬ä¸å†éœ€è¦æè¿™æ ·çš„é—®é¢˜ã€‚æˆ‘ä»¬æ˜¯å¦åªæ˜¯å°†è¿™ä¸ªæœ‰æ¡ä»¶çš„é—®é¢˜æ¨ç»™äº† Coordinator ï¼Ÿä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»¥æ›´å¥½çš„æ–¹å¼è§£å†³å®ƒã€‚</p><p>å½“ç¡®å®éœ€è¦ä¸€æ¬¡å…·æœ‰ä¸¤ä¸ª flow æ—¶ï¼Œå¯¹äºA / Bæµ‹è¯•æˆ–å¤šä¸ª size classesï¼Œä½ å¯ä»¥äº¤æ¢æ•´ä¸ª Coordinator å¯¹è±¡ï¼Œè€Œä¸å¿…åœ¨æ•´ä¸ª ViewController ä¸Šç²˜è´´ä¸€å †æ¡ä»¶ã€‚</p><p>å¦‚æœä½ æƒ³äº†è§£ flow çš„å·¥ä½œæ–¹å¼ï¼Œé‚£ä¹ˆè¿™éå¸¸å®¹æ˜“ï¼Œå› ä¸ºæ‰€æœ‰ä»£ç éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚</p><h4 id="2viewcontrollers-ç°åœ¨å¯ä»¥å¤ç”¨"><a class="markdownIt-Anchor" href="#2viewcontrollers-ç°åœ¨å¯ä»¥å¤ç”¨"></a> 2.ViewControllers ç°åœ¨å¯ä»¥å¤ç”¨</h4><p>ViewControllers å¯¹è¦æ˜¾ç¤ºçš„ä¸Šä¸‹æ–‡æˆ–æŒ‰é’®çš„ç”¨é€”ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚å®ƒä»¬å¯ä»¥è¢«ä½¿ç”¨å’Œé‡æ–°ä½¿ç”¨ï¼Œä»¥ä¿æŒå…¶ç¾è§‚ï¼Œè€Œä¸ä¼šæ‹–ç´¯ä»»ä½•é€»è¾‘ã€‚</p><p>å¦‚æœä½ è¦ç¼–å†™iPadç‰ˆæœ¬çš„appï¼Œåˆ™åªéœ€æ›¿æ¢ Coordinator å³å¯ï¼Œå¹¶ä¸”å¯ä»¥é‡å¤ä½¿ç”¨æ‰€æœ‰ViewControllersã€‚</p><h4 id="3appä¸­æ¯ä¸ªä»»åŠ¡å’Œå­ä»»åŠ¡éƒ½æœ‰ä¸€ç§ä¸“ç”¨çš„å°è£…æ–¹å¼"><a class="markdownIt-Anchor" href="#3appä¸­æ¯ä¸ªä»»åŠ¡å’Œå­ä»»åŠ¡éƒ½æœ‰ä¸€ç§ä¸“ç”¨çš„å°è£…æ–¹å¼"></a> 3.appä¸­æ¯ä¸ªä»»åŠ¡å’Œå­ä»»åŠ¡éƒ½æœ‰ä¸€ç§ä¸“ç”¨çš„å°è£…æ–¹å¼</h4><p>å³ä½¿ä»»åŠ¡å¯ä»¥åœ¨å¤šä¸ª ViewControllers ä¸Šè¿è¡Œï¼Œå®ƒä¹Ÿä¼šè¢«å°è£…ã€‚å¦‚æœä½ çš„iPadç‰ˆæœ¬é‡å¤ä½¿ç”¨äº†å…¶ä¸­çš„ä¸€äº›å­ä»»åŠ¡ï¼Œä½†æ²¡æœ‰é‡å¤ä½¿ç”¨ï¼Œåˆ™ä»…ä½¿ç”¨è¿™äº›å­ä»»åŠ¡å°±éå¸¸å®¹æ˜“ã€‚</p><h4 id="4coordinator-å°†æ˜¾ç¤ºç»‘å®šä¸å‰¯ä½œç”¨åˆ†å¼€"><a class="markdownIt-Anchor" href="#4coordinator-å°†æ˜¾ç¤ºç»‘å®šä¸å‰¯ä½œç”¨åˆ†å¼€"></a> 4.Coordinator å°†æ˜¾ç¤ºç»‘å®šä¸å‰¯ä½œç”¨åˆ†å¼€</h4><p>ä½ å†ä¹Ÿä¸å¿…æ‹…å¿ƒåœ¨å‘ˆç° ViewControlleræ—¶ï¼ŒViewControllerç ´åæ•°æ®äº†ã€‚å®ƒåªèƒ½è¯»å–å’Œæ˜¾ç¤ºï¼Œä¸èƒ½å†™å…¥æˆ–ç ´åæ•°æ®ã€‚è¿™ä¸<a href="https://en.wikipedia.org/wiki/Command%E2%80%93query_separation" target="_blank" rel="noopener">å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»</a>ç›¸ä¼¼ã€‚</p><h4 id="5-coordinatoræ˜¯å®Œå…¨ç”±ä½ æ§åˆ¶çš„å¯¹è±¡"><a class="markdownIt-Anchor" href="#5-coordinatoræ˜¯å®Œå…¨ç”±ä½ æ§åˆ¶çš„å¯¹è±¡"></a> 5. Coordinatoræ˜¯å®Œå…¨ç”±ä½ æ§åˆ¶çš„å¯¹è±¡</h4><p>ä½ ä¸å¿…ç­‰å¾… <code>-viewDidLoad</code> è°ƒç”¨äº†ï¼Œæ‰å¯ä»¥è¿›è¡Œå·¥ä½œã€‚ç°åœ¨å®Œå…¨å¯ä»¥è‡ªå·±æ§åˆ¶å·¥ä½œã€‚åœ¨UIViewControllerè¶…ç±»ä¸­æ²¡æœ‰çœ‹ä¸è§çš„ä»£ç åœ¨åšä½ ä¸çŸ¥é“çš„äº‹ã€‚å–ä»£è¢«è°ƒç”¨ï¼Œä½ å¼€å§‹è¿™ä¸ªè°ƒç”¨ã€‚</p><p>ç¿»è½¬æ­¤æ¨¡å‹å¯ä»¥æ›´è½»æ¾åœ°äº†è§£å‘ç”Ÿäº†ä»€ä¹ˆã€‚appçš„è¡Œä¸ºå¯¹ä½ å®Œå…¨é€æ˜ï¼Œ<code>UIKit</code> ç°åœ¨åªæ˜¯ä½ è¦ä½¿ç”¨å®ƒæ—¶è°ƒç”¨çš„åº“ã€‚</p><p><a href="https://github.com/backchannel/BackchannelSDK-iOS" target="_blank" rel="noopener">Backchannel SDK</a> ä½¿ç”¨æ­¤æ¨¡å¼æ¥ç®¡ç†å…¶æ‰€æœ‰ ViewControllersã€‚app coordinator å’Œèº«ä»½éªŒè¯ coordinator ç¤ºä¾‹æ¥è‡ªè¯¥é¡¹ç›®ã€‚</p><p>æœ€åï¼ŒCoordinator åªæ˜¯ä¸€ç§ç»„ç»‡æ¨¡å¼ã€‚æ²¡æœ‰ä½ èƒ½ä½¿ç”¨çš„ Coordinator åº“ï¼Œå› ä¸ºå®ƒå¾ˆç®€å•ã€‚æ²¡æœ‰å¯ä»¥ <code>pod</code> çš„ Coordinatoråº“ï¼Œä¹Ÿç±³æœ‰å¯ä»¥ç»§æ‰¿çš„å­ç±»ã€‚ç”šè‡³æ²¡æœ‰ä¸€ä¸ªå¯éµå¾ªçš„åè®®ã€‚è¿™ä¸æ˜¯ç¼ºç‚¹ï¼Œè€Œæ˜¯ä½¿ç”¨åƒCoordinatorè¿™æ ·çš„æ¨¡å¼çš„ä¼˜ç‚¹ï¼šå®ƒåªæ˜¯ä½ çš„ä»£ç ï¼Œæ²¡æœ‰ä¾èµ–é¡¹ã€‚</p><p>ä»–ä»¬å°†ä½¿ä½ çš„appå’Œä»£ç æ›´æ˜“äºç®¡ç†ã€‚ViewControllerå°†å…·æœ‰æ›´é«˜çš„å¯é‡ç”¨æ€§ï¼Œå¹¶ä¸”æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´å®¹æ˜“å¼€å‘ä½ çš„ appã€‚</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ€æƒ³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> è®¾è®¡æ€æƒ³ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxFlow 3: æç¤ºå’ŒæŠ€å·§</title>
      <link href="/2018/01/22/RxSwfit+RAC/RxFlow-3-%E6%8F%90%E7%A4%BA%E5%92%8C%E6%8A%80%E5%B7%A7/"/>
      <url>/2018/01/22/RxSwfit+RAC/RxFlow-3-%E6%8F%90%E7%A4%BA%E5%92%8C%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><img src="https://twittemb.github.io/uploads/Weavy_part3.png" alt="-"></p><p>è¿™ç¯‡æ˜¯ RxFlow ç³»åˆ—æ–‡ç« çš„æœ€åä¸€ç« ã€‚åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å·²ç»ä»‹ç»äº†æ‰€æœ‰å…³é”®åŠŸèƒ½/åŸç†</p><p>è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨æˆ‘åœ¨å“åº”å¼ç¼–ç¨‹ä¸­å‘ç°çš„æŠ€å·§å’Œçªé—¨ã€‚</p><h2 id="uiviewcontroller-æ”¯æŒ-reactive"><a class="markdownIt-Anchor" href="#uiviewcontroller-æ”¯æŒ-reactive"></a> UIViewController æ”¯æŒ Reactive</h2><p>æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬2ç¯‡ä¸­æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦ä»¥å“åº”æ–¹å¼çŸ¥é“ä½•æ—¶æ˜¾ç¤ºä¸€ä¸ªPresentableã€‚ä¸€ä¸ª <strong>Presentable</strong> æš´éœ²ä¸‰ä¸ª Observablesï¼š</p><details><summary>code</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Observable that triggers a bool indicating if</span></span><br><span class="line"><span class="comment">/// the current Presentable is being displayed</span></span><br><span class="line"><span class="keyword">var</span> rxVisible: <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Single triggered when this presentable is displayed</span></span><br><span class="line"><span class="comment">/// for the first time</span></span><br><span class="line"><span class="keyword">var</span> rxFirstTimeVisible: <span class="type">Single</span>&lt;<span class="type">Void</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Single triggered when this presentable is dismissed</span></span><br><span class="line"><span class="keyword">var</span> rxDismissed: <span class="type">Single</span>&lt;<span class="type">Void</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br></pre></td></tr></table></figure></pre></details><p>åœ¨ <strong>RxFlow</strong> ä¸­ï¼ŒUIViewController éµä» <strong>Presentable</strong> åè®®ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°æ–¹æ³•è®©ä»–ä»¬æ”¯æŒ Reactiveã€‚</p><p>å¹¸è¿çš„æ˜¯åœ¨æ­¤è¿‡ç¨‹ä¸­å‘ç°çš„ä¸€ä¸ªé¡¹ç›®åœ¨æ­¤æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§ä½œç”¨ï¼š<a href="https://github.com/devxoul/RxViewController" target="_blank" rel="noopener">RxViewController</a>.</p><p>é€šè¿‡åº”ç”¨æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­(<a href="https://twittemb.github.io/swift/generics/reactive/rxswift/pattern/name%20space/2017/11/22/versatile-namespace/" target="_blank" rel="noopener">Swiftä¸­çš„é™æ€åç§°ç©ºé—´</a>)æè¿°çš„æ¨¡å¼ï¼Œå®ƒä¸ºUIViewControllersæä¾›äº†Reactiveæ‰©å±•ã€‚å®ƒä½¿ç”¨RxCocoaå†…ç½®å‡½æ•°å…è®¸è§‚å¯Ÿé€‰æ‹©å™¨è°ƒç”¨ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€æ¦‚å¿µï¼Œä¾¿å¯¹UIViewControllerè¿›è¡Œäº†è‡ªå·±çš„æ‰©å±•ã€‚</p><details><summary>code</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Reactive</span> <span class="title">where</span> <span class="title">Base</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Observable, triggered when the view has appeared for the first time</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> firstTimeViewDidAppear: <span class="type">Single</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> sentMessage(#selector(<span class="type">Base</span>.viewDidAppear)).<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> <span class="type">Void</span>()</span><br><span class="line">        &#125;.take(<span class="number">1</span>).asSingle()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Observable, triggered when the view is being dismissed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> dismissed: <span class="type">ControlEvent</span>&lt;<span class="type">Bool</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> source = sentMessage(#selector(<span class="type">Base</span>.dismiss))</span><br><span class="line">                     .<span class="built_in">map</span> &#123; $<span class="number">0</span>.first <span class="keyword">as</span>? <span class="type">Bool</span> ?? <span class="literal">false</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ControlEvent</span>(events: source)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Observable, triggered when the view appearance state changes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> displayed: <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> viewDidAppearObs = sentMessage(#selector(<span class="type">Base</span>.viewDidAppear))</span><br><span class="line">                               .<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="literal">true</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> viewWillDisappearObs = sentMessage(#selector(<span class="type">Base</span>.viewWillDisappear))</span><br><span class="line">                                   .<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="literal">false</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt;.merge(viewDidAppearObs, viewWillDisappearObs)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>ä½œä¸ºè®°å½•ï¼Œè¿™å°±æ˜¯ <strong>Coordinator</strong> çš„ç”¨æ³•ï¼Œå…¶ä¸­ <strong>â€œnextPresentableâ€</strong> æ˜¯ç”± <strong>Flow</strong> ä¸Šçš„ <strong>â€œnavigateï¼ˆto : )â€</strong> å‡½æ•°ç”Ÿæˆçš„ <strong>Presentable</strong> ã€‚åœ¨å·²ç»å…³è”çš„Presentableé¦–æ¬¡æ˜¾ç¤ºä¹‹åï¼Œæˆ‘ä»¬ä»…ç›‘å¬ä¸‹ä¸€ä¸ªStepperã€‚</p><details><summary>code</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nextPresentable.rxFirstTimeVisible.subscribe(onSuccess: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>,</span><br><span class="line">                                                           <span class="keyword">unowned</span> nextPresentable,</span><br><span class="line">                                                           <span class="keyword">unowned</span> nextStepper] (<span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// we listen to the presentable's Stepper.</span></span><br><span class="line">    <span class="comment">// For each new Step value, we trigger a new navigation process</span></span><br><span class="line">    <span class="comment">// this is the core principle of the whole RxFlow mechanism</span></span><br><span class="line">    <span class="comment">// The process is paused each time the presentable is not currently displayed</span></span><br><span class="line">    <span class="comment">// for instance when another presentable is above it in the VCs hierarchy.</span></span><br><span class="line">    nextStepper.steps</span><br><span class="line">        .pausable(nextPresentable.rxVisible.startWith(<span class="literal">true</span>))</span><br><span class="line">        .asDriver(onErrorJustReturn: <span class="type">NoStep</span>())</span><br><span class="line">        .drive(onNext: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (step) <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// the nextPresentable's Stepper fires a new Step</span></span><br><span class="line">            <span class="keyword">self</span>.steps.onNext(step)</span><br><span class="line">        &#125;).disposed(by: nextPresentable.disposeBag)</span><br><span class="line"></span><br><span class="line">&#125;).disposed(by: <span class="keyword">self</span>.disposeBag)</span><br></pre></td></tr></table></figure></pre></details><h2 id="æš‚åœ"><a class="markdownIt-Anchor" href="#æš‚åœ"></a> æš‚åœ</h2><p>åœ¨ RxFlow ä¸­å¦ä¸€ä¸ªå…³é”®åŸåˆ™ï¼š<strong>Flow</strong> ä¸­å‘ç”Ÿä»€ä¹ˆå°±è¦åœç•™åœ¨ <strong>Flow</strong> ä¸­ã€‚å› æ­¤æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªæ–¹å¼</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxFlow 2: å®è·µ</title>
      <link href="/2018/01/21/RxSwfit+RAC/RxFlow-2-%E5%AE%9E%E8%B7%B5/"/>
      <url>/2018/01/21/RxSwfit+RAC/RxFlow-2-%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><strong>æ³¨æ„ï¼ï¼ï¼</strong></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">NextFlowItems</span> = <span class="type">FlowContributors</span></span><br></pre></td></tr></table></figure><p><a href="https://twittemb.github.io/swift/coordinator/reactive/rxflow/reactive%20programming/2017/12/09/rxflow-part-2-in-practice/" target="_blank" rel="noopener">åŸæ–‡RxFlow Part 2: In Practice</a><br><img src="https://twittemb.github.io/uploads/RxFlowPart2.png" alt="-"></p><p>ä¸Šç¯‡ï¼š<a href="../RxFlow-1-%E5%8E%9F%E7%90%86">RxFlow-1-åŸç†</a></p><p>å‡ å‘¨å‰æˆ‘ä»‹ç»äº† RxFlow æ¡†æ¶ï¼Œæˆ‘å·²ç»åœ¨è¿™ä¸ªæ¡†æ¶ä¸Šå·¥ä½œäº†å‡ ä¸ªæœˆï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨äº†ã€‚å¦‚æœæ‚¨å°šæœªé˜…è¯»ï¼Œå»ºè®®æ‚¨çœ‹ä¸€ä¸‹è¿™ç¯‡<a href="https://twittemb.github.io/swift/coordinator/rxswift/rxflow/reactive%20programming/2017/11/08/rxflow-part-1-in-theory/" target="_blank" rel="noopener">æ–‡ç« </a>ã€‚</p><p>æ€»ç»“ï¼ŒRxFlow æ—¨åœ¨ï¼š</p><ul><li>è½»æ¾çš„å°†ä½ çš„å¯¼èˆªåˆ‡æˆé€»è¾‘éƒ¨åˆ†</li><li>æŠŠå¯¼èˆªä»£ç ä» ViewController ä¸­åˆ é™¤</li><li>é¼“åŠ± ViewController å¤ç”¨æ€§</li><li>ä¿ƒè¿› å“åº”å¼ç¼–ç¨‹</li><li>ä¿ƒè¿› ä¾èµ–æ³¨å…¥</li></ul><p>å¿«é€Ÿå›å¿†ä¸‹ä»¥ä¸‹æœ¯è¯­ï¼š</p><ul><li>Flow: æ¯ä¸ª Flow éƒ½åœ¨åº”ç”¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªå¯¼èˆªåŒºåŸŸã€‚</li><li>Step: åœ¨åº”ç”¨ä¸­ï¼Œæ¯ä¸ª Step å°±æ˜¯ä¸€ä¸ªå¯¼èˆªçŠ¶æ€ï¼ŒFlows å’Œ Steps çš„ç»“åˆæè¿°äº†æœ‰æ‰€å¯¼èˆªæ“ä½œçš„å¯èƒ½ã€‚</li><li>Stepper: ä»»ä½•å¯ä»¥å‘å‡º Steps çš„ä¸œè¥¿ã€‚Steppers è´Ÿè´£è§¦å‘æ¯ä¸ªåœ¨ Flows ä¸­çš„å¯¼èˆªæ“ä½œ</li><li>Presentable: å¯ä»¥è¢«å‘ˆç°å‡ºæ¥çš„äº‹ç‰©çš„æŠ½è±¡ï¼ˆåŸºæœ¬ä¸Šæ˜¯ UIViewController å’Œ å¯ä»¥å‘ˆç°çš„ Flowï¼‰</li><li>NextFlowItem(FlowContributors): ä»–ä¼šå‘Šè¯‰ Coordinatorï¼Œåœ¨ä»–çš„å“åº”æœºåˆ¶ä¸­ï¼Œæ¥ä¸‹æ¥å°†ä¼šæ˜¯ä»€ä¹ˆäº§ç”Ÿæ–°çš„ Steps</li><li>Coordinator: Coordinator çš„å·¥ä½œæ˜¯ä»¥ä¸€ç§ä¸€ç›´çš„æ–¹å¼æ··åˆFlows and Stepsç»„åˆ</li></ul><p>åŒæ ·é‡è¦çš„æ˜¯è¦è®°ä½ï¼ŒRxFlowä½¿ç”¨é¢å‘åè®®çš„ç¨‹åºè®¾è®¡ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šå°†ä»£ç å†»ç»“åœ¨ç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­ã€‚</p><p>åœ¨ <a href="https://github.com/RxSwiftCommunity/RxFlow" target="_blank" rel="noopener">RxFlow repo</a> ä¸­ï¼Œä½ å°†æ‰¾åˆ°ä¸€ä¸ªæ¼”ç¤ºåº”ç”¨ç¨‹åºã€‚å®ƒå‡ ä¹æ˜¾ç¤ºäº†æ¯ç§å¯èƒ½çš„å¯¼èˆªç±»å‹</p><ul><li>Navigation stack</li><li>Tab bar</li><li>Master / detail</li><li>Modal popup</li></ul><p><img src="https://twittemb.github.io/uploads/versions/demoweavy-mov---x----185-400x---.gif" alt="-"></p><h2 id="éƒ½æ˜¯å…³äº-states"><a class="markdownIt-Anchor" href="#éƒ½æ˜¯å…³äº-states"></a> éƒ½æ˜¯å…³äº States</h2><p><strong>RxFlow</strong> ä¸»è¦æ˜¯ä½¿ç”¨å“åº”å¼çš„æ–¹å¼å¤„ç†å¯¼èˆªçŠ¶æ€ã€‚ä¸ºäº†åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­å¤ç”¨ï¼Œè¿™äº›çŠ¶æ€ä¸€å®šè¦ä¸çŸ¥é“å½“å‰ä½¿ç”¨çš„å¯¼èˆª Flowã€‚å› æ­¤ï¼ŒçŠ¶æ€ä¸æ˜¯è¡¨ç¤ºâ€œæˆ‘è¦è·³è½¬åˆ°æ­¤å±å¹•â€ï¼Œè€Œæ˜¯è¡¨ç¤ºâ€œæŸäººæˆ–æŸç‰©æ‰§è¡Œæ­¤æ“ä½œâ€ï¼Œç„¶åRxFlowä¼šæ ¹æ®å½“å‰å¯¼èˆª Flow é€‰æ‹©æ­£ç¡®çš„screenã€‚å¯¹äº RxFlowï¼Œè¿™ä¸ªå¯¼èˆªçŠ¶æ€ç§°ä¸ºâ€œ<strong>Steps</strong>â€ã€‚</p><p>æšä¸¾æ˜¯æè¿° <strong>Steps</strong> çš„å¥½æ–¹æ³•:</p><ul><li>æšä¸¾æ–¹ä¾¿ä½¿ç”¨</li><li>ä¸€ä¸ª value åªå¯ä»¥è¢«å®šä¹‰ä¸€æ¬¡(å› æ­¤ä¸€ä¸ªçŠ¶æ€æ˜¯æƒŸä¸€çš„)</li><li>æšä¸¾å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå› ä¸ºSwiftåœ¨ switch è¯­æ³•ä¸­è¦æ±‚ä½ å®ç°æ‰€æœ‰å¯èƒ½å€¼</li><li>æšä¸¾å¯ä»¥å…³è” valueï¼Œè¿™äº›value å¯ä»¥ä»ä¸€ä¸ª screen ä¼ åˆ°å¦ä¸€ä¸ª screen</li><li>æšä¸¾æ˜¯å€¼ç±»å‹ï¼Œå› æ­¤ä¸å­˜åœ¨ä¼ é€’ä¸å—æ§åˆ¶çš„å…±äº«å‚è€ƒ</li></ul><details><summary>eg: åœ¨ demo App ä¸­ï¼Œè¿™äº›éƒ½æ˜¯æˆ‘ä»¬æ¶µç›–å¯¼èˆªå¯èƒ½æ€§æ‰€éœ€çš„æ‰€æœ‰ Stepsã€‚</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxFlow</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">DemoStep</span>: <span class="title">Step</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> apiKey</span><br><span class="line">    <span class="keyword">case</span> apiKeyIsComplete</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> movieList</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> moviePicked (withMovieId: <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> castPicked (withCastId: <span class="type">Int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> settings</span><br><span class="line">    <span class="keyword">case</span> settingsDone</span><br><span class="line">    <span class="keyword">case</span> about</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h2 id="ä½¿ç”¨-flow"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-flow"></a> ä½¿ç”¨ Flow</h2><p>å¯¹äº <strong>RxFlow</strong>ï¼Œæ‰€æœ‰å¯¼èˆªä»£ç éƒ½åœ¨ Flow ä¸­å£°æ˜ï¼Œegï¼špresenting æˆ–è€… pushing ViewControllerã€‚åœ¨ä½ çš„ App ä¸­ä¸€ä¸ª <strong>Flow</strong> ä»£è¡¨äº†å¯¼èˆªé€»è¾‘æ®µï¼Œå½“ Flow å’Œä¸€ä¸ªæ˜ç¡®çš„ Step ç»“åˆåï¼ŒFlowè§¦å‘å¯¼èˆªåŠ¨ä½œã€‚</p><p>ä¸ºæ­¤ï¼Œ<strong>Flow</strong> è¦å®ç°ï¼š</p><ul><li>ä¸€ä¸ª â€œ<strong>navigate(to:)</strong>â€ æ–¹æ³•æ ¹æ® Flow å’Œ Stepï¼Œæ‰§è¡Œå¯¼èˆªæ“ä½œ</li><li>ä¸€ä¸ª â€œ<strong>root</strong>â€ UIViewControllerï¼Œä»–å°†åŸºäºåœ¨æ­¤ <strong>Flow</strong> ä¸­çš„å¯¼èˆª</li></ul><p>æœ‰ä¸ª <strong>Flow</strong> æ§åˆ¶ UINavigationController å’Œ stackçš„ä¾‹å­ã€‚</p><details><summary>åœ¨è¿™ä¸ª Flow ä¸­ï¼Œå¯ä»¥æ‰§è¡Œ3ä¸ªå¯¼èˆªæ“ä½œã€‚</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxFlow</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WatchedFlow</span>: <span class="title">Flow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> root: <span class="type">UIViewController</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.rootViewController</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> rootViewController = <span class="type">UINavigationController</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> service: <span class="type">MoviesService</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(withService service: <span class="type">MoviesService</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.service = service</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">navigate</span><span class="params">(to step: Step)</span></span> -&gt; [<span class="type">NextFlowItem</span>] <span class="comment">/*FlowContributors*/</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> step = step <span class="keyword">as</span>? <span class="type">DemoStep</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="type">NextFlowItem</span>.noNavigation &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> step &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> .movieList:</span><br><span class="line">            <span class="keyword">return</span> navigateToMovieListScreen()</span><br><span class="line">        <span class="keyword">case</span> .moviePicked(<span class="keyword">let</span> movieId):</span><br><span class="line">            <span class="keyword">return</span> navigateToMovieDetailScreen(with: movieId)</span><br><span class="line">        <span class="keyword">case</span> .castPicked(<span class="keyword">let</span> castId):</span><br><span class="line">            <span class="keyword">return</span> navigateToCastDetailScreen(with: castId)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NextFlowItem</span>.noNavigation</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">navigateToMovieListScreen</span> <span class="params">()</span></span> -&gt; [<span class="type">NextFlowItem</span>]<span class="comment">/*FlowContributors*/</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">WatchedViewModel</span>(with: <span class="keyword">self</span>.service)</span><br><span class="line">        <span class="keyword">let</span> viewController = <span class="type">WatchedViewController</span>.instantiate(with: viewModel)</span><br><span class="line">        viewController.title = <span class="string">"Watched"</span></span><br><span class="line">        <span class="keyword">self</span>.rootViewController.pushViewController(viewController, animated: <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> [<span class="type">NextFlowItem</span>(nextPresentable: viewController, nextStepper: viewModel)]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">navigateToMovieDetailScreen</span> <span class="params">(with movieId: Int)</span></span> -&gt; [<span class="type">NextFlowItem</span>]<span class="comment">/*FlowContributors*/</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">MovieDetailViewModel</span>(withService: <span class="keyword">self</span>.service,</span><br><span class="line">                                             andMovieId: movieId)</span><br><span class="line">        <span class="keyword">let</span> viewController = <span class="type">MovieDetailViewController</span>.instantiate(with: viewModel)</span><br><span class="line">        viewController.title = viewModel.title</span><br><span class="line">        <span class="keyword">self</span>.rootViewController.pushViewController(viewController, animated: <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> [<span class="type">NextFlowItem</span>(nextPresentable: viewController, nextStepper: viewModel)]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">navigateToCastDetailScreen</span> <span class="params">(with castId: Int)</span></span> -&gt; [<span class="type">NextFlowItem</span>]<span class="comment">/*FlowContributors*/</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">CastDetailViewModel</span>(withService: <span class="keyword">self</span>.service,</span><br><span class="line">                                            andCastId: castId)</span><br><span class="line">        <span class="keyword">let</span> viewController = <span class="type">CastDetailViewController</span>.instantiate(with: viewModel)</span><br><span class="line">        viewController.title = viewModel.name</span><br><span class="line">        <span class="keyword">self</span>.rootViewController.pushViewController(viewController, animated: <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NextFlowItem</span>.noNavigation</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h2 id="å¯¼èˆªæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨"><a class="markdownIt-Anchor" href="#å¯¼èˆªæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨"></a> å¯¼èˆªæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨</h2><p>åœ¨å­¦ä¹ å‡½æ•°å“åº”å¼ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸è¯»åˆ° <strong>å‰¯ä½œç”¨</strong>ã€‚FRP çš„ç›®çš„æ˜¯ä¼ é€’äº‹ä»¶ï¼Œç„¶åå†æ•´è¿‡ç¨‹ä¸­ä½¿ç”¨ FRP çš„å‡½æ•°å¤„ç†äº‹ä»¶ã€‚è¿™äº›functions å¯ä»¥è½¬æ¢äº‹ä»¶ï¼Œæœ€ç»ˆ(ä½†æ˜¯ä¸æ˜¯å¿…é¡»)å°†æ‰§è¡Œä½ æƒ³è¦çš„ä»»ä½•åŠŸèƒ½çš„ä»£ç (ç½‘ç»œè¯·æ±‚ï¼Œä¿å­˜æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸€ä¸ª alertâ€¦â€¦)ï¼šè¿™äº›æ˜¯ <strong>å‰¯ä½œç”¨</strong></p><p>å› ä¸º RxFlow ä¾èµ–å“åº”å¼ç¼–ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¯†åˆ«å‡ºå›ºæœ‰çš„æ¦‚å¿µï¼š</p><ul><li>eventsï¼šå‘å‡º Steps</li><li>functionï¼šå°±æ˜¯ â€œ<strong>navigate(to:)</strong>â€ function</li><li>transformationï¼šâ€œ<strong>navigate(to:)</strong>â€ å°† Step è½¬æ¢æˆå¦ä¸€ä¸ª <strong>NextFlowItem</strong> (FlowContributors)</li><li>side effectsï¼šæ‰§è¡Œåœ¨â€œ<strong>navigate(to:)</strong>â€ä¸­çš„å¯¼èˆªæ“ä½œï¼ˆeg: <strong>â€œnavigateToMovieListScreen()â€</strong> æ–¹æ³•åœ¨navigation stack ä¸Š push ä¸€ä¸ªæ–°çš„UIViewControllerï¼‰</li></ul><h2 id="navigating-æ˜¯ä¸ºäº†ç”Ÿæˆ-nextflowitemsflowcontributors"><a class="markdownIt-Anchor" href="#navigating-æ˜¯ä¸ºäº†ç”Ÿæˆ-nextflowitemsflowcontributors"></a> Navigating æ˜¯ä¸ºäº†ç”Ÿæˆ NextFlowItems(FlowContributors)</h2><p>æ¥ç€æ¥è¯´ï¼Œä¸€ä¸ª NextFlowItem(FlowContributors) æ˜¯ä¸€ä¸ªæŒæœ‰ä¸€ä¸ª Presentable å’Œä¸€ä¸ª Stepper ç®€å•çš„æ•°æ®ç»“æ„ã€‚</p><ul><li><strong>Presentable</strong> å‘Šè¯‰ <strong>Coordinator</strong> æ¥ä¸‹æ¥ä½ è¦ present å‡ºæ¥çš„æ˜¯ä»€ä¹ˆ</li><li><strong>Stepper</strong> å‘Šè¯‰ <strong>Coordinator</strong> æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆä¸œè¥¿å‘å‡º <strong>Steps</strong></li></ul><p>é»˜è®¤æƒ…å†µï¼Œæ‰€æœ‰çš„ UIViewController éƒ½æ˜¯ <strong>Presentable</strong>. <strong>Flows</strong> ä¹Ÿæ˜¯ <strong>Presentable</strong>ï¼Œå› ä¸ºæœ‰äº‹ï¼Œä½ æƒ³å¯åŠ¨ä¸€ä¸ªæ–°çš„å¯¼èˆªåŒºåŸŸï¼Œè¯¥åŒºåŸŸåœ¨ä»–è‡ªå·±çš„ <strong>Flow</strong> ä¸­æè¿°ï¼Œæ‰€ä»¥ RxFlow ä¹Ÿä¼šæŠŠä»–å½“åšå¯ä»¥è¢« present çš„ä¸œè¥¿</p><p>ä¸ºä»€ä¹ˆ <strong>Coordinator</strong> è¦çŸ¥é“ <strong>Presentables</strong>ï¼Ÿ</p><p><strong>Presentable</strong> æ˜¯ä¸€ä¸ªæè¿°å¯ä»¥è¢«å‘ˆç°çš„äº‹ç‰©çš„æŠ½è±¡ç±»ã€‚å› ä¸º <strong>Step</strong> ä¸ä¼šè¢«å‘å‡ºï¼Œé™¤éä»–å…³è”çš„ <strong>Presentable</strong> è¢«æ˜¾ç¤ºï¼Œ<strong>Presentable</strong> æä¾› Observablesï¼Œ<strong>Coordinator</strong> ä¼šè®¢é˜…è¿™ä¸ª Observablesï¼ˆæ‰€ä»¥ <strong>Coordinator</strong> ä¼šçŸ¥é“ <strong>Presentable</strong> çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰ã€‚å› æ­¤ <strong>Presentable</strong> æ²¡æœ‰å®Œå…¨æ˜¾ç¤ºçš„æ—¶å€™å‘é€ä¸€ä¸ª <strong>Step</strong> ä¸å­˜åœ¨ä»»ä½•å±é™©ã€‚</p><p><strong>Stepper</strong> å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼šè‡ªå®šä¹‰çš„ UIViewControllerï¼ŒViewModelï¼ŒPresenterâ€¦â€¦ ä¸€æ—¦ä»–åœ¨ <strong>Coordinator</strong> ä¸­æ³¨å†Œï¼Œ<strong>Stepper</strong> å°±å¯ä»¥é€šè¿‡ä»–çš„ â€<strong>step</strong>&quot; å±æ€§å‘é€ <strong>Steps</strong>(step æ˜¯ RxSwift ä¸­çš„ subject)ã€‚ <strong>Coordinator</strong> ä¼šç›‘å¬ <strong>Stepper</strong> å‘é€å‡ºæ¥çš„ <strong>Steps</strong>ï¼Œè°ƒç”¨ <strong>Flowâ€™s â€œnavigate(to:)â€</strong></p><details><summary>åœ¨ demo App ä¸­æœ‰ä¸€ä¸ª Stepper ä¾‹å­ï¼š</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxFlow</span><br><span class="line"><span class="keyword">import</span> RxSwift</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WatchedViewModel</span>: <span class="title">Stepper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> movies: [<span class="type">MovieViewModel</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(with service: <span class="type">MoviesService</span>) &#123;</span><br><span class="line">        <span class="comment">// we can do some data refactoring in order to display</span></span><br><span class="line">        <span class="comment">// things exactly the way we want (this is the aim of a ViewModel)</span></span><br><span class="line">        <span class="keyword">self</span>.movies = service.watchedMovies().<span class="built_in">map</span>(&#123; (movie) -&gt; <span class="type">MovieViewModel</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> <span class="type">MovieViewModel</span>(id: movie.id,</span><br><span class="line">                                  title: movie.title,</span><br><span class="line">                                  image: movie.image)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">pick</span> <span class="params">(movieId: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.step.onNext(<span class="type">DemoStep</span>.moviePicked(withMovieId: movieId))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ª movieçš„æ—¶å€™ä¼šè°ƒç”¨ pick å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ¨ <strong>â€œself.stepâ€</strong> Rx Stream ä¸­å‘å‡ºä¸€ä¸ªnew valueã€‚</p><p>æ€»ç»“å¯¼èˆªè¿‡ç¨‹ï¼š</p><ul><li><strong>navigate(to:)</strong> å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼ å…¥ä¸€ä¸ª <strong>Step</strong> ä½œä¸ºå‚æ•°</li><li>æ ¹æ®è¿™ä¸ª <strong>Step</strong>ï¼Œä¸€äº›å¯¼èˆªä»£ç è¢«è°ƒç”¨ï¼ˆ<strong>side effects</strong>ï¼‰</li><li>ä¹Ÿæ ¹æ®è¿™ä¸ª <strong>Step</strong>ï¼Œäº§ç”Ÿ <strong>NextFlowItems</strong> (FlowContributors)ã€‚å› æ­¤ï¼Œ<strong>Presentables</strong> å’Œ <strong>Steppers</strong> è¢«æ³¨å†Œè¿› <strong>Coordinator</strong> ä¸­</li><li><strong>Steppers</strong> å‘å‡ºæ–°çš„ <strong>Steps</strong>ï¼Œç„¶åå†æ¥ä¸€æ¬¡ä»¥ä¸Šè¿‡ç¨‹</li></ul><h2 id="ä¸ºä»€ä¹ˆå¯¹ä¸ä¸€ä¸ª-flow-step-ç»„åˆäº§ç”Ÿå¤šä¸ª-nextflowitems-flowcontributorsæ˜¯å¯ä»¥çš„"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆå¯¹ä¸ä¸€ä¸ª-flow-step-ç»„åˆäº§ç”Ÿå¤šä¸ª-nextflowitems-flowcontributorsæ˜¯å¯ä»¥çš„"></a> ä¸ºä»€ä¹ˆå¯¹ä¸ä¸€ä¸ª Flow &amp; Step ç»„åˆäº§ç”Ÿå¤šä¸ª <strong>NextFlowItems</strong> (FlowContributors)æ˜¯å¯ä»¥çš„ï¼Ÿ</h2><p>å› ä¸ºåœ¨æŸä¸€ä¸ªæ—¶é—´æ²¡æœ‰ä»€ä¹ˆç¦æ­¢ä¸€ä¸ªappæœ‰å¤šä¸ªå¯¼èˆªã€‚eg: tab barä¸Šé¢çš„æ¯ä¸€ä¸ªitem å¤šä¼šå¯¼å‘ä¸€ä¸ª navigation stackã€‚<strong>Step</strong> è§¦å‘UITabbarController æ˜¾ç¤ºï¼Œå°†åœ¨æ¯ä¸ªnavigation stack ä¸­ç”Ÿæˆä¸€ä¸ª NextFlowItem (FlowContributors)ã€‚</p><details><summary>ä½ å¯ä»¥çœ‹ä¸€ä¸‹ demo app ç†è§£ä¸€ä¸‹æ¦‚å¿µã€‚è¿™é‡Œæœ‰æˆ‘ä»¬æŠŠä¸€ä¸ª UITabbarController å’Œ 2ä¸ªFlowsè¿æ¥çš„ä¸€æ®µä»£ç ã€‚</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">navigationToDashboardScreen</span> <span class="params">()</span></span> -&gt; [<span class="type">NextFlowItem</span>] <span class="comment">/*(FlowContributors)*/</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tabbarController = <span class="type">UITabBarController</span>()</span><br><span class="line">    <span class="keyword">let</span> wishlistStepper = <span class="type">WishlistStepper</span>()</span><br><span class="line">    <span class="keyword">let</span> wishListFlow = <span class="type">WishlistWarp</span>(withService: <span class="keyword">self</span>.service,</span><br><span class="line">                                    andStepper: wishlistStepper)</span><br><span class="line">    <span class="keyword">let</span> watchedFlow = <span class="type">WatchedFlow</span>(withService: <span class="keyword">self</span>.service)</span><br><span class="line"></span><br><span class="line">    <span class="type">Flows</span>.whenReady(flow1: wishListFlow, flow2: watchedFlow, block: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>]</span><br><span class="line">    (root1: <span class="type">UINavigationController</span>, root2: <span class="type">UINavigationController</span>) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> tabBarItem1 = <span class="type">UITabBarItem</span>(title: <span class="string">"Wishlist"</span>,</span><br><span class="line">                                       image: <span class="type">UIImage</span>(named: <span class="string">"wishlist"</span>),</span><br><span class="line">                                       selectedImage: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">let</span> tabBarItem2 = <span class="type">UITabBarItem</span>(title: <span class="string">"Watched"</span>,</span><br><span class="line">                                       image: <span class="type">UIImage</span>(named: <span class="string">"watched"</span>),</span><br><span class="line">                                       selectedImage: <span class="literal">nil</span>)</span><br><span class="line">        root1.tabBarItem = tabBarItem1</span><br><span class="line">        root1.title = <span class="string">"Wishlist"</span></span><br><span class="line">        root2.tabBarItem = tabBarItem2</span><br><span class="line">        root2.title = <span class="string">"Watched"</span></span><br><span class="line"></span><br><span class="line">        tabbarController.setViewControllers([root1, root2], animated: <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">self</span>.rootViewController.pushViewController(tabbarController, animated: <span class="literal">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ([<span class="type">NextFlowItem</span>(nextPresentable: wishListFlow,</span><br><span class="line">                      nextStepper: wishlistStepper),</span><br><span class="line">             <span class="type">NextFlowItem</span>(nextPresentable: watchedFlow,</span><br><span class="line">                      nextStepper: <span class="type">OneStepper</span>(withSingleStep: <span class="type">DemoStep</span>.movieList))])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><br><p>é™æ€æ–¹æ³• <strong>â€œFlows.whenReady()â€</strong> å¸¦ç€å‚æ•° <strong>Flows</strong> å¯åŠ¨è¿˜å¸¦æœ‰ä¸€ä¸ªé—­åŒ…ï¼Œå½“ <strong>Flows</strong> å‡†å¤‡æ˜¾ç¤ºçš„æ—¶å€™å›è°ƒï¼ˆå³å½“Flowçš„ç¬¬ä¸€ä¸ªå±å¹•è¢«é€‰ä¸­çš„æ—¶å€™ï¼‰</p><h2 id="ä¸ºä»€ä¹ˆå¯¹äºflowå’Œstepçš„ç»„åˆå®Œå…¨ä¸äº§ç”Ÿnextflowitemflowcontributorsä¸ºä»€ä¹ˆå¯ä»¥"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆå¯¹äºflowå’Œstepçš„ç»„åˆå®Œå…¨ä¸äº§ç”Ÿnextflowitemflowcontributorsä¸ºä»€ä¹ˆå¯ä»¥"></a> ä¸ºä»€ä¹ˆå¯¹äºFlowå’ŒStepçš„ç»„åˆå®Œå…¨ä¸äº§ç”ŸNextFlowItem(FlowContributors)ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ï¼Ÿ</h2><p>å› ä¸ºå¯¼èˆª Flow å¿…é¡»è¦æœ‰ä¸€ä¸ªç»ˆç‚¹ï¼eg å¯¼èˆªstackçš„æœ€åä¸€ä¸ªå±å¹•ä¸ä¼šå†å‘ä¸‹å¯¼èˆªï¼Œä»–åªå¯ä»¥ pop backã€‚åœ¨è¿™ç§æƒ…å†µï¼Œ<strong>â€œnavigate(to:)â€</strong> è¿”å› <strong>NextFlowItem.noNavigation</strong>ã€‚</p><h2 id="åœ¨-flow-ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆåœç•™åœ¨-flow-ä¸­"><a class="markdownIt-Anchor" href="#åœ¨-flow-ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆåœç•™åœ¨-flow-ä¸­"></a> åœ¨ Flow ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆâ€¦â€¦åœç•™åœ¨ Flow ä¸­ï¼</h2><p>æ­£å¦‚æˆ‘ä»¬å·²ç»çœ‹åˆ°çš„ï¼Œåœ¨åŒä¸€æ—¶é—´æœ‰å¤šä¸ª <strong>Flows</strong> è¢«å¯¼èˆªæ˜¯å¯ä»¥çš„ã€‚egï¼šåœ¨ navigation stack ä¸­çš„ä¸€ä¸ª screen å¯ä»¥å¯åŠ¨å¼¹å‡ºçª—å£ï¼Œè¯¥å¼¹å‡ºçª—å£ä¹Ÿå¯ä»¥åŒ…å«å¦ä¸€ä¸ªnavigation stackã€‚ä» UIKit çš„è§’åº¦ä¸Šçœ‹ï¼ŒUIViewControllerçš„å±‚çº§ç»“æ„éå¸¸é‡è¦ï¼Œæˆ‘ä»¬ä¸èƒ½å¼„æ·· Coordinator å†…éƒ¨çš„å±‚æ¬¡ç»“æ„ã€‚</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“ä¸€ä¸ª <strong>Flow</strong> æ²¡æœ‰æ˜¾ç¤ºï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯å½“ç¬¬ä¸€ä¸ª navigation stack åœ¨å¼¹å‡ºçª—å£ä¹‹ä¸‹ï¼‰ï¼ŒCoordinatorå°†å¿½è§† <strong>Flow</strong> ä¸­å¯èƒ½å‘å‡ºæ¥çš„ <strong>Steps</strong>ã€‚</p><p>ä»æ›´ä¸€èˆ¬çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨ <strong>Flow</strong> ä¸Šä¸‹æ–‡ä¸­å‘å‡ºçš„ <strong>Steps</strong> åªèƒ½åœ¨è¯¥ <strong>Flow</strong> ä¸Šä¸‹æ–‡ä¸­è§£é‡Šï¼ˆå®ƒä»¬ä¸èƒ½è¢«å…¶ä»– <strong>Flow</strong> æ•è·ï¼‰ã€‚</p><h2 id="ä¾èµ–æ³¨å…¥å˜å¾—å®¹æ˜“"><a class="markdownIt-Anchor" href="#ä¾èµ–æ³¨å…¥å˜å¾—å®¹æ˜“"></a> ä¾èµ–æ³¨å…¥å˜å¾—å®¹æ˜“</h2><p>DI æ˜¯RxFlowçš„ä¸€ä¸ªä¸»è¦ç›®æ ‡ã€‚åŸºæœ¬ä¸Šï¼Œä¾èµ–æ³¨å…¥å¯ä»¥é€šè¿‡å°†æŸç§å®ç°ï¼ˆæœåŠ¡ï¼Œç®¡ç†å™¨ç­‰ï¼‰ä½œä¸ºå‚æ•°ä¼ é€’ç»™åˆå§‹åŒ–ç¨‹åºæˆ–æ–¹æ³•æ¥å®Œæˆï¼ˆä¹Ÿå¯ä»¥é€šè¿‡å±æ€§æ¥å®Œæˆï¼‰ã€‚</p><p>åœ¨ <strong>RxFlow</strong> ä¸­, å¼€å‘äººå‘˜è´Ÿè´£å®ä¾‹åŒ–UIViewControllersï¼ŒViewModelsï¼ŒPresenterç­‰,è¿™æ˜¯ä¸€ä¸ªæ³¨å…¥ä½ æ‰€éœ€ä»£ç çš„ç»ä½³æœºä¼šã€‚</p><details><summary>ä¸‹é¢æ˜¯ViewModelä¸­ä¾èµ–é¡¹æ³¨å…¥çš„ç¤ºä¾‹ã€‚</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> RxFlow</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WatchedFlow</span>: <span class="title">Flow</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> service: <span class="type">MoviesService</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(withService service: <span class="type">MoviesService</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.service = service</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">navigateToMovieListScreen</span> <span class="params">()</span></span> -&gt; [<span class="type">NextFlowItem</span>] <span class="comment">/*(FlowContributors)*/</span> &#123;</span><br><span class="line">        <span class="comment">// inject Service into ViewModel</span></span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">WatchedViewModel</span>(with: <span class="keyword">self</span>.service)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// injecy ViewMNodel into UIViewController</span></span><br><span class="line">        <span class="keyword">let</span> viewController = <span class="type">WatchedViewController</span>.instantiate(with: viewModel)</span><br><span class="line"></span><br><span class="line">        viewController.title = <span class="string">"Watched"</span></span><br><span class="line">        <span class="keyword">self</span>.rootViewController.pushViewController(viewController, animated: <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> [<span class="type">NextFlowItem</span>(nextPresentable: viewController, nextStepper: viewModel)]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h2 id="å¦‚ä½•å¼•å¯¼å¯¼èˆªè¿‡ç¨‹"><a class="markdownIt-Anchor" href="#å¦‚ä½•å¼•å¯¼å¯¼èˆªè¿‡ç¨‹"></a> å¦‚ä½•å¼•å¯¼å¯¼èˆªè¿‡ç¨‹</h2><p>æ—¢ç„¶å·²ç»çŸ¥é“å¦‚ä½•å°†äº‹ç‰©ç»„åˆåœ¨ä¸€èµ·ï¼Œå°† <strong>Flows</strong> å’Œ <strong>Steps</strong> æ··åˆåœ¨ä¸€èµ·ä»¥è§¦å‘å¯¼èˆªåŠ¨ä½œå¹¶äº§ç”ŸNextFlowItems (FlowContributors)ï¼Œå‰©ä¸‹è¦åšçš„ä¸€ä»¶äº‹ï¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¼•å¯¼å¯¼èˆªè¿‡ç¨‹ã€‚</p><p>ä¸€åˆ‡éƒ½åœ¨AppDelegateä¸­å‘ç”Ÿï¼Œå¹¶ä¸”ä¼šå‘ç°è¿™éå¸¸ç®€å•ï¼š</p><ul><li>å®ä¾‹åŒ– <strong>Coordinator</strong></li><li>å®ä¾‹åŒ–è¦å¯¼èˆªçš„ç¬¬ä¸€ä¸ª <strong>Flow</strong></li><li>è®© <strong>Coordinator</strong> ä½¿ç”¨ç¬¬ä¸€ä¸ª <strong>Step</strong> æ¥è°ƒåº¦ <strong>Flow</strong></li><li>å½“ç¬¬ä¸€ä¸ª <strong>Flow</strong> å‡†æœ¬å¥½äº†ï¼ŒæŠŠä»–çš„ root é…ç½®æˆ Windowçš„ rootViewController</li></ul><details><summary>åœ¨ demo App ä¸­ï¼š</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> RxFlow</span><br><span class="line"><span class="keyword">import</span> RxSwift</span><br><span class="line"><span class="keyword">import</span> RxCocoa</span><br><span class="line"></span><br><span class="line"><span class="meta">@UIApplicationMain</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppDelegate</span>: <span class="title">UIResponder</span>, <span class="title">UIApplicationDelegate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> disposeBag = <span class="type">DisposeBag</span>()</span><br><span class="line">    <span class="keyword">var</span> window: <span class="type">UIWindow?</span></span><br><span class="line">    <span class="keyword">var</span> coordinator = <span class="type">Coordinator</span>()</span><br><span class="line">    <span class="keyword">let</span> movieService = <span class="type">MoviesService</span>()</span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> mainFlow = &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">MainFlow</span>(with: <span class="keyword">self</span>.movieService)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication,</span></span></span><br><span class="line"><span class="function"><span class="params">                     didFinishWithOptions options: [UIApplicationLaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span></span><br><span class="line">                     -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> window = <span class="keyword">self</span>.window <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Flows</span>.whenReady(flow: mainFlow, block: &#123; [<span class="keyword">unowned</span> window] (root) <span class="keyword">in</span></span><br><span class="line">            window.rootViewController = root</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        coordinator.coordinate(flow: mainFlow,</span><br><span class="line">                               withStepper: <span class="type">OneStepper</span>(withSingleStep: <span class="type">DemoStep</span>.apiKey))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><h2 id="å¥–åŠ±"><a class="markdownIt-Anchor" href="#å¥–åŠ±"></a> å¥–åŠ±</h2><p>åè°ƒå™¨æœ‰ä¸¤ä¸ªå“åº”å¼æ‰©å±•ï¼šwillNavigateå’ŒdidNavigateã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨AppDelegateä¸­è®¢é˜…å®ƒä»¬ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">coordinator.rx.didNavigate.subscribe(onNext: &#123; (flow, step) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span> (<span class="string">"did navigate to flow=\(flow) and step=\(step)"</span>)</span><br><span class="line">&#125;).disposed</span><br></pre></td></tr></table></figure><details><summary>å°†ä¼šç”Ÿæˆå¦‚ä¸‹ logï¼š</summary><pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">MainFlow</span> step=apiKeyIsComplete</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WishlistFlow</span> step=movieList</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WatchedFlow</span> step=movieList</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WishlistFlow</span> step=moviePicked(<span class="number">23452</span>)</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WishlistFlow</span> step=castPicked(<span class="number">2</span>)</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WatchedFlow</span> step=moviePicked(<span class="number">55423</span>)</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WatchedFlow</span> step=castPicked(<span class="number">5</span>)</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">WishlistFlow</span> step=settings</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">SettingsFlow</span> step=settings</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">SettingsFlow</span> step=apiKey</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">SettingsFlow</span> step=about</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">SettingsFlow</span> step=apiKey</span><br><span class="line">did navigate flow=<span class="type">RxFlowDemo</span>.<span class="type">SettingsFlow</span> step=settingsDone</span><br></pre></td></tr></table></figure></pre></details><p>æ—¥å¿—å¯¹äºåˆ†æå’Œdebug ç¨‹åºå¾ˆæœ‰å¸®åŠ©</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RxFlow 1: åŸç†</title>
      <link href="/2018/01/21/RxSwfit+RAC/RxFlow-1-%E5%8E%9F%E7%90%86/"/>
      <url>/2018/01/21/RxSwfit+RAC/RxFlow-1-%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><img src="https://twittemb.github.io/uploads/RxFlow_Logo.png" alt="-"><br><a href="https://twittemb.github.io/swift/coordinator/rxswift/rxflow/reactive%20programming/2017/11/08/rxflow-part-1-in-theory/" target="_blank" rel="noopener">åŸæ–‡RxFlow Part 1: In Theory</a></p><p>è¿™ç¯‡æ˜¯è¯¥ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œè¯¥ç¯‡ä¹Ÿæ˜¯è¯¥ç³»åˆ—æ–‡ç« çš„æ ¸å¿ƒã€‚æˆ‘ä¼šä»‹ç» <code>RxFlow</code> ï¼šå®ƒæ˜¯ä¸€ä¸ªæˆ‘åŸºäº iOS Appä¸Šè®¾è®¡å®ç°çš„å“åº”å¼æµä¸­ä»‹å™¨(Reactive Flow Coordinator)</p><h2 id="äº‹å®"><a class="markdownIt-Anchor" href="#äº‹å®"></a> äº‹å®</h2><p>å…³äºiOSåº”ç”¨ç¨‹åºä¸­çš„å¯¼èˆªï¼Œæœ‰ä¸¤ç§é€‰æ‹©ï¼š</p><ul><li>ä½¿ç”¨ Apple Xcode æä¾›çš„å†…å»ºæœºåˆ¶ï¼šstoryboards å’Œ segues</li><li>ç”¨ä»£ç å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æœºåˆ¶</li></ul><p>è¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š</p><ul><li>å†…å»ºæœºåˆ¶ï¼šnavigation ç›¸å¯¹æ¥è¯´é™æ­¢ï¼Œstoryboards ç›¸å¯¹æ¥è¯´è¿‡äºåºå¤§ã€‚å¯¼èˆªä»£ç æ±¡æŸ“äº† UIViewControllers</li><li>è‡ªå®šä¹‰æœºåˆ¶ï¼šä»£ç å¯èƒ½éš¾ä»¥è®¾ç½®ï¼Œä¹Ÿå¯èƒ½å¾ˆå¤æ‚ï¼Œå…·ä½“å–å†³äºæ‰€é€‰çš„è®¾è®¡æ¨¡å¼ï¼ˆRouterï¼ŒCoordinatorï¼‰</li></ul><h4 id="rxflow-æ—¨åœ¨"><a class="markdownIt-Anchor" href="#rxflow-æ—¨åœ¨"></a> RxFlow æ—¨åœ¨</h4><ul><li>ä¿ƒè¿›å°† storyboards åˆ‡å‰²æˆåŸå­å•å…ƒï¼Œä»¥å®ç°UIViewControllersçš„åä½œå’Œå¯é‡ç”¨æ€§</li><li>å…è®¸ UIViewController æ ¹æ®å¯¼èˆªä¸Šä¸‹æ–‡ä»¥ä¸åŒæ–¹å¼å‘ˆç°</li><li>ç®€åŒ–ä¾èµ–æ³¨å…¥çš„å®ç°</li><li>ä»UIViewControllersåˆ é™¤å¯¼èˆªæœºåˆ¶</li><li>ä¿ƒè¿›å“åº”å¼ç¼–ç¨‹</li><li>åœ¨å¤„ç†å¤§å¤šæ•°å¯¼èˆªæ¡ˆä¾‹çš„åŒæ—¶ï¼Œä»¥å£°æ˜çš„æ–¹å¼è¡¨ç¤ºå¯¼èˆªï¼ˆä»¥å£°æ˜å¼çš„æ–¹å¼å¤„ç†å¯¼èˆªè¿‡ç¨‹ï¼‰</li><li>ä¿ƒè¿›å°†åº”ç”¨ç¨‹åºåˆ‡æˆé€»è¾‘å¯¼èˆªå—</li></ul><h2 id="ä»-storyboard-åˆ°-coordinator-æ¨¡å¼"><a class="markdownIt-Anchor" href="#ä»-storyboard-åˆ°-coordinator-æ¨¡å¼"></a> ä» Storyboard åˆ° Coordinator æ¨¡å¼</h2><p>ä½œä¸º iOS å¼€å‘äººå‘˜ï¼Œéšç€å¼€å‘èƒ½åŠ›æé«˜ï¼ˆAndroidæˆ–è€…webï¼‰ï¼Œæˆ‘ç»å¸¸é‡åˆ°å…³äºå¯¼èˆªçš„åŒæ ·ç–‘é—®ã€‚å¯¹äºå…¶ä»–æ‰€æœ‰æ¦‚å¿µé—®é¢˜ï¼Œæœ‰å¾ˆå¤šæ¨¡å¼å¯ä»¥è§£å†³å¸¸è§çš„ä½“ç³»ç»“æ„é—®é¢˜å’Œå…³æ³¨ç‚¹åˆ†ç¦»éœ€æ±‚ï¼ˆMVC,MVP,MVVM,VIPER)</p><p>ä½†æ˜¯ï¼Œä¸€æ—¦è®¾è®¡å¯¼èˆªï¼Œæˆ‘å°±çŠ¯æ„äº†ï¼š</p><ul><li>å¦‚ä½•åœ¨Storyboard / Seguesä¸­ä½¿ç”¨ä¾èµ–é¡¹æ³¨å…¥ï¼Ÿ</li><li>å¦‚ä½•æ§åˆ¶åº”ç”¨ç¨‹åºçš„æµç¨‹ï¼Ÿ</li><li>å¦‚ä½•æ‘†è„±UIViewControllersä¸­çš„å¯¼èˆªæ ·æ¿ä»£ç ï¼Ÿ</li></ul><p>éšç€æ—¶é—´çš„æµé€ï¼Œæˆ‘å¯¹iOSåº”ç”¨ç¨‹åºä» MVCæ¨¡å¼å¸¦ä¸€ä¸ªStoryboard åˆ° MVCæ¨¡å¼å¾…å¤šä¸ª Storyboardsï¼Œæœ€ååˆ° MVVMæ¨¡å¼ + Flow Coordinator â€”â€” ç›®å‰æ¥è¯´ä»–æ˜¯æˆ‘ä»¬å¯ä»¥å«ä¸Šåå­—çš„æœ€ä½³å®è·µäº†ã€‚MVVMæ¨¡å¼ + Flow Coordinator å¥½æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¾èµ–æ³¨å…¥ï¼ŒUIViewController å¯å¤ç”¨è¡Œï¼Œå¯æµ‹è¯•æ€§ã€‚æˆ‘æœ‰æœºä¼šå°†æ­¤æ¨¡å¼åº”ç”¨äºç”Ÿäº§ä¸­çš„å¤§å‹å¤æ‚åº”ç”¨ç¨‹åºã€‚ä½†æ˜¯æœ€åï¼Œä»ç„¶æœ‰ä¸€äº›é—®é¢˜å›°æ‰°ç€æˆ‘ï¼š</p><ul><li>æˆ‘æ€»æ˜¯ä¸å¾—ä¸ä¸€æ¬¡æ¬¡åœ°å†™ Coordinator æ¨¡å¼</li><li>ä½¿ç”¨å¤§é‡ delegate æ¨¡å¼ï¼Œè®© ViewModels å¾—åˆ° Coordinator å›è°ƒä¿¡æ¯</li><li>ä¸€å¼€å§‹æˆ‘çœ‹ Redux æ¨¡å¼ï¼Œå°¤å…¶æ˜¯å¯¼èˆªçŠ¶æ€æœºã€‚æˆ‘ä»¬å¯ä»¥æœ‰ä¸ªå…¨å±€å¯¼èˆªçŠ¶æ€ï¼Œä½¿ç”¨ RxSwift Observablesæš´éœ²å‡ºæ¥ï¼Œç„¶åç›‘å¬çŠ¶æ€é©±åŠ¨å¯¼èˆªã€‚å”¯ä¸€å›°æ‰°æˆ‘çš„æ˜¯å¯¼èˆªçŠ¶æ€çš„å”¯ä¸€æ€§ï¼Œä»¥åŠå®ƒå¯èƒ½å…·æœ‰ä¸å—æ§åˆ¶çš„è´£ä»»ï¼ˆä»¥åŠå®ƒå¯ä»¥å­˜å‚¨çš„æµ·é‡æ•°æ®ï¼‰</li></ul><p>å‡ºç°äº†è¿™æ ·çš„ä¸€ä¸ªæƒ³æ³•ï¼šå¯¼èˆªåªæ˜¯ä¸€ç§çŠ¶æ€çš„åå°„ï¼Œè¿™ç§çŠ¶æ€å¯ä»¥ä¸€æ­¥æ­¥ä¿®æ”¹ã€‚</p><p>ä¸€ä¸ªçŠ¶æ€ï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºç»“æ„ä¸­ä¼ æ’­ï¼Œä¸æ˜¯å­˜å‚¨åœ¨å•ä¸ªä½ç½®ä¸­ï¼Œè€Œæ˜¯ç”±è§‚å¯Ÿè€…ç»Ÿä¸€èµ·æ¥ï¼Œå¯ä»¥å¯¹å®ƒä½œå‡ºååº”å¹¶å› æ­¤é©±åŠ¨å¯¼èˆªã€‚æ–‡ç« ä¹‹åï¼Œè¿™äº›åˆ†æ•£åœ¨åº”ç”¨ç¨‹åºä¸­çš„å°çŠ¶æ€ç§°ä¸ºâ€œStepsâ€ï¼Œè§‚å¯Ÿè€…ç§°ä¸ºâ€œCoordinatorâ€ã€‚</p><p>RxFlow æ¥è‡ªç»éªŒæ€»ç»“ï¼Œä»–è§£å†³äº†ä¼ ç»Ÿä¸­ä»ç„¶å­˜åœ¨çš„ä¸¤ä¸ªä¸»è¦é—®é¢˜;Coordinator pattern:</p><ul><li>å¼€å‘äººå‘˜ä¸å¿…å†ç¼–å†™Coordinatorï¼Œä»–åªéœ€è¦å£°æ˜å¯¼èˆªåŠå…¶æ‰€é’ˆå¯¹çš„çŠ¶æ€</li><li>ä¸éœ€è¦ delegateï¼Œå› ä¸º state æ˜¯ç”± Loom ç›‘å¬ RxSwift Observable</li></ul><h2 id="å…³é”®åŸåˆ™"><a class="markdownIt-Anchor" href="#å…³é”®åŸåˆ™"></a> å…³é”®åŸåˆ™</h2><p>è¦äº†è§£æœ‰å…³ Coordinator æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œæˆ‘å»ºè®®ä½ å¼€ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  <a href="http://khanlou.com/2015/10/coordinators-redux/" target="_blank" rel="noopener">Coordinator Redux</a></p><p>å°½ç®¡è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ¶æ„ï¼Œä½†æ˜¯Coordinatoræ¨¡å¼ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>æ¯æ¬¡å¼•å¯¼åº”ç”¨ç¨‹åºæ—¶éƒ½å¿…é¡»ç¼–å†™åè°ƒæœºåˆ¶</li><li>å› ä¸ºè¦ä½¿ç”¨ delegate æ¨¡å¼æ¥å¤„ç†ä¸ Coordinator ä¹‹é—´é€šä¿¡ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šæ ·æ¿ä»£ç </li></ul><p>RxFlow æ˜¯ä¸€ä¸ªä»¥å“åº”å¼æ–¹å¼å®ç°çš„ Coordinator æ¨¡å¼ï¼Œå®ƒæœ‰ Coordinator æ¨¡å¼æ¶æ„ä¸­çš„æ‰€æœ‰é‡è¦åŠŸèƒ½ï¼Œä½†è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼š</p><ul><li>ä½¿å¯¼èˆªæ›´å…·å£°æ˜æ€§</li><li>æä¾›ä¸€ä¸ªå†…ç½®çš„åè°ƒå™¨ï¼Œç”¨äºå¤„ç†ä½ å£°æ˜çš„å¯¼èˆªæµ</li><li>ä½¿ç”¨å“åº”å¼ç¼–ç¨‹å¤„ç†å’Œ Coordinator é€šè®¯çš„é—®é¢˜</li></ul><h4 id="å¿…é¡»ç†Ÿæ‚‰6ä¸ªæœ¯è¯­æ‰èƒ½ç†è§£rxflow"><a class="markdownIt-Anchor" href="#å¿…é¡»ç†Ÿæ‚‰6ä¸ªæœ¯è¯­æ‰èƒ½ç†è§£rxflow"></a> å¿…é¡»ç†Ÿæ‚‰6ä¸ªæœ¯è¯­æ‰èƒ½ç†è§£RxFlow</h4><ul><li>Flowï¼šæ¯ä¸ª Flow éƒ½åœ¨åº”ç”¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªå¯¼èˆªåŒºåŸŸã€‚è¿™æ˜¯ä½ å£°æ˜å¯¼èˆªåŠ¨ä½œçš„åœ°æ–¹</li><li>Stepï¼šæ¯ä¸ª Step åœ¨ App ä¸­æ˜¯ä¸€ä¸ªå¯¼èˆªçŠ¶æ€ã€‚Flows å’Œ Steps çš„ç»„åˆæè¿°äº†æ‰€æœ‰å¯èƒ½çš„å¯¼èˆªæ“ä½œã€‚Step ç”šè‡³å¯ä»¥å†…åµŒå€¼ï¼ˆegï¼šIdsï¼ŒURLsâ€¦ï¼‰å°†ä¼šä¼ æ’­åˆ° Flows ä¸­å£°æ˜çš„å±å¹•</li><li>Stepperï¼šå®ƒå¯ä»¥æ˜¯ä»»ä½•å‘å‡º Steps çš„ä¸œè¥¿ï¼ŒSteppers è´Ÿè´£è§¦å‘ Flowsä¸­çš„æ¯ä¸ªå¯¼èˆªè¿‡ç¨‹ã€‚</li><li>Presentableï¼šå®ƒæ˜¯å¯ä»¥å‘ˆç°çš„äº‹ç‰©çš„æŠ½è±¡ç±»ï¼ˆåŸºæœ¬ä¸Šæ˜¯UIViewControllerå’ŒFlowæ˜¯å¯å‘ˆç°çš„ï¼‰ã€‚Presentables æä¾›å“åº”å¼ Observablesï¼Œ Coordinator å°†ä»¥å…¼å®¹ UIKit çš„æ–¹å¼ï¼Œè®¢é˜…è¿™ä¸ª Observables æ¥æ§åˆ¶Flowçš„ Steps</li><li>Flowableï¼šå®ƒæ˜¯ä¸€ä¸ªç»“åˆäº†Presentableå’ŒStepperçš„ç®€å•æ•°æ®ç»“æ„ã€‚å®ƒå‘Šè¯‰ Coordinator ä¸‹ä¸€æ­¥å°†å‘ç”Ÿä»€ä¹ˆï¼Œè¿™å°†åœ¨æ‚¨çš„å“åº”å¼æœºåˆ¶ä¸­äº§ç”Ÿæ–°çš„ Steps</li><li>Coordinatorï¼šä¸€æ—¦å¼€å‘äººå‘˜å®šä¹‰å®Œ ä»£è¡¨å¯¼èˆªå¯èƒ½æ€§çš„æµç¨‹å’Œæ­¥éª¤çš„ç»„åˆï¼ŒCoordinator çš„å·¥ä½œå°±æ˜¯ä»¥ä¸€è‡´çš„æ–¹å¼æ··åˆè¿™äº›ç»„åˆã€‚</li></ul><p>ç¬¬ä¸€ç¯‡æ–‡ç« åªæ˜¯è¯´æ˜æ¡†æ¶çš„ æ¦‚å¿µç†è®ºï¼Œæ¥ä¸‹çš„æ–‡ç« å°†ä¼šä»æºç çš„è§’åº¦è®¨è®ºæ›´å¤š æœ‰å…³ RxFlow çš„æŠ€æœ¯ç‚¹ã€‚</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> RxSwift </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¿»è¯‘ </tag>
            
            <tag> RxSwift </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OC å¯¹è±¡åˆ†æ</title>
      <link href="/2018/01/09/deep%20analyse/OC-%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90/"/>
      <url>/2018/01/09/deep%20analyse/OC-%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p>å¼•ç”¨æºç ï¼š<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">objc4</a></p><p><img src="/img/oc_object.jpg" alt="ocå¯¹è±¡ç»“æ„"></p><p>æ€è€ƒï¼šé—®è‡ªå·±çš„é—®é¢˜</p><ol><li>å®ä¾‹å¯¹è±¡ï¼Œç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡ä¹‹é—´çš„å…³ç³»</li><li>å¯¹è±¡çš„å±æ€§&amp;æ–¹æ³•æ˜¯æ€ä¹ˆä¼ çš„</li><li>å¯¹è±¡æ–¹æ³•æ˜¯å¦‚ä½•æŸ¥è¯¢çš„</li><li>oc çš„æ¶ˆæ¯æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„</li><li>è¿™äº›ç†è®ºå¯ä»¥åº”ç”¨åˆ°ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</li></ol><h2 id="objective-cä¸­çš„å¯¹è±¡æœ‰å“ªäº›"><a class="markdownIt-Anchor" href="#objective-cä¸­çš„å¯¹è±¡æœ‰å“ªäº›"></a> Objective-Cä¸­çš„å¯¹è±¡æœ‰å“ªäº›</h2><p>Objective-Cä¸­ä¸‡ç‰©æ¥å¯¹è±¡ï¼Œå¯¹è±¡ä¸»è¦åˆ†ä¸º3ç§</p><ul><li>instanceå¯¹è±¡</li><li>classå¯¹è±¡</li><li>meta-classå¯¹è±¡</li></ul><h2 id="objc_object-æºç ç»“æ„"><a class="markdownIt-Anchor" href="#objc_object-æºç ç»“æ„"></a> objc_object æºç ç»“æ„</h2><p><img src="/img/objc_object_struct.jpg" alt="objc_object"></p><h2 id="objc_class-æºç ç»“æ„"><a class="markdownIt-Anchor" href="#objc_class-æºç ç»“æ„"></a> objc_class æºç ç»“æ„</h2><p><img src="/img/objc_class_struct.jpg" alt="objc_class"></p><p>class å’Œ meta-class çš„ç»“æ„ç›¸åŒ</p><h3 id="isa-å’Œ-superclass-æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#isa-å’Œ-superclass-æŒ‡é’ˆ"></a> isa å’Œ superclass æŒ‡é’ˆ</h3><p><img src="/img/isa_superclass.jpg" alt=""></p><p>isa æŒ‡å‘ç”Ÿäº§ä»–è¿™ä¸ªå¯¹è±¡çš„å¯¹è±¡ï¼š</p><ol><li>instance å¯¹è±¡çš„isa æ˜¯class å¯¹è±¡</li><li>class å¯¹è±¡çš„ isa æ˜¯ meta-class å¯¹è±¡</li><li>meta-class çš„ isa æ˜¯ root-metaclass å¯¹è±¡ï¼ˆæ‰€æœ‰å…ƒç±»çš„ isa éƒ½æŒ‡å‘ä»–ï¼‰</li></ol><p><img src="/img/message-searching.jpg" alt=""></p><h3 id="class_rw_t-å’Œ-class_ro_t"><a class="markdownIt-Anchor" href="#class_rw_t-å’Œ-class_ro_t"></a> class_rw_t å’Œ class_ro_t</h3><p>è§ä¸Šå›¾ ğŸ‘†</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Meta Class</title>
      <link href="/2018/01/03/deep%20analyse/Meta-Class/"/>
      <url>/2018/01/03/deep%20analyse/Meta-Class/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>smallTalk ä¸­ Metaclass çš„ 7ä¸ªè¦ç´ </p><ol><li>object æ˜¯ class çš„å®ä¾‹</li><li>class æœ€ç»ˆç»§æ‰¿è‡ª object</li><li>class æ˜¯ metaclass çš„å®ä¾‹</li><li>metaclass å’Œ class çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„</li><li>metaclass ç»§æ‰¿è‡ª class å’Œ behavior</li><li>metaclass æ˜¯ Metaclass çš„å®ä¾‹</li><li>Metaclass çš„ metaclass æ˜¯ Metaclass çš„å®ä¾‹</li></ol><h2 id="object-æ˜¯-class-çš„å®ä¾‹"><a class="markdownIt-Anchor" href="#object-æ˜¯-class-çš„å®ä¾‹"></a> object æ˜¯ class çš„å®ä¾‹</h2><p><img src="/img/object_is_class.jpeg" alt="object æ˜¯ class çš„å®ä¾‹"></p><h2 id="æ¯ä¸ª-class-éƒ½ç»§æ‰¿è‡ª-object"><a class="markdownIt-Anchor" href="#æ¯ä¸ª-class-éƒ½ç»§æ‰¿è‡ª-object"></a> æ¯ä¸ª class éƒ½ç»§æ‰¿è‡ª Object</h2><p>å®ä¾‹å¯¹è±¡çš„ class éƒ½ç»§æ‰¿è‡ª Object<br><img src="/img/classInheritsObject.jpeg" alt="objc_class: objc_object"></p><h3 id="is-a-çš„å«ä¹‰"><a class="markdownIt-Anchor" href="#is-a-çš„å«ä¹‰"></a> is-a çš„å«ä¹‰</h3><p>å½“ Object æ¥æ”¶ msg çš„æ—¶å€™ï¼Œåœ¨ä»–çš„ class å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾ï¼Œä¸€ç›´æ²¿ç€ superclasses ï¼ŒçŸ¥é“ Object å¯¹è±¡æŸ¥æ‰¾è¿™ä¸ªæ¶ˆæ¯<br><img src="/img/is-a.jpeg" alt="is-aç”¨äºæŸ¥æ‰¾æ¶ˆæ¯"></p><h3 id="object-çš„è´£ä»»"><a class="markdownIt-Anchor" href="#object-çš„è´£ä»»"></a> Object çš„è´£ä»»</h3><ol><li>æè¿° Object çš„å…¬å…±è¡Œä¸º<ul><li>error-handling, halting â€¦</li></ul></li><li>æ‰€æœ‰ç±»æœ€ç»ˆéƒ½ç»§æ‰¿è‡ª Object</li></ol><h2 id="class-æ˜¯-metaclass-çš„å®ä¾‹"><a class="markdownIt-Anchor" href="#class-æ˜¯-metaclass-çš„å®ä¾‹"></a> class æ˜¯ metaclass çš„å®ä¾‹</h2><p>Class ä¹Ÿæ˜¯å¯¹è±¡ï¼šæ¯ä¸ª class A æ˜¯ä»–çš„ metaclass çš„å”¯ä¸€å®ä¾‹ï¼Œå«åš A class<br><img src="/img/metaclass.jpeg" alt=""></p><h3 id="metaclasses-æ˜¯éšå¼çš„"><a class="markdownIt-Anchor" href="#metaclasses-æ˜¯éšå¼çš„"></a> metaclasses æ˜¯éšå¼çš„</h3><ol><li>å½“åˆ›å»º class çš„æ˜¯æ—¶å€™ï¼Œä¼šéšå¼åˆ›å»º Metaclass</li><li>æ²¡æœ‰å…±äº«çš„ metaclass(class å’Œ metaclass æ˜¯ä¸€ä¸€å¯¹åº”çš„)</li></ol><h2 id="metaclass-å’Œ-class-çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„"><a class="markdownIt-Anchor" href="#metaclass-å’Œ-class-çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„"></a> metaclass å’Œ class çš„ç»§æ‰¿æ˜¯å¹³è¡Œçš„</h2><p>class å’Œ object çš„ä¸€è‡´æ€§</p><ol><li><strong>object æœ‰çš„ä¸œè¥¿ï¼Œclass ä¹Ÿæœ‰</strong></li><li><strong>åŒæ ·çš„æ–¹æ³•æŸ¥è¯¢ç­–ç•¥</strong><ol><li>object åœ¨class çš„ method å­—å…¸ä¸­æŸ¥æ‰¾</li><li>class åœ¨ metaclass çš„method å­—å…¸ä¸­æŸ¥æ‰¾</li></ol></li></ol><h2 id="metaclass-ç»§æ‰¿è‡ª-class-å’Œ-behavior"><a class="markdownIt-Anchor" href="#metaclass-ç»§æ‰¿è‡ª-class-å’Œ-behavior"></a> metaclass ç»§æ‰¿è‡ª class å’Œ behavior</h2><h2 id="metaclass-æ˜¯-metaclass-çš„å®ä¾‹"><a class="markdownIt-Anchor" href="#metaclass-æ˜¯-metaclass-çš„å®ä¾‹"></a> metaclass æ˜¯ Metaclass çš„å®ä¾‹</h2><h2 id="metaclass-çš„-metaclass-æ˜¯-metaclass-çš„å®ä¾‹"><a class="markdownIt-Anchor" href="#metaclass-çš„-metaclass-æ˜¯-metaclass-çš„å®ä¾‹"></a> Metaclass çš„ metaclass æ˜¯ Metaclass çš„å®ä¾‹</h2><p><img src="/img/metaclass_relation.jpeg" alt=""></p><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-metaclass"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆè¦æœ‰-metaclass"></a> ä¸ºä»€ä¹ˆè¦æœ‰ MetaClass</h2><p>objc_class: objc_object, æ‰€ä»¥object æœ‰çš„ä¸œè¥¿ class ä¹Ÿæœ‰</p><ol><li>object æ˜¯ class çš„å®ä¾‹ï¼Œclass æ˜¯ metaclass çš„å®ä¾‹</li><li>object æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®æ–¹æ³•éƒ½ä¿å­˜åœ¨ class å¯¹è±¡ä¸­ï¼›classæ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®æ–¹æ³•éƒ½ä¿å­˜åœ¨ metaclass å¯¹è±¡ä¸­</li><li>class æ˜¯ object çš„å·¥å‚ï¼Œmetaclass æ˜¯class çš„å·¥å‚</li><li>å› ä¸ºclass ç»§æ‰¿è‡ª object æ‰€ä»¥æ¶ˆæ¯æŸ¥æ‰¾æ–¹å¼ç›¸åŒ</li></ol><p>å¦‚æœæ²¡æœ‰ metaclass å‘¢ï¼Ÿ</p><ol><li>smalltalk-76ï¼Œç±»çš„ç±»éƒ½æ˜¯ <code>Class</code> ï¼Œè¯¥ç±»å®ç°äº†ä»»ä½•ç±»éƒ½éœ€è¦çš„æ–¹æ³•-eg. newæ–¹æ³•ã€‚å¦‚æœæƒ³æ·»åŠ ä¸€ä¸ªç±»æ–¹æ³•ï¼Œå¿…é¡»æ·»åŠ åˆ° <code>Class</code></li><li>objc_msgSend(void /* id self, SEL op, â€¦ */) å¤ç”¨æ¶ˆæ¯é€šé“ï¼Œç±»æ–¹æ³•ä¹Ÿå¯ä»¥æ”¾åœ¨Classé‡Œï¼Œä½†å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦å¢åŠ ä¸€ä¸ªå‚æ•°</li></ol><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flexbox model</title>
      <link href="/2017/12/09/flexbox-model/"/>
      <url>/2017/12/09/flexbox-model/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/align-content" target="_blank" rel="noopener">flex-container å±æ€§demo</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/flex" target="_blank" rel="noopener">flex-item å±æ€§demo</a></p><h2 id="åŸºç¡€æœ¯è¯­"><a class="markdownIt-Anchor" href="#åŸºç¡€æœ¯è¯­"></a> åŸºç¡€&amp;æœ¯è¯­</h2><div align="center"><img src="/img/flex_terms.jpeg" alt="flex_terms" style="width:300px;height:180px"></div><ul><li>main axis - flex container ä¸»è½´ï¼Œ<code>flex-items</code> æ²¿ç€è¿™ä¸ªè½´å¸ƒå±€ã€‚å…·ä½“å“ªä¸ªæ–¹å‘å–å†³äº <code>flex-direction</code> å±æ€§ (see below).</li><li>main-start | main-end - <code>flex-items</code> åœ¨ flex-container ä¸­ä» main-start åˆ° main-end å¸ƒå±€.</li><li>main size - flex-item <code>main-axis</code> æ–¹å‘çš„é•¿åº¦</li><li>cross axis - å‚ç›´äº <code>main-axis</code> çš„è½´ã€‚å³å‚ç›´äº <code>flex-items</code> æ’åˆ—å¸ƒå±€æ–¹å‘çš„è½´ã€‚</li><li>cross-start | cross-end - <code>Flex-item</code> å¸ƒå±€å‚ç›´æ–¹å‘å¸ƒå±€ä» cross-start åˆ° cross-end.</li><li>cross size - flex-item <code>cross-axis</code> æ–¹å‘é•¿åº¦</li></ul><h2 id="å±æ€§"><a class="markdownIt-Anchor" href="#å±æ€§"></a> å±æ€§</h2><table><thead><tr><th>å±æ€§</th><th>æè¿°</th><th>å¯å–å€¼</th></tr></thead><tbody><tr><td>display</td><td>æŒ‡å®š HTML å…ƒç´ ç›’å­ç±»å‹</td><td>flex,inline-flex</td></tr><tr><td>flex-direction</td><td>æŒ‡å®šäº†å¼¹æ€§å®¹å™¨ä¸­å­å…ƒç´ çš„æ’åˆ—æ–¹å¼</td><td>row,column</td></tr><tr><td>flex-wrap</td><td>è®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ è¶…å‡ºçˆ¶å®¹å™¨æ—¶æ˜¯å¦æ¢è¡Œ</td><td>wrap,nowrap,wrap-reverse</td></tr><tr><td>justify-content</td><td>è®¾ç½®å¼¹æ€§ç›’å­å…ƒç´ åœ¨ä¸»è½´ï¼ˆæ¨ªè½´ï¼‰æ–¹å‘ä¸Šçš„å¯¹é½æ–¹å¼</td><td>flex-start,flex-end,center,space-around,space-between</td></tr><tr><td>align-self</td><td>åœ¨å¼¹æ€§å­å…ƒç´ ä¸Šä½¿ç”¨è¦†ç›–å®¹å™¨çš„ align-items å±æ€§</td><td>flex-start,flex-end,center</td></tr><tr><td>align-items</td><td>è®¾ç½®å¼¹æ€§ç›’å­å…ƒç´ åœ¨ä¾§è½´ï¼ˆçºµè½´ï¼‰æ–¹å‘ä¸Šçš„å¯¹é½æ–¹å¼</td><td>flex-start ,flex-end,center,stretch,baseline</td></tr><tr><td>align-content</td><td>ä¿®æ”¹ flex-wrap å±æ€§çš„è¡Œä¸ºï¼Œç±»ä¼¼align-items, ä½†ä¸æ˜¯è®¾ç½®å­å…ƒç´ å¯¹é½ï¼Œè€Œæ˜¯è®¾ç½®è¡Œå¯¹é½</td><td>flex-start,flex-end,center,space-around,space-between,stretch</td></tr><tr><td>order</td><td>è®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ æ’åˆ—é¡ºåº</td><td>integer</td></tr><tr><td>flex</td><td>è®¾ç½®å¼¹æ€§ç›’å­çš„å­å…ƒç´ å¦‚ä½•åˆ†é…ç©ºé—´</td><td>integer</td></tr><tr><td>flex-basis</td><td>æŒ‡å®š flex å…ƒç´ åœ¨ä¸»è½´æ–¹å‘ä¸Šçš„åˆå§‹å¤§å°ã€‚å¦‚æœä¸ä½¿ç”¨ box-sizing æ”¹å˜ç›’æ¨¡å‹çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±å†³å®šäº† flex å…ƒç´ çš„å†…å®¹ç›’ï¼ˆcontent-boxï¼‰çš„å°ºå¯¸ã€‚</td><td>integer</td></tr><tr><td>flex-grow</td><td>å…ƒç´ çš„æ‰©å¤§æ¯”ç‡</td><td>integer</td></tr><tr><td>flex-shrink</td><td>å…ƒç´ çš„æ”¶ç¼©æ¯”ç‡</td><td>integer</td></tr></tbody></table><h3 id="çˆ¶çº§çš„å±æ€§flex-container"><a class="markdownIt-Anchor" href="#çˆ¶çº§çš„å±æ€§flex-container"></a> çˆ¶çº§çš„å±æ€§â€“flex-container</h3><h4 id="flex-direction"><a class="markdownIt-Anchor" href="#flex-direction"></a> flex-direction</h4><div align="left"><img src="/img/flex-direction.jpeg" alt="direction" style="width:200px;height:83"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row | row-reverse | column | column-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flex-wrap"><a class="markdownIt-Anchor" href="#flex-wrap"></a> flex-wrap</h4><div align="left"><img src="/img/flex-wrap.jpeg" alt="runloop" style="width:200px;height:93"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span>&#123;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: nowrap | wrap | wrap-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>nowrap (default): æ‰€æœ‰ items éƒ½åœ¨ä¸€è¡Œæ˜¾ç¤º</li><li>wrap: flex items å°†ä»ä¸Šåˆ°ä¸‹å¤šè¡Œæ˜¾ç¤ºã€‚</li><li>wrap-reverse: å°†ä»ä¸‹åˆ°ä¸Šå¤šè¡Œæ˜¾ç¤ºã€‚</li></ul><p><a href="https://codepen.io/team/css-tricks/pen/1ea1ef35d942d0041b0467b4d39888d3/" target="_blank" rel="noopener">flex-wrap å¯è§†åŒ–demo</a><br>ä½¿ç”¨ demoçš„æ—¶å€™è°ƒæ•´æµè§ˆå™¨å¤§å°</p><h4 id="justify-content"><a class="markdownIt-Anchor" href="#justify-content"></a> justify-content</h4><p>main-axis æ–¹å‘ flex-items å¸ƒå±€æ–¹å¼ã€‚</p><div align="left"><img src="/img/flex-justify-content.jpeg" alt="runloop" style="width:150px;height:240"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">justify-content</span>: flex-start | flex-end | center | space-between | space-around | space-evenly | start | end | left | right ... + safe | unsafe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/justify-content" target="_blank" rel="noopener">justify-content: demo</a></p><h4 id="align-items"><a class="markdownIt-Anchor" href="#align-items"></a> align-items</h4><p>cross-axis æ–¹å‘ flex-items å¸ƒå±€æ–¹å¼</p><div align="left"><img src="/img/flex-align-items.jpeg" alt="runloop" style="width:156px;height:200"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">align-items</span>: stretch | flex-start | flex-end | center | baseline | first baseline | last baseline | start | end | self-start | self-end + ... safe | unsafe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="align-content"><a class="markdownIt-Anchor" href="#align-content"></a> align-content</h4><p>ç±»ä¼¼align-items, ä½†ä¸æ˜¯è®¾ç½®å­å…ƒç´ å¯¹é½ï¼Œè€Œæ˜¯è®¾ç½®è¡Œå¯¹é½</p><div align="left"><img src="/img/flex-align-content.jpeg" alt="content" style="width:156px;height:190"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">align-content</span>: flex-start | flex-end | center | space-between | space-around | space-evenly | stretch | start | end | baseline | first baseline | last baseline + ... safe | unsafe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¬¡çº§å±æ€§flex-items"><a class="markdownIt-Anchor" href="#æ¬¡çº§å±æ€§flex-items"></a> æ¬¡çº§å±æ€§(flex items)</h3><h4 id="order"><a class="markdownIt-Anchor" href="#order"></a> order</h4><p>å…ƒç´ æ’åˆ—é¡ºåº</p><div align="left"><img src="/img/flex-order.jpeg" alt="order" style="width:156px;height:190"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">order</span>: &lt;integer&gt;; <span class="comment">/* default is 0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flex-grow"><a class="markdownIt-Anchor" href="#flex-grow"></a> flex-grow</h4><p>å…ƒç´ çš„æ‰©å±•æ¯”ç‡</p><div align="left"><img src="/img/flex-grow.jpeg" alt="content" style="width:156px;height:60"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">flex-grow</span>: &lt;number&gt;; <span class="comment">/* default 0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flex-shrink"><a class="markdownIt-Anchor" href="#flex-shrink"></a> flex-shrink</h4><p>å…ƒç´ çš„æ”¶ç¼©æ¯”ç‡</p><h4 id="flex-basis"><a class="markdownIt-Anchor" href="#flex-basis"></a> flex-basis</h4><p>flex-basis æŒ‡å®šäº† flex å…ƒç´ åœ¨ä¸»è½´æ–¹å‘ä¸Šçš„åˆå§‹å¤§å°ã€‚å¦‚æœä¸ä½¿ç”¨ box-sizing æ”¹å˜ç›’æ¨¡å‹çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±å†³å®šäº† flex å…ƒç´ çš„å†…å®¹ç›’ï¼ˆcontent-boxï¼‰çš„å°ºå¯¸ã€‚</p><h4 id="align-self"><a class="markdownIt-Anchor" href="#align-self"></a> align-self</h4><p>åœ¨å¼¹æ€§å­å…ƒç´ ä¸Šä½¿ç”¨ã€‚è¦†ç›–å®¹å™¨çš„ align-items å±æ€§ã€‚</p><div align="left"><img src="/img/flex-align-self.jpeg" alt="content" style="width:156px;height:77"></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">align-self</span>: auto | flex-start | flex-end | center | baseline | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="https://www.w3cschool.cn/css3/2h6g5xoy.html" target="_blank" rel="noopener">CSS3 å¼¹æ€§ç›’å­(Flex Box)</a><br><a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/" target="_blank" rel="noopener">A Complete Guide to Flexbox</a><br><a href="https://codebond.co/tutorial/css/complete-guide-to-flexbox" target="_blank" rel="noopener">Complete Guide to Flexbox</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ€æƒ³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ€æƒ³ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP/IP</title>
      <link href="/2017/11/18/TCP-IP/"/>
      <url>/2017/11/18/TCP-IP/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="tcpip"><a class="markdownIt-Anchor" href="#tcpip"></a> TCP/IP</h2><h3 id="tcpip-ä¸‰æ¬¡æ¡æ‰‹"><a class="markdownIt-Anchor" href="#tcpip-ä¸‰æ¬¡æ¡æ‰‹"></a> TCP/IP ä¸‰æ¬¡æ¡æ‰‹</h3><p>http æ˜¯åŸºäº TCP/IP åè®®ï¼ŒåŒå…¨å·¥</p><p><img src="/img/TCP-IP-Connection.JPG" alt="tcp/ip ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹"></p><ul><li><p>ä¸ºä»€ä¹ˆè¦3æ¬¡æ¡æ‰‹ï¼Ÿ</p><ul><li>æœ€ç®€å•çš„å›ç­”ï¼Œåä¸€ä¸ªæ¬¡æ¡æ‰‹éƒ½æ˜¯ç¡®å®šå‰ä¸€æ¬¡æ¡æ‰‹çš„æ¥å—æˆåŠŸï¼é™¤äº†ç¬¬ä¸€æ¬¡æ˜¯æœ‰ seq=xï¼Œå…¶ä»–æ¯æ¬¡æ¡æ‰‹éƒ½è¦å¸¦ä¸Š ack=x+1ï¼Œç¡®å®šä¸Šä¸€æ¬¡çš„ seqæ¥å—æˆåŠŸ</li><li>è¿™ä¹Ÿè¯´æ˜æœ€åä¸€æ¬¡æ¡æ‰‹æ°¸è¿œæ˜¯å¦èƒ½å¤Ÿæ¥å—éƒ½æ˜¯æ— æ³•ä¿éšœçš„ï¼Œä½†æ˜¯ &gt;= ä¸‰æ¬¡æ¡æ‰‹åŸºæœ¬æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€å†æµªè´¹èµ„æº</li></ul></li><li><p>ä¸ºä»€ä¹ˆè¦4æ¬¡æŒ¥æ‰‹ï¼Ÿä¸‰æ¬¡å°±å¯ä»¥æ»¡è¶³åŒæ–¹éƒ½çŸ¥é“ç»“æœäº†å‘€ï¼Ÿ</p><ul><li>åˆ†æ‰‹è¦åŒæ–¹éƒ½æå‡ºï¼Œæˆ‘è¦åˆ†æ‰‹ï¼Œæ¯ä¸€æ–¹æå‡ºéƒ½è¦å¯¹æ–¹ç¡®è®¤ä¸€ä¸‹ï¼æ‰€ä»¥æœ‰äº†ä¸€å¯¹ (fin=x â€“ ack=x+1), (fin=y â€“ ack=y+1)</li><li>fin=x æ˜¯æå‡ºåˆ†æ‰‹ï¼Œç¼–å·xï¼Œack=x+1 æ˜¯ç¡®å®šå—åˆ° fin=xæŠ¥æ–‡æ•°æ®ï¼Œç„¶åæˆ‘ä¹Ÿè¦å‘ä¸€æ¬¡æˆ‘è¦åˆ†æ‰‹</li><li>ä¸ºä»€ä¹ˆè¦åŒæ–¹éƒ½è¦ä¸»åŠ¨å‘é€ fin å‘¢ï¼Ÿå› ä¸ºä¸€æ–¹å‘é€ fin ä»¥åï¼Œå¦ä¸€å‘æœ‰å¯èƒ½è¿˜æœ‰æ²¡æœ‰å‘å®Œçš„æ•°æ®ï¼Œç¡®è®¤åŒæ–¹éƒ½æ˜¯æ²¡æœ‰äº‹è¦åšäº†</li></ul></li></ul><h3 id="wireshark-ä½¿ç”¨éªŒè¯-tcpip-è¿æ¥"><a class="markdownIt-Anchor" href="#wireshark-ä½¿ç”¨éªŒè¯-tcpip-è¿æ¥"></a> WireShark ä½¿ç”¨éªŒè¯ TCP/IP è¿æ¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -l 12345        //ç›‘å¬</span><br><span class="line">nc 127.0.0.1 12345 //å»ºç«‹è¿æ¥</span><br></pre></td></tr></table></figure><p>WireShark, Loopback:lo0</p><p><img src="/img/tcp-ip-wireshark1.jpeg" alt="tcp/ip wire-shark1 å»ºç«‹è¿æ¥ä¸‰æ¬¡æ¡æ‰‹"></p><p><img src="/img/tcp-ip-wireshark2.jpeg" alt="tcp/ip wire-shark2 å…¨æµç¨‹"></p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºåŸºç¡€çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Categoryåˆ†æ</title>
      <link href="/2017/11/17/deep%20analyse/Category%E5%88%86%E6%9E%90/"/>
      <url>/2017/11/17/deep%20analyse/Category%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>å½“ç»™ç±»æ·»åŠ æ–¹æ³•çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæƒ³åˆ°ä½¿ç”¨ categoryï¼Œç»™ç±»æ·»åŠ æ–¹æ³•</p><p>oc çš„åœ¨runtime çš„æ—¶å€™</p><h2 id="åˆ†ç±»æ˜¯å¦‚ä½•åŠ è½½çš„"><a class="markdownIt-Anchor" href="#åˆ†ç±»æ˜¯å¦‚ä½•åŠ è½½çš„"></a> åˆ†ç±»æ˜¯å¦‚ä½•åŠ è½½çš„</h2><p>æŸ¥çœ‹ objc æºç è°ƒç”¨è¿‡ç¨‹</p><ol><li><p><a href="http://objc-os.mm" target="_blank" rel="noopener">objc-os.mm</a><br>_objc_init<br>map_images<br>map_images_nolock</p></li><li><p><a href="http://objc-runtime-new.mm" target="_blank" rel="noopener">objc-runtime-new.mm</a><br>_read_images<br>remethodizeClass<br>attachCategories<br>attachLists<br>reallocã€memmoveã€ memcpy</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">category_t</span> &#123;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">  <span class="keyword">classref_t</span> cls;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">instanceMethods</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">classMethods</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *<span class="title">instanceProperties</span>;</span></span><br><span class="line">  <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *_<span class="title">classProperties</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">method_list_t</span> *methodsForMeta(<span class="keyword">bool</span> isMeta) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">property_list_t</span> *propertiesForMeta(<span class="keyword">bool</span> isMeta, struct header_info *hi);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CAShapeLayer ç”»å›¾</title>
      <link href="/2017/10/27/UI%20%E7%9B%B8%E5%85%B3/CAShapeLayer-%E7%94%BB%E5%9B%BE/"/>
      <url>/2017/10/27/UI%20%E7%9B%B8%E5%85%B3/CAShapeLayer-%E7%94%BB%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-shapelayer"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆè¦æœ‰-shapelayer"></a> ä¸ºä»€ä¹ˆè¦æœ‰ ShapeLayerï¼Ÿ</h2><p>å› ä¸ºå¹³å¸¸å¼€å‘ä¸­ ä¸»è¦æ˜¯ çŸ©å½¢çš„ç»˜åˆ¶ï¼Œå¾ˆå°‘ç”¨åˆ°å…¶ä»–å¤šè¾¹å½¢çš„ï¼ˆä¸€èˆ¬éƒ½ç”¨å›¾ç‰‡ä»£æ›¿ï¼‰<br>ä½¿ç”¨ ShapeLayerï¼Œé€šè¿‡ path æ¥å®šä¹‰è‡ªå·±çš„å›¾å½¢<br>å—¯ shapelayer å°±æ˜¯ä¸€ä¸ª ç»˜åˆ¶ path çš„å·¥å…·</p><p>ä¹Ÿå¯ä»¥ç”¨ <code>Core Graphics</code> ç›´æ¥å‘åŸå§‹çš„CALyerçš„å†…å®¹ä¸­ç»˜åˆ¶è·¯å¾„<br>CAShapeLayeræ˜¯ä¸€ä¸ªé€šè¿‡ <code>çŸ¢é‡</code> å›¾å½¢è€Œä¸æ˜¯ <code>bitmap</code> æ¥ç»˜åˆ¶çš„å›¾å±‚CALayerçš„å­ç±»ã€‚</p><p>ç›¸æ¯”ç›´ä¸‹ï¼Œä½¿ç”¨CAShapeLayeræœ‰ä»¥ä¸‹ä¸€äº›ä¼˜ç‚¹ï¼š</p><ul><li>æ¸²æŸ“å¿«é€Ÿ: CAShapeLayerä½¿ç”¨äº†ç¡¬ä»¶åŠ é€Ÿï¼Œç»˜åˆ¶åŒä¸€å›¾å½¢ä¼šæ¯”ç”¨Core Graphicså¿«å¾ˆå¤š</li><li>é«˜æ•ˆä½¿ç”¨å†…å­˜: ä¸€ä¸ªCAShapeLayerä¸éœ€è¦åƒæ™®é€šCALayerä¸€æ ·åˆ›å»ºä¸€ä¸ªå¯„å®¿å›¾å½¢ï¼Œæ‰€ä»¥æ— è®ºæœ‰å¤šå¤§ï¼Œéƒ½ä¸ä¼šå ç”¨å¤ªå¤šçš„å†…å­˜</li><li>ä¸ä¼šè¢«å›¾å±‚è¾¹ç•Œå‰ªè£æ‰: ä¸€ä¸ªCAShapeLayerå¯ä»¥åœ¨è¾¹ç•Œä¹‹å¤–ç»˜åˆ¶:ä½ çš„å›¾å±‚è·¯å¾„ä¸ä¼šåƒåœ¨ä½¿ç”¨Core Graphicsçš„æ™®é€šCALayerä¸€æ ·è¢«å‰ªè£æ‰</li><li>ä¸ä¼šå‡ºç°åƒç´ åŒ–: å½“ä½ ç»™CAShapeLayeråš3Då˜æ¢æ—¶ï¼Œå®ƒä¸åƒä¸€ä¸ªæœ‰å¯„å®¿å›¾çš„æ™®é€šå›¾å±‚ä¸€æ ·å˜å¾—åƒç´ åŒ–</li></ul><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> UI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> æ€§èƒ½ </tag>
            
            <tag> UI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªåŠ¨å¸ƒå±€åŒ…è£¹è§†å›¾</title>
      <link href="/2017/09/21/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E5%8C%85%E8%A3%B9%E8%A7%86%E5%9B%BE/"/>
      <url>/2017/09/21/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E5%8C%85%E8%A3%B9%E8%A7%86%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p><a href="http://devetc.org/code/2014/07/07/auto-layout-and-views-that-wrap.html" target="_blank" rel="noopener">åŸæ–‡ Auto Layout and Views that Wrap</a><br>ç†è§£åŒ…è£¹æ–‡æœ¬å’Œå…¶ä»–æµåŠ¨å¸ƒå±€ã€‚<br>åœ¨è§†å±ä¸­ï¼Œç›’å­é‡Œçš„é¢ï¼Œå½“container resized çš„æ—¶å€™ï¼ŒUILabel (æˆ–è€… Mac ç³»ç»Ÿé‡Œé¢çš„Â NSTextField) åŒ…è£¹çš„æ–‡å­—çš„è¡Œä¸ºåƒè¿™æ ·ï¼š</p><p><a href="http://devetc.org/assets/2014-07-07-auto-layout-and-views-that-wrap/label-default-resize.webm" target="_blank" rel="noopener">video1</a></p><p>è¿™ç¯‡æ–‡ç« å°†ä¼šè®²è§£ï¼Œå½“ container resized çš„æ—¶å€™ UILabel çš„è¡Œä¸ºä¼šæ˜¯è¿™æ ·çš„ï¼š<br><a href="http://devetc.org/assets/2014-07-07-auto-layout-and-views-that-wrap/label-dynamic-preferred-max-layout-width.webm" target="_blank" rel="noopener">video2</a></p><h1 id="ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™æ ·çš„æ•ˆæœ"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™æ ·çš„æ•ˆæœ"></a> ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™æ ·çš„æ•ˆæœ</h1><p>åœ¨è‡ªåŠ¨å¸ƒå±€ä¸­ï¼Œview æœ‰ä¸€ä¸ªâ€œå›ºæœ‰å°ºå¯¸â€ï¼ˆintrinsic content sizeï¼‰çš„æ¦‚å¿µï¼šå®½å’Œé«˜ï¼ˆéƒ½æœ‰ï¼Œæˆ–æœ‰å…¶ä¸€ï¼Œæˆ–éƒ½æ²¡æœ‰ï¼‰åˆšå¥½æ»¡è¶³view çš„å¤§å°ã€‚å¸ƒå±€ç³»ç»Ÿæ ¹æ®viewçš„ â€œcompression resistanceâ€çš„ ä¼˜å…ˆçº§ï¼Œè‡³å°‘ä¼šç»™view ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºé—´ã€‚<br>å¸ƒå±€ç³»ç»Ÿåˆ†åˆ«å¯¹å¾… width å’Œ heightã€‚<br>ä¸¾ä¾‹ï¼šå¦‚æœä¸€ä¸ª segmented controlâ€™sçš„æ–‡æœ¬å¾ˆé•¿ä»¥è‡³äºè¶…å‡ºåŒ…è£¹viewçš„å®½åº¦ï¼Œå®ƒçš„å›ºæœ‰é«˜åº¦ä»ç„¶å°è¯•æ»¡è¶³ åœ¨viewçš„é«˜åº¦ã€‚<br>è¿™ç§æ•ˆæœå¯¹äºå·²ç»å®šä¹‰sizeçš„ view éå¸¸å¥½ï¼Œsuch as buttons, sliders, and small labels.<br>ä½†æ˜¯åŒ…è£¹çš„view ä¼šæœ‰ååˆ†å¤æ‚çš„è¡Œä¸ºï¼šä»–ä»¬çš„ width å’Œ height ç›¸äº’å…³è”ï¼Œç³»ç»Ÿæœ‰çš„æ—¶å€™ä¼šè®©å›ºæœ‰ width ç…§é¡¾å›ºæœ‰ heightï¼Œåè¿‡æ¥ä¹Ÿæ˜¯ã€‚<br>è¿™ç§æƒ…å†µä¸èƒ½å•çº¯çš„ç”¨ å¸ƒå±€é™åˆ¶æ¥è§£é‡Š<br><strong>è¯æ˜:</strong> æ€è€ƒä¸€ä¸ªç®€åŒ–æ¨¡å‹ï¼Œå¿½ç•¥word æˆªæ–­å’Œå¤æ‚çš„æ–‡æœ¬å†…å®¹ã€‚æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæœ‰å›ºå®šé¢ç§¯çš„ view,<br>i.e.Â <em>width</em>Â Ã—Â <em>height</em>Â =Â <em>constant</em>. å¸ƒå±€é™åˆ¶ä¸€å®šè¦è¿™ä¹Ÿæ ·çš„æ ¼å¼ï¼š<br><em>attribute1</em>Â =Â <em>multiplier</em>Â Ã—Â <em>attribute2</em>+Â <em>constant</em>Â (ä¸ºäº†è®©ç³»ç»Ÿå¯ä»¥æä¾›ç¡®å®šçš„æ‰§è¡Œæ•ˆæœ). æ²¡æœ‰å•¥æ–¹å¼ä½¿ç”¨ç¬¬äºŒä¸ªç­‰å¼æ¥è¡¨ç¤ºç¬¬ä¸€ä¸ªç­‰å¼ã€‚å› æ­¤ä¹Ÿæ²¡æœ‰å•¥æ–¹å¼æè¿°å¸ƒå±€é™åˆ¶åŒ…è£¹çš„ viewã€‚<br>æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å¸ƒå±€å¼•æ“è®¡ç®—å‡ºæ¥çš„ width å’Œ height ä½œä¸ºè‡ªç”±å˜é‡ã€‚<br>æœ€ç®€å•çš„æ–¹å¼â€“ä¹Ÿæ˜¯apple ä½¿ç”¨çš„ä¸€ç§â€“æ˜¯å›ºå®š widthï¼Œç„¶åè®© height è‡ªé€‚åº”ï¼ˆå–å†³label çš„å†…å®¹å¤§å°ï¼‰</p><h1 id="æ¨æ–­æœ€å¤§-å¸ƒå±€-å®½åº¦"><a class="markdownIt-Anchor" href="#æ¨æ–­æœ€å¤§-å¸ƒå±€-å®½åº¦"></a> æ¨æ–­æœ€å¤§ å¸ƒå±€ å®½åº¦</h1><p>UILabel å’ŒÂ NSTextField æœ‰ <strong>preferredMaxLayoutWidth</strong> è¿™ä¸ªå±æ€§ã€‚å¦‚æœå®ƒ é 0ï¼Œä»–å°±ä¼šä½œä¸ºlabel çš„å›ºæœ‰å°ºå¯¸çš„æœ€å¤§å®½åº¦ï¼Œå½“ labelæœ‰è¶…è¿‡ container View å®¹é‡çš„æ–‡å­—æ˜¯ï¼Œlabelå¯ä»¥é€‚é…åˆ° è¿™ä¸ª width ä¸Šã€‚è¿™ä¸ª label å°†ä¼šè¿”å›ä¸€ä¸ªæ›´å¤§çš„<br>å›ºæœ‰ heightã€‚(å¦‚æœ label åªæœ‰å°‘é‡æ–‡å­—ï¼Œé‚£ä¹ˆlabel çš„å›ºæœ‰width å°±å›å°äº__preferredMaxLayoutWidth__)<br>iOS ä¸Šï¼ŒUILabel çš„ <strong>preferredMaxLayoutWidth__è¢«è®¾ç½®ä¸ºlabel çš„widthåœ¨ å®ƒæ˜¾ç¤ºåœ¨nib ä¸Šçš„æ—¶å€™ï¼ˆå³ä½¿åœ¨ runtime å®ƒçš„size æ”¹å˜ï¼‰<br>OS X ä¸Š,Â NSTextField å¯é€‰__preferredMaxLayoutWidth</strong>ï¼Œåœ¨å¸ƒå±€ä¹‹åã€‚<br>å¦‚æœ label çš„æœ‰æ•ˆç©ºé—´å¯ä»¥æ”¹å˜ï¼Œåƒæœ€ä¸Šé¢ video1é‡Œé¢çš„demoï¼Œæˆ–è€…å¦‚æœcontainer å¯ä»¥resized ï¼ˆæˆ–è€…rotatedï¼‰ï¼Œä½ å°±éœ€è¦åŠ¨æ€çš„æ”¹å˜ <strong>preferredMaxLayoutWidth</strong>ã€‚</p><h1 id="è°ƒæ•´-preferredmaxlayoutwidth"><a class="markdownIt-Anchor" href="#è°ƒæ•´-preferredmaxlayoutwidth"></a> è°ƒæ•´ <strong>preferredMaxLayoutWidth</strong></h1><p>ä¸ºäº†åŠ¨æ€çš„è®¾ç½®preferredMaxLayoutWidth, éœ€è¦é‡è½½ label çš„çˆ¶ç±»æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Â -[UIView layoutSubviews]</span><br><span class="line">Â -[NSView layout]</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å¾—åˆ°æœ€ä¸Šé¢video2çš„æ•ˆæœï¼Œè¦å°†__preferredMaxLayoutWidth__è®¾ç½®ä¸ºæœ‰æ•ˆçš„label<br>ä¾‹å­çš„å¸ƒå±€ï¼Œlabel è¦æœ‰è¿™å‡ ä¸ªé™åˆ¶:<br><img src="http://upload-images.jianshu.io/upload_images/4042439-28f753957e39d9b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="layout"><br>å›ºå®šå·¦å³é™åˆ¶ï¼Œä½¿labelå æ®æ•´ä¸ªæ°´å¹³ç©ºé—´ï¼Œ<br><em>ä»£ç é‡Œä¸è¦ä½¿ç”¨ æ•°å­— ç¡¬ç¼–ç ä½ çš„ constrain</em>. è¿™ä¼šæ˜¯ä½ çš„å¸ƒå±€ååˆ†è„†å¼±ã€‚å–è€Œä»£æ›¿çš„, å¯ä»¥åˆ©ç”¨å¸ƒå±€ç³»ç»Ÿæ¥è¾¾åˆ°æ•ˆæœï¼Œéœ€è¦åšä¸¤æ­¥ã€‚<br>ä¸Šé¢ video2é‡Œé¢ï¼Œåœ¨label ä¸­ ä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">  [<span class="keyword">super</span> layoutSubviews]; </span><br><span class="line">  <span class="built_in">CGFloat</span> availableLabelWidth = <span class="keyword">self</span>.label.frame.size.width; </span><br><span class="line">  <span class="keyword">self</span>.label.preferredMaxLayoutWidth = availableLabelWidth; </span><br><span class="line">  [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è°ƒç”¨Â [super layoutSubviews]ï¼Œå°†ä¼šè®¡ç®—labelä¸Šçš„ constraintsï¼ˆå› ä¸ºä»–æ˜¯ä¸€ä¸ªé—´æ¥çš„å­viewï¼‰ç›¸åº”çš„æ”¹å˜å®ƒçš„frameã€‚æ­¤æ—¶ width æ˜¯æœ‰ç”¨çš„ï¼Œä½†æ˜¯heightä¸æ˜¯ï¼›height ç”¨çš„æ˜¯label çš„å›ºæœ‰heightï¼Œå®ƒä¾èµ– ä»¥å‰ preferredMaxLayoutWidth çš„å€¼ã€‚<br>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† label çš„å®é™…widthï¼Œæˆ‘ä»¬è®¾ç½®å®ƒçš„æœ€å¤§å¸ƒå±€width. åœ¨å†…éƒ¨,åœ¨ä¸‹ä¸€æ¬¡æŸ¥è¯¢label çš„å›ºæœ‰å°ºå¯¸æ—¶ï¼Œ labelçš„å›ºæœ‰å°ºå¯¸æ˜¯æ— æ•ˆçš„ï¼Œè€Œå¯¹äºå½“å‰çš„ widthä¼šæœ‰ ç²¾ç¡®çš„ heightã€‚<br>æ‰€æœ‰å¸ƒå±€ä¿¡æ¯å°±ç»ª, å†æ¬¡è°ƒç”¨Â [super layoutSubviews]<br>again.</p><h1 id="åˆ›å»ºå±äºä½ è‡ªå·±çš„-åŒ…è£¹view"><a class="markdownIt-Anchor" href="#åˆ›å»ºå±äºä½ è‡ªå·±çš„-åŒ…è£¹view"></a> åˆ›å»ºå±äºä½ è‡ªå·±çš„ åŒ…è£¹view</h1><p><a href="https://github.com/jmah/WrapDemo" target="_blank" rel="noopener">WrapDemo</a><br>. è¿™ä¸ªä¾‹å­æœ‰ä¸€ä¸ªÂ preferredMaxLayoutWidth å±æ€§ that the superview sets, å’Œ ä¸€ä¸ªå…±äº«å¸ƒå±€æ–¹æ³• (-[MyWrappingView enumerateItemRectsForLayoutWidth:usingBlock:]<br>). è¿™ä¸ªæ–¹æ³•åœ¨Â -intrinsicContentSize ä¸­è°ƒç”¨â€“é€šè¿‡preferredMaxLayoutWidth è®¡ç®—åŸºæœ¬å°ºå¯¸ã€‚åœ¨ -layoutSubviews ä¸­è°ƒç”¨ï¼Œç®—å‡ºé‚£äº› æ‰¾è‰²çš„item çš„å®é™… size å’Œ ä½ç½®<br><a href="http://devetc.org/assets/2014-07-07-auto-layout-and-views-that-wrap/custom-wrapping-view.webm" target="_blank" rel="noopener">video3</a></p><h1 id="å‹ç¼©-åŒ…è£¹"><a class="markdownIt-Anchor" href="#å‹ç¼©-åŒ…è£¹"></a> å‹ç¼© åŒ…è£¹</h1><p>æœ€åï¼Œæœ‰å¾ˆå¤šæ¬¡æˆ‘ä»¬æƒ³æŠŠåŒ…è£¹view å’Œå†…å®¹æŠ±ç´§ contenthugging çš„æ–¹å¼ç»„åˆã€‚<br>å¯ä»¥æ·»åŠ çº¦æŸï¼Œä»¥ä½¿å®ƒä»¥ä¸­å¿ƒä¸ºä¸­å¿ƒï¼Œå¹¶<em>è‡³å°‘</em>æœ‰ä¸€äº›è·ç¦»ï¼Œè€Œä¸æ˜¯å›ºå®š label çš„leadingå’Œtrailingç©ºé—´ä½ç½®ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/4042439-3195a7f9882b084a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Label shrink-wrap constraints"><br>å°†å…¶ä¸ä¸Šé¢çš„- layoutsubviewsç»“åˆèµ·æ¥å®ç°æä¾›ä»¥ä¸‹è¡Œä¸º:<br><a href="http://devetc.org/assets/2014-07-07-auto-layout-and-views-that-wrap/shrink-wrap-buggy.webm" target="_blank" rel="noopener">video4</a></p><p>è¾¹ç¼˜çš„ç©ºé—´æ˜¯å……è¶³çš„ï¼Œå¦‚æœå®ƒå¤§äºæˆ–ç­‰äºå¸¸æ•°-å®ƒåªä¼šæŠŠæ ‡ç­¾æ¨è¿›å»ï¼Œå®ƒå°±ä¸ä¼šæŠŠå®ƒæ‹‰å‡ºæ¥ã€‚æˆ‘ä»¬æƒ³è¦åšçš„æ˜¯æ‰¾åˆ°æ ‡ç­¾å¯ä»¥å ç”¨çš„å®½åº¦ï¼Œè€Œä¸éœ€è¦å ç”¨æ‰€æœ‰çš„å®½åº¦ã€‚<br>è‡ªåŠ¨å¸ƒå±€APIåªæä¾›ä¸€ç§è®¡ç®—è·ç¦»çš„æ–¹æ³•:å¸ƒå±€ï¼Œç„¶åæµ‹é‡ã€‚å› æ­¤ï¼Œä¸ºäº†æ‰¾å‡ºæ ‡ç­¾çš„å®½åº¦ï¼Œæˆ‘ä»¬å‘Šè¯‰å®ƒè¦å˜å¾—éå¸¸å®½(ä»”ç»†é€‰æ‹©ä¼˜å…ˆçº§)ï¼ŒæŠŠå®ƒæ”¾åœ¨å¤–é¢ï¼Œæµ‹é‡å®ƒï¼Œç„¶åä½¿ç”¨ç»“æœä½œä¸ºé¦–é€‰çš„æœ€å¤§å¸ƒå±€å®½åº¦ã€‚è¯¥æ ‡ç­¾çš„å†…åœ¨å°ºå¯¸å°†å®Œæˆå…¶ä½™éƒ¨åˆ†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *labelAsWideAsPossibleConstraint =</span><br><span class="line">         [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:<span class="keyword">self</span>.label</span><br><span class="line">                                      attribute:<span class="built_in">NSLayoutAttributeWidth</span></span><br><span class="line">                                      relatedBy:<span class="built_in">NSLayoutRelationGreaterThanOrEqual</span></span><br><span class="line">                                         toItem:<span class="literal">nil</span></span><br><span class="line">                                      attribute:<span class="number">0</span></span><br><span class="line">                                     multiplier:<span class="number">1.0</span></span><br><span class="line">                                       constant:<span class="number">1e8</span>]; <span class="comment">// a big number</span></span><br><span class="line">    labelAsWideAsPossibleConstraint.priority =</span><br><span class="line">        [<span class="keyword">self</span>.label contentCompressionResistancePriorityForAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">    [<span class="keyword">self</span>.label addConstraint:labelAsWideAsPossibleConstraint];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGFloat</span> availableLabelWidth = <span class="keyword">self</span>.label.frame.size.width;</span><br><span class="line">    <span class="keyword">self</span>.label.preferredMaxLayoutWidth = availableLabelWidth;</span><br><span class="line">    [<span class="keyword">self</span>.label removeConstraint:labelAsWideAsPossibleConstraint];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰ä¾‹å­ä»£ç Â <a href="https://github.com/jmah/WrapDemo" target="_blank" rel="noopener">WrapDemo</a>Â project on GitHub.<br>æ„Ÿè°¢Kevin Catheyåœ¨å¸ƒå±€æ–¹é¢çš„å¸®åŠ©å’Œè§è§£ã€‚</p><p>æ€»ç»“ï¼šUILabel çš„ preferredMaxLayoutWidth<br>å½“åº”ç”¨å¸ƒå±€çº¦æŸæ—¶ï¼Œè¿™ä¸ªå±æ€§ä¼šå½±å“æ ‡ç­¾çš„å¤§å°ã€‚åœ¨å¸ƒå±€ä¸­ï¼Œå¦‚æœæ–‡æœ¬è¶…å‡ºäº†è¯¥å±æ€§æŒ‡å®šçš„å®½åº¦ï¼Œåˆ™é¢å¤–çš„æ–‡æœ¬å°†æµå‘ä¸€ä¸ªæˆ–å¤šä¸ªæ–°è¡Œï¼Œä»è€Œå¢åŠ æ ‡ç­¾çš„é«˜åº¦ã€‚</p><h1 id="å…¶ä»–å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å…¶ä»–å‚è€ƒæ–‡ç« "></a> å…¶ä»–å‚è€ƒæ–‡ç« </h1><p><a href="https://developer.apple.com/documentation/uikit/uilabel#//apple_ref/occ/instp/UILabel/preferredMaxLayoutWidth" target="_blank" rel="noopener">Apple: iOS UILabel</a><br><a href="https://stackoverflow.com/questions/12789013/ios-multi-line-uilabel-in-auto-layout" target="_blank" rel="noopener">iOS: Multi-line UILabel in Auto Layout</a><br><a href="https://www.objc.io/issues/3-views/advanced-auto-layout-toolbox/" target="_blank" rel="noopener">Advanced Auto Layout Toolbox</a></p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS ç¦»å±æ¸²æŸ“</title>
      <link href="/2017/09/20/UI%20%E7%9B%B8%E5%85%B3/iOS-%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93/"/>
      <url>/2017/09/20/UI%20%E7%9B%B8%E5%85%B3/iOS-%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>ä»€ä¹ˆæ˜¯ç¦»å±æ¸²æŸ“ï¼Ÿ<br>ä»–å¯¹æ€§èƒ½æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ<br>å¦‚ä½•é¿å…ç¦»å±æ¸²æŸ“ï¼Ÿ</p><h2 id="ios-æ¸²æŸ“"><a class="markdownIt-Anchor" href="#ios-æ¸²æŸ“"></a> iOS æ¸²æŸ“</h2><p>å¦‚æœæƒ³è¦äº†è§£ç¦»å±æ¸²æŸ“ï¼Œåº”è¯¥å…ˆçŸ¥é“iOSæ¸²æŸ“æ¡†æ¶æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><p><img src="/img/core-animation-pipline.jpg" alt="core animation pipeline"><br>è®©å±å¹•é¡µé¢æµç•…åº”è¯¥ä¿è¯é¡µé¢åˆ·æ–°ç‡ä¸º 60 å¸§/ç§’ï¼Œ1 å¸§çš„æ—¶é—´å¤§æ¦‚å°±æ˜¯ 16.67 msäº†ã€‚<br>iOS çš„æ¸²æŸ“æ¡†æ¶ï¼š Core Animation</p><ul><li>ç»„åˆå±å¹•ä¸Šçš„å†…å®¹ï¼Œè¿½è¸ªè§†å›¾ç»“æ„å’Œå†…å®¹çš„å˜åŒ–ã€‚</li><li>æµç¨‹å›¾ä¸­ Commit Transaction å‰é¢çš„çº¢æ¡†ä»£è¡¨è§¦å‘è§†å›¾å†…å®¹å˜åŒ–çš„äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»æŒ‰é’®</li><li>ä¹‹åCore Animation æ¡†æ¶ä¼šæ•è·åˆ°å±å¹•å†…å®¹çš„å˜åŒ–å¹¶æäº¤ç»™ Render Serverï¼ˆæ¸²æŸ“æœåŠ¡å™¨ï¼‰</li><li>Render Server é‡Œå¦å¤–ä¸€ä¸ªç‰ˆæœ¬çš„ Core Animation æ¡†æ¶è´Ÿè´£è§£ç å¹¶ç»˜åˆ¶å†…å®¹ã€‚</li><li>CPU è§£ç å®Œæˆåå°†æ•°æ®äº¤ç»™ GPU</li><li>GPU æ¸²æŸ“å®Œæˆåæ˜¾ç¤º</li></ul><p>ç¦»å±æ¸²æŸ“æ˜¯ä¸ºäº† ç¼“å­˜çš„<br>ç¦»å±æ¸²æŸ“ç©ºé—´åªæœ‰å±å¹•çš„ 2.5å€<br>100ms ä»¥åå¦‚æœç¼“å­˜æ²¡æœ‰ä½¿ç”¨å°±ä¼šè¢«é‡Šæ”¾æ‰</p><p>åœ†è§’å›¾ç‰‡</p><p>ç”±äºGPUçš„æµ®ç‚¹è¿ç®—èƒ½åŠ›æ¯”CPUå¼ºï¼ŒCPUæ¸²æŸ“çš„æ•ˆç‡å¯èƒ½ä¸å¦‚ç¦»å±æ¸²æŸ“ã€‚ä½†å¦‚æœä»…ä»…æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„æ•ˆæœï¼Œç›´æ¥ä½¿ç”¨ CPU æ¸²æŸ“çš„æ•ˆç‡åˆå¯èƒ½æ¯”ç¦»å±æ¸²æŸ“å¥½ï¼Œæ¯•ç«Ÿæ™®é€šçš„ç¦»å±æ¸²æŸ“è¦æ¶‰åŠåˆ°ç¼“å†²åŒºåˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰è€—æ—¶æ“ä½œã€‚å¯¹ä¸€äº›ç®€å•çš„ç»˜åˆ¶è¿‡ç¨‹æ¥è¯´ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰å¯èƒ½ç”¨CoreGraphicsï¼Œå…¨éƒ¨ç”¨CPUæ¥å®Œæˆåè€Œä¼šæ¯”GPUåšå¾—æ›´å¥½ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„ CPU æ¸²æŸ“çš„ä¾‹å­æ˜¯ï¼šé‡å†™ drawRect æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨ä»»ä½• Core Graphics çš„æŠ€æœ¯è¿›è¡Œäº†ç»˜åˆ¶æ“ä½œï¼Œå°±æ¶‰åŠåˆ°äº† CPU æ¸²æŸ“ã€‚æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹ç”± CPU åœ¨ App å†…åŒæ­¥åœ°å®Œæˆï¼Œæ¸²æŸ“å¾—åˆ°çš„bitmapæœ€åå†äº¤ç”±GPUç”¨äºæ˜¾ç¤ºã€‚æ€»ä¹‹ï¼Œå…·ä½“ä½¿ç”¨ CPU æ¸²æŸ“è¿˜æ˜¯ä½¿ç”¨ GPU ç¦»å±æ¸²æŸ“æ›´å¤šçš„æ—¶å€™éœ€è¦è¿›è¡Œæ€§èƒ½ä¸Šçš„å…·ä½“æ¯”è¾ƒæ‰å¯ä»¥ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–çš„ä¾‹å­å°±æ˜¯å¦‚ä½•ç»™ UIView/UIImageView åŠ åœ†è§’ã€‚</p><p>å¦‚ä¸‹æ˜¯ä¸‰ç§åŠ åœ†è§’çš„æ–¹å¼ï¼š</p><p>è®¾ç½® cornerRadius<br>UIBezierPath<br>Core Graphics(ä¸º UIView åŠ åœ†è§’)ä¸ç›´æ¥æˆªå–å›¾ç‰‡(ä¸º UIImageView åŠ åœ†è§’)<br>å¦‚ä¸‹æ˜¯è¿™ä¸‰ç§æ–¹æ³•çš„æ¯”è¾ƒï¼š</p><p><a href="https://hit-alibaba.github.io/interview/iOS/Cocoa-Touch/Performance.html" target="_blank" rel="noopener">â€”</a></p><p>Advanced Graphics and Animations for iOS Appsï¼ˆWWDC14 419)</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> UI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> æ€§èƒ½ </tag>
            
            <tag> UI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ä½¿ç”¨ RunLoop</title>
      <link href="/2017/08/30/runloop/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-RunLoop/"/>
      <url>/2017/08/30/runloop/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-RunLoop/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p><img src="/img/runLoop_class_struct.jpeg" alt="runloopç»“æ„"></p><p>æœ¬æ–‡ä¸»è¦ä»¥ç¿»è¯‘ä¸ºä¸»ï¼Œæœ‰ç¿»è¯‘orç†è§£é”™çš„åœ°æ–¹è¯·æå‡ºï¼Œ3Q</p><h2 id="ä½¿ç”¨-runloop-å¯¹è±¡"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-runloop-å¯¹è±¡"></a> ä½¿ç”¨ RunLoop å¯¹è±¡</h2><p>Apple æ¡†æ¶ä¸­æ˜¯å¦‚ä½•æè¿° RunLoop çš„:</p><table><thead><tr><th>æ¡†æ¶</th><th>RunLoop</th><th>çº¿ç¨‹å®‰å…¨</th></tr></thead><tbody><tr><td>Cocoa</td><td>NSRunLoop å®ä¾‹å¯¹è±¡</td><td>ä¸å®‰å…¨</td></tr><tr><td>Core Foundation</td><td>CFRunLoopRefæŒ‡é’ˆ</td><td>å®‰å…¨</td></tr></tbody></table><p>å¸¦ç€é—®é¢˜ï¼Ÿ</p><ol><li>runloop ä½¿ç”¨éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</li><li>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ runloop</li><li>ç³»ç»Ÿæ¡†æ¶å“ªäº›åœ°æ–¹ä½¿ç”¨äº† runloopï¼Ÿ</li><li>runloop è¿è¡Œæ—¶çš„å†…éƒ¨å®ä½“ç»“æ„åˆ†æï¼Ÿ</li></ol><h3 id="è·å¾—ä¸€ä¸ª-runloop-å¯¹è±¡"><a class="markdownIt-Anchor" href="#è·å¾—ä¸€ä¸ª-runloop-å¯¹è±¡"></a> è·å¾—ä¸€ä¸ª runloop å¯¹è±¡</h3><p>swift</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="type">RunLoop</span>.current</span><br><span class="line"><span class="keyword">var</span> b = <span class="type">CFRunLoopGetCurrent</span>()</span><br></pre></td></tr></table></figure><p>oc</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> a = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line"><span class="keyword">id</span> b = <span class="built_in">CFRunLoopGetCurrent</span>();</span><br></pre></td></tr></table></figure><details><summary>__CFRunLoop ç»“æ„ä½“</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">  CFRuntimeBase _base;</span><br><span class="line">  <span class="keyword">pthread_mutex_t</span> _lock;    <span class="comment">//* locked for accessing mode list */</span></span><br><span class="line">  __CFPort _wakeUpPort;     <span class="comment">// used for CFRunLoopWakeUp </span></span><br><span class="line">  Boolean _unused;</span><br><span class="line">  <span class="keyword">volatile</span> _per_run_data *_perRunData;<span class="comment">// reset for runs of the run loop</span></span><br><span class="line">  <span class="keyword">pthread_t</span> _pthread;</span><br><span class="line">  <span class="keyword">uint32_t</span> _winthread;</span><br><span class="line">  CFMutableSetRef _commonModes;     <span class="comment">// å½“å‰ runloop è¦ç›‘å¬çš„ mode</span></span><br><span class="line">  CFMutableSetRef _commonModeItems; <span class="comment">// æ‰€æœ‰æ¨¡å¼ä¸‹ è¦ç›‘å¬çš„ source0,source1,observer, timer</span></span><br><span class="line">  CFRunLoopModeRef _currentMode;</span><br><span class="line">  CFMutableSetRef _modes;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_head</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_tail</span>;</span></span><br><span class="line">  CFAbsoluteTime _runTime;</span><br><span class="line">  CFAbsoluteTime _sleepTime;</span><br><span class="line">  CFTypeRef _counterpart;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><details><summary>app è¿è¡Œæ—¶ CFRunLoop å†…éƒ¨æ ·å­ç®€ç‰ˆ</summary><pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoop</span> &#123;</span><br><span class="line">  current mode = kCFRunLoopDefaultMode</span><br><span class="line">  common modes = &#123;</span><br><span class="line">  <span class="built_in">UITrackingRunLoopMode</span></span><br><span class="line">  kCFRunLoopDefaultMode</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  common mode items = &#123;</span><br><span class="line">  <span class="comment">// source0 (manual)</span></span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</span><br><span class="line">    callout = _UIApplicationHandleEventQueue&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</span><br><span class="line">    callout = PurpleEventSignalCallback &#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;</span><br><span class="line">    callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// source1 (mach port)</span></span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">17923</span>&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">12039</span>&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">16647</span>&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order =<span class="number">-1</span>, &#123;</span><br><span class="line">    callout = PurpleEventCallback&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">2407</span>,</span><br><span class="line">    callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1</span>c03,</span><br><span class="line">    callout = __IOHIDEventSystemClientAvailabilityCallback&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1</span>b03,</span><br><span class="line">    callout = __IOHIDEventSystemClientQueueCallback&#125;&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">1</span>, &#123;port = <span class="number">1903</span>,</span><br><span class="line">    callout = __IOMIGMachPortPortCallback&#125;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Ovserver</span></span><br><span class="line">  <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">-2147483647</span>, activities = <span class="number">0x1</span>, <span class="comment">// Entry</span></span><br><span class="line">    callout = _wrapRunLoopWithAutoreleasePoolHandler&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">0</span>, activities = <span class="number">0x20</span>,    <span class="comment">// BeforeWaiting</span></span><br><span class="line">    callout = _UIGestureRecognizerUpdateObserver&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">1999000</span>, activities = <span class="number">0xa0</span>,  <span class="comment">// BeforeWaiting | Exit</span></span><br><span class="line">    callout = _afterCACommitHandler&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">2000000</span>, activities = <span class="number">0xa0</span>,  <span class="comment">// BeforeWaiting | Exit</span></span><br><span class="line">    callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;</span><br><span class="line">  <span class="built_in">CFRunLoopObserver</span> &#123;order = <span class="number">2147483647</span>, activities = <span class="number">0xa0</span>, <span class="comment">// BeforeWaiting | Exit</span></span><br><span class="line">    callout = _wrapRunLoopWithAutoreleasePoolHandler&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Timer</span></span><br><span class="line">  <span class="built_in">CFRunLoopTimer</span> &#123;firing = No, interval = <span class="number">3.1536e+09</span>, tolerance = <span class="number">0</span>,</span><br><span class="line">    next fire date = <span class="number">453098071</span> (<span class="number">-4421.76019</span> @ <span class="number">96223387169499</span>),</span><br><span class="line">    callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)&#125;</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  modes ï¼ &#123;</span><br><span class="line">  <span class="built_in">CFRunLoopMode</span>  &#123;</span><br><span class="line">    sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    timers =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">CFRunLoopMode</span>  &#123;</span><br><span class="line">    sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    timers =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">CFRunLoopMode</span>  &#123;</span><br><span class="line">    sources0 = &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">0</span>, &#123;</span><br><span class="line">      callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    sources1 = (null),</span><br><span class="line">    observers = &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopObserver</span> &gt;&#123;activities = <span class="number">0xa0</span>, order = <span class="number">2000000</span>,</span><br><span class="line">      callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;</span><br><span class="line">    )&#125;,</span><br><span class="line">    timers = (null),</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">CFRunLoopMode</span>  &#123;</span><br><span class="line">    sources0 = &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">-1</span>, &#123;</span><br><span class="line">      callout = PurpleEventSignalCallback&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    sources1 = &#123;</span><br><span class="line">    <span class="built_in">CFRunLoopSource</span> &#123;order = <span class="number">-1</span>, &#123;</span><br><span class="line">      callout = PurpleEventCallback&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    observers = (null),</span><br><span class="line">    timers = (null),</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">CFRunLoopMode</span>  &#123;</span><br><span class="line">    sources0 = (null),</span><br><span class="line">    sources1 = (null),</span><br><span class="line">    observers = (null),</span><br><span class="line">    timers = (null),</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode:</p><ol><li>kCFRunLoopDefaultMode: Appçš„é»˜è®¤ Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª Mode ä¸‹è¿è¡Œçš„ã€‚</li><li>UITrackingRunLoopMode: ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“ã€‚</li><li>UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚</li><li>GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°ã€‚</li><li>kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½çš„ Modeï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚<br></li></ol></pre></details><details><summary>app è¿è¡Œæ—¶ CFRunLoop å†…éƒ¨æ ·å­ï¼Œæ‰“å° runloop å¯¹è±¡</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line">&lt;CFRunLoop <span class="number">0x6000008b0000</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">  wakeup port = <span class="number">0x2703</span>, </span><br><span class="line">  stopped = <span class="literal">false</span>, </span><br><span class="line">  ignoreWakeUps = <span class="literal">true</span>, </span><br><span class="line">  current mode = (none),</span><br><span class="line">  common modes = &lt;CFBasicHash <span class="number">0x600003afbb70</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">  type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">  count = <span class="number">2</span>,</span><br><span class="line">  entries =&gt;</span><br><span class="line">  <span class="number">0</span> : &lt;CFString <span class="number">0x7fff86743f40</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    contents = <span class="string">"UITrackingRunLoopMode"</span>&#125;</span><br><span class="line">  <span class="number">2</span> : &lt;CFString <span class="number">0x7fff80628740</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    contents = <span class="string">"kCFRunLoopDefaultMode"</span>&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  common mode items = &lt;CFBasicHash <span class="number">0x600003aa7690</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">  type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">  count = <span class="number">13</span>,</span><br><span class="line">  entries =&gt;</span><br><span class="line">  <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001bc180</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">-1</span>, </span><br><span class="line">    context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">0</span>, </span><br><span class="line">      info = <span class="number">0x0</span>, </span><br><span class="line">      callout = PurpleEventSignalCallback (<span class="number">0x7fff384399f5</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">1</span> : &lt;CFRunLoopSource <span class="number">0x6000001b0240</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = Yes, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">0</span>, </span><br><span class="line">    context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">0</span>, </span><br><span class="line">      info = <span class="number">0x6000010b8e40</span>, </span><br><span class="line">      callout = FBSSerialQueueRunLoopSourceHandler (<span class="number">0x7fff365a092a</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">2</span> : &lt;CFRunLoopSource <span class="number">0x6000001b40c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">-1</span>, </span><br><span class="line">    context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">1</span>, </span><br><span class="line">      info = <span class="number">0x510b</span>, </span><br><span class="line">      callout = PurpleEventCallback (<span class="number">0x7fff38439a01</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">5</span> : &lt;CFRunLoopSource <span class="number">0x6000001b80c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">0</span>, </span><br><span class="line">    context = &lt;MSHRunLoopSource <span class="number">0x600003ae95f0</span>&gt; &#123;</span><br><span class="line">      port = <span class="number">430b</span>, callback = <span class="number">0x0</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="number">7</span> : &lt;CFRunLoopObserver <span class="number">0x6000005b0820</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    valid = Yes, </span><br><span class="line">    activities = <span class="number">0xa0</span>, </span><br><span class="line">    repeats = Yes, </span><br><span class="line">    order = <span class="number">2147483647</span>, </span><br><span class="line">    callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="number">0x7fff47848c8c</span>), </span><br><span class="line">    context = &lt;CFArray <span class="number">0x600003ae9bf0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      type = <span class="keyword">mutable</span>-small, </span><br><span class="line">      count = <span class="number">0</span>, </span><br><span class="line">      values = ()</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">8</span> : &lt;CFRunLoopObserver <span class="number">0x6000005b0780</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    valid = Yes, </span><br><span class="line">    activities = <span class="number">0x1</span>,</span><br><span class="line">    repeats = Yes, </span><br><span class="line">    order = <span class="number">-2147483647</span>, </span><br><span class="line">    callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="number">0x7fff47848c8c</span>), </span><br><span class="line">    context = &lt;CFArray <span class="number">0x600003ae9bf0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      type = <span class="keyword">mutable</span>-small,</span><br><span class="line">      count = <span class="number">0</span>,</span><br><span class="line">      values = ()</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">9</span> : &lt;CFRunLoopObserver <span class="number">0x6000005b06e0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    valid = Yes,</span><br><span class="line">    activities = <span class="number">0xa0</span>,</span><br><span class="line">    repeats = Yes,</span><br><span class="line">    order = <span class="number">2001000</span>,</span><br><span class="line">    callout = _afterCACommitHandler (<span class="number">0x7fff47879310</span>),</span><br><span class="line">    context = &lt;CFRunLoopObserver context <span class="number">0x7fc5adc01e40</span>&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">10</span> : &lt;CFRunLoopObserver <span class="number">0x6000005b0640</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    valid = Yes, </span><br><span class="line">    activities = <span class="number">0xa0</span>, </span><br><span class="line">    repeats = Yes, </span><br><span class="line">    order = <span class="number">1999000</span>, </span><br><span class="line">    callout = _beforeCACommitHandler (<span class="number">0x7fff478792a7</span>), </span><br><span class="line">    context = &lt;CFRunLoopObserver context <span class="number">0x7fc5adc01e40</span>&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="number">12</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8b40</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">-1</span>, </span><br><span class="line">    context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">0</span>, </span><br><span class="line">      info = <span class="number">0x6000001b0180</span>, </span><br><span class="line">      callout = __handleEventQueue (<span class="number">0x7fff478e3efb</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">16</span> : &lt;CFRunLoopSource <span class="number">0x6000001b89c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">0</span>, </span><br><span class="line">    context = &lt;MSHRunLoopSource <span class="number">0x600003ae9650</span>&gt; &#123;</span><br><span class="line">      port = <span class="number">3f</span>0b, </span><br><span class="line">      callback = <span class="number">0x0</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">18</span> : &lt;CFRunLoopObserver <span class="number">0x6000005b0140</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    valid = Yes, </span><br><span class="line">    activities = <span class="number">0x20</span>, </span><br><span class="line">    repeats = Yes, </span><br><span class="line">    order = <span class="number">0</span>, </span><br><span class="line">    callout = _UIGestureRecognizerUpdateObserver (<span class="number">0x7fff473eda72</span>), context = &lt;CFRunLoopObserver context <span class="number">0x600001fb5180</span>&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">21</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8a80</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">0</span>, </span><br><span class="line">    context = &lt;MSHRunLoopSource <span class="number">0x6000034a8160</span>&gt; &#123;</span><br><span class="line">      port = <span class="number">4207</span>, </span><br><span class="line">      callback = <span class="number">0x7fff2e3fdd33</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">22</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8cc0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    signalled = No, </span><br><span class="line">    valid = Yes, </span><br><span class="line">    order = <span class="number">-2</span>, </span><br><span class="line">    context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">0</span>, </span><br><span class="line">      info = <span class="number">0x600003a9fe70</span>, </span><br><span class="line">      callout = __handleHIDEventFetcherDrain (<span class="number">0x7fff478e3f07</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  modes = &lt;CFBasicHash <span class="number">0x600003afbba0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">    count = <span class="number">3</span>,</span><br><span class="line">    entries =&gt;</span><br><span class="line">    <span class="number">0</span> : &lt;CFRunLoopMode <span class="number">0x600000fb8270</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      name = UITrackingRunLoopMode, </span><br><span class="line">      port <span class="built_in">set</span> = <span class="number">0x2c03</span>, </span><br><span class="line">      <span class="built_in">queue</span> = <span class="number">0x600001ab9180</span>, </span><br><span class="line">      source = <span class="number">0x600001ab9200</span> (<span class="keyword">not</span> fired), </span><br><span class="line">      timer port = <span class="number">0x5303</span>, </span><br><span class="line">    sources0 = &lt;CFBasicHash <span class="number">0x600003aa76f0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">      count = <span class="number">4</span>,</span><br><span class="line">      entries =&gt;</span><br><span class="line">      <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001bc180</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">-1</span>, </span><br><span class="line">        context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">        version = <span class="number">0</span>, </span><br><span class="line">        info = <span class="number">0x0</span>, </span><br><span class="line">        callout = PurpleEventSignalCallback (<span class="number">0x7fff384399f5</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">1</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8b40</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">-1</span>, </span><br><span class="line">        context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">        version = <span class="number">0</span>, </span><br><span class="line">        info = <span class="number">0x6000001b0180</span>, </span><br><span class="line">        callout = __handleEventQueue (<span class="number">0x7fff478e3efb</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">2</span> : &lt;CFRunLoopSource <span class="number">0x6000001b0240</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = Yes, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">0</span>, </span><br><span class="line">        context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">        version = <span class="number">0</span>, </span><br><span class="line">        info = <span class="number">0x6000010b8e40</span>, </span><br><span class="line">        callout = FBSSerialQueueRunLoopSourceHandler (<span class="number">0x7fff365a092a</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">3</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8cc0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">-2</span>, </span><br><span class="line">        context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">        version = <span class="number">0</span>, </span><br><span class="line">        info = <span class="number">0x600003a9fe70</span>, </span><br><span class="line">        callout = __handleHIDEventFetcherDrain (<span class="number">0x7fff478e3f07</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    sources1 = &lt;CFBasicHash <span class="number">0x600003aa7720</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">      count = <span class="number">4</span>,</span><br><span class="line">      entries =&gt;</span><br><span class="line">      <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001b40c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">-1</span>, </span><br><span class="line">        context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">        version = <span class="number">1</span>, </span><br><span class="line">        info = <span class="number">0x510b</span>, </span><br><span class="line">        callout = PurpleEventCallback (<span class="number">0x7fff38439a01</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">4</span> : &lt;CFRunLoopSource <span class="number">0x6000001b89c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">0</span>, </span><br><span class="line">        context = &lt;MSHRunLoopSource <span class="number">0x600003ae9650</span>&gt; &#123;</span><br><span class="line">        port = <span class="number">3f</span>0b, </span><br><span class="line">        callback = <span class="number">0x0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">5</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8a80</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">0</span>, </span><br><span class="line">        context = &lt;MSHRunLoopSource <span class="number">0x6000034a8160</span>&gt; &#123;</span><br><span class="line">        port = <span class="number">4207</span>, </span><br><span class="line">        callback = <span class="number">0x7fff2e3fdd33</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">6</span> : &lt;CFRunLoopSource <span class="number">0x6000001b80c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">        signalled = No, </span><br><span class="line">        valid = Yes, </span><br><span class="line">        order = <span class="number">0</span>, </span><br><span class="line">        context = &lt;MSHRunLoopSource <span class="number">0x600003ae95f0</span>&gt; &#123;</span><br><span class="line">        port = <span class="number">430b</span>, </span><br><span class="line">        callback = <span class="number">0x0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125; ,</span><br><span class="line">    observers = (</span><br><span class="line">      <span class="string">"&lt;CFRunLoopObserver 0x6000005b0780 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">      valid = Yes, </span></span><br><span class="line"><span class="string">      activities = 0x1, </span></span><br><span class="line"><span class="string">      repeats = Yes, </span></span><br><span class="line"><span class="string">      order = -2147483647, </span></span><br><span class="line"><span class="string">      callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), </span></span><br><span class="line"><span class="string">      context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = ()</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      &#125;"</span>,</span><br><span class="line">      <span class="string">"&lt;CFRunLoopObserver 0x6000005b0140 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">      valid = Yes, </span></span><br><span class="line"><span class="string">      activities = 0x20, </span></span><br><span class="line"><span class="string">      repeats = Yes, </span></span><br><span class="line"><span class="string">      order = 0, </span></span><br><span class="line"><span class="string">      callout = _UIGestureRecognizerUpdateObserver (0x7fff473eda72), </span></span><br><span class="line"><span class="string">      context = &lt;CFRunLoopObserver context 0x600001fb5180&gt;</span></span><br><span class="line"><span class="string">      &#125;"</span>,</span><br><span class="line">      <span class="string">"&lt;CFRunLoopObserver 0x6000005b0640 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">      valid = Yes, </span></span><br><span class="line"><span class="string">      activities = 0xa0, </span></span><br><span class="line"><span class="string">      repeats = Yes, </span></span><br><span class="line"><span class="string">      order = 1999000, </span></span><br><span class="line"><span class="string">      callout = _beforeCACommitHandler (0x7fff478792a7), </span></span><br><span class="line"><span class="string">      context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;</span></span><br><span class="line"><span class="string">      &#125;"</span>,</span><br><span class="line">      <span class="string">"&lt;CFRunLoopObserver 0x6000005b06e0 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">      valid = Yes, </span></span><br><span class="line"><span class="string">      activities = 0xa0, </span></span><br><span class="line"><span class="string">      repeats = Yes, </span></span><br><span class="line"><span class="string">      order = 2001000, </span></span><br><span class="line"><span class="string">      callout = _afterCACommitHandler (0x7fff47879310), </span></span><br><span class="line"><span class="string">      context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;</span></span><br><span class="line"><span class="string">      &#125;"</span>,</span><br><span class="line">      <span class="string">"&lt;CFRunLoopObserver 0x6000005b0820 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">      valid = Yes, </span></span><br><span class="line"><span class="string">      activities = 0xa0, </span></span><br><span class="line"><span class="string">      repeats = Yes, </span></span><br><span class="line"><span class="string">      order = 2147483647, </span></span><br><span class="line"><span class="string">      callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), </span></span><br><span class="line"><span class="string">      context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">        type = mutable-small, </span></span><br><span class="line"><span class="string">        count = 0, </span></span><br><span class="line"><span class="string">        values = ()</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      &#125;"</span></span><br><span class="line">    ),</span><br><span class="line">    timers = (null),</span><br><span class="line">    currently <span class="number">600930818</span> (<span class="number">56642367633481</span>) / soft deadline in: <span class="number">1.84466874e+10</span> sec (@ <span class="number">-1</span>) / hard deadline in: <span class="number">1.84466874e+10</span> sec (@ <span class="number">-1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="number">1</span> : &lt;CFRunLoopMode <span class="number">0x600000fb8340</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    name = GSEventReceiveRunLoopMode, </span><br><span class="line">    port <span class="built_in">set</span> = <span class="number">0x5203</span>, </span><br><span class="line">    <span class="built_in">queue</span> = <span class="number">0x600001ab9280</span>, </span><br><span class="line">    source = <span class="number">0x600001ab9380</span> (<span class="keyword">not</span> fired), </span><br><span class="line">    timer port = <span class="number">0x2e03</span>, </span><br><span class="line">  sources0 = &lt;CFBasicHash <span class="number">0x600003aa77b0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">    count = <span class="number">1</span>,</span><br><span class="line">    entries =&gt;</span><br><span class="line">    <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001bc180</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      signalled = No, </span><br><span class="line">      valid = Yes, </span><br><span class="line">      order = <span class="number">-1</span>, </span><br><span class="line">      context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">0</span>, </span><br><span class="line">      info = <span class="number">0x0</span>, </span><br><span class="line">      callout = PurpleEventSignalCallback (<span class="number">0x7fff384399f5</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">sources1 = &lt;CFBasicHash <span class="number">0x600003aa77e0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">    count = <span class="number">1</span>,</span><br><span class="line">    entries =&gt;</span><br><span class="line">    <span class="number">2</span> : &lt;CFRunLoopSource <span class="number">0x6000001b4180</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">      signalled = No, </span><br><span class="line">      valid = Yes, </span><br><span class="line">      order = <span class="number">-1</span>, </span><br><span class="line">      context = &lt;CFRunLoopSource context&gt;&#123;</span><br><span class="line">      version = <span class="number">1</span>, </span><br><span class="line">      info = <span class="number">0x510b</span>, </span><br><span class="line">      callout = PurpleEventCallback (<span class="number">0x7fff38439a01</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  observers = (null),</span><br><span class="line">  timers = (null),</span><br><span class="line">  currently <span class="number">600930818</span> (<span class="number">56642369572615</span>) / soft deadline in: <span class="number">1.84466874e+10</span> sec (@ <span class="number">-1</span>) / hard deadline in: <span class="number">1.84466874e+10</span> sec (@ <span class="number">-1</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2</span> : &lt;CFRunLoopMode <span class="number">0x600000fb01a0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    name = kCFRunLoopDefaultMode, </span><br><span class="line">    port <span class="built_in">set</span> = <span class="number">0x2603</span>, </span><br><span class="line">    <span class="built_in">queue</span> = <span class="number">0x600001ab0880</span>, </span><br><span class="line">    source = <span class="number">0x600001ab0980</span> (<span class="keyword">not</span> fired), </span><br><span class="line">    timer port = <span class="number">0x1f03</span>, </span><br><span class="line">  sources0 = &lt;CFBasicHash <span class="number">0x600003aa7750</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">    count = <span class="number">4</span>,</span><br><span class="line">    entries =&gt;</span><br><span class="line">    <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001bc180</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">-1</span>, context = &lt;CFRunLoopSource context&gt;&#123;version = <span class="number">0</span>, info = <span class="number">0x0</span>, callout = PurpleEventSignalCallback (<span class="number">0x7fff384399f5</span>)&#125;&#125;</span><br><span class="line">    <span class="number">1</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8b40</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">-1</span>, context = &lt;CFRunLoopSource context&gt;&#123;version = <span class="number">0</span>, info = <span class="number">0x6000001b0180</span>, callout = __handleEventQueue (<span class="number">0x7fff478e3efb</span>)&#125;&#125;</span><br><span class="line">    <span class="number">2</span> : &lt;CFRunLoopSource <span class="number">0x6000001b0240</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = Yes, valid = Yes, order = <span class="number">0</span>, context = &lt;CFRunLoopSource context&gt;&#123;version = <span class="number">0</span>, info = <span class="number">0x6000010b8e40</span>, callout = FBSSerialQueueRunLoopSourceHandler (<span class="number">0x7fff365a092a</span>)&#125;&#125;</span><br><span class="line">    <span class="number">3</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8cc0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">-2</span>, context = &lt;CFRunLoopSource context&gt;&#123;version = <span class="number">0</span>, info = <span class="number">0x600003a9fe70</span>, callout = __handleHIDEventFetcherDrain (<span class="number">0x7fff478e3f07</span>)&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  sources1 = &lt;CFBasicHash <span class="number">0x600003aa7780</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span> <span class="built_in">set</span>, </span><br><span class="line">    count = <span class="number">4</span>,</span><br><span class="line">    entries =&gt;</span><br><span class="line">    <span class="number">0</span> : &lt;CFRunLoopSource <span class="number">0x6000001b40c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">-1</span>, context = &lt;CFRunLoopSource context&gt;&#123;version = <span class="number">1</span>, info = <span class="number">0x510b</span>, callout = PurpleEventCallback (<span class="number">0x7fff38439a01</span>)&#125;&#125;</span><br><span class="line">    <span class="number">4</span> : &lt;CFRunLoopSource <span class="number">0x6000001b89c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">0</span>, context = &lt;MSHRunLoopSource <span class="number">0x600003ae9650</span>&gt; &#123;port = <span class="number">3f</span>0b, callback = <span class="number">0x0</span>&#125;&#125;</span><br><span class="line">    <span class="number">5</span> : &lt;CFRunLoopSource <span class="number">0x6000001b8a80</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">0</span>, context = &lt;MSHRunLoopSource <span class="number">0x6000034a8160</span>&gt; &#123;port = <span class="number">4207</span>, callback = <span class="number">0x7fff2e3fdd33</span>&#125;&#125;</span><br><span class="line">    <span class="number">6</span> : &lt;CFRunLoopSource <span class="number">0x6000001b80c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;signalled = No, valid = Yes, order = <span class="number">0</span>, context = &lt;MSHRunLoopSource <span class="number">0x600003ae95f0</span>&gt; &#123;port = <span class="number">430b</span>, callback = <span class="number">0x0</span>&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  observers = (</span><br><span class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000005b0780 [0x7fff80615350]&gt;&#123;</span></span><br><span class="line"><span class="string">    valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;&#125;"</span>,</span><br><span class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000005b0140 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x7fff473eda72), context = &lt;CFRunLoopObserver context 0x600001fb5180&gt;&#125;"</span>,</span><br><span class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000005b0640 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x7fff478792a7), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;&#125;"</span>,</span><br><span class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000005b06e0 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x7fff47879310), context = &lt;CFRunLoopObserver context 0x7fc5adc01e40&gt;&#125;"</span>,</span><br><span class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000005b0820 [0x7fff80615350]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff47848c8c), context = &lt;CFArray 0x600003ae9bf0 [0x7fff80615350]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;&#125;"</span></span><br><span class="line">    ),</span><br><span class="line">  timers = &lt;CFArray <span class="number">0x6000010b6400</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;</span><br><span class="line">    type = <span class="keyword">mutable</span>-small, count = <span class="number">1</span>, values = (</span><br><span class="line">    <span class="number">0</span> : &lt;CFRunLoopTimer <span class="number">0x6000001b86c0</span> [<span class="number">0x7fff80615350</span>]&gt;&#123;valid = Yes, firing = No, interval = <span class="number">0</span>, tolerance = <span class="number">0</span>, next fire date = <span class="number">600930808</span> (<span class="number">-10.16959</span> @ <span class="number">56632202715119</span>), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (<span class="number">0x7fff2574c7d2</span> / <span class="number">0x7fff46da0bb6</span>) (/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore), context = &lt;CFRunLoopTimer context <span class="number">0x6000021ef300</span>&gt;&#125;</span><br><span class="line">    )</span><br><span class="line">    &#125;,</span><br><span class="line">  currently <span class="number">600930818</span> (<span class="number">56642369637217</span>) / soft deadline in: <span class="number">1.84467441e+10</span> sec (@ <span class="number">56632202715119</span>) / hard deadline in: <span class="number">1.84467441e+10</span> sec (@ <span class="number">56632202715119</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>NSRunLoop æ˜¯å¯¹CFRunLoopRefæŒ‡é’ˆçš„å°è£…ï¼Œè™½ç„¶ä¸¤è€…ä¹‹é—´ç±»å‹è½¬æ¢ä¸æ¶ˆè€—æ€§èƒ½ï¼Œä½†æ˜¯NSRunLoop class å®šä¹‰ä¸€ä¸ªå¾—åˆ° CFRunLoopRef çš„æ–¹æ³• <code>getCFRunLoop</code></p><h3 id="é…ç½®-runloop"><a class="markdownIt-Anchor" href="#é…ç½®-runloop"></a> é…ç½® RunLoop</h3><p>åœ¨å­çº¿ç¨‹ä¸Šè¿è¡Œ RunLoopï¼Œä½ ä¸€å®šè¦å‘ runloop ä¸­è‡³å°‘æ·»åŠ ä¸€ä¸ª input source æˆ–è€… timerï¼Œå¦‚æœ runloop ä¸­æ²¡æœ‰å¯ç›‘å¬çš„ sourcesï¼Œé‚£ä¹ˆåœ¨ runloop è¿è¡Œçš„æ—¶å€™ä»–å°±ä¼šç«‹åˆ»é€€å‡ºã€‚è¯¦æƒ…çœ‹ä¸‹æ–‡ <a href="#2">é…ç½® RunLoop äº‹ä»¶æº(sources)</a></p><p>é™¤äº†æ·»åŠ äº‹ä»¶æº sourcesï¼Œä½ å¯èƒ½è¿˜è¦ç»™ runloop æ·»åŠ  observersï¼ˆä½¿ç”¨å®ƒæ¥ç›‘å¬å½“å‰ runloop çš„æ‰§è¡Œé˜¶æ®µï¼‰ã€‚</p><details><summary>åˆ›å»º run loop observer</summary><pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)threadMain&#123;</span><br><span class="line">  <span class="comment">// The application uses garbage collection, so no autorelease pool is needed.</span></span><br><span class="line">  <span class="built_in">NSRunLoop</span>* myRunLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Create a run loop observer and attach it to the run loop.</span></span><br><span class="line">  <span class="built_in">CFRunLoopObserverContext</span> context = &#123;<span class="number">0</span>, <span class="keyword">self</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">  <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreate</span>(</span><br><span class="line">  kCFAllocatorDefault,</span><br><span class="line">  kCFRunLoopAllActivities, </span><br><span class="line">  <span class="literal">YES</span>,</span><br><span class="line">  <span class="number">0</span>, </span><br><span class="line">  &amp;myRunLoopObserver, </span><br><span class="line">  &amp;context);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (observer)&#123;</span><br><span class="line">  <span class="built_in">CFRunLoopRef</span> cfLoop = [myRunLoop getCFRunLoop];</span><br><span class="line">  <span class="built_in">CFRunLoopAddObserver</span>(cfLoop, observer, kCFRunLoopDefaultMode);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Create and schedule the timer.</span></span><br><span class="line">  [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">0.1</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doFireTimer:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">NSInteger</span> loopCount = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">do</span>&#123;</span><br><span class="line">  <span class="comment">// Run the run loop 10 times to let the timer fire.</span></span><br><span class="line">  [myRunLoop runUntilDate:[<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="number">1</span>]];</span><br><span class="line">  loopCount--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (loopCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>ç»™ thread é…ç½® runloop è®©å¤„äºä¿æ´»çŠ¶æ€ï¼Œç»™runloop æ·»åŠ ä¸€ä¸ª input sourcesæ¥æ¥å—æ¶ˆæ¯ä¼šæ¯”è¾ƒå¥½ã€‚è™½ç„¶åªæœ‰ä¸€ä¸ª timer sources ä¹Ÿå¯ä»¥è¿›å…¥ runloopï¼Œä½†æ˜¯ä¸€æ—¦ timer firesï¼Œtimer å°±ä¼šå¤±æ•ˆï¼Œå¯¼è‡´ runloop é€€å‡ºã€‚æ·»åŠ ä¸€ä¸ª repeating timer å¯ä»¥è®© runloop ä¿æ´»ï¼Œå¯æ˜¯åå¤è°ƒç”¨ timer fireï¼Œä¼šåå¤å”¤é†’thread(è¿™å®é™…ä¸Šæ˜¯è½®è¯¢çš„å¦ä¸€ç§å½¢å¼)ï¼Œç›¸å¯¹æ¥è¯´ï¼Œä½¿ç”¨ input source æ¥ç­‰å¾… event å‘ç”Ÿï¼Œæ²¡å‘ç”Ÿå‰thread éƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚</p><h3 id="å¼€å¯-runloop"><a class="markdownIt-Anchor" href="#å¼€å¯-runloop"></a> å¼€å¯ RunLoop</h3><ul><li>åªæœ‰å­çº¿ç¨‹æ‰éœ€è¦å¼€å¯ RunLoop</li><li>ä¸€ä¸ª RunLoop å®ä¾‹è‡³å°‘æœ‰ä¸€ä¸ª input source or timer æ¥ç›‘å¬äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰å¯ç›‘å¬çš„sourcesï¼ŒRunLoopå¼€å¯åä¼šç«‹å³é€€å‡ºã€‚</li></ul><p>å¯åŠ¨ RunLoop çš„æ–¹æ³•ï¼š</p><table><thead><tr><th>æ–¹å¼</th><th>æ–¹æ³•å(NSRunLoop)</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>æ— æ¡ä»¶</td><td>run</td><td>æœ€ç®€å•ä½†ä¹Ÿ<code>æœ€ä¸å¯å–çš„æ–¹æ¡ˆ</code>ã€‚ä¼šè®©çº¿ç¨‹è¿›å…¥æ— é™å¾ªç¯ï¼Œå¯¹ run loop å¾ˆéš¾æ§åˆ¶ã€‚å¯ä»¥æ·»åŠ å’Œç§»é™¤ input source å’Œ timerï¼Œä½†åªèƒ½é€šè¿‡ kill çš„æ–¹å¼åœæ­¢ run loopã€‚æ— æ³•åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹è¿è¡Œ runloopã€‚</td></tr><tr><td>è®¾å®šæ—¶é—´é™åˆ¶</td><td>runUntilDate:</td><td>run loop åœ¨æ”¶åˆ°äº‹ä»¶æˆ–è¶…æ—¶å‰ä¼šä¸€ç›´è¿è¡Œã€‚run loop ç»“æŸåå¯ä»¥é‡å¯ï¼Œå¹¶å¤„ç†æ¥ä¸‹æ¥çš„äº‹æƒ…ã€‚æ¯”ä¸Šä¸€ç§æ–¹å¼æ›´å¥½ï¼Œæä¾›äº†æ—¶é—´é™åˆ¶ã€‚</td></tr><tr><td>å¤„äºç‰¹å®šæ¨¡å¼</td><td>runMode:beforeDate:</td><td>ç›¸æ¯”ä¸Šä¸€ç§æ–¹å¼ï¼Œå¢åŠ äº†åœ¨ç‰¹å®šæ¨¡å¼ä¸‹è¿è¡Œ run loop</td></tr></tbody></table><details><summary>Running a run loop</summary><pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)skeletonThreadMain &#123;</span><br><span class="line">  <span class="comment">// Set up an autorelease pool here if not using garbage collection.</span></span><br><span class="line">  <span class="built_in">BOOL</span> done = <span class="literal">NO</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Add your sources or timers to the run loop and do any other setup.</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">do</span>&#123;</span><br><span class="line">    <span class="comment">// Start the run loop but return after each source is handled.</span></span><br><span class="line">    SInt32 result = <span class="built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="number">10</span>, <span class="literal">YES</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// If a source explicitly stopped the run loop, or if there are no</span></span><br><span class="line">    <span class="comment">// sources or timers, go ahead and exit.</span></span><br><span class="line">    <span class="keyword">if</span> ((result == kCFRunLoopRunStopped) || (result == kCFRunLoopRunFinished))</span><br><span class="line">    done = <span class="literal">YES</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Check for any other exit conditions here and set the</span></span><br><span class="line">    <span class="comment">// done variable as needed.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (!done);</span><br><span class="line">  <span class="comment">// Clean up code here. Be sure to release any allocated autorelease pools.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>å¯ä»¥é€’å½’å¯åŠ¨ run loopã€‚ä¹Ÿå°±æ˜¯è¯´å¯ä»¥åœ¨ input source æˆ– timer çš„å›è°ƒå¤„ç†å‡½æ•°ä¸­è°ƒç”¨ CFRunLoopRun, CFRunLoopRunInMode æˆ–ä¸Šé¢æåˆ°çš„ NSRunLoop çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œè€Œä¸”åµŒå¥—çš„ run loop å¯ä»¥åœ¨ä»»æ„ Mode ä¸‹è¿è¡Œã€‚</p><h3 id="é€€å‡º-runloop"><a class="markdownIt-Anchor" href="#é€€å‡º-runloop"></a> é€€å‡º RunLoop</h3><p>åœ¨å¤„ç†äº‹ä»¶ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®© RunLoopé€€å‡ºï¼š</p><ul><li>ç»™ run loop é…ç½® timeout å€¼</li><li>å‘Šè¯‰ run loop åœæ­¢</li></ul><p>ä½¿ç”¨timeoutçš„æ–¹å¼ï¼šRunLoop é€€å‡ºä¹‹å‰ä¼šæ‰§è¡Œå®Œæ‰€æœ‰æ­£å¸¸æƒ…å†µä¸‹çš„å¤„ç†ï¼ŒåŒ…æ‹¬å‘ observers å‘é€é€šçŸ¥ã€‚</p><p>ä½¿ç”¨ CFRunLoopStop()ï¼šå’Œ timeoutæ–¹å¼ç›¸ä¼¼ã€‚RunLoop ä¼šæŠŠå‰©ä¸‹çš„æ‰€æœ‰çŠ¶æ€å‘é€ç»™ observersï¼Œç„¶åé€€å‡ºã€‚ä¸åŒçš„æ˜¯ï¼šä½ åªèƒ½ä½¿ç”¨ CFRunLoopStop åœæ­¢ä»¥ Unconditionally æ–¹å¼å¼€å¯çš„ RunLoopã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ CFRunLoopStop åªä¼šåœæ­¢å¯¹ CFRunLoopRun å’Œ CFRunLoopRunInMode çš„è°ƒç”¨ã€‚å¯¹äº Cocoa æ¡†æ¶ç›¸å½“äºåªåœæ­¢ä¸€æ¬¡ runMode:beforeDate: çš„è°ƒç”¨ï¼Œè€Œä¸æ˜¯é€€å‡º run loopã€‚stop ä¸€æ¬¡è¿è¡Œå’Œ exit æ•´ä¸ª run loop æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>è™½ç„¶ç§»é™¤ RunLoop çš„ input source å’Œ timer ä¹Ÿä¼šå¯¼è‡´å…¶é€€å‡ºï¼Œä½†è¿™ç§æ–¹æ³•ä¸å¯é ã€‚å› ä¸ºæœ‰äº›ç³»ç»Ÿç¨‹åºä¼šå‘ RunLoop ä¸­æ·»åŠ  input sourceï¼Œå¼€å‘è€…æ ¹æœ¬ä¸çŸ¥é“æœ‰è¿™å›äº‹ï¼Œç§»é™¤çš„æ—¶å€™å°±ä¼šæ¼æ‰ï¼Œè‡ªç„¶å°±ä¸ä¼šå¯¼è‡´ RunLoop é€€å‡ºã€‚</p><h2 id="é…ç½®-runloop-äº‹ä»¶æºsources"><a class="markdownIt-Anchor" href="#é…ç½®-runloop-äº‹ä»¶æºsources"></a> é…ç½® RunLoop äº‹ä»¶æº(sources)</h2><h3 id="å®šä¹‰-custom-input-source"><a class="markdownIt-Anchor" href="#å®šä¹‰-custom-input-source"></a> å®šä¹‰ Custom Input Source</h3><p>åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æºæ¶‰åŠå®šä¹‰ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>ä½ æƒ³è®© input source å¤„ç†çš„ä¿¡æ¯</li><li>A scheduler routineï¼šç”¨äºè®©å¤–éƒ¨ client è·çŸ¥å¦‚ä½•è”ç³» input source</li><li>A handler routineï¼šæ‰§è¡Œä»»ä½• client å‘å‡ºè¯·æ±‚çš„</li><li>A cancellation routineï¼šä½¿ input source å¤±æ•ˆ</li></ul><p>å› ä¸ºä½ ä½¿ç”¨ custom input source æ¥å¤„ç† custom informationï¼Œé…ç½®çš„è¿‡ç¨‹ä¼šç›¸å½“çµæ´»ã€‚The scheduler, handler, and cancellation routinesï¼Œæ˜¯ä½ åˆ›å»º custome input source çš„å…³é”®ã€‚ä½†æ˜¯ï¼Œinput source å‰©ä¸‹çš„å¤§éƒ¨åˆ†è¡Œä¸ºéƒ½æ²¡æœ‰åœ¨è¿™å‡ ä¸ªå†ç¨‹ä¸­ï¼Œegï¼š</p><ul><li>å‘ input source ä¼ é€’æ•°æ®çš„æ–¹å¼éœ€è¦ä½ è‡ªå·±å®ç°</li><li>è®©å…¶ä»–çº¿ç¨‹çŸ¥é“è¿™ä¸ª input source çš„å­˜åœ¨</li></ul><p>ä¸‹å›¾ç»™å‡ºäº†ä¸€ä¸ª custom input source é…ç½® demoã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<br>app çš„ä¸»çº¿ç¨‹ç»´æŠ¤ ï¼š</p><ul><li>å¼•ç”¨ input source</li><li>å¼•ç”¨ input source è‡ªå®šä¹‰çš„ command buffer</li><li>å¼•ç”¨ runloop[å·²ç»æŠŠinput source åŠ åˆ°é‡Œé¢äº†]</li></ul><p>å½“ main thread æœ‰ä¸€ä¸ªtaskæƒ³è¦ worker thread å¤„ç†ï¼Œmain thread ä¼špost ä¸€ä¸ª command åˆ° command buffer ä¸­ï¼Œé¡ºå¸¦æŠŠ worker thread éœ€è¦çš„ä¿¡æ¯å‘ç»™å®ƒï¼Œç„¶å main thread å¼€å¯ taskï¼ˆå› ä¸ºmain thread å’Œ worker thread éƒ½æœ‰å¯ä»¥è®¿é—® command bufferï¼Œæ‰€ä»¥è®¿é—® command buffer çš„è¿‡ç¨‹è¦ syncï¼‰ã€‚ä¸€æ—¦å‘½ä»¤å‘å¸ƒï¼Œmain thread å‘ input source å‘é€æ¶ˆæ¯ï¼Œå”¤èµ· worker thread çš„runloopã€‚worker thread çš„ runloop ä¸€æ—¦æ¥å—åˆ°å”¤èµ·å‘½ä»¤ï¼Œä»–å°±ä¼šè°ƒç”¨ input source çš„ handler ç¨‹åºï¼Œhandler ä¼šå¤„ç† command buffer ä¸­çš„å‘½ä»¤ã€‚</p><p>æ“ä½œ custom input source<br><img src="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/Art/custominputsource.jpg" alt=" Operating a custom input source"></p><h4 id="å®šä¹‰-input-source"><a class="markdownIt-Anchor" href="#å®šä¹‰-input-source"></a> å®šä¹‰ Input Source</h4><p>å®šä¹‰ custome input source éœ€è¦ Core Foundationï¼Œæ¥å£éƒ½æ˜¯åŸºäº C çš„ï¼</p><p>ä¸‹é¢ä»£ç å°è£…æˆ OCï¼šRunLoopSource å°è£…äº† CFRunLoopSourceRefï¼Œå¹¶ç®¡ç†ä¸€ä¸ª command bufferï¼Œå¹¶ä½¿ç”¨ buffer æ¥æ”¶å…¶ä»–çº¿ç¨‹çš„æ¶ˆæ¯ã€‚RunLoopContext å°è£…äº† CFRunLoopRef å’Œ RunLoopSource æŒ‡é’ˆï¼Œç”¨äºå‘åº”ç”¨ä¸»çº¿ç¨‹ä¼ é€’ source å¯¹è±¡å’Œ run loop å¼•ç”¨ã€‚</p><details><summary>Custom Input Source å¯¹è±¡å®šä¹‰</summary><pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These are the CFRunLoopSourceRef callback functions.</span></span><br><span class="line"><span class="keyword">void</span> RunLoopSourceScheduleRoutine (<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFStringRef</span> mode);</span><br><span class="line"><span class="keyword">void</span> RunLoopSourcePerformRoutine (<span class="keyword">void</span> *info);</span><br><span class="line"><span class="keyword">void</span> RunLoopSourceCancelRoutine (<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFStringRef</span> mode);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RunLoopSource</span> : <span class="title">NSObject</span></span>&#123;</span><br><span class="line">  <span class="built_in">CFRunLoopSourceRef</span> runLoopSource;</span><br><span class="line">  <span class="built_in">NSMutableArray</span>* commands;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">id</span>)init;</span><br><span class="line">- (<span class="keyword">void</span>)addToCurrentRunLoop;</span><br><span class="line">- (<span class="keyword">void</span>)invalidate;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Handler method</span></span><br><span class="line">- (<span class="keyword">void</span>)sourceFired;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Client interface for registering commands to process</span></span><br><span class="line">- (<span class="keyword">void</span>)addCommand:(<span class="built_in">NSInteger</span>)command withData:(<span class="keyword">id</span>)data;</span><br><span class="line">- (<span class="keyword">void</span>)fireAllCommandsOnRunLoop:(<span class="built_in">CFRunLoopRef</span>)runloop;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// RunLoopContext is a container object used during registration of the input source.</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RunLoopContext</span> : <span class="title">NSObject</span></span>&#123;</span><br><span class="line">  <span class="built_in">CFRunLoopRef</span>  runLoop;</span><br><span class="line">  RunLoopSource*  source;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">CFRunLoopRef</span> runLoop;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) RunLoopSource* source;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">id</span>)initWithSource:(RunLoopSource*)src andLoop:(<span class="built_in">CFRunLoopRef</span>)loop;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></pre></details><p>è™½ç„¶ Objective-C ä»£ç ç®¡ç† input source çš„è‡ªå®šä¹‰æ•°æ®ï¼Œä½†æ˜¯æŠŠ input source æ·»åŠ åˆ° runloop ä¸­éœ€è¦åŸºäº c çš„æ–¹æ³•ã€‚ ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ä¾‹ç¨‹æ˜¯ schedulerï¼Œå½“ä½ æŠŠ source æ·»åŠ åˆ° runloop æ—¶å°±ä¼šè°ƒç”¨ã€‚ input source åªæœ‰ä¸€ä¸ª clientï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹ã€‚è¿™é‡Œ scheduler åšçš„äº‹æƒ…å°±æ˜¯ç”¨ application delegate çš„ registerSource: æ–¹æ³•å°† RunLoopContext å¯¹è±¡ä¸­çš„ä¿¡æ¯ä¼ é€’è¿‡å»ï¼Œä»¥ä¾¿ä¹‹å application delegate ä¸ input source é€šä¿¡æ—¶ä½¿ç”¨ã€‚</p><p><span id="4">Scheduling a run loop source</span></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RunLoopSourceScheduleRoutine (<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFStringRef</span> mode)&#123;</span><br><span class="line">  RunLoopSource* obj = (RunLoopSource*)info;</span><br><span class="line">  AppDelegate*   del = [AppDelegate sharedAppDelegate];</span><br><span class="line">  RunLoopContext* theContext = [[RunLoopContext alloc] initWithSource:obj andLoop:rl];</span><br><span class="line"> </span><br><span class="line">  [del performSelectorOnMainThread:<span class="keyword">@selector</span>(registerSource:)</span><br><span class="line">        withObject:theContext waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å‘ input source å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œç”¨äºå¤„ç†æ•°æ®çš„ perform å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒæ˜¯æœ€é‡è¦çš„å›è°ƒä¹‹ä¸€ã€‚ä¸‹é¢çš„è¿™ä¸ªæ–¹æ³•åªæ˜¯æŠŠè¯·æ±‚è½¬å‘ç»™äº† RunLoopSource çš„ sourceFired æ–¹æ³•ã€‚åé¢ä¼šåˆ—å‡º sourceFired å¤„ç† command buffer çš„é€»è¾‘ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Performing work in the input source</span></span><br><span class="line"><span class="keyword">void</span> RunLoopSourcePerformRoutine (<span class="keyword">void</span> *info)&#123;</span><br><span class="line">  RunLoopSource*  obj = (__bridge RunLoopSource*)info;</span><br><span class="line">  [obj sourceFired];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä»¥å‰ä½¿ç”¨ CFRunLoopSourceInvalidate() æ–¹æ³•æŠŠ input source ä»runloopä¸­ç§»é™¤ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ input source çš„ cancellation routine. ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ª routine é€šçŸ¥ clientsï¼Œä½ çš„input source å¤±æ•ˆï¼Œéœ€è¦ç§»é™¤ä»–ä»¬å¯¹ input source çš„å¼•ç”¨ã€‚ä¸‹é¢çš„ cancellation routine ä½“ç”¨ç³»ç»Ÿä¼ å…¥çš„ RunLoopSourceï¼Œrunloopï¼ŒrunloopMode åˆ›å»ºä¸€ä¸ªæ–°çš„ RunLoopContextï¼Œå¹¶ä¼ ç»™ application delegateã€‚</p><p><span id="5">Invalidating a run loop source:</span></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RunLoopSourceCancelRoutine (<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFStringRef</span> mode)&#123;</span><br><span class="line">  RunLoopSource* obj = (__bridge RunLoopSource*)info;</span><br><span class="line">  AppDelegate* del = [AppDelegate sharedAppDelegate];</span><br><span class="line">  RunLoopContext* theContext = [[RunLoopContext alloc] initWithSource:obj andLoop:rl];</span><br><span class="line"> </span><br><span class="line">  [del performSelectorOnMainThread:<span class="keyword">@selector</span>(removeSource:)</span><br><span class="line">        withObject:theContext waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ application delegateâ€™s çš„ registerSource: and removeSource: æ–¹æ³•åœ¨<a href="#3">ä¸‹é¢</a>æœ‰</p><h4 id="æŠŠ-input-source-æ·»åŠ åˆ°-run-loop"><a class="markdownIt-Anchor" href="#æŠŠ-input-source-æ·»åŠ åˆ°-run-loop"></a> æŠŠ Input Source æ·»åŠ åˆ° Run Loop</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)init&#123;</span><br><span class="line">  <span class="built_in">CFRunLoopSourceContext</span> context = &#123;<span class="number">0</span>, <span class="keyword">self</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">          &amp;RunLoopSourceScheduleRoutine,</span><br><span class="line">          RunLoopSourceCancelRoutine,</span><br><span class="line">          RunLoopSourcePerformRoutine&#125;;</span><br><span class="line"> </span><br><span class="line">  _runLoopSource = <span class="built_in">CFRunLoopSourceCreate</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;context);</span><br><span class="line">  commands = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addToCurrentRunLoop&#123;</span><br><span class="line">  <span class="built_in">CFRunLoopRef</span> runLoop = <span class="built_in">CFRunLoopGetCurrent</span>();</span><br><span class="line">  <span class="built_in">CFRunLoopAddSource</span>(runLoop, _runLoopSource, kCFRunLoopDefaultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ worker çº¿ç¨‹è°ƒç”¨ addToCurrentRunLoop æ–¹æ³•æ—¶ï¼Œæ‰ä¼šå°† input source æ”¾åˆ° runloop ä¸­ï¼Œå¹¶åœ¨æ­¤æ—¶è°ƒç”¨ RunLoopSourceScheduleRoutine ã€‚input source åŠ åˆ° runloop ä¹‹åï¼Œthread å°±å¯ä»¥è·‘èµ·ä»–çš„ runloop ï¼Œç­‰å¾…ä»–æ´¾å‘ task ã€‚</p><ul><li>CFRunLoopSourceContext ç»“æ„ä½“æè¿°äº† custom input sourceï¼ˆsource0ï¼‰çš„ä¸Šä¸‹æ–‡</li><li>CFRunLoopSourceContext1 ç»“æ„ä½“æè¿°äº† port-based input sourceï¼ˆsource1ï¼‰çš„ä¸Šä¸‹æ–‡</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="built_in">CFIndex</span>version;</span><br><span class="line">  <span class="keyword">void</span> *info;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *(*<span class="keyword">retain</span>)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  <span class="keyword">void</span>(*release)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  <span class="built_in">CFStringRef</span>(*copyDescription)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  Boolean(*equal)(<span class="keyword">const</span> <span class="keyword">void</span> *info1, <span class="keyword">const</span> <span class="keyword">void</span> *info2);</span><br><span class="line">  <span class="built_in">CFHashCode</span>(*hash)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span>(*schedule)(<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopMode</span> mode);</span><br><span class="line">  <span class="keyword">void</span>(*cancel)(<span class="keyword">void</span> *info, <span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopMode</span> mode);</span><br><span class="line">  <span class="keyword">void</span>(*perform)(<span class="keyword">void</span> *info);</span><br><span class="line"></span><br><span class="line">&#125; <span class="built_in">CFRunLoopSourceContext</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="built_in">CFIndex</span>version;</span><br><span class="line">  <span class="keyword">void</span> *info;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *(*<span class="keyword">retain</span>)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  <span class="keyword">void</span>(*release)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  <span class="built_in">CFStringRef</span>(*copyDescription)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">  Boolean(*equal)(<span class="keyword">const</span> <span class="keyword">void</span> *info1, <span class="keyword">const</span> <span class="keyword">void</span> *info2);</span><br><span class="line">  <span class="built_in">CFHashCode</span>(*hash)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line"><span class="meta">#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)) || (TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)</span></span><br><span class="line">  mach_port_t(*getPort)(<span class="keyword">void</span> *info);</span><br><span class="line">  <span class="keyword">void</span> *(*perform)(<span class="keyword">void</span> *msg, <span class="built_in">CFIndex</span> size, <span class="built_in">CFAllocatorRef</span> allocator, <span class="keyword">void</span> *info);</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">  <span class="keyword">void</span> *(*getPort)(<span class="keyword">void</span> *info);</span><br><span class="line">  <span class="keyword">void</span>(*perform)(<span class="keyword">void</span> *info);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125; <span class="built_in">CFRunLoopSourceContext1</span>;</span><br></pre></td></tr></table></figure><h4 id="input-source-ä¸-client-çš„åä½œ"><a class="markdownIt-Anchor" href="#input-source-ä¸-client-çš„åä½œ"></a> Input Source ä¸ Client çš„åä½œ</h4><p>æƒ³ä½¿ç”¨ input sourceï¼Œä½ éœ€è¦ä»å…¶ä»– thread å‘é€æ¶ˆæ¯ã€‚input source çš„å…¨éƒ¨ç›®çš„æ˜¯ä½¿å…¶å…³è” thread å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰äº‹è¦åšã€‚è¿™éœ€è¦è®©ä½ çš„åº”ç”¨ç¨‹åºä¸­çš„å…¶ä»–çº¿ç¨‹çŸ¥é“è¾“å…¥æºå¹¶æœ‰ä¸€ç§ä¸ä¹‹é€šä¿¡çš„æ–¹æ³•ã€‚</p><p>å½“ input source ç¬¬ä¸€æ¬¡è£…è½½åˆ° run loop çš„æ—¶å€™ï¼Œå¯ä»¥å‘ client å‘é€æ³¨å†Œ input source çš„è¯·æ±‚ã€‚å¯ä»¥å°†ä¸€ä¸ª input source ç›´æ¥æˆ–é—´æ¥æ³¨å†Œåˆ°å¤šä¸ª client ä¸­ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº† application delegate æä¾›çš„æ³¨å†Œæ–¹æ³• registerSource:ï¼Œä¹‹å‰æåˆ°è¿‡å›è°ƒå‡½æ•° RunLoopSourceScheduleRoutine çš„å®ç°ä¼šè°ƒç”¨ registerSource:ã€‚ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œæµç¨‹æ˜¯ install(addToCurrentRunLoop) -&gt; schedule(RunLoopSourceScheduleRoutine) -&gt; register(registerSource:)ã€‚å¯¹åº”åœ°ï¼Œå½“ input source ä» run loop ä¸­è¢«ç§»é™¤ï¼Œå›è°ƒå‡½æ•° RunLoopSourceCancelRoutine ä¸­ä¼šè°ƒç”¨ removeSource: æ–¹æ³•ã€‚</p><p><a href="#4">scheduler an input source</a> å’Œ <a href="#5">Invalidating an input source</a><br><span id="3"></span></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)registerSource:(RunLoopContext*)sourceInfo;&#123;</span><br><span class="line">  [sourcesToPing addObject:sourceInfo];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)removeSource:(RunLoopContext*)sourceInfo&#123;</span><br><span class="line">  <span class="keyword">id</span> objToRemove = <span class="literal">nil</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (RunLoopContext* context <span class="keyword">in</span> sourcesToPing) &#123;</span><br><span class="line">  <span class="keyword">if</span> ([context isEqual:sourceInfo]) &#123;</span><br><span class="line">    objToRemove = context;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (objToRemove)</span><br><span class="line">  [sourcesToPing removeObject:objToRemove];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‘-input-source-å‘é€ä¿¡å·"><a class="markdownIt-Anchor" href="#å‘-input-source-å‘é€ä¿¡å·"></a> å‘ Input Source å‘é€ä¿¡å·</h4><p>åœ¨å°†æ•°æ®äº¤ç»™ Input Source åï¼Œå®¢æˆ·ç«¯å¿…é¡»å‘ä¿¡å·é€šçŸ¥æºå¹¶å”¤é†’å…¶ runloopã€‚æ¶ˆæ¯ä¼ è¾¾ input source ä»¥åï¼Œthread å¯ä»¥å¤„äºä¼‘çœ çŠ¶æ€ï¼Œä½ åº”è¯¥æ˜¾ç¤ºçš„å”¤èµ· runloopï¼Œå¦‚æœå¤„ç†å®Œäº†å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ç»“æœï¼</p><p>Waking up the run loop:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)fireCommandsOnRunLoop:(<span class="built_in">CFRunLoopRef</span>)runloop &#123;</span><br><span class="line">  <span class="built_in">CFRunLoopSourceSignal</span>(runLoopSource);</span><br><span class="line">  <span class="built_in">CFRunLoopWakeUp</span>(runloop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-timer-sources"><a class="markdownIt-Anchor" href="#é…ç½®-timer-sources"></a> é…ç½® Timer Sources</h3><p>åˆ›å»º Timer Sourcesï¼šåˆ›å»ºä¸€ä¸ª timer å¯¹è±¡ï¼Œç„¶ååœ¨ runloopä¸­è°ƒåº¦å®ƒã€‚<br>Cocoa ä¸­ä½¿ç”¨ NSTimerï¼ŒCore Foundation ä¸­ä½¿ç”¨ CFRunLoopTimerRef ç±»å‹ã€‚è™½ç„¶äºŒè€…æ˜¯ toll-free bridged çš„ï¼Œä½†æ˜¯ NSTimer æä¾›çš„ API æ›´ä¾¿æ·ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:</span><br><span class="line">scheduledTimerWithTimeInterval:invocation:repeats:</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™2ä¸ªæ–¹æ³•ä¼šåˆ›å»º timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹ runloop çš„ DefaultMode ä¸­ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª NSTimer å¯¹è±¡å¹¶ç”¨ NSRunLoop çš„ addTimer:forMode: æ–¹æ³•å°†å…¶æ·»åŠ åˆ° runloop çš„æŒ‡å®š Mode ä¸­ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸¤ç§æ·»åŠ  timer çš„æ–¹å¼ï¼šç¬¬ä¸€ä¸ª timer å»¶è¿Ÿ 1 ç§’è§¦å‘å¹¶æ¯éš” 0.1 ç§’é‡å¤è§¦å‘ï¼Œç¬¬äºŒä¸ª timer å»¶è¿Ÿ 0.2 ç§’è§¦å‘ç„¶åæ¯éš” 0.2 ç§’é‡å¤è§¦å‘ã€‚</p><p>Creating and scheduling timers using NSTimer:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSRunLoop</span>* myRunLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create and schedule the first timer.</span></span><br><span class="line"><span class="built_in">NSDate</span>* futureDate = [<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="number">1.0</span>];</span><br><span class="line"><span class="built_in">NSTimer</span>* myTimer = [[<span class="built_in">NSTimer</span> alloc] initWithFireDate:futureDate</span><br><span class="line">            interval:<span class="number">0.1</span></span><br><span class="line">            target:<span class="keyword">self</span></span><br><span class="line">            selector:<span class="keyword">@selector</span>(myDoFireTimer1:)</span><br><span class="line">            userInfo:<span class="literal">nil</span></span><br><span class="line">             repeats:<span class="literal">YES</span>];</span><br><span class="line">[myRunLoop addTimer:myTimer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create and schedule the second timer.</span></span><br><span class="line">[<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">0.2</span></span><br><span class="line">        target:<span class="keyword">self</span></span><br><span class="line">        selector:<span class="keyword">@selector</span>(myDoFireTimer2:)</span><br><span class="line">        userInfo:<span class="literal">nil</span></span><br><span class="line">         repeats:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure><p>Creating and scheduling a timer using Core Foundation:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoopRef</span> runLoop = <span class="built_in">CFRunLoopGetCurrent</span>();</span><br><span class="line"><span class="built_in">CFRunLoopTimerContext</span> context = &#123;<span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="built_in">CFRunLoopTimerRef</span> timer = <span class="built_in">CFRunLoopTimerCreate</span>(kCFAllocatorDefault, <span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">          &amp;myCFTimerCallback, &amp;context);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">CFRunLoopAddTimer</span>(runLoop, timer, kCFRunLoopCommonModes);</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-a-port-based-input-source"><a class="markdownIt-Anchor" href="#é…ç½®-a-port-based-input-source"></a> é…ç½® a Port-Based Input Source</h3><p>Cocoa and Core Foundation éƒ½æä¾›äº† port-based å¯¹è±¡ç”¨äºçº¿ç¨‹ or è¿›ç¨‹é—´é€šè®¯ï¼Œä¸‹é¢ä¼šä½¿ç”¨ä¸åŒç±»å‹çš„ ports å®ç°å»ºç«‹ port é€šè®¯</p><h4 id="é…ç½®-nsmachport-object"><a class="markdownIt-Anchor" href="#é…ç½®-nsmachport-object"></a> é…ç½® NSMachPort Object</h4><p>ä½¿ç”¨ NSMachPort å¯¹è±¡å»ºç«‹æœ¬åœ°è¿æ¥ï¼š</p><ul><li>åˆ›å»º NSMachPort å¯¹è±¡å¹¶æ·»åŠ åˆ° primary çº¿ç¨‹çš„ runloop ä¸­ã€‚</li><li>å½“å¯åŠ¨ secondary çº¿ç¨‹æ—¶å°†è¿™ä¸ª NSMachPort å¯¹è±¡ä¼ é€’ç»™ secondary çº¿ç¨‹çš„å…¥å£å‡½æ•°ã€‚</li><li>secondary çº¿ç¨‹ä¼šç”¨è¿™ä¸ª NSMachPort å¯¹è±¡å¾€ primary çº¿ç¨‹å‘æ¶ˆæ¯ã€‚</li></ul><h5 id="main-thread-ä»£ç å®ç°"><a class="markdownIt-Anchor" href="#main-thread-ä»£ç å®ç°"></a> main thread ä»£ç å®ç°</h5><p>ä¸‹é¢çš„ä»£ç æ˜¯å¯åŠ¨ secondary worker çº¿ç¨‹çš„ä¸»è¦ä»£ç ã€‚ä½¿ç”¨ Cocoa æ¡†æ¶çš„ä»£ç è¦æ¯” Core Foundation çš„å°‘ï¼Œæ•ˆæœå‡ ä¹ä¸€æ ·ã€‚æœ‰ä¸ªä¸åŒç‚¹æ˜¯ Cocoa ç›´æ¥ä¼ é€’ NSPort å¯¹è±¡ï¼Œè€Œ Core Foundation ä¼ é€’ç«¯å£åå­—ç¬¦ä¸²ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)launchThread&#123;</span><br><span class="line">  <span class="built_in">NSPort</span>* myPort = [<span class="built_in">NSMachPort</span> port];</span><br><span class="line">  <span class="keyword">if</span> (myPort) &#123;</span><br><span class="line">  <span class="comment">// This class handles incoming port messages.</span></span><br><span class="line">  [myPort setDelegate:<span class="keyword">self</span>];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Install the port as an input source on the current run loop.</span></span><br><span class="line">  [[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:myPort forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Detach the thread. Let the worker release the port.</span></span><br><span class="line">  [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(LaunchThreadWithPort:)</span><br><span class="line">     toTarget:[MyWorkerClass <span class="keyword">class</span>] withObject:myPort];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å»ºç«‹å¥½ threads é—´çš„é€šè®¯ï¼Œä½ å¯èƒ½æƒ³è¦å¾—åˆ° worker thread å°†ä»–çš„æœ¬åœ°ç«¯å£å·å‘é€ç»™ main threadï¼ŒæŠŠè¿™ä¸ªå½“åšæ ¡éªŒæ¶ˆæ¯ã€‚main thread å¾—åˆ° worker thread çš„ç«¯å£å·ï¼Œæ ¡éªŒå®Œæ¯•ï¼Œå°±çŸ¥é“å¯åŠ¨ secondary thread çš„è¿‡ç¨‹ä¸€åˆ‡è¿›å±•é¡ºåˆ©ã€‚ä¸»çº¿ç¨‹ä¼šå°† worker thread çš„ portID ä¿å­˜èµ·æ¥ã€‚</p><p>ä¸‹é¢çš„ handlePortMessage: æ–¹æ³•ä¼šåœ¨çº¿ç¨‹è‡ªå·±çš„æœ¬åœ°ç«¯å£æ”¶åˆ°æ•°æ®åè¢«è°ƒç”¨ã€‚NSPortMessage æŒæœ‰ä¸¤ä¸ªç«¯å£å¯¹è±¡ï¼šå‘é€ç«¯å£å’Œæ¥æ”¶ç«¯å£ã€‚handlePortMessage: æ–¹æ³•ä¸­ä½¿ç”¨ [portMessage sendPort] è·å–åˆ°äº†å‘é€ç«¯å£å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ secondary thread æ‹¥æœ‰çš„æœ¬åœ°ç«¯å£ã€‚ä¹Ÿå°±æ˜¯ secondary thread å¯åŠ¨åä¼šç»™ primary thread å‘æ¶ˆæ¯ï¼Œå‘ŠçŸ¥è‡ªå·±çš„ç«¯å£å¯¹è±¡ï¼Œä¸»çº¿ç¨‹ä¼šå°†å…¶å­˜ä¸‹æ¥ä»¥å¤‡æ—¥åä½¿ç”¨ã€‚msgid æ ‡è®°äº†æ¶ˆæ¯çš„å”¯ä¸€ IDã€‚</p><p>Handling Mach port messages:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define kCheckinMessage 100</span></span><br><span class="line"><span class="comment">// Handle responses from the worker thread.</span></span><br><span class="line">- (<span class="keyword">void</span>)handlePortMessage:(<span class="built_in">NSPortMessage</span> *)portMessage&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> message = [portMessage msgid];</span><br><span class="line">  <span class="built_in">NSPort</span>* distantPort = <span class="literal">nil</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (message == kCheckinMessage) &#123;</span><br><span class="line">  <span class="comment">// Get the worker threadâ€™s communications port.</span></span><br><span class="line">  distantPort = [portMessage sendPort];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Retain and save the worker port for later use.</span></span><br><span class="line">  [<span class="keyword">self</span> storeDistantPort:distantPort];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="comment">// Handle other messages.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="secondary-thread-ä»£ç å®ç°"><a class="markdownIt-Anchor" href="#secondary-thread-ä»£ç å®ç°"></a> secondary thread ä»£ç å®ç°</h5><p>å¯¹äº secondary worker thread, ä½ ä¸€å®šè¦æ˜ç¡®ä»–çš„ç«¯å£å·ï¼ç”¨å®ƒä¸ primary thread é€šè®¯ã€‚</p><p>ä¸‹é¢ä»£ç ï¼šå¦‚ä½•é…ç½® worker threadï¼Œworker thread çš„å…¥å£å‡½æ•°ä¼šè¢«ä¼ å…¥ primary thread çš„ç«¯å£å¯¹è±¡ã€‚ä¸‹é¢ä»£ç ä¸­çš„ MyWorkerClass æ˜¯ä¸ªè¾…åŠ©ç±»ï¼Œå®ƒçš„ sendCheckinMessage: æ–¹æ³•è´Ÿè´£åˆ›å»ºworker threadçš„æœ¬åœ°ç«¯å£ï¼Œå¹¶å‘æ¶ˆæ¯ç»™ primary thread ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="keyword">void</span>)LaunchThreadWithPort:(<span class="keyword">id</span>)inData&#123;</span><br><span class="line">  <span class="built_in">NSAutoreleasePool</span>*  pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Set up the connection between this thread and the main thread.</span></span><br><span class="line">  <span class="built_in">NSPort</span>* distantPort = (<span class="built_in">NSPort</span>*)inData;</span><br><span class="line"> </span><br><span class="line">  MyWorkerClass*  workerObj = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">  [workerObj sendCheckinMessage:distantPort];</span><br><span class="line">  [distantPort release];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Let the run loop process things.</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">  [[<span class="built_in">NSRunLoop</span> currentRunLoop] runMode:<span class="built_in">NSDefaultRunLoopMode</span></span><br><span class="line">         beforeDate:[<span class="built_in">NSDate</span> distantFuture]];</span><br><span class="line">  &#125; <span class="keyword">while</span> (![workerObj shouldExit]);</span><br><span class="line"> </span><br><span class="line">  [workerObj release];</span><br><span class="line">  [pool release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®-nsmessageport-object"><a class="markdownIt-Anchor" href="#é…ç½®-nsmessageport-object"></a> é…ç½® NSMessagePort Object</h4><h4 id="ä½¿ç”¨-core-foundation-é…ç½®-port-based-input-source"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-core-foundation-é…ç½®-port-based-input-source"></a> ä½¿ç”¨ Core Foundation é…ç½® Port-Based Input Source</h4><blockquote><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW5" target="_blank" rel="noopener">Threading Programming Guide-RunLoop</a><br><a href="http://yulingtianxia.com/blog/2017/09/17/Threading-Programming-Guide-2/#%E8%AF%A5%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-Run-Loop%EF%BC%9F" target="_blank" rel="noopener">Threading Programming Guide(2)</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> runloop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RunLoop åŸç†åˆ†æ</title>
      <link href="/2017/08/27/runloop/RunLoop%E5%88%86%E6%9E%90/"/>
      <url>/2017/08/27/runloop/RunLoop%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p><img src="/img/runloop_title.jpeg" alt="runloop_title"></p><h2 id="å¸¦ç€é—®é¢˜æ€è€ƒ-questions"><a class="markdownIt-Anchor" href="#å¸¦ç€é—®é¢˜æ€è€ƒ-questions"></a> å¸¦ç€é—®é¢˜æ€è€ƒ Questions</h2><ol><li>RunLoop ä»–æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>RunLoop ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè¦æ˜¯è¿™æ ·çš„ç»“æ„ï¼Œå…¶ä»–çš„æ ·å­ä¸å¯ä»¥å—ï¼Ÿ</li><li>RunLoop å†…éƒ¨åˆ†æï¼Ÿ</li><li>ç³»ç»Ÿä¸­æœ‰å“ªäº›åŠŸèƒ½ä½¿ç”¨äº† runloopï¼Ÿ</li><li>å¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨ RunLoop</li></ol><p>å¼•ç”¨ CFRunLoopRef æºç ï¼š<a href="https://opensource.apple.com/tarballs/CF/CF-1153.18.tar.gz" target="_blank" rel="noopener">CF-1153.18.tar.gz</a></p><h2 id="runloop-æ¥æº"><a class="markdownIt-Anchor" href="#runloop-æ¥æº"></a> RunLoop æ¥æº</h2><ul><li>ä¸€èˆ¬æ¥è¯´ï¼Œç¨‹åºåªè¿è¡Œä¸€æ¬¡ï¼Œç„¶åç»ˆæ­¢. åƒå‘½ä»¤è¡Œé©±åŠ¨ç¨‹åºã€‚ä½†æ˜¯è¿™æ ·çš„ç¨‹åºæ²¡æœ‰ç”¨æˆ·äº¤äº’æ€§</li><li>ä¸ºäº†ä½¿ç¨‹åºå¢åŠ ç”¨æˆ·äº¤äº’æ€§ï¼Œå°±éœ€è¦ä¸€ä¸ªæœºåˆ¶è®©ç¨‹åºä¸é€€å‡ºç­‰å¾…ç”¨æˆ·æ“ä½œã€‚ä½¿ç”¨<a href="https://en.wikipedia.org/wiki/Event_loop" target="_blank" rel="noopener">Event Loop</a>è®¾è®¡æ¨¡å¼ï¼Œè®© thread å…³è”ä¸€ä¸ª event loopï¼Œç›‘å¬ eventï¼Œç„¶åè°ƒç”¨äº‹ä»¶çš„ reactor å¤„ç†äº‹ä»¶é€šå¸¸æ˜¯äº¤ç”± event loop å…³è”çš„ thread å¤„ç†ã€‚è¿™æ ·ä½¿ thread ä¿æ´»</li></ul><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> main</span><br><span class="line">    initialize()</span><br><span class="line">    <span class="keyword">while</span> message != quit</span><br><span class="line">        message := get_next_message()</span><br><span class="line">        process_message(message)</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">while</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">function</span></span><br></pre></td></tr></table></figure><p><img src="/img/event_loop.jpeg" alt="Event loop æœºåˆ¶"></p><p>Event Loop åœ¨å¾ˆå¤šå¹³å°ä¸Šéƒ½æœ‰ï¼Œæ— è®ºæ˜¯ GUIï¼Œå¼€å§‹ç³»ç»Ÿäº‹ä»¶éƒ½éœ€è¦ Event Loop æ¨¡å¼æ¥å¤„ç†äº¤äº’ç¨‹åº</p><table><thead><tr><th style="text-align:left">ç¯å¢ƒ</th><th style="text-align:left">Event_Loopå¯¹åº”åç§°</th></tr></thead><tbody><tr><td style="text-align:left">OSX/iOS</td><td style="text-align:left">RunLoop</td></tr><tr><td style="text-align:left">Windows</td><td style="text-align:left">æ¶ˆæ¯é˜Ÿåˆ—</td></tr><tr><td style="text-align:left">Linux</td><td style="text-align:left">epollï¼Œselect</td></tr></tbody></table><p>æ¶ˆæ¯é˜Ÿåˆ—ä½¿å¾—è°ƒç”¨æ–¹è·Ÿè¢«è°ƒç”¨æ–¹ä¹‹é—´è§£è€¦</p><h2 id="osxios-ä¸­çš„-event-loop"><a class="markdownIt-Anchor" href="#osxios-ä¸­çš„-event-loop"></a> OSX/iOS ä¸­çš„ Event Loop</h2><h3 id="runloop-ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#runloop-ç‰¹ç‚¹"></a> RunLoop ç‰¹ç‚¹ï¼š</h3><ul><li>ä»–æ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€æ¶æ„çš„ä¸€éƒ¨åˆ†ï¼Œå……å½“ç€å¾ªç¯å¤„ç†ã€è°ƒåº¦äº‹ä»¶/è½¬å‘æ¶ˆæ¯çš„è§’è‰²ï¼Œç®¡ç†threadè¿è¡ŒçŠ¶æ€ã€‚<ul><li>å®ƒä½¿å¾—çº¿ç¨‹ä¸ä¼šæ‰§è¡Œå®Œå•ä¸ªä»»åŠ¡åå°±ç«‹åˆ»ç»“æŸ</li><li>è®©çº¿ç¨‹åœ¨æ²¡æœ‰ä»»åŠ¡æ—¶ä¿æŒä¼‘çœ çŠ¶æ€</li><li>åœ¨éœ€è¦å¤„ç†æ¶ˆæ¯æ—¶è¢«ç«‹åˆ»å”¤é†’</li></ul></li><li>RunLoop æ˜¯ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æœ‰å¯¹åº”çš„ runloopã€‚runloopçš„ç®¡ç†æœºåˆ¶å¹¶ä¸å®Œå…¨æ˜¯è‡ªåŠ¨çš„ï¼Œæœ‰æ—¶éœ€è¦è®¾è®¡å¥½ runloop çš„è¿è¡Œæ—¶é—´å’Œäº‹ä»¶å¤„ç†å›è°ƒã€‚<ul><li>é™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œå­çº¿ç¨‹éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å»é…ç½®å¹¶è¿è¡Œå®ƒçš„ runloop</li><li>ä¸»çº¿ç¨‹çš„ runloop å·²ç»ç”±ç³»ç»Ÿè‡ªåŠ¨é…ç½®å¹¶è¿è¡Œäº†ã€‚</li></ul></li><li>runloop åœ¨ Cocoa å’Œ Core Foundation æœ‰ä¸¤ä¸ªå¯¹åº”çš„ç±»ï¼šNSRunLoop å’Œ CFRunLoop</li></ul><h3 id="runloop-ä¸­çš„-mode"><a class="markdownIt-Anchor" href="#runloop-ä¸­çš„-mode"></a> RunLoop ä¸­çš„ Mode</h3><details><summary>RunLoop å’Œ Mode ç®€åŒ–æºç </summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> *<span class="title">CFRunLoopModeRef</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">  CFStringRef _name;      <span class="comment">// Mode Name, ä¾‹å¦‚ @"kCFRunLoopDefaultMode"</span></span><br><span class="line">  CFMutableSetRef _sources0;  <span class="comment">// Set è‡ªå®šä¹‰çš„ input sourceï¼Œç”±å…¶ä»– thread å‘é€æ¶ˆæ¯</span></span><br><span class="line">  CFMutableSetRef _sources1;  <span class="comment">// Set åŸºäº port åŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯</span></span><br><span class="line">  CFMutableArrayRef _observers; <span class="comment">// Array</span></span><br><span class="line">  CFMutableArrayRef _timers;  <span class="comment">// Array</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> *<span class="title">CFRunLoopRef</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">  pthread thread;</span><br><span class="line">  CFMutableSetRef _commonModes;   <span class="comment">// Set é€šç”¨ modesé›†åˆï¼Œä»»ä½•Source/Observer/Timer åŠ å…¥å…¶ä¸­ä»¥åï¼Œ_commonModes ä¸­çš„æ¯ä¸ª mode éƒ½ä¼šå¼•ç”¨è¿™äº›(Source/Observer/Timer ),å¹¶å¯¹å…¶åšç›¸åº”å¤„ç†</span></span><br><span class="line">  CFMutableSetRef _commonModeItems; <span class="comment">// Set æ‰€æœ‰_commonModesä¸­å¼•ç”¨ &lt;Source/Observer/Timer&gt;</span></span><br><span class="line">  CFRunLoopModeRef _currentMode;  <span class="comment">// Current Runloop Mode CFRunLoopCopyAllModesæ–¹æ³•ä¼šå¾—åˆ°å®ƒ</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></details><p><img src="/img/run_loop_structure.jpeg" alt="run_loop_structure"></p><p>Input Sources:</p><ul><li>Port-Based Sourcesï¼šç›‘å¬Appçš„ Mach Portï¼Œç”±å†…æ ¸å‘å‡ºä¿¡å·ï¼Œè¾“å…¥æºæ”¶åˆ°ä¿¡å·åï¼Œæ‰§è¡Œç›¸å…³çš„ä¾‹ç¨‹ã€‚(sources1)</li><li>Custom Input Sourcesï¼šç›‘å¬è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œéœ€è¦åœ¨å…¶å®ƒçº¿ç¨‹æ‰‹åŠ¨å‘é€ä¿¡å·ï¼Œè¾“å…¥æºæ”¶åˆ°ä¿¡å·åï¼Œæ‰§è¡Œç›¸å…³çš„ä¾‹ç¨‹ã€‚(sources0)</li><li>Cocoa Perform Selector Sourcesï¼šCocoaä¸­è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œç›®çš„æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼ŒåŒä¸€çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯é¡ºåºæ‰§è¡Œçš„,å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆåç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤è¿™ä¸ªæºã€‚ï¼ˆæ³¨æ„ï¼šåœ¨ç›®æ ‡çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªç›®æ ‡çº¿ç¨‹å¿…é¡»æœ‰æ´»è·ƒçš„RunLoopï¼‰(sources0)</li></ul><p><code>æ—¶é—´æº time sources</code><br>éœ€è¦ç›‘å¬runloopçš„å½“å‰çŠ¶æ€çš„ï¼š<br><code>ç›‘å¬è€… observers</code></p><p>RunLoop çš„æ¯æ¬¡è¿è¡Œéƒ½ä¼šåœ¨æŸä¸ªç‰¹å®šæ¨¡å¼ä¸‹ï¼Œè€Œä¸”åªæœ‰è¿™ä¸ªæ¨¡å¼æ‰€åŒ…å«çš„ item é›†åˆæ‰ä¼šå‚ä¸å‘é€äº‹ä»¶(è¢«ç›‘å¬)å’Œæ¥æ”¶é€šçŸ¥ã€‚å¦‚æœæ”¹ item æ²¡æœ‰åŠ å…¥åˆ°æŒ‡å®šæ¨¡å¼ä¸‹çš„runloopï¼Œé‚£ä¹ˆè¯¥æ¨¡å¼ä¸‹å°±ä¸ä¼šæ‰§é€šçŸ¥orç›‘å¬è¯¥ itemï¼Œå¦‚æœæ²¡æœ‰ item é‚£ä¹ˆä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚</p><ul><li>mode ä¸­éœ€è¦æ³¨æ„çš„ default å’Œ tracing è¿™ä¸¤ç§ï¼Œåœ¨å®é™…å¼€å‘ä¸­ä¼šç»å¸¸ä½¿ç”¨</li></ul><span id="1"><table><thead><tr><th>Mode</th><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><font color="red">Default</font></td><td>NSDefaultRunLoopMode (Cocoa), kCFRunLoopDefaultMode (Core Foundation)</td><td>Appçš„é»˜è®¤è¿è¡Œæ¨¡å¼ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªè¿è¡Œæ¨¡å¼ä¸‹è¿è¡Œ</td></tr><tr><td>Connection</td><td>NSConnectionReplyMode (Cocoa)</td><td>Cocoa ä¸­ç»“åˆ NSConnection ä½¿ç”¨ï¼Œç”¨äºç›‘å¬å›å¤(Reply)ï¼Œæå°‘ç”¨åˆ°ã€‚(å·²å¼ƒç”¨)</td></tr><tr><td>Modal</td><td>NSModalPanelRunLoopMode (Cocoa)</td><td>Cocoa ä¸­ modal panel ä½¿ç”¨å®ƒæ¥æ”¶ä¸ä¹‹ç›¸å…³ Source çš„äº‹ä»¶</td></tr><tr><td><font color="red">Event tracking</font></td><td>NSEventTrackingRunLoopMode (Cocoa), UITrackingRunLoopMode (Cocoa Touch)</td><td>è·Ÿè¸ªç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ï¼‰</td></tr><tr><td><font color="red"><strong>Common modes</strong></font></td><td>NSRunLoopCommonModes (Cocoa), kCFRunLoopCommonModes (Core Foundation)</td><td>è¿™æ˜¯ä¸€ç»„å¯é…ç½®çš„é€šç”¨é›†åˆï¼Œå¦‚æœå°†æŸä¸ª input source æ³¨å†Œåˆ°è¯¥æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆ input source åœ¨é€šç”¨æ¨¡å¼é›†åˆä¸­çš„æ¯ä¸ª mode ä¸­éƒ½ä¼šæ³¨å†Œã€‚Cocoa æ¡†æ¶ä¸­çš„ Common modes é»˜è®¤åŒ…å« Default, Modal, Event tracking ä¸‰ç§ Modeï¼›Core Foundation åªåŒ…å« Defaultï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://developer.apple.com/documentation/corefoundation/1542137-cfrunloopaddcommonmode" target="_blank" rel="noopener">CFRunLoopAddCommonMode</a> å‡½æ•°å‘é›†åˆä¸­æ·»åŠ è‡ªå®šä¹‰ Modeã€‚</td></tr></tbody></table><p><strong>Common modes</strong> ä¸æ˜¯ä¸€ä¸ªmodeï¼Œè€Œæ˜¯ä¸€ä¸ª modes é›†åˆï¼</p><p>eg: åœ¨ Cocoa æ¡†æ¶ä¸­ï¼Œå¦‚æœ Sources, timers, observers æ·»åŠ åˆ° CommonModesä¸­ï¼Œé‚£ä¹ˆ Sources, timers, observers ä¼šè¢« CommonModes ç»“åˆä¸­(Default, Modal, Event tracking)æ‰€æœ‰æ¨¡å¼å…±äº«ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFRunLoopAddCommonMode</span><span class="params">(CFRunLoopRef rl, CFRunLoopMode mode)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦ mode æ·»åŠ åˆ° runloop çš„_commonModesä»¥åå°±ä¸å¯ä»¥è¢«åˆ é™¤äº†ï¼æ­¤æ—¶éœ€è¦åˆ›å»ºæ–°çš„ runloop å¯¹è±¡ï¼ŒæŠŠæ—§ runloop ä¸­éœ€è¦çš„ mode copy å‡ºæ¥ï¼Œæ”¾åœ¨æ–°çš„ runloop ä¸­</p><p><a href="https://developer.apple.com/documentation/corefoundation/1541775-cfrunloopcopycurrentmode?language=objc" target="_blank" rel="noopener">CFRunLoopCopyCurrentMode</a>/<a href="https://developer.apple.com/documentation/corefoundation/1542184-cfrunloopcopyallmodes?language=objc" target="_blank" rel="noopener">CFRunLoopCopyAllModes</a></p><h2 id="runloop-ä¸­çš„sources-å’Œ-observers"><a class="markdownIt-Anchor" href="#runloop-ä¸­çš„sources-å’Œ-observers"></a> RunLoop ä¸­çš„sources å’Œ observers</h2><p><img src="/img/runloop_event.jpeg" alt="run_loop_structure"><br>åœ¨ RunLoop å¯¹è±¡ç»“æ„ä¸­æœ‰ä¸ª Modeï¼Œæ˜¯ä¸ºäº†åœ¨æŸç§æ¨¡å¼ä¸‹ RunLoop æ‰ä¼šå¤„ç†ï¼Œå¯ä»¥å‡å°‘æ¯æ¬¡éœ€è¦ç›‘å¬çš„äº‹ä»¶æº</p><h3 id="sources-äº‹ä»¶æº"><a class="markdownIt-Anchor" href="#sources-äº‹ä»¶æº"></a> Sources äº‹ä»¶æº</h3><h4 id="input-sources"><a class="markdownIt-Anchor" href="#input-sources"></a> Input Sources</h4><p>sourceåˆ†ä¸ºä¸¤ç±»ï¼Œsource0å’Œsource1ã€‚</p><ol><li>source0åªå«æœ‰å›è°ƒæŒ‡é’ˆï¼Œå¤„ç†å¦‚UIEventï¼ŒCFSocketè¿™ç±»äº‹ä»¶ã€‚å®ƒåªèƒ½æ‰‹åŠ¨å”¤é†’ã€‚</li><li>source1åˆ™æ˜¯æœ‰ä¸€ä¸ªmach portå’Œå›è°ƒæŒ‡é’ˆï¼Œèƒ½è¢«Machå†…æ ¸ä¼ é€’çš„ä¿¡æ¯å”¤é†’ã€‚<ol><li>è§¦æ‘¸äº‹ä»¶å…¶å®æ˜¯source1æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ååœ¨å›è°ƒ __IOHIDEventSystemClientQueueCallback</li><li>__IOHIDEventSystemClientQueueCallback() å†…è§¦å‘çš„ Source0</li><li>Source0 å†è§¦å‘çš„ _UIApplicationHandleEventQueue()</li></ol></li></ol><p>è¾“å…¥æºï¼šå°†äº‹ä»¶ä»¥ <code>asynchronous</code> çš„æ–¹å¼å‘ thread å‘é€ event</p><table><thead><tr><th style="text-align:left">è¾“å…¥æº</th><th>Port-Based Sources</th><th>Custom Input Sources</th></tr></thead><tbody><tr><td style="text-align:left">å¯¹åº” mode ç»“æ„ä½“</td><td>source1</td><td>source0</td></tr><tr><td style="text-align:left">æ¶ˆæ¯ä»ä½•æ¥(å‘é€æ–¹)</td><td>kernel çº¿ç¨‹</td><td>å…¶ä»–ç”¨æˆ·thread</td></tr><tr><td style="text-align:left">ç›‘å¬äº‹ä»¶</td><td>Mach portsï¼ˆå†…æ ¸ portsï¼‰event</td><td>ç”¨æˆ·è‡ªå®šä¹‰Input sources çš„event</td></tr><tr><td style="text-align:left">æ·»åŠ æ–¹æ³•</td><td>NSPort å¯¹è±¡</td><td>CFRunLoopSourceRef</td></tr></tbody></table><h4 id="timer-sources"><a class="markdownIt-Anchor" href="#timer-sources"></a> Timer Sources</h4><p>æ—¶é—´æºï¼šåœ¨é¢„è®¾æ—¶é—´åä»¥åŒæ­¥çš„æ–¹å¼æŠŠ event ä¼ é€’ç»™ thread<br>Timerï¼šæ˜¯çº¿ç¨‹é€šçŸ¥è‡ªå·±åšæŸäº‹çš„ä¸€ç§æ–¹å¼</p><h3 id="run-loop-observers-è§‚å¯Ÿè€…"><a class="markdownIt-Anchor" href="#run-loop-observers-è§‚å¯Ÿè€…"></a> Run Loop Observers è§‚å¯Ÿè€…</h3><p>ä¸åŒäº source åœ¨åŒæ­¥æˆ–å¼‚æ­¥äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘ï¼Œobserver ä¼šåœ¨ runloop è¿è¡ŒæœŸé—´çš„æŸäº›ç‰¹æ®Šåœ°æ–¹è§¦å‘ã€‚<br>CFRunLoopObserverRefæ˜¯ runloop çŠ¶æ€çš„è§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬RunLoopæ‰€æœ‰çš„çŠ¶æ€æ”¹å˜ã€‚</p><ul><li>è¿›å…¥ run loop</li><li>å½“ run loop å³å°†å¤„ç†ä¸€ä¸ª timer</li><li>å½“ run loop å³å°†å¤„ç†ä¸€ä¸ª input source</li><li>å½“ run loop å³å°†ä¼‘çœ </li><li>å½“ run loop å·²ç»è¢«å”¤é†’ï¼Œä½†åœ¨å®ƒå¤„ç†å”¤é†’å®ƒçš„äº‹ä»¶ä¹‹å‰</li><li>é€€å‡º run loop</li></ul><details><summary>å¯¹åº” CFRunLoopActivity æšä¸¾</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å³å°†è¿›å…¥Loop</span></span><br><span class="line">  kCFRunLoopEntry = (<span class="number">1U</span>L &lt;&lt; <span class="number">0</span>),</span><br><span class="line">  <span class="comment">// å³å°†å¤„ç†Timer</span></span><br><span class="line">  kCFRunLoopBeforeTimers = (<span class="number">1U</span>L &lt;&lt; <span class="number">1</span>),</span><br><span class="line">  <span class="comment">// å³å°†å¤„ç†Source</span></span><br><span class="line">  kCFRunLoopBeforeSources = (<span class="number">1U</span>L &lt;&lt; <span class="number">2</span>),</span><br><span class="line">  <span class="comment">// å³å°†è¿›å…¥ä¼‘çœ </span></span><br><span class="line">  kCFRunLoopBeforeWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">5</span>),</span><br><span class="line">  <span class="comment">// åˆšä»ä¼‘çœ ä¸­å”¤é†’</span></span><br><span class="line">  kCFRunLoopAfterWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">6</span>),</span><br><span class="line">  <span class="comment">// å³å°†é€€å‡ºLoop</span></span><br><span class="line">  kCFRunLoopExit = (<span class="number">1U</span>L &lt;&lt; <span class="number">7</span>),</span><br><span class="line">  <span class="comment">// æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">  kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></details><h2 id="run-loop-å†…éƒ¨æ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#run-loop-å†…éƒ¨æ‰§è¡Œæµç¨‹"></a> Run Loop å†…éƒ¨æ‰§è¡Œæµç¨‹</h2><p>çº¿ç¨‹çš„ run loop æ¯æ¬¡è¿è¡Œéƒ½ä¼šå¤„ç†å¾…å†³çš„äº‹ä»¶ï¼Œå¹¶ä¸ºç»‘å®šçš„æ‰€æœ‰ observer ç”Ÿæˆé€šçŸ¥ã€‚æ¬¡åºå¦‚ä¸‹ï¼š</p><p>å¦‚æœmodeé‡Œæ²¡æœ‰source/timer/observer, ç›´æ¥è¿”å›ã€‚</p><ol><li>é€šçŸ¥ observer å·²ç»è¿›å…¥ run loop</li><li>é€šçŸ¥ observer æœ‰ timer å°†è¦è§¦å‘</li><li>é€šçŸ¥ observer æœ‰éåŸºäºç«¯å£çš„ input source(source0, ç³»ç»Ÿå†…æ ¸çº¿ç¨‹å‘æ¥) å°†è¦è§¦å‘</li><li>è§¦å‘æ‰€æœ‰å·²å°±ç»ªçš„éåŸºäºç«¯å£çš„ input source</li><li>å¦‚æœä¸€ä¸ªåŸºäºç«¯å£çš„ input source(source1, ç”¨æˆ·ç«¯å£å‘æ¥) å·²å°±ç»ªå¹¶ç­‰å¾…è§¦å‘ï¼Œç«‹å³å¤„ç†äº‹ä»¶ï¼Œå¹¶è½¬è‡³ç¬¬ 9 æ­¥</li><li>é€šçŸ¥ observer çº¿ç¨‹å³å°†ä¼‘çœ </li><li>è®©çº¿ç¨‹ä¼‘çœ ï¼Œç›´åˆ°è¢«ä»¥ä¸‹æ¡ä»¶å”¤é†’ï¼š<ol><li>æœ‰åŸºäºç«¯å£çš„ input source äº‹ä»¶åˆ°è¾¾</li><li>timer è§¦å‘</li><li>run loop è®¾å®šçš„è¶…æ—¶æ—¶é—´åˆ°äº†</li><li>run loop è¢«æ‰‹åŠ¨å”¤é†’</li></ol></li><li>é€šçŸ¥ observer çº¿ç¨‹åˆšåˆšè¢«å”¤é†’</li><li>å¤„ç†å¾…å†³äº‹ä»¶<ol><li>å¦‚æœç”¨æˆ·å®šä¹‰çš„ timer è§¦å‘äº†ï¼Œå¤„ç† timer äº‹ä»¶å¹¶é‡å¯ run loopï¼Œè·³å›åˆ°ç¬¬ 2 æ­¥</li><li>å¦‚æœ input source è§¦å‘äº†ï¼Œåˆ†å‘äº‹ä»¶</li><li>å¦‚æœ run loop è¢«å”¤é†’ä¸”æ²¡æœ‰è¶…æ—¶ï¼Œé‡å¯ run loopï¼Œè·³å›åˆ°ç¬¬ 2 æ­¥</li></ol></li><li>é€šçŸ¥ observer å·²ç»é€€å‡º run loop</li></ol><details><summary>å¯¹åº”ç®€åŒ–æºç </summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CFRunLoopRunSpecific</span><span class="params">(runloop, modeName, seconds, stopAfterHandle)</span> </span>&#123;</span><br><span class="line">  CFRunLoopModeRef currentMode = __CFRunLoopFindMode(runloop, modeName, <span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// å¦‚æœmodeé‡Œæ²¡æœ‰source/timer/observer, ç›´æ¥è¿”å›ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(currentMode)) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. é€šçŸ¥ Observers: RunLoop å³å°†è¿›å…¥ loopã€‚</span></span><br><span class="line">  __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopEntry);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å†…éƒ¨å‡½æ•°ï¼Œè¿›å…¥loop</span></span><br><span class="line">  __CFRunLoopRun(runloop, currentMode, seconds, returnAfterSourceHandled) &#123;</span><br><span class="line">    Boolean sourceHandledThisLoop = NO;</span><br><span class="line">    <span class="keyword">int</span> retVal = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123; </span><br><span class="line">      <span class="comment">// 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚</span></span><br><span class="line">      __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeTimers);</span><br><span class="line">      <span class="comment">// 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚</span></span><br><span class="line">      __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeSources);</span><br><span class="line">      <span class="comment">// æ‰§è¡Œè¢«åŠ å…¥çš„block</span></span><br><span class="line">      __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚</span></span><br><span class="line">      sourceHandledThisLoop = __CFRunLoopDoSources0(runloop, currentMode, stopAfterHandle);</span><br><span class="line">      <span class="comment">// æ‰§è¡Œè¢«åŠ å…¥çš„block</span></span><br><span class="line">      __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (__Source0DidDispatchPortLastTime) &#123;</span><br><span class="line">        Boolean hasMsg = __CFRunLoopServiceMachPort(dispatchPort, &amp;msg)</span><br><span class="line">        <span class="keyword">if</span> (hasMsg) <span class="keyword">goto</span> handle_msg;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (!sourceHandledThisLoop) &#123;</span><br><span class="line">        __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopBeforeWaiting);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ã€‚</span></span><br><span class="line">      <span class="comment">// â€¢ ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚</span></span><br><span class="line">      <span class="comment">// â€¢ ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†</span></span><br><span class="line">      <span class="comment">// â€¢ RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†</span></span><br><span class="line">      <span class="comment">// â€¢ è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’</span></span><br><span class="line">      __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort) &#123;</span><br><span class="line">        mach_msg(msg, MACH_RCV_MSG, port); <span class="comment">// thread wait for receive msg</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†ã€‚</span></span><br><span class="line">      __CFRunLoopDoObservers(runloop, currentMode, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line">      handle_msg:</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (msg_is_timer) &#123;</span><br><span class="line">        __CFRunLoopDoTimers(runloop, currentMode, mach_absolute_time())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblockã€‚</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (msg_is_dispatch) &#123;</span><br><span class="line">        __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 9.3 å¦‚æœä¸€ä¸ª Source1 (åŸºäºport) å‘å‡ºäº‹ä»¶äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        CFRunLoopSourceRef source1 = __CFRunLoopModeFindSourceForMachPort(runloop, currentMode, livePort);</span><br><span class="line">        sourceHandledThisLoop = __CFRunLoopDoSource1(runloop, currentMode, source1, msg);</span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">          mach_msg(reply, MACH_SEND_MSG, reply);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰§è¡ŒåŠ å…¥åˆ°Loopçš„block</span></span><br><span class="line">      __CFRunLoopDoBlocks(runloop, currentMode);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">        <span class="comment">// è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚</span></span><br><span class="line">        retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">        <span class="comment">// è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº†</span></span><br><span class="line">        retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(runloop)) &#123;</span><br><span class="line">        <span class="comment">// è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº†</span></span><br><span class="line">        retVal = kCFRunLoopRunStopped;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(runloop, currentMode)) &#123;</span><br><span class="line">        <span class="comment">// source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº†</span></span><br><span class="line">        retVal = kCFRunLoopRunFinished;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœæ²¡è¶…æ—¶ï¼Œmodeé‡Œæ²¡ç©ºï¼Œloopä¹Ÿæ²¡è¢«åœæ­¢ï¼Œé‚£ç»§ç»­loopã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (retVal == <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 10. é€šçŸ¥ Observers: RunLoop å³å°†é€€å‡ºã€‚</span></span><br><span class="line">  __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Š RunLoop å°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-while å¾ªç¯ã€‚å½“ä½ è°ƒç”¨ CFRunLoopRun() æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼›ç›´åˆ°è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›ã€‚</p></pre></details><img src="/img/runloop_main_routine.jpg" alt="runloop" style="width:500px;height:628px"><h2 id="runloopåº•å±‚å®ç°"><a class="markdownIt-Anchor" href="#runloopåº•å±‚å®ç°"></a> RunLoopåº•å±‚å®ç°</h2><p>æ ¸å¿ƒæ˜¯æºç ä¸­çš„ç¬¬ 7 æ­¥ï¼š<br>7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’</p><ul><li>ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚</li><li>ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†</li><li>RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†</li><li>è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’</li></ul><p>mach_msg() å‡½æ•°å®é™…ä¸Šæ˜¯è°ƒç”¨äº†ä¸€ä¸ª Mach é™·é˜± (trap)ï¼Œå³å‡½æ•°mach_msg_trap()ï¼Œé™·é˜±è¿™ä¸ªæ¦‚å¿µåœ¨ Mach ä¸­ç­‰åŒäºç³»ç»Ÿè°ƒç”¨ã€‚å½“ä½ åœ¨ç”¨æˆ·æ€è°ƒç”¨ mach_msg_trap() æ—¶ä¼šè§¦å‘é™·é˜±æœºåˆ¶ï¼Œåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼›å†…æ ¸æ€ä¸­å†…æ ¸å®ç°çš„ mach_msg() å‡½æ•°ä¼šå®Œæˆå®é™…çš„å·¥ä½œï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/mach_msg.jpeg" alt="mach_msg"></p><p>ä½¿ç”¨ xcodeï¼Œå½“ç¨‹åºä¸æ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œclick debug çš„æš‚åœ<br><img src="/img/main_thread_mach_msg.jpeg" alt="main_thread_mach_msg"></p><p>åœ¨æ²¡æœ‰äº‹ä»¶å¤„ç†æ—¶ï¼š<br>Thread 1 Queue : com.apple.main-thread (serial)<br>com.apple.uikit.eventfetch-thread (6)<br>è¿™ä¸¤ä¸ªçº¿ç¨‹çš„runloopéƒ½åœç•™åœ¨mach_msg_trapçŠ¶æ€ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚</p><p>å…¶ä»–çº¿ç¨‹éƒ½æ˜¯ <a href="https://github.com/darlinghq/darling/blob/master/src/kernel/emulation/linux/bsdthread/workq_kernreturn.c" target="_blank" rel="noopener"><code>_workq_kernreturnï¼š</code></a><br>ç­‰å¾… <code>spinlock</code> æŠ€æœ¯ï¼Œä»è€Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª taskï¼ˆæˆ–è€…é€€å‡ºï¼‰</p><h2 id="runloop-æ ¸å¿ƒå¯¹è±¡çš„æºç ç»“æ„"><a class="markdownIt-Anchor" href="#runloop-æ ¸å¿ƒå¯¹è±¡çš„æºç ç»“æ„"></a> RunLoop æ ¸å¿ƒå¯¹è±¡çš„æºç ç»“æ„</h2><details><summary>RunLoop</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">  CFRuntimeBase _base;</span><br><span class="line">  __CFPort _wakeUpPort;  <span class="comment">// used for CFRunLoopWakeUp </span></span><br><span class="line">  Boolean _unused;</span><br><span class="line">  <span class="keyword">volatile</span> _per_run_data *_perRunData;  <span class="comment">// reset for runs of the run loop</span></span><br><span class="line">  <span class="keyword">pthread_t</span> _pthread;</span><br><span class="line">  CFMutableSetRef _commonModes;</span><br><span class="line">  CFMutableSetRef _commonModeItems;  </span><br><span class="line">  <span class="comment">//  CFSetAddValue(rl-&gt;_commonModeItems, rls); CFRunLoopSourceRef rlo</span></span><br><span class="line">  <span class="comment">//  CFSetAddValue(rl-&gt;_commonModeItems, rlo); CFRunLoopObserverRef rlo</span></span><br><span class="line">  CFRunLoopModeRef _currentMode;</span><br><span class="line">  CFMutableSetRef _modes;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_head</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_tail</span>;</span></span><br><span class="line">  CFAbsoluteTime _runTime;</span><br><span class="line">  CFAbsoluteTime _sleepTime;</span><br><span class="line">  CFTypeRef _counterpart;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><details><summary>RunLoopMode</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">  CFStringRef _name;</span><br><span class="line">  Boolean _stopped;</span><br><span class="line">  CFMutableSetRef _sources0;</span><br><span class="line">  CFMutableSetRef _sources1;</span><br><span class="line">  CFMutableArrayRef _observers;</span><br><span class="line">  CFMutableArrayRef _timers;</span><br><span class="line">  CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line">  __CFPortSet _portSet;</span><br><span class="line">  CFIndex _observerMask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">  <span class="keyword">dispatch_source_t</span> _timerSource;</span><br><span class="line">  <span class="keyword">dispatch_queue_t</span> _queue;</span><br><span class="line">  Boolean _timerFired; <span class="comment">// set to true by the source when a timer has fired</span></span><br><span class="line">  Boolean _dispatchTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> _timerPort;</span><br><span class="line">  Boolean _mkTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><details><summary>RunLoopSource</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopSource</span> &#123;</span></span><br><span class="line">  CFRuntimeBase _base;</span><br><span class="line">  <span class="keyword">uint32_t</span> _bits;</span><br><span class="line">  CFIndex _order;<span class="comment">/* immutable */</span></span><br><span class="line">  CFMutableBagRef _runLoops;</span><br><span class="line">  <span class="keyword">union</span> &#123;</span><br><span class="line">  CFRunLoopSourceContext version0;<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">    CFRunLoopSourceContext1 version1;<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">  &#125; _context;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><details><summary>RunLoop Observers</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopObserver</span> &#123;</span></span><br><span class="line">  CFRuntimeBase _base;</span><br><span class="line">  CFRunLoopRef _runLoop;</span><br><span class="line">  CFIndex _rlCount;</span><br><span class="line">  CFOptionFlags _activities;<span class="comment">/* immutable */</span></span><br><span class="line">  CFIndex _order;<span class="comment">/* immutable */</span></span><br><span class="line">  CFRunLoopObserverCallBack _callout;<span class="comment">/* immutable */</span></span><br><span class="line">  CFRunLoopObserverContext _context;<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><details><summary>RunLoop Timer</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopTimer</span> &#123;</span></span><br><span class="line">  CFRuntimeBase _base;</span><br><span class="line">  CFRunLoopRef _runLoop;</span><br><span class="line">  CFMutableSetRef _rlModes;</span><br><span class="line">  CFAbsoluteTime _nextFireDate;</span><br><span class="line">  CFTimeInterval _interval;<span class="comment">/* immutable */</span></span><br><span class="line">  CFTimeInterval _tolerance;      <span class="comment">/* mutable */</span></span><br><span class="line">  <span class="keyword">uint64_t</span> _fireTSR;<span class="comment">/* TSR units */</span></span><br><span class="line">  CFIndex _order;<span class="comment">/* immutable */</span></span><br><span class="line">  CFRunLoopTimerCallBack _callout;<span class="comment">/* immutable */</span></span><br><span class="line">  CFRunLoopTimerContext _context;<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></pre></details><h2 id="ä½¿ç”¨åˆ°-runloop-çš„ç›¸å…³å®è·µ"><a class="markdownIt-Anchor" href="#ä½¿ç”¨åˆ°-runloop-çš„ç›¸å…³å®è·µ"></a> ä½¿ç”¨åˆ° RunLoop çš„ç›¸å…³å®è·µ</h2><p>å…ˆåˆ†æä¸‹ç³»ç»Ÿä¸­éƒ½ä½¿ç”¨ runLoop åšäº†ä»€ä¹ˆ</p><h3 id="ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨-runloop"><a class="markdownIt-Anchor" href="#ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨-runloop"></a> ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨ RunLoop</h3><details><summary>app è¿è¡Œæ—¶ï¼Œæ‰“å°CFRunLoop å†…éƒ¨æ ·</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoop &#123;</span><br><span class="line">  current mode = kCFRunLoopDefaultMode</span><br><span class="line">  common modes = &#123;</span><br><span class="line">    UITrackingRunLoopMode,</span><br><span class="line">    kCFRunLoopDefaultMode</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  common mode items = &#123;</span><br><span class="line">  <span class="comment">// source0 (manual)</span></span><br><span class="line">    CFRunLoopSource &#123;order =<span class="number">-1</span>, &#123;callout = _UIApplicationHandleEventQueue&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order =<span class="number">-1</span>, &#123;callout = PurpleEventSignalCallback &#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>, &#123;callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// source1 (mach port)</span></span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">17923</span>&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">12039</span>&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>,  &#123;port = <span class="number">16647</span>&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order =<span class="number">-1</span>, &#123;callout = PurpleEventCallback&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>, &#123;port = <span class="number">2407</span>, callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1</span>c03, callout = __IOHIDEventSystemClientAvailabilityCallback&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">0</span>, &#123;port = <span class="number">1b</span>03, callout = __IOHIDEventSystemClientQueueCallback&#125;&#125;</span><br><span class="line">    CFRunLoopSource &#123;order = <span class="number">1</span>, &#123;port = <span class="number">1903</span>, callout = __IOMIGMachPortPortCallback&#125;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Obvserver</span></span><br><span class="line">    <span class="comment">// Entry</span></span><br><span class="line">    CFRunLoopObserver &#123;order = <span class="number">-2147483647</span>, activities = <span class="number">0x1</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; </span><br><span class="line">    <span class="comment">// BeforeWaiting</span></span><br><span class="line">    CFRunLoopObserver &#123;order = <span class="number">0</span>, activities = <span class="number">0x20</span>, callout = _UIGestureRecognizerUpdateObserver&#125; </span><br><span class="line">    <span class="comment">// BeforeWaiting | Exit</span></span><br><span class="line">    CFRunLoopObserver &#123;order = <span class="number">1999000</span>, activities = <span class="number">0xa0</span>, callout = _afterCACommitHandler&#125; </span><br><span class="line">    <span class="comment">// BeforeWaiting | Exit</span></span><br><span class="line">    CFRunLoopObserver &#123;order = <span class="number">2000000</span>, activities = <span class="number">0xa0</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125; </span><br><span class="line">    <span class="comment">// BeforeWaiting | Exit </span></span><br><span class="line">    CFRunLoopObserver &#123;order = <span class="number">2147483647</span>, activities = <span class="number">0xa0</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler&#125; </span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Timer</span></span><br><span class="line">    CFRunLoopTimer &#123;</span><br><span class="line">      firing = No, </span><br><span class="line">      interval = <span class="number">3.1536e+09</span>, </span><br><span class="line">      tolerance = <span class="number">0</span>,</span><br><span class="line">      next fire date = <span class="number">453098071</span> (<span class="number">-4421.76019</span> @ <span class="number">96223387169499</span>),</span><br><span class="line">      callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)&#125;</span><br><span class="line">  &#125;<span class="comment">// end commons,</span></span><br><span class="line"> </span><br><span class="line">  modes ï¼ &#123;</span><br><span class="line">    CFRunLoopMode  &#123;</span><br><span class="line">      sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      timers =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    CFRunLoopMode  &#123;</span><br><span class="line">      sources0 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      sources1 =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      observers = &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">      timers =  &#123; <span class="comment">/* same as 'common mode items' */</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    CFRunLoopMode  &#123;</span><br><span class="line">      sources0 = &#123; CFRunLoopSource &#123;order = <span class="number">0</span>, &#123; callout = FBSSerialQueueRunLoopSourceHandler&#125;&#125; &#125;,</span><br><span class="line">      sources1 = (null),</span><br><span class="line">      observers = &#123; CFRunLoopObserver &gt;&#123;activities = <span class="number">0xa0</span>, order = <span class="number">2000000</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv&#125;)&#125;,</span><br><span class="line">      timers = (null),</span><br><span class="line">    &#125;,</span><br><span class="line">    CFRunLoopMode  &#123;</span><br><span class="line">      sources0 = &#123;</span><br><span class="line">      CFRunLoopSource &#123;order = <span class="number">-1</span>, &#123; callout = PurpleEventSignalCallback&#125;&#125; &#125;,</span><br><span class="line">      sources1 = &#123; CFRunLoopSource &#123;order = <span class="number">-1</span>, &#123; callout = PurpleEventCallback&#125;&#125; &#125;,</span><br><span class="line">      observers = (null),</span><br><span class="line">      timers = (null),</span><br><span class="line">    &#125;,</span><br><span class="line">    CFRunLoopMode  &#123;</span><br><span class="line">      sources0 = (null),</span><br><span class="line">      sources1 = (null),</span><br><span class="line">      observers = (null),</span><br><span class="line">      timers = (null),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><p>æ‰“å¼€ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†<a href="#1">5ä¸ªMode</a>:</p><ol><li>Observerï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å†…å­˜ç®¡ç†ç›¸å…³ï¼š</span></span><br><span class="line">_wrapRunLoopWithAutoreleasePoolHandlerï¼š <span class="comment">//AutoReleasePoolæœ€é«˜ä¼˜å…ˆçº§å¤„ç† (observer)</span></span><br><span class="line">_wrapRunLoopWithAutoreleasePoolHandlerï¼š <span class="comment">//AutoReleasePoolæœ€ä½ä¼˜å…ˆçº§å¤„ç† (observer)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç•Œé¢åˆ·æ–°ç›¸å…³ï¼š</span></span><br><span class="line">afterCACommitHandlerï¼š <span class="comment">//ç›‘å¬CATransactionï¼Œåˆ·æ–°UIï¼ˆobserverï¼‰</span></span><br><span class="line">_beforeCACommitHandlerï¼š <span class="comment">//ç›‘å¬CATransaction</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰‹åŠ¿æ£€æµ‹å›è°ƒï¼šæ‰‹åŠ¿å˜åŒ–æ—¶éƒ½ä¼šè¢«è¿™ä¸ªè§‚å¯Ÿè€…æ•è·ã€‚mach_msg_trapçŠ¶æ€æ—¶ä¹Ÿéœ€è¦è¢«RunLoopå”¤é†’ä»¥åå¤„ç†ã€‚</span></span><br><span class="line">_UIGestureRecognizerUpdateObserverï¼š <span class="comment">//ç›‘å¬CATransactionï¼Œåˆ·æ–°UIï¼ˆobserverï¼‰</span></span><br></pre></td></tr></table></figure><ol start="2"><li>Sourceï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_handleHIDEventFetcherDrainï¼š <span class="comment">//é‡Šæ”¾IOHIDEventå¯¹è±¡çš„callbackï¼ˆsource0)ï¼Œæ‰€ä»¥æœ‰IOHIDEventäº‹ä»¶çš„ä½ç½®ï¼ˆé€šå¸¸æ˜¯å”¤é†’RunLoopçš„ä½ç½®ï¼‰éƒ½ä¼šæœ‰è¿™ä¸ªå›è°ƒæ–¹æ³•ã€‚</span></span><br><span class="line">_handleEventQueueï¼š <span class="comment">//ç”¨æˆ·äº‹ä»¶å›è°ƒ(source0)ï¼Œä¸€èˆ¬çš„addTarget: action: forControlEvents:æ–¹æ³•éƒ½ä¼šåŠ åœ¨source0ï¼Œå¹¶ç”±_handleEventQueueæ‰§è¡Œã€‚</span></span><br></pre></td></tr></table></figure><span id="2"><h3 id="autoreleasepool"><a class="markdownIt-Anchor" href="#autoreleasepool"></a> AutoreleasePool</h3><p>æ ¹æ®ä¸Šè¿°åˆ†æï¼Œé€šè¿‡ RunLoop Observerï¼Œç›‘å¬ RunLoop çŠ¶æ€æ¥ç®¡ç† AutoreleasePoolçš„ã€‚<br>è‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚</p><ol><li>ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</li><li>ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</li></ol><p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚</p><h3 id="äº‹ä»¶å“åº”"><a class="markdownIt-Anchor" href="#äº‹ä»¶å“åº”"></a> äº‹ä»¶å“åº”</h3><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º __IOHIDEventSystemClientQueueCallback()ã€‚</p><p>å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± IOKit.framework ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒè¿™é‡Œã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ _UIApplicationHandleEventQueue() è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚</p><p>_UIApplicationHandleEventQueue() ä¼šæŠŠ IOHIDEvent å¤„ç†å¹¶åŒ…è£…æˆ UIEvent è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚</p><h3 id="æ‰‹åŠ¿è¯†åˆ«"><a class="markdownIt-Anchor" href="#æ‰‹åŠ¿è¯†åˆ«"></a> æ‰‹åŠ¿è¯†åˆ«</h3><p>å½“ä¸Šé¢çš„ _UIApplicationHandleEventQueue() è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin/Move/End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚<br>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ _UIGestureRecognizerUpdateObserver()ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚<br>å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚</p><h3 id="ç•Œé¢æ›´æ–°"><a class="markdownIt-Anchor" href="#ç•Œé¢æ›´æ–°"></a> ç•Œé¢æ›´æ–°</h3><p>å½“åœ¨æ“ä½œ UI æ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº† Frameã€æ›´æ–°äº† UIView/CALayer çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•åï¼Œè¿™ä¸ª UIView/CALayer å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚</p><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(å³å°†è¿›å…¥ä¼‘çœ ) å’Œ Exit (å³å°†é€€å‡ºLoop) äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š<br>_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView/CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()</span><br><span class="line">    QuartzCore:CA::Transaction::observer_callback:</span><br><span class="line">        CA::Transaction::commit();</span><br><span class="line">            CA::Context::commit_transaction();</span><br><span class="line">                CA::Layer::layout_and_display_if_needed();</span><br><span class="line">                    CA::Layer::layout_if_needed();</span><br><span class="line">                        [CALayer layoutSublayers];</span><br><span class="line">                            [UIView layoutSubviews];</span><br><span class="line">                    CA::Layer::display_if_needed();</span><br><span class="line">                        [CALayer display];</span><br><span class="line">                            [UIView drawRect];</span><br></pre></td></tr></table></figure><h3 id="å®šæ—¶å™¨"><a class="markdownIt-Anchor" href="#å®šæ—¶å™¨"></a> å®šæ—¶å™¨</h3><p>NSTimer å…¶å®å°±æ˜¯ CFRunLoopTimerRefï¼Œä»–ä»¬ä¹‹é—´æ˜¯ toll-free bridged çš„ã€‚ä¸€ä¸ª NSTimer æ³¨å†Œåˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚ä¾‹å¦‚ 10:00, 10:10, 10:20 è¿™å‡ ä¸ªæ—¶é—´ç‚¹ã€‚RunLoopä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ªTimerã€‚Timer æœ‰ä¸ªå±æ€§å«åš Tolerance (å®½å®¹åº¦)ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚</p><p>å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚å°±æ¯”å¦‚ç­‰å…¬äº¤ï¼Œå¦‚æœ 10:10 æ—¶æˆ‘å¿™ç€ç©æ‰‹æœºé”™è¿‡äº†é‚£ä¸ªç‚¹çš„å…¬äº¤ï¼Œé‚£æˆ‘åªèƒ½ç­‰ 10:20 è¿™ä¸€è¶Ÿäº†ã€‚</p><p>CADisplayLink æ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡ä¸€è‡´çš„å®šæ—¶å™¨ï¼ˆä½†å®é™…å®ç°åŸç†æ›´å¤æ‚ï¼Œå’Œ NSTimer å¹¶ä¸ä¸€æ ·ï¼Œå…¶å†…éƒ¨å®é™…æ˜¯æ“ä½œäº†ä¸€ä¸ª Sourceï¼‰ã€‚å¦‚æœåœ¨ä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´æ‰§è¡Œäº†ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œé‚£å…¶ä¸­å°±ä¼šæœ‰ä¸€å¸§è¢«è·³è¿‡å»ï¼ˆå’Œ NSTimer ç›¸ä¼¼ï¼‰ï¼Œé€ æˆç•Œé¢å¡é¡¿çš„æ„Ÿè§‰ã€‚åœ¨å¿«é€Ÿæ»‘åŠ¨TableViewæ—¶ï¼Œå³ä½¿ä¸€å¸§çš„å¡é¡¿ä¹Ÿä¼šè®©ç”¨æˆ·æœ‰æ‰€å¯Ÿè§‰ã€‚Facebook å¼€æºçš„ AsyncDisplayLink å°±æ˜¯ä¸ºäº†è§£å†³ç•Œé¢å¡é¡¿çš„é—®é¢˜ï¼Œå…¶å†…éƒ¨ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œè¿™ä¸ªç¨åæˆ‘ä¼šå†å•ç‹¬å†™ä¸€é¡µåšå®¢æ¥åˆ†æã€‚</p><h3 id="performselecter"><a class="markdownIt-Anchor" href="#performselecter"></a> PerformSelecter</h3><p>å½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚</p><p>å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚</p><h3 id="å…³äºgcd"><a class="markdownIt-Anchor" href="#å…³äºgcd"></a> å…³äºGCD</h3><p>å®é™…ä¸Š RunLoop åº•å±‚ä¹Ÿä¼šç”¨åˆ° GCD çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ RunLoop æ˜¯ç”¨ dispatch_source_t å®ç°çš„ Timerï¼ˆè¯„è®ºä¸­æœ‰äººæé†’ï¼ŒNSTimer æ˜¯ç”¨äº† XNU å†…æ ¸çš„ mk_timerï¼Œæˆ‘ä¹Ÿä»”ç»†è°ƒè¯•äº†ä¸€ä¸‹ï¼Œå‘ç° NSTimer ç¡®å®æ˜¯ç”± mk_timer é©±åŠ¨ï¼Œè€Œé GCD é©±åŠ¨çš„ï¼‰ã€‚ä½†åŒæ—¶ GCD æä¾›çš„æŸäº›æ¥å£ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œ ä¾‹å¦‚ dispatch_async()ã€‚</p><p>å½“è°ƒç”¨ dispatch_async(dispatch_get_main_queue(), block) æ—¶ï¼ŒlibDispatch ä¼šå‘ä¸»çº¿ç¨‹çš„ RunLoop å‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å–å¾—è¿™ä¸ª blockï¼Œå¹¶åœ¨å›è°ƒ <strong>CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE</strong>() é‡Œæ‰§è¡Œè¿™ä¸ª blockã€‚ä½†è¿™ä¸ªé€»è¾‘ä»…é™äº dispatch åˆ°ä¸»çº¿ç¨‹ï¼Œdispatch åˆ°å…¶ä»–çº¿ç¨‹ä»ç„¶æ˜¯ç”± libDispatch å¤„ç†çš„ã€‚</p><h3 id="å…³äºç½‘ç»œè¯·æ±‚"><a class="markdownIt-Anchor" href="#å…³äºç½‘ç»œè¯·æ±‚"></a> å…³äºç½‘ç»œè¯·æ±‚</h3><p>iOS ä¸­ï¼Œå…³äºç½‘ç»œè¯·æ±‚çš„æ¥å£è‡ªä¸‹è‡³ä¸Šæœ‰å¦‚ä¸‹å‡ å±‚:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CFSocket</span><br><span class="line">CFNetwork       -&gt;ASIHttpRequest</span><br><span class="line">NSURLConnection -&gt;AFNetworking</span><br><span class="line">NSURLSession    -&gt;AFNetworking2, Alamofire</span><br></pre></td></tr></table></figure><p>â€¢ CFSocket æ˜¯æœ€åº•å±‚çš„æ¥å£ï¼Œåªè´Ÿè´£ socket é€šä¿¡ã€‚<br>â€¢ CFNetwork æ˜¯åŸºäº CFSocket ç­‰æ¥å£çš„ä¸Šå±‚å°è£…ï¼ŒASIHttpRequest å·¥ä½œäºè¿™ä¸€å±‚ã€‚<br>â€¢ NSURLConnection æ˜¯åŸºäº CFNetwork çš„æ›´é«˜å±‚çš„å°è£…ï¼Œæä¾›é¢å‘å¯¹è±¡çš„æ¥å£ï¼ŒAFNetworking å·¥ä½œäºè¿™ä¸€å±‚ã€‚<br>â€¢ NSURLSession æ˜¯ iOS7 ä¸­æ–°å¢çš„æ¥å£ï¼Œè¡¨é¢ä¸Šæ˜¯å’Œ NSURLConnection å¹¶åˆ—çš„ï¼Œä½†åº•å±‚ä»ç„¶ç”¨åˆ°äº† NSURLConnection çš„éƒ¨åˆ†åŠŸèƒ½ (æ¯”å¦‚ com.apple.NSURLConnectionLoader çº¿ç¨‹)ï¼ŒAFNetworking2 å’Œ Alamofire å·¥ä½œäºè¿™ä¸€å±‚ã€‚</p><p>ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹ NSURLConnection çš„å·¥ä½œè¿‡ç¨‹ã€‚</p><p>é€šå¸¸ä½¿ç”¨ NSURLConnection æ—¶ï¼Œä½ ä¼šä¼ å…¥ä¸€ä¸ª Delegateï¼Œå½“è°ƒç”¨äº† [connection start] åï¼Œè¿™ä¸ª Delegate å°±ä¼šä¸åœæ”¶åˆ°äº‹ä»¶å›è°ƒã€‚å®é™…ä¸Šï¼Œstart è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šä¼šè·å– CurrentRunLoopï¼Œç„¶ååœ¨å…¶ä¸­çš„ DefaultMode æ·»åŠ äº†4ä¸ª Source0 (å³éœ€è¦æ‰‹åŠ¨è§¦å‘çš„Source)ã€‚CFMultiplexerSource æ˜¯è´Ÿè´£å„ç§ Delegate å›è°ƒçš„ï¼ŒCFHTTPCookieStorage æ˜¯å¤„ç†å„ç§ Cookie çš„ã€‚</p><p>å½“å¼€å§‹ç½‘ç»œä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NSURLConnection åˆ›å»ºäº†ä¸¤ä¸ªæ–°çº¿ç¨‹ï¼šcom.apple.NSURLConnectionLoader å’Œ com.apple.CFSocket.privateã€‚å…¶ä¸­ CFSocket çº¿ç¨‹æ˜¯å¤„ç†åº•å±‚ socket è¿æ¥çš„ã€‚NSURLConnectionLoader è¿™ä¸ªçº¿ç¨‹å†…éƒ¨ä¼šä½¿ç”¨ RunLoop æ¥æ¥æ”¶åº•å±‚ socket çš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡ä¹‹å‰æ·»åŠ çš„ Source0 é€šçŸ¥åˆ°ä¸Šå±‚çš„ Delegateã€‚</p><p><img src="https://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_network.png" alt="RunLoop_network"></p><p>NSURLConnectionLoader ä¸­çš„ RunLoop é€šè¿‡ä¸€äº›åŸºäº mach port çš„ Source æ¥æ”¶æ¥è‡ªåº•å±‚ CFSocket çš„é€šçŸ¥ã€‚å½“æ”¶åˆ°é€šçŸ¥åï¼Œå…¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºå‘ CFMultiplexerSource ç­‰ Source0 å‘é€é€šçŸ¥ï¼ŒåŒæ—¶å”¤é†’ Delegate çº¿ç¨‹çš„ RunLoop æ¥è®©å…¶å¤„ç†è¿™äº›é€šçŸ¥ã€‚CFMultiplexerSource ä¼šåœ¨ Delegate çº¿ç¨‹çš„ RunLoop å¯¹ Delegate æ‰§è¡Œå®é™…çš„å›è°ƒã€‚</p><h2 id="å¼•ç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨"></a> å¼•ç”¨</h2><blockquote><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html" target="_blank" rel="noopener">Threading Programming Guide â€“ Run Loops</a><br><a href="https://developer.apple.com/documentation/corefoundation/1542137-cfrunloopaddcommonmode" target="_blank" rel="noopener">CFRunLoopAddCommonMode</a><br><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a> æœ¬æ–‡å®ä¾‹<a href="#2">ä½¿ç”¨åˆ° RunLoop çš„ç›¸å…³å®è·µ</a> å¤§é‡å‚è€ƒè¯¥æ–‡ç« ï¼Œæ•¬ä½©~<br><a href="https://en.wikipedia.org/wiki/Event_loop" target="_blank" rel="noopener">Event loop</a><br><a href="https://github.com/robbie-cao/note/blob/master/eventloop.md" target="_blank" rel="noopener">åç«¯eventloop</a><br><a href="https://en.wikipedia.org/wiki/Event-driven_programming" target="_blank" rel="noopener">Event-driven programming</a><br><a href="http://yulingtianxia.com/blog/2017/09/17/Threading-Programming-Guide-2/#Input-Sources" target="_blank" rel="noopener">Threading Programming Guide(2)</a></p></blockquote></span></span><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> runloop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Method Swizzling</title>
      <link href="/2017/08/01/deep%20analyse/Method-Swizzling/"/>
      <url>/2017/08/01/deep%20analyse/Method-Swizzling/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="method-swizzling-çš„ä½œç”¨"><a class="markdownIt-Anchor" href="#method-swizzling-çš„ä½œç”¨"></a> Method swizzling çš„ä½œç”¨</h2><p>ä»–æ˜¯ä¸€ç§ <a href="https://en.wikipedia.org/wiki/Pointer_swizzling" target="_blank" rel="noopener">äº¤æ¢æŒ‡é’ˆæŒ‡å‘</a> çš„æŠ€æœ¯ï¼Œç”¨æ¥äº¤æ¢åŸºäºåå­—æˆ–è€…ä½ç½®çš„æŒ‡é’ˆå¼•ç”¨ã€‚method swizzling å¯ä»¥é€šè¿‡äº¤æ¢ selector æ¥æ”¹å˜å‡½æ•°æŒ‡é’ˆçš„å¼•ç”¨ã€‚</p><p>Method swizzling ç”¨äºæ”¹å˜ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ selector çš„å®ç°ã€‚è¯¥æŠ€æœ¯åœ¨è¿è¡Œæ—¶é€šè¿‡æ”¹å˜ selector åœ¨ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä¸­çš„æ˜ å°„ä»è€Œæ”¹å˜åŸæœ‰æ–¹æ³•ã€‚</p><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬æƒ³è¦åœ¨ä¸€æ¬¾ iOS app ä¸­è¿½è¸ªæ¯ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨è¢«ç”¨æˆ·å‘ˆç°äº†å‡ æ¬¡ï¼š å¯ä»¥é€šè¿‡åœ¨æ¯ä¸ªè§†å›¾æ§åˆ¶å™¨çš„ viewDidAppear: æ–¹æ³•ä¸­æ·»åŠ è¿½è¸ªä»£ç æ¥å®ç°ï¼Œä½†ä¼šæœ‰å¤§é‡é‡å¤ä»£ç ã€‚ç»§æ‰¿æ˜¯å¦ä¸€ç§å¯è¡Œçš„æ–¹å¼ï¼Œä½†æ˜¯è¿™è¦æ±‚æ‰€æœ‰è¢«ç»§æ‰¿çš„è§†å›¾æ§åˆ¶å™¨å¦‚ UIViewController, UITableViewController, UINavigationController éƒ½åœ¨ viewDidAppearï¼šå®ç°è¿½è¸ªä»£ç ï¼Œè¿™åŒæ ·ä¼šé€ æˆå¾ˆå¤šé‡å¤ä»£ç ã€‚è¿™é‡Œæœ‰å¦å¤–ä¸€ç§å¯è¡Œçš„æ–¹å¼ï¼šä» category å®ç° method swizzling ã€‚ä¸‹é¢æ˜¯å®ç°æ–¹å¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">Tracking</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line"><span class="comment">// 1. å¾—åˆ°æ–¹æ³•åç§° selector</span></span><br><span class="line">    SEL originalSelector = <span class="keyword">@selector</span>(viewWillAppear:);</span><br><span class="line">    SEL swizzledSelector = <span class="keyword">@selector</span>(xxx_viewWillAppear:);</span><br><span class="line"><span class="comment">// 2. å¾—åˆ°æ–¹æ³•ç±»å‹ï¼ˆæ–¹æ³•ç­¾åï¼‰</span></span><br><span class="line">    Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When swizzling a class method, use the following:</span></span><br><span class="line">    <span class="comment">// Class class = object_getClass((id)self);</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Method originalMethod = class_getClassMethod(class, originalSelector);</span></span><br><span class="line">    <span class="comment">// Method swizzledMethod = class_getClassMethod(class, swizzledSelector);</span></span><br><span class="line"><span class="comment">// 3. ç»™ originalSelector æ·»åŠ æ–°methodçš„å®ç°å’Œå‚æ•°ç±»ï¼Œå¦‚æœoriginSelåœ¨ cls ä¸­æ²¡æœ‰å®ç°ä½“ï¼Œé‚£ä¹ˆä¼šæ·»åŠ å„ä¸€ä¸ªå®ç°ä½“ï¼Œå¹¶return YESï¼Œå¦‚æœå·²ç»æœ‰å®ç°ä½“ return NO</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">BOOL</span> didAddMethod =</span><br><span class="line">    class_addMethod(<span class="keyword">class</span>,</span><br><span class="line">                    originalSelector,</span><br><span class="line">                    method_getImplementation(swizzledMethod),</span><br><span class="line">                    method_getTypeEncoding(swizzledMethod));</span><br><span class="line">    <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">      <span class="comment">// 4. æ›¿æ¢</span></span><br><span class="line">      class_replaceMethod(<span class="keyword">class</span>,</span><br><span class="line">                          swizzledSelector,</span><br><span class="line">                          method_getImplementation(originalMethod),</span><br><span class="line">                          method_getTypeEncoding(originalMethod));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Method Swizzling</span></span><br><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">  [<span class="keyword">self</span> xxx_viewWillAppear:animated];</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p><strong>class_addMethod</strong> ã€‚è¦å…ˆå°è¯•æ·»åŠ  originSel æ˜¯ä¸ºäº†åšä¸€å±‚ä¿æŠ¤ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªç±»æ²¡æœ‰å®ç° originSel ï¼Œä½†å…¶çˆ¶ç±»å®ç°äº†ï¼Œé‚£ class_getInstanceMethod ä¼šè¿”å›çˆ¶ç±»çš„æ–¹æ³•ã€‚è¿™æ · method_exchangeImplementations æ›¿æ¢çš„æ˜¯çˆ¶ç±»çš„é‚£ä¸ªæ–¹æ³•ã€‚æ‰€ä»¥å…ˆå°è¯•æ·»åŠ  originSelï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œå†ç”¨ method_exchangeImplementations æŠŠåŸæ–¹æ³•çš„å®ç°è·Ÿæ–°çš„æ–¹æ³•å®ç°ç»™äº¤æ¢æ‰ã€‚</p><p>è¿‡ç¨‹å˜åŒ–å›¾</p><div align="left"><img src="/img/method_swizzle.jpg" alt="swizzle" style="width:450px;height:371px"></div><h2 id="åº”è¯¥åœ¨å“ªäº›åœ°æ–¹ä½¿ç”¨-method-swizzling"><a class="markdownIt-Anchor" href="#åº”è¯¥åœ¨å“ªäº›åœ°æ–¹ä½¿ç”¨-method-swizzling"></a> åº”è¯¥åœ¨å“ªäº›åœ°æ–¹ä½¿ç”¨ method swizzling</h2><h3 id="swizzling-åº”è¯¥åªåœ¨-load-ä¸­"><a class="markdownIt-Anchor" href="#swizzling-åº”è¯¥åªåœ¨-load-ä¸­"></a> swizzling åº”è¯¥åªåœ¨ +load ä¸­</h3><p>åœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ªç±»æœ‰ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚</p><ul><li>+load æ˜¯åœ¨ä¸€ä¸ªç±»è¢«åˆå§‹è£…è½½æ—¶è°ƒç”¨ï¼Œ[åªä¼šè°ƒç”¨ä¸€æ¬¡]</li><li>+initialize æ˜¯åœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•å‰è°ƒç”¨çš„ã€‚[å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡]</li></ul><p>ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ–¹æ³•è¢«å®ç°çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è°ƒç”¨ã€‚</p><h3 id="dispatch_once"><a class="markdownIt-Anchor" href="#dispatch_once"></a> dispatch_once</h3><p>swizzling åº”è¯¥åªåœ¨ dispatch_once ä¸­å®Œæˆã€‚</p><ol><li>swizzling æ”¹å˜äº†å…¨å±€çš„çŠ¶æ€</li><li>ç¡®ä¿ä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚Grand Central Dispatch çš„ dispatch_once æä¾›åŸå­æ€§</li></ol><h3 id="selectors-methods-implementations"><a class="markdownIt-Anchor" href="#selectors-methods-implementations"></a> Selectors, Methods, &amp; Implementations</h3><p>åœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œselectors, methods, implementations æŒ‡ä»£äº†ä¸åŒæ¦‚å¿µï¼Œç„¶è€Œæˆ‘ä»¬é€šå¸¸ä¼šè¯´åœ¨æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸‰ä¸ªæ¦‚å¿µæ˜¯å¯ä»¥ç›¸äº’è½¬æ¢çš„ã€‚ ä¸‹é¢æ˜¯è‹¹æœ Objective-C Runtime Referenceä¸­çš„æè¿°ï¼š</p><ul><li><code>Selectorï¼ˆtypedef struct objc_selector *SELï¼‰</code>:åœ¨è¿è¡Œæ—¶ Selectors ç”¨æ¥ä»£è¡¨ä¸€ä¸ªæ–¹æ³•çš„åå­—ã€‚Selector æ˜¯ä¸€ä¸ªåœ¨è¿è¡Œæ—¶è¢«æ³¨å†Œï¼ˆæˆ–æ˜ å°„ï¼‰çš„Cç±»å‹å­—ç¬¦ä¸²ã€‚Selectorç”±ç¼–è¯‘å™¨äº§ç”Ÿå¹¶ä¸”åœ¨å½“ç±»è¢«åŠ è½½è¿›å†…å­˜æ—¶ç”±è¿è¡Œæ—¶è‡ªåŠ¨è¿›è¡Œåå­—å’Œå®ç°çš„æ˜ å°„ã€‚</li><li><code>Methodï¼ˆtypedef struct objc_method *Methodï¼‰</code>:æ–¹æ³•æ˜¯ä¸€ä¸ªä¸é€æ˜çš„ç”¨æ¥ä»£è¡¨ä¸€ä¸ªæ–¹æ³•çš„å®šä¹‰çš„ç±»å‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Method ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_t</span> &#123;</span></span><br><span class="line">    SEL name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types;</span><br><span class="line">    MethodListIMP imp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>Implementationï¼ˆtypedef id (*IMP)(id, SEL,...)</code>ï¼‰:è¿™ä¸ªæ•°æ®ç±»å‹æŒ‡å‘ä¸€ä¸ªæ–¹æ³•çš„å®ç°çš„æœ€å¼€å§‹çš„åœ°æ–¹ã€‚è¯¥æ–¹æ³•ä¸ºå½“å‰CPUæ¶æ„ä½¿ç”¨æ ‡å‡†çš„Cæ–¹æ³•è°ƒç”¨æ¥å®ç°ã€‚è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘è°ƒç”¨æ–¹æ³•çš„è‡ªèº«ï¼ˆå³å†…å­˜ä¸­ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè‹¥æ˜¯è°ƒç”¨ç±»æ–¹æ³•ï¼Œè¯¥æŒ‡é’ˆåˆ™æ˜¯æŒ‡å‘å…ƒç±»å¯¹è±¡ metaclass ï¼‰ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿™ä¸ªæ–¹æ³•çš„åå­— selectorï¼Œè¯¥æ–¹æ³•çš„çœŸæ­£å‚æ•°ç´§éšå…¶åã€‚</li></ul><p>ç†è§£ selector, method, implementation è¿™ä¸‰ä¸ªæ¦‚å¿µä¹‹é—´å…³ç³»çš„æœ€å¥½æ–¹å¼æ˜¯ï¼šåœ¨è¿è¡Œæ—¶ï¼Œç±»ï¼ˆClassï¼‰ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯åˆ†å‘åˆ—è¡¨æ¥è§£å†³æ¶ˆæ¯çš„æ­£ç¡®å‘é€ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨çš„å…¥å£æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ˆMethodï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•æ˜ å°„äº†ä¸€å¯¹é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å€¼æ˜¯è¿™ä¸ªæ–¹æ³•çš„åå­— selectorï¼ˆSELï¼‰ï¼Œå€¼æ˜¯æŒ‡å‘è¿™ä¸ªæ–¹æ³•å®ç°çš„å‡½æ•°æŒ‡é’ˆ implementationï¼ˆIMPï¼‰ã€‚ Method swizzling ä¿®æ”¹äº†ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä½¿å¾—å·²ç»å­˜åœ¨çš„ selector æ˜ å°„äº†å¦ä¸€ä¸ªå®ç° implementationï¼ŒåŒæ—¶é‡å‘½åäº†åŸç”Ÿæ–¹æ³•çš„å®ç°ä¸ºä¸€ä¸ªæ–°çš„ selectorã€‚</p><h3 id="è°ƒç”¨-_cmd"><a class="markdownIt-Anchor" href="#è°ƒç”¨-_cmd"></a> è°ƒç”¨ _cmd</h3><p>ä¸‹é¢ä»£ç åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šå‡ºç°å¾ªç¯ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">  [<span class="keyword">self</span> xxx_viewWillAppear:animated];</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåœ¨äº¤æ¢äº†æ–¹æ³•å®ç°åå°±ä¸ä¼šå‡ºç°å¾ªç¯äº†ã€‚å¥½çš„ç¨‹åºå‘˜åº”è¯¥å¯¹è¿™é‡Œå‡ºç°çš„æ–¹æ³•çš„é€’å½’è°ƒç”¨æœ‰æ‰€è­¦è§‰ï¼Œè¿™é‡Œæˆ‘ä»¬åº”è¯¥ç†æ¸…åœ¨ method swizzling åæ–¹æ³•çš„å®ç°ç©¶ç«Ÿå˜æˆäº†ä»€ä¹ˆã€‚åœ¨äº¤æ¢äº†æ–¹æ³•çš„å®ç°åï¼Œxxx_viewWillAppear:æ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºäº† UIViewController -viewWillAppearï¼šçš„åŸç”Ÿå®ç°ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯åœ¨é€’å½’è°ƒç”¨ã€‚ç”±äº xxx_viewWillAppear: è¿™ä¸ªæ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºäº† viewWillAppear: çš„å®ç°ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†è°ƒç”¨ viewWillAppear: æ—¶ä¾¿ä¼šé€ æˆé€’å½’å¾ªç¯ã€‚</p><p>è®°ä½ç»™éœ€è¦è½¬æ¢çš„æ‰€æœ‰æ–¹æ³•åŠ ä¸ªå‰ç¼€ä»¥åŒºåˆ«åŸç”Ÿæ–¹æ³•ã€‚</p><h2 id="æ¶‰åŠ-runtime-æ–¹æ³•"><a class="markdownIt-Anchor" href="#æ¶‰åŠ-runtime-æ–¹æ³•"></a> æ¶‰åŠ <code>runtime</code> æ–¹æ³•ï¼š</h2><ol><li><p>é€šè¿‡ SEL è·å–ä¸€ä¸ªæ–¹æ³• Method<br>Method class_getInstanceMethod(Class cls, SEL name);</p></li><li><p>é€šè¿‡ Method è·å–è¯¥æ–¹æ³•çš„å®ç° IMP<br>IMP method_getImplementation(Method m);</p></li><li><p>è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæè¿°äº†æ–¹æ³•çš„å‚æ•°å’Œè¿”å›ç±»å‹<br>const char * method_getTypeEncoding(Method m);</p></li><li><p>é€šè¿‡ SEL ä»¥åŠ IMP ç»™ä¸€ä¸ªç±»æ·»åŠ æ–°çš„æ–¹æ³• Methodï¼Œå…¶ä¸­ types å°±æ˜¯ method_getTypeEncoding çš„è¿”å›å€¼ã€‚<br>BOOL class_addMethod(Class cls, SEL name, IMP imp, const char *types);</p><ol><li>å½“ cls ä¸­æœ‰ name æ–¹æ³•å®ç°ï¼Œæ·»åŠ method return NO</li><li>å½“ cls ä¸­æ²¡æœ‰ name æ–¹æ³•ï¼Œåˆ™æ·»åŠ æ–¹æ³•å®ç° return YES</li></ol></li><li><p>é€šè¿‡ç»™å®šçš„ SEL æ›¿æ¢åŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•çš„å®ç° IMPï¼Œå…¶ä¸­ SEL æ˜¯æƒ³è¦æ›¿æ¢çš„ selector åï¼ŒIMP æ˜¯æ›¿æ¢åçš„å®ç°ã€‚<br>IMP class_replaceMethod(Class cls, SEL name, IMP imp, const char *types);</p></li><li><p>äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç° IMP<br>void method_exchangeImplementations(Method m1, Method m2);</p></li></ol><h2 id="æ€è€ƒ"><a class="markdownIt-Anchor" href="#æ€è€ƒ"></a> æ€è€ƒ</h2><p>å¾ˆå¤šäººè®¤ä¸ºäº¤æ¢æ–¹æ³•å®ç°ä¼šå¸¦æ¥æ— æ³•é¢„æ–™çš„ç»“æœã€‚ç„¶è€Œé‡‡å–äº†ä»¥ä¸‹é¢„é˜²æªæ–½å, method swizzling ä¼šå˜å¾—å¾ˆå¯é ï¼š</p><ul><li>åœ¨äº¤æ¢æ–¹æ³•å®ç°åè®°å¾—è¦è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°ï¼ˆé™¤éä½ éå¸¸ç¡®å®šå¯ä»¥ä¸ç”¨è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°ï¼‰ï¼šAPIs æä¾›äº†è¾“å…¥è¾“å‡ºçš„è§„åˆ™ï¼Œè€Œåœ¨è¾“å…¥è¾“å‡ºä¸­é—´çš„æ–¹æ³•å®ç°å°±æ˜¯ä¸€ä¸ªçœ‹ä¸è§çš„é»‘ç›’ã€‚äº¤æ¢äº†æ–¹æ³•å®ç°å¹¶ä¸”ä¸€äº›å›è°ƒæ–¹æ³•ä¸ä¼šè°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å®ç°è¿™å¯èƒ½ä¼šé€ æˆåº•å±‚å®ç°çš„å´©æºƒã€‚</li><li>é¿å…å†²çªï¼šä¸ºåˆ†ç±»çš„æ–¹æ³•åŠ å‰ç¼€ï¼Œä¸€å®šè¦ç¡®ä¿è°ƒç”¨äº†åŸç”Ÿæ–¹æ³•çš„æ‰€æœ‰åœ°æ–¹ä¸ä¼šå› ä¸ºä½ äº¤æ¢äº†æ–¹æ³•çš„å®ç°è€Œå‡ºç°æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚</li><li>ç†è§£å®ç°åŸç†ï¼šåªæ˜¯ç®€å•çš„æ‹·è´ç²˜è´´äº¤æ¢æ–¹æ³•å®ç°çš„ä»£ç è€Œä¸å»ç†è§£å®ç°åŸç†ä¸ä»…ä¼šè®© App å¾ˆè„†å¼±ï¼Œå¹¶ä¸”æµªè´¹äº†å­¦ä¹  Objective-C è¿è¡Œæ—¶çš„æœºä¼šã€‚é˜…è¯» Objective-C Runtime Reference å¹¶ä¸”æµè§ˆ &lt;obje/runtime.h&gt; èƒ½å¤Ÿè®©ä½ æ›´å¥½ç†è§£å®ç°åŸç†ã€‚</li><li>æŒç»­çš„é¢„é˜²ï¼šä¸ç®¡ä½ å¯¹ä½ ç†è§£ swlzzling æ¡†æ¶ï¼ŒUIKit æˆ–è€…å…¶ä»–å†…åµŒæ¡†æ¶æœ‰å¤šè‡ªä¿¡ï¼Œä¸€å®šè¦è®°ä½æ‰€æœ‰ä¸œè¥¿åœ¨ä¸‹ä¸€ä¸ªå‘è¡Œç‰ˆæœ¬éƒ½å¯èƒ½å˜å¾—ä¸å†å¥½ä½¿ã€‚åšå¥½å‡†å¤‡ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªé»‘é­”æ³•ä¸­èµ°å¾—æ›´è¿œï¼Œä¸è¦è®©ç¨‹åºåè€Œå‡ºç°ä¸å¯æ€è®®çš„è¡Œä¸ºã€‚</li></ul><blockquote><p><a href="https://nshipster.cn/method-swizzling/" target="_blank" rel="noopener">å¼•ç”¨ Method Swizzling</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> objc </category>
          
          <category> runtime </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> åº•å±‚ </tag>
            
            <tag> objc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CollectionView ä½¿ç”¨</title>
      <link href="/2017/06/15/UI%20%E7%9B%B8%E5%85%B3/CollectionView-%E4%BD%BF%E7%94%A8/"/>
      <url>/2017/06/15/UI%20%E7%9B%B8%E5%85%B3/CollectionView-%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><h2 id="åŸºæœ¬å®ç°æ³¨æ„ç‚¹"><a class="markdownIt-Anchor" href="#åŸºæœ¬å®ç°æ³¨æ„ç‚¹"></a> åŸºæœ¬å®ç°æ³¨æ„ç‚¹</h2><p>CollectionView åœ¨å‘ˆç°çš„æ•°æ®å’Œç”¨äºå‘ˆç°è¯¥æ•°æ®çš„è§†è§‰å…ƒç´ ä¹‹é—´ä¿æŒä¸¥æ ¼çš„åŒºåˆ†ï¼ˆview + layoutï¼‰ã€‚</p><p>åŸºæœ¬ä½¿ç”¨çš„è¿‡ç¨‹ï¼š</p><ol><li>è‡ªå·±çš„å¸ƒå±€å¯¹è±¡ï¼šå­ç±»åŒ– layout</li><li>è‡ªå®šä¹‰ collectionView ä¸­çš„ itemï¼ˆcellï¼Œsupplementary views å’Œ decoration viewsï¼‰</li><li>åœ¨layout çš„ <code>prepare</code> æ–¹æ³•ä¸­è®¡ç®—å‡ºæ‰€æœ‰ attributeï¼ˆç”¨æ¥ä¿®é¥° cellï¼Œsupplementary views å’Œ decoration viewsï¼‰å¹¶ç¼“å­˜åœ¨ layout å¯¹è±¡ä¸­<ol><li>æ¯ä¸ª attribute çš„indexPathï¼Œframeï¼ŒzIndex â€¦â€¦</li><li>æ ¹æ® attribute è®¡ç®—å‡º collectionViewContentSize</li><li>è®¡ç®— attribute çš„æ•°æ®å¯ä»¥ç»™ layout è‡ªå®šä¹‰ä¸€ä¸ª delegate åè®®ï¼Œè®©ä»–å»å‘ collectionView æ‹¿</li></ol></li><li><code>layoutAttributesForElementsInRect</code> è·å–è§†å›¾çš„å¯è§çŸ©å½¢åŒºåŸŸä¸­çš„æ‰€æœ‰ UICollectionViewLayoutAttributesï¼Œç±»ä¼¼å®ç° <code>layoutAttributesForItem:atIndexPath</code>ï¼Œ <code>layoutAttributesForSupplementaryViewOfKind:atIndexPath</code> ï¼Œ<code>layoutAttributesForDecorationViewOfKind:atIndexPath</code></li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥ä½¿ç”¨ binaryTree ç®—æ³•ï¼Œå°†å¤æ‚åº¦é™åˆ° O(log(n))</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutAttributesForElements</span><span class="params">(<span class="keyword">in</span> rect: CGRect)</span></span> -&gt; [<span class="type">UICollectionViewLayoutAttributes</span>]? &#123;</span><br><span class="line">  <span class="keyword">var</span> visibleLayoutAttributes: [<span class="type">UICollectionViewLayoutAttributes</span>] = []</span><br><span class="line">  <span class="keyword">for</span> attributes <span class="keyword">in</span> cache &#123;</span><br><span class="line">    <span class="keyword">if</span> attributes.frame.intersects(rect) &#123;</span><br><span class="line">      visibleLayoutAttributes.append(attributes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> visibleLayoutAttributes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutAttributesForItem</span><span class="params">(at indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewLayoutAttributes?</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> cache[indexPath.item]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>æ˜¯å¦åˆ·æ–°é¡µé¢</li></ol><blockquote><p>å½“ collection view çš„ bounds æ”¹å˜æ—¶ï¼Œå¸ƒå±€éœ€è¦å‘Šè¯‰ collection view æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å¸ƒå±€ã€‚æˆ‘çš„çŒœæƒ³æ˜¯ï¼šå½“ collection view æ”¹å˜å¤§å°æ—¶ï¼Œå¤§å¤šæ•°å¸ƒå±€ä¼šè¢«ä½œåºŸï¼Œæ¯”å¦‚è®¾å¤‡æ—‹è½¬çš„æ—¶å€™ã€‚å› æ­¤ï¼Œä¸€ä¸ªå¹¼ç¨šçš„å®ç°å¯èƒ½åªä¼šç®€å•çš„è¿”å› YESã€‚è™½ç„¶å®ç°åŠŸèƒ½å¾ˆé‡è¦ï¼Œä½†æ˜¯ scroll view çš„ bounds åœ¨æ»šåŠ¨æ—¶ä¹Ÿä¼šæ”¹å˜ï¼Œè¿™æ„å‘³ç€ä½ çš„å¸ƒå±€æ¯ç§’ä¼šè¢«ä¸¢å¼ƒå¤šæ¬¡ã€‚æ ¹æ®è®¡ç®—çš„å¤æ‚æ€§åˆ¤æ–­ï¼Œè¿™å°†ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚<br>å½“ collection view çš„å®½åº¦æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€å¿…é¡»è¢«ä¸¢å¼ƒï¼Œä½†è¿™æ»šåŠ¨å¹¶ä¸ä¼šå½±å“åˆ°å¸ƒå±€ã€‚å¹¸è¿çš„æ˜¯ï¼Œcollection view å°†å®ƒçš„æ–° bounds ä¼ ç»™ shouldInvalidateLayoutForBoundsChange: æ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿èƒ½æ¯”è¾ƒè§†å›¾å½“å‰çš„bounds å’Œæ–°çš„ bounds æ¥ç¡®å®šè¿”å›å€¼ï¼š</p></blockquote><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">shouldInvalidateLayout</span><span class="params">(forBoundsChange newBounds: CGRect)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> oldBounds = collectionView?.bounds</span><br><span class="line">  <span class="keyword">if</span> newBounds.width != oldBounds?.width &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ-uicollectionviewh-ä¸­çš„ç±»ç»“æ„"><a class="markdownIt-Anchor" href="#åˆ†æ-uicollectionviewh-ä¸­çš„ç±»ç»“æ„"></a> åˆ†æ UICollectionView.h ä¸­çš„ç±»ç»“æ„</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">UICollectionView</span>, <span class="title">UICollectionReusableView</span>, <span class="title">UICollectionViewCell</span>, <span class="title">UICollectionViewLayout</span>, <span class="title">UICollectionViewTransitionLayout</span>, <span class="title">UICollectionViewLayoutAttributes</span>, <span class="title">UITouch</span>, <span class="title">UINib</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">UIDragItem</span>, <span class="title">UIDragPreviewParameters</span>, <span class="title">UIDragPreviewTarget</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">UICollectionViewDropProposal</span>, <span class="title">UICollectionViewPlaceholder</span>, <span class="title">UICollectionViewDropPlaceholder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">UIContextMenuConfiguration</span>, <span class="title">UITargetedPreview</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">UIContextMenuInteractionCommitAnimating</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">UIDataSourceTranslating</span>, <span class="title">UISpringLoadedInteractionContext</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">UIDragSession</span>, <span class="title">UIDropSession</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">UICollectionViewDragDelegate</span>, <span class="title">UICollectionViewDropDelegate</span>, <span class="title">UICollectionViewDropCoordinator</span>, <span class="title">UICollectionViewDropItem</span>, <span class="title">UICollectionViewDropPlaceholderContext</span>;</span></span><br></pre></td></tr></table></figure><p>å¼•ç”¨ï¼š</p><blockquote><p><a href="https://objccn.io/issue-3-3/" target="_blank" rel="noopener">è‡ªå®šä¹‰ Collection View å¸ƒå±€</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>c å¯å˜å‚æ•°å®æ•´ç†</title>
      <link href="/2017/06/01/c-%E5%AE%8F%E6%95%B4%E7%90%86/"/>
      <url>/2017/06/01/c-%E5%AE%8F%E6%95%B4%E7%90%86/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="__va_args__å’Œ__va_args__çš„ä½œç”¨"><a class="markdownIt-Anchor" href="#__va_args__å’Œ__va_args__çš„ä½œç”¨"></a> #ã€##ã€__VA_ARGS__å’Œ##__VA_ARGS__çš„ä½œç”¨</h2><h3 id="ç”¨æ¥æŠŠå‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²"><a class="markdownIt-Anchor" href="#ç”¨æ¥æŠŠå‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²"></a> <code>#</code>ç”¨æ¥æŠŠå‚æ•°è½¬æ¢æˆå­—ç¬¦ä¸²</h3><p>å®ä¾‹1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> P(A) printf(<span class="meta-string">"%s:%d\n"</span>,#A,A);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123; </span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>; </span><br><span class="line">  P(a); </span><br><span class="line">  P(b); </span><br><span class="line">  P(a+b); </span><br><span class="line">  system(<span class="string">"pause"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span></span><br><span class="line">b:<span class="number">2</span></span><br><span class="line">a+b:<span class="number">3</span></span><br></pre></td></tr></table></figure><p>å®ä¾‹2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SQUARE(x) printf(<span class="meta-string">"The square of "</span>#x<span class="meta-string">" is %d.\n"</span>, ((x)*(x)));</span></span><br><span class="line">SQUARE(<span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçš„æ˜¯ï¼šThe square of 8 is 64</p><h3 id="è¿ç®—ç¬¦å¯ä»¥ç”¨äºå®å‡½æ•°çš„æ›¿æ¢éƒ¨åˆ†"><a class="markdownIt-Anchor" href="#è¿ç®—ç¬¦å¯ä»¥ç”¨äºå®å‡½æ•°çš„æ›¿æ¢éƒ¨åˆ†"></a> <code>##</code>è¿ç®—ç¬¦å¯ä»¥ç”¨äºå®å‡½æ•°çš„æ›¿æ¢éƒ¨åˆ†</h3><p>è¿™ä¸ªè¿ç®—ç¬¦æŠŠä¸¤ä¸ªè¯­è¨€ç¬¦å·ç»„åˆæˆå•ä¸ªè¯­è¨€ç¬¦å·ï¼Œä¸ºå®æ‰©å±•æä¾›äº†ä¸€ç§è¿æ¥å®é™…å˜å…ƒçš„æ‰‹æ®µ</p><p>å®ä¾‹1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XNAME(n) x ## n</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¿™æ ·ä½¿ç”¨å®ï¼šXNAME(8)</p><p>åˆ™ä¼šè¢«å±•å¼€æˆè¿™æ ·ï¼šx8</p><p><code>##</code>å°±æ˜¯ä¸ªç²˜åˆå‰‚ï¼Œå°†å‰åä¸¤éƒ¨åˆ†ç²˜åˆèµ·æ¥ï¼Œä¹Ÿå°±æ˜¯æœ‰â€œå­—ç¬¦åŒ–â€çš„æ„æ€ã€‚ä½†æ˜¯â€œ##â€ä¸èƒ½éšæ„ç²˜åˆä»»æ„å­—ç¬¦ï¼Œå¿…é¡»æ˜¯åˆæ³•çš„Cè¯­è¨€æ ‡ç¤ºç¬¦ã€‚åœ¨å•ä¸€çš„å®å®šä¹‰ä¸­ï¼Œæœ€å¤šå¯ä»¥å‡ºç°ä¸€æ¬¡â€œ#â€æˆ–â€œ##â€é¢„å¤„ç†æ“ä½œç¬¦ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šä¸â€œ#â€æˆ–â€œ##â€é¢„å¤„ç†æ“ä½œç¬¦ç›¸å…³çš„è®¡ç®—æ¬¡åºï¼Œåˆ™ä¼šäº§ç”Ÿé—®é¢˜ã€‚ä¸ºé¿å…è¯¥é—®é¢˜ï¼Œåœ¨å•ä¸€çš„å®å®šä¹‰ä¸­åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§æ“ä½œç¬¦(å³ï¼Œä¸€ä»½â€œ#â€æˆ–ä¸€ä¸ªâ€œ##â€ï¼Œæˆ–éƒ½ä¸ç”¨)ã€‚é™¤ééå¸¸æœ‰å¿…è¦ï¼Œå¦åˆ™å°½é‡ä¸è¦ä½¿ç”¨â€œ#â€å’Œâ€œ##â€ã€‚</p><h3 id="__va_args__-æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°çš„å®"><a class="markdownIt-Anchor" href="#__va_args__-æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°çš„å®"></a> <code>__VA_ARGS__</code> æ˜¯ä¸€ä¸ªå¯å˜å‚æ•°çš„å®</h3><p>è¿™ä¸ªå¯å˜å‚æ•°çš„å®æ˜¯æ–°çš„C99è§„èŒƒä¸­æ–°å¢çš„ï¼Œç›®å‰ä¼¼ä¹åªæœ‰gccæ”¯æŒï¼ˆVC6.0çš„ç¼–è¯‘å™¨ä¸æ”¯æŒï¼‰ã€‚<br>å®ç°æ€æƒ³å°±æ˜¯å®å®šä¹‰ä¸­å‚æ•°åˆ—è¡¨çš„æœ€åä¸€ä¸ªå‚æ•°ä¸ºçœç•¥å·ï¼ˆä¹Ÿå°±æ˜¯ä¸‰ä¸ªç‚¹ï¼‰ã€‚</p><h3 id="__va_args__"><a class="markdownIt-Anchor" href="#__va_args__"></a> <code>##__VA_ARGS__</code></h3><p>å®å‰é¢åŠ ä¸Š##çš„ä½œç”¨åœ¨äºï¼Œå½“å¯å˜å‚æ•°çš„ä¸ªæ•°ä¸º0æ—¶ï¼Œè¿™é‡Œçš„##èµ·åˆ°æŠŠå‰é¢å¤šä½™çš„&quot;,&quot;å»æ‰çš„ä½œç”¨,å¦åˆ™ä¼šç¼–è¯‘å‡ºé”™</p><p>ä¸€èˆ¬è¿™ä¸ªç”¨åœ¨è°ƒè¯•ä¿¡æ¯ä¸Šå¤šä¸€ç‚¹<br>ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> my_print1(...)  printf(\_\_VA_ARGS__)</span></span><br><span class="line">my_print1(<span class="string">"i=%d,j=%d\n"</span>,i,j)  æ­£ç¡®æ‰“å°</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> my_print2(fmt,...)  printf(fmt, \_\_VA_ARGS__)  </span></span><br><span class="line"></span><br><span class="line">my_print1(<span class="string">"i=%d,j=%d\n"</span>,i,j) æ­£ç¡®æ‰“å°</span><br><span class="line"></span><br><span class="line">my_print1(<span class="string">"iiiiiii\n"</span>) ç¼–è¯‘å¤±è´¥æ‰“å°ï¼Œå› ä¸ºæ‰©å±•å‡ºæ¥åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œè‡³å°‘è¦ä¸¤ä¸ªåŠä»¥ä¸Šå‚æ•°</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">å¦‚æœæ˜¯<span class="meta">#<span class="meta-keyword">define</span> my_print2(fmt,...)  printf(fmt,##\_\_VA_ARGS__)  </span></span><br><span class="line"></span><br><span class="line">é‚£ä¹ˆ my_print1 é‡Œé¢ä¸ç®¡æ˜¯å‡ ä¸ªå‚æ•°éƒ½èƒ½æ­£ç¡®æ‰“å°</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODULE_NAME <span class="meta-string">"MY_LIB"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> error_print(fmt, ...)  printf(<span class="meta-string">"[ERROR]["</span>MODULE_NAME<span class="meta-string">"](%s|%d)"</span> fmt, __func__, __LINE__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure><h2 id="c-åº“å®-va_start"><a class="markdownIt-Anchor" href="#c-åº“å®-va_start"></a> C åº“å® - va_start()</h2><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> å¼€å‘è¯­è¨€ </category>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Masonry åˆ†æ</title>
      <link href="/2017/06/01/source-code/Masonry-%E5%88%86%E6%9E%90/"/>
      <url>/2017/06/01/source-code/Masonry-%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>åˆ†ææºç ï¼š</p><ol><li>è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œä»–è®¾è®¡çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>éœ€è¦å“ªäº›åŸºç¡€çŸ¥è¯†</li><li>æ•´ä½“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„</li><li>ç”±å¤–è€Œå†…é€å±‚åˆ†æå±‚æ¬¡ç»“æ„</li><li>æ¯ä¸ªå±‚æ¬¡ç»“æ„çš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ„å›¾ä»–ä½¿ç”¨äº†ä»€ä¹ˆæ–¹å¼ï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆä¼˜ç‚¹</li><li>ä¸ºäº†è®©ç”¨æˆ·ä½¿ç”¨æ–¹ä¾¿ï¼Œå®ç°äº†ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œä¸ºäº†å®ç°è¿™æ ·çš„æ¥å£åº•å±‚åˆæ˜¯å¦‚ä½•å®è·µçš„å‘¢ï¼Ÿ</li></ol><h2 id="masonry-æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#masonry-æ˜¯ä»€ä¹ˆ"></a> Masonry æ˜¯ä»€ä¹ˆ</h2><p><a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonryæºç </a></p><ul><li>Masonryæ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¸ƒå±€æ¡†æ¶ï¼Œå®ƒä»¥æ›´å¥½çš„è¯­æ³•åŒ…è£…äº†AutoLayout</li><li>Masonryæ‹¥æœ‰è‡ªå·±çš„å¸ƒå±€DSLï¼Œå®ƒæä¾›äº†å¯é“¾å¼è¯­æ³•æ¥æè¿°NSLayoutConstraintsï¼Œä»è€Œä½¿å¸ƒå±€ä»£ç æ›´ç®€æ´æ˜“è¯»ã€‚<br>ï¼ˆDSL å…¶å®æ˜¯ Domain Specific Language çš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰</li></ul><h2 id="ä¸ºä»€ä¹ˆè¦è®¾è®¡-masonry"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆè¦è®¾è®¡-masonry"></a> ä¸ºä»€ä¹ˆè¦è®¾è®¡ Masonry</h2><p>å¯¹æ¯”ä¸€ä¸‹ AutoLayout ä¸­ä½¿ç”¨ <code>NSLayoutConstraint</code> æ˜¯å¤šä¹ˆç³Ÿç³•</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIView</span> *superview = <span class="keyword">self</span>.view;</span><br><span class="line"><span class="built_in">UIView</span> *view1 = [[<span class="built_in">UIView</span> alloc] init];</span><br><span class="line">view1.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">view1.backgroundColor = [<span class="built_in">UIColor</span> greenColor];</span><br><span class="line">[superview addSubview:view1];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIEdgeInsets</span> padding = <span class="built_in">UIEdgeInsetsMake</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">[superview addConstraints:@[</span><br><span class="line">  <span class="comment">//view1 constraints</span></span><br><span class="line">  [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:view1</span><br><span class="line">                 attribute:<span class="built_in">NSLayoutAttributeTop</span></span><br><span class="line">                 relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                    toItem:superview</span><br><span class="line">                 attribute:<span class="built_in">NSLayoutAttributeTop</span></span><br><span class="line">                multiplier:<span class="number">1.0</span></span><br><span class="line">                  constant:padding.top],</span><br><span class="line">  ... bottom, left</span><br><span class="line">  [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:view1</span><br><span class="line">                 attribute:<span class="built_in">NSLayoutAttributeRight</span></span><br><span class="line">                 relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                    toItem:superview</span><br><span class="line">                 attribute:<span class="built_in">NSLayoutAttributeRight</span></span><br><span class="line">                multiplier:<span class="number">1</span></span><br><span class="line">                  constant:-padding.right],</span><br><span class="line"> ]];</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨ Masonry<br><span id="code1"></span></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[view1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">  make.edges.equalTo(superview).insets(padding);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>P.S. Masonry å†…éƒ¨ä¼šå¸®ä½ è°ƒç”¨ view.translatesAutoresizingMaskIntoConstraints = NO;</p><p>Masonry è®¾è®¡çš„ç›®çš„ï¼Œå°±æ˜¯ä»¥é“¾å¼ç¼–ç¨‹æ‰‹æ®µå°è£… <code>NSLayoutConstraint</code> å†—ä½™ä»£ç ï¼<br><span id="questions"></span></p><ol><li>å¦‚ä½•å¤„ç†åŸæ¥ç¹æ‚æ¥å£</li><li>å¦‚ä½•å®ç°é“¾å¼</li><li>å¦‚ä½•å°è£… <code>NSLayoutConstraint</code> çš„</li><li>ä½¿ç”¨äº†ä½•ç§ç¼–ç¨‹æ‰‹æ®µ[æ•´ä½“æ¶æ„è®¾è®¡ï¼Œè®¾è®¡æ¨¡å¼ï¼Œè¯­æ³•æŠ€å·§]</li></ol><p>å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæ ¹æ®æºç ç»“æ„åˆ†æå‡ºæ¥</p><hr><h2 id="masonry-ä»£ç ç»“æ„åˆ†æ"><a class="markdownIt-Anchor" href="#masonry-ä»£ç ç»“æ„åˆ†æ"></a> Masonry ä»£ç ç»“æ„åˆ†æ</h2><h3 id="ä»è°ƒç”¨å±‚æ¬¡åˆ†æ"><a class="markdownIt-Anchor" href="#ä»è°ƒç”¨å±‚æ¬¡åˆ†æ"></a> ä»è°ƒç”¨å±‚æ¬¡åˆ†æ</h3><p>è¿™é‡Œæˆ‘è¦åƒæ´‹è‘±ä¸€æ ·ä¸€å±‚ä¸€å±‚çš„æ‹¨å¼€</p><ol><li>æœ€å¤–å±‚æ¥å£</li></ol><p><a href="#code1">æ ¹æ®è¿™æ®µä»£ç åˆ†æ</a><br>UIView category ä¸­å®ç° View+MASAdditions.h (View+MASShorthandAdditions.h)</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define MAS_VIEW UIView</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MAS_VIEW</span> (<span class="title">MASAdditions</span>)</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)mas_makeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;</span><br><span class="line">- (<span class="built_in">NSArray</span> *)mas_updateConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;</span><br><span class="line">- (<span class="built_in">NSArray</span> *)mas_remakeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">//NSLayoutAttribute properties</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_left;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_top;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_right;</span><br><span class="line">...è¿˜æœ‰å¾ˆå¤šå¸ƒå±€å±æ€§è¿™é‡Œçœç•¥</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *(^mas_attribute)(<span class="built_in">NSLayoutAttribute</span> attr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_firstBaseline;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_lastBaseline;</span><br><span class="line"></span><br><span class="line"><span class="comment">//a key to associate with this view</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> mas_key;</span><br></pre></td></tr></table></figure><p>ä»ğŸ‘†æºç å¯ä»¥çœ‹åˆ°</p><ul><li>ä¸‰ä¸ªè§åçŸ¥æ„çš„æ–¹æ³•</li><li>æ–¹æ³•å‚æ•° <code>MASConstraintMaker</code> è¿™ä¸ªå°±æ˜¯ make</li><li>å±æ€§ <code>MASViewAttribute</code> è¿™ä¸ªå°±æ˜¯ make åé¢çš„ make.edges</li><li><code>id mas_key</code> è¿™ä¸ªæ˜¯å•¥ï¼Œç›®å‰ä¸çŸ¥é“</li></ul><p>æˆ‘æƒ³çŸ¥é“ï¼Œä»–çš„é“¾å¼æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¦‚ä½•å°è£… autolayout ç›¸å…³çš„æ•°æ®çš„ï¼Œç›®å‰çœ‹åˆ°çš„åªæ˜¯å¹³å¸¸ä½¿ç”¨çš„æ¥å£<br>æˆ‘è¿˜è¦æ‰¾åˆ° ä¸‹å›¾çš„è¿™äº›ä¿¡æ¯<br><img src="/img/view_formula.jpeg" alt="view formula"></p><ol start="2"><li>æ¥ç€å¾€é‡Œé¢çœ‹</li></ol><ul><li>MASViewAttribute: ä¸€ä¸ªä¸å¯å˜å…ƒç»„ï¼Œå­˜ç€ receiver view, related view å’Œå…³è”çš„ <code>NSLayoutAttribute</code> [æ ¹æ®æ–‡æ¡£æ³¨é‡Š]</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">readonly</span>) MAS_VIEW *view;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">readonly</span>) <span class="keyword">id</span> item;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">NSLayoutAttribute</span> layoutAttribute;</span><br></pre></td></tr></table></figure><p>ç›®å‰ç†è§£ä¸ºä¸‹å›¾ç­‰å¼çš„ç›¸å…³ä¿¡æ¯</p><ul><li>MASConstraintMakerï¼š<br>æä¾›ä¸€ä¸ªå·¥å‚æ–¹æ³•æ¥åˆ›å»º <code>MASConstraints</code>, è¿™äº› constraints åªæœ‰åœ¨è¢« installed çš„æ—¶å€™æ‰ä¼šè¢«æ”¶é›†[æ ¹æ®æ–‡æ¡£æ³¨é‡Š]</li></ul><p>MASConstraintMaker.h</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *firstBaseline;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *lastBaseline;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ˜¯å¹²å•¥çš„ï¼Ÿ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *(^attributes)(MASAttribute attrs);</span><br></pre></td></tr></table></figure><ul><li>MASConstraintï¼Ÿè·Ÿ <code>NSLayoutConstraint</code> å¥½åƒ<ul><li>å…è®¸ä½¿ç”¨å¯é“¾æ¥çš„è¯­æ³•åˆ›å»ºçº¦æŸ</li><li>çº¦æŸå¯ä»¥è¡¨ç¤ºå•ä¸ª NSLayoutConstraintï¼ˆMASViewConstraintï¼‰</li><li>æˆ–ä¸€ç»„ NSLayoutConstraintsï¼ˆMASComposisteConstraintï¼‰</li></ul></li></ul><p>bingoï¼Œåˆ°è¿™é‡Œä¸‹é¢è¿™ä¸¤ä¸ªé—®é¢˜æœ‰çœ‰ç›®äº†, <a href="#questions">æœ€å¼€å§‹çš„å‡ ä¸ªé—®é¢˜</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span> å¦‚ä½•å®ç°é“¾å¼</span><br><span class="line"><span class="number">3.</span> å¦‚ä½•å°è£… `NSLayoutConstraint` çš„</span><br></pre></td></tr></table></figure><hr><h3 id="åˆ†æ-masonry-é“¾å¼å°è£…"><a class="markdownIt-Anchor" href="#åˆ†æ-masonry-é“¾å¼å°è£…"></a> åˆ†æ <code>Masonry</code> é“¾å¼å°è£…</h3><h4 id="ä¸»è¦ç»„ä»¶ç»“æ„"><a class="markdownIt-Anchor" href="#ä¸»è¦ç»„ä»¶ç»“æ„"></a> ä¸»è¦ç»„ä»¶ç»“æ„</h4><ol><li>MASConstraintMaker</li><li>MASConstraint<ol><li>MASViewConstraint</li><li>MASComposisteConstraint</li></ol></li><li>MASConstraintDelegate</li></ol><p><img src="/img/masonry-frame.jpg" alt="masonry ä¸»è¦ç»„ä»¶"></p><hr><h4 id="ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ"><a class="markdownIt-Anchor" href="#ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ"></a> ä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆåˆ†æ</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[redView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">  make.top.equalTo(superview.mas_top).with.offset(padding); <span class="comment">//with with</span></span><br><span class="line">  make.left.equalTo(greenView.mas_right).offset(padding);   <span class="comment">//without with</span></span><br><span class="line">  make.bottom.equalTo(blueView.mas_top).offset(-padding);</span><br><span class="line">  make.right.equalTo(superview.mas_right).offset(-padding);</span><br><span class="line">  make.width.equalTo(greenView.mas_width);</span><br><span class="line">  make.height.equalTo(@[greenView, blueView]);              <span class="comment">//can pass array of views</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><details><summary>masonry call stack step1: ä¸»æµç¨‹</summary><pre><p><img src="/img/masonry-step1.jpeg" alt="step1"><br></p></pre><p></p></details><details><summary>masonry call stack step2ï¼šè°ƒç”¨block æ”¶é›†å¸ƒå±€ä¿¡æ¯</summary><pre><p><img src="/img/masonry-step2.jpeg" alt="step2"><br></p></pre><p></p></details><details><summary>masonry call stack step3ï¼šinstall constraints</summary><pre><p><img src="/img/masonry-step3.jpeg" alt="step3"><br></p></pre><p></p></details><p>æ•´ä½“æµç¨‹&amp;æ ¸å¿ƒè°ƒç”¨æ ˆåˆ†æç»“æŸåï¼Œæ¥ä¸‹æ¥å†çœ‹ç»†èŠ‚æŠ€å·§å°±å®¹æ˜“å¤šäº†</p><h3 id="ä»£ç ç»„ä»¶åˆ†æ"><a class="markdownIt-Anchor" href="#ä»£ç ç»„ä»¶åˆ†æ"></a> ä»£ç ç»„ä»¶åˆ†æ</h3><ol><li>MASConstraintMaker</li><li>MASConstraint<ol><li>MASViewConstraint</li><li>MASComposisteConstraint</li></ol></li><li>MASConstraintDelegate</li><li>MASViewAttribute</li></ol><ul><li><p><code>NSLayoutConstraint</code> çš„é—®é¢˜</p><ul><li>å¸ƒå±€æ•°æ®åˆ†æ•£ï¼Œä½¿ç”¨å‘½ä»¤å¼æ–¹æ³•è°ƒç”¨ï¼Œæ¥å£å‚æ•°å°±æ˜¯å¸ƒå±€å±æ€§ï¼Œå¯¼è‡´ç”¨æˆ·ä½¿ç”¨é—¹å¿ƒ</li></ul></li><li><p>Masonry æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ</p><ol><li>éœ€è¦åˆ›å»ºå¯¹è±¡ä¿å­˜ model æ•°æ®</li><li>åˆ›å»ºé“¾èŠ‚ç‚¹(æŠŠå¤§é‡å‚æ•°ä»¥é“¾èŠ‚ç‚¹çš„æ–¹å¼é€ä¸€æ”¾åœ¨èŠ‚ç‚¹ä¸­ï¼ˆMASViewConstraintèŠ‚ç‚¹ï¼‰)</li><li>è°ƒç”¨ç³»ç»Ÿ <code>NSLayoutConstraint</code> æ–¹æ³•</li></ol></li><li><p>æ•´ä½“æ­¥éª¤ï¼š</p><ol><li>node1: åˆ›å»º MASConstraint èŠ‚ç‚¹ï¼Œç»‘å®šç¬¬ä¸€ä¸ª item1 å’Œ attr1</li><li>node2: åˆ›å»º MASViewAttribute(item2, attr2)ï¼Œå¹¶æ·»åŠ ç­‰å¼çš„ relation (block é—­åŒ…è°ƒç”¨)</li><li>node3: æ·»åŠ  valueOffsetï¼Œpriorityï¼ŒdivideBy â€¦â€¦ å¸¸é‡æ•°æ® ï¼ˆblock é—­åŒ…ä½å•Šç”¨ï¼‰</li><li>block ç»“æŸï¼Œæ‰€æœ‰ constraint é…ç½®å®Œï¼Œè¿›è¡Œ install å†…éƒ¨è°ƒç”¨ <code>NSLayoutConstraint</code> æ–¹æ³•ï¼ŒæŠŠå¤æ‚çš„æ–¹æ³•å°è£…åœ¨å†…éƒ¨</li></ol></li></ul><hr><h4 id="model-å±‚æ•°æ®"><a class="markdownIt-Anchor" href="#model-å±‚æ•°æ®"></a> model å±‚æ•°æ®</h4><p>æ ¹æ®è¿™ä¸ªç­‰å¼ ç­‰å¼ä¿¡æ¯ï¼š<br><img src="/img/view_formula.jpeg" alt="view formula"></p><p><strong>åˆ›å»ºä¸€ä¸ª constraint éœ€è¦ï¼š</strong></p><ol><li>ä¸¤å¯¹ï¼ˆview, attr)</li><li>relation</li><li>mulity</li><li>constant</li><li>priority</li></ol><ul><li>MASViewAttribute å…ƒç»„å°è£… (item, constraintAttr)</li><li>MASViewConstraint åœ¨ MASViewAttribute åŸºç¡€ä¸Šå°è£… (mas_attr = 1.0 * mas_attr + constant)</li></ul><h5 id="ç”Ÿæˆ-masviewattribute-çš„æ–¹å¼"><a class="markdownIt-Anchor" href="#ç”Ÿæˆ-masviewattribute-çš„æ–¹å¼"></a> ç”Ÿæˆ <strong>MASViewAttribute</strong> çš„æ–¹å¼</h5><ol><li>UIView+MASAdditions</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—å±æ€§</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_left;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_top;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_right;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASViewAttribute *mas_bottom;</span><br><span class="line"></span><br><span class="line">- (MASViewAttribute *)mas_left &#123;</span><br><span class="line">  <span class="keyword">return</span> [[MASViewAttribute alloc] initWithView:<span class="keyword">self</span> layoutAttribute:<span class="built_in">NSLayoutAttributeLeft</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><code>MASConstraintMaker</code> ç”Ÿæˆé“¾æ¡èŠ‚ç‚¹ <code>MASConstraint</code> æ—¶ï¼Œä½¿ç”¨å·¥å‚æ–¹æ³•å†…éƒ¨é…ç½® <code>MASViewAttribute</code></li></ol><h5 id="masconstraint-é…ç½®è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#masconstraint-é…ç½®è¿‡ç¨‹"></a> <strong>MASConstraint</strong> é…ç½®è¿‡ç¨‹</h5><p><code>make.bottom.equalTo(blueView.mas_top).offset(-padding);</code></p><ol><li>attr1: ç”± MASConstraintMaker ä¸­çš„è®¡ç®—å±æ€§æ–¹æ³•åˆ›å»º make.top.left</li><li>relation: ç”± MASConstraint ä¸­çš„æ–¹æ³• equalTo æ·»åŠ </li><li>attr2: ç”± UIView+MASAdditions æ‰©å±•æ–¹æ³•å¾—åˆ°</li><li>offset: ç”± MASConstraint ä¸­çš„æ–¹æ³• equalTo æ·»åŠ </li><li>priority: ç”± MASConstraint ä¸­çš„æ–¹æ³• priority æ·»åŠ </li></ol><p><img src="/img/masonry_frame2.jpg" alt=""></p><hr><h4 id="å¸ƒå±€å·¥å‚-masconstraintmaker"><a class="markdownIt-Anchor" href="#å¸ƒå±€å·¥å‚-masconstraintmaker"></a> å¸ƒå±€å·¥å‚ MASConstraintMaker</h4><p>ä»–çš„ product æ˜¯ <code>MASConstraint</code></p><ol><li>ä»–çš„å·¥å‚æ–¹æ³•</li></ol><p><span id="anchor"></span></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è®¡ç®—å±æ€§ï¼Œæˆ‘ç†è§£ä¸ºå·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *bottom;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—å±æ€§çš„ get æ–¹æ³•</span></span><br><span class="line">- (MASConstraint *)top &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> addConstraintWithLayoutAttribute:<span class="built_in">NSLayoutAttributeTop</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (MASConstraint *)addConstraintWithLayoutAttribute:(<span class="built_in">NSLayoutAttribute</span>)layoutAttribute &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> constraint:<span class="literal">nil</span> addConstraintWithLayoutAttribute:layoutAttribute];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. çœŸæ­£çš„å·¥å‚æ–¹æ³•ï¼ŒåŒæ—¶ ä»–ä¹Ÿæ˜¯ ç»™ constraint æ·»åŠ  NSLayoutAttribute çš„åœ°æ–¹</span></span><br><span class="line">- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(<span class="built_in">NSLayoutAttribute</span>)layoutAttribute &#123;</span><br><span class="line"></span><br><span class="line">  MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] initWithView:<span class="keyword">self</span>.view layoutAttribute:layoutAttribute];</span><br><span class="line">  MASViewConstraint *newConstraint = [[MASViewConstraint alloc] initWithFirstViewAttribute:viewAttribute];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.2 make.top.left.equalTo(superview).insets(padding); [left èŠ‚ç‚¹çš„æ—¶å€™è°ƒç”¨ï¼Œäº§ç”Ÿç¬¬äºŒä¸ª èŠ‚ç‚¹ä»¥åæ‰€æœ‰èŠ‚ç‚¹çš„æ–¹æ³•]</span></span><br><span class="line">  <span class="keyword">if</span> ([constraint isKindOfClass:MASViewConstraint.class]) &#123;</span><br><span class="line">    <span class="comment">//replace with composite constraint</span></span><br><span class="line">    <span class="built_in">NSArray</span> *children = @[constraint, newConstraint];</span><br><span class="line">    MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children];</span><br><span class="line">    compositeConstraint.delegate = <span class="keyword">self</span>;</span><br><span class="line">    [<span class="keyword">self</span> constraint:constraint shouldBeReplacedWithConstraint:compositeConstraint];</span><br><span class="line">    <span class="keyword">return</span> compositeConstraint;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1 make.top.left.equalTo(superview).insets(padding); [top èŠ‚ç‚¹çš„æ—¶å€™è°ƒç”¨ï¼Œäº§ç”Ÿç¬¬ä¸€ä¸ª èŠ‚ç‚¹çš„æ–¹æ³•]</span></span><br><span class="line">  <span class="keyword">if</span> (!constraint) &#123;</span><br><span class="line">    newConstraint.delegate = <span class="keyword">self</span>;</span><br><span class="line">    [<span class="keyword">self</span>.constraints addObject:newConstraint];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newConstraint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¾—å‡ºç»“è®ºï¼š</strong></p><ol><li>æ ¹æ®ä¸Šé¢ä»£ç ä¸­çš„ 2.1ï¼Œ2.2 çŸ¥é“ make.left.right.topâ€¦â€¦ ä¼šç”Ÿäº§ 3 ä¸ª MASViewConstraintï¼Œå¹¶ç»„åˆåˆ° MASCompositeConstraint é‡Œé¢</li></ol><p>2333 è¿™å°±çŸ¥é“äº† ä¸ºä»€ä¹ˆè¦æœ‰ MASCompositeConstraintï¼Œä»–çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯ å®ç°é“¾å¼å…¼å®¹å•Šï¼ï¼ˆå› ä¸ºèµ¤è£¸è£¸çš„ 3ä¸ª MASViewConstraintï¼Œæ€ä¹ˆå˜æˆä¸€ä¸ª èŠ‚ç‚¹å•Šï¼‰<br>é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œmake.left.right.top(view)ï¼Œæ˜¯æ€ä¹ˆå®ç° left = view.left, right = view.right â€¦â€¦ çš„å‘¢ï¼Ÿ</p><ol start="2"><li>ç­‰å¼å…³ç³»ï¼Œä½¿ç”¨å‡½æ•°è¡¨ç¤ºï¼Œå†…éƒ¨ç›´æ¥æŠŠå¯¹åº” relation é…ç½®ç»™ constraint</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (MASConstraint * (^)(<span class="keyword">id</span> attr))mas_equalTo;</span><br><span class="line">- (MASConstraint * (^)(<span class="keyword">id</span> attr))mas_greaterThanOrEqualTo;</span><br><span class="line">- (MASConstraint * (^)(<span class="keyword">id</span> attr))mas_lessThanOrEqualTo;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ¥ä¸‹æ¥çš„é“¾å¼éƒ½æ˜¯ç”¨å‡½æ•°é—­åŒ…çš„æ–¹å¼ï¼ŒæŠŠå‚æ•°ä¼ ç»™ constraint çš„ [é—­åŒ…æ ¼å¼ MASConstraint * (^)(parameter å‚æ•°)]</li><li>MASConstraintDelegate æ˜¯å·¥å‚æ–¹æ³•åè®®, ä» <a href="#anchor">è¿™æ®µä»£ç çš„ 2 çœ‹</a>ï¼Œä»–æ˜¯è®© constraint ç”Ÿæˆ constraint çš„æ–¹æ³•è¿‡æ¸¡ç‚¹ã€‚<ol><li>ä»–æ˜¯ä¸ºäº†æ»¡è¶³ make.top.left ä¸­ top.left é€šè¿‡ topConstraint ç”Ÿæˆä¸€ä¸ª leftConstraintçš„æ–¹æ³•</li></ol></li><li>æ‰€ä»¥å¯¹äºé“¾å¼ç¼–ç¨‹æŠ€å·§ï¼š<ol><li>é“¾æ¡çš„å¼€å§‹ï¼Œåˆ›å»ºæˆé“¾çš„èµ·å§‹èŠ‚ç‚¹å¯¹è±¡</li><li>ä¸€æ¡é“¾ä¸Šåº”è¯¥åªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œåé¢çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å¯¹äºè¿™ä¸ªå¯¹è±¡çš„å±æ€§é…ç½®æ·»åŠ </li><li>å¦‚æœåŒä¸€æ¡é“¾ä¸Šæœ‰å¤šä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆä½¿ç”¨ç»„åˆæ¨¡å¼ï¼ŒæŠŠå¤šä¸ªèŠ‚ç‚¹å¯¹è±¡å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡</li></ol></li></ol><p><img src="/img/masonry-call-stack.jpg" alt="ä»ä¸Šé¢å¾—åˆ°"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é—­åŒ…ä¼ ï¼Ÿä½¿ç”¨æ–¹æ³•æ¶ˆæ¯ä¼ ä¸å¥½å—ï¼Ÿ</span><br><span class="line">å¥½åƒå°±æ˜¯ä¸ºäº†ä¸è¦ `[]` è¿™ä¸ªç¬¦å·å§â€¦â€¦ï¼Œä½¿ç”¨ `.` é“¾å¼è°ƒç”¨çœ‹ç€å¥½çœ‹</span><br></pre></td></tr></table></figure><hr><h3 id="å…¶ä»–å¼€å‘ç»†èŠ‚åˆ†æ"><a class="markdownIt-Anchor" href="#å…¶ä»–å¼€å‘ç»†èŠ‚åˆ†æ"></a> å…¶ä»–å¼€å‘ç»†èŠ‚åˆ†æ</h3><p>ä¸‹é¢è¿™äº›æ˜¯å•¥ï¼Ÿ<br>éƒ½æ˜¯ä¸€äº› c è¯­è¨€çš„å®ï¼Œåœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†æè¿‡äº†</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MASUtilities.h</span></span><br><span class="line"><span class="meta">#define MASAttachKeys(...)                                                        \</span></span><br><span class="line">  &#123;                                                                             \</span><br><span class="line">    <span class="built_in">NSDictionary</span> *keyPairs = <span class="built_in">NSDictionaryOfVariableBindings</span>(__VA_ARGS__);     \</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> key <span class="keyword">in</span> keyPairs.allKeys) &#123;                                        \</span><br><span class="line">      <span class="keyword">id</span> obj = keyPairs[key];                                               \</span><br><span class="line">      <span class="built_in">NSAssert</span>([obj respondsToSelector:<span class="keyword">@selector</span>(setMas_key:)],             \</span><br><span class="line">               <span class="string">@"Cannot attach mas_key to %@"</span>, obj);                        \</span><br><span class="line">      [obj setMas_key:key];                                                 \</span><br><span class="line">    &#125;                                                                         \</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">id</span> _MASBoxValue(<span class="keyword">const</span> <span class="keyword">char</span> *type, ...)</span><br><span class="line"><span class="meta">#define MASBoxValue(value) _MASBoxValue(@encode(__typeof__((value))), (value))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//View+MASShorthandAdditions.h</span></span><br><span class="line"><span class="meta">#define MAS_ATTR_FORWARD(attr)  \</span></span><br><span class="line">- (MASViewAttribute *)attr &#123;    \</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> mas_<span class="meta">##attr];   \</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#define MAS_ATTR_FORWARD_AVAILABLE(attr, available)  \</span></span><br><span class="line">- (MASViewAttribute *)attr available &#123;    \</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> mas_<span class="meta">##attr];   \</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MASConstraint.h</span></span><br><span class="line"><span class="meta">#define mas_equalTo(...)                 equalTo(MASBoxValue((__VA_ARGS__)))</span></span><br><span class="line"><span class="meta">#define mas_greaterThanOrEqualTo(...)    greaterThanOrEqualTo(MASBoxValue((__VA_ARGS__)))</span></span><br><span class="line"><span class="meta">#define mas_lessThanOrEqualTo(...)       lessThanOrEqualTo(MASBoxValue((__VA_ARGS__)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define mas_offset(...)                  valueOffset(MASBoxValue((__VA_ARGS__)))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#ifdef MAS_SHORTHAND_GLOBALS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define equalTo(...)                     mas_equalTo(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#define greaterThanOrEqualTo(...)        mas_greaterThanOrEqualTo(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#define lessThanOrEqualTo(...)           mas_lessThanOrEqualTo(__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define offset(...)                      mas_offset(__VA_ARGS__)</span></span><br></pre></td></tr></table></figure><h4 id="runtime-çš„è¿ç”¨"><a class="markdownIt-Anchor" href="#runtime-çš„è¿ç”¨"></a> runtime çš„è¿ç”¨</h4><p>ä¸»è¦æ˜¯ç»™ view æ·»åŠ å…³è”å¯¹è±¡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MASViewConstraint.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MAS_VIEW</span> (<span class="title">MASConstraints</span>)</span></span><br><span class="line"><span class="comment">// è§åçŸ¥æ„</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSMutableSet</span> *mas_installedConstraints; </span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MAS_VIEW</span> (<span class="title">MASConstraints</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> kInstalledConstraintsKey; </span><br><span class="line">- (<span class="built_in">NSMutableSet</span> *)mas_installedConstraints &#123;</span><br><span class="line">  <span class="built_in">NSMutableSet</span> *constraints = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;kInstalledConstraintsKey);</span><br><span class="line">  <span class="keyword">if</span> (!constraints) &#123;</span><br><span class="line">    constraints = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;kInstalledConstraintsKey, constraints, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> constraints;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//View+MASAdditions.m</span></span><br><span class="line">- (<span class="keyword">id</span>)mas_key &#123;</span><br><span class="line">  <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(mas_key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setMas_key:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">  objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(mas_key), key, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mas_key æ˜¯ä¸ºäº†è°ƒè¯•å¸ƒå±€ç”¨çš„</p><ul><li><a href="https://www.jianshu.com/p/710f742ca71a" target="_blank" rel="noopener">Masonry å¸ƒå±€å†²çªå¿«é€Ÿå®šä½</a></li><li><a href="https://www.jianshu.com/p/e36db45b764a" target="_blank" rel="noopener">å¦‚ä½•å¿«é€Ÿå®šä½å“ªä¸ª View å‡ºç°äº†çº¦æŸè­¦å‘Šï¼Ÿ</a></li></ul><blockquote><p><a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/AutolayoutPG/index.html#//apple_ref/doc/uid/TP40010853-CH7-SW1" target="_blank" rel="noopener">Auto Layout Guide</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> UI å¸ƒå±€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS View ç¼–ç¨‹æŒ‡å—</title>
      <link href="/2017/05/15/UI%20%E7%9B%B8%E5%85%B3/iOS-View-%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97/"/>
      <url>/2017/05/15/UI%20%E7%9B%B8%E5%85%B3/iOS-View-%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="view-å’Œ-window-æ¶æ„"><a class="markdownIt-Anchor" href="#view-å’Œ-window-æ¶æ„"></a> View å’Œ Window æ¶æ„</h2><h3 id="view-ç»“æ„åŸºç¡€"><a class="markdownIt-Anchor" href="#view-ç»“æ„åŸºç¡€"></a> View ç»“æ„åŸºç¡€</h3><p>layer ç®¡ç† view è¾…åŠ©å­˜å‚¨å™¨ï¼Œå¤„ç†view ç›¸å…³çš„åŠ¨ç”»ã€‚</p><h4 id="view-å±‚çº§å’Œå­view-ç®¡ç†"><a class="markdownIt-Anchor" href="#view-å±‚çº§å’Œå­view-ç®¡ç†"></a> View å±‚çº§å’Œå­view ç®¡ç†</h4><h4 id="view-ç»˜åˆ¶å¾ªç¯"><a class="markdownIt-Anchor" href="#view-ç»˜åˆ¶å¾ªç¯"></a> View ç»˜åˆ¶å¾ªç¯</h4><p>UIViewç±»ä½¿ç”¨æŒ‰éœ€ç»˜åˆ¶æ¨¡å‹æ¥å‘ˆç°å†…å®¹ã€‚å½“è§†å›¾é¦–æ¬¡å‡ºç°åœ¨å±å¹•ä¸Šæ—¶ï¼Œç³»ç»Ÿè¦æ±‚å®ƒç»˜åˆ¶å…¶å†…å®¹ã€‚ç³»ç»Ÿæ•è·è¯¥å†…å®¹çš„å¿«ç…§å¹¶å°†è¯¥å¿«ç…§ç”¨ä½œ view çš„è§†è§‰è¡¨ç¤ºã€‚å¦‚æœä¸æ›´æ”¹è§†å›¾çš„å†…å®¹ï¼Œåˆ™å¯èƒ½æ°¸è¿œä¸ä¼šå†æ¬¡è°ƒç”¨è§†å›¾çš„ç»˜å›¾ä»£ç ã€‚å¿«ç…§å›¾åƒå¯ç”¨äºæ¶‰åŠè§†å›¾çš„å¤§å¤šæ•°æ“ä½œã€‚å¦‚æœæ›´æ”¹äº†å†…å®¹ï¼Œåˆ™ä¼šé€šçŸ¥ç³»ç»Ÿè§†å›¾å·²æ›´æ”¹ã€‚ç„¶åï¼Œè§†å›¾é‡å¤ç»˜åˆ¶è§†å›¾å’Œæ•è·æ–°ç»“æœå¿«ç…§çš„è¿‡ç¨‹ã€‚å½“è§†å›¾çš„å†…å®¹æ›´æ”¹æ—¶ï¼Œæ‚¨ä¸ä¼šç›´æ¥é‡ç»˜è¿™äº›æ›´æ”¹ã€‚è€Œæ˜¯ä½¿ç”¨setNeedsDisplayæˆ–setNeedsDisplayInRectï¼šæ–¹æ³•ä½¿è§†å›¾æ— æ•ˆã€‚è¿™äº›æ–¹æ³•å‘Šè¯‰ç³»ç»Ÿè§†å›¾çš„å†…å®¹å·²æ›´æ”¹ï¼Œå¹¶ä¸”éœ€è¦åœ¨ä¸‹ä¸€ä¸ªæœºä¼šé‡æ–°ç»˜åˆ¶ã€‚åœ¨å¯åŠ¨ä»»ä½•ç»˜å›¾æ“ä½œä¹‹å‰ï¼Œç³»ç»Ÿå°†ä¸€ç›´ç­‰åˆ°å½“å‰è¿è¡Œå¾ªç¯ç»“æŸã€‚è¿™ç§å»¶è¿Ÿä½¿ä½ æœ‰æœºä¼šä¸€æ¬¡ä½¿å¤šä¸ªè§†å›¾æ— æ•ˆï¼Œä»å±‚æ¬¡ç»“æ„ä¸­æ·»åŠ æˆ–åˆ é™¤è§†å›¾ï¼Œéšè—è§†å›¾ï¼Œè°ƒæ•´è§†å›¾å¤§å°ä»¥åŠé‡æ–°æ”¾ç½®è§†å›¾ã€‚æ‰€åšçš„æ‰€æœ‰æ›´æ”¹éƒ½å°†åŒæ—¶åæ˜ å‡ºæ¥ã€‚</p><p>é—®é¢˜ï¼šéƒ½æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å‡ºå‘è§†å›¾é‡æ–°ç»˜åˆ¶ï¼Ÿ</p><h4 id="å†…å®¹-modes"><a class="markdownIt-Anchor" href="#å†…å®¹-modes"></a> å†…å®¹ Modes</h4><h4 id="å¯æ‹‰ä¼¸-views"><a class="markdownIt-Anchor" href="#å¯æ‹‰ä¼¸-views"></a> å¯æ‹‰ä¼¸ Views</h4><h4 id="å†…å»ºåŠ¨ç”»æ”¯æŒ"><a class="markdownIt-Anchor" href="#å†…å»ºåŠ¨ç”»æ”¯æŒ"></a> å†…å»ºåŠ¨ç”»æ”¯æŒ</h4><h3 id="view-å‡ ä½•å’Œåæ ‡ç³»"><a class="markdownIt-Anchor" href="#view-å‡ ä½•å’Œåæ ‡ç³»"></a> View å‡ ä½•å’Œåæ ‡ç³»</h3><h4 id="the-relationship-of-the-frame-bounds-and-center-properties"><a class="markdownIt-Anchor" href="#the-relationship-of-the-frame-bounds-and-center-properties"></a> The Relationship of the Frame, Bounds, and Center Properties</h4><h4 id="åæ ‡ç³»è½¬æ¢"><a class="markdownIt-Anchor" href="#åæ ‡ç³»è½¬æ¢"></a> åæ ‡ç³»è½¬æ¢</h4><p>CGContextGetCTM<br>Returns the current transformation matrix.</p><h4 id="points-versus-pixels"><a class="markdownIt-Anchor" href="#points-versus-pixels"></a> Points Versus Pixels</h4><h3 id="the-runtime-interaction-model-for-views"><a class="markdownIt-Anchor" href="#the-runtime-interaction-model-for-views"></a> The Runtime Interaction Model for Views</h3><h3 id="tips-for-using-views-effectively"><a class="markdownIt-Anchor" href="#tips-for-using-views-effectively"></a> Tips for Using Views Effectively</h3><h4 id="views-do-not-always-have-a-corresponding-view-controller"><a class="markdownIt-Anchor" href="#views-do-not-always-have-a-corresponding-view-controller"></a> Views Do Not Always Have a Corresponding View Controller</h4><h4 id="minimize-custom-drawing"><a class="markdownIt-Anchor" href="#minimize-custom-drawing"></a> Minimize Custom Drawing</h4><h4 id="take-advantage-of-content-modes"><a class="markdownIt-Anchor" href="#take-advantage-of-content-modes"></a> Take Advantage of Content Modes</h4><h4 id="declare-views-as-opaque-whenever-possible"><a class="markdownIt-Anchor" href="#declare-views-as-opaque-whenever-possible"></a> Declare Views as Opaque Whenever Possible</h4><h4 id="adjust-your-views-drawing-behavior-when-scrolling"><a class="markdownIt-Anchor" href="#adjust-your-views-drawing-behavior-when-scrolling"></a> Adjust Your Viewâ€™s Drawing Behavior When Scrolling</h4><h4 id="do-not-customize-controls-by-embedding-subviews"><a class="markdownIt-Anchor" href="#do-not-customize-controls-by-embedding-subviews"></a> Do Not Customize Controls by Embedding Subviews</h4><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> Guide </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Swift é¢å‘åè®®ç¼–ç¨‹</title>
      <link href="/2017/05/14/swift%20%E8%AF%AD%E6%B3%95/Swift-%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/"/>
      <url>/2017/05/14/swift%20%E8%AF%AD%E6%B3%95/Swift-%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><p>WWDC 2015<br>Developer Tools<br>Protocol-Oriented Programming in Swift<br>Session 408</p><h2 id="class"><a class="markdownIt-Anchor" href="#class"></a> Class</h2><p>é¢å‘å¯¹è±¡çš„è®¾è®¡æ€æƒ³</p><ol><li>å°è£…ï¼šæŠŠç›¸å…³æ•°æ®å’Œæ“ä½œè¿›è¡Œåˆ†ç»„</li><li>è®¿é—®æ§åˆ¶ï¼šæ„å»ºä¸€é¢å¢™æŠŠé‡Œé¢ä»£ç å’Œå¤–é¢ä»£ç åˆ†å¼€</li><li>æŠ½è±¡æ¥å£ï¼šæŠ½è±¡æ¥å£è¡¨è¾¾ç±»çš„ä½œç”¨å’Œé€šè®¯åŠŸèƒ½</li><li>å‘½åç©ºé—´ï¼šé¿å…ä»£ç åç§°å†²çª</li><li>Expressive syntaxï¼šè¡¨è¾¾å¼è¯­æ³•ï¼ˆä¸‹æ ‡æ‰©å±•ï¼‰</li><li>extension æ‰©å±•æ€§ï¼šå¿˜äº†ç»™ç±»åŠ ä¸œè¥¿ï¼Œå¯ä»¥ä½¿ç”¨ extension ç»™ä»–åŠ ä¸Š</li></ol><p>ä½†æ˜¯ï¼Œåœ¨ swift é‡Œä¸Šé¢çš„è¿™äº›éƒ½å¯ä»¥ç”¨ struct or enum åš</p><p>Building Better Apps with Value Types in Swift</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
          <category> WWDC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> WWDC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RAC-å­¦ä¹ ç¬”è®°01</title>
      <link href="/2017/04/06/RxSwfit+RAC/RAC-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/"/>
      <url>/2017/04/06/RxSwfit+RAC/RAC-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><a id="more"></a><h2 id="å­¦ä¹ ç›®çš„"><a class="markdownIt-Anchor" href="#å­¦ä¹ ç›®çš„"></a> å­¦ä¹ ç›®çš„</h2><ol><li>çŸ¥é“ rac éƒ½æœ‰ä»€ä¹ˆ</li><li>çŸ¥é“ä»–ä»¬éƒ½æ€ä¹ˆç”¨</li><li>çŸ¥é“ä¸ºä»€ä¹ˆæœ‰è¿™äº›ä¸œè¥¿</li><li>æ ¹ç±»å½’çº³æ•´ç†</li><li>å¦‚ä½•è‡ªå·±æ‰©å±•</li><li>é€‚å½“åˆ†ææºç </li></ol><h2 id="ä¸»è¦æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#ä¸»è¦æ¦‚å¿µ"></a> ä¸»è¦æ¦‚å¿µ</h2><ol><li>ä¿¡å·</li><li>ä¿¡å·å˜æ¢&amp;ç»„åˆ</li><li>è®¢é˜…ï¼ˆç»‘å®šï¼‰</li><li>å–æ¶ˆè®¢é˜…</li></ol><p><img src="/img/RACStream.jpeg" alt="RACStream"></p><p>RACSignal : åŸºäºæ—¶é—´çš„å¼‚æ­¥äº‹ä»¶æµ</p><p>RACSequence : æƒ°æ€§é›†åˆï¼ŒåŒæ­¥ï¼ˆå¾ˆå°‘ç”¨ï¼‰ï¼Œcollectionç±»å‹çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ Streamï¼ˆmonadï¼‰å°è£…çš„å‡½æ•°å¼æ–¹å¼</p><h2 id="å¦‚ä½•åˆ›å»ºä¿¡å·"><a class="markdownIt-Anchor" href="#å¦‚ä½•åˆ›å»ºä¿¡å·"></a> å¦‚ä½•åˆ›å»ºä¿¡å·</h2><h3 id="å•å…ƒä¿¡å·"><a class="markdownIt-Anchor" href="#å•å…ƒä¿¡å·"></a> å•å…ƒä¿¡å·</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *sig0 = [RACSignal error:<span class="built_in">NSError</span>.new];</span><br><span class="line">RACSignal *sig1 = [RACSignal <span class="keyword">return</span>:@<span class="number">0</span>];</span><br><span class="line">RACSignal *sig2 = [RACSignal empty];</span><br><span class="line">RACSignal *sig3 = [RACSignal never];</span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€ä¿¡å·"><a class="markdownIt-Anchor" href="#åŠ¨æ€ä¿¡å·"></a> åŠ¨æ€ä¿¡å·</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *s = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  [subscriber sendNext:@<span class="number">0</span>];</span><br><span class="line">  [subscriber sendCompleted];</span><br><span class="line">  <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line"></span><br><span class="line">  &#125;];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="cocoa-æ¡¥æ¥"><a class="markdownIt-Anchor" href="#cocoa-æ¡¥æ¥"></a> Cocoa æ¡¥æ¥</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) bridge &#123;</span><br><span class="line">  RACSignal *sO = RACObserver(<span class="keyword">self</span>, button);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.sigSetFrame = [<span class="keyword">self</span>.button rac_signalForSelector:<span class="keyword">@selector</span>(setFrame:)];</span><br><span class="line">  [_sigSetFrame</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"setFrame:%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">self</span>.sigClick = [<span class="keyword">self</span>.button rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">  [_sigClick</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"event: %@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line"></span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignals:_sigClick, <span class="literal">nil</span>]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalsFromArray:@[[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">  &#125;]]]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@<span class="number">1</span>)]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>) lift:(<span class="keyword">id</span>)value&#123;</span><br><span class="line">  printf(<span class="string">"lift: %s"</span>, __func__);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·å˜åŒ–å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„"><a class="markdownIt-Anchor" href="#ä¿¡å·å˜åŒ–å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„"></a> ä¿¡å·å˜åŒ–(å†…éƒ¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°ä¿¡å·çš„)</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">  <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="åºåˆ—è½¬æ¢"><a class="markdownIt-Anchor" href="#åºåˆ—è½¬æ¢"></a> åºåˆ—è½¬æ¢</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.sigSequence = [[RACSequence <span class="keyword">return</span>:@<span class="number">3</span>] concat:[RACSequence <span class="keyword">return</span>:@<span class="number">4</span>]].signal;</span><br></pre></td></tr></table></figure><h2 id="è®¢é˜…ç»‘å®šä¿¡å·çš„æ–¹å¼"><a class="markdownIt-Anchor" href="#è®¢é˜…ç»‘å®šä¿¡å·çš„æ–¹å¼"></a> è®¢é˜…ï¼ˆç»‘å®šï¼‰ä¿¡å·çš„æ–¹å¼</h2><h3 id="ç›´æ¥è®¢é˜…æ–¹æ³•"><a class="markdownIt-Anchor" href="#ç›´æ¥è®¢é˜…æ–¹æ³•"></a> ç›´æ¥è®¢é˜…æ–¹æ³•</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.sigSample</span><br><span class="line"> subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"sample: %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="ç»‘å®š"><a class="markdownIt-Anchor" href="#ç»‘å®š"></a> ç»‘å®š</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAC(<span class="keyword">self</span>, a) = Signal;</span><br></pre></td></tr></table></figure><h3 id="cocoa-æ¡¥æ¥-2"><a class="markdownIt-Anchor" href="#cocoa-æ¡¥æ¥-2"></a> Cocoa æ¡¥æ¥</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)signal &#123;</span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignals:_sigClick, <span class="literal">nil</span>]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalsFromArray:@[[_sigClick map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> @[@<span class="number">3</span>];</span><br><span class="line">  &#125;]]]</span><br><span class="line">   subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</span><br><span class="line">  &#125;];</span><br><span class="line">  </span><br><span class="line">  [<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(lift:) withSignalOfArguments:[_sigClick mapReplace:RACTuplePack(@<span class="number">1</span>)]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>) lift:(<span class="keyword">id</span>)value&#123;</span><br><span class="line">  printf(<span class="string">"lift: %s"</span>, __func__);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¿¡å·å˜åŒ–ç»„åˆ"><a class="markdownIt-Anchor" href="#ä¿¡å·å˜åŒ–ç»„åˆ"></a> ä¿¡å·å˜åŒ–&amp;ç»„åˆ</h2><ol><li>å•ä¸ªä¿¡å·çš„å˜åŒ–</li><li>å¤šä¸ªä¿¡å·çš„ç»„åˆ</li><li>é«˜é˜¶æ“ä½œ</li></ol><p><img src="/img/signal_transform.jpeg" alt="signal å˜åŒ–"></p><h3 id="å€¼æ“ä½œ"><a class="markdownIt-Anchor" href="#å€¼æ“ä½œ"></a> å€¼æ“ä½œ</h3><p>é—®é¢˜ï¼š</p><ul><li>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„å€¼æ“ä½œæ–¹æ³•ï¼Ÿ</li><li>è‡ªå·±å¦‚ä½•æ‰©å±•æ–°çš„å€¼æ–¹æ³•</li></ul><hr><ul><li>transform è¿™äº›ç”¨çš„æ¯”è¾ƒå¤š<ol><li>map</li><li>MapReplace</li><li>ReduceEach tuple(a, b) -&gt; c</li></ol></li><li>å€¼åˆ¤æ–­é€»è¾‘å˜æ¢<ol><li>not</li><li>and</li><li>or</li></ol></li><li>ç”¨çš„æ¯”è¾ƒå°‘<ol><li>reduceApply è¿™ä¸ªä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œç”¨combineLatest: reduceEach: å°±å¯ä»¥åšäº†ï¼Œè€Œä¸”ä»£ç çœ‹èµ·æ¥æ›´å¥½ã€‚</li><li>materialize</li><li>dematerialize</li></ol></li></ul><h3 id="æ•°é‡æ“ä½œ"><a class="markdownIt-Anchor" href="#æ•°é‡æ“ä½œ"></a> æ•°é‡æ“ä½œ</h3><ol><li>repeat ä¸€ç›´ä¼šæœ‰å€¼</li></ol><ul><li><p>æ¡ä»¶è¿‡æ»¤1</p><ol><li>ignore</li><li>ignoreValues</li><li>distinctUntilChanged</li></ol></li><li><p>æ¡ä»¶è¿‡æ»¤2</p><ol><li>takeUntilBlock:(BOOL (^)(id x))predicate</li><li>takeWhileBlock:(BOOL (^)(id x))predicate;</li><li>skipUntilBlock:(BOOL (^)(id x))predicate;</li><li>skipWhileBlock:(BOOL (^)(id x))predicate;</li></ol></li><li><p>æ•°é‡åˆ¤æ–­ï¼Œå¦‚æœæœ‰å€¼å°±å‘é€</p><ol><li>any;</li><li>any:(BOOL (^)(id object))predicateBlock;</li><li>all:(BOOL (^)(id object))predicateBlock;</li></ol></li><li><p>é‡è¯•</p><ol><li>retry</li><li>retry: Count</li><li>collect <code>æ±‡èš</code> ä¿¡å·å¿…é¡»æœ‰è¿”å›å€¼</li></ol></li></ul><p>å‰¯ä½œç”¨ï¼š<br>â€“ å¯¹äºä¿¡å·å€¼å˜åŒ–ä»¥å¤–çš„ä¸€äº›æ“ä½œ</p><ul><li>doNext</li><li>doCompleted</li><li>doError</li></ul><p><code>æŠ˜å å‡½æ•°</code></p><p>ä¸å¬å¯¹ä¸€ä¸ªvalue æ“ä½œï¼Œä½¿ç”¨æŠ˜å å‡½æ•°è§£å†³è¿™ä¸ªé—®é¢˜</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sig10 aggregateWithStart:@<span class="number">0</span> reduce:^<span class="keyword">id</span>(<span class="keyword">id</span> running, <span class="keyword">id</span> next) &#123;</span><br><span class="line">  <span class="keyword">return</span> @([running intValue] + [next intValue]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><ol><li>(RACSignal *)aggregateWithStart:(id)start reduce:(id (^)(id running, id next))reduceBlock;</li><li>(RACSignal *)aggregateWithStart:(id)start reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;</li><li>(RACSignal *)aggregateWithStartFactory:(id (^)(void))startFactory reduce:(id (^)(id running, id next))reduceBlock;</li><li>(instancetype)scanWithStart:(id)startingValue reduce:(id (^)(id running, id next))reduceBlock;</li><li>(instancetype)scanWithStart:(id)startingValue reduceWithIndex:(id (^)(id running, id next, NSUInteger index))reduceBlock;</li></ol><h3 id="æ—¶é—´æ“ä½œ"><a class="markdownIt-Anchor" href="#æ—¶é—´æ“ä½œ"></a> æ—¶é—´æ“ä½œ</h3><ol><li>+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler;</li><li>+ (RACSignal *)interval:(NSTimeInterval)interval onScheduler:(RACScheduler *)scheduler withLeeway:(NSTimeInterval)leeway;</li><li>delay</li><li>throttle é˜€é—¨ï¼Œåœ¨å›ºå®šæ—¶é—´å†…æ²¡æœ‰æ–°å€¼å‘é€çš„æ—¶å€™ï¼Œä¼šå‘é€æœ€åçš„å€¼</li></ol><h3 id="å¤šä¸ªä¿¡å·ç»„åˆ"><a class="markdownIt-Anchor" href="#å¤šä¸ªä¿¡å·ç»„åˆ"></a> å¤šä¸ªä¿¡å·ç»„åˆ</h3><p>é—®é¢˜ï¼š</p><ol><li>å—å“ªä¸ªä¿¡å·ç»ˆæ­¢è€Œç»ˆæ­¢ï¼Ÿ</li><li>é”™è¯¯ä¼ é€’ï¼Ÿ</li><li>å„ä¸ªä¿¡å·ä½•æ—¶å¼€å§‹å¼€å§‹è®¢é˜…ï¼Ÿ</li><li>åœ¨å“ªä¸ªçº¿ç¨‹å‘å‡ºï¼Ÿ</li></ol><ul><li>concat<ul><li>ç¬¬ä¸€ä¸ªç»“æŸåï¼Œè®¢é˜…ç¬¬äºŒä¸ª</li><li>ç¬¬ä¸€ä¸ªerror åï¼Œå°±ç›´æ¥ error</li></ul></li><li>merge</li><li>zip</li><li>combineLatest</li><li>sample</li><li>takeUntil</li><li>takeUntilReplacement, å½“ B æ¥äº†ç›´æ¥æ›¿æ¢ Aï¼Œå¼€å§‹è®¢é˜… B</li></ul><h3 id="ä¿¡å·çš„é«˜é˜¶æ“ä½œå‡é˜¶é™é˜¶"><a class="markdownIt-Anchor" href="#ä¿¡å·çš„é«˜é˜¶æ“ä½œå‡é˜¶é™é˜¶"></a> ä¿¡å·çš„é«˜é˜¶æ“ä½œï¼ˆå‡é˜¶é™é˜¶ï¼‰</h3><ol><li>å‡é˜¶ S(v) -&gt; S(s(v))</li><li>é™é˜¶ S(s(v)) -&gt; S(v)</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, @<span class="number">4</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signalB = [[signal map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">  <span class="keyword">return</span> [[RACSignal <span class="keyword">return</span>:value] delay:<span class="number">1</span>];</span><br><span class="line">&#125;] concat];</span><br></pre></td></tr></table></figure><ul><li><p>é™é˜¶æ“ä½œ</p></li><li><p>switchToLatests</p></li></ul><p><img src="/img/switchToLatests.jpeg" alt="switchToLatests"></p><ul><li><p>if/then/else<br><img src="/img/if-then-else.jpeg" alt="if/then/else"></p></li><li><p>switch/cases/default</p></li><li><p>flatten</p></li></ul><p><img src="/img/flatten.jpeg" alt="flatten"></p><p>flatten ç±»ä¼¼ merge åªä¸è¿‡ä¸€ä¸ªæ˜¯æ¥æ”¶çš„ valueæ˜¯ signalï¼Œå¦ä¸€ä¸ªæ¥æ”¶çš„å°±æ˜¯ value</p><ul><li>flatten:count æŒ‰ä¸ªæ•°å±•å¼€ä¿¡å·ï¼Œå½“ä¿¡å·ä¸ªæ•° &gt; count ä»¥åç­‰å¾…ï¼Œå¦‚æœæœ‰ sig completedï¼Œé‚£ä¹ˆæŠŠç­‰å¾…ä¸­çš„sig æ”¾å…¥å±•å¼€æ•°ç»„é‡Œé¢</li></ul><p><img src="/img/flatten-count.jpeg" alt="flatten-count"></p><p>flatten:1 == concat</p><ul><li>flattenMap</li></ul><p>æ»¡è¶³ monad çš„éƒ¨åˆ†å®šä¹‰ï¼Œç»å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ flattenMap å®ç°</p><ul><li>bind</li></ul><p>å¤§éƒ¨åˆ†å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨ bind å®ç°</p><h2 id="å†·ä¿¡å·çƒ­ä¿¡å·"><a class="markdownIt-Anchor" href="#å†·ä¿¡å·çƒ­ä¿¡å·"></a> å†·ä¿¡å·&amp;çƒ­ä¿¡å·</h2><h2 id="ä¸€äº›ä¹ é¢˜"><a class="markdownIt-Anchor" href="#ä¸€äº›ä¹ é¢˜"></a> ä¸€äº›ä¹ é¢˜</h2><ol><li>å¦‚ä½•è·å¾—æ— é™é€’å¢çš„ä¿¡å·</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *increment(<span class="keyword">int</span> inc) &#123;</span><br><span class="line">  RACSignal *repeat = [[RACSignal <span class="keyword">return</span>:@(inc)] repeat];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [[repeat scanWithStart:<span class="number">0</span> reduce:^<span class="keyword">id</span>(<span class="keyword">id</span> running, <span class="keyword">id</span> next) &#123;</span><br><span class="line">    <span class="keyword">return</span> @([running intValue] + [next intValue]);</span><br><span class="line">  &#125;]</span><br><span class="line">  delay:<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>fibonacci</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *fibonacci() &#123;</span><br><span class="line">  RACSignal *repeat = [[RACSignal <span class="keyword">return</span>:<span class="literal">nil</span>] repeat];</span><br><span class="line">  <span class="keyword">return</span> [repeat scanWithStart:RACTuplePack(@<span class="number">1</span>, @<span class="number">1</span>) reduce:^<span class="keyword">id</span>(RACTuple *running, <span class="keyword">id</span> _) &#123;</span><br><span class="line">    <span class="keyword">int</span> next = [running.first intValue] + [running.second intValue];</span><br><span class="line">    <span class="keyword">return</span> RACTuplePack(running.second, @(next));</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> ç¬¬ä¸‰æ–¹æ¡†æ¶ </category>
          
          <category> ReactiveCocoa </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
            <tag> objc </tag>
            
            <tag> RAC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿›ç¨‹&amp;çº¿ç¨‹é—´é€šä¿¡</title>
      <link href="/2017/03/09/%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
      <url>/2017/03/09/%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><a id="more"></a><h2 id="ä¸€-è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼"><a class="markdownIt-Anchor" href="#ä¸€-è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼"></a> ä¸€ã€è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼</h2><h3 id="ç®¡é“-pipe"><a class="markdownIt-Anchor" href="#ç®¡é“-pipe"></a> ç®¡é“( pipe )</h3><ul><li>ç®¡é“æ˜¯ä¸€ç§åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚è¿›ç¨‹çš„äº²ç¼˜å…³ç³»é€šå¸¸æ˜¯æŒ‡çˆ¶å­è¿›ç¨‹å…³ç³»ã€‚</li></ul><h3 id="æœ‰åç®¡é“-namedpipe"><a class="markdownIt-Anchor" href="#æœ‰åç®¡é“-namedpipe"></a> æœ‰åç®¡é“ (namedpipe)</h3><ul><li>æœ‰åç®¡é“ä¹Ÿæ˜¯åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œä½†æ˜¯å®ƒå…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚</li></ul><h3 id="ä¿¡å·é‡semophore"><a class="markdownIt-Anchor" href="#ä¿¡å·é‡semophore"></a> ä¿¡å·é‡(semophore )</h3><p>ä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚å®ƒå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—-messagequeue"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—-messagequeue"></a> æ¶ˆæ¯é˜Ÿåˆ—( messagequeue )</h3><ul><li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”±æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ã€ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚</li></ul><h3 id="ä¿¡å·-sinal"><a class="markdownIt-Anchor" href="#ä¿¡å·-sinal"></a> ä¿¡å· (sinal )</h3><ul><li>ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚</li></ul><h3 id="å…±äº«å†…å­˜shared-memory"><a class="markdownIt-Anchor" href="#å…±äº«å†…å­˜shared-memory"></a> å…±äº«å†…å­˜(shared memory )</h3><ul><li>å…±äº«å†…å­˜å°±æ˜¯æ˜ å°„ä¸€æ®µèƒ½è¢«å…¶ä»–è¿›ç¨‹æ‰€è®¿é—®çš„å†…å­˜ï¼Œè¿™æ®µå…±äº«å†…å­˜ç”±ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œä½†å¤šä¸ªè¿›ç¨‹éƒ½å¯ä»¥è®¿é—®ã€‚å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ IPC æ–¹å¼ï¼Œå®ƒæ˜¯é’ˆå¯¹å…¶ä»–è¿›ç¨‹é—´é€šä¿¡æ–¹å¼è¿è¡Œæ•ˆç‡ä½è€Œä¸“é—¨è®¾è®¡çš„ã€‚å®ƒå¾€å¾€ä¸å…¶ä»–é€šä¿¡æœºåˆ¶ï¼Œå¦‚ä¿¡å·ä¸¤ï¼Œé…åˆä½¿ç”¨ï¼Œæ¥å®ç°è¿›ç¨‹é—´çš„åŒæ­¥å’Œé€šä¿¡ã€‚</li></ul><h3 id="å¥—æ¥å­—socket"><a class="markdownIt-Anchor" href="#å¥—æ¥å­—socket"></a> å¥—æ¥å­—(socket )</h3><ul><li>å¥—è§£å£ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œä¸å…¶ä»–é€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ç”¨äºä¸åŒåŠå…¶é—´çš„è¿›ç¨‹é€šä¿¡ã€‚</li></ul><h2 id="äºŒ-çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼"><a class="markdownIt-Anchor" href="#äºŒ-çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼"></a> äºŒã€çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼</h2><ul><li>é”æœºåˆ¶ï¼šåŒ…æ‹¬äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”</li><li>äº’æ–¥é”æä¾›äº†ä»¥æ’ä»–æ–¹å¼é˜²æ­¢æ•°æ®ç»“æ„è¢«å¹¶å‘ä¿®æ”¹çš„æ–¹æ³•ã€‚</li><li>è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«æ•°æ®ï¼Œè€Œå¯¹å†™æ“ä½œæ˜¯äº’æ–¥çš„ã€‚</li><li>æ¡ä»¶å˜é‡å¯ä»¥ä»¥åŸå­çš„æ–¹å¼é˜»å¡è¿›ç¨‹ï¼Œç›´åˆ°æŸä¸ªç‰¹å®šæ¡ä»¶ä¸ºçœŸä¸ºæ­¢ã€‚å¯¹æ¡ä»¶çš„æµ‹è¯•æ˜¯åœ¨äº’æ–¥é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œçš„ã€‚æ¡ä»¶å˜é‡å§‹ç»ˆä¸äº’æ–¥é”ä¸€èµ·ä½¿ç”¨ã€‚</li><li>ä¿¡å·é‡æœºåˆ¶(Semaphore)ï¼šåŒ…æ‹¬æ— åçº¿ç¨‹ä¿¡å·é‡å’Œå‘½åçº¿ç¨‹ä¿¡å·é‡</li><li>ä¿¡å·æœºåˆ¶(Signal)ï¼šç±»ä¼¼è¿›ç¨‹é—´çš„ä¿¡å·å¤„ç†</li></ul><p>çº¿ç¨‹é—´çš„é€šä¿¡ç›®çš„ä¸»è¦æ˜¯ç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œæ‰€ä»¥çº¿ç¨‹æ²¡æœ‰åƒè¿›ç¨‹é€šä¿¡ä¸­çš„ç”¨äºæ•°æ®äº¤æ¢çš„é€šä¿¡æœºåˆ¶ã€‚</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºåŸºç¡€çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªå®šä¹‰æ§ä»¶[è½¬è½½objccn]</title>
      <link href="/2017/01/13/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6/"/>
      <url>/2017/01/13/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:52 GMT+0800 (CST) --><p>å¯ä»¥ç›´æ¥çœ‹ <a href="http://objccn.io" target="_blank" rel="noopener">objccn.io</a> çš„è¿™ç¯‡<a href="https://objccn.io/issue-3-4/" target="_blank" rel="noopener">è‡ªå®šä¹‰æ§ä»¶</a></p><ol><li>æ§ä»¶æ¸²æŸ“æ–¹å¼</li><li>æ§ä»¶äº¤äº’æ–¹å¼</li><li>optional æ•°æ®æº</li></ol><h2 id="è§†å›¾å±‚æ¬¡æ¦‚è§ˆ"><a class="markdownIt-Anchor" href="#è§†å›¾å±‚æ¬¡æ¦‚è§ˆ"></a> è§†å›¾å±‚æ¬¡æ¦‚è§ˆ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UIResponder</span><br><span class="line">    â†‘</span><br><span class="line">  UIView</span><br><span class="line">    â†‘</span><br><span class="line"> UIControl</span><br></pre></td></tr></table></figure><h3 id="uiresponderå“åº”é“¾"><a class="markdownIt-Anchor" href="#uiresponderå“åº”é“¾"></a> UIResponder(å“åº”é“¾)</h3><p>UIResponder æ˜¯ UIView çš„çˆ¶ç±»ã€‚responder èƒ½å¤Ÿå¤„ç†è§¦æ‘¸ã€æ‰‹åŠ¿ã€è¿œç¨‹æ§åˆ¶ç­‰äº‹ä»¶ã€‚ä¹‹æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„ç±»è€Œæ²¡æœ‰åˆå¹¶åˆ° UIView ä¸­ï¼Œæ˜¯å› ä¸º UIResponder æœ‰æ›´å¤šçš„å­ç±»ï¼Œæœ€æ˜æ˜¾çš„å°±æ˜¯ UIApplication å’Œ UIViewControllerã€‚é€šè¿‡é‡å†™ UIResponder çš„æ–¹æ³•ï¼Œå¯ä»¥å†³å®šä¸€ä¸ªç±»æ˜¯å¦å¯ä»¥æˆä¸º<font size="4" color="red">ç¬¬ä¸€å“åº”è€… (first responder)</font>ï¼Œä¾‹å¦‚å½“å‰è¾“å…¥ç„¦ç‚¹å…ƒç´ ã€‚</p><p>å½“ touches (è§¦æ‘¸) æˆ– motion (æŒ‡ä¸€ç³»åˆ—è¿åŠ¨ä¼ æ„Ÿå™¨) ç­‰äº¤äº’è¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œå®ƒä»¬è¢«å‘é€ç»™ç¬¬ä¸€å“åº”è€… (é€šå¸¸æ˜¯ä¸€ä¸ªè§†å›¾)ã€‚å¦‚æœç¬¬ä¸€å“åº”è€…æ²¡æœ‰å¤„ç†ï¼Œåˆ™è¯¥è¡Œä¸ºæ²¿ç€å“åº”é“¾åˆ°è¾¾è§†å›¾æ§åˆ¶å™¨ï¼Œå¦‚æœè¡Œä¸ºä»ç„¶æ²¡æœ‰è¢«å¤„ç†ï¼Œåˆ™ç»§ç»­ä¼ é€’ç»™åº”ç”¨ã€‚å¦‚æœæƒ³ç›‘æµ‹æ™ƒåŠ¨æ‰‹åŠ¿ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åœ¨è¿™3å±‚ä¸­çš„ä»»æ„ä½ç½®å¤„ç†ã€‚</p><p>UIResponder è¿˜å…è®¸è‡ªå®šä¹‰è¾“å…¥æ–¹æ³•ï¼Œä» inputAccessoryView å‘é”®ç›˜æ·»åŠ è¾…åŠ©è§†å›¾åˆ°ä½¿ç”¨ inputView æä¾›ä¸€ä¸ªå®Œå…¨è‡ªå®šä¹‰çš„é”®ç›˜ã€‚</p><h3 id="uiviewæ¸²æŸ“layerå®¿ä¸»"><a class="markdownIt-Anchor" href="#uiviewæ¸²æŸ“layerå®¿ä¸»"></a> UIView(æ¸²æŸ“layerå®¿ä¸»)</h3><p>UIView å­ç±»å¤„ç†æ‰€æœ‰è·Ÿå†…å®¹ç»˜åˆ¶æœ‰å…³çš„äº‹æƒ…ä»¥åŠè§¦æ‘¸æ—¶é—´ã€‚<br>ä½†æˆ‘ä»¬é‡ç”³ä¸€äº›æŠ€å·§ç‚¹:<br>ä¸€ä¸ªæ™®éé”™è¯¯çš„æ¦‚å¿µï¼šè§†å›¾çš„åŒºåŸŸæ˜¯ç”±å®ƒçš„ frame å®šä¹‰çš„ã€‚å®é™…ä¸Š <font color="red">frame æ˜¯ä¸€ä¸ªæ´¾ç”Ÿå±æ€§ï¼Œæ˜¯ç”± center å’Œ bounds åˆæˆè€Œæ¥</font>ã€‚ä¸ä½¿ç”¨ Auto Layout æ—¶ï¼Œå¤§å¤šæ•°äººä½¿ç”¨ frame æ¥æ”¹å˜è§†å›¾çš„ä½ç½®å’Œå¤§å°ã€‚å°å¿ƒäº›ï¼Œ<a href="https://developer.apple.com/library/ios/#documentation/UIKit/Reference/UIView_Class/UIView/UIView.html#//apple_ref/occ/instp/UIView/frame" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ç‰¹åˆ«è¯¦ç»†è¯´æ˜äº†ä¸€ä¸ªæ³¨æ„äº‹é¡¹:</p><blockquote><p>å¦‚æœ transform å±æ€§ä¸æ˜¯ identity transform çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼Œå› æ­¤åº”è¯¥å°†å…¶å¿½ç•¥</p></blockquote><p>å¦ä¸€ä¸ªå…è®¸å‘è§†å›¾æ·»åŠ äº¤äº’çš„æ–¹æ³•æ˜¯ä½¿ç”¨<font color="purple">æ‰‹åŠ¿è¯†åˆ«ã€‚æ³¨æ„å®ƒä»¬å¯¹ responders å¹¶ä¸èµ·ä½œç”¨ï¼Œè€Œåªå¯¹è§†å›¾åŠå…¶å­ç±»å¥æ•ˆ</font>ã€‚</p><h3 id="uicontroläº¤äº’æ§ä»¶"><a class="markdownIt-Anchor" href="#uicontroläº¤äº’æ§ä»¶"></a> UIControl(äº¤äº’æ§ä»¶)</h3><p>UIControl å»ºç«‹åœ¨è§†å›¾ä¸Šï¼Œå¢åŠ äº†æ›´å¤šçš„äº¤äº’æ”¯æŒã€‚æœ€é‡è¦çš„æ˜¯ï¼Œ<font color="purple">å®ƒå¢åŠ äº† target / action æ¨¡å¼</font>ã€‚çœ‹ä¸€ä¸‹å…·ä½“çš„å­ç±»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æŒ‰é’®ï¼Œæ—¥æœŸé€‰æ‹©å™¨ (Date pickers)ï¼Œæ–‡æœ¬æ¡†ç­‰ç­‰ã€‚åˆ›å»ºäº¤äº’æ§ä»¶æ—¶ï¼Œä½ é€šå¸¸æƒ³è¦å­ç±»åŒ–ä¸€ä¸ª UIControlã€‚ä¸€äº›å¸¸è§çš„åƒ bar buttons (è™½ç„¶ä¹Ÿæ”¯æŒ target / action) å’Œ text view (è¿™é‡Œéœ€è¦ä½ ä½¿ç”¨ä»£ç†æ¥è·å¾—é€šçŸ¥) çš„ç±»å…¶å®å¹¶ä¸æ˜¯ UIControlã€‚</p><h2 id="æ¸²æŸ“"><a class="markdownIt-Anchor" href="#æ¸²æŸ“"></a> æ¸²æŸ“</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬è½¬å‘å¯è§éƒ¨åˆ†ï¼šè‡ªå®šä¹‰æ¸²æŸ“ã€‚æ­£å¦‚ Daniel åœ¨ä»–çš„<a href="http://www.objccn.io/issue-3-1/" target="_blank" rel="noopener">æ–‡ç« </a>ä¸­æåˆ°çš„ï¼Œä½ å¯èƒ½æƒ³é¿å…åœ¨ CPU ä¸Šåšæ¸²æŸ“è€Œå°†å…¶ä¸¢ç»™ GPUã€‚è¿™é‡Œæœ‰ä¸€æ¡ç»éªŒï¼šå°½é‡é¿å… <code>drawRect:</code>ï¼Œä½¿ç”¨ç°æœ‰çš„è§†å›¾æ„å»ºè‡ªå®šä¹‰è§†å›¾ã€‚</p><p><font color="purple">é€šå¸¸æœ€å¿«é€Ÿçš„æ¸²æŸ“æ–¹æ³•æ˜¯ä½¿ç”¨å›¾ç‰‡è§†å›¾</font>ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³ç”»ä¸€ä¸ªå¸¦æœ‰è¾¹æ¡†çš„åœ†å½¢å¤´åƒï¼Œåƒä¸‹é¢å›¾ç‰‡ä¸­è¿™æ ·:</p><div align="center"><img src="https://objccn.io/images/issues/issue-3/issue-3-rounded-corners@2x.png" alt="runloop" style="width:200px;height:376px"></div><p>ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬ç”¨ä»¥ä¸‹çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå›¾ç‰‡è§†å›¾çš„å­ç±»:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// called from initializer</span></span><br><span class="line">- (<span class="keyword">void</span>)setupView &#123;</span><br><span class="line">  <span class="keyword">self</span>.clipsToBounds = <span class="literal">YES</span>;</span><br><span class="line">  <span class="keyword">self</span>.layer.cornerRadius = <span class="keyword">self</span>.bounds.size.width / <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">self</span>.layer.borderWidth = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">self</span>.layer.borderColor = [<span class="built_in">UIColor</span> darkGrayColor].CGColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘é¼“åŠ±å„ä½è¯»è€…<font color="red">æ·±å…¥äº†è§£ CALayer åŠå…¶å±æ€§ï¼Œå› ä¸ºä½ ç”¨å®ƒèƒ½å®ç°çš„å¤§å¤šæ•°äº‹æƒ…ä¼šæ¯”ç”¨ Core Graphics è‡ªå·±ç”»è¦å¿«</font>ã€‚ç„¶è€Œä¸€å¦‚æ—¢å¾€ï¼Œç›‘æµ‹è‡ªå·±çš„ä»£ç çš„æ€§èƒ½æ˜¯ååˆ†é‡è¦çš„ã€‚</p><p>æŠŠå¯æ‹‰ä¼¸çš„å›¾ç‰‡å’Œå›¾ç‰‡è§†å›¾ä¸€èµ·ä½¿ç”¨ä¹Ÿå¯ä»¥æå¤§çš„æé«˜æ•ˆç‡ã€‚åœ¨ <a href="http://robots.thoughtbot.com/post/33427366406/designing-for-ios-taming-uibutton" target="_blank" rel="noopener">Taming UIButton</a> è¿™ä¸ªå¸–å­ä¸­ï¼ŒReda Lemeden æ¢ç´¢äº†å‡ ç§ä¸åŒçš„ç»˜å›¾æ–¹æ³•ã€‚åœ¨æ–‡ç« ç»“å°¾å¤„æœ‰ä¸€ä¸ªå¾ˆæœ‰ä»·å€¼çš„<a href="https://news.ycombinator.com/item?id=4645585" target="_blank" rel="noopener">æ¥è‡ª UIKit å›¢é˜Ÿçš„å·¥ç¨‹å¸ˆ Andy Matuschak çš„å›å¤</a>ï¼Œè§£é‡Šäº†å¯æ‹‰ä¼¸å›¾ç‰‡æ˜¯è¿™äº›æŠ€æœ¯ä¸­æœ€å¿«çš„ã€‚åŸå› æ˜¯å¯æ‹‰ä¼¸å›¾ç‰‡åœ¨ CPU å’Œ GPU ä¹‹é—´çš„æ•°æ®è½¬ç§»é‡æœ€å°ï¼Œå¹¶ä¸”è¿™äº›å›¾ç‰‡çš„ç»˜åˆ¶æ˜¯ç»è¿‡é«˜åº¦ä¼˜åŒ–çš„ã€‚</p><p>å¤„ç†å›¾ç‰‡æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®© GPU ä¸ºä½ å·¥ä½œæ¥ä»£æ›¿ä½¿ç”¨ Core Graphicsã€‚<font color="red">ä½¿ç”¨ Core Imageï¼Œä½ ä¸å¿…ç”¨ CPU åšä»»ä½•çš„å·¥ä½œå°±å¯ä»¥åœ¨å›¾ç‰‡ä¸Šå»ºç«‹å¤æ‚çš„æ•ˆæœ</font>ã€‚ä½ å¯ä»¥ç›´æ¥åœ¨ OpenGL ä¸Šä¸‹æ–‡ä¸Šç›´æ¥æ¸²æŸ“ï¼Œæ‰€æœ‰çš„å·¥ä½œéƒ½åœ¨ GPU ä¸Šå®Œæˆã€‚</p><h3 id="è‡ªå®šä¹‰ç»˜åˆ¶"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰ç»˜åˆ¶"></a> è‡ªå®šä¹‰ç»˜åˆ¶</h3><p>å¦‚æœå†³å®šäº†é‡‡ç”¨è‡ªå®šä¹‰ç»˜åˆ¶ï¼Œæœ‰å‡ ç§ä¸åŒçš„é€‰é¡¹å¯ä¾›é€‰æ‹©ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥ç”Ÿæˆä¸€å¼ å›¾ç‰‡å¹¶åœ¨å†…å­˜å’Œç£ç›˜ä¸Šç¼“å­˜èµ·æ¥ã€‚å¦‚æœå†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œä¹Ÿè®¸ä½ å¯ä»¥ä½¿ç”¨ Core Animationï¼Œå¦‚æœè¿˜æ˜¯è¡Œä¸é€šï¼Œä½¿ç”¨ Core Graphicsã€‚å¦‚æœä½ çœŸçš„æƒ³è¦æ¥è¿‘åº•å±‚ï¼Œä½¿ç”¨ GLKit å’ŒåŸç”Ÿ OpenGL ä¹Ÿä¸æ˜¯é‚£ä¹ˆéš¾ï¼Œä½†æ˜¯éœ€è¦åšå¾ˆå¤šå·¥ä½œã€‚</p><p>å¦‚æœä½ çœŸçš„é€‰æ‹©äº†é‡å†™ <code>drawRect:</code>ï¼Œç¡®ä¿æ£€æŸ¥å†…å®¹æ¨¡å¼ã€‚é»˜è®¤çš„æ¨¡å¼æ˜¯å°†å†…å®¹ç¼©æ”¾ä»¥å¡«å……è§†å›¾çš„èŒƒå›´ï¼Œè¿™åœ¨å½“è§†å›¾çš„ frame æ”¹å˜æ—¶å¹¶ä¸ä¼šé‡æ–°ç»˜åˆ¶ã€‚</p><h2 id="è‡ªå®šä¹‰äº¤äº’"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰äº¤äº’"></a> è‡ªå®šä¹‰äº¤äº’</h2><p>è‡ªå®šä¹‰æ§ä»¶çš„æ—¶å€™ï¼Œä½ å‡ ä¹ä¸€å®šä¼šæ‰©å±•ä¸€ä¸ª UIControl çš„å­ç±»ã€‚åœ¨ä½ çš„å­ç±»é‡Œï¼Œå¯ä»¥ä½¿ç”¨ target action æœºåˆ¶è§¦å‘äº‹ä»¶ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> sendActionsForControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å“åº”è§¦æ‘¸ï¼Œä½ å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨æ‰‹åŠ¿è¯†åˆ«ã€‚ç„¶è€Œå¦‚æœæƒ³è¦æ›´æ¥è¿‘åº•å±‚ï¼Œä»ç„¶å¯ä»¥é‡å†™ touchesBeganï¼Œ touchesMoved å’Œ touchesEnded æ–¹æ³•æ¥è®¿é—®åŸå§‹çš„è§¦æ‘¸è¡Œä¸ºã€‚<br>ä½†è™½è¯´å¦‚æ­¤ï¼Œ<font color="purple">åˆ›å»ºä¸€ä¸ªæ‰‹åŠ¿è¯†åˆ«çš„å­ç±»æ¥æŠŠæ‰‹åŠ¿å¤„ç†ç›¸å…³çš„é€»è¾‘ä»ä½ çš„è§†å›¾æˆ–è€…è§†å›¾æ§åˆ¶å™¨ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯ä¸€ç§æ›´åˆé€‚çš„æ–¹å¼</font>ã€‚</p><p>åˆ›å»ºè‡ªå®šä¹‰æ§ä»¶æ—¶æ‰€é¢å¯¹çš„<font color="red">ä¸€ä¸ªæ™®éçš„è®¾è®¡é—®é¢˜æ˜¯å‘æ‹¥æœ‰å®ƒä»¬çš„ç±»ä¸­å›ä¼ è¿”å›å€¼</font>ã€‚æ¯”å¦‚ï¼Œå‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªç»˜åˆ¶äº¤äº’é¥¼çŠ¶å›¾çš„è‡ªå®šä¹‰æ§ä»¶ï¼Œæƒ³çŸ¥é“ç”¨æˆ·ä½•æ—¶é€‰æ‹©äº†å…¶ä¸­ä¸€ä¸ªéƒ¨åˆ†ã€‚ä½ å¯ä»¥ç”¨å¾ˆå¤šç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚é€šè¿‡ target action æ¨¡å¼ï¼Œä»£ç†ï¼Œblock æˆ–è€… KVOï¼Œç”šè‡³é€šçŸ¥ã€‚</p><h3 id="ä½¿ç”¨-target-action"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-target-action"></a> ä½¿ç”¨ Target-Action</h3><p>é€šå¸¸ä¹Ÿæ˜¯æœ€æ–¹ä¾¿çš„åšæ³•æ˜¯ä½¿ç”¨ target-actionã€‚åœ¨ç”¨æˆ·é€‰æ‹©åä½ å¯ä»¥åœ¨è‡ªå®šä¹‰çš„è§†å›¾ä¸­åšç±»ä¼¼è¿™æ ·çš„äº‹æƒ…:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> sendActionsForControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨åœ¨ç®¡ç†è¿™ä¸ªè§†å›¾ï¼Œéœ€è¦è¿™æ ·åš:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupPieChart &#123;</span><br><span class="line">  [<span class="keyword">self</span>.pieChart addTarget:<span class="keyword">self</span> </span><br><span class="line">                action:<span class="keyword">@selector</span>(updateSelection:)</span><br><span class="line">      forControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateSelection:(<span class="keyword">id</span>)sender&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>.pieChart.selectedSector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯åœ¨è‡ªå®šä¹‰è§†å›¾å­ç±»ä¸­éœ€è¦åšçš„äº‹æƒ…å¾ˆå°‘ï¼Œå¹¶ä¸”è‡ªåŠ¨è·å¾—å¤šç›®æ ‡æ”¯æŒ</p><h3 id="ä½¿ç”¨ä»£ç†"><a class="markdownIt-Anchor" href="#ä½¿ç”¨ä»£ç†"></a> ä½¿ç”¨ä»£ç†</h3><p>å¦‚æœä½ éœ€è¦æ›´å¤šçš„æ§åˆ¶ä»è§†å›¾å‘é€åˆ°è§†å›¾æ§åˆ¶å™¨çš„æ¶ˆæ¯ï¼Œé€šå¸¸ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚åœ¨æˆ‘ä»¬çš„é¥¼çŠ¶å›¾ä¸­ï¼Œä»£ç çœ‹èµ·æ¥å¤§æ¦‚æ˜¯è¿™æ ·:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.delegate pieChart:<span class="keyword">self</span> didSelectSector:<span class="keyword">self</span>.selectedSector];</span><br></pre></td></tr></table></figure><p>åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œä½ è¦å†™å¦‚ä¸‹ä»£ç :</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyViewController</span> &lt;<span class="title">PieChartDelegate</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line">- (<span class="keyword">void</span>)setupPieChart&#123;</span><br><span class="line">  <span class="keyword">self</span>.pieChart.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)pieChart:(PieChart*)pieChart didSelectSector:(PieChartSector*)sector&#123;</span><br><span class="line">  <span class="comment">// å¤„ç†åŒºå—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä½ æƒ³è¦åšæ›´å¤šå¤æ‚çš„å·¥ä½œè€Œä¸ä»…ä»…æ˜¯é€šçŸ¥æ‰€æœ‰è€…å€¼å‘ç”Ÿäº†å˜åŒ–æ—¶ï¼Œè¿™ä¹ˆåšæ˜¾ç„¶æ›´åˆé€‚ã€‚ä¸è¿‡è™½ç„¶å¤§å¤šæ•°å¼€å‘äººå‘˜å¯ä»¥éå¸¸å¿«é€Ÿçš„å®ç°è‡ªå®šä¹‰ä»£ç†ï¼Œä½†è¿™ç§æ–¹å¼ä»ç„¶æœ‰ä¸€äº›ç¼ºç‚¹ï¼šä½ å¿…é¡»æ£€æŸ¥ä»£ç†æ˜¯å¦å®ç°äº†ä½ æƒ³è¦è°ƒç”¨çš„æ–¹æ³• (ä½¿ç”¨ respondsToSelector:)ï¼Œæœ€é‡è¦çš„ï¼Œé€šå¸¸ä½ åªæœ‰ä¸€ä¸ªä»£ç† (æˆ–è€…éœ€è¦åˆ›å»ºä¸€ä¸ªä»£ç†æ•°ç»„)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦è§†å›¾æ‰€æœ‰è€…å’Œè§†å›¾ä¹‹é—´çš„é€šä¿¡å˜å¾—ç¨å¾®å¤æ‚ï¼Œæˆ‘ä»¬å‡ ä¹æ€»æ˜¯ä¼šé‡‡å–è¿™ç§æ¨¡å¼ã€‚</p><h3 id="ä½¿ç”¨-block"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-block"></a> ä½¿ç”¨ Block</h3><p>å¦ä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨ blockã€‚å†ä¸€æ¬¡ç”¨é¥¼çŠ¶å›¾ä¸¾ä¾‹ï¼Œä»£ç çœ‹èµ·æ¥å¤§æ¦‚æ˜¯è¿™æ ·:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PieChart</span> : <span class="title">UIControl</span> </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="keyword">void</span>(^selectionHandler)(PieChartSection* selectedSection); </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>åœ¨é€‰å–è¡Œä¸ºçš„ä»£ç ä¸­ï¼Œä½ åªéœ€è¦æ‰§è¡Œå®ƒã€‚åœ¨æ­¤ä¹‹å‰æ£€æŸ¥ä¸€ä¸‹blockæ˜¯å¦è¢«èµ‹å€¼éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œä¸€ä¸ªæœªè¢«èµ‹å€¼çš„ block ä¼šä½¿ç¨‹åºå´©æºƒã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.selectionHandler != <span class="literal">NULL</span>) &#123;</span><br><span class="line">  <span class="keyword">self</span>.selectionHandler(<span class="keyword">self</span>.selectedSection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æŠŠç›¸å…³çš„ä»£ç æ•´åˆåœ¨è§†å›¾æ§åˆ¶å™¨ä¸­:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupPieChart &#123;</span><br><span class="line">  <span class="keyword">self</span>.pieChart.selectionHandler = ^(PieChartSection* section) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç†åŒºå—</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±åƒä»£ç†ï¼Œæ¯ä¸ªåŠ¨ä½œé€šå¸¸åªæœ‰ä¸€ä¸ª blockã€‚å¦ä¸€ä¸ªé‡è¦çš„é™åˆ¶æ˜¯ä¸è¦å½¢æˆå¼•ç”¨å¾ªç¯ã€‚å¦‚æœä½ çš„è§†å›¾æ§åˆ¶å™¨æŒæœ‰é¥¼çŠ¶å›¾çš„å¼ºå¼•ç”¨ï¼Œé¥¼çŠ¶å›¾æŒæœ‰ blockï¼Œblock åˆæŒæœ‰è§†å›¾æ§åˆ¶å™¨ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªå¼•ç”¨å¾ªç¯ã€‚åªè¦åœ¨ block ä¸­å¼•ç”¨ self å°±ä¼šé€ æˆè¿™ä¸ªé”™è¯¯ã€‚æ‰€ä»¥é€šå¸¸ä»£ç ä¼šå†™æˆè¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">id</span> weakSelf = <span class="keyword">self</span>;</span><br><span class="line"><span class="keyword">self</span>.pieChart.selectionHandler = ^(PieChartSection* section) &#123;</span><br><span class="line">  MyViewController* strongSelf = weakSelf;</span><br><span class="line">  [strongSelf handleSectionChange:section];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦ block ä¸­çš„ä»£ç è¦å¤±å»æ§åˆ¶ (æ¯”å¦‚ block ä¸­è¦å¤„ç†çš„äº‹æƒ…å¤ªå¤šï¼Œå¯¼è‡´ block ä¸­çš„ä»£ç è¿‡å¤š)ï¼Œä½ è¿˜åº”è¯¥å°†å®ƒä»¬æŠ½ç¦»æˆç‹¬ç«‹çš„æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µçš„è¯å¯èƒ½ç”¨ä»£ç†ä¼šæ›´å¥½ä¸€äº›ã€‚</p><h3 id="ä½¿ç”¨-kvo"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-kvo"></a> ä½¿ç”¨ KVO</h3><p>å¦‚æœå–œæ¬¢ KVOï¼Œä½ ä¹Ÿå¯ä»¥ç”¨å®ƒæ¥è§‚å¯Ÿã€‚è¿™æœ‰ä¸€ç‚¹ç¥å¥‡è€Œä¸”æ²¡é‚£ä¹ˆç›´æ¥ï¼Œä½†å½“åº”ç”¨ä¸­å·²ç»ä½¿ç”¨ï¼Œ<font color="red">å®ƒæ˜¯å¾ˆå¥½çš„è§£è€¦è®¾è®¡æ¨¡å¼</font>ã€‚åœ¨é¥¼çŠ¶å›¾ç±»ä¸­ï¼Œç¼–å†™ä»£ç :</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.selectedSegment = theNewSelectedSegment;</span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨åˆæˆå±æ€§ï¼ŒKVO ä¼šæ‹¦æˆªåˆ°è¯¥å˜åŒ–å¹¶å‘å‡ºé€šçŸ¥ã€‚åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œç¼–å†™ç±»ä¼¼çš„ä»£ç :</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupPieChart&#123;</span><br><span class="line">   [<span class="keyword">self</span>.pieChart addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"selectedSegment"</span> options:<span class="number">0</span> context:<span class="literal">NULL</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">  <span class="keyword">if</span>(object == <span class="keyword">self</span>.pieChart &amp;&amp; [keyPath isEqualToString:<span class="string">@"selectedSegment"</span>]) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç†æ”¹å˜</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä½ çš„éœ€è¦ï¼Œåœ¨ viewWillDisappear: æˆ– dealloc ä¸­ï¼Œè¿˜éœ€è¦ç§»é™¤è§‚å¯Ÿè€…ã€‚å¯¹åŒä¸€ä¸ªå¯¹è±¡è®¾ç½®å¤šä¸ªè§‚å¯Ÿè€…å¾ˆå®¹æ˜“é€ æˆæ··ä¹±ã€‚æœ‰ä¸€äº›æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ <a href="https://github.com/ReactiveCocoa/ReactiveCocoa" target="_blank" rel="noopener">ReactiveCocoa</a> æˆ–è€…æ›´è½»é‡çº§çš„ THObserversAndBindersã€‚</p><h3 id="ä½¿ç”¨é€šçŸ¥"><a class="markdownIt-Anchor" href="#ä½¿ç”¨é€šçŸ¥"></a> ä½¿ç”¨é€šçŸ¥</h3><p>ä½œä¸ºæœ€åä¸€ä¸ªé€‰æ‹©ï¼Œå¦‚æœä½ æƒ³è¦ä¸€ä¸ªéå¸¸æ¾æ•£çš„è€¦åˆï¼Œå¯ä»¥ä½¿ç”¨é€šçŸ¥æ¥ä½¿å…¶ä»–å¯¹è±¡å¾—çŸ¥å˜åŒ–ã€‚å¯¹äºé¥¼çŠ¶å›¾æ¥è¯´ä½ å‡ ä¹è‚¯å®šä¸æƒ³è¿™æ ·ï¼Œä¸è¿‡ä¸ºäº†è®²è§£çš„å®Œæ•´ï¼Œè¿™é‡Œä»‹ç»å¦‚ä½•å»åšã€‚åœ¨é¥¼çŠ¶å›¾çš„çš„å¤´æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="built_in">NSString</span>* <span class="keyword">const</span> SelectedSegmentChangedNotification;</span><br></pre></td></tr></table></figure><p>åœ¨å®ç°æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span>* <span class="keyword">const</span> SelectedSegmentChangedNotification = <span class="string">@"selectedSegmentChangedNotification"</span>;</span><br><span class="line">...</span><br><span class="line">- (<span class="keyword">void</span>)notifyAboutChanges&#123;</span><br><span class="line">  [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:SelectedSegmentChangedNotification object:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨è®¢é˜…é€šçŸ¥ï¼Œåœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupPieChart&#123;</span><br><span class="line">  [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> </span><br><span class="line">                                       selector:<span class="keyword">@selector</span>(segmentChanged:) </span><br><span class="line">                                           name:SelectedSegmentChangedNotification</span><br><span class="line">                                          object:<span class="keyword">self</span>.pieChart];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)segmentChanged:(<span class="built_in">NSNotification</span>*)note&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ·»åŠ äº†è§‚å¯Ÿè€…ï¼Œä½ å¯ä»¥ä¸å°†é¥¼çŠ¶å›¾ä½œä¸ºå‚æ•° objectï¼Œè€Œæ˜¯ä¼ é€’ nilï¼Œä»¥æ¥æ”¶æ‰€æœ‰é¥¼çŠ¶å›¾å¯¹è±¡å‘å‡ºçš„é€šçŸ¥ã€‚å°±åƒ KVO é€šçŸ¥ï¼Œä½ ä¹Ÿéœ€è¦åœ¨æ°å½“çš„åœ°æ–¹é€€è®¢è¿™äº›é€šçŸ¥ã€‚</p><p><font color="red">è¿™é¡¹æŠ€æœ¯çš„å¥½å¤„æ˜¯å®Œå…¨çš„è§£è€¦ã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å¤±å»äº†ç±»å‹å®‰å…¨ï¼Œå› ä¸ºåœ¨å›è°ƒä¸­ä½ å¾—åˆ°çš„æ˜¯ä¸€ä¸ªé€šçŸ¥å¯¹è±¡ï¼Œè€Œä¸åƒä»£ç†ï¼Œç¼–è¯‘å™¨æ— æ³•æ£€æŸ¥é€šçŸ¥å‘é€è€…å’Œæ¥å—è€…ä¹‹é—´çš„ç±»å‹æ˜¯å¦åŒ¹é…</font>ã€‚</p><h2 id="è¾…åŠ©åŠŸèƒ½-accessibility"><a class="markdownIt-Anchor" href="#è¾…åŠ©åŠŸèƒ½-accessibility"></a> è¾…åŠ©åŠŸèƒ½ (Accessibility)</h2><p>è‹¹æœå®˜æ–¹æä¾›çš„æ ‡å‡† iOS æ§ä»¶å‡æœ‰è¾…åŠ©åŠŸèƒ½ã€‚è¿™ä¹Ÿæ˜¯æ¨èç”¨æ ‡å‡†æ§ä»¶åˆ›å»ºè‡ªå®šä¹‰æ§ä»¶çš„å¦ä¸€ä¸ªåŸå› ã€‚</p><p>è¿™æˆ–è®¸å¯ä»¥ä½œä¸ºä¸€æ•´æœŸçš„ä¸»é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³ç¼–å†™è‡ªå®šä¹‰è§†å›¾ï¼ŒAccessibility Programming Guide è¯´æ˜äº†å¦‚ä½•åˆ›å»ºè¾…åŠ©æ§åˆ¶å™¨ã€‚æœ€ä¸ºå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè§†å›¾ä¸­æœ‰å¤šä¸ªéœ€è¦è¾…åŠ©åŠŸèƒ½çš„å…ƒç´ ï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯è¯¥è§†å›¾çš„å­è§†å›¾ï¼Œä½ å¯ä»¥è®©è§†å›¾å®ç° UIAccessibilityContainer åè®®ã€‚å¯¹äºæ¯ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªæè¿°å®ƒçš„ UIAccessibilityElement å¯¹è±¡ã€‚</p><h2 id="æœ¬åœ°åŒ–"><a class="markdownIt-Anchor" href="#æœ¬åœ°åŒ–"></a> æœ¬åœ°åŒ–</h2><p>åˆ›å»ºè‡ªå®šä¹‰è§†å›¾æ—¶ï¼Œæœ¬åœ°åŒ–ä¹ŸåŒæ ·é‡è¦ã€‚åƒè¾…åŠ©åŠŸèƒ½ä¸€æ ·ï¼Œè¿™ä¸ªå¯ä»¥ä½œä¸ºä¸€æ•´æœŸçš„è¯é¢˜ã€‚æœ¬åœ°åŒ–è‡ªå®šä¹‰è§†å›¾çš„æœ€ç›´æ¥å·¥ä½œå°±æ˜¯å­—ç¬¦ä¸²å†…å®¹ã€‚å¦‚æœä½¿ç”¨ NSStringï¼Œä½ ä¸å¿…æ‹…å¿ƒç¼–ç é—®é¢˜ã€‚å¦‚æœåœ¨è‡ªå®šä¹‰è§†å›¾ä¸­å±•ç¤ºæ—¥æœŸæˆ–æ•°å­—ï¼Œä½¿ç”¨æ—¥æœŸå’Œæ•°å­—æ ¼å¼åŒ–ç±»æ¥å±•ç¤ºå®ƒä»¬ã€‚ä½¿ç”¨ NSLocalizedString æœ¬åœ°åŒ–å­—ç¬¦ä¸²ã€‚</p><p>å¦ä¸€ä¸ªæœ¬åœ°åŒ–è¿‡ç¨‹ä¸­å¾ˆæœ‰ç”¨çš„å·¥å…·æ˜¯ Auto Layoutã€‚ä¾‹å¦‚ï¼Œæœ‰åœ¨è‹±æ–‡ä¸­å¾ˆçŸ­çš„è¯åœ¨å¾·è¯­ä¸­å¯èƒ½ä¼šå¾ˆé•¿ã€‚å¦‚æœæ ¹æ®è‹±æ–‡å•è¯çš„é•¿åº¦å¯¹è§†å›¾çš„å°ºå¯¸åšç¡¬ç¼–ç ï¼Œé‚£ä¹ˆå½“ç¿»è¯‘æˆå¾·æ–‡çš„æ—¶å€™å‡ ä¹ä¸€å®šä¼šé‡ä¸Šéº»çƒ¦ã€‚é€šè¿‡ä½¿ç”¨ Auto Layoutï¼Œè®©æ ‡ç­¾æ§ä»¶è‡ªåŠ¨è°ƒæ•´ä¸ºå†…å®¹çš„å°ºå¯¸ï¼Œå¹¶å‘ä¾èµ–å…ƒç´ æ·»åŠ ä¸€äº›å…¶ä»–çš„é™åˆ¶ä»¥ç¡®ä¿é‡æ–°è®¾ç½®å°ºå¯¸ï¼Œä½¿è¿™é¡¹å·¥ä½œå˜å¾—éå¸¸ç®€å•ã€‚è‹¹æœä¸ºæ­¤æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„<a href="http://developer.apple.com/library/ios/#referencelibrary/GettingStarted/RoadMapiOS/chapters/InternationalizeYourApp/InternationalizeYourApp/InternationalizeYourApp.html" target="_blank" rel="noopener">ä»‹ç»</a>ã€‚å¦å¤–ï¼Œå¯¹äºç±»ä¼¼å¸Œä¼¯æ¥è¯­è¿™ç§é¡ºåºä»å³åˆ°å·¦çš„è¯­è¨€ï¼Œå¦‚æœä½ ä½¿ç”¨äº† leading å’Œ trailing å±æ€§ï¼Œæ•´ä¸ªè§†å›¾ä¼šè‡ªåŠ¨æŒ‰ç…§ä»å³åˆ°å·¦çš„é¡ºåºå±•ç¤ºï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„ä»å·¦è‡³å³ã€‚</p><h2 id="æµ‹è¯•"><a class="markdownIt-Anchor" href="#æµ‹è¯•"></a> æµ‹è¯•</h2><p>æœ€åï¼Œè®©æˆ‘ä»¬è€ƒè™‘æµ‹è¯•è§†å›¾çš„é—®é¢˜ã€‚å¯¹äºå•å…ƒæµ‹è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ Xcode è‡ªå¸¦çš„å·¥å…·æˆ–è€…å…¶å®ƒç¬¬ä¸‰æ–¹æ¡†æ¶ã€‚å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ UIAutomation æˆ–è€…å…¶å®ƒåŸºäºå®ƒçš„å·¥å…·ã€‚ä¸ºæ­¤ï¼Œä½ çš„è§†å›¾å®Œå…¨æ”¯æŒè¾…åŠ©åŠŸèƒ½æ˜¯å¿…è¦çš„ã€‚UIAutomation å¹¶æœªå……åˆ†å¾—åˆ°åˆ©ç”¨çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯æˆªå›¾ï¼›ä½ å¯ä»¥ç”¨å®ƒ<a href="http://jeffkreeftmeijer.com/2011/comparing-images-and-creating-image-diffs/" target="_blank" rel="noopener">è‡ªåŠ¨å¯¹æ¯”</a>è§†å›¾å’Œè®¾è®¡ä»¥ç¡®ä¿ä¸¤è€…æ¯ä¸€ä¸ªåƒç´ éƒ½åˆ†æ¯«ä¸å·®ã€‚(æ’ä¸€ä¸ªæ— å…³çš„å°æç¤ºï¼šä½ è¿˜å¯ä»¥ä½¿ç”¨å®ƒæ¥ä¸ºåº”ç”¨ä¸Šæ¶ App Store <a href="http://www.smallte.ch/blog-read_en_29001.html" target="_blank" rel="noopener">è‡ªåŠ¨ç”Ÿæˆæˆªå›¾</a>ï¼Œè¿™åœ¨ä½ æœ‰å¤šä¸ªå¤šå›½è¯­è¨€çš„åº”ç”¨æ—¶ä¼šç‰¹åˆ«æœ‰ç”¨)ã€‚</p><p>å¼•ç”¨</p><blockquote><p><a href="https://objccn.io/issue-3-4/" target="_blank" rel="noopener">è‡ªå®šä¹‰æ§ä»¶</a></p></blockquote><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOS è®¾å¤‡å°ºå¯¸è¡¨</title>
      <link href="/2016/12/01/%E8%AE%BE%E5%A4%87%E5%B0%BA%E5%AF%B8/"/>
      <url>/2016/12/01/%E8%AE%BE%E5%A4%87%E5%B0%BA%E5%AF%B8/</url>
      
        <content type="html"><![CDATA[<!-- build time:Tue Jun 02 2020 17:35:51 GMT+0800 (CST) --><h2 id="å°ºå¯¸è¦æ±‚"><a class="markdownIt-Anchor" href="#å°ºå¯¸è¦æ±‚"></a> å°ºå¯¸è¦æ±‚</h2><p><a href="http://help.apple.com/itunes-connect/developer/#/devd274dd925" target="_blank" rel="noopener">Apple Doc</a></p><table><thead><tr><th style="text-align:center">å±å¹•å°ºå¯¸</th><th style="text-align:center">æ¨ªå±å¿«ç…§å°ºå¯¸</th><th style="text-align:center">ç«–å±å¿«ç…§å°ºå¯¸</th></tr></thead><tbody><tr><td style="text-align:center">3.5å¯¸</td><td style="text-align:center">960 * 640</td><td style="text-align:center">640*960</td></tr><tr><td style="text-align:center">4å¯¸</td><td style="text-align:center">1136*640</td><td style="text-align:center">640*1136</td></tr><tr><td style="text-align:center">4.7å¯¸</td><td style="text-align:center">1334*750</td><td style="text-align:center">750*1334</td></tr><tr><td style="text-align:center">5.5å¯¸</td><td style="text-align:center">2208*1242</td><td style="text-align:center">1242*2208</td></tr><tr><td style="text-align:center">5.8å¯¸</td><td style="text-align:center">2436*1125</td><td style="text-align:center">1125*2436</td></tr><tr><td style="text-align:center">9.7å¯¸(iPad)</td><td style="text-align:center">1024*768</td><td style="text-align:center">768*1024</td></tr><tr><td style="text-align:center">12.9å¯¸(iPad)</td><td style="text-align:center">2732*2048</td><td style="text-align:center">2048*2732</td></tr></tbody></table><p>iTunesConnect ä¸Šæ¶å¯ä½¿ç”¨ é«˜å°ºå¯¸ä»£æ›¿ä½å°ºå¯¸</p><!-- rebuild by neat -->]]></content>
      
      
      <categories>
          
          <category> iOS Programming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
