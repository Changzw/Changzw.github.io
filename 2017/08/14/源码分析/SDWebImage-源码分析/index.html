<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><title>SDWebImage 源码分析 | Fri.</title><meta name="keywords" content="源码,设计思想"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:type" content="article"><meta property="og:title" content="SDWebImage 源码分析"><meta property="og:url" content="https://changzw.github.io/2017/08/14/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/SDWebImage-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="Fri."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_Frame.jpg"><meta property="og:image" content="https://raw.githubusercontent.com/SDWebImage/SDWebImage/master/Docs/Diagrams/SDWebImageHighLevelDiagram.jpeg"><meta property="og:image" content="https://raw.githubusercontent.com/SDWebImage/SDWebImage/master/Docs/Diagrams/SDWebImageClassDiagram.png"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_ManagerClass_Diagram.png"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_LoaderClass_Diagram.png"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_download.jpg"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_downloader_class.jpg"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_cache_frame.jpg"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_cache_query.jpg"><meta property="og:image" content="https://changzw.github.io/img/SDWebImage_CacheClass_Diagram.png"><meta property="article:published_time" content="2017-08-14T08:11:05.000Z"><meta property="article:modified_time" content="2020-07-01T03:07:56.292Z"><meta property="article:author" content="Fri."><meta property="article:tag" content="源码"><meta property="article:tag" content="设计思想"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://changzw.github.io/img/SDWebImage_Frame.jpg"><link rel="alternate" href="/atom.xml" title="Fri." type="application/atom+xml"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/open-sans/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/2.1.3/jquery.min.js"></script><script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script><link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css"><link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 4.2.0"></head></html><body><div id="container"><header id="header"><div id="header-main" class="header-inner"><div class="outer"><a href="/" id="logo"><i class="logo"></i> <span class="site-title">Fri.</span></a><nav id="main-nav"><a class="main-nav-link" href="/">首页</a> <a class="main-nav-link" href="/archives">归档</a> <a class="main-nav-link" href="/categories">分类</a> <a class="main-nav-link" href="/tags">标签</a> <a class="main-nav-link" href="/about">关于</a></nav><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..."><span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></div></div><div id="main-nav-mobile" class="header-sub header-inner"><table class="menu outer"><tr><td><a class="main-nav-link" href="/">首页</a></td><td><a class="main-nav-link" href="/archives">归档</a></td><td><a class="main-nav-link" href="/categories">分类</a></td><td><a class="main-nav-link" href="/tags">标签</a></td><td><a class="main-nav-link" href="/about">关于</a></td><td><div class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="搜索"></div></td></tr></table></div></header><div class="outer"><aside id="sidebar"><div class="widget-wrap" id="categories"><h3 class="widget-title"><span>分类</span> &nbsp;<a id="allExpand" href="#"><i class="fa fa-angle-double-down fa-2x"></i></a></h3><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; favorite</a><ul class="unstyled" id="tree"><li class="file"><a href="/2019/06/03/%E5%A5%BD%E6%96%87%E7%AB%A0/">好文章</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; iOS Programming</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; AppExtensions</a><ul class="unstyled" id="tree"><li class="file"><a href="/2020/02/17/%E8%87%AA%E5%AE%9A%E4%B9%89-keyboard/">自定义 keyboard</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; Guide</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/05/15/UI%20%E7%9B%B8%E5%85%B3/iOS-View-%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97/">iOS View 编程指南</a></li><li class="file"><a href="/2019/08/19/%E7%BD%91%E7%BB%9C/URL-Loading-System/">URL Loading System</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; UI</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/01/13/UI%20%E7%9B%B8%E5%85%B3/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6/">自定义控件[转载objccn]</a></li><li class="file"><a href="/2017/06/15/UI%20%E7%9B%B8%E5%85%B3/CollectionView-%E4%BD%BF%E7%94%A8/">CollectionView 使用</a></li><li class="file"><a href="/2017/09/20/UI%20%E7%9B%B8%E5%85%B3/iOS-%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93/">iOS 离屏渲染</a></li><li class="file"><a href="/2017/09/21/UI%20%E7%9B%B8%E5%85%B3/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E5%8C%85%E8%A3%B9%E8%A7%86%E5%9B%BE/">自动布局包裹视图</a></li><li class="file"><a href="/2017/10/27/UI%20%E7%9B%B8%E5%85%B3/CAShapeLayer-%E7%94%BB%E5%9B%BE/">CAShapeLayer 画图</a></li><li class="file"><a href="/2018/11/06/UI%20%E7%9B%B8%E5%85%B3/viewController-transitions/">viewController transitions</a></li><li class="file"><a href="/2019/02/11/UI%20%E7%9B%B8%E5%85%B3/iOS-%E5%93%8D%E5%BA%94%E9%93%BE/">iOS 响应链</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; WWDC</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/05/14/swift%20%E8%AF%AD%E6%B3%95/Swift-%E9%9D%A2%E5%90%91%E5%8D%8F%E8%AE%AE%E7%BC%96%E7%A8%8B/">Swift 面向协议编程</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; objc</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; runtime</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/08/01/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/Method-Swizzling/">Method Swizzling</a></li><li class="file"><a href="/2018/01/03/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/Meta-Class/">Meta Class</a></li><li class="file"><a href="/2018/04/02/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/dealloc%E7%9A%84%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA/">dealloc的调用时机</a></li><li class="file"><a href="/2018/06/01/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/weak-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">__weak 实现分析</a></li><li class="file"><a href="/2018/07/01/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/">关联对象</a></li><li class="file"><a href="/2019/01/12/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/load%E5%92%8Cinitialize/">load和initialize</a></li><li class="file"><a href="/2019/12/01/performance/%E8%B0%83%E8%AF%95%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3%E9%97%AE%E9%A2%98%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E9%AD%94%E6%B3%95%E6%8D%95%E8%8E%B7%E5%B8%83%E5%B1%80%E5%8F%8D%E9%A6%88%E5%BE%AA%E7%8E%AF/">调试内存不足问题：使用运行时魔法捕获布局反馈循环</a></li><li class="file"><a href="/2020/03/08/%E4%BD%BF%E7%94%A8-closures-%E6%B7%BB%E5%8A%A0-Gesture-Recognizers/">使用 closures 代替 Gesture Recognizers 选择器</a></li></ul></li><li class="file"><a href="/2017/08/06/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BlocksKit-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">BlocksKit 源码阅读</a></li><li class="file"><a href="/2017/11/17/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/Category%E5%88%86%E6%9E%90/">Category分析</a></li><li class="file"><a href="/2018/01/09/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/OC-%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90/">OC 对象分析</a></li><li class="file"><a href="/2018/05/31/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/autoreleasepool-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">autoreleasepool 实现分析</a></li><li class="file"><a href="/2018/09/11/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/block-%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/">block 底层分析</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; runloop</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/08/27/runloop/RunLoop%E5%88%86%E6%9E%90/">RunLoop 原理分析</a></li><li class="file"><a href="/2017/08/30/runloop/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-RunLoop/">如何使用 RunLoop</a></li><li class="file"><a href="/2019/12/29/runloop/runloop-%E5%AE%9E%E8%B7%B5%E7%9B%B8%E5%85%B3/">runloop 实践相关</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; runtime</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/08/10/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/objc_msgSend%20%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">objc_msgSend 流程分析</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; thread</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/07/10/thread/%E8%A7%A3%E5%86%B3%E8%B5%84%E6%BA%90%E7%AB%9E%E4%BA%89%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E6%8E%A7%E5%88%B6%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5/">解决资源竞争的方法，控制线程同步</a></li><li class="file"><a href="/2018/12/21/thread/GCD-%E5%8E%9F%E7%90%86-API-%E5%88%86%E6%9E%90/">GCD 原理+API 分析+实践</a></li><li class="file"><a href="/2018/12/25/thread/%E4%BB%8EGCD-%E5%88%B0-Operation/">从GCD 到 Operation</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 系统原理</a><ul class="unstyled" id="tree"><li class="file"><a href="/2019/02/05/UI%20%E7%9B%B8%E5%85%B3/iOS-%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">iOS 渲染过程性能优化</a></li><li class="file"><a href="/2020/02/20/UI%20%E7%9B%B8%E5%85%B3/iOS%20%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B/">Apple 系统界面渲染过程</a></li></ul></li><li class="file"><a href="/2016/12/01/%E8%AE%BE%E5%A4%87%E5%B0%BA%E5%AF%B8/">iOS 设备尺寸表</a></li><li class="file"><a href="/2017/07/01/iOS-app-%E6%B2%99%E7%9B%92%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/">iOS app 沙盒目录结构</a></li><li class="file"><a href="/2018/03/24/%E5%8A%9F%E8%83%BD%E7%BB%86%E8%8A%82%E8%AE%B0%E5%BD%95/">功能细节记录</a></li><li class="file"><a href="/2018/07/13/%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/objectivec-swift-%E7%A8%8B%E5%BA%8F%E5%86%85%E5%AD%98/">objectivec/swift 程序内存</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 开发语言</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; C/C++</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/06/01/c-%E5%AE%8F%E6%95%B4%E7%90%86/">c 可变参数宏整理</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; swift</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/02/09/swift%20%E8%AF%AD%E6%B3%95/swift-%E8%AF%AD%E6%B3%95%E5%B0%8F%E8%AE%B0/">swift 语法小记</a></li><li class="file"><a href="/2018/05/10/swift%20%E8%AF%AD%E6%B3%95/swift-%E5%BA%8F%E5%88%97%E5%8C%96Codable/">swift 序列化Codable</a></li></ul></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 思考</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 开发</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/03/03/%E5%A6%82%E4%BD%95%E8%AF%BB%E4%BB%A3%E7%A0%81%E5%86%99%E4%BB%A3%E7%A0%81/">如何读代码写代码</a></li><li class="file"><a href="/2018/08/24/%E5%BC%80%E5%8F%91%E4%B8%8A%E7%9A%84%E6%80%9D%E8%80%83/">“T” 字模型</a></li><li class="file"><a href="/2018/12/06/%E7%AE%80%E5%8C%96%E8%AE%BE%E8%AE%A1-App-%E7%9A%84%E8%BF%87%E7%A8%8B/">简化设计 App 的过程</a></li><li class="file"><a href="/2019/02/05/%E9%9B%AA%E7%90%83%E9%80%9F%E8%AF%BB%E6%B3%95/">雪球速读法--迭代树--整体&细节</a></li></ul></li></ul></li><li class="directory open"><a href="#" data-role="directory"><i class="fa fa-folder-open"></i> &nbsp; 第三方框架</a><ul class="unstyled" id="tree"><li class="directory open"><a href="#" data-role="directory"><i class="fa fa-folder-open"></i> &nbsp; Net</a><ul class="unstyled" id="tree"><li class="file active"><a href="/2017/08/14/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/SDWebImage-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">SDWebImage 源码分析</a></li><li class="file"><a href="/2019/08/23/source-code/AlamoFire-%E5%88%86%E6%9E%90/">AlamoFire 分析</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; ReactiveCocoa</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/04/06/RxSwfit+RAC/RAC-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/">RAC-学习笔记01</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; RxSwift</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/01/21/RxSwfit+RAC/RxFlow-1-%E5%8E%9F%E7%90%86/">RxFlow 1: 原理</a></li><li class="file"><a href="/2018/01/21/RxSwfit+RAC/RxFlow-2-%E5%AE%9E%E8%B7%B5/">RxFlow 2: 实践</a></li><li class="file"><a href="/2018/01/22/RxSwfit+RAC/RxFlow-3-%E6%8F%90%E7%A4%BA%E5%92%8C%E6%8A%80%E5%B7%A7/">RxFlow 3: 提示和技巧</a></li><li class="file"><a href="/2018/01/31/RxSwfit+RAC/RxSwift-%E7%89%B9%E5%BE%81/">RxSwift 1.特征</a></li><li class="file"><a href="/2018/02/02/RxSwfit+RAC/Hot-%E5%92%8C-Cold-Observables/">Hot 和 Cold Observables</a></li><li class="file"><a href="/2018/02/02/RxSwfit+RAC/RxSwift-Observer/">RxSwift 2.Observer</a></li><li class="file"><a href="/2018/02/02/RxSwfit+RAC/RxSwift-3-Subject(Observable&Observer)/">RxSwift 3.Subject(Observable & Observer)</a></li><li class="file"><a href="/2018/02/03/RxSwfit+RAC/RxSwift-Action/">RxSwift 4.Action</a></li><li class="file"><a href="/2018/02/06/RxSwfit+RAC/RxSwift-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">RxSwift 学习笔记</a></li><li class="file"><a href="/2018/03/04/RxSwfit+RAC/Rx-MVVM-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/">Rx+MVVM 实际应用</a></li><li class="file"><a href="/2018/03/12/%E5%A6%82%E4%BD%95%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%84%E5%BA%93%E6%B7%BB%E5%8A%A0%E5%89%8D%E7%BC%80/">如何给自己的库添加前缀</a></li><li class="file"><a href="/2018/08/18/RxSwfit+RAC/RxSwift-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">RxSwift 源码分析</a></li><li class="file"><a href="/2019/01/31/RxSwfit+RAC/RxSwift-RxDataSources/">RxSwift 5.RxDataSources</a></li><li class="file"><a href="/2019/04/16/RxSwfit+RAC/RxSwift-MVVM-%E5%A6%82%E4%BD%95%E6%8F%90%E4%BE%9BViewModels/">RxSwift + MVVM:如何提供ViewModels</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; UI 布局</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/06/01/source-code/Masonry-%E5%88%86%E6%9E%90/">Masonry 分析</a></li><li class="file"><a href="/2018/02/09/UI%20%E7%9B%B8%E5%85%B3/Texture-%E6%B5%85%E6%9E%90/">Texture 浅析</a></li><li class="file"><a href="/2018/04/11/UI%20%E7%9B%B8%E5%85%B3/Texture-%E5%B8%83%E5%B1%80/">Texture 布局</a></li><li class="file"><a href="/2020/04/10/source-code/SnapKit-%E5%88%86%E6%9E%90/">SnapKit 分析</a></li></ul></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 算法</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 动态规划</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/07/03/%E7%AE%97%E6%B3%95/%E7%88%AC%E6%A5%BC%E6%A2%AF/">爬楼梯</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 滑动窗口</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/07/02/%E7%AE%97%E6%B3%95/%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2/">无重复字符的最长子串</a></li></ul></li><li class="file"><a href="/2018/07/02/%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E6%9C%89%E5%BA%8F%E6%95%B0%E7%BB%84/">合并两个有序数组</a></li><li class="file"><a href="/2020/06/09/%E7%AE%97%E6%B3%95/LRU-%E5%AE%9E%E7%8E%B0-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/">LRU 实现+实际应用</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 英语学习</a><ul class="unstyled" id="tree"><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 语法</a><ul class="unstyled" id="tree"><li class="file"><a href="/2018/03/15/English/%E8%8B%B1%E8%AF%AD%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/">英语语法学习</a></li><li class="file"><a href="/2018/03/15/English/22-%E5%80%92%E8%A3%85%E5%8F%A5/">22-比较级倒装</a></li></ul></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 计算机基础知识</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/03/09/thread/%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/">进程&线程间通信</a></li><li class="file"><a href="/2017/11/18/%E7%BD%91%E7%BB%9C/TCP-IP/">TCP/IP</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 设计思想</a><ul class="unstyled" id="tree"><li class="file"><a href="/2017/12/09/UI%20%E7%9B%B8%E5%85%B3/flexbox-model/">flexbox model</a></li><li class="file"><a href="/2018/01/24/architecture/%E5%8D%8F%E8%B0%83%E5%99%A8-Redux/">协调器 Redux</a></li><li class="file"><a href="/2018/07/10/NSProxy%20%E5%81%9A%E4%BB%A3%E7%90%86%E6%96%B9%E6%B3%95(%E8%A7%A3%E5%86%B3%20NSTimer%20%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8)/">NSProxy 做代理方法(解决 NSTimer 循环引用)</a></li><li class="file"><a href="/2018/09/18/architecture/App-%E6%9E%B6%E6%9E%84/">App 架构</a></li></ul></li><li class="directory"><a href="#" data-role="directory"><i class="fa fa-folder"></i> &nbsp; 读源码</a><ul class="unstyled" id="tree"><li class="file"><a href="/2019/05/17/source-code/%E8%AF%BB%E4%BB%A3%E7%A0%81-Me/">读代码 Me</a></li></ul></li><li class="file"><a href="/2020/08/07/runtime-%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E/">runtime 接口说明</a></li></ul></div><script>$(document).ready(function(){var r="fa-folder-open",i="fa-folder",l="fa-angle-double-down",d="fa-angle-double-up";$(document).on("click",'#categories a[data-role="directory"]',function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(r),l=$(this).siblings("ul");e.removeClass(r).removeClass(i),s?(void 0!==l&&l.slideUp({duration:100}),e.addClass(i)):(void 0!==l&&l.slideDown({duration:100}),e.addClass(r))}),$('#categories a[data-role="directory"]').bind("contextmenu",function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(r),l=$(this).siblings("ul"),d=$.merge(l.find("li ul"),l),o=$.merge(l.find(".fa"),e);o.removeClass(r).removeClass(i),s?(d.slideUp({duration:100}),o.addClass(i)):(d.slideDown({duration:100}),o.addClass(r))}),$(document).on("click","#allExpand",function(a){a.preventDefault();var e=$(this).children(".fa"),s=e.hasClass(l);e.removeClass(l).removeClass(d),s?($("#sidebar .fa.fa-folder").removeClass("fa-folder").addClass("fa-folder-open"),$("#categories li ul").slideDown({duration:100}),e.addClass(d)):($("#sidebar .fa.fa-folder-open").removeClass("fa-folder-open").addClass("fa-folder"),$("#categories li ul").slideUp({duration:100}),e.addClass(l))})})</script><div class="widget-wrap"><h3 class="widget-title"><span>标签云</span></h3><div class="widget tagcloud"><a href="/tags/C-C/" style="font-size:10px">C/C++</a> <a href="/tags/English/" style="font-size:10px">English</a> <a href="/tags/RAC/" style="font-size:11px">RAC</a> <a href="/tags/RxSwift/" style="font-size:16px">RxSwift</a> <a href="/tags/Texture/" style="font-size:11px">Texture</a> <a href="/tags/UI/" style="font-size:11px">UI</a> <a href="/tags/WWDC/" style="font-size:10px">WWDC</a> <a href="/tags/iOS/" style="font-size:20px">iOS</a> <a href="/tags/obj/" style="font-size:10px">obj</a> <a href="/tags/objc/" style="font-size:17px">objc</a> <a href="/tags/readings/" style="font-size:10px">readings</a> <a href="/tags/swift/" style="font-size:15px">swift</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%84%9F%E6%82%9F/" style="font-size:13px">学习感悟</a> <a href="/tags/%E5%BA%95%E5%B1%82/" style="font-size:18px">底层</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size:11px">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size:12px">性能优化</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size:15px">源码</a> <a href="/tags/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" style="font-size:10px">滑动窗口</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:13px">算法</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size:19px">翻译</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size:11px">计算机基础</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" style="font-size:14px">设计思想</a> <a href="/tags/%E8%AF%AD%E6%B3%95/" style="font-size:10px">语法</a></div></div><div class="widget-wrap"><h3 class="widget-title"><span>归档</span></h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li></ul></div></div><div id="toTop" class="fa fa-angle-up"></div></aside><section id="main"><article id="post-源码分析/SDWebImage-源码分析" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><div class="article-meta"><div class="article-category"><i class="fa fa-folder"></i> <a class="article-category-link" href="/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/">第三方框架</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/Net/">Net</a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a>, <a class="tag-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" rel="tag">设计思想</a></div><div class="article-date"><i class="fa fa-calendar"></i> <a href="/2017/08/14/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/SDWebImage-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><time datetime="2017-08-14T08:11:05.000Z" itemprop="datePublished">2017-08-14</time></a></div><i class="fa fa-bar-chart"></i><span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span></div><h1 class="article-title" itemprop="name">SDWebImage 源码分析</h1></header><div class="article-entry" itemprop="articleBody"><div id="toc" class="toc-article"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#协调器-manager"><span class="toc-number">1.</span> <span class="toc-text">协调器 Manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#子模块-sdimageloader"><span class="toc-number">2.</span> <span class="toc-text">子模块 SDImageLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sdimageloader-协议"><span class="toc-number">2.1.</span> <span class="toc-text">SDImageLoader 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sdwebimagedownloaderoptions"><span class="toc-number">2.2.</span> <span class="toc-text">SDWebImageDownloaderOptions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sdwebimagecontext"><span class="toc-number">2.3.</span> <span class="toc-text">SDWebImageContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#具体下载逻辑-sdwebimagedownloader"><span class="toc-number">2.4.</span> <span class="toc-text">具体下载逻辑 SDWebImageDownloader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#子模块-sdimagecache"><span class="toc-number">3.</span> <span class="toc-text">子模块 SDImageCache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sdmemorycache"><span class="toc-number">3.1.</span> <span class="toc-text">SDMemoryCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sddiskcache"><span class="toc-number">3.2.</span> <span class="toc-text">SDDiskCache</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解码"><span class="toc-number">4.</span> <span class="toc-text">解码</span></a></li></ol></div><a id="more"></a><p><a href="https://github.com/SDWebImage/SDWebImage" target="_blank" rel="noopener">SDWebImage源码</a></p><p>框架架构的主要目的是为了将项目模块化，分层，把代码解耦从而提高代码的复用</p><p>而 <code>SDWebImage</code> 异步下载并支持缓存，图片编码解码的框架</p><p><img src="/img/SDWebImage_Frame.jpg" alt="frame"></p><details><summary>官方提供整体类图</summary><pre>
<p><img src="https://raw.githubusercontent.com/SDWebImage/SDWebImage/master/Docs/Diagrams/SDWebImageHighLevelDiagram.jpeg" alt="顶层结构"></p>
<p><img src="https://raw.githubusercontent.com/SDWebImage/SDWebImage/master/Docs/Diagrams/SDWebImageClassDiagram.png" alt="整体类图"></p>
</pre></details><h2 id="协调器-manager"><a class="markdownIt-Anchor" href="#协调器-manager"></a> 协调器 Manager</h2><p><img src="/img/SDWebImage_ManagerClass_Diagram.png" alt="SDWebImageManagerClassDiagram"></p><ol><li>Manager 使用中介者模式，用于管理协调各个子模块之间交互</li><li>SDWebImageManager 依赖 SDWebImageOptions<enum>(配置信息)，各个子模块都是聚合关系<ol><li>子模块都是协议！使用协议作为隔离层用于解耦 Manager 跟子模块，Manager 不需要知道具体的子模块到底是什么</li><li>聚合的关系，说明子模块可以独立于 Manager 而独立使用</li></ol></enum></li><li><code>cacheKey(for url: URL?) -&gt; String?</code><ol><li>使用 url 作为cache key，用于读写 image</li></ol></li></ol><p>子模块分析，先分析 imageLoader和 imageCache</p><h2 id="子模块-sdimageloader"><a class="markdownIt-Anchor" href="#子模块-sdimageloader"></a> 子模块 SDImageLoader</h2><p><img src="/img/SDWebImage_LoaderClass_Diagram.png" alt="SDWebImageLoaderClassDiagram"></p><h3 id="sdimageloader-协议"><a class="markdownIt-Anchor" href="#sdimageloader-协议"></a> SDImageLoader 协议</h3><ol><li>SDImageLoader接口具体实现：<ol><li><code>SDImageLoadersManager</code> 组合模式，内部维护 <code>Array&lt;SDImageLoader&gt;</code></li><li><code>SDWebImageDownloader</code> 具体image 下载逻辑实现</li></ol></li><li>SDImageLoader接口依赖 <code>SDWebImageDownloaderOptions</code>，配置信息跟逻辑拆分，聚合配置信息，避免逻辑方法调用过程中配置参数零散</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">SDImageLoader</span> : <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line"><span class="comment">// 判断 url 的有效性，如果无效会标记 image 加载失败，有效就会调用requestImageWithURL:options:context:progress:completed:</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">canRequestImage</span><span class="params">(<span class="keyword">for</span> url: URL?)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">根据 url 下载 image data </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">参数：</span></span><br><span class="line"><span class="comment">url：image url，有可能是 http url</span></span><br><span class="line"><span class="comment">options: 针对 request 的可选配置信息</span></span><br><span class="line"><span class="comment">context: SDWebImageContextOption，用于处理具体的changes or  precess</span></span><br><span class="line"><span class="comment">progressBlock: image 下载的回调，get进度信息。P.S. 后台队列</span></span><br><span class="line"><span class="comment">completedBlock: 下载完成回调</span></span><br><span class="line"><span class="comment">return: request 的 Operation，用户可以自己 cancel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">requestImage</span><span class="params">(with url: URL?,</span></span></span><br><span class="line"><span class="function"><span class="params">                    options: SDWebImageOptions = [],</span></span></span><br><span class="line"><span class="function"><span class="params">                    context: [SDWebImageContextOption : <span class="keyword">Any</span>]?,</span></span></span><br><span class="line"><span class="function"><span class="params">                    progress progressBlock: SDImageLoaderProgressBlock?,</span></span></span><br><span class="line"><span class="function"><span class="params">                    completed completedBlock: SDImageLoaderCompletedBlock? = <span class="literal">nil</span>)</span></span></span><br><span class="line">                    -&gt; <span class="type">SDWebImageOperation?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">来自图像加载器的错误是否应该标记为不可恢的。</span></span><br><span class="line"><span class="comment">如果返回 true，失败的 url放进黑名单 ，不使用`SDWebImageRetryFailed`</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">error: url 加载的 error，来自于`requestImageWithURL:options:context:progress:completed:` completedBlock's error.</span></span><br><span class="line"><span class="comment">return: 是否把url 放入黑名单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">shouldBlockFailedURL</span><span class="params">(with url: URL, error: Error)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Q:在想为什么协议只暴露三个接口？？</p><p>一些思考</p><ul><li>图片请求的并发量</li><li>请求超时策略</li><li>请求优先级</li></ul><h3 id="sdwebimagedownloaderoptions"><a class="markdownIt-Anchor" href="#sdwebimagedownloaderoptions"></a> SDWebImageDownloaderOptions</h3><p>位枚举，下载器功能自定义配置，用户可更改配置改变 Downloader 中的行为</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">SDWebImageDownloaderOptions</span> : <span class="title">OptionSet</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 下载任务的 priority (Put the download in the low queue priority and task priority.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> lowPriority: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 边下载边显示(This flag enables progressive download, the image is displayed progressively during download as a browser would do.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> progressiveLoad: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否使用 urlCache，默认是不使用 (By default, request prevent the use of NSURLCache. With this flag, NSURLCache is used with default policies.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> useNSURLCache: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果imageData 从 URLCache 中读取，complete block 会返回 nil，error code 是 `SDWebImageErrorCacheNotModified`, 这个标记应该跟  SDWebImageDownloaderUseNSURLCache 一起使用 (Call completion block with nil image/imageData if the image was read from NSURLCache And the error code is `SDWebImageErrorCacheNotModified` This flag should be combined with `SDWebImageDownloaderUseNSURLCache`.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> ignoreCachedResponse: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 iOS 4+ 版本中，app 进入后台继续下载image，需要想系统请求而外的后台时间来让 Request 完成。如果请求时间耗尽，Operation 会被 cancel (In iOS 4+, continue the download of the image if the app goes to background. This is achieved by asking the system for extra time in background to let the request finish. If the background task expires the operation will be cancelled.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> continueInBackground: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理村粗在 NSHTTPCookieStore 的 cookies (Handles cookies stored in NSHTTPCookieStore by setting NSMutableURLRequest.HTTPShouldHandleCookies = YES;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> handleCookies: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 允许不可信的 SSL 认证，主要用于测试(Enable to allow untrusted SSL certificates. Useful for testing purposes. Use with caution in production.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> allowInvalidSSLCertificates: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 下载优先级，将下载 task 放在 高 priorty 队列中 (Put the download in the high queue priority and task priority.）</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> highPriority: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解码下采样，默认情况，image解码应该跟原始尺寸一致，该 flag 在 iOS中根据设备内存来下采样 image size，如果设置 SDWebImageDownloaderAvoidDecodeImage这个 flag 会失效，如果设置了 SDWebImageDownloaderProgressiveLoad，这个 flag会被忽视(By default, images are decoded respecting their original size. On iOS, this flag will scale down the images to a size compatible with the constrained memory of devices. This flag take no effect if `SDWebImageDownloaderAvoidDecodeImage` is set. And it will be ignored if `SDWebImageDownloaderProgressiveLoad` is set.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> scaleDownLargeImages: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解码，默认情况，在查询 image cache or download from the network的时候，使用后台任务解码 image(在使用UIImage的时候 Core Animation是在 main thread 解码image的)。后台解码会增加内存，该flag 标记解码过程由用户自己处理 (By default, we will decode the image in the background during cache query and download from the network. This can help to improve performance because when rendering image on the screen, it need to be firstly decoded. But this happen on the main queue by Core Animation. However, this process may increase the memory usage as well. If you are experiencing a issue due to excessive memory consumption, This flag can prevent decode the image.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> avoidDecodeImage: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// gif image 解码，该 flag 标记框架只解码一帧 (By default, we decode the animated image. This flag can force decode the first frame only and produce the static image.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> decodeFirstFrameOnly: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//gif image 解码，该flag 标记框架解码所有帧 (By default, for `SDAnimatedImage`, we decode the animated image frame during rendering to reduce memory usage. This flag actually trigger `preloadAllAnimatedImageFrames = YES` after image load from network)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> preloadAllFrames: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//gif image 解码, 默认情况当你使用 `SDWebImageContextAnimatedImageClass` 的时候，我们依然使用 UIImage，当 cache 命中，或者image 解码器不可用，作为一个 fallback 方案，使用这个 option，可以确保使用你自己提供的 class来生成 image，如果失败会产生 `SDWebImageErrorBadImageData`，注意这个 flag 跟 `SDWebImageDownloaderDecodeFirstFrameOnly` 不兼容 (By default, when you use `SDWebImageContextAnimatedImageClass` context option (like using `SDAnimatedImageView` which designed to use `SDAnimatedImage`), we may still use `UIImage` when the memory cache hit, or image decoder is not available, to behave as a fallback solution. Using this option, can ensure we always produce image with your provided class. If failed, a error with code `SDWebImageErrorBadImageData` will been used. Note this options is not compatible with `SDWebImageDownloaderDecodeFirstFrameOnly`, which always produce a UIImage/NSImage.)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> matchAnimatedImageClass: <span class="type">SDWebImageDownloaderOptions</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sdwebimagecontext"><a class="markdownIt-Anchor" href="#sdwebimagecontext"></a> SDWebImageContext</h3><p>根据字典拿到辅助功能对象</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> * SDWebImageContextOption <span class="built_in">NS_EXTENSIBLE_STRING_ENUM</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSDictionary</span>&lt;SDWebImageContextOption, <span class="keyword">id</span>&gt; SDWebImageContext;</span><br></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextSetImageOperationKey = <span class="string">@"setImageOperationKey"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextCustomManager = <span class="string">@"customManager"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageCache = <span class="string">@"imageCache"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageLoader = <span class="string">@"imageLoader"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageCoder = <span class="string">@"imageCoder"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageTransformer = <span class="string">@"imageTransformer"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageScaleFactor = <span class="string">@"imageScaleFactor"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImagePreserveAspectRatio = <span class="string">@"imagePreserveAspectRatio"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextImageThumbnailPixelSize = <span class="string">@"imageThumbnailPixelSize"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextQueryCacheType = <span class="string">@"queryCacheType"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextStoreCacheType = <span class="string">@"storeCacheType"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextOriginalQueryCacheType = <span class="string">@"originalQueryCacheType"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextOriginalStoreCacheType = <span class="string">@"originalStoreCacheType"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextAnimatedImageClass = <span class="string">@"animatedImageClass"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextDownloadRequestModifier = <span class="string">@"downloadRequestModifier"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextDownloadResponseModifier = <span class="string">@"downloadResponseModifier"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextDownloadDecryptor = <span class="string">@"downloadDecryptor"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextCacheKeyFilter = <span class="string">@"cacheKeyFilter"</span>;</span><br><span class="line">SDWebImageContextOption <span class="keyword">const</span> SDWebImageContextCacheSerializer = <span class="string">@"cacheSerializer"</span>;</span><br></pre></td></tr></table></figure><p>为什么使用字典而不是在创建一个类呢？<br>可能这些类or配置信息都不重要，使用字典管理</p><h3 id="具体下载逻辑-sdwebimagedownloader"><a class="markdownIt-Anchor" href="#具体下载逻辑-sdwebimagedownloader"></a> 具体下载逻辑 SDWebImageDownloader</h3><p><img src="/img/SDWebImage_download.jpg" alt="downloader"></p><ol><li>依赖 <code>SDWebImageDownloadToken</code> (关联具体的 downloadOperation)</li><li>依赖 <code>SDWebImageDownloadOptions</code></li><li>依赖 <code>SDWebImageDownloaderOperation</code> (内部封装 downloadTask，coderQueue)</li><li>依赖 <code>SDWebImageDownloaderConfig</code> (下载配置信息)</li><li>聚合 <code>SDWebImageDownloaderRequestModifier</code> (在请求前修改 request)</li><li>聚合 <code>SDWebImageDownloaderResponsetModifier</code> (在响应后修改 response)</li><li>聚合 <code>SDWebImageDownloaderDecryptor</code></li><li>聚合 <code>NSURLSessionConfiguration</code> (下载operation 配置的 session 环境)</li></ol><p>私有属性，维护下载任务</p><ol><li>URLSession</li><li>OperationQueue，URLOperations</li></ol><p><img src="/img/SDWebImage_downloader_class.jpg" alt="downloader_class"></p><p>大致过程</p><ol><li>SDWebImageDownloader.init<ol><li>配置 downloader config</li><li>downloadQueue 并发 default 6 thread</li><li>配置 httpHeader</li><li>配置 urlSession</li></ol></li><li>url -&gt; SDWebImageDownloadToken -&gt; SDWebImageDownloaderOperation<ol><li>配置 request</li><li>根据 context 配置 SDWebImageDownloaderOperation<ol><li>operation.start 中封装 dataTask</li><li>配置 coderQueue(serial) SDWebImageDownloaderOperation taskDelegate receive data 回调中边下载data 边解码</li><li>dataTask 结束后调用 operation 的 completeBlock 将 imageData 交给用户</li></ol></li></ol></li></ol><h2 id="子模块-sdimagecache"><a class="markdownIt-Anchor" href="#子模块-sdimagecache"></a> 子模块 SDImageCache</h2><p>内存：当前程序运行空间，空间小，数据易丢失，读取快<br>程序运行后，内存分为 5 个区：栈区，堆区，全局区，常量区，代码区<br>内存缓存设计一般使用：栈区，堆区</p><p>磁盘：空间大、可持久、读取速度慢</p><p>iOS 主要提供4种磁盘存储方式：</p><ul><li>NSKeyedArchiver：归档的形式来保存数据，只能一次性归档保存以及一次性解压。所以只能针对小量数据，如果想改动数据的某一小部分，需要解压整个数据或者归档整个数据。</li><li>NSUserDefaults：用来保存应用程序设置和属性、用户保存的数据。存储的数据类型少，包括：NSData、NSString、NSNumber、NSDate、NSArray、 NSDictionary</li><li>plist：userDefault就是一个 plist</li><li>FileManager 相关 write 写入方式：永久保存在磁盘中</li><li>数据库</li></ul><p>App 的沙盒根目录结构：</p><ol><li>Documents</li><li>Library</li><li>temp</li></ol><p>大体结构，在网络层的 operation 中 coderQueue(serial) 负责解码 image</p><p><img src="/img/SDWebImage_cache_frame.jpg" alt="cache"></p><p>cache 读取方法：使用url的单向 hash值来读写<br><img src="/img/SDWebImage_cache_query.jpg" alt="cache"></p><ol><li>依赖 SDImageCacheOptions</li><li>聚合 SDMemoryCache</li><li>聚合 SDDiskCache</li><li>聚合 SDImageCacheConfig</li><li>使用组合模式 SDImageCachesManager 做分支节点，SDImageCache 做叶子节点</li><li>SDImageCacheManager 依赖 SDImageCachesManagerOperationPolicy(用于处理多个 cache)</li></ol><p><img src="/img/SDWebImage_CacheClass_Diagram.png" alt="SDWebImageCacheClassDiagram"></p><p>计算机组成原理：层级存储器设计思想</p><h3 id="sdmemorycache"><a class="markdownIt-Anchor" href="#sdmemorycache"></a> SDMemoryCache</h3><p>内存管理设计<br>内存空间(因为是内存，使用什么数据结构？)<br>3个队列：<br>50 * 10 kb<br>20 * 100 kb<br>10 * 100+kb</p><p>队列淘汰策略<br>FIFO 算法<br>LRU 算法（检查时机）</p><p>内部使用NSCache 实现缓存<br>NSMapTable 作为弱引用缓存</p><h3 id="sddiskcache"><a class="markdownIt-Anchor" href="#sddiskcache"></a> SDDiskCache</h3><p>磁盘管理设计<br>存储方式<br>空间大小限制<br>淘汰策略</p><p>根据文件属性删减文件</p><ul><li>(void)removeExpiredData</li></ul><h2 id="解码"><a class="markdownIt-Anchor" href="#解码"></a> 解码</h2><ul><li>使用策略模式针对不同图片解码</li><li>解码时机：<ul><li>图片数据下载完成</li><li>磁盘读取后</li></ul></li></ul></div></div></article><nav id="article-nav"><a href="/2017/08/27/runloop/RunLoop%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title">RunLoop 原理分析</div></a><a href="/2017/08/06/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/BlocksKit-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">BlocksKit 源码阅读</div></a></nav><script type="text/javascript">!function(){var e=window.location.href,r=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var o="//api.share.baidu.com/s.gif";r?(o+="?r="+encodeURIComponent(document.referrer),e&&(o+="&l="+e)):e&&(o+="?l="+e),(new Image).src=o}}(window)</script></section></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">Fri. &copy; 2020 <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" target="_blank" rel="noopener">wikitten</a><br><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> &nbsp;|&nbsp;<span id="busuanzi_container_site_pv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="/libs/lightgallery/js/lightgallery.min.js"></script><script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script><script src="/libs/lightgallery/js/lg-pager.min.js"></script><script src="/libs/lightgallery/js/lg-autoplay.min.js"></script><script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script><script src="/libs/lightgallery/js/lg-zoom.min.js"></script><script src="/libs/lightgallery/js/lg-hash.min.js"></script><script src="/libs/lightgallery/js/lg-share.min.js"></script><script src="/libs/lightgallery/js/lg-video.min.js"></script><script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/main.js"></script></div></body>